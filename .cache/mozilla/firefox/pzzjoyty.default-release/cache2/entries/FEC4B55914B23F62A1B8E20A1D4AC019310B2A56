define([ 'app', 'text!app/contact/contact-template.html', 'i18n!app/contact/nls/contact-i18n',
		'app/contact/contact-models', 'app/org/org-models' ], function(app, template, i18n) {

	app.module('contact', function(contact, app, Backbone, Marionette, $, _) {

		contact.$template = $(template);

		contact.SidebarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.SidebarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#sidebar-template').html();
					compiledTemplate = _.template(html);
					contact.SidebarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					app : app,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(contact.groupCollection, 'sync', this.renderContactsView);
				this.listenTo(contact.groupCollection, 'sync', this._updateTrashContactsCount);
				this.listenTo(app.vent, 'show:shared-group-view', this.renderSharedView);
				this.listenTo(app.vent, 'contact:modifyView', this.contactAddView);
				this.listenTo(app.vent, 'contact:mergeView', this.contactAddView);
				this.listenTo(app.vent, 'activate:contacts-tab', this.activateContactsTab);
			},
			onRender : function() {
				var self = this;
				var $createView = $('#addressModify');
				var $contactAdd = this.$el.find('.mc-btn_quick');
				var $groupAdd = this.$el.find('.mc-btn_import');
				var $trashEmpty = this.$el.find('.mc-btn_clean');
				var $importantContacts = this.$el.find('#importantContacts');
				var $recentContacts = this.$el.find('#recentContacts');
				var $importContacts = this.$el.find('#importContacts');
				var $exportContacts = this.$el.find('#exportContacts');
				var $trashContacts = this.$el.find('#trashContacts');
				$contactAdd.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contactAddView();
					self.activateContactsTab('contact');
				});
				$groupAdd.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.addGroup();
					self.activateContactsTab('contact');
				});
				var $links = this.$el.find('ul.tabbox li a');
				$links.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var link;
					var now = (Date.now ? Date.now() : new Date().getTime());
					switch ($this.attr('name')) {
					case 'contact':
						link = '#contacts/all/contacts?_=' + now
						break;
					case 'org':
						link = '#org?_=' + now;
						break;
					case 'shared-groups':
						link = '#shared-groups/all/contacts?_=' + now;
						break;
					}
					location.hash = link;
				});
				this.$contactsTab = this.$el.find('div.section_list ul.tabbox li.tbm1');
				this.$orgTab = this.$el.find('div.section_list ul.tabbox li.tbm2');
				this.$shareContactsTab = this.$el.find('div.section_list ul.tabbox li.tbm3');
				this.$contactsTab.add(this.$orgTab).add(this.$shareContactsTab).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $contactsLayer = self.$el.find('div.mc-svc_menu_area div.contacts-group');
					var $orgLayer = self.$el.find('div.mc-svc_menu_area div.org-group');
					var $shareContactsLayer = self.$el.find('div.mc-svc_menu_area div.share-contacts-group');
					var $panels = $contactsLayer.add($orgLayer).add($shareContactsLayer);
					$panels.hide();
					$this.siblings().removeClass('on');
					$this.addClass('on');
					switch ($this.attr('id')) {
					case 'org-tab':
						self.renderOrgView();
						$orgLayer.show();
						break;
					case 'share-tab':
						self.renderSharedView();
						$shareContactsLayer.show();
						break;
					case 'contact-tab':
					default:
						contact.groupCollection.fetch();
						$contactsLayer.show();
						break;
					}
					contact.selectedAddressCollection.reset();
				});
				$trashEmpty.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.emptyTrashMsg)) {
						// 휴지통 비우기
						self.cleanTrashContacts();
					}
				});
				if (this.groupContextMenuView)
					this.groupContextMenuView.close();
				this.groupContextMenuView = new contact.GroupContextMenuView();
				if (this.shareGroupContextMenuView)
					this.shareGroupContextMenuView.close();
				this.shareGroupContextMenuView = new contact.SharedGroupContextMenuView();
				this.activateContactsTab();
			},
			onShow : function() {
				var self = this;
				var orgGroupCollection = new app.org.OrgGroupCollection();
				orgGroupCollection.fetch({
					success : function(collection, response, options) {
						var isOrgVisible = false, isSharedContactsVisible = false;
						collection.find(function(model, index) {
							if (model.get('USER_GROUP_STRUCTURE') === 1) {
								isOrgVisible = true;
								return true;
							}
						});
						collection.find(function(model, index) {
							if (model.get('USER_GROUP_ADDRESS') === 1) {
								isSharedContactsVisible = true;
								return true;
							}
						});
						var userAuth = app.userModel.get('USERS_AUTH');
						if (userAuth == 'U' && !isOrgVisible) {
							self.$el.find('div.section_list ul.tabbox li.tbm2').hide();
						}
						if (userAuth == 'U' && !isSharedContactsVisible) {
							self.$el.find('div.section_list ul.tabbox li.tbm3').hide();
						}
					},
					error : function(model, response, options) {
						alert('Failed to fetch Organizational Groups');
					}
				});
			},
			renderContactsView : function() {
				var $contactsLayer = this.$el.find('div.mc-svc_menu_area div.contacts-group');
				var groups = contact.groupCollection.filter(function(groupModel) {
					var groupType = groupModel.get('GROUP_TYPE');
					return groupType != 'T' && groupType != 'A' && groupModel.get('REF_GROUP_IDX') == 0;
				});
				var contactsView = new contact.ContactsView({
					collection : new contact.GroupCollection(groups),
					groupCollection : contact.groupCollection,
				});
				contactsView.render();
				$contactsLayer.html(contactsView.el);
			},
			renderOrgView : function() {
				var $orgLayer = this.$el.find('div.mc-svc_menu_area div.org-group div.treeWrapping');
				var orgRootEntryModel = new app.org.OrgEntryModel({
					id : 'root'
				});
				orgRootEntryModel.fetch();
				this.listenTo(orgRootEntryModel, 'change', function() {
					var attributes = orgRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.org.OrgEntryCollection(member);
					var groups = contact.groupCollection.filter(function(groupModel) {
						return groupModel.get('GROUP_TYPE') == 'U';
					});
					var orgView = new contact.OrgView({
						model : orgRootEntryModel,
						collection : collection,
						groupCollection : new contact.GroupCollection(groups),
					});
					orgView.render();
					$orgLayer.html(orgView.el);
				});
			},
			renderSharedView : function() {
				var $sharedContactsLayer = this.$el.find('div.mc-svc_menu_area div.share-contacts-group');
				contact.sharedGroupCollection = new contact.SharedGroupCollection();
				contact.sharedGroupCollection.addSharedAllGroup();
				contact.sharedGroupCollection.fetch();
				this.listenToOnce(contact.sharedGroupCollection, 'sync', function() {
					var sharedGroups = contact.sharedGroupCollection.filter(function(groupModel) {
						var groupType = groupModel.get('GROUP_TYPE');
						return groupType != 'A';
					});
					var sharedContactView = new contact.SharedGroupView({
						collection : new contact.SharedGroupCollection(sharedGroups),
						sharedGroupCollection : contact.sharedGroupCollection,
					});
					sharedContactView.render();
					$sharedContactsLayer.html(sharedContactView.el);
				});
			},
			addGroup : function() {
				var groupName = i18n.importGroupName;
				var check = function(groupName) {
					var exist = false;
					var groups = contact.groupCollection.filter(function(groupModel) {
						return groupModel.get('GROUP_NM') == groupName;
					});
					if (groups.length > 0) {
						exist = true;
					}
					return exist;
				};
				for (var i = 1; check(groupName);) {
					if (i > 1) {
						groupName = groupName.substring(0, groupName.indexOf('('));
					}
					groupName += '(' + i + ')';
					i++;
				}
				contact.groupCollection.create({
					GROUP_NM : groupName,
				}, {
					wait : true,
					async : false,
				});
				var groupModel = contact.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_NM') == groupName;
				});
				var isNew = true;
				app.vent.trigger('rename:group', groupModel, isNew);
			},
			contactAddView : function(addressCollection) {
				var $createView = $('#addressModify');
				var $viewWrapper = $('#contactMan');
				var createContactView;
				var model = new contact.AddressModel();
				if (addressCollection) {
					createContactView = new contact.ContactModifyView({
						model : model,
						collection : contact.groupCollection,
						paginator : contact.paginator,
						addressCollection : addressCollection,
					});
				} else {
					var options = {};
					if (contact.selectedAddressCollection.length > 0) {
						options['silent'] = true;
					}
					// 선택된 연락처들을 초기화
					contact.selectedAddressCollection.reset(undefined, options);
					createContactView = new contact.ContactModifyView({
						model : model,
						collection : contact.groupCollection,
						paginator : contact.paginator,
					});
				}
				createContactView.render();
				$createView.html(createContactView.el);
				$viewWrapper.show();
				$createView.show();
			},
			addedToGroupCollection : function(model, collection, options) {
				var groupId = model.get('GROUP_IDX');
			},
			cleanTrashContacts : function() {
				// 휴지통 비우기
				var model = contact.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_TYPE') == 'T';
				});
				var url = 'groups/' + model.get('GROUP_IDX') + '/all-contacts';
				var jqXHR = model.destroy({
					wait : true,
					async : false,
					url : url,
				});
				jqXHR.done(function() {
					contact.groupCollection.fetch();
					location.hash = '#contacts';
					contact.paginator.pager();
				});
			},
			_updateTrashContactsCount : function() {
				var groupModel = contact.groupCollection.getGroupModel('GROUP_TYPE', 'T');
				if (!groupModel)
					groupModel = new app.contact.GroupModel();
				var $trashContactsCount = this.$el.find('div.section_etc a#trashContacts em.mc-cut');
				var count = groupModel.get('contactsCount') ? groupModel.get('contactsCount') : '';
				$trashContactsCount.text(count);
			},
			onClose : function() {
				if (this.groupContextMenuView)
					this.groupContextMenuView.close();
				if (this.shareGroupContextMenuView)
					this.shareGroupContextMenuView.close();
			},
			activateContactsTab : function(type) {
				var $tab;
				if (!type) {
					var hash = location.hash;
					type = hash.indexOf('#contacts') != -1 ? 'contact' : hash.indexOf('#org') != -1 ? 'org' : 'share';
				}
				switch (type) {
				case 'org':
					$tab = this.$orgTab;
					break;
				case 'share':
					$tab = this.$shareContactsTab;
					break;
				case 'contact':
				default:
					$tab = this.$contactsTab;
					break;
				}
				if (!$tab.hasClass('on'))
					$tab.click();
			},
		}); // contact.SidebarView

		contact.GroupDescriptionView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.GroupDescriptionView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#group-description-template').html();
					compiledTemplate = _.template(html);
					contact.GroupDescriptionView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var $update = this.$el.find('.dh_layer_btn_area button:first');
				var $textArea = this.$el.find('.p2 textarea');
				var self = this;
				$update.click(function(event) {
					self.model.save({
						GROUP_STMT : $textArea.val()
					}, {
						patch : true,
						wait : true
					});
				});
			},
		}); // contact.GroupDescriptionView

		contact.GroupDeleteView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.GroupDeleteView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#group-delete-template').html();
					compiledTemplate = _.template(html);
					contact.GroupDeleteView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $deleteOptions = this.$el.find('.layer_content input[type=radio]');
				var $confirm = this.$el.find('.dh_layer_btn_area button.b');
				$confirm.click(function() {
					var groupCollection = contact.groupCollection;
					var type = $deleteOptions.filter(':checked').val();
					function traverseGroup(parentGroupModel) {
						var subGroupModels;
						if (parentGroupModel) {
							subGroupModels = groupCollection.filter(function(groupModel) {
								return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
							});
							self.deleteGroup(parentGroupModel, type);
						}
						for (var i = 0; i < subGroupModels.length; i++) {
							traverseGroup(subGroupModels[i]);
						}
					}
					contact.overlayView.showProcessing();
					traverseGroup(self.model);
					contact.overlayView.hideProcessing();
					contact.groupCollection.fetch();
					location.hash = '#contacts/all/contacts';
				});
			},
			deleteGroup : function(groupModel, type) {
				var orgUrl = groupModel.urlRoot;
				if (type == 0) {
					// 그룹+연락처 모두 삭제
					var url = orgUrl + '/' + groupModel.get('GROUP_IDX') + '/all';
					groupModel.destroy({
						url : url,
						wait : true,
						async : false,
					});
				} else {
					// 그룹만삭제
					groupModel.destroy({
						wait : true,
						async : false,
					});
				}
			},
		}); // contact.GroupDeleteView

		contact.GroupItemView = Backbone.Marionette.CompositeView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = contact.GroupItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#group-item-template').html();
					compiledTemplate = _.template(html);
					contact.GroupItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(app.vent, 'rename:group', this.editGroupName);
				this.groupCollection = options.groupCollection;
				this.parentView = options.parentView;
			},
			itemViewOptions : function(model, index) {
				var groupId = model.get('GROUP_IDX');
				var groupCollection = this.options.groupCollection;
				var groups = groupCollection.filter(function(model) {
					return model.get('REF_GROUP_IDX') === groupId;
				});
				return {
					collection : new contact.GroupCollection(groups),
					groupCollection : groupCollection,
					itemIndex : index,
					parentView : this.parentView,
				}
			},
			getLevel : function() {
				var level = 1;
				var groupCollection = this.options.groupCollection;
				var parentId = this.model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = groupCollection.find(function(gruopModel) {
					return gruopModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = groupCollection.find(function(gruopModel) {
						return gruopModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function(event) {
				var self = this;
				var groupModel = this.model;
				var level = this.getLevel();
				var $list = this.$el.find('ul:first');
				var $toggle = this.$el.find('button.btn_folder:first');
				this.applyClassToItems();
				var $link = this.$el.find('span.set_onp a.ma:first');
				$link.click(function(event) {
					var $item = self.$el.find('span.ml_t:first')
					self.applyClassToItems($item);
				});
				$toggle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var folded = 0;
					if ($list.is(':visible')) {
						self.$el.removeClass('spread_folder').addClass('fold_folder');
						$list.hide();
						folded = 1;
					} else {
						self.$el.removeClass('fold_folder').addClass('spread_folder');
						$list.show();
						folded = 0;
					}
					groupModel.save({
						FOLDED : folded
					}, {
						patch : true,
						wait : true,
						error : function(model, response, options) {
							app.log('Failed to update groupModel folded');
						},
					});
					return false;
				});
				$list.addClass('depth' + level);
				if (groupModel.get('FOLDED')) {
					this.$el.addClass('fold_folder');
					$list.hide();
				} else {
					this.$el.addClass('spread_folder');
					$list.show();
				}
				if ($list.children('li').length === 0) {
					$toggle.remove();
				}
				var $groupWrapper = this.$el.find('span.set_onp:first');
				var $inputWrapper = this.$el.find('span.set_inp:first');
				var $input = $inputWrapper.find('input.input_text:first');
				var editGroupName = function(event) {
					$inputWrapper.show();
					$groupWrapper.hide();
					$input.val(self.model.get('GROUP_NM'));
					$input.focus();
					$input.select();
				};
				this.$el.on('mouseover', function(event) {
					$groupWrapper.addClass('ovr');
					$rename.show();
					return false;
				});
				this.$el.on('mouseout', function(event) {
					$groupWrapper.removeClass('ovr');
					$rename.hide();
					return false;
				});
				var $rename = $groupWrapper.find('a.mdf:first');
				$rename.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.editGroupName();
					return false;
				});
				var $row = this.$el.find('span.ml_t:first');
				$row.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('contextmenu:group', event, self.model, self);
					return false;
				});
				$row.dblclick(editGroupName);
				$input.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						$input.blur();
					}
				});
				$input.blur(function() {
					var groupName = $.trim($(this).val());
					var $groupWrapper = self.$el.find('span.set_onp:first');
					var $inputWrapper = self.$el.find('span.set_inp:first');
					if (!groupName) {
						return false;
					}
					if (groupName.length > 25) {
						alert(i18n.settings.groupMng.groupNameLengthOverflow);
						$input.focus();
						$input.select();
						return false;
					}
					if (groupName == i18n.myContact) {
						alert(i18n.alreadyDefaultGroup);
						return false;
					}
					if (groupName == self.model.get('GROUP_NM')) {
						$inputWrapper.hide();
						$groupWrapper.show();
						return false;
					}
					self.model.save({
						GROUP_NM : groupName
					}, {
						patch : true,
						wait : true,
						async : false,
						error : function(model, response, options) {
							switch (response.status) {
							case 409:
								alert(i18n.alreadyGroup);
								break;
							}
						},
					});
					$inputWrapper.show();
					$groupWrapper.hide();
					$input.val(groupName);
					$input.focus();
					$input.select();
					return false;
				});
				if (this.options.edit) {
					this.editGroupName();
				}
				this.$el.data('group-id', groupModel.get('GROUP_IDX'));
				this.$el.draggable({
					distance : 10,
					cursor : 'default',
					cursorAt : {
						top : -5,
						left : -5
					},
					appendTo : 'div.mc-wrap > div.mc-container',
					helper : function() {
						var $helper = $("<div />", {
							css : {
								'line-height' : '18px',
								'background-color' : '#eeeeee;',
								'padding' : '0 3px',
								'z-index' : '31'
							}
						}).append($('<span />', {
							css : {
								'display' : 'inline-block',
								'width' : '16px',
								'height' : '13px',
								'vertical-align' : 'middle',
								'background' : 'transparent url("img/tree_ico.png") no-repeat',
							},
							text : ' ',
						})).append(document.createTextNode(' ' + groupModel.get('GROUP_NM')));
						return $helper;
					},
				});
				this.$el.droppable({
					greedy : true,
					tolerance : 'pointer',
					accept : function(element) {
						var groupId = element.data('group-id');
						if (groupId && groupId !== $(this).data('group-id')) {
							return true;
						}
						var addressIds = element.data('address-ids');
						if (addressIds && addressIds.length) {
							return true;
						}
						return false;
					},
					drop : function(event, ui) {
						var groupId = ui.draggable.data('group-id');
						if (groupId) {
							var model = self.groupCollection.findModel('GROUP_IDX', groupId);
							if (!model || model.get('REF_GROUP_IDX') === $(this).data('group-id')) {
								return;
							}
							var filtered = self.groupCollection.filter(function(groupModel) {
								if (groupModel.get('GROUP_IDX') !== model.get('GROUP_IDX')
										&& groupModel.get('REF_GROUP_IDX') === model.get('REF_GROUP_IDX')
										&& groupModel.get('GROUP_NM') === model.get('GROUP_NM')) {
									return true;
								}
								return false;
							});
							if (filtered.length) {
								alert(i18n.alreadyGroup + ': ' + model.get('GROUP_NM'));
								return;
							}
							if (groupModel.get('FOLDED')) {
								(new contact.GroupModel({
									GROUP_IDX : groupModel.get('GROUP_IDX')
								})).save({
									FOLDED : 0
								}, {
									async : false,
									patch : true,
									success : function(model, response, options) {
										groupModel.set('FOLDED', 0);
									},
									error : function(model, response, options) {
										// ignore error
									},
								});
							}
							var originalParentId = model.get('REF_GROUP_IDX');
							model.save({
								REF_GROUP_IDX : groupModel.get('GROUP_IDX')
							}, {
								async : false,
								patch : true,
								wait : true,
								error : function(model, response, options) {
									model.set('REF_GROUP_IDX', originalParentId);
								},
							});
						} // end if (mboxId)
						var addressIds = ui.draggable.data('address-ids');
						if (addressIds && addressIds.length) {
							var model = new (app.BackboneModel.extend({
								urlRoot : 'groups/' + groupModel.get('GROUP_IDX'),
								defaults : {
									id : 'contacts'
								}
							}))();
							var jqXHR = model.save({
								GROUP_IDX : groupModel.get('GROUP_IDX'),
								addressIds : addressIds,
							}, {
								patch : true,
								wait : true,
								success : function(model, response, options) {
									// deferred success callback to jqXHR.done()
								},
								error : function(model, response, options) {
									// deferred error callback to jqXHR.fail()
								},
							});
							jqXHR.done(function(data, textStatus, jqXHR) {
								var paginator = contact.paginator;
								if (paginator.length == addressIds.length && addressIds.length == data.updated) {
									var info = paginator.info();
									if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
										var args = {
											page : info.currentPage - 1
										};
										location.hash = '#' + paginator.getURL(args);
									} else {
										paginator.pager();
									}
								} else {
									paginator.pager();
								}
								contact.selectedAddressCollection.reset();
								contact.groupCollection.fetch();
							}).fail(function(jqXHR, textStatus, errorThrown) {
								alert('Failed to move contacts.');
							});
						}
					},
					over : function(event, ui) {
						$(this).find('span.folder_name.set_onp').css('cursor', 'default');
					},
					out : function(event, ui) {
						$(this).find('span.folder_name.set_onp').css('cursor', '');
					},
				});
			},
			editGroupName : function(groupModel) {
				if (groupModel) {
					if (this.model.get('GROUP_IDX') !== groupModel.get('GROUP_IDX')) {
						return;
					}
				}
				var $groupWrapper = this.$el.find('span.set_onp:first');
				var $inputWrapper = this.$el.find('span.set_inp:first');
				var $input = $inputWrapper.find('input.input_text:first');
				$inputWrapper.show();
				$groupWrapper.hide();
				$input.val(this.model.get('GROUP_NM'));
				$input.focus();
				$input.select();
			},
			resetOptions : function() {
				this.options.edit = false;
			},
			appendHtml : function(collectionView, itemView) {
				collectionView.$('ul:first').append(itemView.el);
			},
			applyClassToItems : function($item) {
				var $items = this.parentView.$el.find('li span.ml_t');
				this.$el.find('span.ml_t:first')
				$items.removeClass('choice');
				if ($item) {
					$item.addClass('choice');
				} else {
					$item = this.$el.find('span.ml_t:first')
					var $link = this.$el.find('span.set_onp a.ma:first');
					var hash = location.hash;
					var href = $link.attr('href');
					if (hash == href)
						$item.addClass('choice');
				}
			},
		}); // contact.GroupItemView

		contact.ContactsView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.GroupItemView,
			itemViewContainer : 'ul',
			itemViewOptions : function(model, index) {
				var groupId = model.get('GROUP_IDX');
				var groupCollection = this.options.groupCollection;
				var groups = groupCollection.filter(function(model) {
					return model.get('REF_GROUP_IDX') === groupId;
				});
				return {
					collection : new contact.GroupCollection(groups),
					groupCollection : groupCollection,
					itemIndex : index,
					parentView : this,
				}
			},
			template : function(data) {
				var html, compiledTemplate = contact.ContactsView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-template').html();
					compiledTemplate = _.template(html);
					contact.ContactsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					groupCollection : contact.groupCollection,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.groupCollection = options.groupCollection;
			},
			onRender : function() {
				var self = this;
				var $item = this.$el.find('h3.menu_tadd');
				$item.click(function(event) {
					var $items = self.$el.find('li span.ml_t');
					$items.removeClass('choice');
				});
				var $myContact = this.$el.find('span.ml_t a.ma:first');
				$myContact.droppable({
					tolerance : 'pointer',
					accept : function(element) {
						var groupId = element.data('group-id');
						if (groupId && groupId !== $(this).data('group-id')) {
							return true;
						}
						var addressIds = element.data('address-ids');
						if (addressIds && addressIds.length) {
							return true;
						}
						return false;
					},
					drop : function(event, ui) {
						var groupId = ui.draggable.data('group-id');
						if (groupId) {
							var groupModel = self.groupCollection.findModel('GROUP_IDX', groupId);
							var filtered = self.groupCollection.filter(function(model) {
								if (model.get('REF_GROUP_IDX') === 0
										&& model.get('GROUP_NM') === groupModel.get('GROUP_NM')) {
									return true;
								}
								return false;
							});
							if (filtered.length) {
								if (filtered[0] === groupModel)
									return;
								alert(i18n.alreadyGroup + ': ' + groupModel.get('GROUP_NM'));
								return;
							}
							var originalParentId = groupModel.get('REF_GROUP_IDX');
							groupModel.save({
								REF_GROUP_IDX : 0
							}, {
								async : false,
								patch : true,
								wait : true,
								error : function(model, response, options) {
									model.set('REF_GROUP_IDX', originalParentId);
								},
							});
						}
						var addressIds = ui.draggable.data('address-ids');
						if (addressIds && addressIds.length) {
							var model = new (app.BackboneModel.extend({
								urlRoot : 'groups/0',
								defaults : {
									id : 'contacts'
								}
							}))();
							var jqXHR = model.save({
								GROUP_IDX : 0,
								addressIds : addressIds,
							}, {
								patch : true,
								wait : true,
								success : function(model, response, options) {
									// deferred success callback to jqXHR.done()
								},
								error : function(model, response, options) {
									// deferred error callback to jqXHR.fail()
								},
							});
							jqXHR.done(function(data, textStatus, jqXHR) {
								var paginator = contact.paginator;
								if (paginator.length == addressIds.length && addressIds.length == data.updated) {
									var info = paginator.info();
									if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
										var args = {
											page : info.currentPage - 1
										};
										location.hash = '#' + paginator.getURL(args);
									} else {
										paginator.pager();
									}
								} else {
									paginator.pager();
								}
								contact.selectedAddressCollection.reset();
								contact.groupCollection.fetch();
							}).fail(function(jqXHR, textStatus, errorThrown) {
								alert('Failed to move contacts.');
							});
						}
					},
					over : function(event, ui) {
						$(this).css('cursor', 'default');
					},
					out : function(event, ui) {
						$(this).css('cursor', '');
					},
				});
			},
		}); // contact.ContactView

		contact.GroupContextMenuView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'group-contextmenu',
			className : 'layer_bd layer_mouseright',
			attributes : {
				style : 'display: none; z-index: 2015;',
			},
			template : function(data) {
				var html, compiledTemplate = contact.GroupContextMenuView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#group-contextmenu-template').html();
					compiledTemplate = _.template(html);
					contact.GroupContextMenuView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.GroupModel
				this.listenTo(app.vent, 'contextmenu:group', this.showContextMenu);
			},
			onRender : function() {
				var self = this;
				var $contextMenu = $('body > #group-contextmenu');
				if ($contextMenu.length)
					$contextMenu.remove();
				$contextMenu = this.$el.appendTo('body');
				$contextMenu.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$contextMenu.attr('hidable', true);
				$contextMenu.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($contextMenu.outerHeight() > (viewportY - event.pageY)) {
					$contextMenu.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$contextMenu.css('top', event.pageY + 'px');
				}
				if ($contextMenu.outerWidth() > (viewportX - event.pageX)) {
					$contextMenu.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$contextMenu.css('left', event.pageX + 'px');
				}
				var $composeSms = this.$el.find('li.contact-compose-sms');
				var $composeMail = this.$el.find('li.contact-compose-mail');
				var $shareSetting = this.$el.find('li.contact-share-setting');
				var $rename = this.$el.find('li.contact-rename-group');
				var $description = this.$el.find('li.contact-add-description');
				var $delete = this.$el.find('li.contact-delete-group');
				var $addGroup = this.$el.find('li.contact-add-group');
				$composeSms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$groupMenu.hide();
					alert('문자 보내기 준비중...');
				});
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = {
						to : [],
					};
					params.to.push('#' + self.model.get('GROUP_NM'));
					location.hash = "compose?" + decodeURIComponent($.param(params, true));
					self.$el.hide();
				});
				$shareSetting.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!self.model) { // contact.groupModel
						return false;
					}
					app.vent.trigger('toggle:share-group-layout', self.model);
					var $shareSettingsLayer = $('#share_this');
					self.setPositionSettingsLayer($shareSettingsLayer);
					$(window).resize(function() {
						self.setPositionSettingsLayer($shareSettingsLayer);
					});
					self.$el.hide();
				});
				$rename.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.hide();
					app.vent.trigger('rename:group', self.model);
				});
				$description.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $descriptionView = $('#groupDescriptionLayer');
					var groupDescriptionView = new contact.GroupDescriptionView({
						model : self.model
					});
					groupDescriptionView.render();
					$descriptionView.html(groupDescriptionView.el);
					$descriptionView.show();
					$descriptionView.attr('hidable', false);
					// Layer 를 정중앙에 위치
					self.setPositionLayerView($descriptionView);
					$(window).resize(function() {
						// auto resize
						if ($descriptionView.is(':visible')) {
							self.setPositionLayerView($descriptionView);
						}
					});
					self.$el.hide();
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $deleteView = $('#deleteGroupConfirmLayer');
					var groupDeleteView = new contact.GroupDeleteView({
						model : self.model
					});
					groupDeleteView.render();
					$deleteView.html(groupDeleteView.el);
					$deleteView.show();
					// Layer 를 정중앙에 위치
					self.setPositionLayerView($deleteView);
					$(window).resize(function() {
						// auto resize
						if ($deleteView.is(':visible')) {
							self.setPositionLayerView($deleteView);
						}
					});
					self.$el.hide();
				});
				$addGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $list = self.groupItemView.$el.find('ul:first');
					var level = $list.attr('class').slice($list.attr('class').length - 1);
					if (level == '5') {
						alert(i18n.createSubgroupUpToDepth);
						self.$el.hide();
						return false;
					}
					var groupName = i18n.importGroupName;
					var check = function(groupName) {
						var exist = false;
						var groups = contact.groupCollection.filter(function(groupModel) {
							return groupModel.get('GROUP_NM') == groupName;
						});
						if (groups.length > 0) {
							exist = true;
						}
						return exist;
					};
					for (var i = 1; check(groupName);) {
						if (i > 1) {
							groupName = groupName.substring(0, groupName.indexOf('('));
						}
						groupName += '(' + i + ')';
						i++;
					}
					contact.groupCollection.create({
						GROUP_NM : groupName,
						REF_GROUP_IDX : self.model.get('GROUP_IDX'),
					}, {
						wait : true,
						async : false,
					});
					if (self.model.get('FOLDED')) {
						self.model.save({
							FOLDED : 0
						}, {
							patch : true,
							wait : true,
							async : false,
							error : function(model, response, options) {
								app.log('Failed to update groupModel folded');
							},
						});
					}
					var groupModel = contact.groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_NM') == groupName;
					});
					self.$el.hide();
					var isNew = true;
					app.vent.trigger('rename:group', groupModel, isNew);
				});
			},
			setPositionLayerView : function($layerView) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width() / 2;
				var viewportHeight = $viewport.height() / 2;
				var width = $layerView.width() / 2;
				var height = $layerView.height() / 2;
				var top = Math.floor(viewportHeight - height);
				var left = Math.floor(viewportWidth - width);
				$layerView.css({
					position : 'absolute',
					display : 'block',
					top : top,
					left : left,
				});
			},
			setPositionSettingsLayer : function($shareSettingsLayer) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width();
				var viewportHeight = $viewport.height();
				var scrollTop = $viewport.scrollTop();
				var scrollLeft = $viewport.scrollLeft();
				var layerWidth = $shareSettingsLayer.width();
				var layerHeight = $shareSettingsLayer.height();
				var top, left, marginTop, marginLeft;

				if (viewportHeight > layerHeight) {
					top = "50%";
					marginTop = -(layerHeight / 2) + scrollTop + "px";
				} else {
					top = scrollTop + "px";
					marginTop = "0";
				}

				if (viewportWidth > layerWidth) {
					left = "50%";
					marginLeft = -(layerWidth / 2) + scrollLeft + "px";
				} else {
					left = scrollLeft + "px";
					marginLeft = "0";
				}

				$shareSettingsLayer.css({
					position : 'absolute',
					top : top,
					left : left,
					'margin-top' : marginTop,
					'margin-left' : marginLeft
				});
			},
			showContextMenu : function(mouseEvent, groupModel, groupItemView) {
				this.mouseEvent = mouseEvent;
				this.model = groupModel;
				this.groupItemView = groupItemView;
				this.render().$el.show();
			}
		}); // contact.GroupContextMenuView

		contact.ContentLayout = Backbone.Marionette.Layout.extend({
			// parentEl : '.mc-content',
			template : function(data) {
				var html = contact.$template.filter('#content-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
					group : data,
				});
				return html;
			},
			regions : {
				contentHeaderRegion : '#contentGroupHeader',
				contactToolbarRegion : '#addressBtn_fol',
				filterToolbarRegion : 'div.contact-filter-toolbar',
				envToolbarRegion : 'div.set_tab_area',
				selectedContactbarRegion : 'div.selected-contactbar',
				contactListRegion : 'div.content_original div.contact-list',
				contactTrashListRegion : 'div.content_original div.contact-trash-list',
				envListRegion : 'div.env_contentArea',
				moveToGroupRegion : '#groupManagementLayer',
				categoryFilterRegion : '#contactTypeFilterLayer',
				exposeListRegion : '#contactCustomFieldLayer',
				exportLayerRegion : '#exportButtonLayer',
				orgHeaderRegion : '#orgHeader',
				orgToolbarRegion : '#addressBtn_org',
				orgFilterToolbarRegion : 'div.org-filter-toolbar',
				orgCategoryFilterRegion : '#orgTypeFilterLayer',
				orgExposeListRegion : '#orgCustomFieldLayer',
				addToContactRegion : '#orgManagementLayer',
				orgListRegion : 'div.content_original div.org-list',
				sharedContactListRegion : 'div.content_original div.shared-contact-list',
				sharedContentHeaderRegion : '#sharedGroupHeader',
				sharedToolbarRegion : '#addressBtn_share',
				sharedFilterToolbarRegion : 'div.shared-filter-toolbar',
				sharedCategoryFilterRegion : '#sharedGroupTypeFilterLayer',
				shareSettingsRegion : '#share_this',
				shareeListRegion : '.sharee-list-layer',
			},
			initialize : function(options) {
				// this.model == contact.GroupModel
				this.userModel = options.userModel;
				this.paginator = options.paginator;
				this.groupModel = options.groupModel;
				this.listenTo(app.vent, 'hide:export-merge-views', this.hideMergeView);
				this.listenTo(app.vent, 'paginate:org-entries', this.showOrgListView);
				this.listenTo(app.vent, 'toggle:share-group-layout', this.showShareSettingsView);
				this.listenTo(this, 'toggle:sharee-list-view', this.showShareeListView);
				this.listenTo(app.vent, 'hide:share-settings-layout', this.hideShareGroupView);
				this.listenTo(app.vent, 'change:contact-views', this.changeContactView);
				this.listenTo(app.vent, 'hide:expose-list-view', this.hideExposeListView);
				this.listenTo(app.vent, 'hide:orgExpose-list-view', this.hideOrgExposeListView);
			},
			onRender : function() {
				this.contentHeaderRegion.show(new contact.ContentHeaderView({
					model : this.model,// contact.GroupModel
					collection : this.paginator,
					parentView : this,
				}));
				this.contactListRegion.show(new contact.ContactListView({
					model : this.model,
					collection : this.paginator,
					userModel : this.userModel,
				}));
				this.contactToolbarRegion.show(new contact.ContentToolbarView({
					model : this.model,// contact.GroupModel
					collection : this.paginator,
					parentView : this,
				}));
				this.filterToolbarRegion.show(new contact.ContentFilterToolbarView({
					model : this.model,// contact.GroupModel
					collection : this.paginator,
				}));
				this.selectedContactbarRegion.show(new contact.SelectedContactbarView({
					collection : contact.selectedAddressCollection
				}));
				this.contactTrashListRegion.show(new contact.ContactTrashListView({
					model : this.model,// contact.GroupModel
					collection : this.paginator,
				}));
				this.orgHeaderRegion.show(new contact.OrgHeaderView({
					model : new Backbone.Model({
						group : new app.org.OrgGroupModel(),
						paginator : contact.orgPaginator,
					}),
					collection : contact.orgPaginator,
				}));
				this.orgToolbarRegion.show(new contact.OrgToolbarView({
					collection : contact.orgPaginator,
					parentView : this.parentView,
				}));
				this.orgFilterToolbarRegion.show(new contact.OrgFilterToolbarView({
					model : this.userModel,
					collection : contact.orgPaginator,
				}));
				this.moveToGroupRegion.show(new contact.MoveToGroupView({
					collection : contact.groupCollection,
					paginator : this.paginator,
					parentView : this,
				}));
				this.exportLayerRegion.show(new contact.ExportMergeView({
					collection : contact.selectedAddressCollection,
					paginator : this.paginator,
				}));
				this.categoryFilterRegion.show(new contact.CategoryFilterView({
					model : this.userModel,
					collection : this.paginator,
				}));
				this.exposeListRegion.show(new contact.ExposeListView({
					model : this.userModel,
				}));
				this.sharedContentHeaderRegion.show(new contact.SharedContentHeaderView({
					model : contact.sharedGroupModel,
					collection : contact.sharedPaginator,
				}));
				this.sharedToolbarRegion.show(new contact.SharedContentToolbarView({
					model : contact.sharedGroupModel,
					collection : contact.sharedPaginator,
				}));
				this.sharedFilterToolbarRegion.show(new contact.SharedContentFilterToolbarView({
					model : contact.sharedGroupModel,
					collection : contact.sharedPaginator,
				}));
				this.sharedCategoryFilterRegion.show(new contact.SharedGroupCategoryFilterView({
					model : this.userModel,
					collection : contact.sharedPaginator,
				}));
				this.sharedContactListRegion.show(new contact.SharedContactListView({
					model : contact.sharedGroupModel,
					collection : contact.sharedPaginator,
					userModel : this.userModel,
				}));
			},
			onShow : function() {
				var $parent = this.$el.parent('div.content_cst');
				$parent.addClass('page_mp');
			},
			showOrgListView : function(params) {
				var self = this;
				contact.orgPaginator = new app.org.OrgEntryPaginator();
				var paginator = contact.orgPaginator;
				var url = 'org/root/entries';
				if (params.url) {
					paginator.paginator_core.url = params.url;
				} else {
					paginator.paginator_core.url = url;
				}
				params._method = 'GET';
				paginator.setParams(params);
				paginator.fetch({
					success : function(collection, response, options) {
						if (!paginator.server_api.groupId && response.parentGroupId) {
							paginator.server_api.groupId = response.parentGroupId;
						}
						collection.pager();

						var orgGroupModel = new app.org.OrgGroupModel({
							USER_GROUP_IDX : response.parentGroupId
						});
						if (orgGroupModel.get('USER_GROUP_IDX') > 0) {
							var urlRoot = _.result(orgGroupModel, 'urlRoot');
							urlRoot += '/' + app.userModel.get('DOMAIN') + '/groups/';
							orgGroupModel.urlRoot = urlRoot;
							orgGroupModel.fetch({
								success : function(model, response, options) {
									app.vent.trigger('change:orgEntry', model);
								},
								error : function(model, response, options) {
								},
							});
						}

						self.orgHeaderRegion.show(new contact.OrgHeaderView({
							model : new Backbone.Model({
								group : orgGroupModel,
								paginator : paginator,
							}),
							collection : paginator,
						}));
						self.orgToolbarRegion.show(new contact.OrgToolbarView({
							collection : self.paginator,
							parentView : self,
						}));
						self.addToContactRegion.show(new contact.OrgAddContactView({
							userModel : self.userModel,
							collection : contact.groupCollection,
							orgCollection : self.paginator.models,
						}));
						self.orgFilterToolbarRegion.show(new contact.OrgFilterToolbarView({
							model : self.userModel,
							collection : paginator,
						}));
						self.orgCategoryFilterRegion.show(new contact.OrgCategoryFilterView({
							model : self.userModel,
							collection : paginator,
						}));
						self.orgExposeListRegion.show(new contact.OrgExposeListView({
							model : self.userModel,
							collection : paginator,
						}));
						self.orgListRegion.show(new contact.OrgListView({
							model : self.userModel, // app.contactUserModel
							collection : paginator,
							selectedAddressCollection : contact.selectedAddressCollection,
						}));
						self.orgListRegion.$el.show();
						contact.overlayView.hideLoading();
					},
					silent : true,
				});
			},
			showShareSettingsView : function(groupModel) {
				if (!groupModel) {
					return;
				}
				this.shareSettingsRegion.show(new contact.ShareSettingsLayout({
					model : this.userModel,
					groupModel : groupModel,
				}));
				var $this = this.shareSettingsRegion.$el;
				$this.toggle();
				if ($this.is(':visible')) {
					app.vent.trigger('fetch:shared-recipients', groupModel); // groupModel
				}
				$this.attr('hidable', false);
				$this.click(function(event) {
					event.preventDefault() && event.stopPropagation();
				});
			},
			showShareeListView : function(groupModel) {
				if (!groupModel) {
					return;
				}
				var self = this;
				var url = 'shared-groups/' + groupModel.get('GROUP_IDX') + '/recipients';
				if (this.shareeListRegion.$el && this.shareeListRegion.$el.is(':visible')) {
					this.shareeListRegion.$el.hide();
				} else {
					contact.shareCollection.fetch({
						url : url,
						success : function(collection) {
							self.shareeListRegion.show(new contact.ShareeListView({
								model : new Backbone.Model({
									userModel : app.userModel,
									shareeCollection : collection,
								}),
							}));
							self.shareeListRegion.$el.show();
							var top = self.contentHeaderRegion.$el.height();
							var left = self.contentHeaderRegion.$el.find('a.sharee-list').position().left;
							self.shareeListRegion.$el.css({
								top : top,
								left : left,
							});
						}
					});
				}
			},
			hideMergeView : function() {
				this.exportLayerRegion.$el.hide();
			},
			hideShareGroupView : function() {
				this.shareSettingsRegion.$el.hide();
			},
			changeContactView : function(type, groupModel) {
				switch (type) {
				case 'contact':
					// header
					this.contentHeaderRegion.$el.show();
					this.orgHeaderRegion.$el.hide();
					this.sharedContentHeaderRegion.$el.hide();
					// toolbar
					this.contactToolbarRegion.$el.show();
					this.orgToolbarRegion.$el.hide();
					this.sharedToolbarRegion.$el.hide();
					this.filterToolbarRegion.$el.show();
					this.orgFilterToolbarRegion.$el.hide();
					this.sharedFilterToolbarRegion.$el.hide();
					// list
					if (groupModel) {
						if (this.model.get('GROUP_TYPE') != groupModel.get('GROUP_TYPE')) {
							contact.selectedAddressCollection.reset();
						}
						this.model = groupModel;
					}
					if (this.model.get('GROUP_TYPE') == 'T') {
						this.contactListRegion.$el.hide();
						this.contactTrashListRegion.$el.show();
					} else {
						this.contactListRegion.$el.show();
						this.contactTrashListRegion.$el.hide();
					}
					if (this.orgListRegion.$el)
						this.orgListRegion.$el.hide();
					this.sharedContactListRegion.$el.hide();
					break;
				case 'org':
					// header
					this.contentHeaderRegion.$el.hide();
					this.orgHeaderRegion.$el.show();
					this.sharedContentHeaderRegion.$el.hide();
					// toolbar
					this.contactToolbarRegion.$el.hide();
					this.orgToolbarRegion.$el.show();
					this.sharedToolbarRegion.$el.hide();
					this.filterToolbarRegion.$el.hide();
					this.orgFilterToolbarRegion.$el.show();
					this.sharedFilterToolbarRegion.$el.hide();
					// list
					this.contactListRegion.$el.hide();
					this.contactTrashListRegion.$el.hide();
					this.sharedContactListRegion.$el.hide();
					break;
				case 'share':
					// header
					this.contentHeaderRegion.$el.hide();
					this.orgHeaderRegion.$el.hide();
					this.sharedContentHeaderRegion.$el.show();
					// toolbar
					this.contactToolbarRegion.$el.hide();
					this.orgToolbarRegion.$el.hide();
					this.sharedToolbarRegion.$el.show();
					this.filterToolbarRegion.$el.hide();
					this.orgFilterToolbarRegion.$el.hide();
					this.sharedFilterToolbarRegion.$el.show();
					// list
					this.contactListRegion.$el.hide();
					this.contactTrashListRegion.$el.hide();
					if (this.orgListRegion.$el)
						this.orgListRegion.$el.hide();
					this.sharedContactListRegion.$el.show();
					break;
				}
			},
			hideExposeListView : function() {
				this.exposeListRegion.$el.hide();
			},
			hideOrgExposeListView : function() {
				this.orgExposeListRegion.$el.hide();
			},
		}); // contact.ContentLayout

		contact.ContentHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ContentHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#content-header-template').html();
					compiledTemplate = _.template(html);
					contact.ContentHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					groupCollection : contact.groupCollection,
					contacts : contact.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = contact.ContactPaginator
				this.parentView = options.parentView;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'change:group', this.replaceGroupModel);
			},
			replaceGroupModel : function(groupModel, params) {
				this.stopListening(this.model);
				this.model = groupModel;
				this.listenTo(this.model, 'change', this.render);
				this.render();
			},
			onRender : function() {
				var self = this;
				var $shareeList = this.$el.find('.sharee-list');
				$shareeList.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.parentView.trigger('toggle:sharee-list-view', self.model);
				});
				var $searchInput = this.$el.find('.mc-search');
				$searchInput.keydown(function(event) {
					if (event.which == 13) {
						var term = $(this).val();
						if (term) {
							self.search(term);
						}
					}
				});
				var $searchBtn = this.$el.find('.mc-search_btn');
				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var term = $searchInput.val();
					if (term) {
						self.search(term);
					}
				});
			},
			search : function(term) {
				if (term && (term.indexOf('%') != -1 || term.indexOf('_') != -1)) {
					alert(i18n.search.invalidToken);
					return;
				}
				if (location.hash.indexOf('trash') != -1) {
					contact.groupModel = contact.groupCollection.getGroupModel('GROUP_TYPE', 'A');
				}
				var hash = '#contacts/all/contacts?search=' + encodeURIComponent(encodeURIComponent(term));
				location.hash = hash;
			},
		}); // contact.ContentHeaderView

		contact.ShareeListView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ShareeListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#sharee-list-template').html();
					compiledTemplate = _.template(html);
					contact.ShareeListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data.userModel.toJSON(),
					sharees : data.shareeCollection.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
			},
		}); // contact.ShareeListView

		contact.ContentToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ContentToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-toolbar-template').html();
					compiledTemplate = _.template(html);
					contact.ContentToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.GroupModel
				// this.collection == contact.paginator;
				this.listenTo(app.vent, 'change:group', this.replaceGroupModel);
				this.parentView = options.parentView;
			},
			replaceGroupModel : function(groupModel, params) {
				this.model = groupModel;
				this.render();
			},
			onRender : function() {
				var self = this;
				var $el = this.$el;
				var $selectAll = $el.find('div.mc-buttonSet .contact-toolbar-selectAll');
				var $delete = $el.find('div.mc-buttonSet .contact-toolbar-delete');
				var $move = $el.find('div.mc-buttonSet .contact-toolbar-move');
				var $export = $el.find('div.mc-buttonSet .contact-toolbar-export');
				var $composeMail = $el.find('div.mc-buttonSet .contact-toolbar-compose-mail');
				var $composeSms = $el.find('div.mc-buttonSet .contact-toolbar-compose-sms');
				var $composeNote = $el.find('div.mc-buttonSet .contact-toolbar-compose-note');
				var $print = $el.find('.mc-rightTool .ic');
				var $shareSettings = $el.find('#group_share');
				var selectAddressList = contact.selectedAddressCollection;
				$selectAll.click(function(event) {
					event.stopPropagation();
					var $listRegion = self.model.get('GROUP_TYPE') == 'T' ? self.parentView.contactTrashListRegion.$el
							: self.parentView.contactListRegion.$el;
					var $toggle = $listRegion.find('#checkListAll');
					var $checkboxes = $listRegion.find('div.scroll_zoom td.check input.inp_ch');
					var $this = $(this);
					if ($this.is('.toolbar-selectAll')) {
						$this.removeClass('toolbar-selectAll');
						$checkboxes.prop('checked', false);
						$toggle.prop('checked', false);
						self.collection.forEach(function(model) {
							contact.selectedAddressCollection.remove(model);
						});
					} else {
						$this.addClass('toolbar-selectAll');
						$checkboxes.prop('checked', true);
						$toggle.prop('checked', true);
						self.collection.forEach(function(model) {
							contact.selectedAddressCollection.add(model);
						});
					}
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (selectAddressList.length < 1) {
						alert(i18n.deleteMsg.pleaseSelectContact);
						return;
					}
					if (contact.groupModel) {
						var msg = i18n.deleteMsg.confirmDeleteContact;
						var GROUP_TYPE = contact.groupModel.get('GROUP_TYPE');
						if (GROUP_TYPE == 'T') {
							if (confirm(msg)) {
								self.deleteContacts(selectAddressList);
							}
						} else {
							self.trashContacts(selectAddressList);
						}
					}
				});
				$move.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $groupLayer = $('#groupManagementLayer');
					var $header = $('.mc-content_header');
					var left, top, $target = $(event.currentTarget);
					top = $header.height() + $target.position().top + $target.height();
					left = $target.position().left;
					$groupLayer.css({
						top : top,
						left : left,
					});
					app.vent.trigger('remove:address');
					$groupLayer.attr('hidable', 'false');
					$groupLayer.toggle();
				});
				$export.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $exportLayer = $('#exportButtonLayer');
					var $header = $('.mc-content_header');
					var left, top, $target = $(event.currentTarget);

					top = $header.height() + $target.position().top + $target.height();
					left = $target.position().left;

					$exportLayer.css({
						top : top,
						left : left,
					});
					$exportLayer.attr('hidable', 'false');
					$exportLayer.toggle();
				});
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1) {
						alert(i18n.pleaseSelectContact);
						return;
					}
					var models = contact.selectedAddressCollection.filter(function(model) {
						return model.get('ADDRESS_EMAIL');
					});
					var params = {
						to : [],
					};
					for (var i = 0; i < models.length; i++) {
						var alias = models[i].get('ADDRESS_NAME');
						var email = models[i].get('ADDRESS_EMAIL');
						if (email) {
							var param = '';
							if (alias) {
								param += '"' + alias + '"';
								param += '<' + email + '>';
							} else {
								param += email;
							}
							params.to.push(param);
						}
					}
					location.hash = "compose?" + decodeURIComponent($.param(params, true));
				});
				$composeSms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1) {
						alert('연락처를 선택해 주세요.');
						return;
					}
					alert('문자 보내기 준비중...');
				});
				$composeNote.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1) {
						alert('연락처를 선택해 주세요.');
						return;
					}
					alert('쪽지 보내기 준비중...');
				});
				$shareSettings.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('toggle:share-group-layout', self.model);
					var $shareSettingsLayer = $('#share_this');
					self.setPositionSettingsLayer($shareSettingsLayer);
					$(window).resize(function() {
						self.setPositionSettingsLayer($shareSettingsLayer);
					});
				});
				$print.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					alert('인쇄하기 준비중...');
				});
			},
			deleteContacts : function(selectAddressList) {
				var self = this;
				var ids = [];
				var contactListView = this.parentView.contactListRegion.currentView;
				var $contentItemViewContainer = contactListView.$itemViewContainer;
				var $checkboxes = $contentItemViewContainer.find('input[type=checkbox]');
				selectAddressList.forEach(function(addressModel) {
					if (addressModel.get('GROUP_IDX') == contact.groupModel.get('GROUP_IDX')) {
						ids.push(addressModel.get('ADDRESS_IDX'));
					}
				});
				if (ids.length === 0) {
					return;
				}
				var model = new (app.BackboneModel.extend({
					url : function() {
						var url = 'groups/' + contact.groupModel.get('GROUP_IDX') + '/contacts';
						for (var i = 0; i < ids.length; i++) {
							url += (i == 0 ? '?' : '&') + 'id=' + ids[i];
						}
						return url;
					},
					defaults : {
						id : 'contacts'
					}
				}))();
				var jqXHR = model.destroy({
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					var paginator = self.collection;
					if ($checkboxes.length == ids.length && ids.length == data.deleted) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
						} else {
							paginator.pager();
						}
					} else {
						paginator.pager();
					}
					contact.selectedAddressCollection.reset();
					contact.groupCollection.fetch();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					alert('Failed to delete contacts.');
				});
			},
			trashContacts : function(selectAddressList) {
				var self = this;
				var ids = [];
				var contactListView = this.parentView.contactListRegion.currentView;
				var $contentItemViewContainer = contactListView.$itemViewContainer;
				var $checkboxes = $contentItemViewContainer.find('input[type=checkbox]');
				var trashGroupModel = contact.groupCollection.findModel('GROUP_TYPE', 'T');
				if (!trashGroupModel) {
					return;
				}
				selectAddressList.forEach(function(addressModel) {
					ids.push(addressModel.get('ADDRESS_IDX'));
				});
				if (ids.length === 0) {
					return;
				}
				var model = new (app.BackboneModel.extend({
					urlRoot : 'groups/' + contact.groupModel.get('GROUP_IDX'),
					defaults : {
						id : 'contacts'
					}
				}))();
				var jqXHR = model.save({
					GROUP_IDX : contact.groupModel.get('GROUP_IDX'),
					addressIds : ids,
					moveOption : 'trash',
				}, {
					patch : true,
					wait : true,
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					var paginator = self.collection;
					if ($checkboxes.length == ids.length && ids.length == data.updated) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
						} else {
							paginator.pager();
						}
					} else {
						paginator.pager();
					}
					contact.selectedAddressCollection.reset();
					contact.groupCollection.fetch();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					alert('Failed to trash contacts.');
				});
			},
			setPositionSettingsLayer : function($shareSettingsLayer) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width();
				var viewportHeight = $viewport.height();
				var scrollTop = $viewport.scrollTop();
				var scrollLeft = $viewport.scrollLeft();
				var layerWidth = $shareSettingsLayer.width();
				var layerHeight = $shareSettingsLayer.height();
				var top, left, marginTop, marginLeft;

				if (viewportHeight > layerHeight) {
					top = "50%";
					marginTop = -(layerHeight / 2) + scrollTop + "px";
				} else {
					top = scrollTop + "px";
					marginTop = "0";
				}

				if (viewportWidth > layerWidth) {
					left = "50%";
					marginLeft = -(layerWidth / 2) + scrollLeft + "px";
				} else {
					left = scrollLeft + "px";
					marginLeft = "0";
				}

				$shareSettingsLayer.css({
					position : 'absolute',
					top : top,
					left : left,
					'margin-top' : marginTop,
					'margin-left' : marginLeft
				});
			},
		}); // contact.ContentToolbarView

		contact.ContentFilterToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ContentFilterToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-filter-toolbar-template').html();
					compiledTemplate = _.template(html);
					contact.ContentFilterToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == contact.paginator
				this.listenTo(app.vent, 'change:group', this.replaceGroupModel);
			},
			onRender : function() {
				var self = this;
				var $category = this.$el.find('.view_box li:first');
				var $exposure = this.$el.find('.view_box li:eq(1)');
				var $searchKey = this.$el.find('.word_box li');
				var $item = this.$el.find('ul.word_box li span');
				var keyIndex;
				if (location.hash) {
					var link = document.createElement("a");
					link.href = location.hash.substring(location.hash.indexOf('#') + 1);
					if (link.search.indexOf('keyIndex') == 1) {
						keyIndex = link.search.split('=')[1];
						keyIndex = decodeURIComponent(decodeURIComponent(keyIndex));
					}
				}
				$item.each(function() {
					if (keyIndex === 'all') {
						keyIndex = i18n.all;
					} else if (keyIndex === 'other') {
						keyIndex = i18n.other;
					} else if (keyIndex === 'noname') {
						keyIndex = i18n.noname;
					}
					if ($(this).text() === keyIndex) {
						self.selectItem($(this).parent());
					}
				});
				$category.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $header = $('.mc-content_header');
					var $categoryLayer = $('contactTypeFilterLayer');
					var left, top, $target = $(this);

					top = $header.height() + $target.position().top + $target.height();
					left = $target.position().left;

					$categoryLayer.css({
						top : top,
						left : left,
					});
				});

				$searchKey.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.selectItem($(this).children('a:first'));
					var hash;
					var GROUP_IDX = self.model.get('GROUP_IDX');
					var keyIndex = $(this).find('span').text();
					if (keyIndex === i18n.all) {
						keyIndex = 'all';
					} else if (keyIndex === i18n.other) {
						keyIndex = 'other';
					} else if (keyIndex === i18n.noname) {
						keyIndex = 'noname';
					}
					keyIndex = encodeURIComponent(encodeURIComponent(keyIndex));
					if (GROUP_IDX == 0) {
						hash = '#contacts/all/contacts?keyIndex=' + keyIndex;
					} else {
						hash = '#contacts/' + self.model.get('GROUP_IDX') + '/contacts?keyIndex=' + keyIndex;
					}
					location.hash = hash;
				});

				$exposure.click(function(event) {
					event.preventDefault() && event.stopPropagation();

				});
			},
			selectItem : function($this) {
				var $parent = $this.parent();
				$parent.siblings().removeClass('clk');
				$parent.addClass('clk');
			},
			replaceGroupModel : function(groupModel) {
				this.model = groupModel;
			},
		}); // contact.ContentFilterToolbarView

		contact.SelectedContactItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = contact.SelectedContactItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#selected-contact-item-template').html();
					compiledTemplate = _.template(html);
					contact.SelectedContactItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var self = this;
				var $delete = this.$el.find('a.del');
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					contact.selectedAddressCollection.remove(self.model);
				});
			},
		}); // contact.SelectedContactItemView

		contact.SelectedContactbarView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.SelectedContactItemView,
			itemViewContainer : 'div.cphone_pad div.cphone_view .cphone_list',
			template : function(data) {
				var html, compiledTemplate = contact.SelectedContactbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#selected-contactbar-template').html();
					compiledTemplate = _.template(html);
					contact.SelectedContactbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contacts : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(this.collection, 'add', this.renderItems);
				this.listenTo(this.collection, 'remove', this.renderItems);
				this.listenTo(this.collection, 'reset', this.renderItems);
			},
			onRender : function() {
				var self = this;
				var $selected = $('.content_cst');
				var $selectedLayer = $('.cphone_area');
				var $deleteAll = this.$el.find('.cphone_tit a.del');
				var $expansion = this.$el.find('.cphone_btn');

				$deleteAll.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$selected.removeClass('cphone_yes');
					self.collection.reset();
				});
				$expansion.click(function(event) {
					// TODO selectLayer가 선택 되지 않아 다시 봐야함....
					event.preventDefault() && event.stopPropagation();
					$selectedLayer.addClass('cphone_open');

				});

				this.renderItems();
			},
			renderItems : function() {
				var self = this;
				var $selected = $('.content_cst');
				var $selectedCount = this.$el.find('.cphone_tit strong');

				if (self.collection.length > 0) {
					$selected.addClass('cphone_yes');
					$selectedCount.html(self.collection.length);
				} else {
					$selected.removeClass('cphone_yes');
				}
			},
		}); // contact.ContentFilterToolbarView

		contact.ContactItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = contact.ContactItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-item-template').html();
					compiledTemplate = _.template(html);
					contact.ContactItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					groupCollection : contact.groupCollection,
					user : contact.contactUserModel.toJSON(),
					params : contact.params,
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var self = this;
				this.$el.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagtion();
					app.vent.trigger('contextmenu:contact', event, self.model, self);
					return false;
				});
				var ADDRESS_IMPORTANT = this.model.get('ADDRESS_IMPORTANT');
				var $important = this.$el.find('.star a');
				var $td = this.$el.find('td');
				var $viewWrapper = $('#contactMan');
				var $view = $('#customerView');
				var $modifyView = $('#addressModify');
				this.$checkbox = this.$el.find('td.check input.inp_ch');
				if (ADDRESS_IMPORTANT == 'Y') {
					$important.addClass('on');
				} else {
					$important.removeClass('on');
				}
				$important.click(function(event) {
					event.preventDefault();
					event.stopPropagation();
					if (ADDRESS_IMPORTANT === 'Y') {
						self.model.save({
							ADDRESS_IMPORTANT : 'N',
							patchImportant : 1,
						}, {
							patch : true,
							wait : true
						});
					} else {
						self.model.save({
							ADDRESS_IMPORTANT : 'Y',
							patchImportant : 1,
						}, {
							patch : true,
							wait : true
						});
					}
				});
				this.$checkbox.change(function(event) {
					event.stopPropagation();
					var $elem = $(self.el)
					if ($(this).is(':checked')) {
						$elem.addClass('focus');
						contact.selectedAddressCollection.add(self.model);
					} else {
						$elem.removeClass('focus');
						contact.selectedAddressCollection.remove(self.model);
					}
				});
				this.$checkbox.click(function(event) {
					event.stopPropagation();
				});
				$td.click(function(event) {
					if (event.which != 1)
						return false;
					if (self.$checkbox.is(':checked')) {
						self.$checkbox.prop('checked', false);
					} else {
						self.$checkbox.prop('checked', true);
					}
					self.$checkbox.change();
				});
				this.$name = this.$el.find('td.name a');
				this.$name.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var detailView = new contact.ContactDetailView({
						model : self.model,
					});
					detailView.render();
					$view.html(detailView.el);
					$viewWrapper.css('zIndex', '32001');
					$viewWrapper.show();
					$view.show();
					contact.overlayView.showOverlay();
				});
				this.$modify = this.$el.find('.modify a');
				this.$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.model.get('ORG_EMAIL')) {
						alert(i18n.organizationNotBeModified);
						return;
					} else if (self.model.get('SHARE_ADDRESS_IDX')) {
						alert(i18n.sharedContactsNotBeModified);
						return;
					}
					var options = {};
					options['silent'] = true;
					contact.selectedAddressCollection.reset();
					contact.selectedAddressCollection.add(self.model, options);
					contact.selectedAddressCollection.title = i18n.addAddress.modifyTitle;
					app.vent.trigger('contact:modifyView', contact.selectedAddressCollection);
				});
				this.$el.draggable({
					distance : 10,
					cursor : 'default',
					cursorAt : {
						top : -1,
						left : -1
					},
					appendTo : 'div.mc-wrap > div.mc-container',
					helper : function() {
						var $helper = $("<div />", {
							css : {
								'line-height' : '18px',
								'background-color' : 'transparent',
								'padding' : '0 6px',
								'z-index' : '31',
							}
						}).append($('<span />', {
							css : {
								'display' : 'inline-block',
								'width' : '16px',
								'height' : '16px',
								'vertical-align' : 'middle',
								'background' : 'transparent url("img/addr_left_menu.png") no-repeat',
								'background-position' : '-37px -95px',
							},
							text : ' ',
						})).append(document.createTextNode(' ' + self.model.get('ADDRESS_NAME')));
						return $helper;
					},
					start : function(event, ui) {
						var $checkboxes = self.options.parentView.$checkboxes;
						var addressIds = [];
						$checkboxes.each(function(index, element) {
							if (this.checked)
								addressIds.push(parseInt(this.value));
						});
						if (addressIds.length == 0 || !_.contains(addressIds, self.model.get('ADDRESS_IDX'))) {
							self.$checkbox.prop('checked', true).change();
							addressIds.push(self.model.get('ADDRESS_IDX'));
						}
						$(this).data('address-ids', addressIds);
					},
				});
			},
		}); // contact.ContactItemView

		contact.ContactListView = Backbone.Marionette.CompositeView.extend({
			// parentEl : 'div.list_view',
			itemView : contact.ContactItemView,
			itemViewContainer : 'div.list_area div.scroll_zoom tbody',
			itemViewOptions : function(model, index) {
				return {
					parentView : this
				};
			},
			template : function(data) {
				var html, compiledTemplate = contact.ContactListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-list-template').html();
					compiledTemplate = _.template(html);
					contact.ContactListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : contact.contactUserModel.toJSON(),
					paginator : contact.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'paginate:contacts', this.paginateContacts);
				this.listenTo(contact.selectedAddressCollection, 'reset', this.resetCheckboxes);
				this.listenTo(contact.selectedAddressCollection, 'remove', this.unchecked);
			},
			onRender : function() {
				var self = this, $el = this.$el;
				if (this.contactContextMenuView)
					this.contactContextMenuView.close();
				this.contactContextMenuView = new contact.ContactContextMenuView();
				var $toggle = $el.find('#checkListAll');
				var $checkboxes = this.$checkboxes = $el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				var $headerColgroup = $el.find('#listHead [data-expose=none]');
				var $listColgroup = $el.find('#defaultArea [data-expose=none]');

				this.switchListViewOptions($headerColgroup, $listColgroup);

				var checked = 0;
				$checkboxes.each(function(index, checkbox) {
					var $this = $(checkbox);
					contact.selectedAddressCollection.each(function(addressModel) {
						var contactId = addressModel.get('ADDRESS_IDX');
						if ($this.val() == contactId) {
							$this.attr('checked', true).trigger('change');
							checked++;
						}
					});
				});
				if (checked > 0 && checked == $checkboxes.length) {
					$toggle.attr('checked', true);
				}
				$toggle.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
					$checkboxes.change();
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length)
							$toggle.prop('checked', true);
					} else {
						$toggle.removeAttr('checked');
					}
				});
				var pagination = new contact.PaginationView({
					collection : this.collection
				});
				pagination.render();
				$('.mc-paginate').html($(pagination.el).html());
				var $headColumnCol = self.$el.find('table#listHead colgroup col');
				self.changeColName($headColumnCol);
				var $subColumnCol = self.$el.find('div.list_area colgroup col');
				self.changeColName($subColumnCol);
			},
			changeColName : function($columnCol) {
				$columnCol.each(function(index, element) {
					if (index != 0 && index != 1 && index != $columnCol.length - 1)
						$(element).attr('class', 'col_auto');
				});
			},
			switchListViewOptions : function($headerColgroup, $listColgroup) {
				var user = this.userModel.toJSON();
				var key, count = 0;
				for (key in user) {
					if (user[key] == 1) {
						count++;
					}
				}
				if (count == 4) {
					var flags = user.PHONE_FLAG && user.EMAIL_FLAG && user.COMPANY_FLAG && user.GROUP_FLAG;
					if (!(flags)) {
						$headerColgroup.removeClass();
						$listColgroup.removeClass();
					}
				} else {
					$headerColgroup.removeClass();
					$listColgroup.removeClass();
				}
			},
			resetCheckboxes : function() {
				var $el = this.$el;
				var $checkboxes = $el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.removeAttr('checked').trigger('change');
			},
			unchecked : function(addressModel) {
				var $el = this.$el;
				var contactId = addressModel.get('ADDRESS_IDX');
				var $checkboxes = $el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.each(function(index, checkbox) {
					if ($(checkbox).val() == contactId) {
						$(checkbox).removeProp('checked').trigger('change');
					}
				});
			},
			paginateContacts : function(groupModel, params) {
				if (groupModel) {
					this.model = groupModel;
				}
				this.collection.setGroupModel(groupModel);
				contact.overlayView.showLoading();
				if (!params)
					params = {};
				this.collection.setParams(params);
				this.collection.server_api._method = 'GET';
				this.collection.pager();
				contact.overlayView.hideLoading();
			},
		}); // contact.ContactListView

		contact.ContactTrashItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = contact.ContactTrashItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-trash-item-template').html();
					compiledTemplate = _.template(html);
					contact.ContactTrashItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					group : contact.groupModel.toJSON(),
					params : contact.params,
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var self = this;
				var ADDRESS_IMPORTANT = this.model.get('ADDRESS_IMPORTANT');
				var $important = this.$el.find('.star a');
				var $checkbox = this.$el.find('td.check input.inp_ch');
				var $td = this.$el.find('td');

				if (ADDRESS_IMPORTANT == 'Y') {
					$important.addClass('on');
				} else {
					$important.removeClass('on');
				}
				$important.click(function(event) {
				});
				$checkbox.change(function(event) {
					event.stopPropagation();
					var $elem = $(self.el)
					if ($(this).is(':checked')) {
						$elem.addClass('focus');
						contact.selectedAddressCollection.add(self.model);
					} else {
						$elem.removeClass('focus');
						contact.selectedAddressCollection.remove(self.model);
					}
				});
				$checkbox.click(function(event) {
					event.stopPropagation();
				});
				$td.click(function(event) {
					if ($checkbox.is(':checked')) {
						$checkbox.prop('checked', false);
					} else {
						$checkbox.prop('checked', true);
					}
					$checkbox.change();
				});
			},
		}); // contact.ContactItemView

		contact.ContactTrashListView = Backbone.Marionette.CompositeView.extend({
			// parentEl : 'div.list_view',
			itemView : contact.ContactTrashItemView,
			itemViewContainer : 'div.list_area div.scroll_zoom tbody',
			template : function(data) {
				var html, compiledTemplate = contact.ContactTrashListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-trash-list-template').html();
					compiledTemplate = _.template(html);
					contact.ContactTrashListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					user : this.userModel,
					paginator : contact.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'paginate:trash-contacts', this.paginateTrashContacts);
				this.listenTo(contact.selectedAddressCollection, 'reset', this.resetCheckboxes);
				this.listenTo(contact.selectedAddressCollection, 'remove', this.unchecked);
			},
			onRender : function() {
				var self = this;
				var $toggle = this.$el.find('input.contact-trash-check-toggle');
				var $checkboxes = this.$el.find('div#wasteArea table tbody input[type=checkbox]');
				var $selectAll = $('div#addressBtn_fol div div.mc-buttonSet button:eq(0)');
				var checked = 0;
				$checkboxes.each(function(index, checkbox) {
					var $this = $(checkbox);
					contact.selectedAddressCollection.each(function(addressModel) {
						var contactId = addressModel.get('ADDRESS_IDX');
						if ($this.val() == contactId) {
							$this.prop('checked', true).trigger('change');
							checked++;
						}
					});
				});
				if (checked > 0 && checked == $checkboxes.length) {
					$toggle.prop('checked', true);
				}
				$toggle.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
					$checkboxes.change();
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length)
							$toggle.prop('checked', true);
					} else {
						$toggle.removeAttr('checked');
					}
				});
				var pagination = new contact.PaginationView({
					collection : this.collection
				});
				pagination.render();
				$('.mc-paginate').html($(pagination.el).html());
			},
			resetCheckboxes : function() {
				var $checkboxes = this.$el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.removeAttr('checked').trigger('change');
			},
			unchecked : function(addressModel) {
				var addressIdx = addressModel.get('ADDRESS_IDX');
				var $checkboxes = this.$el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.each(function(index, checkbox) {
					if ($(checkbox).val() == addressIdx) {
						$(checkbox).removeProp('checked').trigger('change');
					}
				});
			},
			paginateTrashContacts : function(groupModel, params) {
				if (groupModel) {
					this.model = groupModel;
				}
				contact.overlayView.showLoading();
				if (!params)
					params = {};
				this.collection.setParams(params);
				this.collection.server_api._method = 'GET';
				this.collection.pager();
				contact.overlayView.hideLoading();
			},
		}); // contact.ContactListView

		contact.ContactContextMenuView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'contact-contextmenu',
			className : 'layer_bd layer_mouseright',
			attributes : {
				style : 'display: none; z-index: 2015; width: 150px',
			},
			template : function(data) {
				var html, compiledTemplate = contact.ContactContextMenuView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-context-menu-template').html();
					compiledTemplate = _.template(html);
					contact.ContactContextMenuView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.AddressModel
				this.listenTo(app.vent, 'contextmenu:contact', this.showContextMenu);
			},
			onRender : function() {
				var self = this;
				var $contextMenu = $('body > #contact-contextmenu');
				if ($contextMenu.length)
					$contextMenu.remove();
				$contextMenu = this.$el.appendTo('body');
				$contextMenu.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$contextMenu.attr('hidable', true);
				$contextMenu.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($contextMenu.outerHeight() > (viewportY - event.pageY)) {
					$contextMenu.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$contextMenu.css('top', event.pageY + 'px');
				}
				if ($contextMenu.outerWidth() > (viewportX - event.pageX)) {
					$contextMenu.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$contextMenu.css('left', event.pageX + 'px');
				}
				var $groupLayer = $('#groupManagementLayer');
				$groupLayer.attr('hidable', true);
				var name = this.model.get('ADDRESS_NAME');
				var email = this.model.get('ADDRESS_EMAIL');
				if (name)
					email = '"' + name + '" <' + email + '>';
				var $composeMail = this.$el.find('li.compose-mail');
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					location.hash = 'compose?' + $.param({
						to : email,
					}, true);
					self.$el.hide();
				});
				var $showContact = this.$el.find('li.show-contact');
				$showContact.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contactItemView.$name.click();
					self.$el.hide();
					return false;
				});
				var $modifyContact = this.$el.find('li.modify-contact');
				$modifyContact.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contactItemView.$modify.click();
					self.$el.hide();
					return false;
				});
				var $deleteContact = this.$el.find('li.delete-contact');
				$deleteContact.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var trashGroupModel = contact.groupCollection.getGroupModel('GROUP_TYPE', 'T');
					self.model.save({
						GROUP_IDX : trashGroupModel.get('GROUP_IDX'),
						ORG_EMAIL : '',
						SHARE_ADDRESS_IDX : 0,
						moveTrash : true,
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							self.$el.hide();
							app.vent.trigger('paginate:contacts', contact.groupModel);
						},
					});
					return false;
				});
				var $moveContact = this.$el.find('li.move-contact');
				$moveContact.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					return false;
				});
				$moveContact.mouseover(function(event) {
					event.preventDefault() && event.stopPropagation();
					$groupLayer.css({
						top : $contextMenu.position().top - 38,
						left : $contextMenu.position().left - 133,
					});
					if (!$groupLayer.is(':visible')) {
						app.vent.trigger('add:address', self.model);
						$groupLayer.toggle();
					}
					return false;
				});
				$composeMail.add($showContact).add($modifyContact).add($deleteContact).mouseover(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($groupLayer.is(':visible'))
						$groupLayer.toggle();
					return false;
				});
			},
			showContextMenu : function(mouseEvent, addressModel, contactItemView) {
				this.mouseEvent = mouseEvent;
				this.model = addressModel;
				this.contactItemView = contactItemView;
				this.render().$el.show();
			}
		}); // contact.ContactContextMenuView

		contact.PaginationView = Backbone.View.extend({
			parentEl : '.mc-paginate',
			render : function() {
				var html, compiledTemplate = contact.PaginationView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-pagination-template').html();
					compiledTemplate = _.template(html);
					contact.PaginationView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : this.collection,
					i18n : i18n,
				});
				this.$el.html(html);
				return this;
			},
		}); // contact.PaginationView

		contact.MoveToGroupItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = contact.MoveToGroupItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#move-to-group-item-template').html();
					compiledTemplate = _.template(html);
					contact.MoveToGroupItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.GroupModel
				this.groupCollection = options.groupCollection;
			},
			getLevel : function() {
				var level = 0;
				var parentId = this.model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = this.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = this.groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},

			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				var level = this.getLevel();
				var $groupName = this.$el.find('label.group-name');
				var name = $groupName.text();
				for (var i = 0; i < level; i++) {
					name = '../' + name;
				}
				$groupName.text(name);
			},
		}); // contact.MoveToGroupItemView

		contact.MoveToGroupView = Backbone.Marionette.ItemView.extend({
			itemView : contact.MoveToGroupItemView,
			itemViewContainer : '.grp_mv ul.mailBoxList',
			template : function(data) {
				var html, compiledTemplate = contact.MoveToGroupView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#move-to-group-template').html();
					compiledTemplate = _.template(html);
					contact.MoveToGroupView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.paginator = options.paginator;
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.renderGroupItems);
				this.listenTo(app.vent, 'add:address', this.addAddressModel);
				this.listenTo(app.vent, 'remove:address', this.removeAddressModel);
			},
			onRender : function() {
				var self = this;
				this.renderGroupItems();
				var $newGroup = this.$el.find('.grp_mv .add_area .add_btn button');
				var $move = this.$el.find('div.add_layer_btn button:eq(0)');
				var $copy = this.$el.find('div.add_layer_btn button:eq(1)');
				$newGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $input = self.$el.find('#newGroupAdd');
					var groupName = $.trim($input.val());
					if (groupName) {
						contact.groupCollection.create({
							GROUP_NM : groupName
						}, {
							wait : true,
							success : function(model, response, options) {
								self.addedToGroupCollection(model, contact.groupCollection, options);
							},
						});
					}
					$input.val('');
				});
				$move.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1 && !self.addressModel) {
						alert(i18n.moveTo.pleaseSelectMoveContact);
						return;
					}
					if (!confirm(i18n.moveTo.confirmMoveToContact)) {
						return;
					}
					self.moveToGroup();
				});
				$copy.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1 && !self.addressModel) {
						alert(i18n.moveTo.pleaseSelectCopyContact);
						return;
					}
					self.copyToGroup();
				});
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			addedToGroupCollection : function(model, collection, options) {
				this.GROUP_IDX = model.get('GROUP_IDX');
				this.renderGroupItems();
			},
			renderGroupItems : function() {
				var self = this;
				var $groupList = this.$el.find('.grp_mv ul.mailBoxList');
				$groupList.empty();
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				for (var i = 0; i < groupModels.length; i++) {
					var groupItemView = new contact.MoveToGroupItemView({
						model : groupModels[i],
						groupCollection : self.collection,
					});
					$groupList.append(groupItemView.render().el);
				}
				var $groupItems = this.$el.find('.grp_mv ul.mailBoxList li');
				$groupItems.each(function(index) {
					var $item = $(this);
					var $checkbox = $item.find('input:checkbox');
					if (index == 0) {
						$item.addClass('selected');
						$checkbox.prop('checked', true);
					}
					if ($checkbox.val() == self.GROUP_IDX) {
						$groupItems.removeClass('selected');
						$groupItems.find('input:checkbox').prop('checked', false);
						$item.addClass('selected');
						$checkbox.prop('checked', true);
						var pos = $groupList.scrollTop() + $item.position().top;
						$groupList.scrollTop(pos);
					}
					$item.click(function() {
						$groupItems.removeClass('selected');
						$groupItems.find('input:checkbox').prop('checked', false);
						$(this).addClass('selected');
						var $checked = $(this).find('input:checkbox');
						self.GROUP_IDX = $checked.val();
						$checked.prop('checked', true);
					});
				});
			},
			moveToGroup : function() {
				var self = this;
				var $groupItems = this.$el.find('.grp_mv ul.mailBoxList li input[type=checkbox]');
				var $selectedItem = $groupItems.filter(':checked');
				var ids = [];
				var contactListView = this.parentView.contactListRegion.currentView;
				var $contentItemViewContainer = contactListView.$itemViewContainer;
				var $checkboxes = $contentItemViewContainer.find('input[type=checkbox]');
				if (contact.selectedAddressCollection.size() > 0) {
					contact.selectedAddressCollection.forEach(function(addressModel) {
						ids.push(addressModel.get('ADDRESS_IDX'));
					});
				} else if (this.addressModel) {
					ids.push(this.addressModel.get('ADDRESS_IDX'));
					delete this.addressModel;
				}
				if (ids.length === 0)
					return;
				var model = new (app.BackboneModel.extend({
					urlRoot : 'groups/' + $selectedItem.val(),
					defaults : {
						id : 'contacts'
					}
				}))();
				var jqXHR = model.save({
					GROUP_IDX : $selectedItem.val(),
					addressIds : ids,
				}, {
					patch : true,
					wait : true,
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					var paginator = self.paginator;
					if ($checkboxes.length == ids.length && ids.length == data.updated) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
						} else {
							paginator.pager();
						}
					} else {
						paginator.pager();
					}
					contact.selectedAddressCollection.reset();
					contact.groupCollection.fetch();
					self.parentView.moveToGroupRegion.$el.hide();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					alert('Failed to move contacts.');
				});
			},
			copyToGroup : function() {
				var self = this;
				var $groupItems = this.$el.find('.grp_mv ul.mailBoxList li input:checkbox');
				var $selectedItem = $groupItems.filter(':checked');
				var groupModel = contact.groupCollection.getGroupModel('GROUP_IDX', $selectedItem.val());
				var GROUP_NM = groupModel.get('GROUP_NM');
				var contactListView = this.parentView.contactListRegion.currentView;
				var $contentItemViewContainer = contactListView.$itemViewContainer;
				var $checkboxes = $contentItemViewContainer.find('input[type=checkbox]');
				var created = 0;
				var selectedModels = [];
				if (contact.selectedAddressCollection.size() > 0) {
					selectedModels = contact.selectedAddressCollection.models;
				} else if (this.addressModel) {
					selectedModels.push(this.addressModel);
					delete this.addressModel;
				}
				if (selectedModels.length === 0)
					return;
				_.each(selectedModels, function(selectedModel) {
					selectedModel.set({
						ADDRESS_IDX : 0,
					}, {
						silent : true,
					});
					var contactModel = new contact.AddressModel();
					contactModel.attributes = selectedModel.attributes;
					contactModel.save({
						GROUP_IDX : $selectedItem.val(),
						ORG_EMAIL : '',
						SHARE_ADDRESS_IDX : 0,
					}, {
						wait : true,
						async : false,
						success : function() {
							created++;
						}
					});
				});
				var paginator = this.paginator;
				if ($checkboxes.length == selectedModels.length && selectedModels.length == created) {
					var info = paginator.info();
					if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
						var args = {
							page : info.currentPage - 1
						};
						location.hash = '#' + paginator.getURL(args);
					} else {
						paginator.pager();
					}
				} else {
					paginator.pager();
				}
				var msg = i18n.moveTo.ofTheContacts + GROUP_NM + i18n.moveTo.copiedGroup;
				alert(selectedModels.length + msg);
				contact.selectedAddressCollection.reset();
				contact.groupCollection.fetch();
				this.parentView.moveToGroupRegion.$el.hide();
			},
			addAddressModel : function(addressModel) {
				this.addressModel = addressModel;
			},
			removeAddressModel : function(addressModel) {
				delete this.addressModel;
			},
		}); // contact.MoveToGroupview

		contact.CategoryFilterView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.CategoryFilterView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-category-filter-template').html();
					compiledTemplate = _.template(html);
					contact.CategoryFilterView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.find('ul li');

				$items.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $item = $(event.target, this);
					var className = $item.attr('class');
					var categoryType = className.slice(className.indexOf('-') + 1);
					var GROUP_IDX = contact.groupModel.get('GROUP_IDX');
					var url = 'groups/' + GROUP_IDX + '/category/' + categoryType;
					self.collection.pager({
						url : url
					});
				});
			},
		}); // contact.CategoryFilterView

		contact.ExposeListView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ExposeListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-expose-template').html();
					compiledTemplate = _.template(html);
					contact.ExposeListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.contactUserModel
				this.listenTo(this.model, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $inputs = this.$el.find('input');
				var $save = this.$el.find('.add_layer_btn button.b');
				var $close = this.$el.find('.close-expose-list');
				var expose = {};
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				$close.click(function() {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('hide:expose-list-view');
				});
				$save.click(function() {
					$inputs.each(function() {
						var $input = $(this);
						expose[$input.attr('name')] = $input.prop('checked') ? 1 : 0;
					});
					self.model.save({
						NICKNAME_FLAG : expose['nickname'],
						PHONE_FLAG : expose['phone'],
						EMAIL_FLAG : expose['email'],
						COMPANY_FLAG : expose['company'],
						DEPARTMENT_FLAG : expose['department'],
						DUTY_FLAG : expose['duty'],
						HOMEPAGE_FLAG : expose['homepage'],
						GROUP_FLAG : expose['group'],
						RECENT_FLAG : expose['recent'],
						MEMO_FLAG : expose['memo'],
					}, {
						wait : true,
						patch : true,
						success : function(res) {
							if (res.get('faultcode')) {
								alert(res.get('faultcode') + ' : ' + res.get('faultstring'));
								return;
							} else {
								var hash = location.hash;
								if (hash.indexOf('#shared-groups') != -1) {
									contact.sharedPaginator.pager();
									app.vent.trigger('change:shared-group', contact.sharedGroupModel);
								} else {
									contact.paginator.pager();
									app.vent.trigger('change:group', contact.groupModel);
								}
								app.vent.trigger('hide:expose-list-view');
								// app.contact.controller.showContentLayout();
							}
						},
					});
				}); // $save.click(function() {

			},
		}); // contact.ExposeListView

		contact.ContactFormLayout = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ContactFormLayout.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-form-layout-template').html();
					compiledTemplate = _.template(html);
					contact.ContactFormLayout.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
			},
		}); // contact.ContactFormLayout

		contact.ContactDetailView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ContactDetailView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-detail-template').html();
					compiledTemplate = _.template(html);
					contact.ContactDetailView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					groups : contact.groupCollection,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.addressModel
				this.isGroupShared = options.isGroupShared;
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $important = this.$el.find('.art_grp a');
				var $close = this.$el.find('.layer_pd a.lay_close');
				var $delete = this.$el.find('div.btn_leftset button.contact-detail-delete');
				var $modify = this.$el.find('.btn_area button.modify-contact');
				var $cancel = this.$el.find('.btn_area button.c');
				var $rep = this.$el.find('.rep').add(this.$el.find('.on'));
				var $composeMail = this.$el.find('a.send_mail');
				var $modifyView = $('#addressModify');
				var $viewWrapper = $('#contactMan');
				var $detailView = $('#customerView');
				var photo = this.model.get('photo');
				if (photo) {
					var $profileContainer = this.$el.find('div.pic_a');
					$profileContainer.empty();
					var now = Date.now ? Date.now() : new Date().getTime();
					var $img = $('<img></img>', {
						'src' : 'contacts/' + this.model.get('ADDRESS_IDX') + '/photo?_=' + now,
						'width' : '60px',
						'height' : '60px',
					});
					$profileContainer.append($img);
					$img.error(function(event) {
						event.preventDefault() && event.stopPropagation();
						$(this).unbind('error');
						$profileContainer.empty();
						return false;
					});
				}
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var important = self.model.get('ADDRESS_IMPORTANT') == 'Y' ? 'N' : 'Y';
					if (location.hash.indexOf('shared-groups') != -1) {
						var url = 'shared-groups/' + self.model.get('GROUP_IDX') + '/contacts/'
								+ self.model.get('ADDRESS_IDX');
						self.model.save({
							ADDRESS_IMPORTANT : important,
							patchImportant : 1,
						}, {
							url : url,
							wait : true,
							patch : true,
						});
					} else {
						self.model.save({
							ADDRESS_IMPORTANT : important,
							patchImportant : 1,
						}, {
							wait : true,
							patch : true,
						});
					}
				});
				$rep.click(function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = {
						to : [],
					};
					var param = '';
					var alias = self.model.get('ADDRESS_NAME');
					var email = self.model.get('ADDRESS_EMAIL');
					if (email) {
						if (alias) {
							param += '"' + alias + '"';
							param += '<' + email + '>';
						} else {
							param += email;
						}
					}
					params.to.push(param);
					$($detailView).add($viewWrapper).hide();
					contact.overlayView.hideOverlay();
					location.hash = "compose?" + decodeURIComponent($.param(params, true));
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var trashGroupModel = contact.groupCollection.getGroupModel('GROUP_TYPE', 'T');
					self.model.save({
						GROUP_IDX : trashGroupModel.get('GROUP_IDX'),
						ORG_EMAIL : '',
						SHARE_ADDRESS_IDX : 0,
						moveTrash : true,
					}, {
						patch : true,
						async : false,
						wait : true,
					});
					$($detailView).add($viewWrapper).hide();
					contact.overlayView.hideOverlay();
					app.vent.trigger('paginate:contacts', contact.groupModel);
				});
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$detailView.hide();
					var options = {};
					options['silent'] = true;
					contact.selectedAddressCollection.reset();
					contact.selectedAddressCollection.add(self.model, options);
					contact.selectedAddressCollection.title = i18n.addAddress.modifyTitle;
					app.vent.trigger('contact:modifyView', contact.selectedAddressCollection);
				});
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$($detailView).add($viewWrapper).hide();
					contact.overlayView.hideOverlay();
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$($detailView).add($viewWrapper).hide();
					contact.overlayView.hideOverlay();
				});
			},
		}); // contact.ContactDetailView

		contact.ContactModifyView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ContactModifyView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-modify-template').html();
					compiledTemplate = _.template(html);
					contact.ContactModifyView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					groups : contact.groupCollection,
					i18n : i18n,
					headTitle : contact.selectedAddressCollection.title,
					addressCollection : contact.selectedAddressCollection.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				if (options.addressCollection) {
					// contact.selectedAddressCollection
					this.addressCollection = options.addressCollection;
				}
				this.paginator = options.paginator;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(contact.selectedGroupCollection, 'add', this.selectedGroupRender);
				this.listenTo(contact.selectedGroupCollection, 'reset', this.selectedGroupRender);
				var script = document.createElement('script');
				script.setAttribute('type', 'text/javascript');
				script.setAttribute('src', 'http://dmaps.daum.net/map_js_init/postcode.v2.js??autoload=false');
				$("head")[0].appendChild(script);
			},
			onBeforeRender : function() {
				contact.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this;
				var $modifyView = $('#addressModify');
				var $viewWrapper = $('#contactMan');
				var $uploadPhoto = this.$el.find('.contact-modify-upload-photo');
				var $close = this.$el.find('.layer_pd .lay_close');
				var $save = this.$el.find('.btn_area button.b');
				var $cancel = this.$el.find('.btn_area button:eq(1)');
				var $saveKeep = this.$el.find('button.contact-modify-save-keep');
				var $groupWrapper = this.$el.find('#groupSettingId');
				var $toggleGroupLayer = this.$el.find('#toggleGroup');
				var $important = this.$el.find('a.contact-modify-important');
				var $birthInput = this.$el.find('.lc_list .art_grp input[name=birthDay]');
				var $findPost = this.$el.find('.lc_list li button.contact-modify-find-post');
				var $phoneType = this.$el.find('.lc_list select[name=phoneType]');
				var $detailTab = this.$el.find('a.contact-modify-detail-tab');
				var photo = false;
				var filename;
				var $inputs = this.$el.find('input[type=text]');
				var $textareas = this.$el.find('textarea');
				$inputs.add($textareas).placeholder();
				var _cid = function() {
					var now = Date.now ? Date.now() : new Date().getTime();
					var random = Math.floor(Math.random() * 10000);
					return now + '.' + random;
				};
				if (this.addressCollection) {
					this.addressCollection.forEach(function(model) {
						var entity = model.getExistsValues();
						self.addGroups(entity);
						photo = model.get('photo');
						filename = model.get('ADDRESS_IDX');
					});
					if (photo) {
						var $profileContainer = this.$el.find('div.pic_a');
						$profileContainer.empty();
						var now = Date.now ? Date.now() : new Date().getTime();
						var $img = $('<img></img>', {
							'src' : 'contacts/' + filename + '/photo?_=' + now,
							'width' : '60px',
							'height' : '60px',
						});
						$profileContainer.append($img);
						$img.error(function(event) {
							event.preventDefault() && event.stopPropagation();
							$(this).unbind('error');
							$profileContainer.empty();
							return false;
						});
					}
				}
				/* 그룹설정 Layer */
				var contactModifyGroupView = new contact.ContactModifyGroupView({
					collection : contact.groupCollection,
					addressCollection : this.addressCollection,
				});
				contactModifyGroupView.render();
				$groupWrapper.html(contactModifyGroupView.$el.children());

				var $fileInput = $('body > #contact_photo_files_to_upload');
				if (!$fileInput.length) {
					$fileInput = $('<input>', {
						'id' : 'contact_photo_files_to_upload',
						'class' : 'file_input_hidden',
						'type' : 'file',
						'accept' : '.gif, .jpg, .jpeg, .png',
						'multiple' : 'false',
						'style' : 'position: absolute; top: -10000px; left: -10000px;'
					}).appendTo('body');
					$fileInput.change(function(event) {
						event.preventDefault() && event.stopPropagation();
						var $inputFileName = self.$el.find('input.contact-modify-photo-name');
						if (!this.files || !this.files.length)
							return false;
						if (this.files[0].type.indexOf('image/') == -1)
							return false;
						$inputFileName.val(this.files[0].name);
						return false;
					});
				}
				if (!$fileInput[0].files && !document.contactPhotoUploadIframe) {
					$('<iframe>', {
						'name' : 'contactPhotoUploadIframe',
						'src' : 'contacts/photo/form',
						'style' : 'position: absolute; display: none;',
					}).appendTo('body');
					$uploadPhoto.hide();
				}
				var $findPhoto = this.$el.find('div.file_input_box button.find-photo');
				$findPhoto.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($fileInput[0].files) {
						$fileInput.click();
						return false;
					}
					if (document.contactPhotoUploadIframe) {
						var iframe = document.contactPhotoUploadIframe;
						var form = iframe.contactPhotoUploadForm;
						var changed = false;
						form.photo.onchange = function(event) {
							changed = true;
							return false;
						};
						form.photo.click();
						if (!changed) {
							return false;
						}
						filename = _cid();
						form.filename.value = filename;
						form.submit();
						contact.overlayView.showProcessing();
						app.vent.once('contact-photo:uploaded', function(filename) {
							contact.overlayView.hideProcessing();
							var iframe = document.contactPhotoUploadIframe;
							var pathname = iframe.location.pathname;
							var url = pathname.substring(0, pathname.lastIndexOf('/')) + '/form';
							iframe.location.replace(url);
							if (!filename) {
								alert(i18n.addAddress.cannotUpload);
								return;
							}
							var $profileContainer = self.$el.find('div.profile_edite div.pic_a');
							$profileContainer.empty();
							var $img = $('<img></img>', {
								'src' : 'contacts/' + filename + '/photo',
								'width' : '60px',
								'height' : '60px',
							});
							$profileContainer.append($img);
						});
					}
				});
				$uploadPhoto.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var files = $fileInput[0].files;
					if (files && files.length > 0) {
						if (files[0].type.indexOf('image/') == -1)
							return false;
						var file = files[0];
						var quota = 5 * 1024 * 1024;
						var size = file.size;
						var free = quota - size;
						if (free <= 0) {
							alert(i18n.addAddress.alertExceedingQuota);
							return false;
						}
						filename = _cid();
						var url = 'contacts/photo';
						var formData = new FormData();
						var xhr = new XMLHttpRequest();
						xhr.open('POST', url);
						formData.append(filename, file);
						xhr.upload.onload = function(event) {
							var $profileContainer = self.$el.find('div.profile_edite div.pic_a');
							$profileContainer.empty();
							var $img = $('<img></img>', {
								'src' : 'contacts/' + filename + '/photo',
								'width' : '60px',
								'height' : '60px',
							});
							$profileContainer.append($img);
						};
						xhr.send(formData);
					}
				});
				$toggleGroupLayer.click(function(event) {
					$groupWrapper.toggle();
					var top = self.$el.find('dl.group_settings').position().top;
					$groupWrapper.css('top', top);
				});
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var important = $this.hasClass('a_key_on') ? 'N' : 'Y';
					$this.toggleClass('a_key_on');
				});
				var sequence = 1;
				var $add = this.$el.find('.lc_list li a.a_add');
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					self.addNewField($this, sequence);
					sequence++;
				});
				var $rep = this.$el.find('.lc_list .rep');
				$rep.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					$this.parent().parent().find('.rep').removeClass('on');
					$this.toggleClass('on');
				});
				var $del = this.$el.find('.lc_list li a.a_del');
				$del.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					self.deleteOption($this);
				});
				$findPost.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var postCodeId = $this.data('post-code');
					var postAddrId = $this.data('post-addr');
					self.openPostView(postCodeId, postAddrId);
				});
				$detailTab.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.find('div.contact-modify-detail-input-container').toggle();
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.saveAddress(filename);
				});
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$($modifyView).add($viewWrapper).hide();
					contact.overlayView.hideOverlay();
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$($modifyView).add($viewWrapper).hide();
					contact.overlayView.hideOverlay();
				});
				$saveKeep.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = self.saveAddress(filename, 'saveKeep');
					if (params) {
						self.model.clear();
						self.model = new contact.AddressModel({});
						self.render();
					}
				});
				this.initDatePicker($birthInput);
				$birthInput.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$('#ui-datepicker-div').css('z-index', 40000);
				});
				$phoneType.change(function() {
					var $customPhone = $(this).siblings('input[name=customPhone]');
					var $phone = $(this).siblings('input[name=phone]');
					if ($(this).val() == 'custom') {
						$customPhone.val();
						$customPhone.show();
						$phone.width('127');
					} else {
						$customPhone.hide();
						$phone.width('210');
					}
				});
			},
			openPostView : function(postCodeId, postAddrId) {
				var self = this;
				daum.postcode.load(function() {
					new daum.Postcode({
						oncomplete : function(data) {
							// 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

							// 도로명 주소의 노출 규칙에 따라 주소를 조합한다.
							// 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기
							// 한다.
							var fullRoadAddr = data.roadAddress; // 도로명
							// 주소 변수
							var extraRoadAddr = ''; // 도로명 조합형 주소 변수

							// 법정동명이 있을 경우 추가한다. (법정리는 제외)
							// 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
							if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
								extraRoadAddr += data.bname;
							}
							// 건물명이 있고, 공동주택일 경우 추가한다.
							if (data.buildingName !== '' && data.apartment === 'Y') {
								extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
							}
							// 도로명, 지번 조합형 주소가 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
							if (extraRoadAddr !== '') {
								extraRoadAddr = ' (' + extraRoadAddr + ')';
							}
							// 도로명, 지번 주소의 유무에 따라 해당 조합형 주소를 추가한다.
							if (fullRoadAddr !== '') {
								fullRoadAddr += extraRoadAddr;
							}

							// 우편번호와 주소 정보를 해당 필드에 넣는다.
							self.$el.find('#' + postCodeId).val(data.zonecode);
							self.$el.find('#' + postAddrId).val(fullRoadAddr);
						}
					}).open();
				});
			},
			initDatePicker : function($birthInput) {
				$birthInput.attr('id', 'datePicker' + 0);
				$birthInput.datepicker();
				$birthInput.addClass('myDate');
			},
			selectedGroupRender : function() {
				var selectedGroupName = '', $selectedWrapper = this.$el.find('.grpname');
				var $tip = this.$el.find('.tip');
				contact.selectedGroupCollection.each(function(groupModel, index) {
					if (index == 0) {
						selectedGroupName = _.escape(groupModel.get('GROUP_NM'));
					} else {
						selectedGroupName += ', ' + _.escape(groupModel.get('GROUP_NM'));
					}
				}, this);
				$selectedWrapper.html(selectedGroupName);
				if (contact.selectedGroupCollection.length > 0) {
					$selectedWrapper.show();
					$tip.hide();
				} else {
					$selectedWrapper.hide();
					$tip.show();
				}
			},
			/* 선택된 연락처의 그룹을 추가한다. */
			addGroups : function(entity) {
				// 연락처 수정 + 합치기시 연락처의 그룹을 가져와서 check 시킨다.
				if (entity && entity['GROUP_IDX']) {
					var GROUP_IDX = entity['GROUP_IDX'];
					this.collection.each(function(groupModel) {
						if (groupModel.get('GROUP_IDX') == GROUP_IDX)
							contact.selectedGroupCollection.add(groupModel);
					});
				}
			},
			/* 사용자가 + 버튼을 눌러서 필드를 추가할때 동작 */
			addNewField : function($this, sequence) {
				var $li = $this.parent();
				var $ul = $li.parent();
				var $cloneLi = $li.clone(true);
				$this.hide();
				var $reps = $ul.find('.rep');
				var rep = $reps.hasClass('on');
				if (!rep) {
					$($reps[0]).addClass('on');
				}
				$cloneLi.find('.rep').removeClass('on');
				$cloneLi.find('.a_del').each(function() {
					var $this = $(this);
					if ($this.siblings('.a_add').is(':visible')) {
						$this.show();
					}
				});
				$cloneLi.find('input[type=text]').val('');
				$cloneLi.find('textarea').val('');
				$ul.children('li').find('.a_del').show();

				var $radios = $cloneLi.find('input[type=radio]');
				if ($radios.length > 0) {
					$radios.each(function(index, radio) {
						var name = $(radio).attr('name');
						var id = $(radio).attr('id');
						var nameSeq = 0;
						if (name.indexOf('isSolar') != -1) {
							// 기존 이름 뒤 시퀀스 +1 처리
							nameSeq = parseInt(name.substring(7)) + 1 || 1;
						}
						$(radio).attr('name', 'isSolar' + nameSeq);
					});
				}
				var $birthInput = $cloneLi.find('.hasDatepicker');
				$birthInput.each(function(index) {
					this.id = 'datePicker' + sequence;
					var $this = $(this);
					$this.addClass("myDate");
					$this.removeClass("hasDatepicker");
				}).datepicker();

				var zipcodeSeq = sequence + 1;
				$cloneLi.find('.itxt').each(function() {
					var $this = $(this);
					if ($this.attr('name') === 'addressFirstZip') {
						$this.attr('id', '_zip1_index_' + zipcodeSeq);
					}
					// else if ($this.attr('name') === 'addressSecondZip') {
					// $this.attr('id', '_zip2_index_' + zipcodeSeq);
					// }
				});
				$cloneLi.find('textarea').each(function() {
					var $this = $(this);
					if ($this.attr('name') === 'address') {
						$this.attr('id', '_adr_index_' + zipcodeSeq);
					}
				});
				$cloneLi.find('.contact-modify-find-post').each(function() {
					var $this = $(this);
					$this.data('post-code', '_zip1_index_' + zipcodeSeq);
					$this.data('post-addr', '_adr_index_' + zipcodeSeq);
				});
				$ul.append($cloneLi);
			},
			/* 유효성 검증 후 유효하다면 서버에 저장 */
			saveAddress : function(filename, saveKeep) {
				var self = this;
				var $modifyView = $('#addressModify');
				var $viewWrapper = $('#contactMan');
				// Check Validation
				var params = this.validateForm();
				if (params) {
					var options = {};
					options.wait = true;
					if (this.model.get('ADDRESS_IDX') > 0) {
						options.patch = true;
					}
					if (contact.selectedGroupCollection.length > 0) {
						var groupIds = [];
						contact.selectedGroupCollection.each(function(groupModel) {
							groupIds.push(groupModel.get('GROUP_IDX'));
						});
						if (groupIds && groupIds.length == 1) {
							params.GROUP_IDX = groupIds[0];
						} else {
							params.groupIds = groupIds;
						}
						self.saveAndRefresh(params, options, filename);
						contact.selectedGroupCollection.reset();
					} else {
						params.GROUP_IDX = 0;
						self.saveAndRefresh(params, options, filename);
					}
					if (!saveKeep) {
						$($modifyView).add($viewWrapper).hide();
						contact.overlayView.hideOverlay();
					}
				}
				return params;
			},
			saveAndRefresh : function(params, options, filename) {
				var self = this;
				var jqXHR;
				options.async = false;
				if (this.addressCollection && this.addressCollection.length == 1) {
					// 연락처 수정
					options.patch = true;
					this.model = this.addressCollection.models[0];
					options.url = _.result(this.model, 'urlRoot') + '/' + this.model.get('ADDRESS_IDX') + '?photo='
							+ filename;
					jqXHR = this.model.save(params, options);
				} else if (this.addressCollection && this.addressCollection.length > 1) {
					// 연락처 합치기
					// options.patch = true;
					options.url = 'contacts/merge';
					params.selectedAddressCollection = this.addressCollection.toJSON();
					jqXHR = this.model.save(params, options);
					this.addressCollection.reset();
				} else {
					// 연락처 추가
					options.url = _.result(this.model, 'urlRoot') + '/0?photo=' + filename;
					jqXHR = this.model.save(params, options);
				}
				jqXHR.done(function() {
					self.collection.fetch(); // contact.groupCollection
					location.hash = '#' + self.paginator.getURL({});
					self.paginator.pager();
				});
			},
			getMultiFormValues : function($elements) {
				var values = [];
				$elements.each(function(index) {
					var $this = $(this);
					if ($this.val().length > 0) {
						values[index] = $this.val();
					}
				});
				return values;
			},
			setPhoneValues : function($phoneInput, $emailInput, entity, expansions) {
				var phoneKey;
				var $phoneType = this.$el.find('.lc_list select[name=phoneType]');
				var $customName = this.$el.find('.lc_list input[name=customPhone]');
				var phoneValues = this.getMultiFormValues($phoneInput);
				var emailValues = this.getMultiFormValues($emailInput);
				if (phoneValues.length <= 0 && emailValues.length <= 0) {
					alert(i18n.addAddress.pleaseEnterTelOrEmail);
					$phoneInput.focus();
					return false;
				}
				var emptyCustomName;
				$customName.each(function() {
					var $this = $(this);
					if ($this.is(':visible') && !$this.val()) {
						alert(i18n.addAddress.pleaseEnterPhoneType);
						$this.focus();
						emptyCustomName = true;
						return false;
					}
				});
				if (emptyCustomName) {
					return false;
				}
				$phoneType.find(':selected').each(
						function(index) {
							var $this = $(this);
							var phoneEnum = [ 'ADDRESS_CELLTEL', 'ADDRESS_OFFICETEL', 'ADDRESS_TEL',
									'ADDRESS_OFFICEFAX', 'ADDRESS_ETCTEL', 'ADDRESS_CUSTOMTEL' ];
							var phoneType;
							switch ($this.val()) {
							case 'cell':
								phoneType = phoneEnum[0];
								break;
							case 'office':
								phoneType = phoneEnum[1];
								break;
							case 'tel':
								phoneType = phoneEnum[2];
								break;
							case 'fax':
								phoneType = phoneEnum[3];
								break;
							case 'other':
								phoneType = phoneEnum[4];
								break;
							case 'custom':
								phoneType = phoneEnum[5];
								break;
							}
							if (index == 0) {
								entity[phoneType] = $($phoneInput[index]).val();
								if (phoneType == phoneEnum[5]) {
									entity.ADDRESS_CUSTOMTELNAME = $($customName[index]).val();
								}
								phoneEnum.each(function(index) {
									if (phoneType != index) {
										entity[index] = '';
									}
								});
							} else {
								var expansion = expansions[index];
								expansion[phoneType] = $($phoneInput[index]).val();
								if (phoneType == 'ADDRESS_CUSTOMTEL') {
									expansion.ADDRESS_CUSTOMTELNAME = $($customName[index]).val();
								}
							}
						});
				this.setRepFlag($phoneType, entity, expansions, 'ADDRESS_TEL_REP');
				return true;
			},
			setEmailValues : function($emailInput, entity, expansions) {
				var emailValues = this.getMultiFormValues($emailInput);
				if (emailValues.length > 0) {
					var check;
					var expr = '^([\\w-]+(?:\\.[\\w-]+)*)@';
					expr += '((?:[\\w-]+\\.)*\\w[\\w-]{0,66})\\.([a-z]{2,6}(?:\\.[a-z]{2})?)$';
					var matcher = new RegExp(expr);
					for (var i = 0; i < emailValues.length; i++) {
						check = matcher.test(emailValues[i]);
						if (!check)
							break;
					}
					if (!check) {
						alert(i18n.addAddress.pleaseEnterEmailMatch);
						$emailInput.focus();
						return false;
					}
				}
				this.setSingleValue(entity, 'ADDRESS_EMAIL', emailValues[0], $emailInput);
				this.setExpansions(expansions, 'ADDRESS_EMAIL', $emailInput);
				this.setRepFlag($emailInput, entity, expansions, 'ADDRESS_EMAIL_REP');
				return true;
			},
			setBirthValues : function($birthType, entity, expansions) {
				var $birthInput = this.$el.find('.lc_list .art_grp input[name=birthDay]');
				var $birthIsSolar = this.$el.find('.lc_list .art_grp [name^=isSolar]');
				var $selectedBirthType = $birthType.find(':selected');
				var $selectedIsSolar = $birthIsSolar.filter(':checked');
				var birthTypeValues = this.getMultiFormValues($selectedBirthType);
				var birthInputValues = this.getMultiFormValues($birthInput);
				var isSolarValues = this.getMultiFormValues($selectedIsSolar);
				this.setSingleValue(entity, 'ADDRESS_BIRTH_TYPE', birthTypeValues[0]);
				this.setSingleValue(entity, 'ADDRESS_BIRTH', birthInputValues[0]);
				this.setSingleValue(entity, 'ADDRESS_ISSOLAR', isSolarValues[0]);
				this.setExpansions(expansions, 'ADDRESS_BIRTH_TYPE', $selectedBirthType);
				this.setExpansions(expansions, 'ADDRESS_BIRTH', $birthInput);
				this.setExpansions(expansions, 'ADDRESS_ISSOLAR', $selectedIsSolar);
				this.setRepFlag($birthType, entity, expansions, 'ADDRESS_BIRTH_REP');
			},
			setOfficeValues : function($office, $department, $duty, entity, expansions) {
				var keys = [ 'ADDRESS_OFFICE', 'ADDRESS_DEPT', 'ADDRESS_DUTY' ];
				var officeValues = this.getMultiFormValues($office);
				var deptValues = this.getMultiFormValues($department);
				var dutyValues = this.getMultiFormValues($duty);
				this.setSingleValue(entity, 'ADDRESS_OFFICE', officeValues[0]);
				this.setSingleValue(entity, 'ADDRESS_DEPT', deptValues[0]);
				this.setSingleValue(entity, 'ADDRESS_DUTY', dutyValues[0]);
				this.setExpansions(expansions, 'ADDRESS_OFFICE', $office);
				this.setExpansions(expansions, 'ADDRESS_DEPT', $department);
				this.setExpansions(expansions, 'ADDRESS_DUTY', $duty);
				this.setRepFlag($office, entity, expansions, 'ADDRESS_OFFICE_REP');
			},
			setZipcodeAddrValues : function($addressType, entity, expansions) {
				var $el = this.$el;
				var zipcodeColumn, addressColumn;
				var $addressFirstZip = $el.find('.lc_list .art_grp input[name=addressFirstZip]');
				var $addressInput = $el.find('.lc_list .art_grp textarea[name=address]');
				$addressType.find(':selected').each(function(index) {
					var $this = $(this);
					var zipcodeEnum = [ 'ADDRESS_OFFICEZIP', 'ADDRESS_HOMEZIP', 'ADDRESS_ETCZIP' ];
					var addressEnum = [ 'ADDRESS_OFFICEADDR', 'ADDRESS_HOMEADDR', 'ADDRESS_ETCADDR' ];
					switch ($this.val()) {
					case 'office':
						zipcodeColumn = zipcodeEnum[0];
						addressColumn = addressEnum[0];
						break;
					case 'home':
						zipcodeColumn = zipcodeEnum[1];
						addressColumn = addressEnum[1];
						break;
					case 'other':
						zipcodeColumn = zipcodeEnum[2];
						addressColumn = addressEnum[2];
						break;
					}
					var zipcode = $($addressFirstZip[index]).val();
					var addressname = $($addressInput[index]).val();
					if (!(zipcode && addressname))
						return;
					if (index == 0) {
						entity[zipcodeColumn] = zipcode;
						entity[addressColumn] = addressname;
						zipcodeEnum.each(function(index) {
							if (zipcodeColumn != index) {
								entity[index] = '';
							}
							;
						});
						addressEnum.each(function(index) {
							if (addressColumn != index) {
								entity[index] = '';
							}
							;
						});
					} else {
						var expansion = expansions[index];
						expansion[zipcodeColumn] = zipcode;
						expansion[addressColumn] = addressname;
					}
				});
				this.setRepFlag($addressFirstZip, entity, expansions, 'ADDRESS_ZIP_REP');
			},
			setHomepageValues : function($homepage, entity, expansions) {
				var homepages = this.getMultiFormValues($homepage);
				this.setSingleValue(entity, 'ADDRESS_HOMEURL', homepages[0]);
				this.setExpansions(expansions, 'ADDRESS_HOMEURL', $homepage);
				this.setRepFlag($homepage, entity, expansions, 'ADDRESS_HOMEURL_REP');
			},
			setSnsValues : function($snsType, $sns, entity, expansions) {
				var snsTypes = this.getMultiFormValues($snsType.find(':selected'));
				var snsIdValues = this.getMultiFormValues($sns);
				this.setSingleValue(entity, 'ADDRESS_SNS_TYPE', snsTypes[0]);
				this.setSingleValue(entity, 'ADDRESS_SNS_ID', snsIdValues[0]);
				this.setExpansions(expansions, 'ADDRESS_SNS_TYPE', $snsType);
				this.setExpansions(expansions, 'ADDRESS_SNS_ID', $sns);
				this.setRepFlag($snsType, entity, expansions, 'ADDRESS_SNS_REP');
			},
			setSingleValue : function(entity, column, value) {
				if (entity && column && value) {
					entity[column] = value;
				}
			},
			setExpansions : function(expansions, column, $elements) {
				if (!(expansions && column))
					return;
				$elements.each(function(index) {
					var $this = $(this);
					if (index == 0)
						return;
					expansions[index][column] = $this.val();
				});
			},
			/* 대표 필드 분기 */
			setRepFlag : function($element, entity, list, key) {
				var self = this;
				if ($element) {
					$element.each(function(index) {
						var $this = $(this);
						var isRep = $this.parent().siblings().is('.on');
						if (isRep) {
							self.setRepField(entity, list, key, index, 'Y', $element.length);
						} else {
							self.setRepField(entity, list, key, index, 'N', $element.length);
						}
					});
				}
			},
			/* 대표 필드 값 할당 */
			setRepField : function(entity, list, key, index, value, length) {
				if (index == 0 && length == 1) {
					entity[key] = 'Y';
				} else if (index == 0 && length > 1) {
					entity[key] = value;
				} else {
					list[index][key] = value;
				}
			},
			initList : function($phoneInput, $emailInput, $birthType, $office, $addressType, $homepage, $snsType) {
				var list = [];
				var phoneLen = $phoneInput.length;
				var emailLen = $emailInput.length;
				var birthLen = $birthType.length;
				var officeLen = $office.length;
				var addrLen = $addressType.length;
				var homepageLen = $homepage.length;
				var snsLen = $snsType.length;
				var maxLen = Math.max(phoneLen, emailLen, birthLen, officeLen, addrLen, homepageLen, snsLen);

				if (maxLen <= 1)
					return void 0; // return undefined
				for (var i = 1; i < maxLen; i++) {
					list[i] = {};
				}
				return list;
			},
			/* 입력 필드의 유효성 검사후 필드의 값을 객체화해 리턴 */
			validateForm : function() {
				var $important = this.$el.find('a.contact-modify-important');
				var $firstNameInput = this.$el.find('.lc_list input[name=firstName]');
				var $lastNameInput = this.$el.find('.lc_list input[name=lastName]');
				var $idInput = this.$el.find('.lc_list input[name=identity]');
				var $nicknameInput = this.$el.find('.lc_list input[name=nickname]');
				var $phoneInput = this.$el.find('.lc_list input[name=phone]');
				var $emailInput = this.$el.find('.lc_list input[name=email]');
				var $birthType = this.$el.find('.lc_list .art_grp select[name=birthType]');
				var $office = this.$el.find('.lc_list .art_grp input[name=office]');
				var $department = this.$el.find('.lc_list .art_grp input[name=department]');
				var $duty = this.$el.find('.lc_list .art_grp input[name=duty]');
				var $addressType = this.$el.find('.lc_list .art_grp select[name=addressType]');
				var $homepage = this.$el.find('.lc_list .art_grp input[name=homepage]');
				var $snsType = this.$el.find('.lc_list .art_grp select[name=snsType]');
				var $sns = this.$el.find('.lc_list .art_grp input[name=sns]');
				var $memo = this.$el.find('.ipt_grp textarea[name=memo]');
				var entity = {}; // ADDRESS VALUES
				// ADDRESS_EXPANSION LIST
				var expansions = this.initList($phoneInput, $emailInput, $birthType, $office, $addressType, $homepage,
						$snsType);
				var important = $important.hasClass('a_key_on') ? 'Y' : 'N';
				var lastName = $lastNameInput.val(); // 성
				var firstName = $firstNameInput.val(); // 이름
				if (!firstName) {
					alert(i18n.addAddress.pleaseEnterName);
					$firstNameInput.focus();
					return;
				}
				entity.ADDRESS_IMPORTANT = important;
				entity.ADDRESS_FIRSTNAME = firstName;
				entity.ADDRESS_LASTNAME = lastName;
				entity.ADDRESS_NAME = lastName + firstName; // 성 + 이름
				entity.ADDRESS_ID = $idInput.val();
				entity.ADDRESS_NICKNAME = $nicknameInput.val();
				// setting MultiForm
				var isValidPhone = this.setPhoneValues($phoneInput, $emailInput, entity, expansions);
				if (!isValidPhone) {
					return;
				}
				var isValidEmail = this.setEmailValues($emailInput, entity, expansions);
				if (!isValidEmail) {
					return;
				}
				this.setBirthValues($birthType, entity, expansions);
				this.setOfficeValues($office, $department, $duty, entity, expansions);
				this.setZipcodeAddrValues($addressType, entity, expansions);
				this.setHomepageValues($homepage, entity, expansions);
				this.setSnsValues($snsType, $sns, entity, expansions);
				var memo = $memo.val();
				if (memo.length > 1000) {
					alert(i18n.addAddress.checkMemoLength);
					$memo.focus();
					return;
				}
				entity.ADDRESS_MEMO = memo;
				// set ADDRESS_EXPANSION LIST
				if (expansions) {
					expansions.shift();// 배열의 1번부터 값이 할당되므로 0번 요소 제거
					entity.ADDRESS_EXPANSION_LIST = expansions;
				}
				return entity;
			},
			deleteOption : function($this) {
				var $topDelBtn = $this.parent().siblings().find('a.a_del');
				var $ul = $this.parent().parent();
				$this.parent().remove();
				var $reps = $ul.find('.rep');
				var rep = $reps.hasClass('on');
				if (!rep) {
					$($reps[0]).addClass('on');
				}
				var $adds = $ul.find('.a_add');
				var $addHidden = $adds.find(':hidden');
				if ($addHidden.length == $adds.length) {
					$adds.last().show();
				}
				if ($ul.children().length <= 1) {
					$topDelBtn.hide();
				}
			},
		}); // contact.ContactModifyView

		contact.ContactModifyGroupItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = contact.ContactModifyGroupItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-modify-group-item-template').html();
					compiledTemplate = _.template(html);
					contact.ContactModifyGroupItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.groupCollection = options.groupCollection;
			},
			getLevel : function() {
				var level = 0;
				var parentId = this.model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = this.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = this.groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function() {
				var self = this;
				var level = this.getLevel();
				var $groupName = this.$el.find('label.group-name');
				var name = $groupName.text();
				for (var i = 0; i < level; i++) {
					name = '../' + name;
				}
				$groupName.text(name);
			},
		}); // contact.ContactModifyGroupItemView

		contact.ContactModifyGroupView = Backbone.Marionette.ItemView.extend({
			itemView : contact.ContactModifyGroupItemView,
			itemViewContainer : '#inputGroupListUL',
			template : function(data) {
				var html, compiledTemplate = contact.ContactModifyGroupView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-modify-group-template').html();
					compiledTemplate = _.template(html);
					contact.ContactModifyGroupView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == contact.groupCollection
				if (options.addressCollection) {
					this.addressCollection = options.addressCollection;
				}
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(this.collection, 'add', this.renderGroupItems);
			},
			onRender : function() {
				this.renderItems();
			},
			renderItems : function() {
				var self = this;
				var $groupList = this.$el.find('#inputGroupListUL');
				var $addGroup = this.$el.find('.grp_mv .add_area .add_btn button');
				var $save = this.$el.find('.add_layer_btn button#saveContactModifyGroup');
				var $cancle = this.$el.find('.add_layer_btn button#cancleContactModifyGroup');
				this.renderGroupItems();

				$addGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $groupInput = $('.grp_mv .add_area .add_text #contactNewGroupName');
					if ($groupInput) {
						self.addGroup($groupInput.val());
						$groupInput.val('');
					}
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var options = {}, $checkboxes = $groupList.find('input:checked');
					self.saveGroup($checkboxes, options);
				});
				$cancle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = $groupList.find('li input[type="checkbox"]:checked');
					$checkboxes.each(function() {
						$(this).attr('checked', false);
					});
				});
			},
			renderGroupItems : function(model, collection, options) {
				var self = this;
				var $groupList = this.$el.find('#inputGroupListUL');
				if (arguments.length > 0) {
					$groupList = $('#inputGroupListUL');
				}
				var $checkboxes = $groupList.find('li input[type="checkbox"]:checked');
				$groupList.empty();
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				for (var i = 0; i < groupModels.length; i++) {
					var groupItemView = new contact.ContactModifyGroupItemView({
						model : groupModels[i],
						groupCollection : self.collection,
					});
					$groupList.append(groupItemView.render().el);
				}
				if (this.addressCollection) {
					// 연락처 수정 + 합치기시 연락처의 그룹을 가져와서 check 시킨다.
					this.addressCollection.each(function(addressModel) {
						var GROUP_IDX = addressModel.get('GROUP_IDX');
						$groupList.find('#moveLayer-' + GROUP_IDX).attr('checked', true);
					});
				}
				if (model) {
					// 그룹을 생성시 연락처의 그룹을 가져와서 check 시킨다.
					var GROUP_IDX = model.get('GROUP_IDX');
					var $newGroupCheckbox = $groupList.find('#moveLayer-' + GROUP_IDX);
					$newGroupCheckbox.attr('checked', true);
					$checkboxes.each(function() {
						var $selectGroupCheckbox = $groupList.find('#moveLayer-' + this.value);
						$selectGroupCheckbox.attr('checked', true);
					});
					var pos = $groupList.scrollTop() + $newGroupCheckbox.parent().position().top;
					$groupList.scrollTop(pos);
				}
			},
			addGroup : function(groupName) {
				if ($.trim(groupName).length > 0) {
					var existGroup = this.collection.filter(function(groupModel) {
						return groupModel.get('GROUP_NM') === groupName;
					});
					if (existGroup.length > 0) {
						var existGroupMsg = groupName + i18n.addAddressGroup.existsMessage;
						alert(existGroupMsg);
						return;
					}
					this.collection.create({
						GROUP_NM : groupName
					}, {
						wait : true,
						async : true,
					});
				}
			},
			saveGroup : function($checkboxes, options) {
				if (contact.selectedGroupCollection.length > 0) {
					options['silent'] = true;
				}
				contact.selectedGroupCollection.reset(undefined, options);
				this.collection.each(function(groupModel) {
					$checkboxes.each(function(index, checkbox) {
						if ($(checkbox).val() == groupModel.get('GROUP_IDX')) {
							contact.selectedGroupCollection.add(groupModel);
						}
					});
				}, this);
			},
		}); // contact ContactModifyGroupView

		contact.OrgEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, compiledTemplate = contact.OrgEntryView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-sidebar-entry-template').html();
					compiledTemplate = _.template(html);
					contact.OrgEntryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					entry : data,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.org.OrgEntryModel
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = this.$el.children('.orgNode');
				var $label = this.$el.children('label:first');
				var $list = this.$el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var groupId = self.model.id;
					if (/^org-group-/.test(groupId))
						groupId = groupId.substring(10);
					var now = Date.now ? Date.now() : new Date().getTime();
					location.hash = '#org/' + groupId + '?_=' + now;
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email-address
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common
						// name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email
						// address
						this.$el.data('mail', attributes.mail[0]);
				}
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'groupOfNames')) {
					$list.append($item);
				}
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = (index == $items.length - 1 ? true : false);
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
		}); // contact.OrgEntryView

		contact.OrgView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-sidebar-template').html();
					compiledTemplate = _.template(html);
					contact.OrgView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					entry : data,
				});
				return html;
			},
			itemView : contact.OrgEntryView,
			itemViewContainer : 'ul.orgDepth1',
			initialize : function(options) {
				// this.model == app.org.OrgEntryModel
				this.groupCollection = options.groupCollection;
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
				var $root = this.$el.find('.orgCorp label');
				$root.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var now = Date.now ? Date.now() : new Date().getTime();
					location.hash = '#org?_=' + now;
					;
				});
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'groupOfNames')) {
					$list.append($item);
				}
			},
		}); // contact.OrgView

		contact.OrgHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-header-template').html();
					compiledTemplate = _.template(html);
					contact.OrgHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data.group.toJSON(),
					paginator : data.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = contact.OrgEntryPaginator
				this.group = this.model.get('group');
				this.listenTo(this.group, 'change', this.render);
				this.listenTo(app.vent, 'change:orgEntry', this.changeGroup);
			},
			changeGroup : function(model) {
				this.model.set('group', model);
			},
			onRender : function() {
				var self = this;
				var $searchInput = this.$el.find('.mc-search');
				var $searchBtn = this.$el.find('.mc-search_btn');
				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var keyword = $searchInput.val();
					if (keyword && keyword.length > 0) {
						var hash = '#org?search=' + encodeURIComponent(keyword);
						location.hash = hash;
					}
				});
				$searchInput.keydown(function(event) {
					if (event.which == 13)
						$searchBtn.click();
				});
			}
		}); // contact.OrgHeaderView

		contact.OrgToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-toolbar-template').html();
					compiledTemplate = _.template(html);
					contact.OrgToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					member : data,
					user : contact.contactUserModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = app.org.OrgEntryModel
				// this.collection = app.org.OrgEntryCollection
				this.parentView = options.parentView;
				this.listenTo(app.vent, 'add:org', this.render);
				this.listenTo(app.vent, 'sync-entry:org', this.entryReset);
			},
			onRender : function() {
				var self = this;
				var $selectAllBtn = this.$el.find('div.mc-buttonSet button.btn_selectAll');
				var $addToContact = this.$el.find('div.mc-buttonSet button.btn_addToContact');
				var $orgExport = this.$el.find('div.mc-buttonSet button.org_export');
				var $composeMail = this.$el.find('div.mc-buttonSet button.org_mail_btn');
				var $composeSms = this.$el.find('div.mc-buttonSet button.org_sms_btn');
				var $composeNote = this.$el.find('div.mc-buttonSet button.org_note_btn');
				var $print = this.$el.find('.mc-rightTool .ic');
				$selectAllBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $listRegion = self.parentView.orgListRegion.$el;
					var $toggle = $listRegion.find('#checkListAll');
					var $checkboxes = $listRegion.find('div.org-list_area tbody input.inp_ch');
					var $this = $(this);
					if ($this.is('.toolbar-selectAll')) {
						$this.removeClass('toolbar-selectAll');
						$checkboxes.prop('checked', false);
						$toggle.prop('checked', false);
						self.collection.forEach(function(model) {
							contact.selectedAddressCollection.remove(model);
						});
					} else {
						$this.addClass('toolbar-selectAll');
						$checkboxes.prop('checked', true);
						$toggle.prop('checked', true);
						self.collection.forEach(function(model) {
							contact.selectedAddressCollection.add(model);
						});
					}
				});
				$addToContact.click(function(event) {
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#orgManagementLayer');
					// $layer.css({
					// position : 'absolute',
					// top : top,
					// left : left
					// });
					$layer.attr('hidable', false);
					var $checkboxes = $('div.org-list_area tbody input.inp_ch').filter(':checked');
					var isGroup = $checkboxes.hasClass('group');
					if ($checkboxes.length < 1) {
						alert(i18n.organize.selectGroup);
						return;
					} else if ($checkboxes.hasClass('user') && isGroup) {
						alert(i18n.organize.notAdded);
						return;
					} else if ($checkboxes.length > 1 && isGroup) {
						alert(i18n.organize.chooseOne);
						return;
					} else if ($checkboxes.length == 1 && isGroup) { // 그룹저장
						var grpIdx = $('.listSubGrpIdx').siblings().filter(':checked').val();
						var domain = app.userModel.get('DOMAIN');
						var tmpUrl = 'org/' + domain + '/groups/';
						var orgModel = new app.org.OrgEntryModel({
							urlRoot : tmpUrl,
							id : grpIdx,
						});
						orgModel.fetch({
							async : false,
						});
						var orgGroupAddContactView = new contact.OrgGroupAddContactView({
							userModel : this.userModel,
							model : orgModel,
						});
						orgGroupAddContactView.render();
						$('#orgManagementLayer').html(orgGroupAddContactView.el);
					} else { // 그룹원 저장
						var orgAddContactView = new contact.OrgAddContactView({
							userModel : this.userModel,
							collection : contact.groupCollection,
						});
						orgAddContactView.render();
						$('#orgManagementLayer').html(orgAddContactView.el);
					}
					$layer.toggle();
				});
				$orgExport.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					alert("준비중입니다.");
				});
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1) {
						alert(i18n.pleaseSelectContact);
						return;
					}
					var params = {
						to : [],
					};
					contact.selectedAddressCollection.each(function(entryModel) {
						var param = '';
						var attributes = entryModel.get('attributes');
						if (_.contains(attributes.objectClass, 'user')) {
							var alias = attributes.cn;
							var email = attributes.mail;
							if (alias) {
								param += '"' + alias + '"';
								param += '<' + email + '>';
							} else {
								param += email;
							}
						} else {
							param += '$' + attributes.cn;
						}
						params.to.push(param);
					});
					location.hash = "compose?" + decodeURIComponent($.param(params, true));
				});
				$composeSms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					alert("준비중입니다.");
				});
				$composeNote.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					alert("준비중입니다.");
				});
				$print.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					alert("준비중입니다.");
				});
			},
			entryReset : function(entries) {
				this.collection.reset();
				this.collection.add(entries.entry.models);
			},
		}); // contact.OrgToolbarView

		contact.OrgFilterToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgFilterToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-filter-toolbar-template').html();
					compiledTemplate = _.template(html);
					contact.OrgFilterToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = org.OrgEntryPaginator
			},
			onRender : function() {
				var self = this;
				var $searchKey = this.$el.find('.word_box li');
				var $category = this.$el.find('.view_box li.typeFilter');
				var $exposure = this.$el.find('.view_box li.customField');
				var $item = self.$el.find('ul.word_box li span');
				$item.each(function() {
					var keyIndex = decodeURIComponent(self.collection.server_api.keyIndex);
					if (keyIndex === 'all') {
						keyIndex = i18n.all;
					} else if (keyIndex === 'other') {
						keyIndex = i18n.other;
					} else if (keyIndex === 'noname') {
						keyIndex = i18n.noname;
					}
					if ($(this).html() === keyIndex) {
						self.selectItem($(this).parent());
					}
				});
				$searchKey.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.selectItem($(this).children('a:first'));
					var keyIndex = $(this).find('span').text();
					if (keyIndex === i18n.all) {
						keyIndex = 'all';
					} else if (keyIndex === i18n.other) {
						keyIndex = 'other';
					} else if (keyIndex === i18n.noname) {
						keyIndex = 'noname';
					}
					var domain = app.userModel.get('DOMAIN');
					var params = self.collection.server_api;
					params.keyIndex = encodeURIComponent(keyIndex);
					app.vent.trigger('paginate:org-entries', params);
				});
				$category.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $header = $('.mc-content_header');
					var $categoryLayer = $('#orgTypeFilterLayer');
					var left, top, $target = $(this);
					top = $header.height() + $target.position().top + $target.height();
					left = $target.position().left;
					// $categoryLayer.css({
					// top : top,
					// left : left,
					// });
				});
				$exposure.click(function(event) {
					event.preventDefault() && event.stopPropagation();
				});
			},
			selectItem : function($this) {
				var $parent = $this.parent();
				$parent.siblings().removeClass('clk');
				$parent.addClass('clk');
			},
		}); // contact.OrgFilterToolbarView

		contact.OrgCategoryFilterView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgCategoryFilterView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-category-filter-template').html();
					compiledTemplate = _.template(html);
					contact.OrgCategoryFilterView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = org.OrgEntryPaginator
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.find('ul li');
				$items.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $item = $(event.target, this);
					var className = $item.attr('class');
					var categoryType = className.slice(className.indexOf('-') + 1);
					var domain = app.userModel.get('DOMAIN');
					var params = self.collection.server_api;
					params.categoryType = encodeURIComponent(categoryType);
					app.vent.trigger('paginate:org-entries', params);
				});
			},
		}); // contact.orgCategoryFilterView

		contact.OrgExposeListView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgExposeListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-expose-template').html();
					compiledTemplate = _.template(html);
					contact.OrgExposeListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = org.OrgEntryPaginator
			},
			onRender : function() {
				var self = this;
				var $inputs = this.$el.find('input');
				var $save = this.$el.find('.add_layer_btn button.b');
				var $cancel = this.$el.find('.add_layer_btn button.c');
				var expose = {};
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				$save.click(function() {
					$inputs.each(function() {
						var $input = $(this);
						expose[$input.attr('name')] = $input.prop('checked') ? 1 : 0;
					});
					self.model.save({
						PHONE_FLAG : expose['phone'],
						CELLPHONE_FLAG : expose['cellphone'],
						EMAIL_FLAG : expose['email'],
						COMPANY_FLAG : expose['company'],
						DEPARTMENT_FLAG : expose['department'],
						DUTY_FLAG : expose['duty'],
					}, {
						wait : true,
						patch : true,
						success : function(res) {
							if (res.get('faultcode')) {
								alert(res.get('faultcode') + ' : ' + res.get('faultstring'));
								return;
							} else {
								var domain = app.userModel.get('DOMAIN');
								var params = self.collection.server_api;
								app.vent.trigger('paginate:org-entries', params);
								app.vent.trigger('hide:orgExpose-list-view');
							}
						},
					});

				});
				$cancel.click(function() {
					$('#orgCustomFieldLayer').toggle();
				});
			},
		}); // contact.orgExposeListView

		contact.OrgAddContactView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgAddContactView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-add-contact-template').html();
					compiledTemplate = _.template(html);
					contact.OrgAddContactView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					user : contact.contactUserModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = contact.groupCollection
				this.orgCollection = options.orgCollection;
				this.listenTo(this.collection, 'add', this.render);
			},
			onRender : function() {
				var self = this;
				this.renderGroupItems();
				var $selGroup = this.$el.find('div.add_layertbl li');
				var $addContactBtn = this.$el.find('div.add_layer_btn .add');
				$selGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					$this.siblings().removeClass('selected');
					$this.addClass('selected');
				});
				$addContactBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var addrGroupIdx = $('.org_ad .mailBoxList').find('li.selected input').val();
					var $checked = $('div.org-list_area .check .inp_ch').filter(':checked');
					var grpIdx;
					$checked.each(function(index, element) {
						var $checkbox = $(element);
						var emailId = $checkbox.val();
						if ($checkbox.hasClass('user')) {
							grpIdx = $checkbox.parent().find('.listUserGrpIdx').val();
						} else {
							grpIdx = $checkbox.parent().find('.listSubGrpIdx').val();
						}
						var orgEntryModel = new app.org.OrgEntryModel();
						var domain = app.userModel.get('DOMAIN');
						var tmpUrl = 'org/' + domain + '/groups/' + encodeURIComponent(grpIdx) + '/users/'
								+ encodeURIComponent(emailId);
						orgEntryModel.fetch({
							url : tmpUrl,
							async : false,
						});
						var attributes = orgEntryModel.get('attributes');
						if (attributes) {
							var addressModel = new contact.AddressModel();
							addressModel.save({
								ADDRESS_NAME : attributes.cn[0],
								ADDRESS_EMAIL : attributes.mail[0],
								ADDRESS_CELLTEL : attributes.mobile[0],
								ADDRESS_TEL : attributes.homePhone[0],
								GROUP_IDX : addrGroupIdx,
								ORG_EMAIL : attributes.mail[0],
							}, {
								wait : true,
								async : false,
							});
						}
					});
					self.unchecked($checked);
				});
			},
			renderGroupItems : function() {
				var self = this;
				var $groupList = this.$el.find('div.org_ad .mailBoxList');
				$groupList.empty();
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				for (var i = 0; i < groupModels.length; i++) {
					var groupItemView = new contact.OrgAddContactItemView({
						model : groupModels[i],
						groupCollection : self.collection,
					});
					$groupList.append(groupItemView.render().el);
				}
				var $addArea = this.$el.find('div.add_area');
				var addAreaView = new contact.OrgAddContactNewGroupView({
					collection : this.collection
				});
				$addArea.append(addAreaView.render().el);
			},
			unchecked : function($items) {
				$items.each(function() {
					if (this.checked) {
						$items.removeAttr('checked');
					}
					var $selectAllCheckbox = $('#checkListAll');
					if ($selectAllCheckbox.prop('checked'))
						$selectAllCheckbox.prop('checked', false);

					var orgEntryModel = new app.org.OrgEntryModel({
						id : this.value,
					});
					contact.selectedAddressCollection.remove(orgEntryModel);
				});
			},
		}); // contact.OrgAddContactView

		contact.OrgAddContactItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = contact.OrgAddContactItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-add-contact-item-template').html();
					compiledTemplate = _.template(html);
					contact.OrgAddContactItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.GroupModel
				this.groupCollection = options.groupCollection;
			},
			getLevel : function() {
				var level = 0;
				var parentId = this.model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = this.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = this.groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var level = this.getLevel();
				var $groupName = this.$el.find('label.group-name');
				var name = $groupName.text();
				for (var i = 0; i < level; i++) {
					name = '../' + name;
				}
				$groupName.text(name);
			}
		}); // contact.OrgAddContactItemView

		contact.OrgAddContactNewGroupView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgAddContactNewGroupView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-add-contact-add-area-template').html();
					compiledTemplate = _.template(html);
					contact.OrgAddContactNewGroupView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collectioin = contact.GropuCollection
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var self = this;
				var $addrGroupAdd = self.$el.find('.addrGroup_add');
				$addrGroupAdd.click(function() {
					var grpNm = self.$el.find('#newGroupAdd').val();
					if (grpNm.length < 1) {
						alert(i18n.settings.groupMng.addGroupNameMessage);
						return;
					}
					var addrGroup = contact.groupCollection.filter(function(groupModel) {
						return groupModel.get('GROUP_NM') === grpNm;
					});
					if (addrGroup.length > 0) {
						var msg = grpNm + i18n.addAddressGroup.existsMessage;
						alert(msg);
						return;
					}
					var groupModel = new contact.GroupModel();
					groupModel.save({
						GROUP_NM : grpNm,
					}, {
						success : function() {
							contact.groupCollection.fetch();
						}
					});
				});
			}
		}); // contact.OrgAddContactNewGroupView

		contact.OrgGroupAddContactView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.OrgGroupAddContactView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-group-add-contact-template').html();
					compiledTemplate = _.template(html);
					contact.OrgGroupAddContactView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = app.org.OrgEntryModel
			},
			onRender : function() {
				var self = this;
				var $addBtn = self.$el.find('div.add_layer_btn .add');
				$addBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var item = $('div.org-list_area .check .inp_ch').filter(':checked');
					if (item && item[0]) {
						var grpIdx = $(item[0]).parent().find('.listSubGrpIdx').val();
						var orgEntryModel = new app.org.OrgEntryModel();
						var domain = app.userModel.get('DOMAIN');
						var tmpUrl = 'org/' + domain + '/groups/' + encodeURIComponent(grpIdx);
						orgEntryModel.fetch({
							url : tmpUrl,
							async : false,
						});
						var attributes = orgEntryModel.get('attributes');
						if (attributes) {
							var orgGroupNm = attributes.cn[0];
							if (orgGroupNm && orgGroupNm.length < 1) {
								alert(i18n.settings.groupMng.addGroupNameMessage);
								return;
							}
							var addrGroup = contact.groupCollection.filter(function(groupModel) {
								return groupModel.get('GROUP_NM') === orgGroupNm;
							});
							if (addrGroup.length > 0) {
								var msg = orgGroupNm + i18n.addAddressGroup.existsMessage;
								alert(msg);
								return;
							}
							self.createAddressGroup(orgGroupNm);

							addrGroup = contact.groupCollection.find(function(groupModel) {
								return groupModel.get('GROUP_NM') === orgGroupNm;
							});
							var addrGroupIdx = addrGroup.id;
							self.addToContact(attributes, addrGroupIdx);

							self.unchecked($(item[0]));
						}
					}
				});
			},
			createAddressGroup : function(groupNm) {
				var groupModel = new contact.GroupModel();
				groupModel.save({
					GROUP_NM : groupNm,
				}, {
					wait : true,
					async : false,
					success : function() {
						contact.groupCollection.fetch({
							async : false
						});
					}
				});
			},
			addToContact : function(attributes, addrGroupIdx) {
				var addressModel = new contact.AddressModel();
				var orgEntryModels = attributes.member;
				_.each(orgEntryModels, function(model) {
					var member = model.attributes;
					if (_.contains(member.objectClass, 'user')) {
						addressModel.save({
							ADDRESS_NAME : member.cn[0],
							ADDRESS_EMAIL : member.mail[0],
							ADDRESS_CELLTEL : member.mobile[0],
							ADDRESS_TEL : member.homePhone[0],
							GROUP_IDX : addrGroupIdx,
							ORG_EMAIL : member.mail[0],
						});
					}
				});
			},
			unchecked : function($items) {
				$items.each(function() {
					if (this.checked) {
						$items.removeAttr('checked');
					}
					var $selectAllCheckbox = $('#checkListAll');
					if ($selectAllCheckbox.prop('checked'))
						$selectAllCheckbox.prop('checked', false);

					var orgEntryModel = new app.org.OrgEntryModel({
						id : this.value,
					});
					contact.selectedAddressCollection.remove(orgEntryModel);
				});
			},
		}); // contact.OrgGroupAddContactView

		contact.OrgListItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = contact.OrgListItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-item-template').html();
					compiledTemplate = _.template(html);
					contact.OrgListItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					member : data,
					user : contact.contactUserModel.toJSON(),
					params : contact.params,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = app.org.OrgEntryModel
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var attribute = self.model.get('attributes');
				var objectClass = attribute.objectClass;
				var $checkbox = self.$el.find('td.check input.inp_ch');
				var $item = self.$el.find('td.check');
				var $important = self.$el.find('.important_' + attribute.uid);
				var $td = this.$el.find('td');
				var $grpIdx, userGrpIdx;
				if (_.contains(objectClass, 'groupOfNames')) {
					$grpIdx = $('<input>', {
						type : 'hidden',
						name : 'listSubGrpIdx',
						'class' : 'listSubGrpIdx',
						value : self.model.id,
					});
					$item.append($grpIdx);
				} else {
					userGrpIdx = self.model.urlRoot.split('\/');
					if (userGrpIdx && userGrpIdx[3]) {
						userGrpIdx = userGrpIdx[3];
					}
					var $userGrpIdx = $('<input>', {
						type : 'hidden',
						name : 'listUserGrpIdx',
						'class' : 'listUserGrpIdx',
						value : userGrpIdx,
					});
					var $usersIdx = $('<input>', {
						type : 'hidden',
						name : 'listUsersIdx',
						'class' : 'listUsersIdx',
						value : attribute.mail[0],
					});
					$item.append($userGrpIdx).append($usersIdx);
					if (self.model.get('important')) {
						$important.addClass('on');
					} else {
						$important.addClass('off');
					}
				}
				var $orgLinks = self.$el.find('td.name a');
				$orgLinks.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var groupId = self.model.id;
					if (/^org-group-/.test(groupId))
						groupId = groupId.substring(10);
					location.hash = '#org/' + groupId;
					return false;
				});
				$checkbox.change(function(event) {
					event.stopPropagation();
					var $elem = $(self.el)
					if ($(this).is(':checked')) {
						$elem.addClass('focus');
						contact.selectedAddressCollection.add(self.model);
					} else {
						$elem.removeClass('focus');
						contact.selectedAddressCollection.remove(self.model);
					}
				});
				$checkbox.click(function(event) {
					event.stopPropagation();
				});
				$td.click(function(event) {
					if ($checkbox.is(':checked')) {
						$checkbox.prop('checked', false);
					} else {
						$checkbox.prop('checked', true);
					}
					$checkbox.change();
				});
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var important = self.model.get('important');
					if (important) {
						important = false;
					} else {
						important = true;
					}
					self.model.save({
						important : important
					}, {
						patch : true,
						wait : true,
						async : false,
					});
				});
			}
		}); // contact.OrgListItemView

		contact.OrgListView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.OrgListItemView,
			itemViewContainer : 'div.org-list_area div.scroll_zoom tbody',
			template : function(data) {
				var html, compiledTemplate = contact.OrgListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-list-template').html();
					compiledTemplate = _.template(html);
					contact.OrgListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					paginator : contact.orgPaginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.contactUserModel
				// this.collection == org.OrgEntryPaginator
				this.selectedAddressCollection = options.selectedAddressCollection;
				this.listenTo(this.selectedAddressCollection, 'reset', this.resetCheckboxes);
				this.listenTo(this.selectedAddressCollection, 'remove', this.unchecked);
			},
			onCompositeCollectionRendered : function() {
				var self = this, $el = this.$el;
				var $selectAllBtn = $('div.mc-buttonSet button.btn_selectAll');
				var $selectAllCheckbox = $el.find('#checkListAll');
				var $checkboxes = $el.find('div.org-list_area div.scroll_zoom td.check input.inp_ch');
				var $addToContact = $el.find('.mc-actionArea .btn_addToContact');
				var $mailBtn = $el.find('.mc-actionArea .org_mail_btn');
				var $sortItems = $el.find('#org-listHead thead th a');
				var checked = 0;
				$checkboxes.each(function(index, checkbox) {
					var $this = $(checkbox);
					contact.selectedAddressCollection.each(function(entryModel) {
						var attribute = entryModel.get('attributes');
						var isUser = _.contains(attribute.objectClass, 'user');
						var entryId = isUser ? attribute.uid : entryModel.get('id');
						if ($this.val() == entryId) {
							$this.attr('checked', true).trigger('change');
							checked++;
						}
					});
				});
				if (checked > 0 && checked == $checkboxes.length) {
					$selectAllCheckbox.attr('checked', true);
				}
				$selectAllCheckbox.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						$checkboxes.prop('checked', true).trigger('change');
						if (!$selectAllBtn.is('.org-selectAll')) {
							$selectAllBtn.addClass('org-selectAll');
						}
					} else {
						$checkboxes.removeAttr('checked').trigger('change');
						if ($selectAllBtn.is('.org-selectAll')) {
							$selectAllBtn.removeClass('org-selectAll');
						}
					}
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length) {
							$selectAllCheckbox.prop('checked', true);
						}
					} else {
						$selectAllCheckbox.removeAttr('checked');
					}
				});
				$checkboxes.change();
				$sortItems.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var sortField = this.className;
					if (sortField == 'on')
						sortField = 'important';
					var domain = app.userModel.get('DOMAIN');
					var params = self.collection.server_api;
					params.sortField = sortField;
					params.sortOrder = self.collection.sortOrder == 'ASC' ? 'DESC' : 'ASC';
					app.vent.trigger('paginate:org-entries', params);
				});
				app.vent.trigger('sync-entry:org', {
					entry : self.collection,
				});
				var $headColumnCol = self.$el.find('table#org-listHead colgroup col');
				self.changeColName($headColumnCol);
				var $subColumnCol = self.$el.find('div.org-list_area colgroup col');
				self.changeColName($subColumnCol);
				// Pagination
				var $pagination = $('.mc-paginate');
				var paginationView = new contact.OrgPaginationView({
					collection : this.collection
				});
				$pagination.html(paginationView.render().$el.children());
			},
			changeColName : function($columnCol) {
				$columnCol.each(function(index, element) {
					if (index != 0 && index != 1 && index != $columnCol.length - 1)
						$(element).attr('class', 'col_auto');
				});
			},
			resetCheckboxes : function() {
				var $el = this.$el;
				var $checkboxes = $el.find('div.org-list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.removeAttr('checked').trigger('change');
			},
			unchecked : function(entry) {
				var $el = this.$el;
				var entryId = entry.attributes.id;
				var $checkboxes = $el.find('div.org-list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.each(function(index, checkbox) {
					if ($(checkbox).val() === entryId) {
						$(checkbox).removeProp('checked').trigger('change');
					}
				});
			},
		}); // contact.OrgListView

		contact.OrgPaginationView = Backbone.Marionette.ItemView.extend({
			initialize : function(options) {
				// this.collection == org.OrgEntryPaginator
			},
			render : function() {
				var html, compiledTemplate = contact.OrgPaginationView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-pagination-template').html();
					compiledTemplate = _.template(html);
					contact.OrgPaginationView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				this.$el.html(html);
				var $firstPage = this.$el.find('a.pre_end:first');
				$firstPage.click($.proxy(this.gotoFirst, this));
				var $prevPage = this.$el.find('a.pre:first');
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = this.$el.find('a.next:first');
				$nextPage.click($.proxy(this.gotoNext, this));
				var $lastPage = this.$el.find('a.next_end:first');
				$lastPage.click($.proxy(this.gotoLast, this));
				var $pages = this.$el.find('.org-entries-page');
				$pages.click($.proxy(this.gotoPage, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.previousPage();
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.nextPage();
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.preventDefault() && event.stopPropagation();
				var page = $(event.target).text();
				this.collection.goTo(page);
			},
		}); // contact.OrgPaginationView

		contact.ContactImportLayoutView = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var html = contact.$template.filter('#contact-import-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				importFromFileRegion : 'div#adrsImportTab1',
				importFromMailRegion : 'div#adrsImportTab2',
			},
			initialize : function(options) {
				// this.model == contact.groupModel
				// this.collection == contact.groupCollection
				this.userModel = options.userModel;
				this.uploadedContactCollection = new app.BackboneCollection();
				this.mailLoadedContactCollection = new app.BackboneCollection();
			},
			onRender : function() {
				var self = this;
				this.showImportFromFileView();
				this.showImportFromMailView();
				var $tabs = this.$el.find('ul.tab_cm li');
				$tabs.eq(0).addClass('select');
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$tabs.removeClass('select');
					var $item = $(this).addClass('select');
					var id = $item.attr('id');
					switch (id) {
					case 'import-from-file': // 파일에서 불러오기
						self.importFromMailRegion.$el.hide();
						self.importFromFileRegion.$el.show();
						break;
					case 'import-from-mail': // 메일에서 불러오기
						self.importFromFileRegion.$el.hide();
						self.importFromMailRegion.$el.show();
						break;
					}
					return false;
				});
				var $closeSampleLayer = this.$el.find('#txt_pop_close');
				$closeSampleLayer.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.find('div.sample-upload-text-layer').hide();
				});
			},
			showImportFromFileView : function() {
				contact.overlayView.showProcessing();
				this.importFromFileRegion.show(new contact.ContactImportFromFileView({
					collection : this.uploadedContactCollection,
					groupCollection : this.collection,
					parentView : this,
				}));
				contact.overlayView.hideProcessing();
			},
			showImportFromMailView : function() {
				contact.overlayView.showProcessing();
				if (!this.mboxCollection) {
					this.mboxCollection = new app.mail.MboxCollection();
					this.mboxCollection.fetch({
						wait : true,
						async : false,
					});
				}
				this.importFromMailRegion.show(new contact.ContactImportFromMailView({
					model : new Backbone.Model({
						mboxes : this.mboxCollection.toJSON(),
					}),
					collection : this.mailLoadedContactCollection,
					groupCollection : this.collection,
					parentView : this,
				}));
				contact.overlayView.hideProcessing();
			},
		}); // contact.ContactImportLayoutView

		contact.ContactImportFromFileItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html = contact.$template.filter('#contact-import-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					contact : data,
					i18n : i18n,
					groups : contact.groupCollection.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(this.model, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				this.$el.data('cid', this.model.cid);
				var $input = this.$el.find('input[type=text]');
				$input.blur(function() {
					var $this = $(this);
					var $checkbox = self.$el.find('input[type=checkbox]');
					var inputValue = $.trim($this.val());
					switch ($this.attr('name')) {
					case 'contact-name':
						if ($input.length == 1) {
							self.model.set('ADDRESS_NAME', inputValue);
							if (inputValue) {
								$checkbox.removeAttr('disabled').prop('checked', 'checked');
							} else {
								$checkbox.attr('disabled', true).prop('checked', false);
							}
						}
						break;
					case 'contact-tel':
					case 'contact-email':
						var $name = self.$el.find('[name=contact-name]');
						if ($this.attr('name') == 'contact-tel')
							self.model.set('ADDRESS_TEL', inputValue);
						else if ($this.attr('name') == 'contact-email')
							self.model.set('ADDRESS_EMAIL', inputValue);
						if ($name.length == 0) {
							if (inputValue) {
								$checkbox.removeAttr('disabled').prop('checked', 'checked');
							} else {
								$checkbox.attr('disabled', true).prop('checked', false);
							}
						} else {
							if ($name.val() && inputValue) {
								$checkbox.removeAttr('disabled').prop('checked', 'checked');
							} else {
								$checkbox.attr('disabled', true).prop('checked', false);
							}
						}
						break;
					}
				});
				$input.blur();
			},
		}); // contact.ContactImportFromFileItemView

		contact.ContactImportFromFileView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.ContactImportFromFileItemView,
			itemViewContainer : 'tbody.contact-import-list',
			template : function(data) {
				var html, compiledTemplate = contact.ContactImportFromFileView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-import-list-template').html();
					compiledTemplate = _.template(html);
					contact.ContactImportFromFileView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contacts : data.items,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == uploadedContactCollection
				this.groupCollection = options.groupCollection;
				this.parentView = options.parentView;
				this.listenTo(this.groupCollection, 'sync', this.render);
			},
			onRender : function() {
				$('div.mc-paginate').hide();
				var self = this;
				var $sampleText = this.$el.find('button[name=sample-upload-text]');
				$sampleText.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $sampleLayer = self.parentView.$el.find('div.sample-upload-text-layer');
					$sampleLayer.toggle();
					return false;
				});
				this.files = [];
				var $fileInput = this.$el.find('input[name="upload-contacts"]');
				$fileInput.prop('accept', 'text/*, .csv, .xls, .xlsl');
				$fileInput.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.files = this.files;
					return false;
				});
				var $add = this.$el.find('button.add-file');
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!$fileInput[0].files) {
						var $form = self.$el.find('form[name=contactsImportForm]');
						contact.overlayView.showProcessing();
						$form.ajaxSubmit({
							url : 'contacts/import/file',
							dataType : 'text',
							success : function(response) {
								contact.overlayView.hideProcessing();
								var contacts = JSON.parse(response);
								self.collection.reset(contacts);
							},
						});
					} else {
						var formData = new FormData();
						var time = Date.now ? Date.now() : new Date().getTime();
						$.each(self.files, function(index, file) {
							var name = time + '.' + index;
							formData.append(name, file);
						});
						var xhr = new XMLHttpRequest();
						xhr.open('POST', 'contacts/file');
						xhr.upload.onprogress = function(event) {
							contact.overlayView.showProcessing();
						};
						xhr.upload.onabort = function(event) {
							contact.overlayView.hideProcessing();
						};
						xhr.upload.onload = function(event) {
							contact.overlayView.hideProcessing();
						};
						xhr.onreadystatechange = function() {
							if (xhr.readyState == 4 && xhr.status == 200) {
								if (xhr.responseText) {
									var contacts = JSON.parse(xhr.responseText);
									self.collection.reset(contacts);
								}
							}
						};
						xhr.send(formData);
					}
					return false;
				});
				var $toggle = this.$el.find('input[type=checkbox].toggle-contacts');
				$toggle.change(function(event) {
					var $checkboxes = self.$el.find('div.address_call_lst:first tbody tr input[type=checkbox]');
					$checkboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($toggle.is(':checked')) {
								$this.prop('checked', 'checked');
							} else {
								$this.removeProp('checked');
							}
						}
					});
				});
				var $checkAll = this.$el.find('button.check-all');
				$checkAll.click(function(event) {
					if ($toggle.is(':checked')) {
						$toggle.removeProp('checked');
					} else {
						$toggle.prop('checked', 'checked');
					}
					var $checkboxes = self.$el.find('div.address_call_lst:first tbody tr input[type=checkbox]');
					$checkboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($toggle.is(':checked')) {
								$this.prop('checked', 'checked');
							} else {
								$this.removeProp('checked');
							}
						}
					});
				});
				var $removeDuplicate = this.$el.find('button.remove-duplicate');
				$removeDuplicate.click(function(event) {
					if ($toggle.is(':checked')) {
						$toggle.removeProp('checked');
					}
					var $checkboxes = self.$el.find('div.address_call_lst:first tbody tr input[type=checkbox]');
					$checkboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($this.data('contact-dupliacted')) {
								$this.removeProp('checked');
							}
						}
					});
				});
				var $containsDuplicate = this.$el.find('button.contains-duplicate');
				$containsDuplicate.click(function(event) {
					var $checkboxes = self.$el.find('div.address_call_lst:first tbody tr input[type=checkbox]');
					$checkboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($this.data('contact-dupliacted')) {
								$this.prop('checked', 'checked');
							}
						}
					});
				});
				var $selectGroup = this.$el.find('select[name=groups]');
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.groupCollection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.groupCollection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				var options = [];
				options.push($('<option value="0"></option>').text(i18n.setUpGroup));
				for (var i = 0; i < groupModels.length; i++) {
					var level = self.getLevel(groupModels[i], self.groupCollection);
					var $option = $('<option></option>');
					$option.val(groupModels[i].get('GROUP_IDX'));
					var name = groupModels[i].get('GROUP_NM');
					for (var j = 0; j < level; j++) {
						name = '../' + name;
					}
					$option.text(name);
					options.push($option);
				}
				$selectGroup.append(options);
				var $groupname = this.$el.find('input.input-groupname');
				$selectGroup.change(function() {
					var groupId = $(this).val();
					if (groupId == 0) {
						$groupname.show();
					} else {
						$groupname.hide();
						$groupname.val('');
					}
				});
				var $save = this.$el.find('button.save-contacts');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('div.address_call_lst:first tbody tr input[type=checkbox]');
					if ($checkboxes && $checkboxes.length > 0) {
						var contactModels = [];
						var $rows = $checkboxes.filter(':checked').closest('tr');
						if (!$rows.length) {
							alert(i18n.pleaseSelectAddress);
							return false;
						} else {
							$rows.each(function() {
								var cid = $(this).data('cid');
								var contactModel = self.collection.get(cid);
								if (contactModel.get('ADDRESS_EMAIL')) {
									var expr = /^((\w|[\-\.])+)@((\w|[\-\.])+)\.([A-Za-z]+)$/;
									if (!expr.test(contactModel.get('ADDRESS_EMAIL'))) {
										alert(i18n.invalidEmail);
										return false;
									}
								}
								contactModels.push(contactModel);
							});
							if ($rows.length != contactModels.length)
								return false;
						}
						var groupId = $selectGroup.val();
						contact.overlayView.showProcessing();
						var groupname = $groupname.val();
						if (groupname) {
							var groupModel = self.groupCollection.getGroupModel("GROUP_NM", groupname);
							if (!groupModel) {
								self.groupCollection.create({
									GROUP_NM : groupname,
								}, {
									wait : true,
									async : false,
								});
								groupModel = self.groupCollection.getGroupModel("GROUP_NM", groupname);
							}
							groupId = groupModel.get('GROUP_IDX');
						}
						contactModels.each(function(contactModel) {
							contactModel.url = 'contacts/contact/0?_method=PUT';
							if (groupId != 0)
								contactModel.set('GROUP_IDX', groupId);
							contactModel.save(null, {
								wait : true,
							});
						});
						self.groupCollection.fetch();
						self.collection.reset();
						contact.overlayView.hideProcessing();
						alert(i18n.storeImported);
					}
				});
			},
			getLevel : function(model, groupCollection) {
				var level = 0;
				var parentId = model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
		}); // contact.ContactImportFromFileView

		contact.ContactImportFromMailItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html = contact.$template.filter('#contact-import-from-mail-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					contact : data,
					i18n : i18n,
					groups : contact.groupCollection.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(this.model, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				this.$el.data('cid', this.model.cid);
				var $input = this.$el.find('input[type=text]');
				var isName = false, isEmail = false, isTel = false;
				$input.blur(function() {
					var $this = $(this);
					var $checkbox = self.$el.find('input[type=checkbox]');
					var inputValue = $.trim($this.val());
					switch ($this.attr('name')) {
					case 'contact-name':
						self.model.set('ADDRESS_NAME', inputValue);
						if (inputValue) {
							isName = true;
						} else {
							isName = false;
						}
						break;
					case 'contact-email':
						self.model.set('ADDRESS_EMAIL', inputValue);
						if (inputValue) {
							isEmail = true;
						} else {
							isEmail = false;
						}
						break;
					case 'contact-tel':
						self.model.set('ADDRESS_TEL', inputValue);
						if (inputValue) {
							isTel = true;
						} else {
							isTel = false;
						}
						break;
					}
					if ((isName && isEmail) || (isName && isTel))
						$checkbox.removeAttr('disabled').prop('checked', 'checked');
					else
						$checkbox.attr('disabled', true).prop('checked', false);
				});
				$input.blur();
			},
		}); // contact.ContactImportFromMailItemView

		contact.ContactImportFromMailView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.ContactImportFromMailItemView,
			itemViewContainer : 'tbody.contact-import-list',
			template : function(data) {
				var html, compiledTemplate = contact.ContactImportFromMailView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-import-from-mail-template').html();
					compiledTemplate = _.template(html);
					contact.ContactImportFromMailView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mboxes : data.mboxes,
					groups : contact.groupCollection.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mailLoadedContactCollection
				this.groupCollection = options.groupCollection;
				this.parentView = options.parentView;
				this.listenTo(this.groupCollection, 'sync', this.render);
			},
			onRender : function() {
				$('div.mc-paginate').hide();
				var self = this;
				var $mboxToggle = this.$el.find('.toggle-mbox');
				var $mboxCheckboxes = this.$el.find('ul.scheck_list li input[type=checkbox]');
				$mboxToggle.change(function() {
					if (this.checked) {
						$mboxCheckboxes.prop('checked', 'checked');
					} else {
						$mboxCheckboxes.removeProp('checked');
					}
				});
				var $load = this.$el.find('button.load-contacts');
				$load.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = 'contacts/mail-senders';
					var $receivedPeriod = self.$el.find('select[name=received-period]');
					var $receivedCount = self.$el.find('select[name=received-count]');
					var now = new Date(), date = new Date();
					var startDate, endDate;
					var mboxIds = [];
					var $selectMboxCheckboxes = $mboxCheckboxes.filter(':checked');
					if ($selectMboxCheckboxes.length == 0) {
						alert(i18n.selectMailMbox);
						return;
					}
					$selectMboxCheckboxes.each(function() {
						mboxIds.push($(this).val());
					});
					switch ($receivedPeriod.val()) {
					case '1M':
						date.setMonth(now.getMonth() - 1);
						startDate = $.format.date(date, 'yyyy-MM-dd');
						endDate = $.format.date(now, 'yyyy-MM-dd');
						break;
					case '3M':
						date.setMonth(now.getMonth() - 3);
						startDate = $.format.date(date, 'yyyy-MM-dd');
						endDate = $.format.date(now, 'yyyy-MM-dd');
						break;
					case '6M':
						date.setMonth(now.getMonth() - 6);
						startDate = $.format.date(date, 'yyyy-MM-dd');
						endDate = $.format.date(now, 'yyyy-MM-dd');
						break;
					case '1Y':
						date.setFullYear(now.getFullYear() - 1);
						startDate = $.format.date(date, 'yyyy-MM-dd');
						endDate = $.format.date(now, 'yyyy-MM-dd');
						break;
					}
					url += '?ids=' + mboxIds.join(',');
					if (startDate && endDate) {
						url += '&startDate=' + startDate + '&endDate=' + endDate;
					}
					url += '&receivedCount=' + $receivedCount.val();
					self.collection.url = url;
					self.collection.fetch();
				});
				var $toggleContacts = this.$el.find('.toggle-contacts');
				var $checkAll = this.$el.find('button.check-all');
				$checkAll.click(function(event) {
					if ($toggleContacts.is(':checked')) {
						$toggleContacts.removeProp('checked');
					} else {
						$toggleContacts.prop('checked', 'checked');
					}
					var checkboxSelector = 'tbody.contact-import-list input[type=checkbox]';
					var $contactsCheckboxes = self.$el.find(checkboxSelector);
					$contactsCheckboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($toggleContacts.is(':checked')) {
								$this.prop('checked', 'checked');
							} else {
								$this.removeProp('checked');
							}
						}
					});
				});
				$toggleContacts.change(function() {
					if (self.collection && self.collection.size() > 0) {
						var checkboxSelector = 'tbody.contact-import-list input[type=checkbox]';
						var $contactsCheckboxes = self.$el.find(checkboxSelector);
						if (this.checked) {
							$contactsCheckboxes.prop('checked', 'checked');
						} else {
							$contactsCheckboxes.removeProp('checked');
						}
					}
				});
				var $removeDuplicate = this.$el.find('button.remove-duplicate');
				$removeDuplicate.click(function(event) {
					if ($toggleContacts.is(':checked')) {
						$toggleContacts.removeProp('checked');
					}
					var checkboxSelector = 'tbody.contact-import-list input[type=checkbox]';
					var $contactsCheckboxes = self.$el.find(checkboxSelector);
					$contactsCheckboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($this.data('contact-dupliacted')) {
								$this.removeProp('checked');
							}
						}
					});
				});
				var $containsDuplicate = this.$el.find('button.contains-duplicate');
				$containsDuplicate.click(function(event) {
					var checkboxSelector = 'tbody.contact-import-list input[type=checkbox]';
					var $contactsCheckboxes = self.$el.find(checkboxSelector);
					$contactsCheckboxes.each(function() {
						var $this = $(this);
						if (!$this.attr('disabled')) {
							if ($this.data('contact-dupliacted')) {
								$this.prop('checked', 'checked');
							}
						}
					});
				});
				var $selectGroup = this.$el.find('select[name=groups]');
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.groupCollection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.groupCollection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				var options = [];
				options.push($('<option value="0"></option>').text(i18n.setUpGroup));
				for (var i = 0; i < groupModels.length; i++) {
					var level = self.getLevel(groupModels[i], self.groupCollection);
					var $option = $('<option></option>');
					$option.val(groupModels[i].get('GROUP_IDX'));
					var name = groupModels[i].get('GROUP_NM');
					for (var j = 0; j < level; j++) {
						name = '../' + name;
					}
					$option.text(name);
					options.push($option);
				}
				$selectGroup.append(options);
				var $groupname = this.$el.find('input.input-groupname');
				$selectGroup.change(function() {
					var groupId = $(this).val();
					if (groupId == 0) {
						$groupname.show();
					} else {
						$groupname.hide();
						$groupname.val('');
					}
				});
				var $save = this.$el.find('button.save-contacts');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $contactsCheckboxes = self.$el.find('tbody.contact-import-list input[type=checkbox]');
					if ($contactsCheckboxes && $contactsCheckboxes.length > 0) {
						var contactModels = [];
						var $rows = $contactsCheckboxes.filter(':checked').closest('tr');
						if (!$rows.length) {
							alert(i18n.pleaseSelectAddress);
							return false;
						} else {
							$rows.each(function() {
								var cid = $(this).data('cid');
								var contactModel = self.collection.get(cid);
								if (contactModel.get('ADDRESS_EMAIL')) {
									var expr = /^((\w|[\-\.])+)@((\w|[\-\.])+)\.([A-Za-z]+)$/;
									if (!expr.test(contactModel.get('ADDRESS_EMAIL'))) {
										alert(i18n.invalidEmail);
										return false;
									}
								}
								contactModels.push(contactModel);
							});
							if ($rows.length != contactModels.length)
								return false;
						}
						var groupId = $selectGroup.val();
						contact.overlayView.showProcessing();
						var groupname = $groupname.val();
						if (groupname) {
							var groupModel = self.groupCollection.getGroupModel("GROUP_NM", groupname);
							if (!groupModel) {
								self.groupCollection.create({
									GROUP_NM : groupname,
								}, {
									wait : true,
									async : false,
								});
								groupModel = self.groupCollection.getGroupModel("GROUP_NM", groupname);
							}
							groupId = groupModel.get('GROUP_IDX');
						}
						contactModels.each(function(contactModel) {
							contactModel.url = 'contacts/contact/0?_method=PUT';
							if (groupId != 0)
								contactModel.set('GROUP_IDX', groupId);
							contactModel.save(null, {
								wait : true,
							});
						});
						self.groupCollection.fetch();
						self.collection.reset();
						contact.overlayView.hideProcessing();
						alert(i18n.storeImported);
					}
				});
			},
			getLevel : function(model, groupCollection) {
				var level = 0;
				var parentId = model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
		}); // contact.ContactImportFromMailView

		contact.FileExportLayoutView = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var html = contact.$template.filter('#contact-fileexport-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				exportRegion : '.address_pd',
			},
			initialize : function(options) {
				// this.model == contact.groupModel
				// this.collection == contact.groupCollection
			},
			onRender : function() {
				this.exportRegion.show(new contact.FileExportView({
					model : this.model,
					collection : this.collection,
				}));
			},
		}); // contact.FileExportLayoutView

		contact.FileExportView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.FileExportView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-fileexport-list-template').html();
					compiledTemplate = _.template(html);
					contact.FileExportView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.groupModel
				// this.collection == contact.groupCollection
			},
			onRender : function() {
				$('div.mc-paginate').hide();
				var self = this;
				var $fileType = this.$el.find('input[name=fileType]');
				var $checkAll = this.$el.find('#item_all');
				var $groupCheckAll = this.$el.find('#exportGroupCheckAll');
				var $exportContactsFile = this.$el.find('button#exportContactsFile');
				var $exportGroupList = this.$el.find('ul.export-target-group-list');
				var $groupType = this.$el.find('input#groupType');
				var $individualContacts = this.$el.find('input#individualContacts');
				var groupCollection = this.collection;
				var selectAddressCollection = contact.selectedAddressCollection;

				if (groupCollection) {
					var groups = groupCollection.filter(function(groupModel) {
						var GROUP_TYPE = groupModel.get('GROUP_TYPE');
						return GROUP_TYPE != 'T' && GROUP_TYPE != 'I' && GROUP_TYPE != 'R' && GROUP_TYPE != 'A';
					});
					_.each(groups, function(group, index) {
						var id = 'li_' + index;
						var $input = $('<input>', {
							'class' : 'input_check',
							type : 'checkbox',
							name : 'li_check',
							id : id,
							value : group.get('GROUP_IDX'),
						});
						var groupName = group.get('GROUP_NM');
						var $label = $('<label>', {
							'for' : id,
							title : groupName,
							text : groupName,
						});
						var $li = $('<li></li>').append($input).append($label);
						$exportGroupList.append($li);
					});
				}
				if (selectAddressCollection) {
					var $selectedCount = this.$el.find('span.selected-export-contacts-count');
					var $groupCheckboxes = self.$el.find('.export-target-group-list input[type=checkbox]');
					var selectedAddressCount = selectAddressCollection.length;
					var countText = '(' + selectedAddressCount + i18n.exportContacts.piece + ')';
					$selectedCount.text(countText);
					if (selectedAddressCount > 0) {
						$individualContacts.prop('checked', true);
						$individualContacts.removeProp('disabled');
						$groupCheckAll.prop('disabled', 'disabled');
						$groupCheckboxes.prop('disabled', 'disabled');
					}
				}

				$checkAll.click(function() {
					var $checkboxes = self.$el.find('.export-target-columns input[type=checkbox]');
					var $this = $(this);
					if ($this.is(':checked')) {
						$checkboxes.each(function() {
							var $checkbox = $(this);
							if ($checkbox.val() !== 'name') {
								$checkbox.prop('checked', true);
							}
						});
					} else {
						$checkboxes.each(function() {
							var $checkbox = $(this);
							if ($checkbox.val() !== 'name') {
								$checkbox.removeProp('checked');
							}
						});
					}
				});

				$groupType.click(function() {
					var $checkboxes = self.$el.find('.export-target-group-list input[type=checkbox]');
					if ($groupCheckAll.prop('disabled')) {
						$groupCheckAll.removeProp('disabled');
						$checkboxes.removeProp('disabled');
					}
				});

				$individualContacts.click(function() {
					var $checkboxes = self.$el.find('.export-target-group-list input[type=checkbox]');
					if (!$groupCheckAll.prop('disabled')) {
						$groupCheckAll.prop('disabled', 'disabled');
						$checkboxes.removeProp('checked');
						$checkboxes.prop('disabled', 'disabled');
					}
				});

				$groupCheckAll.click(function() {
					var $el = self.$el;
					var $checkboxes = $el.find('.export-target-group-list input[type=checkbox]');
					if ($(this).is(':checked')) {
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeProp('checked');
					}
				});

				$exportContactsFile.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $el = self.$el;
					var exportType;
					$fileType.each(function() {
						if (this.checked) {
							exportType = $(this).val();
						}
					});
					var $colCheckboxes = $el.find('.export-target-columns input[type=checkbox]');
					var columnItems = [];
					$colCheckboxes.each(function() {
						var $this = $(this);
						if ($this.is(':checked')) {
							columnItems.push($this.val());
						}
					});
					var $groupCheckboxes = $el.find('.export-target-group-list input[type=checkbox]');
					var groupItems = [];
					$groupCheckboxes.each(function() {
						var $this = $(this);
						if ($this.is(':checked')) {
							groupItems.push($this.val());
						}
					});
					if ($groupType.is(':checked') && groupItems.length <= 0) {
						alert(i18n.exportContacts.pleaseSelectGroup);
						return;
					}
					var selectedContactItems = [];
					if ($individualContacts.is(':checked') && selectAddressCollection) {
						selectAddressCollection.forEach(function(model) {
							selectedContactItems.push(model.get('ADDRESS_IDX'));
						});
					}
					var params = '?columns=' + columnItems.join(',');
					if (groupItems.length > 0) {
						params += '&groupIds=' + groupItems.join(',');
					} else if (selectedContactItems.length > 0) {
						params += '&addressIds=' + selectedContactItems.join(',');
					}
					switch (exportType) {
					case 'csv':
						location.href = 'contacts/export/csv' + params;
						break;
					case 'xls':
						location.href = 'contacts/export/excel' + params;
						break;
					case 'vcard':
						location.href = 'contacts/export/vcard' + params;
						break;
					}
				});
			},
		}); // contact.ContactImportFromFileView

		contact.ExportMergeView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ExportMergeView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#export-layer-template').html();
					compiledTemplate = _.template(html);
					contact.ExportMergeView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.paginator = options.paginator;
			},
			onRender : function() {
				var self = this;
				var $contactsExport = this.$el.find('#contactsExport');
				var $contactsMerge = this.$el.find('#contactsMerge');
				$contactsExport.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.hide();
					location.hash = '#contacts/file-export';
				});
				$contactsMerge.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var selectAddressList = contact.selectedAddressCollection;
					if (selectAddressList.length <= 1) {
						alert(i18n.exportMerge.pleaseSelectMergeContacts);
						app.vent.trigger('hide:export-merge-views');
						return;
					}
					if (selectAddressList.length > 10) {
						alert(i18n.exportMerge.pleaseMergeCountCheck);
						app.vent.trigger('hide:export-merge-views');
						return;
					}
					self.collection.title = i18n.addAddress.mergeTitle;
					app.vent.trigger('contact:mergeView', self.collection);
					app.vent.trigger('hide:export-merge-views');
				});
			},
		}); // contact.ExportMergeView

		contact.SettingsLayoutView = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var html = contact.$template.filter('#contact-settings-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				settingsRegion : 'div.env_contentArea .address_pd',
			},
			initialize : function(options) {
				// this.model = contact.groupModel
				// this.collection = contact.groupCollection
				this.userModel = options.userModel;
				this.parmas = options.params ? options.params : 'general';
				this.listenTo(this.collection, 'sync', this.showGroupSettingsView);
			},
			onRender : function() {
				var self = this;
				if (this.parmas == 'group') {
					self.showGroupSettingsView();
				} else if (this.parmas == 'important') {
					// self.showImportantView();
				} else if (this.parmas == 'restore') {
					self.showRestoreContactView();
				} else {
					self.showGeneralSettingsView();
				}
				var $general = this.$el.find('ul.top_tab li#generalSeting a');
				var $group = this.$el.find('ul.top_tab li#groupManage a');
				var $important = this.$el.find('ul.top_tab li#importanceSetting a');
				var $restoreContact = this.$el.find('ul.top_tab li#restoreContact a');
				$general.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.showGeneralSettingsView();
				});
				$group.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.showGroupSettingsView();
				});
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.showImportantView();
				});
				$restoreContact.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.showRestoreContactView();
				});
			},
			showGeneralSettingsView : function() {
				var $clickBtn = this.$el.find('#generalSeting a');
				this.selectClass($clickBtn);
				this.settingsRegion.show(new contact.GeneralSettingsView({
					model : this.userModel,
					parentView : this,
				}));
			},
			showGroupSettingsView : function() {
				var self = this;
				var $clickBtn = this.$el.find('#groupManage a');
				this.selectClass($clickBtn);
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				this.settingsRegion.show(new contact.GroupSettingsView({
					collection : new contact.GroupCollection(groupModels),
					groupCollection : self.collection
				}));
			},
			showImportantView : function() {
				var $clickBtn = this.$el.find('#importanceSetting a');
				this.selectClass($clickBtn);
				this.settingsRegion.show(new contact.ImportantSettingsView({
					userModel : this.userModel,
				}));
			},
			showRestoreContactView : function() {
				var $clickBtn = this.$el.find('#restoremenu a');
				this.selectClass($clickBtn);
				this.settingsRegion.show(new contact.RestoreSettingsView({
					userModel : this.userModel,
				}));
			},
			selectClass : function($this) {
				var $parent = $this.parent();
				$parent.siblings().removeClass('select');
				$parent.addClass('select');
			},
		}); // contact.SettingsLayoutView

		contact.GeneralSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html = contact.$template.filter('#contact-general-settings-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
					user : contact.contactUserModel.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model = user.userModel
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				var $default = this.$el.find('.btn_c button.ab_l');
				var $save = this.$el.find('button.contact-general-settings-save');
				var $cancel = this.$el.find('.btn_c button.c');
				var $setHome = this.$el.find('.box_tbl input[name=setHome]');
				var $setSort = this.$el.find('.box_tbl input[name=listSort]');
				var $exposeCnt = this.$el.find('.box_tbl select[name=contact_list_num]');
				$default.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$setHome.filter('[value=ALL]').prop('checked', true);
					$setSort.filter('[value=ADDRESS_NAME]').prop('checked', true);
					$exposeCnt.val('20');
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var homeType = $setHome.filter(':checked').val();
					var sortType = $setSort.filter(':checked').val();
					var exposeCnt = $exposeCnt.val();
					self.model.save({
						HOME_TYPE : homeType,
						SORT_TYPE : sortType,
						EXPOSE_COUNT : exposeCnt,
					}, {
						patch : true,
						wait : true,
						success : function() {
							alert(i18n.settings.general.success);
						}
					});
				});
				$cancel.click(function() {
					self.parentView.showGeneralSettingsView();
				});
			},
		}); // contact.GeneralSettingsView

		contact.GroupSettingsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var $template = contact.$template;
				var html, compiledTemplate = contact.GroupSettingsItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = $template.filter('#contact-group-settings-item-template').html();
					compiledTemplate = _.template(html);
					contact.GroupSettingsItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					group : data,
					user : contact.contactUserModel.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model = contact.groupModel
				this.listenTo(this.model, 'change', this.render);
			},
			getLevel : function() {
				var level = 0;
				var parentId = this.model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = contact.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = contact.groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function() {
				var self = this;
				var level = this.getLevel();
				var $groupName = this.$el.find('span.group-name');
				var name = $groupName.text();
				for (var i = 0; i < level; i++) {
					name = '../' + name;
				}
				$groupName.text(name);
				self.$el.attr('id', this.model.get('GROUP_IDX')).attr('class', 'grp');
				self.$el.data('ref', this.model.get('REF_GROUP_IDX')).data('level', level);
				var $modify = this.$el.find('td.m_d div.inpd_div a.modifyBtn');
				var $delete = this.$el.find('td.m_d div.inpd_div a.deleteBtn');
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $item = $(this).parent().parent().parent();
					self.modify(self, $item);
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = i18n.settings.groupMng.checkDeleteGroup;
					if (confirm(msg)) {
						function traverseGroup(parentGroupModel) {
							var subGroupModels;
							if (parentGroupModel) {
								subGroupModels = contact.groupCollection.filter(function(groupModel) {
									return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
								});
								self.deleteGroup(parentGroupModel);
							}
							for (var i = 0; i < subGroupModels.length; i++) {
								traverseGroup(subGroupModels[i]);
							}
						}
						contact.overlayView.showProcessing();
						traverseGroup(self.model);
						contact.overlayView.hideProcessing();
					}
				});
			},
			deleteGroup : function(groupModel) {
				var orgUrl = groupModel.urlRoot;
				// 그룹+연락처 모두 삭제
				var url = orgUrl + '/' + groupModel.get('GROUP_IDX') + '/all';
				groupModel.destroy({
					url : url,
					wait : true,
					async : false,
				});
			},
			modify : function(self, $item) {
				var model = self.model;
				var $name = $('<input>', {
					type : 'text',
					name : 'groupName',
					value : model.get("GROUP_NM"),
				});
				var $desc = $('<input>', {
					type : 'text',
					name : 'groupDesc',
					value : model.get("GROUP_STMT"),
					css : {
						'width' : '250px',
					}
				});
				$item.find('.inpd_div_name').empty().append($name);
				$item.find('.inpd_div_stmt').empty().append($desc);
				var $save = $('<a>', {
					'href' : '#',
					'class' : 'saveBtn',
					text : i18n.settings.save,
				});
				var span = $('<span>', {
					'class' : 'hipen',
					html : '&nbsp;&nbsp;|&nbsp;&nbsp;',
				});
				var $cancel = $('<a>', {
					'href' : '#',
					'class' : 'cancelBtn',
					text : i18n.settings.cancel,
				});
				$item.find('td.m_d .inpd_div').empty().append($save).append(span).append($cancel);
				var $save = $item.find('.saveBtn');
				$save.on('click', function(event) {
					event.preventDefault() && event.stopPropagation();
					groupName = $item.find('input[name=groupName]').val();
					groupDesc = $item.find('input[name=groupDesc]').val();
					if (groupName.length > 25) {
						alert(i18n.settings.groupMng.groupNameLengthOverflow);
						return false;
					}
					if (groupDesc.length > 300) {
						alert(i18n.settings.groupMng.groupDescLengthOverflow);
						return false;
					}
					self.saveGroup(groupName, groupDesc, model);
				});
				var $cancel = $item.find('.cancelBtn');
				$cancel.on('click', function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});
			},
			saveGroup : function(groupName, groupDesc, model) {
				if ($.trim(groupName).length > 0) {
					var attrs = {};
					if (groupName != model.get('GROUP_NM'))
						attrs.GROUP_NM = groupName;
					if (groupDesc)
						attrs.GROUP_STMT = groupDesc;
					model.save(attrs, {
						patch : true,
						wait : true,
						async : true,
						success : function() {
							contact.groupCollection.fetch();
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 409:
								alert(i18n.alreadyGroup);
								break;
							}
						},
					});
				} else {
					if (groupName.length < 1) {
						alert(i18n.settings.groupMng.addGroupNameMessage);
					}
				}
			},
		}); // contact.groupSettingsItemView

		contact.GroupSettingsView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.GroupSettingsItemView,
			itemViewContainer : '.address_call_tbl tbody',
			template : function(data) {
				var html, compiledTemplate = contact.GroupSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#contact-group-settings-template').html();
					compiledTemplate = _.template(html);
					contact.GroupSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					user : contact.contactUserModel.toJSON(),
					groupCollection : contact.groupCollection,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = contact.groupCollection
				this.groupCollection = options.groupCollection
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $add = $el.find('div.group_inp button');
				var $selectAllBtn = $el.find('div.ft_btn .all');
				var $selectAllCheckbox = $el.find('.address_call_tbl thead .check .input_check');
				var $checkboxes = $el.find('.address_call_tbl tbody .check .input_check');
				var $delete = $el.find('div.ft_btn button.delete');
				var $top = $el.find('.mv_top');
				var $up = $el.find('.mv_up');
				var $down = $el.find('.mv_dw');
				var $bottom = $el.find('.mv_btm');
				var $save = $el.find('div.btn_c .b');
				var $cancel = $el.find('div.btn_c .c');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $element = self.$el.find('.address_call_tbl').find('tr.grp');
					var groups = [];
					$element.each(function(index) {
						var $this = $(this);
						var groupId = $this.attr('id');
						var sortNo = $element.length + 1 - index;
						groups.push({
							GROUP_IDX : groupId,
							GROUP_SORT_NO : sortNo
						});
					});
					var groupModel = new contact.GroupModel({});
					groupModel.url = 'groups/order';
					groupModel.save({
						groups : groups,
					}, {
						patch : true,
						wait : true,
						async : false,
						success : function() {
							self.groupCollection.fetch();
							alert(i18n.settings.groupMng.success);
						},
					});
				});
				$cancel.click(function() {
					self.render();
				});
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var groupName = self.$el.find('#groupNameInput').val();
					var groupDesc = self.$el.find('#groupDescInput').val();
					if (groupName.length > 25) {
						alert(i18n.settings.groupMng.groupNameLengthOverflow);
						self.$el.find('#groupNameInput').focus();
						self.$el.find('#groupNameInput').select();
						return false;
					}
					if (groupDesc.length > 25) {
						alert(i18n.settings.groupMng.groupDescLengthOverflow);
						self.$el.find('#groupDescInput').focus();
						self.$el.find('#groupDescInput').select();
						return false;
					}
					self.addGroup(groupName, groupDesc);
				});
				$selectAllBtn.click(function(event) {
					event.stopPropagation();
					var $this = $(this);
					if ($this.is('.group-selectAll')) {
						$this.removeClass('group-selectAll');
						$checkboxes.prop('checked', false);
						$selectAllCheckbox.prop('checked', false);
					} else {
						$this.addClass('group-selectAll');
						$checkboxes.prop('checked', true);
						$selectAllCheckbox.prop('checked', true);
					}
				});
				$selectAllCheckbox.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						$checkboxes.prop('checked', true);
						if (!$selectAllBtn.is('.group-selectAll')) {
							$selectAllBtn.addClass('group-selectAll');
						}
					} else {
						$checkboxes.removeAttr('checked');
						if ($selectAllBtn.is('.group-selectAll')) {
							$selectAllBtn.removeClass('group-selectAll');
						}
					}
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length) {
							$selectAllCheckbox.prop('checked', true);
						}
					} else {
						$selectAllCheckbox.removeAttr('checked');
					}
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = i18n.settings.groupMng.checkDeleteGroup;
					if (!confirm(msg)) {
						return false;
					}
					self.deleteGroup($checkboxes);
				});
				$top.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('.address_call_tbl tbody .check .input_check');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					self.rowMove(self, $checkboxes, 'top');
				});
				$up.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('.address_call_tbl tbody .check .input_check');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					self.rowMove(self, $checkboxes, 'up');
				});
				$down.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('.address_call_tbl tbody .check .input_check');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					self.rowMove(self, $checkboxes, 'down');
				});
				$bottom.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('.address_call_tbl tbody .check .input_check');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					self.rowMove(self, $checkboxes, 'bottom');
				});
			},
			rowMove : function(self, $checkboxes, option) {
				var chkGroupidx = self.getGroupIdx($checkboxes);
				var element = self.$el.find('#' + chkGroupidx);
				var prevEl = element.prev('tr');
				var nextEl = element.next('tr');
				while (nextEl.html() && element.data('level') < nextEl.data('level')) {
					element = element.add(nextEl);
					nextEl = nextEl.next('tr');
				}
				if (option == 'up') {
					while (prevEl.html() && element.data('level') < prevEl.data('level')) {
						prevEl = prevEl.prev('tr');
					}
					if (element.data('level') > prevEl.data('level')) {
						alert(i18n.subgroupOutOfTheParentGroup);
						return false;
					}
					element.insertBefore(prevEl);
				} else if (option == 'down') {
					var el = nextEl;
					while (nextEl.next('tr').html() && el.data('level') < nextEl.next('tr').data('level')) {
						nextEl = nextEl.next('tr');
					}
					if (element.data('level') > nextEl.data('level')) {
						alert(i18n.subgroupOutOfTheParentGroup);
						return false;
					}
					element.insertAfter(nextEl);
				} else if (option == 'top') {
					if (element.data('level') != 0) {
						alert(i18n.subgroupOutOfTheParentGroup);
						return false;
					}
					var rows = element.parent().find('tr');
					element.insertBefore(rows[0]);
				} else if (option == 'bottom') {
					if (element.data('level') != 0) {
						alert(i18n.subgroupOutOfTheParentGroup);
						return false;
					}
					var rows = element.parent().find('tr');
					element.insertAfter(rows[rows.length - 1]);
				}
			},
			chkboxCheck : function($checkboxes) {
				var checkCnt = 0;
				$checkboxes.each(function() {
					if (!this.checked) {
						return;
					}
					checkCnt++;
				});
				if (checkCnt > 1) {
					alert(i18n.settings.groupMng.selectOnlyOneGroup);
					return true;
				}
				return false;
			},
			getGroupIdx : function($checkboxes) {
				var chkGroupidx = 0;
				$checkboxes.each(function() {
					if (!this.checked) {
						return;
					}
					chkGroupidx = this.value;
				});
				return chkGroupidx;
			},
			addGroup : function(groupName, groupDesc) {
				var self = this;
				if ($.trim(groupName).length > 0) {
					var existGroup = self.collection.filter(function(groupModel) {
						return groupModel.get('GROUP_NM') === groupName;
					});
					if (existGroup.length > 0) {
						var existGroupMsg = groupName + i18n.addAddressGroup.existsMessage;
						alert(existGroupMsg);
						self.render();
						return;
					}
					if (groupName == i18n.myContact) {
						alert(i18n.alreadyDefaultGroup);
						return false;
					}
					self.collection.create({
						GROUP_NM : groupName,
						GROUP_STMT : groupDesc
					}, {
						wait : true,
						success : function() {
							contact.groupCollection.fetch();
						},
					});
				} else {
					if (groupName.length < 1) {
						alert(i18n.settings.groupMng.addGroupNameMessage);
					}
				}
			},
			deleteGroup : function($checkboxes) {
				var self = this;
				var deleteCnt = 0;
				$checkboxes.each(function() {
					if (!this.checked)
						return;
					var chkGroupidx = this.value;
					var models = self.collection.filter(function(groupModel) {
						if (groupModel.get('GROUP_IDX') == chkGroupidx)
							return true;
					});
					_.each(models, function(model) {
						model.destroy({
							wait : true,
							async : false
						});
						deleteCnt++;
					});
				});
				return deleteCnt;
			},
			appendHtml : function(collectionView, itemView, index) {
				collectionView.$el.find('.address_call_tbl tbody').append(itemView.el);
			},
		}); // contact.GroupSettingsView

		contact.ImportantSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html = contact.$template.filter('#contact-important-settings-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
					user : contact.contactUserModel.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.listenTo(this.userModel, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $default = this.$el.find('.btn_c button.ab_l');
				var $save = this.$el.find('.btn_c button.b');
				var $cancel = this.$el.find('.btn_c button.c');
				var $impAutoEmail = this.$el.find('#auto_type1');
				var $impAutoEmailCnt = this.$el.find('div.auto_div select[name=impAutoEmailCnt]');
				$default.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var userModel = new contact.ContactUserModel();
					var impEmailChk = self.userModel.get('IMPORTANT_EMAIL_AUTO') == 'N' ? false : true;
					var impEmailCnt = self.userModel.get('IMPORTANT_EMAIL_AUTO_CNT');
					$impAutoEmail.prop('checked', impEmailChk);
					$impAutoEmailCnt.val(impEmailCnt);
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var impEmailChk = $impAutoEmail.is(':checked') ? 'Y' : 'N';
					var impEmailCnt = $impAutoEmailCnt.val();
					if (impEmailChk == 'N') {
						impEmailCnt = new contact.ContactUserModel().get('IMPORTANT_EMAIL_AUTO_CNT');
						$impAutoEmailCnt.val(impEmailCnt);
					}
					self.update(impEmailChk, impEmailCnt);
				});
				$cancel.click(function(evnet) {
					self.render();
				});
			},
			update : function(impEmailChk, impEmailCnt) {
				this.userModel.save({
					IMPORTANT_EMAIL_AUTO : impEmailChk,
					IMPORTANT_EMAIL_AUTO_CNT : impEmailCnt,
				}, {
					patch : true,
					wait : true,
				});
			},
		}); // contact.ImportantSettingsView

		contact.RestoreSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html = contact.$template.filter('#contact-restore-settings-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
					user : contact.contactUserModel.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
			},
			onRender : function() {
				//
			},
		}); // contact.RestoreSettingsView

		contact.SharedGroupItemView = Backbone.Marionette.CompositeView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = contact.SharedGroupItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-group-item-template').html();
					compiledTemplate = _.template(html);
					contact.SharedGroupItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					sharedGroup : data,
					i18n : i18n,
				});
				return html;
			},
			itemViewOptions : function(model, index) {
				return {
					shareGroupView : this.shareGroupView,
					parentView : this,
				}
			},
			initialize : function(options) {
				this.collection = this.model.groups;
				this.shareGroupView = options.shareGroupView;
				this.parentView = options.parentView;
			},
			getLevel : function() {
				var level = 1;
				var $parentList = this.parentView.$el.find('ul:first');
				if ($parentList.attr('class') && $parentList.attr('class').indexOf('depth') != -1) {
					var parentLevel = $parentList.attr('class').slice($parentList.attr('class').length - 1)
					level = Number(parentLevel) + 1;
				}
				return level;
			},
			onRender : function(event) {
				var self = this;
				var groupModel = this.model;
				var level = this.getLevel();
				var $list = this.$el.find('ul:first');
				var $toggle = this.$el.find('button.btn_folder:first');
				this.applyClassToItems();
				var $link = this.$el.find('span.set_onp a.ma:first');
				$link.click(function(event) {
					var $item = self.$el.find('span.ml_t:first')
					self.applyClassToItems($item);
				});
				$toggle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($list.is(':visible')) {
						self.$el.removeClass('spread_folder').addClass('fold_folder');
						$list.hide();
					} else {
						self.$el.removeClass('fold_folder').addClass('spread_folder');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								$list.show();
							});
						} else {
							$list.show();
						}
					}
					return false;
				});
				$list.addClass('depth' + level);
				this.$el.addClass('fold_folder');
				var $more = this.$el.find('#editDisplay');
				$more.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('contextmenu:share-group', event, self.model, self);
					return false;
				});
				var $row = this.$el.find('.ml_t');
				$row.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('contextmenu:share-group', event, self.model, self);
					return false;
				});
			},
			appendHtml : function(collectionView, itemView) {
				collectionView.$('ul:first').append(itemView.el);
			},
			applyClassToItems : function($item) {
				var $items = this.shareGroupView.$el.find('li span.ml_t');
				this.$el.find('span.ml_t:first')
				$items.removeClass('choice');
				if ($item) {
					$item.addClass('choice');
				} else {
					$item = this.$el.find('span.ml_t:first')
					var $link = this.$el.find('span.set_onp a.ma:first');
					var hash = location.hash;
					var href = $link.attr('href');
					if (hash == href)
						$item.addClass('choice');
				}
			},
		}); // contact.SharedGroupItemView

		contact.SharedGroupView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.SharedGroupItemView,
			itemViewContainer : 'ul',
			itemViewOptions : function(model, index) {
				return {
					shareGroupView : this,
					parentView : this,
				}
			},
			template : function(data) {
				var html, compiledTemplate = contact.SharedGroupView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-group-template').html();
					compiledTemplate = _.template(html);
					contact.SharedGroupView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.sharedGroupCollection = options.sharedGroupCollection
			},
			onRender : function() {
				var self = this;
				var $item = this.$el.find('h3.menu_tadd');
				$item.click(function(event) {
					var $items = self.$el.find('li span.ml_t');
					$items.removeClass('choice');
				});
			},
			appendHtml : function(collectionView, itemView) {
				var visible = itemView.model.get('GROUP_VISIBLE');
				if (visible)
					collectionView.$('ul:first').append(itemView.el);
			},
		}); // contact.SharedContactView

		contact.SharedGroupContextMenuView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'share-group-contextmenu',
			className : 'layer_bd layer_mouseright',
			attributes : {
				style : 'display: none; z-index: 2015;',
			},
			template : function(data) {
				var html, compiledTemplate = contact.SharedGroupContextMenuView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-group-contextmenu-template').html();
					compiledTemplate = _.template(html);
					contact.SharedGroupContextMenuView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(app.vent, 'contextmenu:share-group', this.showContextMenu);
			},
			onRender : function() {
				var self = this;
				var $contextMenu = $('body > #share-group-contextmenu');
				if ($contextMenu.length)
					$contextMenu.remove();
				$contextMenu = this.$el.appendTo('body');
				$contextMenu.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$contextMenu.attr('hidable', true);
				$contextMenu.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($contextMenu.outerHeight() > (viewportY - event.pageY)) {
					$contextMenu.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$contextMenu.css('top', event.pageY + 'px');
				}
				if ($contextMenu.outerWidth() > (viewportX - event.pageX)) {
					$contextMenu.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$contextMenu.css('left', event.pageX + 'px');
				}
				var $composeSms = this.$el.find('li.shared-compose-sms');
				var $composeMail = this.$el.find('li.shared-compose-mail');
				var $addContacts = this.$el.find('li.shared-add-contact-group');
				var $hideGroup = this.$el.find('li.shared-hide-group');
				var groupModel = this.model;
				$composeSms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.hide();
					alert('문자 보내기 준비중...');
				});
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var sharerId = groupModel.get('USERS_IDX');
					sharerId = sharerId.substring(0, sharerId.indexOf('@'));
					var params = {
						to : [],
					};
					params.to.push('!' + groupModel.get('GROUP_NM') + '@' + sharerId);
					location.hash = "compose?" + decodeURIComponent($.param(params, true));
					self.$el.hide();
				});
				$addContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.hide();
					var GROUP_NM = self.model.get('GROUP_NM');
					GROUP_NM = $.trim(GROUP_NM);
					var alreadyGroup = contact.groupCollection.find(function(model) {
						return $.trim(model.get('GROUP_NM')) == GROUP_NM;
					});
					if (alreadyGroup) {
						alert(i18n.alreadyGroup);
						return false;
					}
					var jqXHR = self.createAddressGroup(GROUP_NM);
					jqXHR.done(function() {
						alert(i18n.shareGroup.addContacts.successGroup);
					});
				});
				$hideGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var depth = self.groupItemView.$el.find('ul:first').attr('class');
					var level = depth ? depth.substring(5) : 1;
					if (level != 1) {
						alert(i18n.shareGroup.subgroupCanNotHidden);
						return false;
					}
					if (confirm(groupModel.get('GROUP_NM') + i18n.shareGroup.hideGroupFromList)) {
						self.hideAddressGroup();
					}
					self.$el.hide();
				});
			},
			createAddressGroup : function(groupName) {
				var groupModel = new contact.SharedGroupModel();
				var jqXHR = groupModel.save({
					GROUP_NM : groupName,
				}, {
					wait : true,
					async : false,
					url : 'shared-groups/' + this.model.get('GROUP_IDX'),
				});
				return jqXHR;
			},
			hideAddressGroup : function() {
				var configModel = new contact.ShareConfigModel();
				configModel.save({
					GROUP_IDX : this.model.get('GROUP_IDX'),
					GROUP_VISIBLE : 0,
				}, {
					patch : true,
					wait : true,
					async : false,
					url : 'shared-groups/config/visible',
				});
				contact.shareConfigCollection.fetch();
				app.vent.trigger('show:shared-group-view');
				location.hash = '#shared-groups/all/contacts';
			},
			showContextMenu : function(mouseEvent, groupModel, groupItemView) {
				this.mouseEvent = mouseEvent;
				this.model = groupModel;
				this.groupItemView = groupItemView;
				this.render().$el.show();
			}
		}); // contact.SharedGroupMenuView

		contact.SharedContentHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.SharedContentHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-content-header-template').html();
					compiledTemplate = _.template(html);
					contact.SharedContentHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					paginator : contact.sharedPaginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = contact.SharedGroupModel
				// this.collection = contact.SharedPaginator
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'change:shared-group', this.replaceGroupModel);
			},
			replaceGroupModel : function(groupModel, params) {
				this.stopListening(this.model);
				this.model = groupModel;
				if (this.model.get('GROUP_IDX') == 0) {
					this.model.set({
						contactsCount : contact.sharedGroupCollection.length
					});
				}
				this.listenTo(this.model, 'change', this.render);
				this.render();
			},
			onRender : function() {
				var self = this;
				var $searchInput = this.$el.find('.mc-search');
				var $searchBtn = this.$el.find('.mc-search_btn');

				$searchInput.keydown(function(event) {
					if (event.which == 13) {
						var keyword = $(this).val();
						if (keyword) {
							self.search(keyword);
						}
					}
				});

				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var keyword = $searchInput.val();
					if (keyword) {
						self.search(keyword);
					}
				});
			},
			search : function(term) {
				if (term && (term.indexOf('%') != -1 || term.indexOf('_') != -1)) {
					alert(i18n.search.invalidToken);
					return;
				}
				var hash = '#shared-groups/all/contacts?search=' + encodeURIComponent(encodeURIComponent(term));
				location.hash = hash;
				// });
			},
		}); // contact.SharedContentHeaderView

		contact.SharedContentToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.SharedContentToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-contact-toolbar-template').html();
					compiledTemplate = _.template(html);
					contact.SharedContentToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {

			},
			onRender : function() {
				var self = this;
				var $selectAllBtn = this.$el.find('div.mc-buttonSet button.btn_selectAll');
				var $addToContact = this.$el.find('div.mc-buttonSet button.btn_addToContact');
				var $composeMail = this.$el.find('div.mc-buttonSet button.org_mail_btn');
				$selectAllBtn.click(function(event) {
					event.stopPropagation();
					var $checkboxes = $('div.list_area .check .inp_ch');
					var $selectAllCheckbox = $('#checkListAll');
					var $this = $(this);
					if ($this.is('.toolbar-selectAll')) {
						$this.removeClass('toolbar-selectAll');
						$checkboxes.prop('checked', false);
						$selectAllCheckbox.prop('checked', false);
						self.collection.forEach(function(model) {
							contact.selectedAddressCollection.remove(model);
						});
					} else {
						$this.addClass('toolbar-selectAll');
						$checkboxes.prop('checked', true);
						$selectAllCheckbox.prop('checked', true);
						self.collection.forEach(function(model) {
							contact.selectedAddressCollection.add(model);
						});
					}
				});
				$addToContact.click(function(event) {
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#orgManagementLayer');
					// $layer.css({
					// position : 'absolute',
					// top : top,
					// left : left
					// });
					$layer.attr('hidable', false);
					var $checkboxes = $('div.list_area .check .inp_ch').filter(':checked');
					if ($checkboxes.length < 1) {
						alert(i18n.shareGroup.chooseAddressAddContact);
						return;
					}
					var sharedAddContactView = new contact.SharedAddContactView({
						userModel : this.userModel,
						collection : contact.groupCollection,
					});
					sharedAddContactView.render();
					$('#orgManagementLayer').html(sharedAddContactView.el);
					$layer.toggle();
				});
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (contact.selectedAddressCollection.length < 1) {
						alert(i18n.shareGroup.pleaseSelectContact);
						return;
					}
					var models = contact.selectedAddressCollection.filter(function(model) {
						return model.get('ADDRESS_EMAIL');
					});
					var params = {
						to : [],
					};
					for (var i = 0; i < models.length; i++) {
						var alias = models[i].get('ADDRESS_NAME');
						var email = models[i].get('ADDRESS_EMAIL');
						if (email) {
							var param = '';
							if (alias) {
								param += '"' + alias + '"';
								param += '<' + email + '>';
							} else {
								param += email;
							}
							params.to.push(param);
						}
					}
					location.hash = "compose?" + decodeURIComponent($.param(params, true));
				});
			},
		}); // contact.SharedContentToolbarView

		contact.SharedAddContactView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.SharedAddContactView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-add-contact-template').html();
					compiledTemplate = _.template(html);
					contact.SharedAddContactView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					user : contact.contactUserModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = contact.groupCollection
				this.listenTo(this.collection, 'add', this.render);
			},
			onRender : function() {
				var self = this;
				this.renderGroupItems();
				var $selGroup = this.$el.find('div.add_layertbl li');
				var $addContactBtn = this.$el.find('div.add_layer_btn .add');
				$selGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					$this.siblings().removeClass('selected');
					$this.addClass('selected');
				});
				$addContactBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var groupIdx = $('.shared_ad .mailBoxList').find('li.selected input').val();
					var contacts = contact.selectedAddressCollection;
					contacts.forEach(function(contact) {
						contact.set('SHARE_ADDRESS_IDX', contact.get('ADDRESS_IDX'));
						contact.set('ADDRESS_IDX', 0);
						contact.set('GROUP_IDX', groupIdx);
						contact.set('sharerIdx', contact.get('USERS_IDX'));
						contact.urlRoot = 'shared-groups/';
						contact.save({}, {
							wait : true,
							async : false,
						});
					});
					alert(contacts.length + i18n.shareGroup.addContacts.success);
					contacts.reset();
				});
			},
			renderGroupItems : function() {
				var self = this;
				var $groupList = this.$el.find('div.shared_ad .mailBoxList');
				$groupList.empty();
				var groupModels = [];
				function traverseGroup(parentGroupModel) {
					var subGroupModels;
					if (parentGroupModel) {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('REF_GROUP_IDX') == parentGroupModel.get('GROUP_IDX');
						});
						groupModels.push(parentGroupModel);
					} else {
						subGroupModels = self.collection.filter(function(groupModel) {
							return groupModel.get('GROUP_TYPE') == 'U' && groupModel.get('REF_GROUP_IDX') == 0;
						});
					}
					for (var i = 0; i < subGroupModels.length; i++) {
						traverseGroup(subGroupModels[i]);
					}
				}
				traverseGroup();
				for (var i = 0; i < groupModels.length; i++) {
					var groupItemView = new contact.SharedAddContactItemView({
						model : groupModels[i],
						groupCollection : self.collection,
					});
					$groupList.append(groupItemView.render().el);
				}
				var $addArea = this.$el.find('div.add_area');
				var addAreaView = new contact.SharedAddContactNewGroupView({
					collection : this.collection
				});
				$addArea.append(addAreaView.render().el);
			},
		}); // contact.SharedAddContactView

		contact.SharedAddContactItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, selfView = contact.SharedAddContactItemView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-add-contact-item-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.GroupModel
				this.groupCollection = options.groupCollection;
			},
			getLevel : function() {
				var level = 0;
				var parentId = this.model.get('REF_GROUP_IDX');
				if (parentId === 0) {
					return level;
				}
				var parentGroupModel = this.groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_IDX') === parentId;
				});
				while (parentGroupModel) {
					level++;
					parentId = parentGroupModel.get('REF_GROUP_IDX');
					if (parentId === 0)
						break;
					parentGroupModel = this.groupCollection.find(function(groupModel) {
						return groupModel.get('GROUP_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var level = this.getLevel();
				var $groupName = this.$el.find('label.group-name');
				var name = $groupName.text();
				for (var i = 0; i < level; i++) {
					name = '../' + name;
				}
				$groupName.text(name);
			}
		}); // contact.SharedAddContactItemView

		contact.SharedAddContactNewGroupView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, selfView = contact.SharedAddContactNewGroupView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = contact.$template;
					html = $template.filter('#shared-add-contact-add-area-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var self = this;
				var $addrGroupAdd = self.$el.find('.addrGroup_add');
				$addrGroupAdd.click(function() {
					self.addGroup();
				});
			},
			addGroup : function() {
				var grpNm = this.$el.find('#newGroupAdd').val();
				var groupModel = new contact.GroupModel();
				if ($.trim(grpNm)) {
					groupModel.save({
						GROUP_NM : grpNm,
					}, {
						success : function() {
							contact.groupCollection.fetch();
							app.vent.trigger('add:contactgroup', contact.groupCollection);
						}
					});
				}
			}
		}); // contact.SharedAddContactNewGroupView

		contact.SharedGroupAddContactView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, selfView = contact.SharedGroupAddContactView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#org-group-add-contact-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $addBtn = self.$el.find('div.add_layer_btn .add');
				$addBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var item = $('div.list_area .check .inp_ch').filter(':checked');
					if (item && item[0]) {
						var grpIdx = $(item[0]).parent().find('.listSubGrpIdx').val();
						var orgEntryModel = new app.org.OrgEntryModel();
						var domain = app.userModel.get('DOMAIN');
						var tmpUrl = 'org/' + domain + '/groups/' + grpIdx;
						orgEntryModel.fetch({
							url : tmpUrl,
							async : false,
						});
						var attributes = orgEntryModel.get('attributes');
						if (attributes) {
							var orgGroupNm = attributes.cn[0];
							var addrGroup = contact.groupCollection.filter(function(groupModel) {
								return groupModel.get('GROUP_NM') === orgGroupNm;
							});
							if (addrGroup.length > 0) {
								var msg = orgGroupNm + i18n.addAddressGroup.existsMessage;
								alert(msg);
								return;
							}
							self.createAddressGroup(orgGroupNm);

							var addrGroupIdx = addrGroup[0].attributes.GROUP_IDX;
							self.addToContact(attributes, addrGroupIdx);
						}
					}
					app.vent.trigger('paginate:org-entries', this.model);
				});

			},
			createAddressGroup : function(groupNm) {
				var groupModel = new contact.GroupModel();
				groupModel.save({
					GROUP_NM : groupNm,
				}, {
					wait : true,
					async : false,
					success : function() {
						contact.groupCollection.fetch({
							async : false
						});
					}
				});
			},
			addToContact : function(attributes, addrGroupIdx) {
				var addressModel = new contact.AddressModel();
				var orgEntryModels = attributes.member;
				_.each(orgEntryModels, function(model) {
					var member = model.attributes;
					addressModel.save({
						USERS_IDX : contact.contactUserModel.get('USERS_IDX'),
						ADDRESS_NAME : member.cn[0],
						ADDRESS_EMAIL : member.mail[0],
						ADDRESS_CELLTEL : member.mobile[0],
						ADDRESS_TEL : member.homePhone[0],
						GROUP_IDX : addrGroupIdx,
					}, {
						wait : true,
						async : false,
					});
				});
			}
		}); // contact.SharedGroupAddContactView

		contact.SharedContentFilterToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, $selfView = contact.SharedContentFilterToolbarView;
				var compiledTemplate = $selfView.compiledTemplate
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-contact-filter-toolbar-template').html();
					compiledTemplate = _.template(html);
					$selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(app.vent, 'change:shared-group', this.replaceGroupModel);
			},
			onRender : function() {
				var self = this;
				var $category = this.$el.find('.view_box li:first');
				var $exposure = this.$el.find('.view_box li:eq(1)');
				var $searchKey = this.$el.find('.word_box li');
				var $item = this.$el.find('ul.word_box li span');
				var keyIndex;
				if (location.hash) {
					var link = document.createElement("a");
					link.href = location.hash.substring(location.hash.indexOf('#') + 1);
					if (link.search.indexOf('keyIndex') == 1) {
						keyIndex = link.search.split('=')[1];
						keyIndex = decodeURIComponent(decodeURIComponent(keyIndex));
					}
				}
				$item.each(function() {
					if (keyIndex === 'all') {
						keyIndex = i18n.all;
					} else if (keyIndex === 'other') {
						keyIndex = i18n.other;
					} else if (keyIndex === 'noname') {
						keyIndex = i18n.noname;
					}
					if ($(this).text() === keyIndex) {
						self.selectItem($(this).parent());
					}
				});
				$category.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $header = $('.mc-content_header');
					var $categoryLayer = $('contactTypeFilterLayer');
					var left, top, $target = $(this);

					top = $header.height() + $target.position().top + $target.height();
					left = $target.position().left;

					$categoryLayer.css({
						top : top,
						left : left,
					});
				});

				$searchKey.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.selectItem($(this).children('a:first'));
					var hash;
					var GROUP_IDX = self.model.get('GROUP_IDX');
					var keyIndex = $(this).find('span').text();
					if (keyIndex === i18n.all) {
						keyIndex = 'all';
					} else if (keyIndex === i18n.other) {
						keyIndex = 'other';
					} else if (keyIndex === i18n.noname) {
						keyIndex = 'noname';
					}
					keyIndex = encodeURIComponent(encodeURIComponent(keyIndex));
					if (GROUP_IDX == 0) {
						hash = '#shared-groups/all/contacts?keyIndex=' + keyIndex;
					} else {
						hash = '#shared-groups/' + self.model.get('GROUP_IDX') + '/contacts?keyIndex=' + keyIndex;
					}
					location.hash = hash;
				});

				$exposure.click(function(event) {
					event.preventDefault() && event.stopPropagation();

				});
			},
			selectItem : function($this) {
				var $parent = $this.parent();
				$parent.siblings().removeClass('clk');
				$parent.addClass('clk');
			},
			replaceGroupModel : function(groupModel) {
				this.model = groupModel;
			},
		}); // contact.SharedContentFilterToolbarView

		contact.SharedContactItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = contact.SharedContactItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-contact-item-template').html();
					compiledTemplate = _.template(html);
					contact.SharedContactItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					groupCollection : contact.sharedGroupCollection,
					user : contact.contactUserModel.toJSON(),
					params : contact.params,
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var important = this.model.get('ADDRESS_IMPORTANT');
				var $important = this.$el.find('.star a');
				var $checkbox = this.$el.find('td.check input.inp_ch');
				var $td = this.$el.find('td');
				var $name = this.$el.find('td.name a');
				var $viewWrapper = $('#contactMan');
				var $view = $('#customerView');
				var $modifyView = $('#addressModify');
				var $modify = this.$el.find('.modify a');

				if (important == 'Y') {
					$important.addClass('on');
				} else {
					$important.removeClass('on');
				}
				$checkbox.change(function(event) {
					event.stopPropagation();
					var $elem = $(self.el)
					if ($(this).is(':checked')) {
						$elem.addClass('focus');
						contact.selectedAddressCollection.add(self.model);
					} else {
						$elem.removeClass('focus');
						contact.selectedAddressCollection.remove(self.model);
					}
				});
				$checkbox.click(function(event) {
					event.stopPropagation();
				});
				$td.click(function(event) {
					if ($checkbox.is(':checked')) {
						$checkbox.prop('checked', false);
					} else {
						$checkbox.prop('checked', true);
					}
					$checkbox.change();
				});
				$name.click(function(event) {
					event.preventDefault()
					event.stopPropagation();

					var detailView = new contact.ContactDetailView({
						model : self.model,
						isGroupShared : 'Y',
					})
					detailView.render();
					$view.html(detailView.el);

					$viewWrapper.css('zIndex', '32001');
					$viewWrapper.show();
					$view.show();
					contact.overlayView.showOverlay();
				});
				$important.click(function(event) {
					event.preventDefault()
					event.stopPropagation();
					var important = self.model.get('ADDRESS_IMPORTANT');
					if (important == 'Y') {
						important = 'N';
					} else {
						important = 'Y';
					}
					var url = 'shared-groups/' + self.model.get('GROUP_IDX') + '/contacts/'
							+ self.model.get('ADDRESS_IDX');
					self.model.save({
						important : important
					}, {
						url : url,
						patch : true,
						wait : true,
						success : function() {
							contact.sharedPaginator.pager();
						},
					});
				});
			},
		}); // contact.SharedContactItemView

		contact.SharedContactListView = Backbone.Marionette.CompositeView.extend({
			// parentEl : 'div.list_view',
			itemView : contact.SharedContactItemView,
			itemViewContainer : 'div.list_area div.scroll_zoom tbody',
			template : function(data) {
				var html, compiledTemplate = contact.SharedContactListView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-contact-list-template').html();
					compiledTemplate = _.template(html);
					contact.SharedContactListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : contact.contactUserModel.toJSON(),
					paginator : contact.sharedPaginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'paginate:shared-contacts', this.paginateContacts);
				this.listenTo(contact.selectedAddressCollection, 'reset', this.resetCheckboxes);
				this.listenTo(contact.selectedAddressCollection, 'remove', this.unchecked);
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $toggle = $el.find('#checkListAll');
				var $checkboxes = $el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				var $selectAll = $('div#addressBtn_fol div div.mc-buttonSet button:eq(0)');
				var $headerColgroup = $el.find('#listHead [data-expose=none]');
				var $listColgroup = $el.find('#defaultArea [data-expose=none]');

				this.switchListViewOptions($headerColgroup, $listColgroup);

				var checked = 0;
				$checkboxes.each(function(index, checkbox) {
					var $this = $(checkbox);
					contact.selectedAddressCollection.each(function(addressModel) {
						var contactId = addressModel.get('ADDRESS_IDX');
						if ($this.val() == contactId) {
							$this.attr('checked', true).trigger('change');
							checked++;
						}
					});
				});
				if (checked > 0 && checked == $checkboxes.length) {
					$toggle.attr('checked', true);
				}
				$toggle.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
					$checkboxes.change();
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length)
							$toggle.prop('checked', true);
					} else {
						$toggle.removeAttr('checked');
					}
				});
				this.renderPagination();
				var $headColumnCol = this.$el.find('table#listHead colgroup col');
				this.changeColName($headColumnCol);
				var $subColumnCol = this.$el.find('div.list_area colgroup col');
				this.changeColName($subColumnCol);
			},
			changeColName : function($columnCol) {
				$columnCol.each(function(index, element) {
					if (index != 0 && index != 1 && index != $columnCol.length - 1)
						$(element).attr('class', 'col_auto');
				});
			},
			switchListViewOptions : function($headerColgroup, $listColgroup) {
				var user = this.userModel.toJSON();
				var key, count = 0;
				for (key in user) {
					if (user[key] == 1) {
						count++;
					}
				}
				if (count == 4) {
					var flags = user.PHONE_FLAG && user.EMAIL_FLAG && user.COMPANY_FLAG && user.GROUP_FLAG;
					if (!(flags)) {
						$headerColgroup.removeClass();
						$listColgroup.removeClass();
					}
				} else {
					$headerColgroup.removeClass();
					$listColgroup.removeClass();
				}
			},
			renderPagination : function() {
				var pagination = new contact.SharedContactPaginationView({
					collection : this.collection
				});
				pagination.render();
				var $pagination = $('.mc-paginate');
				$pagination.empty().append($(pagination.el).html());
			},
			resetCheckboxes : function() {
				var $el = this.$el;
				var $checkboxes = $el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.removeAttr('checked').trigger('change');
			},
			unchecked : function(addressModel) {
				var $el = this.$el;
				var contactId = addressModel.get('ADDRESS_IDX');
				var $checkboxes = $el.find('div.list_area div.scroll_zoom td.check input.inp_ch');
				$checkboxes.each(function(index, checkbox) {
					if ($(checkbox).val() == contactId) {
						$(checkbox).removeProp('checked').trigger('change');
					}
				});
			},
			paginateContacts : function(groupModel, params) {
				if (groupModel) {
					this.model = groupModel;
				}
				this.collection.setGroupModel(groupModel);
				contact.overlayView.showLoading();
				if (!params)
					params = {};
				this.collection.setParams(params);
				this.collection.server_api._method = 'GET';
				this.collection.pager();
				contact.overlayView.hideLoading();
			},
		}); // contact.SharedContactListView

		contact.SharedContactPaginationView = Backbone.View.extend({
			parentEl : '.mc-paginate',
			render : function() {
				var html, selfView = contact.SharedContactPaginationView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-contact-pagination-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : this.collection,
					i18n : i18n,
				});
				this.$el.html(html);
				return this;
			},
		}); // contact.SharedContactPaginationView

		contact.SharedGroupCategoryFilterView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, selfView = contact.SharedGroupCategoryFilterView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-contact-category-filter-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.find('ul li');
				$items.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $item = $(event.target, this);
					var className = $item.attr('class');
					var categoryType = className.slice(className.indexOf('-') + 1);
					var GROUP_IDX = contact.sharedGroupModel.get('GROUP_IDX');
					var url = 'shared-groups/' + GROUP_IDX + '/category/' + categoryType;
					self.collection.pager({
						url : url
					});
				});
			},
		}); // contact.SharedGroupCategoryFilterView

		contact.SharedGroupSettingsLayout = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var html = contact.$template.filter('#shared-group-settings-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				headerRegion : '.mc-content_header',
				contentRegion : '#share_group',
			},
			initialize : function(options) {
				this.sharedGroupCollection = options.sharedGroupCollection;
			},
			onRender : function() {
				var self = this;
				this.headerRegion.show(new contact.SharedGroupSettingsHeaderView({}));
				this.contentRegion.show(new contact.SharedGroupSettingsView({
					collection : this.sharedGroupCollection,
					configCollection : this.collection,
				}));
			},
		}); // contact.SharedGroupSettingsLayout

		contact.SharedGroupSettingsHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, $selfView = contact.SharedGroupSettingsHeaderView;
				var compiledTemplate = $selfView.compiledTemplate
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-group-settings-header-template').html();
					compiledTemplate = _.template(html);
					$selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
			},
		}); // contact.SharedGroupSettingsHeaderView

		contact.SharedGroupSettingsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var $template = contact.$template;
				var html, selfView = contact.SharedGroupSettingsItemView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = $template.filter('#shared-group-settings-item-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					group : data,
					configCollection : contact.shareConfigCollection,
					user : contact.contactUserModel.toJSON(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model = contact.sharedGroupModel
				this.configCollection = contact.shareConfigCollection;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.configCollection, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $hide = this.$el.find('.inpd_div a');
				this.$el.attr('id', this.model.get('GROUP_IDX')).attr('class', 'grp');

				$hide.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var GROUP_IDX = self.model.get('GROUP_IDX');
					self.configCollection.forEach(function(model) {
						var GROUP_VISIBLE = model.get('GROUP_VISIBLE') === 0 ? 1 : 0;
						if (model.get('GROUP_IDX') == GROUP_IDX)
							model.set('GROUP_VISIBLE', GROUP_VISIBLE);
					});
				});
			},
		}); // contact.SharedGroupSettingsItemView

		contact.SharedGroupSettingsView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.SharedGroupSettingsItemView,
			itemViewContainer : '.address_call_tbl tbody',
			template : function(data) {
				var html, $selfView = contact.SharedGroupSettingsView;
				var compiledTemplate = $selfView.compiledTemplate
				if (!compiledTemplate) {
					html = contact.$template.filter('#shared-group-settings-content-template').html();
					compiledTemplate = _.template(html);
					$selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = contact.sharedGroupCollection;
				this.configCollection = options.configCollection;
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $selectAll = this.$el.find('button.shared-group-settiings-selectAll');
				var $hide = this.$el.find('button.shared-group-settiings-hide');
				var $unhide = this.$el.find('button.shared-group-settiings-unhide');
				var $topCheckbox = this.$el.find('.address_call_tbl .top_checkbox');
				var $moveTop = this.$el.find('div.ico_btn button.mv_top');
				var $moveUp = this.$el.find('button.mv_up');
				var $moveDown = this.$el.find('div.ico_btn button.mv_dw');
				var $moveBottom = this.$el.find('div.ico_btn button.mv_btm');
				var $checkboxes = this.$el.find('tbody input[type=checkbox]');
				var $save = this.$el.find('button.share-group-settings-save');
				var $cancel = this.$el.find('button.share-group-settings-cancel');
				var cloneConfigCollection = new contact.ShareConfigCollection(this.configCollection.toJSON());

				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $element = self.$el.find('.address_call_tbl').find('tr.grp');
					var groups = [];
					for (var i = 0; i < $element.length; i++) {
						var model = self.configCollection.getConfigModel('GROUP_IDX', $element[i].id);
						var sortNo = $element.length + 1 - $element[i].rowIndex;
						var group = {
							GROUP_IDX : $element[i].id,
							GROUP_SORT_NO : sortNo
						}
						groups.push(group);

						var clone = cloneConfigCollection.getConfigModel('GROUP_IDX', model.get('GROUP_IDX'));
						if (model.get('GROUP_VISIBLE') != clone.get('GROUP_VISIBLE'))
							self.saveGroupVisible(model.get('GROUP_IDX'), model.get('GROUP_VISIBLE'));
					}
					model.save({
						groups : groups,
					}, {
						patch : true,
						wait : true,
						async : false,
						url : 'shared-groups/config/sort',
						success : function() {
							// self.collection.fetch();
							self.configCollection.fetch();
							app.vent.trigger('show:shared-group-view');
						},
					});

				});

				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.collection.fetch();
					self.configCollection.fetch();
					return false;
				});

				$selectAll.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $checkboxes = self.$el.find('tbody input[type=checkbox]');
					if ($this.is('.shared-group-selectAll')) {
						$this.removeClass('shared-group-selectAll');
						$checkboxes.prop('checked', false);
						$topCheckbox.prop('checked', false);
					} else {
						$this.addClass('shared-group-selectAll');
						$checkboxes.prop('checked', true);
						$topCheckbox.prop('checked', true);
					}
				});

				$topCheckbox.change(function(event) {
					event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]');
					if (this.checked) {
						$checkboxes.prop('checked', true);
						if (!$selectAll.is('.shared-group-selectAll')) {
							$selectAll.addClass('shared-group-selectAll');
						}
					} else {
						$checkboxes.removeProp('checked');
						if ($selectAll.is('.shared-group-selectAll')) {
							$selectAll.removeClass('shared-group-selectAll');
						}
					}
				});

				$checkboxes.change(function() {
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length) {
							$topCheckbox.prop('checked', true);
						}
					} else {
						$topCheckbox.removeAttr('checked');
					}
				});

				$hide.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]').filter(':checked');
					self.changeGroupVisible($checkboxes, 0);
				});

				$unhide.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]').filter(':checked');
					self.changeGroupVisible($checkboxes, 1);
				});

				$moveTop.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					var chkGroupidx = self.getGroupIdx($checkboxes);
					var $element = self.$el.find('#' + chkGroupidx);
					var $rows = $element.parent().find('tr');
					$element.insertBefore($rows[0]);
				});

				$moveUp.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					self.rowMove(self, $checkboxes, "up");
				});

				$moveDown.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					self.rowMove(self, $checkboxes, "down");
				});

				$moveBottom.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.$el.find('tbody input[type=checkbox]');
					if (self.chkboxCheck($checkboxes)) {
						return;
					}
					var chkGroupidx = self.getGroupIdx($checkboxes);
					var $element = self.$el.find('#' + chkGroupidx);
					var $rows = $element.parent().find('tr');
					$element.insertAfter($rows[$rows.length - 1]);
				});
			},
			rowMove : function(self, $checkboxes, option) {
				var chkGroupidx = self.getGroupIdx($checkboxes);
				var $element = self.$el.find('#' + chkGroupidx);
				if (option == "up") {
					if ($element.prev().html() && $element.prev().attr("class") != "f") {
						$element.insertBefore($element.prev());
					}
				} else {
					if ($element.next().html()) {
						$element.insertAfter($element.next());
					}
				}
			},
			chkboxCheck : function($checkboxes) {
				var checkCnt = 0;
				$checkboxes.each(function() {
					if (!this.checked) {
						return;
					}
					checkCnt++;
				});
				if (checkCnt > 1) {
					alert(i18n.shareGroup.settings.pleaseSelectOneGroup);
					return true;
				}
				return false;
			},
			getGroupIdx : function($checkboxes) {
				var chkGroupidx = 0;
				$checkboxes.each(function() {
					if (!this.checked) {
						return;
					}
					chkGroupidx = this.value;
				});
				return chkGroupidx;
			},
			changeGroupVisible : function($checkboxes, GROUP_VISIBLE) {
				var self = this;
				if ($checkboxes.length === 0) {
					alert(i18n.shareGroup.settings.pleaseSelectOneGroup);
					return;
				}
				$checkboxes.each(function() {
					var GROUP_IDX = $(this).val();
					self.configCollection.forEach(function(model) {
						if (model.get('GROUP_IDX') == GROUP_IDX)
							model.set('GROUP_VISIBLE', GROUP_VISIBLE);
					});

				});
			},
			saveGroupVisible : function(GROUP_IDX, GROUP_VISIBLE) {
				var configModel = new contact.ShareConfigModel();
				configModel.save({
					GROUP_IDX : GROUP_IDX,
					GROUP_VISIBLE : GROUP_VISIBLE,
				}, {
					patch : true,
					wait : true,
					async : false,
					url : 'shared-groups/config/visible',
				});
			},
		}); // contact.SharedGroupSettingsView

		contact.ShareSettingsLayout = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var $template = contact.$template;
				var html = $template.filter('#share-settings-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				headerRegion : '#shareGroupHeader',
				orgTreeRegion : '#groupOrgTreeWrapping',
				orgUserSearchRegion : '#shareGroupUserSearch',
				orgUserListRegion : '#shareGroupUserList',
				orgRecipientsRegion : '#share_people',
				footerRegion : '#shareGroupFooter',
				paginationRegion : '.page_ctrl',
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.groupModel = options.groupModel;
				this.listenTo(app.vent, 'paginate:shared-org-entries', this.showOrgUserListView);
				this.listenTo(app.vent, 'fetch:shared-recipients', this.showOrgRecipientsView);
				this.listenTo(this, 'update:shared-recipients-count', this.updateRecipientsCount);
			},
			onRender : function() {
				var self = this;
				this.headerRegion.show(new contact.ShareSettingsHeaderView({
					model : this.groupModel,
				}));
				var orgRootEntryModel = new app.org.OrgEntryModel({
					id : 'root'
				});
				orgRootEntryModel.fetch();
				this.showOrgTreeView(orgRootEntryModel);

				this.orgUserSearchRegion.show(new contact.ShareOrgUserSearchView({
					model : orgRootEntryModel,
					parentView : this,
				}));

				this.footerRegion.show(new contact.ShareSettingsFooterView({
					model : this.groupModel,
					parentView : this,
				}));
				// Buttons: append [->] | remove [<-]
				var $append = this.$el.find('.btn_add');
				var $remove = this.$el.find('.btn_remove');
				var $checkAll = this.$el.find('#all_check');
				$append.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trigger('append:recipients');
					$checkAll.removeProp('checked');
				});
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trigger('remove:recipients');
				});
				$checkAll.click(function(event) {
					var checked = $(this).is(':checked');
					self.trigger('check:share-group-org-list', checked);
				});
				this.stopHidableEvent();
			},
			showOrgTreeView : function(orgRootEntryModel) {
				var self = this;
				this.listenTo(orgRootEntryModel, 'change', function() {
					var attributes = orgRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.org.OrgEntryCollection(member);
					self.orgTreeRegion.show(new contact.ShareOrgTreeRootView({
						model : orgRootEntryModel,
						collection : collection,
						parentView : self,
					}));
					app.vent.trigger('paginate:shared-org-entries');
				});
			},
			showOrgUserListView : function(params) {
				var self = this;
				var paginator = new app.org.OrgEntryPaginator();
				if (params && params.url) {
					paginator.paginator_core.url = params.url;
					delete params.url;
				}
				var url = 'org/root/entries';
				if (!params) {
					params = {};
					paginator.paginator_core.url = url;
				}
				params._method = 'GET';
				paginator.setParams(params);
				paginator.fetch({
					success : function(collection, response, options) {
						collection.pager();
						var shareOrgListView = new contact.ShareOrgUserListView({
							model : self.model, // app.userModel
							collection : paginator,
							parentView : self,
						});
						self.orgUserListRegion.show(shareOrgListView);
						// Pagination
						var paginationView = new contact.ShareSettingsPaginationView({
							collection : paginator,
						});
						self.paginationRegion.show(paginationView);
					},
					silent : true,
				});
			},
			showOrgRecipientsView : function(groupModel) {
				var self = this;
				var url = 'shared-groups/' + groupModel.get('GROUP_IDX') + '/recipients';
				contact.shareCollection.fetch({
					url : url,
				});
				this.listenTo(contact.shareCollection, 'sync', function() {
					self.orgRecipientsRegion.show(new contact.ShareRecipientsView({
						collection : contact.shareCollection,
						parentView : self,
					}));
				});
			},
			stopHidableEvent : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			updateRecipientsCount : function(recipientsCount) {
				this.$el.find('.share-group-recipients-count').text(recipientsCount);
			}
		}); // contact.ShareSettingsLayout

		contact.ShareSettingsHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var $template = contact.$template;
				var html = $template.filter('#share-settings-header-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var $close = this.$el.find('a#txt_pop_close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('hide:share-settings-layout');
				});
			},
		}); // contact.ShareSettingsHeaderView

		contact.ShareSettingsPaginationView = Backbone.Marionette.ItemView.extend({
			initialize : function(options) {
				// this.collection == org.OrgEntryPaginator
				this.collection.on('reset', this.render, this);
			},
			render : function() {
				var html, selfView = contact.ShareSettingsPaginationView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = contact.$template;
					html = $template.filter('#share-settings-pagination-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				this.$el.html(html);
				var $firstPage = this.$el.find('a.btn_first');
				$firstPage.click($.proxy(this.gotoFirst, this));
				var $prevPage = this.$el.find('a.btn_prev');
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = this.$el.find('a.btn_next');
				$nextPage.click($.proxy(this.gotoNext, this));
				var $lastPage = this.$el.find('a.btn_last');
				$lastPage.click($.proxy(this.gotoLast, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.previousPage();
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.nextPage();
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.stopPropagation();
				if (event.which == 13) {
					event.preventDefault();
					var page = $(event.target).val();
					if (this.collection.totalPages >= page) {
						this.collection.goTo(page);
					}
				}
			},
		}); // contact.ShareSettingsPaginationView

		contact.ShareOrgTreeEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, compiledTemplate = contact.ShareOrgTreeEntryView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#share-org-entry-template').html();
					compiledTemplate = _.template(html);
					contact.ShareOrgTreeEntryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = $el.children('.orgNode');
				var $checkbox = $el.children('input:checkbox');
				var $label = $el.children('label:first');
				var $list = $el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = _.result(self.model, 'url') + '/entries';
					var params = {
						url : url
					};
					app.vent.trigger('paginate:shared-org-entries', params);
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email
						this.$el.data('id', this.model.get('id')); // user_group_idx
					}
				}
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'group')) {
					$list.append($item);
				}
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					}
				});
			}
		}); // contact.ShareOrgTreeEntryView

		contact.ShareOrgTreeRootView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ShareOrgTreeRootView.compiledTemplate;
				if (!compiledTemplate) {
					html = contact.$template.filter('#share-org-root-template').html();
					compiledTemplate = _.template(html);
					contact.ShareOrgTreeRootView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			itemView : contact.ShareOrgTreeEntryView,
			itemViewContainer : "ul#shareOrgContainer:first",
			initialize : function(options) {
				this.parentView = options.parentView; // contact.ShareLayout
				this.listenTo(this.parentView, 'append:recipients', this.appendRecipients);
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					}
				});
				var topParentNode = this.$el.find('#topParentNode');
				topParentNode.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var checked = $(this).is(':checked');
					var url = _.result(self.model, 'url') + '/entries';
					var params = {
						url : url,
					};
					app.vent.trigger('paginate:shared-org-entries', params);
				});
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'group')) {
					$list.append($item);
				}
			},
			appendRecipients : function() {
				var $checkboxes = this.$el.find('input[type="checkbox"]:checked');
				var recipients = [];
				$checkboxes.each(function(index, element) {
					var $checkbox = $(element);
					var $item = $checkbox.parent();
					var share = {
						type : $item.data('oc'),
						personal : $item.data('cn'),
						address : $item.data('mail'),
						id : $item.data('id'),
					};
					recipients.push(share);
				});
				$checkboxes.prop('checked', false);
				this.parentView.trigger('add:recipients', recipients);
			},
		}); // contact.ShareOrgTreeRootView

		contact.ShareOrgUserView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, $template = contact.$template;
				html = $template.filter('#share-org-user-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var attributes = this.model.get('attributes');
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email
						this.$el.data('id', this.model.get('id')); // idx
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common
						// name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email
						// address
						this.$el.data('mail', attributes.mail[0]);
					this.$el.data('id', this.model.get('id')); // idx
				}
			}
		}); // contact.ShareOrgUserView

		contact.ShareOrgUserListView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.ShareOrgUserView,
			itemViewContainer : 'ul',
			template : function(data) {
				var html;
				var selfView = contact.ShareOrgUserListView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = contact.$template;
					html = $template.filter('#share-org-user-list-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.parentView = options.parentView; // contact.ShareLayout
				this.listenTo(this.parentView, 'append:recipients', this.appendRecipients);
				this.listenTo(this.parentView, 'remove:recipients', this.removeRecipients);
				this.listenTo(this.parentView, 'check:share-group-org-list', this.checkChildList);
			},
			onRender : function() {
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				$list.append($item);
			},
			appendRecipients : function() {
				var self = this;
				var $checkboxes = this.$el.find('input[type="checkbox"]:checked');
				var recipients = [];
				$checkboxes.each(function(index, element) {
					var $checkbox = $(element);
					var $item = $checkbox.parent();
					var share = {
						type : $item.data('oc'),
						personal : $item.data('cn'),
						address : $item.data('mail'),
						id : $item.data('id'),
					};
					if ($item.data('mail') == self.model.get('USERS_IDX')) {
						alert(i18n.shareGroup.shareOnSelfIsNotPossible);
						return;
					}
					recipients.push(share);
				});
				$checkboxes.prop('checked', false);
				this.parentView.trigger('add:recipients', recipients);
			},
			removeRecipients : function() {
				this.parentView.trigger('remove:recipient');
			},
			checkChildList : function(checked) {
				var $checkboxes = this.$el.find('input[type="checkbox"]');
				$checkboxes.each(function() {
					if (checked) {
						$(this).prop('checked', checked);
					} else {
						$(this).removeProp('checked');
					}
				});
			}
		}); // contact.ShareOrgUserListView

		contact.ShareOrgUserSearchView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = contact.ShareOrgUserSearchView.compiledTemplate;
				var $template = contact.$template;
				if (!compiledTemplate) {
					html = $template.filter('#share-settings-search-template').html();
					compiledTemplate = _.template(html);
					contact.ShareOrgUserSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $searchInput = this.$el.find('input[type=text]');
				var $searchBtn = this.$el.find('button[type=submit]');
				$searchInput.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						self.filterOrgUsers($(this).val());
					}
				});
				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.filterOrgUsers($searchInput.val());
				});
			},
			filterOrgUsers : function(keyword) {
				if (keyword && (keyword.indexOf('%') != -1 || keyword.indexOf('_') != -1)) {
					alert(i18n.search.invalidToken);
					return;
				}
				app.vent.trigger('paginate:shared-org-entries	', {
					search : encodeURIComponent(keyword),
				});
			},
		}); // contact.ShareOrgUserSearchView

		contact.ShareRecipientsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, $template = contact.$template;
				html = $template.filter('#share-settings-user-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				this.initData();
			},
			initData : function() {
				var type = this.model.get('type');
				var USER_GROUP_IDX = this.model.get('USER_GROUP_IDX') || this.model.get('id');
				if (!type && (!USER_GROUP_IDX || USER_GROUP_IDX == 0)) {
					type = 'user';
				} else if (!type && (USER_GROUP_IDX && USER_GROUP_IDX != 0)) {
					type = 'group';
				}
				this.$el.data('SHARE_EMAIL', this.model.get('SHARE_EMAIL'));
				this.$el.data('USER_GROUP_IDX', USER_GROUP_IDX);
				this.$el.data('type', type);
				this.$el.data('SHARE_NAME', this.model.get('SHARE_NAME'));
			},
		}); // contact.ShareRecipientsItemView

		contact.ShareRecipientsView = Backbone.Marionette.CompositeView.extend({
			itemView : contact.ShareRecipientsItemView,
			itemViewContainer : 'ul',
			template : function(data) {
				var html;
				var selfView = contact.ShareRecipientsView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = contact.$template;
					html = $template.filter('#share-settings-user-list-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.parentView = options.parentView; // contact.ShareLayout
				this.listenTo(this.parentView, 'add:recipients', this.addRecipients);
				this.listenTo(this.parentView, 'remove:recipient', this.removeRecipients);
			},
			onRender : function() {
				this.parentView.trigger('update:shared-recipients-count', this.$el.find('li').length);
			},
			addRecipients : function(recipients) {
				var self = this, $el = this.$el, $lastItem;
				var $itemViewContainer = this.$el.children('ul:first');
				$.each(recipients, function(index, share) {
					var isDuplicate = self.checkDuplicate(share);
					if (isDuplicate)
						return;
					var model = new Backbone.Model({
						type : share.type,
						SHARE_NAME : share.personal,
						SHARE_EMAIL : share.address,
						id : share.id,
					});
					var recipientsItemView = new contact.ShareRecipientsItemView({
						model : model,
						parentView : self,
					});
					$itemViewContainer.append(recipientsItemView.render().el);
				});
				this.parentView.trigger('update:shared-recipients-count', this.$el.find('li').length);
			},
			removeRecipients : function() {
				var $checkbox = this.$el.find('.share-recipient-item');
				$checkbox.filter(':checked').parent('li').remove();
				this.parentView.trigger('update:shared-recipients-count', this.$el.find('li').length);
			},
			checkDuplicate : function(share) {
				var $item = this.$el.find('li label');
				var isDuplicate = false;
				$item.each(function() {
					var addr = $(this).text();
					var id;
					if (addr.charAt(0) == '$') {
						id = share.address;
					} else {
						if (share.personal) {
							id = '"' + share.personal + '"' + '<' + share.address + '>';
						} else {
							id = '<' + share.address + '>';
						}
					}
					if (addr && $.trim(addr) == $.trim(id)) {
						isDuplicate = true;
						return false;
					}
				});
				return isDuplicate;
			}
		}); // contact.ShareRecipientsView

		contact.ShareSettingsFooterView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var $template = contact.$template;
				var html = $template.filter('#share-settings-footer-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.groupModel
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				var $save = this.$el.find('button.share-user-group-save');
				var $cancel = this.$el.find('button.share-user-group-cancel');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.shareSettings.shareYourCurrentGroup)) {
						self.updateShareGroup();
					}
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('hide:share-settings-layout');
				});
			},
			updateShareGroup : function() {
				var self = this;
				var model = new contact.ShareModel({});
				// 해당 그룹에 대한 기존 공유자 삭제 후 추가
				model.destroy({
					wait : true,
					async : false,
					url : 'shared-groups/' + this.model.get('GROUP_IDX') + '/recipients',
				}).done(function(response) {
					self.createShareGroupRecipients();
				});
			},
			createShareGroupRecipients : function() {
				var self = this;
				var $recipients = $('div#share_people li');
				var GROUP_IDX = this.model.get('GROUP_IDX');
				$recipients.each(function(index, element) {
					var $item = $(element);
					var type = $item.data('type');
					var param = {};
					if (type == 'group') {
						var groupId = $item.data('USER_GROUP_IDX') || $item.data('id');
						if (/^org-group-/.test(groupId))
							groupId = groupId.substring(10);
						param.USER_GROUP_IDX = groupId;
					} else if (type == 'user') {
						param.SHARE_EMAIL = $item.data('SHARE_EMAIL');
					}
					param.SHARE_NAME = $item.data('SHARE_NAME');
					param.GROUP_IDX = GROUP_IDX;
					param.SHARE_TYPE = type;
					var model = new contact.ShareModel();
					model.save(param, {
						url : 'shared-groups/recipients',
						wait : true,
						async : false,
					});
				});
				contact.groupCollection.fetch();
				app.vent.trigger('hide:share-settings-layout');
			}
		}); // contact.ShareSettingsFooterView

		contact.OverlayView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			attributes : {
				style : 'display: none;',
			},
			template : function(data) {
				var html;
				var compiledTemplate = contact.OverlayView.compiledTemplate;
				if (!compiledTemplate) {
					var templateId = '#contact-overlay-template';
					html = contact.$template.filter(templateId).html();
					compiledTemplate = _.template(html);
					contact.OverlayView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == No Model
			},
			onRender : function() {
				var self = this;
				this.$overlay = this.$el.children('#contacts-overlay');
				this.$loadingLayer = this.$overlay.children('.contacts-loading-layer');
				this.$processingLayer = this.$overlay.children('.contacts-processing-layer');
				this.$overlay.on('mousedown', function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				this.$viewport = $(window);
				this.$viewport.resize(function(event) {
					var viewportWidth = self.$viewport.width() / 2;
					var viewportHeight = self.$viewport.height() / 2;
					var width = self.$loadingLayer.width() / 2;
					var height = self.$loadingLayer.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					self.$loadingLayer.css({
						'top' : top,
						'left' : left,
					});
					width = self.$processingLayer.width() / 2;
					height = self.$processingLayer.height() / 2;
					top = Math.floor(viewportHeight - height);
					left = Math.floor(viewportWidth - width);
					self.$processingLayer.css({
						'top' : top,
						'left' : left,
					});
				});
				this.$viewport.resize();
				this.$loadingLayer.hide();
				this.$processingLayer.hide();
				this.$overlay.hide();
				this.$overlay.appendTo('body');
			},
			onClose : function() {
				this.$overlay.remove();
			},
			showOverlay : function() {
				this.$viewport.trigger('resize');
				this.$overlay.show();
			},
			hideOverlay : function() {
				this.$overlay.fadeOut();
			},
			showLoading : function() {
				this.showOverlay();
				this.$loadingLayer.show();
			},
			hideLoading : function() {
				this.$loadingLayer.fadeOut();
				this.hideOverlay();
			},
			showProcessing : function() {
				this.showOverlay();
				this.$processingLayer.show();
			},
			hideProcessing : function() {
				this.$processingLayer.hide();
				this.hideOverlay();
			},
		});

	}); // app.module('contact', function(contact, app, ...) {...})
});\#      c[c[E6MccU   y    O^partitionKey=%28http%2Cseoultech.ac.kr%29,:http://mail.seoultech.ac.kr/mail/app/contact/contact-views.js?v=202301181454 necko:classified 1 strongly-framed 1 request-method GET response-head HTTP/1.1 200 
Accept-Ranges: bytes
ETag: W/"327773-1664418070000"
Last-Modified: Thu, 29 Sep 2022 02:21:10 GMT
Content-Type: application/javascript;charset=UTF-8
Content-Length: 327773
Date: Wed, 01 Feb 2023 07:57:14 GMT
 original-response-headers Accept-Ranges: bytes
ETag: W/"327773-1664418070000"
Last-Modified: Thu, 29 Sep 2022 02:21:10 GMT
Content-Type: application/javascript;charset=UTF-8
Content-Length: 327773
Date: Wed, 01 Feb 2023 07:57:14 GMT
 ctid 2 uncompressed-len 0 net-response-time-onstart 34 net-response-time-onstop 56   ]