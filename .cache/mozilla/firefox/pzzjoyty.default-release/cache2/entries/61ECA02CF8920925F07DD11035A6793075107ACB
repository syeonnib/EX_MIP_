define([ 'app', 'text!app/settings/settings-template.html', 'i18n!app/settings/nls/settings-i18n',
		'app/settings/settings-models', 'app/user/user-models', 'app/mail/mail-models', 'app/mail/mail-views',
		'marionette' ], function(app, tmpl, i18n) {

	app.module('settings', function(settings, app, Backbone, Marionette, $, _) {

		settings.$template = $(tmpl);

		function isPopup() {
			try {
				if (window.opener && window.opener.location.pathname != window.location.pathname)
					return true;
				if (/.*\/popup\/.*/.test(window.location.pathname))
					return true;
				else
					return false;
			} catch (error) {
				if (/.*\/popup\/.*/.test(window.location.pathname))
					return true;
				else
					return false;
			}
		}

		settings.ContentLayout = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'content_fix',
			template : function(data) {
				var html = settings.$template.filter('#content-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					config : app.config,
					user : data,
					domain : app.domainModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			regions : {
				headerRegion : 'div.mc-content_header.sub:first',
				navigationRegion : 'div.mc-actionArea.top_tab:first',
				contentRegion : 'div.settings-contents:first',
				internalUserSettingsRegion : '#share_this',
				shareMboxSettingsRegion : 'div.settings-share-mbox',
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.mboxCollection = options.mboxCollection;
				this.searchMboxCollection = options.searchMboxCollection;
				this.labelCollection = options.labelCollection;
				this.filterCollection = options.filterCollection;
				this.listenTo(this, 'show:mbox-share-settings', this.showMboxShareSettingsView);
				this.listenTo(this, 'hide:share-settings-layout', this.hideShareSettingsView);
				this.listenTo(this, 'show:security-settings', this.showSecuritySettingsView);
				this.listenTo(this, 'show:add-internal-user', this.showAddInternalUserView);
				this.listenTo(this, 'change:vacation-menu', this.changeVacationTabMenu);
				this.listenTo(app.vent, 'show:signature-settings', this.showSignatureSettingsView);
				if (!settings.overlayView) {
					settings.overlayView = new settings.OverlayView();
					settings.overlayView.render();
				}
			},
			onRender : function() {
				var $navigations = this.$el.find(this.navigationRegion.el).find('table.top_tab td');
				this.$links = $navigations.children('a');
				this.$links.click(function(event) {
					event.stopPropagation();
					$navigations.removeClass('select');
					$(this).parent().addClass('select');
				});
			},
			onShow : function() {
				var $parent = this.$el.parent('div.content_cst');
				$parent.removeClass().addClass('content_cst');
			},
			showGeneralSettingsView : function(subPart) {
				this.$links.filter('a[href="#settings/general"]').click();
				this.contentRegion.show(new settings.GeneralSettingsView({
					model : this.model, // app.userModel
					mboxCollection : this.mboxCollection,
					subPart : subPart,
				}));
			},
			showSecuritySettingsView : function(subPart) {
				this.$links.filter('a[href="#settings/security"]').click();
				var otpModel = new app.settings.OtpModel();
				otpModel.set('USERS_IDX', this.model.get('USERS_IDX'));
				otpModel.fetch({
					async : false,
				});
				this.contentRegion.show(new settings.SecuritySettingsView({
					userModel : this.model, // app.userModel
					otpModel : otpModel,
					parentView : this,
					subPart : subPart,
				}));
			},
			showMboxesSettingsTabView : function(part) {
				this.$links.filter('a[href="#settings/mboxes"]').click();
				this.contentRegion.show(new settings.MboxesSettingsTabView({
					mboxCollection : this.mboxCollection,
					searchMboxCollection : this.searchMboxCollection,
					labelCollection : this.labelCollection,
					userModel : app.userModel,
					parentView : this,
					part : part,
				}));
			},
			showCleanUpSettingsView : function() {
				this.$links.filter('a[href="#settings/clean-up"]').click();
				this.contentRegion.show(new settings.CleanUpSettingsView({
					model : this.model, // app.userModel
				}));
			},
			showFiltersSettingsView : function() {
				settings.overlayView.showLoading();
				var filterCollection = new app.mail.AutoDivisionCollection();
				filterCollection.fetch({
					async : false,
				});
				this.mboxCollection.fetch({
					async : false,
				});
				settings.overlayView.hideLoading();
				this.$links.filter('a[href="#settings/filters"]').click();
				this.contentRegion.show(new settings.FiltersSettingsView({
					collection : filterCollection,
					mboxCollection : this.mboxCollection,
					userModel : this.model, // app.userModel,
					parentView : this,
				}));
			},
			showSignatureSettingsView : function() {
				this.$links.filter('a[href="#settings/signature"]').click();
				var signatureCollection = new app.mail.SignatureCollection();
				signatureCollection.fetch({
					async : false,
					wait : true,
				});
				this.contentRegion.show(new settings.SignatureSettingsView({
					collection : signatureCollection,
				}));
			},
			showRecipientGroupSettingsView : function() {
				this.$links.filter('a[href="#settings/recipient-group"]').click();
				var recipientGroupCollection = new app.contact.RecipientGroupCollection();
				recipientGroupCollection.fetch();
				this.contentRegion.show(new settings.RecipientGroupSettingsView({
					model : recipientGroupCollection,
					collection : recipientGroupCollection,
				}));
			},
			showVacationResponseSettingsView : function() {
				this.$links.filter('a[href="#settings/vacation-response"]').click();
				var model = new Backbone.Model();
				model.set('userModel', this.model);// app.userModel
				if (app.config.approvalMail.enabled) {
					var approverCollection = new (app.BackboneCollection.extend({
						url : 'approval/approvers',
					}))();
					approverCollection.fetch({
						async : false,
					});
					model.set('approverCollection', approverCollection);
				}
				this.contentRegion.show(new settings.VacationSettingsView({
					model : model,
					parentView : this,
				}));
			},
			showSpamSettingsView : function() {
				this.$links.filter('a[href="#settings/spam"]').click();
				this.contentRegion.show(new settings.SpamSettingsView({
					model : this.model, // app.userModel
				}));
			},
			showImportSettingsView : function() {
				this.$links.filter('a[href="#settings/import"]').click();
				this.contentRegion.show(new settings.ImportSettingsView({}));
			},
			showPopImapSettingsView : function() {
				this.$links.filter('a[href="#settings/pop-imap"]').click();
				this.contentRegion.show(new settings.PopImapSettingsView({
					model : this.model, // app.userModel
				}));
			},
			showAliasesForwardingSettingsView : function() {
				this.$links.filter('a[href="#settings/aliases-forwarding"]').click();
				this.contentRegion.show(new settings.AliasesForwardingSettingsView({
					model : this.model, // app.userModel
				}));
			},
			showMboxShareSettingsView : function(mboxModel) {
				var self = this;
				if (mboxModel) {
					var sharedMboxModel = new app.mail.SharedMboxModel({});
					sharedMboxModel.set('id', mboxModel.get('SHARING_MBOX_ID'));
					sharedMboxModel.fetch();
					this.listenTo(sharedMboxModel, 'change', function() {
						self.shareMboxSettingsRegion.show(new settings.MboxOrgSettingsLayout({
							model : sharedMboxModel,
							userModel : self.model, // app.userModel
							mboxModel : mboxModel,
							parentView : self,
						}));
						self.shareMboxSettingsRegion.$el.show();
						self.shareMboxSettingsRegion.$el.appendTo('body');
						self._centerLayerInWindow(self.shareMboxSettingsRegion.$el);
					});
				} else {
					this.shareMboxSettingsRegion.show(new settings.MboxOrgSettingsLayout({
						userModel : this.model, // app.userModel
						mboxCollection : this.mboxCollection,
						parentView : this,
					}));
					this.shareMboxSettingsRegion.$el.show();
					this.shareMboxSettingsRegion.$el.appendTo('body');
					this._centerLayerInWindow(this.shareMboxSettingsRegion.$el);
				}
			},
			showAddInternalUserView : function(flag) {
				this.internalUserSettingsRegion.show(new settings.VacationResponseOrgSettingsLayout({
					model : new Backbone.Model({
						userModel : this.model, // app.userModel
						flag : flag,
					}),
					parentView : this,
				}));
			},
			hideShareSettingsView : function() {
				this.internalUserSettingsRegion.$el.hide();
			},
			showKpnsSettingsView : function() {
				this.$links.filter('a[href="#settings/kpns"]').click();
				var kpnsConfigModel = new app.settings.KpnsModel();
				kpnsConfigModel.fetch({
					async : false,
				});
				this.contentRegion.show(new settings.KpnsSettingsView({
					model : kpnsConfigModel,
					mboxCollection : app.mail.mboxCollection,
					parentView : this,
				}));
			},
			showDeletedMailView : function() {
				var deletedMailPaginator = new app.mail.LoggingDeletedPaginator();
				this.$links.filter('a[href="#settings/deleted-mail"]').click();
				this.contentRegion.show(new settings.DeletedMailView({
					model : this.model, // app.userModel
					paginator : deletedMailPaginator,
				}));
			},
			changeVacationTabMenu : function(isApprover) {
				var $td = this.$el.find('td.vacation-response-settings');
				if (isApprover) {
					$td.children('a').html(i18n.deputyApproval.settings);
				} else {
					$td.children('a').html(i18n.vacationResponse.settings);
				}
			},
			_centerLayerInWindow : function($layer) {
				var $viewport = $(window);
				$viewport.on('resize.documentFormLayer', function(event) {
					event.preventDefault() && event.stopPropagation();
					var viewportWidth = $viewport.width() / 2;
					var viewportHeight = $viewport.height() / 2;
					var width = $layer.width() / 2;
					var height = $layer.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					$layer.css({
						top : top,
						left : left
					});
					return false;
				});
				$viewport.trigger('resize.documentFormLayer');
			},
		});

		settings.GeneralSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.GeneralSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#general-settings-template').html();
					compiledTemplate = _.template(html);
					settings.GeneralSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					domainDetails : app.domainDetailsModel.toJSON(),
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.mboxCollection = options.mboxCollection;
				this.subPart = options.subPart;
				this.listenTo(this, 'show:change-password', this.showSettingsChangePasswordView);
			},
			onRender : function() {
				var self = this;
				var $tabs = this.$el.find('ul.tab_list li a');
				var $panel = this.$el.find('div.scroll_frame div.scroll_zoom');
				switch (this.subPart) {
				case 'viewing':
					var $tab = $tabs.filter('.settings-viewing').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					var settingsViewingView = new settings.SettingsViewingView({
						model : self.model,
						mboxCollection : self.mboxCollection,
					});
					$panel.html(settingsViewingView.render().el);
					break;
				case 'composing':
					var $tab = $tabs.filter('.settings-composing').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					var settingsComposingView = new settings.SettingsComposingView({
						model : self.model
					})
					$panel.html(settingsComposingView.render().el);
					break;
				case 'change-password':
					var $tab = $tabs.filter('.settings-change-password').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					self.showSettingsChangePasswordView();
					break;
				case 'profile':
				default:
					var $tab = $tabs.filter('.settings-profile').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					var profileSettingsView = new settings.ProfileSettingsView({
						model : self.model
					});
					$panel.html(profileSettingsView.render().el);
					break;
				}
			},
			showSettingsChangePasswordView : function() {
				var $panel = this.$el.find('div.scroll_frame div.scroll_zoom');
				var securityDomain = new app.settings.SecurityDomainModel();
				securityDomain.fetch({
					async : false,
					wait : true,
				});
				var model = new app.BackboneModel({
					USERS_ID : this.model.get('USERS_ID'),
					USERS_IDX : this.model.get('USERS_IDX'),
					SECURITY_DOMAIN : securityDomain,
				});
				var settingsChangePasswordView = new settings.SettingsChangePasswordView({
					model : model,
					parentView : this,
				});
				$panel.html(settingsChangePasswordView.render().el);
			},
		}); // settings.GeneralSettingsView

		settings.ProfileSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ProfileSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#profile-settings-template').html();
					compiledTemplate = _.template(html);
					settings.ProfileSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $save = this.$el.find('div.tab_contents div.btn_c .b');
				var $cancel = this.$el.find('div.tab_contents div.btn_c .c');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var attributes = self.validateForm();
					if (!attributes)
						return false;
					if (attributes['USERS_CELLNO'] !== undefined || attributes['USERS_PREVEMAIL'] !== undefined) {
						if (self.confirmUserPasswordView) {
							self.confirmUserPasswordView.close();
						}
						var zIndex = settings.overlayView.$overlay.css('z-index');
						self.confirmUserPasswordView = new settings.ConfirmUserPasswordView({
							model : self.model,
							attributes : attributes,
							parentView : self,
						});
						var $confirmUserPasswordView = self.confirmUserPasswordView.render().$el;
						$confirmUserPasswordView.css('z-index', parseInt(zIndex) + 1);
						$confirmUserPasswordView.show().appendTo('body');
						var $viewport = $(window);
						$viewport.off('resize.confirmUserPasswordView');
						$viewport.on('resize.confirmUserPasswordView', function(event) {
							var parentWidth = $viewport.width() / 2;
							var parentHeight = $viewport.height() / 2;
							var width = $confirmUserPasswordView.width() / 2;
							var height = $confirmUserPasswordView.height() / 2;
							var top = Math.floor(parentHeight - height);
							var left = Math.floor(parentWidth - width);
							$confirmUserPasswordView.css({
								'top' : top,
								'left' : left
							});
						});
						$viewport.trigger('resize.confirmUserPasswordView');
					} else {
						self.userProfileSave(attributes);
					}
					return false;
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
					return false;
				});
			},
			validateForm : function() {
				var $engName = this.$el.find('#eng_name');
				var $nickname = this.$el.find('#nickname');
				var $company = this.$el.find('#company');
				var $group = this.$el.find('#group');
				var $level = this.$el.find('#level');
				// var $c_number = this.$el.find('#c_number');
				var $phone = this.$el.find('#phone');
				var $mobile = this.$el.find('#mobile');
				var $fax = this.$el.find('#fax');
				var $email = this.$el.find('#email');
				var $languages = this.$el.find('#languages');
				var $privacy = this.$el.find('input[name="use_privacy"]:checked');

				var entity = {};
				entity['USERS_ENGNAME'] = $engName.val();
				entity['USERS_NICKNAME'] = $nickname.val();
				entity['USERS_COMPNAME'] = $company.val();
				entity['USERS_DEPARTMENT'] = $group.val();
				entity['USERS_JOBTITLE'] = $level.val();
				entity['USERS_PRIVACY'] = $privacy.val();
				// entity['USERS_LICENCENUM'] = $c_number.val();

				entity['USERS_TELNO'] = $phone.val();
				if (this.model.get('USERS_CELLNO') != $mobile.val())
					entity['USERS_CELLNO'] = $mobile.val();
				entity['USERS_FAXNO'] = $fax.val();

				var prevEmail = $email.val();
				if (prevEmail.length > 0) {
					if (!this.isValidEmail(prevEmail)) {
						return;
					}
				}
				if (this.model.get('USERS_PREVEMAIL') != prevEmail)
					entity['USERS_PREVEMAIL'] = prevEmail;
				entity['USERS_LANG'] = $languages.val();
				return entity;
			},
			isValidEmail : function(input) {
				var expr = /^((\w|[\-\.])+)@((\w|[\-\.])+)\.([A-Za-z]+)$/;
				if (!this.isValidFormat(input, expr)) {
					alert(i18n.general.validEmail);
					return false;
				} else {
					return true;
				}
			},
			isValidFormat : function(input, expr) {
				if (input.search(expr) != -1) {
					return true;
				}
				return false;
			},
			userProfileSave : function(attributes) {
				if (attributes) {
					this.model.save(attributes, {
						patch : true,
						async : false,
						wait : true,
						success : function(model, response, options) {
							alert(i18n.general.modificationComplete);
							if (model.hasChanged('USERS_LANG'))
								window.location.reload();
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 412:
								var error = response.responseText;
								if (error.indexOf('Invalid Password') != -1) {
									alert(i18n.general.changePassword.invalidPassword);
								} else if (error.indexOf('Invalid Captcha') != -1) {
									alert(i18n.general.changePassword.invalidCaptchar);
								}
							}
							return false;
						},
					});
				}
			}
		}); // settings.ProfileSettingsView

		settings.SettingsViewingView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.SettingsViewingView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-viewing-template').html();
					compiledTemplate = _.template(html);
					settings.SettingsViewingView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.mboxCollection = options.mboxCollection;
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				this.renderMboxSelect();
				var $defaultSettings = this.$el.find('div.tab_contents div.btn_c .ab_l');
				var $save = this.$el.find('div.tab_contents div.btn_c .b');
				var $cancel = this.$el.find('div.tab_contents div.btn_c .c');
				var $listCon = this.$el.find('input[name=list_con]');
				if (self.model.get('USERS_MAIL_VIEW_MODE') != '0') {
					self.$el.find('#first_mail').attr('disabled', false);
				} else {
					self.$el.find('#first_mail').attr('disabled', true);
				}
				function timeZoneString() {
					var offset = (new Date()).getTimezoneOffset();
					var hours = Math.ceil(offset / 60);
					if (offset > 0)
						hours = Math.floor(offset / 60);
					var minutes = Math.floor(offset % 60);
					var timezone = hours > 0 ? '-' : '+';
					hours = hours < 0 ? -(hours) : hours;
					minutes = minutes < 0 ? -(minutes) : minutes;
					timezone += hours < 10 ? '0' + hours : hours;
					timezone += ':';
					timezone += minutes < 10 ? '0' + minutes : minutes;
					return timezone;
				}
				$defaultSettings.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var userModel = self.model;
					self.model = self.model.clone();
					self.model.set({
						MAIL_FIRST_VIEW : '',
						USERS_TIMEZONE : timeZoneString(),
						USERS_MAIL_VIEW : 1,
						AFTER_DELETING_MOVING : 'L',
						// USERS_PAGEVIEW_TYPE : 1,
						USERS_LISTNUM : 20,
						LIST_FONT_SIZE : '9',
						USERS_MAIL_VIEW_MODE : '0',
						SHOW_FIRST_MAIL : 0,
						LIST_GROUP_BY_DATE : 1,
						SHOW_FROM_COUNTRY : 1,
						BLOCK_EXTERNAL_CONTENT : 0
					});
					self.render();
					self.model = userModel;
					return false;
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.saveViewing();
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});
				$listCon.click(function() {
					if ($(this).is('#list_mail')) {
						self.$el.find('#first_mail').attr('disabled', true);
					} else {
						self.$el.find('#first_mail').attr('disabled', false);
					}
				});
			},
			saveViewing : function() {
				var mailFirstView = this.$el.find('select[name=mail-first-view]').val();
				var timeZone = this.$el.find('select[name=timeZone]').val();
				var readWindow = this.$el.find('input[name=read_window]:checked').val();
				var afterDeleting = this.$el.find('input[name=afterDeleting]:checked').val();
				// var pageviewType =
				// this.$el.find('input[name=pageview_type]:checked').val();
				var listNum = this.$el.find('#list_num').val();
				var listFontSize = this.$el.find('#list_font_size').val();
				var listCon = this.$el.find('input[name=list_con]:checked').val();
				var firstMail = this.$el.find('#first_mail').prop('checked') ? 1 : 0;
				var listGroupByDate = this.$el.find('input[name=list_group_by_date]:checked').val();
				var showFromCountry = this.$el.find('input[name=show_from_country]:checked').val();
				var blockExternalContent = this.$el.find('input[name=block_external_content]:checked').val();
				this.model.save({
					MAIL_FIRST_VIEW : mailFirstView,
					USERS_TIMEZONE : timeZone,
					USERS_MAIL_VIEW : readWindow,
					AFTER_DELETING_MOVING : afterDeleting,
					// USERS_PAGEVIEW_TYPE : pageviewType,
					USERS_LISTNUM : listNum,
					LIST_FONT_SIZE : listFontSize,
					USERS_MAIL_VIEW_MODE : listCon,
					SHOW_FIRST_MAIL : firstMail,
					LIST_GROUP_BY_DATE : listGroupByDate,
					SHOW_FROM_COUNTRY : showFromCountry,
					BLOCK_EXTERNAL_CONTENT : blockExternalContent
				}, {
					patch : true,
					async : false,
					wait : true,
					success : function(model, response, options) {
						alert(i18n.general.modificationComplete);
					}
				});
			},
			renderMboxSelect : function() {
				var self = this, $el = this.$el;
				var $mboxSelect = $el.find('select[name=mail-first-view]:first');
				$mboxSelect.empty();
				var mboxModels = [];
				function traverseMbox(parentMboxModel) {
					var subMboxModels;
					if (parentMboxModel) {
						subMboxModels = self.mboxCollection.filter(function(mboxModel) {
							return mboxModel.get('MBOX_REF') === parentMboxModel.get('MBOX_IDX');
						});
						mboxModels.push(parentMboxModel);
					} else {
						subMboxModels = self.mboxCollection.filter(function(mboxModel) {
							return mboxModel.get('MBOX_REF') === 0 && mboxModel.get('MBOX_TYPE') != 3
									&& mboxModel.get('MBOX_TYPE') != 5;
						});
					}
					for (var i = 0; i < subMboxModels.length; i++) {
						traverseMbox(subMboxModels[i]);
					}
				}
				traverseMbox();
				var options = [];
				options.push($('<option value="all"></option>').text(i18n.mboxes.all));
				options.push($('<option value="unseen"></option>').text(i18n.mboxes.unseen));
				for (var i = 0; i < mboxModels.length; i++) {
					var level = self.getLevel(mboxModels[i], self.mboxCollection);
					var $option = $('<option></option>');
					$option.val(mboxModels[i].get('MBOX_IDX'));
					switch (mboxModels[i].get('MBOX_TYPE')) {
					case 1:
						$option.text(i18n.mboxes.inbox);
						if (!self.model.get('MAIL_FIRST_VIEW'))
							$option.attr('selected', 'selected');
						break;
					case 2:
						options.push($('<option value="sent-me"></option>').text(i18n.mboxes.sentMe));
						$option.text(i18n.mboxes.sent);
						break;
					case 4:
						$option.text(i18n.mboxes.drafts);
						break;
					case 6:
					default:
						var name = mboxModels[i].get('MBOX_NAME');
						for (var j = 0; j < level; j++) {
							name = '../' + name;
						}
						$option.text(name);
					}
					options.push($option);
				}
				options.push($('<option value="important"></option>').text(i18n.mboxes.important));
				options.push($('<option value="attached"></option>').text(i18n.mboxes.attached));
				$mboxSelect.append(options);
				if (self.model.get('MAIL_FIRST_VIEW'))
					$mboxSelect.val(self.model.get('MAIL_FIRST_VIEW')).attr('selected', 'selected');

			},
			getLevel : function(model, mboxCollection) {
				var level = 0;
				var parentId = model.get('MBOX_REF');
				if (parentId === 0) {
					return level;
				}
				var parentMboxModel = mboxCollection.find(function(mboxModel) {
					return mboxModel.get('MBOX_IDX') === parentId;
				});
				while (parentMboxModel) {
					level++;
					parentId = parentMboxModel.get('MBOX_REF');
					if (parentId === 0)
						break;
					parentMboxModel = mboxCollection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === parentId;
					});
				}
				return level;
			},
		}); // settings.SettingsViewingView

		settings.SettingsChangePasswordView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.SettingsChangePasswordView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-change-password-template').html();
					compiledTemplate = _.template(html);
					settings.SettingsChangePasswordView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = Backbone.Model
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				var $save = this.$el.find('div.tab_contents div.btn_c .b');
				var $cancel = this.$el.find('div.tab_contents div.btn_c .c');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.save()) {
						self.parentView.trigger('show:change-password');
					}
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});
				this.$captchaRefresh = this.$el.find('a.mc-captcha-refresh');
				this.$captchaRefresh.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $captchaImg = self.$el.find('img[name=captcha-image]');
					$captchaImg.attr('src', 'img/captcha?_=' + new Date().getTime());
					return false;
				});
			},
			save : function() {
				var now_pw = this.$el.find('#now_pw').val();
				var new_pw = this.$el.find('#new_pw').val();
				var conf_pw = this.$el.find('#conf_pw').val();
				if (new_pw != conf_pw) {
					alert(i18n.general.changePassword.notMatch);
					return false;
				}
				var captcha = this.$el.find('input:text[name=captcha]').val();
				if (!captcha.trim().length) {
					alert(i18n.general.changePassword.invalidCaptchar);
					return false;
				}
				this.savePasswd(now_pw, new_pw, captcha)
			},
			isValidFormat : function(input, expr) {
				if (input.search(expr) != -1) {
					return true;
				}
				return false;
			},
			savePasswd : function(now_pw, new_pw, captcha) {
				var self = this;
				var userModel = new (app.user.UserModel.extend({
					urlRoot : 'users/password/',
				}))();
				userModel.save({
					USERS_IDX : this.model.get('USERS_IDX'),
					USERS_CURRENT_PASSWD : now_pw,
					USERS_PASSWD : new_pw,
					captcha : captcha,
				}, {
					patch : true,
					async : false,
					success : function() {
						alert(i18n.general.changePassword.patchSuccess);
					},
					error : function(model, response, options) {
						switch (response.status) {
						case 412:
							var error = response.responseText;
							if (error.indexOf('Include excluded word') != -1) {
								alert(i18n.general.changePassword.includeExcludedWord);
							} else if (error.indexOf('No capital letter') != -1) {
								alert(i18n.general.changePassword.noCapitalLetter);
							} else if (error.indexOf('No lower letter') != -1) {
								alert(i18n.general.changePassword.noLowerLetter);
							} else if (error.indexOf('No special character') != -1) {
								alert(i18n.general.changePassword.noSpecialChar);
							} else if (error.indexOf('No Number Found') != -1) {
								alert(i18n.general.changePassword.noNumberFound);
							} else if (error.indexOf('Dictionary word Found') != -1) {
								alert(i18n.general.changePassword.dictionaryWordFound);
							} else if (error.indexOf('Length invalid given') != -1) {
								alert(i18n.general.changePassword.lengthNotValid);
							} else if (error.indexOf('Invalid Password') != -1) {
								alert(i18n.general.changePassword.invalidPassword);
							} else if (error.indexOf('Invalid Captcha') != -1) {
								alert(i18n.general.changePassword.invalidCaptchar);
								self.$captchaRefresh.click();
							} else {
								alert(i18n.general.changePassword.patchFailure);
							}
							break;
						default:
							alert(i18n.general.changePassword.patchFailure);
							break;
						}
					},
				});
			},
		}); // settings.SettingsChangePasswordView

		settings.SettingsComposingView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.SettingsComposingView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-composing-template').html();
					compiledTemplate = _.template(html);
					settings.SettingsComposingView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $displayNameContainer = this.$el.find('div.layer_send_form');
				var $displayName = $displayNameContainer.children('button.layer_send_bt');
				var $displayNamesWrapper = $displayNameContainer.children('div.send_form_con');
				var $displayNameList = $displayNamesWrapper.children('ul');
				var $displayNameCustom = $displayNamesWrapper.children('p');
				var $displayNameInputWrapper = this.$el.find('p.add_send');
				var $displayNameInput = $displayNameInputWrapper.children('input[name="display-name"]');
				var $addDisplayName = $displayNameInputWrapper.children('button').eq(0);
				var $cancelDisplayName = $displayNameInputWrapper.children('button').eq(1);
				this.$el.click(function(event) {
					$displayNamesWrapper.hide();
				});
				$displayName.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$displayNamesWrapper.toggle();
					return false;
				});
				var $displayNameItems = $displayNameList.children('li');
				var addItemEventsListener = function($item) {
					$item.children('a').click(function(event) {
						event.preventDefault() && event.stopPropagation();
						var displayName = $(this).text();
						var $span = $displayName.children().not('span.ic.arrow');
						$span.text(displayName);
						$displayName.data('display-name', displayName);
						$displayNamesWrapper.hide();
						return false;
					});
					$item.children('span.ic.close').click(function(event) {
						event.preventDefault() && event.stopPropagation();
						$item.remove();
						return false;
					});
				};
				for (var i = 0; i < $displayNameItems.length; i++) {
					var $item = $displayNameItems.eq(i);
					addItemEventsListener($item);
					if (i == 0) {
						var displayName = $item.children('a').text();
						if (displayName == this.model.get('USERS_NAME')) {
							$item.children('span.ic.close').off('click');
						}
					}
				}
				var $displayNames = $displayNameItems.children('a');
				$displayNameCustom.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$displayNamesWrapper.hide();
					$displayNameContainer.hide();
					$displayNameInputWrapper.show();
					$displayNameInput.val('').focus();
					return false;
				});
				$addDisplayName.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var displayName = $displayNameInput.val();
					var $item = $displayNameItems.eq(0).clone();
					addItemEventsListener($item);
					$displayNameList.append($item);
					$item.children('a').text(displayName).click();
					$displayNameContainer.show();
					$displayNameInputWrapper.hide();
					return false;
				});
				$cancelDisplayName.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$displayNameInputWrapper.hide();
					$displayNameContainer.show();
					return false;
				});
				var $replyToAddressRadio = this.$el.find('input[name=reply-to-address]');
				$replyToAddressRadio.change(function(event) {
					var $reAddress = self.$el.find('input[name="USERS_READDR"]:first');
					var value = $(this).val();
					if ($(this).is(':checked') && value == 'sender') {
						$reAddress.attr('disabled', true);
					} else if ($(this).is(':checked') && value == 'address') {
						$reAddress.attr('disabled', false);
					}
				});
				$replyToAddressRadio.change();
				var $buttons = this.$el.find('div.btn_c button');
				var $restoreDefaults = $buttons.filter('.ab_l');
				var $save = $buttons.filter('.b');
				var $cancel = $buttons.not('.ab_l').not('.b');
				$restoreDefaults.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var userModel = self.model;
					self.model = self.model.clone();
					self.model.set({
						COMPOSE_FORMAT : 'html',
						COMPOSE_FONT : 'none',
						COMPOSE_FONT_SIZE : '10',
						DISPLAY_NAME : '',
						DISPLAY_NAMES : userModel.get('DISPLAY_NAMES'),
						AUTOSAVE_INTERVAL : 300,
						USERS_SENDBOX : 'Y',
						INDIVIDUAL_SEND : 0,
						ALWAYS_CC_BCC_MYSELF : 'none',
						PREVIEW_BEFORE_SENDING : 'all',
						SEND_DELAY : 0,
						REPLY_TO_SENDER : 1,
						REPLY_WITH : 'original',
						FORWARDING_OPTION : 0,
						ATTACHMENTS_POSITION : 0,
						COMPOSE_NEW_WINDOW : 0
					});
					self.render();
					self.model = userModel;
					return false;
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var attrs = {};
					var $selects = self.$el.find('select');
					$selects.each(function(index, element) {
						var name = $(element).attr('name');
						var value = $(element).val();
						switch (name) {
						case 'COMPOSE_FORMAT':
						case 'COMPOSE_FONT':
						case 'COMPOSE_FONT_SIZE':
							if (value != self.model.get(name))
								attrs[name] = value;
							break;
						case 'AUTOSAVE_INTERVAL':
							value = isNaN(value) ? 0 : parseInt(value);
							if (value != self.model.get(name))
								attrs[name] = value;
							break;
						}
					});
					var displayName = $displayName.data('display-name');
					if (displayName != self.model.get('DISPLAY_NAME'))
						attrs['DISPLAY_NAME'] = displayName;
					var displayNames = [];
					$displayNameItems.each(function(index, element) {
						var $item = $(element);
						var displayName = $item.children('a').text();
						if (displayName != self.model.get('USERS_NAME'))
							displayNames.push(displayName);
					});
					displayNames = displayNames.join('|');
					if (displayNames != self.model.get('DISPLAY_NAMES'))
						attrs['DISPLAY_NAMES'] = displayNames;
					var $inputs = self.$el.find('input');
					$inputs.each(function(index, element) {
						var $input = $(element);
						var name = $input.attr('name');
						var value = $input.val();
						switch (name) {
						case 'USERS_SENDBOX':
							value = $input.is(':checked') ? 'Y' : 'N';
							if (value != self.model.get(name))
								attrs[name] = value;
							break;
						case 'INDIVIDUAL_SEND':
							value = $input.is(':checked') ? 1 : 0;
							if (value != self.model.get(name))
								attrs[name] = value;
							break;
						case 'ALWAYS_CC_BCC_MYSELF':
						case 'PREVIEW_BEFORE_SENDING':
						case 'REPLY_WITH':
						case 'FORWARDING_OPTION':
						case 'ATTACHMENTS_POSITION':
						case 'COMPOSE_NEW_WINDOW':
							if ($input.is(':checked') && value != self.model.get(name))
								attrs[name] = value;
							break;
						case 'SEND_DELAY':
							if ($input.is(':checked')) {
								value = isNaN(value) ? 0 : parseInt(value);
								if (value != self.model.get(name))
									attrs[name] = value;
							}
							break;
						case 'reply-to-address':
							if ($input.is(':checked') && value == 'sender') {
								if (self.model.get('REPLY_TO_SENDER') != 1)
									attrs['REPLY_TO_SENDER'] = 1;
							}
							if ($input.is(':checked') && value == 'address') {
								if (self.model.get('REPLY_TO_SENDER') != 0)
									attrs['REPLY_TO_SENDER'] = 0;
								var $address = $inputs.filter('[name="USERS_READDR"]');
								var expr = '^([\\w-]+(?:\\.[\\w-]+)*)@';
								expr += '((?:[\\w-]+\\.)*\\w[\\w-]{0,66})\\.([a-z]{2,6}(?:\\.[a-z]{2})?)$';
								var matcher = new RegExp(expr);
								if (!matcher.test($address.val())) {
									alert(i18n.compose.checkMailFormat);
									$address.val('');
									$address.focus();
									return;
								}
								if (self.model.get('USERS_READDR') != $address.val())
									attrs['USERS_READDR'] = $address.val();
							}
							break;
						}
					});
					if (_.isEmpty(attrs)) {
						return false;
					}
					self.model.save(attrs, {
						async : false,
						wait : true,
						patch : true,
						success : function(model, response, options) {
							alert(i18n.compose.savedSuccessfully);
						},
						error : function(model, response, options) {
							alert(i18n.compose.failedToSave);
						},
					});
					return false;
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
					return false;
				});
			},
		}); // settings.SettingsComposingView

		settings.SecuritySettingsView = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.SecuritySettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#security-settings-template').html();
					compiledTemplate = _.template(html);
					settings.SecuritySettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},

			regions : {
				twoFactorRegion : {
					selector : 'div#two-factor-login',
				},
				qrCodeRegion : {
					selector : 'div#qr-code',
				},
				loginHistoryRegion : {
					selector : 'div#login-history',
				},
				countryRegion : {
					selector : 'div#country',
				},
			},

			initialize : function(options) {
				this.otpModel = options.otpModel;
				this.userModel = options.userModel;
				this.parentView = options.parentView;
				this.listenTo(this.otpModel, 'sync', function() {
					this.$el.find("#qr_code_tag").attr("src", this.otpModel.get("otpAuthURL"));
				});
				this.saveAuthorized = false;
				this.subPart = options.subPart;
			},
			onRender : function() {
				var self = this;
				var $tabs = this.$el.find('ul.tab_list li');
				var $panels = this.$el.find('div.scroll_frame div.scroll_zoom').children('div');
				switch (this.subPart) {
				case 'qr-code':
					$panels.hide();
					var $tab = $tabs.filter('.tab-qr-code');
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					self.showQrCodeView();
					self.qrCodeRegion.$el.show();
					break;
				case 'login-history':
					$panels.hide();
					var $tab = $tabs.filter('.tab-login-history');
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					self.showLoginLogView();
					self.loginHistoryRegion.$el.show();
					break;
				case 'country':
					$panels.hide();
					var $tab = $tabs.filter('.tab-country');
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					self.showCountryRestrictionView();
					self.countryRegion.$el.show();
					break;
				case 'two-factor':
				default:
					$panels.hide();
					var $tab = $tabs.filter('.tab-two-factor-login');
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					self.showTwoFactorLoginView();
					self.twoFactorRegion.$el.show();
					break;
				}
			},

			showTwoFactorLoginView : function() {
				var securityDomain = new app.settings.SecurityDomainModel();
				securityDomain.fetch({
					async : false,
					wait : true,
				});
				this.twoFactorRegion.show(new settings.TwoStepVerificationView({
					model : new Backbone.Model({
						userModel : this.userModel,
						securityDomain : securityDomain,
					}),
					otpModel : this.otpModel
				}));
			},

			showQrCodeView : function() {
				this.qrCodeRegion.show(new settings.OtpQrCodeView({
					otpModel : this.otpModel
				}));
			},

			showLoginLogView : function() {
				if (!this.loginPaginator) {
					this.loginPaginator = new settings.LoginPaginator();
				}
				this.loginPaginator.clearSearch();
				this.loginPaginator.currentPage = 1;
				var now = new Date();
				this.loginPaginator.server_api['search.startDate'] = $.format.date(new Date()
						.setMonth(now.getMonth() - 3), 'yyyy-MM-dd');
				this.loginPaginator.server_api['search.endDate'] = $.format.date(now, 'yyyy-MM-dd');
				this.loginPaginator.fetch({
					async : false,
					wait : true,
				});
				this.loginHistoryRegion.show(new settings.LoginLogView({
					collection : this.loginPaginator,
				}));
			},

			showCountryRestrictionView : function() {
				var securityDomain = new app.settings.SecurityDomainModel();
				securityDomain.fetch({
					async : false,
					wait : true,
				})
				this.countryRegion.show(new settings.LoginCountryView({
					model : new Backbone.Model({
						userModel : this.userModel,
						securityDomain : securityDomain,
					}),
				}));
			},

		}); // settings.SecuritySettingsView

		settings.OtpQrCodeView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.OtpQrCodeView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-qrcode-template').html();
					compiledTemplate = _.template(html);
					settings.OtpQrCodeView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},

			initialize : function(options) {
				this.otpModel = options.otpModel;
				this.listenTo(this.otpModel, 'sync', this.render);
			},

			onRender : function() {
				var self = this;
				this.$el.find("#qr_code_tag").attr("src", this.otpModel.get("otpAuthURL"));

				var $otpKey = this.$el.find('a.otpkey:first');
				$otpKey.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (this.otpKeyView && this.otpKeyView.$layer) {
						this.otpKeyView.$layer.toggle();
						return false;
					}
					this.otpKeyView = new settings.OtpKeyView({
						model : self.otpModel,
					});
					this.otpKeyView.render();
					return false;
				});
				// OTP리셋 버튼 onClick이벤트 묶기
				var $otpReset = this.$el.find('div.btn_c button.qr_code_reset_btn');
				$otpReset.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var confirmMsg = i18n.otp.reset;
					var successMsg = i18n.otp.resetSuccess;
					var failureMsg = i18n.otp.resetFailure;
					if (confirm(confirmMsg)) {
						self.otpModel.fetch({
							async : false,
							wait : true,
							data : {
								action : 'reset'
							},
							success : (function() {
								alert(successMsg);
								self.otpModel.fetch();
							}),
							error : (function(e) {
								alert(failureMsg);
							}),
						});
					}
					return false;
				}); // OTP 리셋 버튼 onClick이벤트 묶기
			},

		}); // settings.OtpQrCodeView

		settings.OtpKeyView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.OtpKeyView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-otpkey-template').html();
					compiledTemplate = _.template(html);
					settings.OtpKeyView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					otp : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.settings.OtpModel
			},
			onRender : function() {
				var self = this;
				this.$layer = this.$el.children().appendTo('body');
				this.$layer.css({
					top : '440px',
					left : '688px',
				});
				this.$layer.show();
				this.$layer.click(function(event) {
					event.stopPropagation();
				});
				var $close = this.$layer.find('div.close_bt:first');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$layer.toggle();
					return false;
				});
			},
		}); // settings.OtpKeyView

		settings.LoginLogItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = settings.LoginLogItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-loginlog-list-template').html();
					compiledTemplate = _.template(html);
					settings.LoginLogItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					login : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {
			},
			onRender : function() {

			},
		});

		settings.LoginLogView = Backbone.Marionette.CompositeView.extend({
			itemView : settings.LoginLogItemView,
			itemViewContainer : '.mc-logList',
			template : function(data) {
				var html, compiledTemplate = settings.LoginLogView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-loginlog-template').html();
					compiledTemplate = _.template(html);
					settings.LoginLogView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : data,
					i18n : i18n,
				});
				return html;
			},

			initialize : function(options) {
				this.listenTo(this.collection, 'sync', this.paginationView);
			},

			onRender : function() {
				var self = this;
				var $condition = this.$el.find('select#login_sel_box');
				var $keyword = this.$el.find('input[name=search-by-key]');
				var $searchBtn = this.$el.find('button#searchBtn');
				var $successCode = this.$el.find('select#search_login');
				var $dateInput = this.$el.find('span#search-by-date');
				var $startDate = this.$el.find('input#search_from');
				var $endDate = this.$el.find('input#search_to');
				var $downBtn = this.$el.find('button#loginlogDownBtn');
				$startDate.val($.format.date(new Date(), 'yyyy-MM-dd'));
				$endDate.val($.format.date(new Date(), 'yyyy-MM-dd'));
				$startDate.datepicker(i18n.datepicker.loginLogOptions);
				$endDate.datepicker(i18n.datepicker.loginLogOptions);
				var $selectList = $keyword.add($successCode).add($dateInput);
				$condition.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					$selectList.hide();
					var $this = $(this);
					if ($this.val() == 'success') {
						$successCode.show();
					} else if ($this.val() == 'time') {
						$dateInput.show();
					} else {
						$keyword.show();
					}
					self.collection.clearSearch();
				});
				$keyword.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						$searchBtn.click();
					}
				});
				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var server_api = self.collection.server_api;
					server_api._method = 'GET';
					server_api['search.condition'] = $condition.val();
					if ($condition.val() == 'success') {
						server_api['search.keyword'] = $successCode.val();
					} else if ($condition.val() == 'time') {
						server_api['search.startDate'] = $startDate.val();
						server_api['search.endDate'] = $endDate.val();
					} else {
						server_api['search.keyword'] = $keyword.val();
					}
					self.collection.goTo(1);
				});
				$downBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = 'search.startDate=' + self.collection.server_api['search.startDate'];
					params += '&search.endDate=' + self.collection.server_api['search.endDate'];
					location.href = 'settings/security/logins/download?' + params;
				});
				this.paginationView();
			},
			paginationView : function() {
				if (!this.$pagination) {
					this.$pagination = this.$el.find('.mc-paginate');
				}
				var paginationView = new settings.PaginationView({
					collection : this.collection,
				});
				this.$pagination.empty().append(paginationView.render().$el.children());
			},
		}); // settings.LoginLogView

		settings.PaginationView = Backbone.View.extend({
			render : function() {
				var html, compiledTemplate = settings.PaginationView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-pagination-template').html();
					compiledTemplate = _.template(html);
					settings.PaginationView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				this.$el.html(html);
				var $firstPage = this.$el.find('a.pre_end:first');
				$firstPage.click($.proxy(this.gotoFirst, this));
				var $prevPage = this.$el.find('a.pre:first');
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = this.$el.find('a.next:first');
				$nextPage.click($.proxy(this.gotoNext, this));
				var $lastPage = this.$el.find('a.next_end:first');
				$lastPage.click($.proxy(this.gotoLast, this));
				var $pages = this.$el.find('.entries-page');
				$pages.click($.proxy(this.gotoPage, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				if (this.collection.requestPreviousPage) {
					this.collection.requestPreviousPage();
				} else {
					this.collection.prevPage();
				}
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				if (this.collection.requestNextPage) {
					this.collection.requestNextPage();
				} else {
					this.collection.nextPage();
				}
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.preventDefault() && event.stopPropagation();
				var page = $(event.target).text();
				this.collection.goTo(page);
			},
		});

		settings.CountryListItemView = Backbone.Marionette.ItemView.extend({
			// tagName : 'option',
			template : function(data) {
				var html, compiledTemplate = settings.CountryListItemView.compiledTemplate;
				if (!compiledTemplate) {
					var tmplId = '#settings-logincountry-item-template';
					html = settings.$template.filter(tmplId).html();
					compiledTemplate = _.template(html);
					settings.CountryListItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					country : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {

			},
			onRender : function() {
				var self = this;
				this.$el = this.$el.children();
				this.$el.unwrap();
				this.setElement(this.$el);

			},
		});

		settings.CountryListSelectedItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			template : function(data) {
				var html, compiledTemplate = settings.CountryListSelectedItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-logincountry-item-selected-box-template').html();
					compiledTemplate = _.template(html);
					settings.CountryListSelectedItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					country : data,
					i18n : i18n,
					user : app.userModel,
				});
				return html;
			},

			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				this.$el = this.$el.children();
				this.$el.unwrap();
				this.setElement(this.$el);

			},
		});

		settings.LoginCountryView = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			template : function(data) {
				var html, compiledTemplate = settings.LoginCountryView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-logincountry-template').html();
					compiledTemplate = _.template(html);
					settings.LoginCountryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					user : data.userModel.toJSON(),
					securityDomain : data.securityDomain.toJSON(),
					countries : app.countryCollection.toJSON(),
				});
				return html;
			},

			initialize : function(options) {
				this.userModel = this.model.get('userModel');
				this.securityDomain = this.model.get('securityDomain');
				this.listenTo(this.userModel, 'sync', this.render);
				this.listenTo(app.countryCollection, 'sync', this.render);
			},

			onRender : function() {
				var self = this;
				$el = this.$el;

				var $toBeSelected = this.$el.find('li#country_select');
				$toBeSelected.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).parent().children().removeClass('on');
					if ($(this).hasClass('on')) {
						$(this).removeClass('on');
					} else {
						$(this).attr('class', 'on');
					}
				});

				var $addBtn = this.$el.find('#countryAddBtn');
				$addBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var code = self.$el.find('ul.ct_list li.on').attr('value');
					var $countryElem = self.$el.find("ul.ct_list_ok [value='" + code + "']");
					if (self.securityDomain.get('COUNTRY_USE') == 1) {
						var contryList = self.securityDomain.get('COUNTRY_LIST').split(',');
						var blockContry = false;
						contryList.each(function(contry) {
							if (contry == code) {
								blockContry = true;
								return false;
							}
						});
						if (blockContry) {
							alert(i18n.country.countryBlockedByAdmin);
							return false;
						}
					}
					if ($countryElem.css('display') == 'none') {
						$countryElem.show();
					} else {
						alert(i18n.country.alreadySelected);
					}
				});

				var $selected = this.$el.find('li#country-selected');
				$selected.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.country.confirmDelete)) {
						$(this).hide();
					}
				});

				var $saveBtn = this.$el.find("#country_save");
				$saveBtn.click(function(event) {
					var $selectedList = self.$el.find(".ct_list_ok li").filter(function() {
						return $(this).css('display') != 'none';
					});
					var newCountryStr = "";
					$selectedList.each(function(index) {
						newCountryStr += $(this).attr('value') + ",";
					});
					var countryUse = self.$el.find('input[name=country_use]:checked').val();
					self.userModel.save({
						COUNTRY_LIST : newCountryStr,
						COUNTRY_USE : countryUse,
					}, {
						patch : true,
						wait : true,
						async : false,
						success : function() {
							self.userModel.fetch();
							alert(i18n.country.useChangeSuccess);
						},
						error : function() {
							alert(i18n.country.useChangeFailure);
						},
					});
				});
			},

		}); // settings.LoginCountryView

		settings.TwoStepVerificationView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.TwoStepVerificationView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#settings-two-way-verification-template').html();
					compiledTemplate = _.template(html);
					settings.TwoStepVerificationView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data.userModel.toJSON(),
					securityDomain : data.securityDomain.toJSON(),
					i18n : i18n,
				});
				return html;
			},

			initialize : function(options) {
				this.userModel = this.model.get('userModel');
				this.otpModel = options.otpModel;
				// 2단계 인증 로그인 저장 버튼 클릭 허용 플래그
				this.saveAuthorized = false;
				this.listenTo(this.userModel, 'all', this.render);
			},

			onRender : function() {
				var self = this;
				// 2차인증 사용 관련 div display 처리
				var $authUseRadio = this.$el.find("input:radio[name='cfm']");
				var $authMethodRadio = this.$el.find("input:radio[name='cfm_manner']");
				var $skipTwoFactorAuth = this.$el.find("input:checkbox[name='skip_two_factor_auth']");
				$authUseRadio.change(function() {
					var value = $(this).val();
					if ($(this).is(':checked') && value == "0") {
						// OTP 미사용 선택 시, sms, app div 숨김처리
						self.$el.find('table.set_tbl tbody tr.auth-method').hide();
						self.$el.find('#otp_sms_ok').hide();
						self.$el.find('#otp_app_ok').hide();
						$skipTwoFactorAuth.prop('checked', false);
						$skipTwoFactorAuth.attr('disabled', true);
					} else if ($(this).is(':checked') && value == "1") {
						// OTP사용 선택 시 아래 sms,app 중 선택된 것 보임처리
						self.$el.find('table.set_tbl tbody tr.auth-method').show();
						if ($authMethodRadio.filter(':checked').val() == "otpapp") {
							self.$el.find('#otp_sms_ok').hide();
							self.$el.find("#otp_app_ok").show();
						} else {
							self.$el.find('#otp_sms_ok').show();
							self.$el.find("#otp_app_ok").hide();
						}
						$skipTwoFactorAuth.attr('disabled', false);
					}
				});
				$authUseRadio.change();

				$authMethodRadio.click(function() {
					if ($authUseRadio.filter(':checked').val() == "1") {
						if ($(this).val() == "otpapp") {
							self.$el.find('#otp_sms_ok').hide();
							self.$el.find("#otp_app_ok").show();
						} else {
							self.$el.find('#otp_sms_ok').show();
							self.$el.find("#otp_app_ok").hide();
						}
					}
				}); // //2차인증 사용 관련 div display 처리

				var $showQrCode = this.$el.find('strong.show-qrcode');
				$showQrCode.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.simpleQrCodeView)
						self.simpleQrCodeView.close();
					self.simpleQrCodeView = new settings.SimpleQrCodeView({
						model : self.otpModel,
					});
					var $simpleQrCodeView = self.simpleQrCodeView.render().$el;
					var $offsetParent = self.$el.offsetParent();
					$simpleQrCodeView.show().appendTo($offsetParent);
					$simpleQrCodeView.css({
						'top' : $showQrCode.position().top + 250,
						'left' : 635,
					});
				});

				// OTP 검증 버튼 이벤트핸들러 추가
				var $appValidateBtn = this.$el.find("#app_validate_btn");
				var $appValidateInp = this.$el.find("#app_check_num");
				$appValidateBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($appValidateInp.val().length != 6) {
						alert(i18n.otp.codeLengthError);
					} else {
						self.otpModel.fetch({
							async : true,
							wait : true,
							data : {
								action : 'validate',
								otpcode : $appValidateInp.val()
							},
							success : (function() {
								alert(i18n.otp.validateSuccess);
								self.saveAuthorized = true;
							}),
							error : (function(e) {
								alert(i18n.otp.validateFailure);
								self.saveAuthorized = false;
							}),
						});
					}
					return false;
				});

				var $cellPhone = this.$el.find('input:text[name=cell-phone]');
				var $sendSms = this.$el.find('button.send_sms');
				$sendSms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var expr = /^01([0|1|6|7|8|9]?)-?([0-9]{3,4})-?([0-9]{4})$/;
					var cellPhone = $cellPhone.val();
					if (!cellPhone || !expr.test(cellPhone)) {
						alert(i18n.twoPath.invalidPhone);
						return false;
					}
					var param = '';
					if ($this.text() == i18n.twoPath.smsRetry)
						param = 'retry';
					$.ajax({
						type : 'GET',
						url : 'sms/certification-key',
						dataType : 'json',
						data : {
							phone : cellPhone,
							param : param,
						},
						success : function(data) {
							var status = data.mapList[0].value.substring(0, 3);
							if (status == '200') {
								alert(i18n.twoPath.successSendSms);
								$this.text(i18n.twoPath.smsRetry);
							} else {
								alert(i18n.twoPath.failedSendSms);
							}
						},
					});
					return false;
				});
				var $smsValidateInp = this.$el.find('input:text[name=certification-key]');
				var $smsValidateBtn = this.$el.find('button.vaildate_sms');
				$smsValidateBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (isNaN($smsValidateInp.val()) || $smsValidateInp.val().length != 6) {
						alert(i18n.otp.codeLengthError);
					} else {
						$.ajax({
							type : 'POST',
							url : 'sms/certification-key',
							dataType : 'json',
							data : {
								certificationKey : $smsValidateInp.val(),
							},
							success : function(data) {
								alert(i18n.otp.validateSuccess);
								self.saveAuthorized = true;
							},
							error : function(request, status, error) {
								switch (request.status) {
								case 401:
									var error = request.responseText;
									if (error.indexOf('certificationKey') != -1) {
										alert(i18n.twoPath.invalidCertificationKey);
									} else if (error.indexOf('certificationTime') != -1) {
										alert(i18n.twoPath.invalidCertificationTime);
									} else if (error.indexOf('certificationCount') != -1) {
										alert(i18n.twoPath.invalidCertificationCount);
									}
									break;
								default:
									alert(i18n.otp.validateFailure);
									break;
								}
								self.saveAuthorized = false;
							}
						});
					}
					return false;
				});

				var $saveBtn = this.$el.find("#otp_save_btn");
				$saveBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					// 변경사항이 있는지 검사하는 로직
					var skipTwoFactorAuth = $skipTwoFactorAuth.prop('checked') ? 1 : 0;
					if (self.userModel.get('AUTH_USE') == $authUseRadio.filter(':checked').val()
							&& self.userModel.get('AUTH_METHOD') == $authMethodRadio.filter(':checked').val()
							&& self.userModel.get('SKIP_TWO_FACTOR_AUTH') == skipTwoFactorAuth) {
						alert(i18n.otp.noChangeFound);
						return;
					}
					if ($authUseRadio.filter(':checked').val() == 1 && !self.saveAuthorized) {
						alert(i18n.otp.validateFirst);
					} else {
						var cellPhone = self.model.get('USERS_CELLNO');
						if ($authMethodRadio.filter(':checked').val() == 'otpsms') {
							var expr = /^01([0|1|6|7|8|9]?)-?([0-9]{3,4})-?([0-9]{4})$/;
							cellPhone = $cellPhone.val();
							if (!cellPhone || !expr.test(cellPhone)) {
								alert(i18n.twoPath.invalidPhone);
								return false;
							}
						}
						if (confirm(i18n.otp.confirmSave)) {
							self.userModel.save({
								AUTH_USE : $authUseRadio.filter(':checked').val(),
								AUTH_METHOD : $authMethodRadio.filter(':checked').val(),
								SKIP_TWO_FACTOR_AUTH : skipTwoFactorAuth,
							}, {
								patch : true,
								wait : true,
								async : false,
								success : (function() {
									alert(i18n.otp.saveSuccess);
									self.userModel.fetch();
								}),
								error : (function(e) {
									alert(i18n.otp.saveFailure);
								}),
							});
						}
					}
					return false;
				});
			},
		}); // settings.TwoStepVerificationView

		settings.SimpleQrCodeView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 250px; display: none; position: absolute; text-align:center; z-index:2020',
				hidable : 'false',
			},
			template : function(data) {
				var html;
				var compiledTemplate = settings.SimpleQrCodeView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#simple-qrcode-templete').html();
					compiledTemplate = _.template(html);
					settings.SimpleQrCodeView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mail : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = new settings.OtpModel
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				this.$el.find('img.simple-qrcode').attr('src', this.model.get('otpAuthURL'));
				var $qrCodeReset = this.$el.find('div.ad_btn_area button.qrcode-reset');
				$qrCodeReset.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.otp.reset)) {
						self.model.fetch({
							async : false,
							wait : true,
							data : {
								action : 'reset'
							},
							success : (function() {
								self.model.fetch();
							}),
							error : (function(e) {
								alert(i18n.otp.resetFailure);
							}),
						});
					}
					return false;
				});
				var $close = this.$el.find('div.close_bt:first');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
		});

		settings.MboxesSettingsTabView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.MboxesSettingsTabView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mboxes-settings-tab-template').html();
					compiledTemplate = _.template(html);
					settings.MboxesSettingsTabView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel; // app.userModel
				this.mboxCollection = options.mboxCollection;
				this.searchMboxCollection = options.searchMboxCollection;
				this.labelCollection = options.labelCollection;
				this.parentView = options.parentView;
				this.part = options.part;
			},
			onRender : function() {
				var self = this;
				var $tabs = this.$el.find('ul.tab_list li a');
				var $panel = this.$el.find('div.scroll_frame div.scroll_zoom');
				switch (this.part) {
				case 'search-mboxes':
					var $tab = $tabs.filter('.settings-search-mboxes').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					settings.overlayView.showLoading();
					this.searchMboxCollection.fetch({
						async : false,
					});
					var searchMboxesSettingsView = new settings.SearchMboxesSettingsView({
						collection : this.searchMboxCollection,
						userModel : this.userModel,
						parentView : this,
					});
					$panel.html(searchMboxesSettingsView.render().el);
					settings.overlayView.hideLoading();
					break;
				case 'labels':
					var $tab = $tabs.filter('.settings-labels').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					settings.overlayView.showLoading();
					var labelsSettingsView = new settings.LabelsSettingsView({
						collection : this.labelCollection,
						userModel : this.userModel,
						parentView : this,
					});
					$panel.html(labelsSettingsView.render().el);
					settings.overlayView.hideLoading();
					break;
				case 'mboxes':
				default:
					var $tab = $tabs.filter('.settings-mboxes').parent();
					$tab.siblings().removeClass('on');
					$tab.addClass('on');
					settings.overlayView.showLoading();
					this.mboxCollection.fetch({
						async : false,
					});
					var mboxesSettingsView = new settings.MboxesSettingsView({
						collection : this.mboxCollection,
						userModel : this.userModel,
						parentView : this.parentView,
					});
					$panel.html(mboxesSettingsView.render().el);
					settings.overlayView.hideLoading();
					break;
				}
			},
		}); // settings.MboxesSettingsTabView

		settings.MboxesSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.MboxesSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mboxes-settings-template').html();
					compiledTemplate = _.template(html);
					settings.MboxesSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mboxes : data.items,
					mboxCollection : app.mail.mboxCollection,
					deliveryStatusPaginator : app.mail.deliveryStatusPaginator,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel; // app.userModel
				// this.collection == mail.mboxCollection
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'all', this.render);
			},
			onRender : function() {
				var self = this;
				var $table = this.$el.find('table.set_tbl.mail_tbl:first');
				var $tableRows = $table.find('tbody tr');
				$tableRows.mouseover(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).children().not('[rowspan]').css('background-color', '#efefef');
				});
				$tableRows.mouseout(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).children().not('[rowspan]').css('background-color', 'transparent');
				});
				var $createMbox = this.$el.find('button.create-mbox');
				$createMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $input = self.$el.find('input[name="mbox-name"]');
					var $mboxType = self.$el.find('input[name=mbox-type]:checked');
					var mboxName = $.trim($input.val());
					var mbox = {};
					if (!mboxName) {
						alert(i18n.mboxes.alertEmptyMailboxName);
						$input.focus();
						return false;
					}
					mbox.MBOX_NAME = mboxName;
					switch ($mboxType.val()) {
					case 'normal':
						break;
					case 'secure':
						var $passwd = self.$el.find('#new-mbox-pw');
						var passwd = $.trim($passwd.val());
						var $retypePasswd = self.$el.find('#retype-mbox-pw');
						var retypePasswd = $.trim($retypePasswd.val());
						if (!passwd) {
							alert(i18n.mboxes.alertEmptyMailboxPassword);
							$passwd.focus();
							return false;
						}
						if (!retypePasswd) {
							alert(i18n.mboxes.alertEmptyMailboxRetypePassword);
							$retypePasswd.focus();
							return false;
						}
						if (passwd !== retypePasswd) {
							alert(i18n.mboxes.alertInvalidMailboxPassword);
							$passwd.focus();
							return false;
						}
						mbox.MBOX_PUBLIC = 'S';
						mbox.MBOX_PASSWD = passwd;
						break;
					case 'shared':
						self.parentView.trigger('show:mbox-share-settings');
						return false;
					}
					if (mboxName !== '') {
						settings.overlayView.showProcessing();
						self.collection.create(mbox, {
							async : false,
							wait : true,
							error : function(model, response, options) {
								switch (response.status) {
								case 409:
									alert(i18n.mboxes.alertMailboxNameAlreadyExists);
									break;
								default:
									alert(i18n.mboxes.alertMailboxCreateFailure);
									break;
								}
							},
						});
						settings.overlayView.hideProcessing();
					}
					$input.val('');
					return false;
				});
				var $download = this.$el.find('a.mbox-actions-files');
				$download.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					if (self.mboxDownloadView) {
						self.mboxDownloadView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.mboxDownloadView = new settings.MboxDownloadView({
						model : mboxModel,
						parentView : self,
					});
					var $mboxDownloadView = self.mboxDownloadView.render().$el;
					$mboxDownloadView.css('z-index', parseInt(zIndex) + 1);
					$mboxDownloadView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.mboxDownloadView');
					$viewport.on('resize.mboxDownloadView', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $mboxDownloadView.width() / 2;
						var height = $mboxDownloadView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$mboxDownloadView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.mboxDownloadView');
					return false;
				});
				var $renameMbox = this.$el.find('a.mbox-actions-rename');
				$renameMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						self.showConfirmPasswordView(mboxModel, function() {
							var mboxRenameView = new settings.MboxRenameView({
								model : mboxModel,
								collection : self.collection,
							});
							mboxRenameView.render().$el.attr('hidable', false);
						});
					} else {
						var mboxRenameView = new settings.MboxRenameView({
							model : mboxModel,
							collection : self.collection,
						});
						mboxRenameView.render().$el.attr('hidable', false);
					}
					return false;
				});
				var $shareMbox = this.$el.find('a.mbox-actions-sharing');
				$shareMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					self.parentView.trigger('show:mbox-share-settings', mboxModel);
					return false;
				});
				var $changeMboxPassword = this.$el.find('a.mbox-actions-password');
				$changeMboxPassword.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					var mboxChangePasswordView = new settings.MboxChangePasswordView({
						model : mboxModel,
						collection : self.collection,
					});
					mboxChangePasswordView.render();
					return false;
				});
				var $emptyMbox = this.$el.find('a.mbox-actions-empty');
				$emptyMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					var emptyMbox = function() {
						var mboxName = self.getMboxNameById(mboxId);
						var msg = '';
						if (mboxId == 'delivery-status') {
							msg = i18n.mboxes.leadingConfirmDeliveryStatusEmpty + mboxName
									+ i18n.mboxes.trailingConfirmDeliveryStatusEmpty;
						} else if (self.userModel.get('USERS_DELBOX') == 'Y' && mboxModel.get('MBOX_TYPE') != 3
								&& mboxModel.get('MBOX_TYPE') != 5) {
							msg = i18n.mboxes.leadingConfirmMailboxEmpty + mboxName
									+ i18n.mboxes.trailingConfirmMailboxEmpty;
						} else {
							msg = i18n.mboxes.leadingConfirmMailboxPermanentlyEmpty + mboxName
									+ i18n.mboxes.trailingConfirmMailboxPermanentlyEmpty;
						}
						if (!confirm(msg)) {
							return false;
						}
						var model = new (app.BackboneModel.extend({
							urlRoot : 'mboxes/' + mboxId,
							defaults : {
								id : 'emails'
							},
						}))();
						settings.overlayView.showProcessing();
						model.destroy({
							wait : true,
							success : function(model, response, options) {
								self.collection.fetch();
								settings.overlayView.hideProcessing();
							},
						});
						app.userModel.fetch();
					};
					if (mboxModel && mboxModel.get('MBOX_PUBLIC') == 'S') {
						self.showConfirmPasswordView(mboxModel, emptyMbox);
					} else {
						emptyMbox();
					}
					return false;
				});
				var $removeMbox = this.$el.find('a.mbox-actions-remove');
				$removeMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					var removeMbox = function() {
						var mboxName = self.getMboxNameById(mboxId);
						var msg = '';
						if (self.userModel.get('USERS_DELBOX') == 'Y') {
							msg = i18n.mboxes.leadingConfirmMailboxRemove + mboxName
									+ i18n.mboxes.trailingConfirmMailboxRemove;
						} else {
							msg = i18n.mboxes.leadingConfirmMailboxPermanentlyDelete + mboxName
									+ i18n.mboxes.trailingConfirmMailboxPermanentlyDelete;
						}
						if (!confirm(msg)) {
							return false;
						}
						settings.overlayView.showProcessing();
						mboxModel.destroy({
							wait : true,
							success : function(model, response, options) {
								settings.overlayView.hideProcessing();
							},
						});
						app.userModel.fetch();
					};
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						self.showConfirmPasswordView(mboxModel, removeMbox);
					} else {
						removeMbox();
					}
					return false;
				});
				var $markAllAsRead = this.$el.find('a.mbox-actions-read');
				$markAllAsRead.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxName = self.getMboxNameById(mboxId);
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					var markAllAsRead = function() {
						if (!confirm(i18n.mboxes.leadingConfirmMarkAllAsRead + mboxName
								+ i18n.mboxes.trailingConfirmMarkAllAsRead)) {
							return false;
						}
						var model = new (app.BackboneModel.extend({
							urlRoot : 'mboxes/' + mboxId,
							defaults : {
								id : 'mails'
							},
						}))();
						settings.overlayView.showProcessing();
						model.save({
							M_ISREAD : 'Y',
						}, {
							wait : true,
							patch : true,
							success : function(model, response, options) {
								alert(i18n.mboxes.successMarkAllAsRead);
								self.collection.fetch();
								settings.overlayView.hideProcessing();
							},
						});
					};
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						self.showConfirmPasswordView(mboxModel, markAllAsRead);
					} else {
						markAllAsRead();
					}
					return false;
				});
				var $fileInput = $('body > #mail_files_to_upload');
				if (!$fileInput.length) {
					$fileInput = $('<input>', {
						'id' : 'mail_files_to_upload',
						'type' : 'file',
						'accept' : '.eml, .zip',
						'multiple' : 'true',
						'style' : 'position: absolute; top: -10000px; left: -10000px;'
					}).appendTo('body');
					$fileInput.change(function(event) {
						event.preventDefault() && event.stopPropagation();
						var $this = $(this);
						var files = this.files;
						var url = 'mboxes/' + $this.data('mbox-id') + '/files';
						var items = [];
						var totalSize = 0;
						var random = Math.floor(Math.random() * 100000000);
						for (var i = 0; i < files.length; i++) {
							items.push({
								id : random + '-' + i,
								file : files[i],
							});
							totalSize += files[i].size;
						}
						var quota = self.userModel.get('USERS_MAX_VOLUME') * 1024 * 1024;
						var free = quota - totalSize;
						if (free <= 0) {
							alert(i18n.mboxes.alertExceedingQuota);
							$this.val('');
							return false;
						}
						var mailUploadView = new settings.MailUploadView({
							collection : new Backbone.Collection(items),
							url : url,
						});
						var deferred = mailUploadView.upload();
						var zIndex = $('#settings-overlay').css('z-index');
						mailUploadView.$el.css('z-index', isNaN(zIndex) ? 2016 : parseInt(zIndex) + 1);
						deferred.always(function() {
							$this.val('');
							settings.overlayView.showLoading();
							self.collection.fetch({
								async : false,
							});
							settings.overlayView.hideLoading();
						});
						return false;
					});
				} // end if (!$fileInput.length)
				if (!$fileInput[0].files && !document.mailUploadIframe) {
					$('<iframe>', {
						'name' : 'mailUploadIframe',
						'src' : 'mboxes/form',
						'style' : 'position: absolute; display: none;',
					}).appendTo('body');
				}
				var $upload = this.$el.find('a.mbox-actions-upload');
				$upload.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					if ($fileInput[0].files) {
						$fileInput.data('mbox-id', mboxId);
						$fileInput.click();
						return false;
					}
					if (document.mailUploadIframe) {
						var iframe = document.mailUploadIframe;
						var form = iframe.mailUploadForm;
						var changed = false;
						form.mail.onchange = function(event) {
							changed = true;
							return false;
						};
						form.mail.click();
						if (!changed) {
							return false;
						}
						form.mbox.value = mboxId;
						form.submit();
						settings.overlayView.showUploadingMail();
						app.vent.once('mail-file:uploaded', function(filename) {
							settings.overlayView.hideUploadingMail();
							var iframe = document.mailUploadIframe;
							var pathname = iframe.location.pathname;
							var url = pathname.substring(0, pathname.lastIndexOf('/')) + '/form';
							iframe.location.replace(url);
							if (!filename) {
								alert(i18n.mboxes.alertFailedToUploadMail);
								return;
							}
							self.collection.fetch({
								async : false,
							});
						});
					}
					return false;
				}); // $upload.click(function(event) {...});
			}, // onRender : function() {...}
			getMboxNameById : function(mboxId) {
				if (mboxId == 'delivery-status') {
					return i18n.mboxes.deliveryStatus;
				}
				var mboxModel = this.collection.find(function(mboxModel) {
					return mboxModel.get('MBOX_IDX') === mboxId;
				});
				if (!mboxModel) {
					return null;
				}
				var mboxName = mboxModel.get('MBOX_NAME');
				switch (mboxModel.get('MBOX_TYPE')) {
				case 1:
					mboxName = i18n.mboxes.inbox;
					break;
				case 2:
					mboxName = i18n.mboxes.sent;
					break;
				case 3:
					mboxName = i18n.mboxes.trash;
					break;
				case 4:
					mboxName = i18n.mboxes.drafts;
					break;
				case 5:
					mboxName = i18n.mboxes.junk;
					break;
				}
				return mboxName;
			},
			showConfirmPasswordView : function(mboxModel, handleAction) {
				if (!mboxModel) {
					return;
				}
				var mboxConfirmPasswordView = new settings.MboxConfirmPasswordView({
					model : mboxModel,
					collection : this.collection,
					handleAction : handleAction,
				});
				mboxConfirmPasswordView.render();
			},
			_centerLayerInWindow : function($addFilterLayer) {
				var $viewport = $(window);
				$viewport.on('resize.documentFormLayer', function(event) {
					var viewportWidth = $viewport.width();
					var viewportHeight = $viewport.height();
					var scrollTop = $viewport.scrollTop();
					var scrollLeft = $viewport.scrollLeft();
					var layerWidth = $addFilterLayer.width();
					var layerHeight = $addFilterLayer.height();
					var top, left, marginTop, marginLeft;

					if (viewportHeight > layerHeight) {
						top = "50%";
						marginTop = -(layerHeight / 2) + scrollTop + "px";
					} else {
						top = scrollTop + "px";
						marginTop = "0";
					}
					if (viewportWidth > layerWidth) {
						left = "50%";
						marginLeft = -(layerWidth / 2) + scrollLeft + "px";
					} else {
						left = scrollLeft + "px";
						marginLeft = "0";
					}
					$addFilterLayer.css({
						position : 'absolute',
						top : top,
						left : left,
						'margin-top' : marginTop,
						'margin-left' : marginLeft
					});
				});
				$viewport.trigger('resize.documentFormLayer');
			},
		}); // settings.MboxesSettingsView

		settings.MboxDownloadView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 480px; display: none; position: absolute;',
			},
			template : function(data) {
				var html;
				var compiledTemplate = settings.MboxDownloadView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mbox-download-template').html();
					compiledTemplate = _.template(html);
					settings.MboxDownloadView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				this.parentView = options.parentView;
			},
			onBeforeRender : function() {
				settings.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $downloadTerms = $el.find('input[name="download_terms"]');
				var $startDate = $el.find('input.start-date:first');
				var $endDate = $el.find('input.end-date:first');
				var $download = $el.find('div.ad_btn_area button.layer_download');
				var $close = $el.find('div.close_bt:first');
				var $cancel = $el.find('div.ad_btn_area button.layer_cancle');
				$downloadTerms.change(function(event) {
					var term = $(this).val();
					if (term == 'all') {
						$startDate.add($endDate).attr('disabled', 'disabled');
					} else {
						$startDate.add($endDate).removeAttr('disabled');
					}
				});
				// jQuery UI Datepicker
				$startDate.datepicker();
				$endDate.datepicker();
				$download.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = '';
					if ($downloadTerms.filter(':checked').val() == 'period') {
						var regExp = /^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/;
						if (!regExp.test($startDate.val()) || !regExp.test($endDate.val())) {
							alert(i18n.mboxes.invalidDate);
							$startDate.focus();
							return false;
						}
						if (($startDate.val() && $endDate.val()) && $startDate.val() > $endDate.val()) {
							alert(i18n.mboxes.endDayLessThanStartDate);
							$startDate.focus();
							return false;
						}
						params = "?startDate=" + $startDate.val();
						params += "&endDate=" + $endDate.val();
					}
					if (self.model.get('MBOX_PUBLIC') == 'S') {
						self.parentView.showConfirmPasswordView(self.model, function() {
							location.href = "mboxes/" + self.model.get('MBOX_IDX') + "/files" + params;
						});
					} else {
						location.href = "mboxes/" + self.model.get('MBOX_IDX') + "/files" + params;
					}
					self.close();
				});
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
			onClose : function() {
				settings.overlayView.hideOverlay();
			},
		});

		settings.SearchMboxesSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.SearchMboxesSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#search-mboxes-settings-template').html();
					compiledTemplate = _.template(html);
					settings.SearchMboxesSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					searchMboxes : data.items,
					mboxCollection : app.mail.mboxCollection,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel; // app.userModel
				// this.collection == mail.searchMboxCollection
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $table = this.$el.find('table.set_tbl.mail_tbl:first');
				var $tableRows = $table.find('tbody tr');
				$tableRows.mouseover(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).children().not('[rowspan]').css('background-color', '#f9f9f9');
				});
				$tableRows.mouseout(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).children().not('[rowspan]').css('background-color', 'transparent');
				});
				var $use = this.$el.find('input:radio[name="search-mboxes-used"]');
				var $newSearchMbox = this.$el.find('div.search_mbox_enabled_area');
				var $searchMboxes = this.$el.find('div.box_tbl:first');
				$use.change(function(event) {
					event.stopPropagation();
					var value = $(this).val();
					if ($(this).is(':checked') && value == 0) {
						$newSearchMbox.hide();
						$searchMboxes.hide();
					} else if ($(this).is(':checked') && value == 1) {
						$newSearchMbox.show();
						$searchMboxes.show();
					}
				});
				$use.change();
				var $add = $newSearchMbox.find('button.button_s');
				var $modify = this.$el.find('a.search-mbox-modify');
				$add.add($modify).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var searchMboxModel = new app.mail.SearchMboxModel();
					var searchMboxdId = $(this).data('search-mbox-id');
					if (searchMboxdId) {
						searchMboxModel = self.collection.find(function(searchMboxModel) {
							return searchMboxModel.get('id') === searchMboxdId;
						});
					}
					if (self.searchMboxRegisterView) {
						self.searchMboxRegisterView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.searchMboxRegisterView = new app.mail.SearchMboxRegisterView({
						model : searchMboxModel,
						collection : self.collection,
						mboxCollection : app.mail.mboxCollection,
					});
					var $searchMboxRegisterView = self.searchMboxRegisterView.render().$el;
					$searchMboxRegisterView.css('z-index', parseInt(zIndex) + 1);
					$searchMboxRegisterView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.searchMboxRegister');
					$viewport.on('resize.searchMboxRegister', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $searchMboxRegisterView.width() / 2;
						var height = $searchMboxRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$searchMboxRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.searchMboxRegister');
					return false;
				});
				var $remove = this.$el.find('a.search-mbox-remove');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var searchMboxdId = $(this).data('search-mbox-id');
					var searchMboxModel = self.collection.find(function(searchMboxModel) {
						return searchMboxModel.get('id') === searchMboxdId;
					});
					var msg = searchMboxModel.get('name') + i18n.searchMboxes.deleteSearchMbox;
					if (!confirm(msg)) {
						return false;
					}
					searchMboxModel.destroy({
						async : false,
						wait : true,
						success : function(model, response, options) {
							self.collection.fetch();
						},
						error : function(model, response, options) {
							alert(i18n.searchMboxes.failedToDelete);
						},
					});
					return false;
				});
				var $visible = this.$el.find('a.search-mbox-visible');
				var $invisible = this.$el.find('a.search-mbox-invisible');
				$visible.add($invisible).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var searchMboxdId = $(this).data('search-mbox-id');
					var searchMboxModel = self.collection.find(function(searchMboxModel) {
						return searchMboxModel.get('id') === searchMboxdId;
					});
					var visible = searchMboxModel.get('visible');
					if (visible) {
						visible = 0;
						$visible.children('span:first').removeClass();
						$invisible.children('span:first').removeClass().addClass('sh_chk');
					} else {
						visible = 1;
						$visible.children('span:first').removeClass().addClass('sh_chk');
						$invisible.children('span:first').removeClass();
					}
					searchMboxModel.save({
						visible : visible,
					}, {
						patch : true,
						async : false,
						wait : true,
					});
					return false;
				});
				var $save = this.$el.find('div.btn_c button.b');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.userModel.save({
						SEARCH_MBOX_ENABLED : $use.filter(':checked').val(),
					}, {
						patch : true,
						wait : true,
						success : function() {
							alert(i18n.general.modificationComplete);
							app.userModel.trigger('search-mbox:enabled');
						}
					});
				});
				var $cancel = this.$el.find('div.btn_c button.c');
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});
			}, // onRender : function() {...}
		}); // settings.SearchMboxesSettingsView

		settings.LabelsSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.LabelsSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#labels-settings-template').html();
					compiledTemplate = _.template(html);
					settings.LabelsSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					labels : data.items,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel; // app.userModel
				// this.collection == mail.labelCollection
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $table = this.$el.find('table.set_tbl.mail_tbl:first');
				var $tableRows = $table.find('tbody tr');
				$tableRows.mouseover(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).children().not('[rowspan]').css('background-color', '#f9f9f9');
				});
				$tableRows.mouseout(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).children().not('[rowspan]').css('background-color', 'transparent');
				});
				var $use = this.$el.find('input:radio[name="mail-labels-used"]');
				var $newLabel = this.$el.find('div.label_enabled_area');
				var $labels = this.$el.find('div.box_tbl:first');
				$use.change(function(event) {
					event.stopPropagation();
					var value = $(this).val();
					if ($(this).is(':checked') && value == 0) {
						$newLabel.hide();
						$labels.hide();
					} else if ($(this).is(':checked') && value == 1) {
						$newLabel.show();
						$labels.show();
					}
				});
				$use.change();
				var $add = $newLabel.find('button.button_s');
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('show:label-add', event, self.collection, new app.mail.LabelModel());
					return false;
				});
				var $modify = this.$el.find('a.label-modify');
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var labelId = $(this).data('label-id');
					var labelModel = self.collection.find(function(labelModel) {
						return labelModel.get('id') === labelId;
					});
					app.vent.trigger('show:label-add', event, self.collection, labelModel);
					return false;
				});
				var $remove = this.$el.find('a.label-remove');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var labelId = $(this).data('label-id');
					var labelModel = self.collection.find(function(labelModel) {
						return labelModel.get('id') === labelId;
					});
					var msg = labelModel.get('name') + i18n.labels.deleteLabel;
					if (!confirm(msg)) {
						return false;
					}
					labelModel.destroy({
						async : false,
						wait : true,
						success : function(model, response, options) {
							self.collection.fetch();
						},
						error : function(model, response, options) {
							alert(i18n.labels.failedToDelete);
						},
					});
					return false;
				});
				var $visible = this.$el.find('a.label-visible');
				var $invisible = this.$el.find('a.label-invisible');
				$visible.add($invisible).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var labelId = $(this).data('label-id');
					var labelModel = self.collection.find(function(labelModel) {
						return labelModel.get('id') === labelId;
					});
					var visible = labelModel.get('visible');
					if (visible) {
						visible = 0;
						$visible.children('span:first').removeClass();
						$invisible.children('span:first').removeClass().addClass('sh_chk');
					} else {
						visible = 1;
						$visible.children('span:first').removeClass().addClass('sh_chk');
						$invisible.children('span:first').removeClass();
					}
					labelModel.save({
						visible : visible,
					}, {
						patch : true,
						async : false,
						wait : true,
					});
					return false;
				});
				var $save = this.$el.find('div.btn_c button.b');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.userModel.save({
						MAIL_LABEL_ENABLED : $use.filter(':checked').val(),
					}, {
						patch : true,
						wait : true,
						success : function() {
							alert(i18n.general.modificationComplete);
							app.userModel.trigger('mail-label:enabled');
						}
					});
				});
				var $cancel = this.$el.find('div.btn_c button.c');
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});
			}, // onRender : function() {...}
		}); // settings.LabelsSettingsView

		settings.MailUploadView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'mc-dh_layer',
			template : function(data) {
				var html, compiledTemplate = settings.MailUploadView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mail-upload-template').html();
					compiledTemplate = _.template(html);
					settings.MailUploadView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					files : data.items,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = options.collection
				this.url = options.url;
			},
			onRender : function() {
				var self = this, $el = this.$el;

				this.$totalProgressPercent = $el.find('.progress_bar .total');
				this.$totalProgressBar = $el.find('.p_bar .p_bar_value:first');

				this.$transferFiles = $el.find('.transfer-files:first');
				this.$transferRate = $el.find('.transfer-rate:first');
				this.$transferBytes = $el.find('.transfer-bytes:first');
				this.$transferTime = $el.find('.transfer-time:first');

				this.$close = $el.find('img.lClose:first');
				this.$close.click(function(event) {
					self.xhr && self.xhr.abort();
				});
				this.$pause = $el.find('.addButton.nb');
				this.$pause.click(function(event) {
					self.xhr && self.xhr.abort();
				});
			},
			upload : function() {
				this.deferred = {
					callbacks : {},
					done : function(callback) {
						this.callbacks['done'] = callback;
						return this;
					},
					fail : function(callback) {
						this.callbacks['fail'] = callback;
						return this;
					},
					always : function(callback) {
						this.callbacks['always'] = callback;
						return this;
					}
				};
				var self = this;
				setTimeout(function() {
					settings.overlayView.showOverlay();
					$('body').append(self.render().$el);
					self.$el.show();
					self._centerElementInWindow(self.$el);
					self._uploadFiles();
				}, 100);
				return this.deferred;
			},
			_uploadFiles : function() {
				var self = this, $el = this.$el, collection = this.collection;
				var totalLoaded = 0, totalBytes = 0, totalPercent = 0, totalRate = 0;
				var startTime = this._now();
				var uploadables = [];
				collection.each(function(model, index) {
					totalBytes += model.get('file').size;
					uploadables.push(function() {
						self.$transferFiles.text((index + 1) + '/' + collection.length);
						var id = model.get('id');
						var file = model.get('file');
						var xhr = self.xhr = new XMLHttpRequest();
						xhr.open('POST', self.url);

						var formData = new FormData();
						formData.append('files-' + id, file);

						var $fileItem = $el.find('#file-id-' + id);
						var $progress = $fileItem.find('.file_progress');
						var $progressBytes = $progress.find('.st');
						var $progressBar = $progress.find('.p_bar .p_bar_value');
						var $progressStatus = $progress.find('.transfer_status');

						var $parent = $fileItem.parents('.upld_file_list');
						var top = $parent.scrollTop() + $fileItem.position().top;
						$parent.scrollTop(top);

						var prevLoaded = 0;
						xhr.upload.onprogress = function(event) {
							var status = $progressStatus.text();
							if (status !== i18n.upload.loading) {
								$progressStatus.text(i18n.upload.loading);
							}
							if (event.lengthComputable) {
								var loaded = event.loaded;
								var total = event.total;
								if (loaded > file.size) {
									loaded = file.size;
								}
								var transferred = loaded - prevLoaded;
								app.log('Transferred: ' + transferred + ' = ' + loaded + " - " + prevLoaded);
								totalLoaded += transferred;
								prevLoaded = loaded;
								if (transferred > 0) {
									var position = self._formatSize(totalLoaded) + '/' + self._formatSize(totalBytes);
									self.$transferBytes.text(position);
									var pos = self._formatSize(event.loaded) + '/' + self._formatSize(event.total);
									$progressBytes.text(pos);
								}
								var percent = Math.round(totalLoaded / totalBytes * 100);
								app.log('Percent: ' + percent + ' = Math.round(' + totalLoaded + " / " + totalBytes
										+ " * 100)");
								if (percent != totalPercent) {
									totalPercent = percent;
									self.$totalProgressPercent.text(percent + '%');
									self.$totalProgressBar.css('width', percent + '%');
								}
								percent = Math.round(event.loaded / event.total * 100);
								$progressBar.css('width', percent + '%');
								var m = i18n.upload.minutes, s = i18n.upload.seconds;
								var elapsedTime = self._now() - startTime;
								if (elapsedTime == 0)
									interval = 1;
								var rate = Math.round(totalLoaded * 1000 / elapsedTime);
								if (totalRate != rate) {
									totalRate = rate;
									var speed = self._formatSize(rate);
									self.$transferRate.text(speed + '/' + s);
								}
								var remainingBytes = totalBytes - totalLoaded;
								var remainingTime = Math.floor(remainingBytes / rate * 1000);
								var estimatedTime = elapsedTime + remainingTime;
								var time = '';
								if (elapsedTime > 60000)
									time += Math.floor(elapsedTime / 60000) + m;
								time += Math.floor(elapsedTime % 60000 / 1000) + s;
								time += ' / ';
								if (estimatedTime > 60000)
									time += Math.floor(estimatedTime / 60000) + m;
								time += Math.floor(estimatedTime % 60000 / 1000) + s;
								self.$transferTime.text(time);
							} // end if (event.lengthComputable)
						}; // xhr.upload.onprogress
						xhr.upload.onabort = function(event) {
							$progressStatus.text(i18n.upload.abort);
							var callbacks = self.deferred.callbacks;
							callbacks.fail && callbacks.fail.call();
							callbacks.always && callbacks.always.call();
							self.remove();
							settings.overlayView.hideOverlay();
						}; // xhr.upload.onabort
						xhr.upload.onload = function(event) {
							$progressStatus.text(i18n.upload.done);
							if (index < collection.length - 1) {
								try {
									uploadables[index + 1].call();
								} catch (error) {
									app.log(error);
									var callbacks = self.deferred.callbacks;
									callbacks.fail && callbacks.fail.call();
									callbacks.always && callbacks.always.call();
									self.remove();
									settings.overlayView.hideOverlay();
								}
							} else {
								var callbacks = self.deferred.callbacks;
								callbacks.done && callbacks.done.call();
								callbacks.always && callbacks.always.call();
								self.remove();
								settings.overlayView.hideOverlay();
							}
							app.userModel.fetch({
								async : false,
								wait : true,
							});
						}; // xhr.upload.onload = function(event) {...}
						xhr.send(formData);
					}); // uploadables[].push(function() {...});
				}); // collection.each(function(model, index) {...});
				if (uploadables.length) {
					try {
						uploadables[0].call();
					} catch (error) {
						app.log(error);
						var callbacks = self.deferred.callbacks;
						callbacks.fail && callbacks.fail.call();
						callbacks.always && callbacks.always.call();
						self.remove();
						settings.overlayView.hideOverlay();
					}
				} else {
					var callbacks = self.deferred.callbacks;
					callbacks.done && callbacks.done.call();
					callbacks.always && callbacks.always.call();
					self.remove();
					settings.overlayView.hideOverlay();
				}
			}, // _uploadFiles : function() {...}
			_centerElementInWindow : function($element) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width() / 2;
				var viewportHeight = $viewport.height() / 2;
				var width = $element.width() / 2;
				var height = $element.height() / 2;
				var top = Math.floor(viewportHeight - height);
				var left = Math.floor(viewportWidth - width);
				$element.css({
					top : top,
					left : left
				});
			},
			_formatSize : function(number, pattern) {
				pattern = typeof pattern === 'string' ? pattern : '0.0b';
				return numeral(number).format(pattern);
			},
			_now : function() {
				return Date.now ? Date.now() : new Date().getTime();
			},
		}); // settings.MailUploadView

		settings.MboxRenameView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.MboxRenameView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mbox-rename-template').html();
					compiledTemplate = _.template(html);
					settings.MboxRenameView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.mboxCollection
			},
			onRender : function() {
				var self = this;
				this.$layer = this.$el.children().appendTo('body');
				this._centerElementInWindow(this.$layer);
				this.$layer.show();
				this.$layer.click(function(event) {
					event.stopPropagation();
				});
				var $close = this.$layer.find('.close-mbox-rename:first');
				var $cancel = this.$layer.find('.cancel-mbox-rename:first');
				$($close).add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$layer.remove();
					self.remove();
					return false;
				});
				var $confirm = this.$layer.find('.confirm-mbox-rename:first');
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $newMboxName = self.$layer.find('input#new-mailbox-name');
					if ($newMboxName.length == 0 || $.trim($newMboxName.val()).length == 0) {
						alert(i18n.mboxes.alertEmptyMailboxName);
						return false;
					}
					var mboxName = $newMboxName.val();
					if (mboxName.length > 16) {
						alert(i18n.mboxes.alertMboxNameLengthOverflow);
						return false;
					}
					var mboxModel = self.collection.find(function(mboxModel) {
						if (mboxModel.get('MBOX_NAME') == mboxName)
							return true;
					});
					if (mboxModel) {
						alert(i18n.mboxes.alertMailboxNameAlreadyExists);
						return false;
					}
					self.model.save({
						MBOX_NAME : mboxName
					}, {
						patch : true,
						async : false,
						wait : true,
						success : function(model, response, options) {
							self.$layer.remove();
							self.remove();
						},
						error : function(model, response, options) {
							alert(i18n.mboxes.alertMailboxRenameFailure);
							self.$layer.remove();
							self.remove();
						}
					});
					return false;
				});
			},
			_centerElementInWindow : function($element) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width() / 2;
				var viewportHeight = $viewport.height() / 2;
				var width = $element.width() / 2;
				var height = $element.height() / 2;
				var top = Math.floor(viewportHeight - height);
				var left = Math.floor(viewportWidth - width);
				$element.css({
					top : top,
					left : left
				});
			},
		});

		settings.MboxChangePasswordView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.MboxChangePasswordView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mbox-password-template').html();
					compiledTemplate = _.template(html);
					settings.MboxChangePasswordView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.mboxCollection
			},
			onRender : function() {
				var self = this;
				var $aob = $('div.aob'); // 백그라운드 안개효과
				this.$layer = this.$el.children().appendTo('body');
				this._centerElementInWindow(this.$layer);
				this.$layer.show();
				this.$layer.click(function(event) {
					event.stopPropagation();
				});
				var $close = this.$layer.find('.close-mbox-passwd:first');
				var $cancel = this.$layer.find('.cancel-mbox-passwd:first');
				$($close).add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$layer.remove();
					self.remove();
					$aob.hide();
					return false;
				});
				var $confirm = this.$layer.find('.confirm-mbox-passwd:first');
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $mboxPasswd = self.$layer.find('input#mbox-passwd');
					var mboxPasswd = $.trim($mboxPasswd.val());
					var $newMboxPasswd = self.$layer.find('input#new-mbox-passwd');
					var newMboxPasswd = $.trim($newMboxPasswd.val());
					if ($mboxPasswd.length == 0 || mboxPasswd.length == 0) {
						alert(i18n.mboxes.alertEmptyMailboxCurrentPassword);
						$mboxPasswd.focus();
						return false;
					}
					if ($newMboxPasswd.length == 0 || newMboxPasswd.length == 0) {
						alert(i18n.mboxes.alertEmptyMailboxNewPassword);
						$newMboxPasswd.focus();
						return false;
					}
					if (mboxPasswd === newMboxPasswd) {
						alert(i18n.mboxes.alertSameMailboxPassword);
						$newMboxPasswd.focus();
						return false;
					}
					self.model.save({
						MBOX_PUBLIC : 'S',
						MBOX_PASSWD : mboxPasswd,
						MBOX_NEW_PASSWD : newMboxPasswd,
					}, {
						patch : true,
						async : false,
						wait : true,
						success : function(model, response, options) {
							self.$layer.remove();
							self.remove();
							$aob.hide();
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 401:
								alert(i18n.mboxes.alertInvalidCurrentPassword);
								break;
							default:
								alert(i18n.mboxes.alertMailboxChangePasswordFailure);
								break;
							}
						}
					});
					return false;
				});
				$aob.show();
			},
			_centerElementInWindow : function($element) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width() / 2;
				var viewportHeight = $viewport.height() / 2;
				var width = $element.width() / 2;
				var height = $element.height() / 2;
				var top = Math.floor(viewportHeight - height);
				var left = Math.floor(viewportWidth - width);
				$element.css({
					top : top,
					left : left
				});
			},
		}); // settings.MboxChangePasswordView

		settings.MboxConfirmPasswordView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.MboxConfirmPasswordView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mbox-confirm-password-template').html();
					compiledTemplate = _.template(html);
					settings.MboxConfirmPasswordView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.mboxCollection
				this.handleAction = options.handleAction;
			},
			onRender : function() {
				var self = this;
				var $aob = $('div.aob'); // 백그라운드 안개효과
				this.$layer = this.$el.children().appendTo('body');
				this._centerElementInWindow(this.$layer);
				this.$layer.show();
				this.$layer.click(function(event) {
					event.stopPropagation();
				});
				var $close = this.$layer.find('.close-mbox-passwd:first');
				var $cancel = this.$layer.find('.cancel-mbox-passwd:first');
				$($close).add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$layer.remove();
					self.remove();
					$aob.hide();
					return false;
				});
				var $confirm = this.$layer.find('.confirm-mbox-passwd:first');
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $mboxPasswd = self.$layer.find('input#mbox-passwd');
					var mboxPasswd = $.trim($mboxPasswd.val());
					if ($mboxPasswd.length == 0 || mboxPasswd.length == 0) {
						alert(i18n.mboxes.alertEmptyMailboxPassword);
						$mboxPasswd.focus();
						return false;
					}
					self.model.fetch({
						type : 'POST',
						data : {
							_method : 'GET',
							key : mboxPasswd
						},
						success : function() {
							self.$layer.remove();
							self.remove();
							if (typeof self.handleAction == 'function') {
								self.handleAction();
							}
							$aob.hide();
							return false;
						},
						error : function(model, response, options) {
							alert(i18n.mboxes.alertInvalidMailboxPassword);
							return false;
						},
					});
					return false;
				});
				$aob.show();
			},
			_centerElementInWindow : function($element) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width() / 2;
				var viewportHeight = $viewport.height() / 2;
				var width = $element.width() / 2;
				var height = $element.height() / 2;
				var top = Math.floor(viewportHeight - height);
				var left = Math.floor(viewportWidth - width);
				$element.css({
					top : top,
					left : left
				});
			},
		}); // settings.MboxConfirmPasswordView

		settings.MboxOrgSettingsLayout = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var $template = settings.$template;
				var templateID = '#mbox-org-settings-layout-template';
				var html = $template.filter(templateID).html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				headerRegion : 'div.mbox-sharing-header',
				orgTreeRegion : 'div.treeWrapping',
				orgUserSearchRegion : 'div.mbox-sharing-search',
				orgUserListRegion : 'div.mbox-org-users',
				mboxShareeRegion : 'div.mbox-sharee-users',
				footerRegion : 'div.mbox-sharing-footer',
				paginationRegion : '.page_ctrl',
			},
			initialize : function(options) {
				// this.model == mail.sharedMboxModel
				this.userModel = options.userModel;
				this.mboxModel = options.mboxModel;
				this.mboxCollection = options.mboxCollection;
				this.contentLayoutView = options.parentView;
				this.listenTo(app.vent, 'paginate:shared-org-entries', this.showOrgUserListView);
				this.listenTo(this, 'update:sharee-count', this.updateRecipientsCount);
			},
			onRender : function() {
				var self = this;
				this.headerRegion.show(new settings.MboxOrgHeaderView({
					contentLayoutView : this.contentLayoutView,
				}));
				var orgRootEntryModel = new app.org.OrgEntryModel({
					id : 'root'
				});
				orgRootEntryModel.fetch();
				this.listenTo(orgRootEntryModel, 'change', function() {
					var attributes = orgRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.org.OrgEntryCollection(member);
					self.orgTreeRegion.show(new settings.MboxOrgTreeRootView({
						model : orgRootEntryModel,
						collection : collection,
						parentView : self,
					}));
				});
				this.orgUserSearchRegion.show(new settings.MboxOrgUserSearchView({
					model : orgRootEntryModel,
					parentView : this,
				}));
				this.showOrgUserListView();
				this.mboxShareeRegion.show(new settings.MboxOrgShareeListView({
					model : this.model, // mail.sharedMboxModel
					parentView : this,
				}));
				this.footerRegion.show(new settings.MboxOrgSettingsFooterView({
					userModel : this.userModel,
					mboxModel : this.mboxModel,
					mboxCollection : this.mboxCollection,
					parentView : this,
					contentLayoutView : this.contentLayoutView,
				}));
				// // Buttons: append [->] | remove [<-]
				var $append = this.$el.find('.btn_add');
				var $remove = this.$el.find('.btn_remove');
				var $checkAll = this.$el.find('#mbox-sharing-all-user');
				$append.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trigger('append:sharees');
					$checkAll.removeProp('checked');
				});
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trigger('remove:sharees');
				});
				$checkAll.change(function() {
					var checked = $(this).is(':checked');
					var $checkboxes = self.orgUserListRegion.$el.find('input[type=checkbox]');
					if (checked) {
						$checkboxes.prop('checked', 'checked');
					} else {
						$checkboxes.removeProp('checked');
					}
				});
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			showOrgUserListView : function(params) {
				var self = this;
				var paginator = new app.org.OrgEntryPaginator();
				if (params && params.url) {
					paginator.paginator_core.url = params.url;
					delete params.url;
				}
				var url = 'org/root/entries';
				if (!params) {
					params = {};
					paginator.paginator_core.url = url;
				}
				params._method = 'GET';
				paginator.setParams(params);
				paginator.fetch({
					success : function(collection, response, options) {
						collection.pager();
						var shareOrgListView = new settings.MboxOrgUserListView({
							model : self.userModel, // app.userModel
							collection : paginator,
							parentView : self,
						});
						self.orgUserListRegion.show(shareOrgListView);
						// Pagination
						var paginationView = new settings.MboxOrgPaginationView({
							collection : paginator,
						});
						self.paginationRegion.show(paginationView);
					},
					silent : true,
				});
			},
			updateRecipientsCount : function(recipientsCount) {
				// this.$el.find('.org-group-recipients-count').text(recipientsCount);
			},
		}); // settings.MboxOrgSettingsLayout

		settings.MboxOrgHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var $template = settings.$template;
				var html = $template.filter('#mbox-org-header-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					group : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.contentLayoutView = options.contentLayoutView;
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('a#txt_pop_close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contentLayoutView.shareMboxSettingsRegion.$el.hide();
				});
			},
		}); // settings.MboxOrgHeaderView

		settings.MboxOrgPaginationView = Backbone.Marionette.ItemView.extend({
			initialize : function(options) {
				// this.collection == org.OrgEntryPaginator
				this.collection.on('reset', this.render, this);
			},
			render : function() {
				var html, selfView = settings.MboxOrgPaginationView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = settings.$template;
					html = $template.filter('#mbox-org-settings-pagination-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				this.$el.html(html);
				var $firstPage = this.$el.find('a.btn_first');
				$firstPage.click($.proxy(this.gotoFirst, this));
				var $prevPage = this.$el.find('a.btn_prev');
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = this.$el.find('a.btn_next');
				$nextPage.click($.proxy(this.gotoNext, this));
				var $lastPage = this.$el.find('a.btn_last');
				$lastPage.click($.proxy(this.gotoLast, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.previousPage();
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.nextPage();
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.stopPropagation();
				if (event.which == 13) {
					event.preventDefault();
					var page = $(event.target).val();
					if (this.collection.totalPages >= page) {
						this.collection.goTo(page);
					}
				}
			},
		}); // settings.MboxOrgPaginationView

		settings.MboxOrgTreeEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, selfView = settings.MboxOrgTreeEntryView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mbox-org-entry-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = $el.children('.orgNode');
				var $checkbox = $el.children('input:checkbox');
				var $label = $el.children('label:first');
				var $list = $el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var urlRoot = _.result(self.model, 'urlRoot');
					var url = urlRoot.replace(/([^\/])$/, '$1/') + encodeURIComponent(self.model.id) + '/entries';
					var params = {
						url : url
					};
					app.vent.trigger('paginate:shared-org-entries', params);
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email
						this.$el.data('id', this.model.get('id')); // user_group_idx
					}
				}
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'group')) {
					$list.append($item);
				}
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					}
				});
			}
		}); // settings.MboxOrgTreeEntryView

		settings.MboxOrgTreeRootView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, selfView = settings.MboxOrgTreeRootView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#mbox-org-root-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			itemView : settings.MboxOrgTreeEntryView,
			itemViewContainer : "ul#shareOrgContainer:first",
			initialize : function(options) {
				this.parentView = options.parentView; // settings.MboxOrgSettingsLayout
				this.listenTo(this.parentView, 'append:sharees', this.appendSharees);
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					}
				});
				var topParentNode = this.$el.find('#topParentNode');
				topParentNode.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var checked = $(this).is(':checked');
					// var urlRoot = _.result(self.model, 'urlRoot');
					// var url = urlRoot.replace(/([^\/])$/, '$1/')
					// + encodeURIComponent(self.model.id) + '/entries';
					app.vent.trigger('paginate:shared-org-entries');
				});
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$('ul:first');
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'group')) {
					$list.append($item);
				}
			},
			appendSharees : function() {
				var $checkboxes = this.$el.find('input[type="checkbox"]:checked');
				var recipients = [];
				$checkboxes.each(function(index, element) {
					var $checkbox = $(element);
					var $item = $checkbox.parent();
					var share = {
						type : $item.data('oc'),
						personal : $item.data('cn'),
						address : $item.data('mail'),
						id : $item.data('id'),
					};
					recipients.push(share);
				});
				$checkboxes.prop('checked', false);
				this.parentView.trigger('add:sharees', recipients);
			},
		}); // settings.MboxOrgTreeRootView

		settings.MboxOrgUserView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, $template = settings.$template;
				html = $template.filter('#mbox-org-user-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var attributes = this.model.get('attributes');
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email
						this.$el.data('id', this.model.get('id')); // idx
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common
						// name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email
						// address
						this.$el.data('mail', attributes.mail[0]);
					this.$el.data('id', this.model.get('id')); // idx
				}
			},
		}); // settings.MboxOrgUserView

		settings.MboxOrgUserListView = Backbone.Marionette.CompositeView.extend({
			itemView : settings.MboxOrgUserView,
			itemViewContainer : 'ul',
			template : function(data) {
				var html;
				var selfView = settings.MboxOrgUserListView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = settings.$template;
					html = $template.filter('#mbox-org-user-list-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.parentView = options.parentView; // settings.MboxOrgSettingsLayout
				this.listenTo(this.parentView, 'append:sharees', this.appendSharees);
				this.listenTo(this.parentView, 'remove:sharees', this.removeSharees);
			},
			onRender : function() {
			},
			appendSharees : function() {
				var self = this;
				var $checkboxes = this.$el.find('input[type="checkbox"]:checked');
				var recipients = [];
				$checkboxes.each(function(index, element) {
					var $checkbox = $(element);
					var $item = $checkbox.parent();
					var share = {
						type : $item.data('oc'),
						personal : $item.data('cn'),
						address : $item.data('mail'),
						id : $item.data('id'),
					};
					if ($item.data('mail') == self.model.get('USERS_IDX')) {
						alert(i18n.mboxes.alertSelfMboxShare);
						return;
					}
					recipients.push(share);
				});
				$checkboxes.prop('checked', false);
				this.parentView.trigger('add:sharees', recipients);
			},
			removeSharees : function() {
				this.parentView.trigger('remove:sharee');
			},
		}); // settings.MboxOrgUserListView

		settings.MboxOrgUserSearchView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.MboxOrgUserSearchView.compiledTemplate;
				var $template = settings.$template;
				if (!compiledTemplate) {
					html = $template.filter('#mbox-org-settings-search-template').html();
					compiledTemplate = _.template(html);
					settings.MboxOrgUserSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $searchInput = this.$el.find('input[type=text]');
				var $searchBtn = this.$el.find('button[type=submit]');
				$searchInput.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						self.filterOrgUsers($(this).val());
					}
				});
				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.filterOrgUsers($searchInput.val());
				});
			},
			filterOrgUsers : function(keyword) {
				if (keyword && (keyword.indexOf('%') != -1 || keyword.indexOf('_') != -1)) {
					alert(i18n.search.invalidToken);
					return;
				}
				app.vent.trigger('paginate:shared-org-entries', {
					search : encodeURIComponent(keyword),
				});
			},
		}); // settings.MboxOrgUserSearchView

		settings.MboxOrgShareeItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, $template = settings.$template;
				html = $template.filter('#mbox-org-sharee-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				this.initData();
			},
			initData : function() {
				var type = this.model.get('type');
				var USER_GROUP_IDX = this.model.get('USER_GROUP_IDX') || this.model.get('id');
				if (!type && (!USER_GROUP_IDX || USER_GROUP_IDX == 0)) {
					type = 'user';
				} else if (!type && (USER_GROUP_IDX && USER_GROUP_IDX != 0)) {
					type = 'group';
				}
				this.$el.data('SHARE_EMAIL', this.model.get('SHARE_EMAIL'));
				this.$el.data('USER_GROUP_IDX', USER_GROUP_IDX);
				this.$el.data('type', type);
				this.$el.data('SHARE_NAME', this.model.get('SHARE_NAME'));
			},
		}); // settings.MboxOrgShareeItemView

		settings.MboxOrgShareeListView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html;
				var selfView = settings.MboxOrgShareeListView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = settings.$template;
					html = $template.filter('#mbox-org-sharee-list-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.sharedMboxModel
				this.parentView = options.parentView; // settings.MboxOrgSettingsLayout
				this.listenTo(this.parentView, 'add:sharees', this.addSharees);
				this.listenTo(this.parentView, 'remove:sharee', this.removeSharee);
			},
			onRender : function() {
				if (this.model && this.model.get('sharee')) {
					var sharees = this.model.get('sharee').split(',');
					for (var i = 0; i < sharees.length; i++) {
						var sharee = sharees[i];
						var type = 'user';
						var personal, address;
						try {
							var addr = InternetAddress.parseHeader(sharee, false);
							personal = addr[0].getPersonal();
							address = addr[0].getAddress();
						} catch (e) {
						}
						if (sharee.charAt(0) === '$') {
							type = 'group';
							personal = address.substring(1);
						}
						var model = new Backbone.Model({
							type : type,
							SHARE_NAME : personal,
							SHARE_EMAIL : address,
						});
						var recipientsItemView = new settings.MboxOrgShareeItemView({
							model : model,
							parentView : this,
						});
						this.$el.find('ul').append(recipientsItemView.render().el);
					}
				}
			},
			addSharees : function(sharees) {
				var self = this, $el = this.$el;
				$.each(sharees, function(index, sharee) {
					var isDuplicate = self.checkDuplicate(sharee);
					if (isDuplicate)
						return;
					var model = new Backbone.Model({
						type : sharee.type,
						SHARE_NAME : sharee.personal,
						SHARE_EMAIL : sharee.address,
						id : sharee.id,
					});
					var recipientsItemView = new settings.MboxOrgShareeItemView({
						model : model,
						parentView : self,
					});
					$el.find('ul').append(recipientsItemView.render().el);
				});
				this.parentView.trigger('update:sharee-count', this.$el.find('li').length);
			},
			removeSharee : function() {
				var $checkbox = this.$el.find('.org-recipient-item');
				$checkbox.filter(':checked').parent('li').hide();
				$checkbox.attr('id', $checkbox.attr('id') + '-hide');
			},
			checkDuplicate : function(sharee) {
				var $item = this.$el.find('li label');
				var isDuplicate = false;
				$item.each(function() {
					var addr = $(this).text();
					var id;
					if (addr.charAt(0) == '$') {
						id = sharee.address;
					} else {
						if (sharee.personal) {
							id = '"' + sharee.personal + '"' + '<' + sharee.address + '>';
						} else {
							id = '<' + sharee.address + '>';
						}
					}
					if (addr && $.trim(addr) == $.trim(id)) {
						isDuplicate = true;
						return false;
					}
				});
				return isDuplicate;
			}
		}); // settings.MboxOrgShareeListView

		settings.MboxOrgSettingsFooterView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var $template = settings.$template;
				var html = $template.filter('#mbox-org-settings-footer-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.mboxModel = options.mboxModel;
				this.mboxCollection = options.mboxCollection;
				this.parentView = options.parentView;
				this.contentLayoutView = options.contentLayoutView;
			},
			onRender : function() {
				var self = this;
				var $save = this.$el.find('button.org-user-group-save');
				var $cancel = this.$el.find('button.org-user-group-cancel');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!self.mboxModel && !confirm(i18n.mboxes.confirmSharingMbox)) {
						return false;
					}
					if (self.mboxModel && !confirm(i18n.mboxes.confirmChangeSharingSetting)) {
						return false;
					}
					var sharees = [], unlinkedSharees = [];
					var $list = self.parentView.mboxShareeRegion.$el.find('li');
					$list.each(function() {
						var $item = $(this);
						var sharee = $.trim($item.data('SHARE_EMAIL'));
						if (!sharee) {
							return true;
						}
						if (sharee == self.userModel.get('USERS_IDX')) {
							return true;
						}
						if (sharee.charAt(0) === '$') {
							if ($item.is(':visible')) {
								sharees.push(sharee);
							} else {
								unlinkedSharees.push(sharee);
							}
							return true;
						}
						try {
							var addr = InternetAddress.parseHeader(sharee, false);
							sharee = '"' + $.trim($item.data('SHARE_NAME')) + '"' + '<' + addr[0].getAddress() + '>';
						} catch (error) {
						}
						if ($item.is(':visible')) {
							sharees.push(sharee);
						} else {
							unlinkedSharees.push(sharee);
						}
					});
					unlinkedSharees = _.difference(unlinkedSharees, sharees);
					var sharedMboxModel = new app.mail.SharedMboxModel({});
					var sharingMboxId;
					if (self.mboxModel) {
						sharingMboxId = self.mboxModel.get('SHARING_MBOX_ID');
					} else {
						sharedMboxModel.save(null, {
							async : false,
							wait : true,
							success : function(model, response, options) {
								sharingMboxId = model.get('id');
								var mboxName = $.trim($('input#new-mbox').val());
								// create mbox
								self.mboxCollection.create({
									MBOX_NAME : mboxName,
									SHARING_MBOX_ID : sharingMboxId,
								}, {
									async : false,
									wait : true,
								});
							},
						});
					}
					sharedMboxModel.set('id', sharingMboxId);
					sharedMboxModel.save({
						sharee : sharees.join(','),
						unlinkedSharees : unlinkedSharees.join(','),
					}, {
						patch : true,
						wait : true,
					});
					self.contentLayoutView.shareMboxSettingsRegion.$el.hide();
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contentLayoutView.shareMboxSettingsRegion.$el.hide();
				});
			},
		}); // settings.MboxOrgSettingsFooterView

		settings.CleanUpSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.CleanUpSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#clean-up-settings-template').html();
					compiledTemplate = _.template(html);
					settings.CleanUpSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
			},
			onRender : function() {
				var self = this;
				var $moveToTrash = this.$el.find('input[name="USERS_DELBOX"]:first');
				var $trashRetention = this.$el.find('select[name="USERS_DEL_WASTE"]:first');
				var $spamRetention = this.$el.find('select[name="USERS_DEL_SPAM"]:first');
				var $inboxRetention = this.$el.find('select[name="USERS_DEL_INBOX"]:first');
				var $autoDelBySpam = this.$el.find('input:radio[name="USERS_AUTO_DEL"]');
				var $resetDefaults = this.$el.find('.reset-settings-to-defaults:first');
				$resetDefaults.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$moveToTrash.prop('checked', true);
					var $options = $trashRetention.children('option');
					$options.eq(0).prop('selected', true);
					$options = $spamRetention.children('option');
					$options.eq(0).prop('selected', true);
					$options = $inboxRetention.children('option');
					$options.eq(0).prop('selected', true);
					return false;
				});
				var $save = this.$el.find('.save-settings:first');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = {};
					if ($moveToTrash.is(':checked')) {
						params.USERS_DELBOX = 'Y';
					} else {
						params.USERS_DELBOX = 'N';
					}
					params.USERS_DEL_WASTE = $trashRetention.children('option:selected').val();
					params.USERS_DEL_SPAM = $spamRetention.children('option:selected').val();
					params.USERS_DEL_INBOX = $inboxRetention.children('option:selected').val();
					params.USERS_AUTO_DEL = $autoDelBySpam.filter(':checked').val();
					settings.overlayView.showSaving();
					self.model.save(params, {
						patch : true,
						wait : true,
						async : false,
					});
					settings.overlayView.hideSaving();
					return false;
				});
			},
		}); // settings.CleanUpSettingsView

		settings.FiltersSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.FiltersSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-settings-template').html();
					compiledTemplate = _.template(html);
					settings.FiltersSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					filters : data.items,
					mboxes : app.mail.mboxCollection.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == app.mail.AutoDivisionCollection
				this.filterModel = new app.mail.AutoDivisionModel();
				this.userModel = options.userModel; // app.userModel
				this.mboxCollection = options.mboxCollection; // mail.mboxCollection
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'fetch:filters-settings-view', this.fetchFilterCollection);
			},
			onRender : function() {
				var self = this;
				var $addFilter = this.$el.find('button#group_add_bt');
				var $modify = this.$el.find('.filter-settings-modify');
				var $toolbarRemove = this.$el.find('button.filter-toolbar-remove');
				var $findFilter = this.$el.find('button#find-filter-button');
				var $inputFindFilter = this.$el.find('input#find-filter');
				var $remove = this.$el.find('button.filter-settings-remove');
				var $checkAll = this.$el.find('input[type=checkbox]#filters-check-all');
				var $checkboxes = this.$el.find('table.mail_auto_tbl tbody input[type=checkbox]');

				$addFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.addFiltersSettingsView) {
						self.addFiltersSettingsView.close();
					}
					self.addFiltersSettingsView = new settings.AddFiltersSettingsView({
						userModel : self.userModel, // app.userModel
						mboxCollection : self.mboxCollection,
					})
					var $offsetParent = self.$el.offsetParent();
					var $addFiltersSettingsView = self.addFiltersSettingsView.render().$el;
					$addFiltersSettingsView.show().appendTo($offsetParent);
					self._centerLayerInWindow($offsetParent, $addFiltersSettingsView);
				});
				$toolbarRemove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $selectedCheckboxes = $checkboxes.filter(':checked');
					if ($selectedCheckboxes.length == 0) {
						alert(i18n.filters.selectForDeleteFilter);
						return;
					}
					if (!confirm(i18n.filters.confirmDelete)) {
						return;
					}
					settings.overlayView.showLoading();
					$selectedCheckboxes.each(function() {
						var filterModel = self.collection.getAutoDivisionModel('AUTODIVISION_IDX', $(this).val());
						if (filterModel) {
							filterModel.destroy({
								async : false,
								wait : true,
							});
						}
					});
					settings.overlayView.hideLoading();
					self.fetchFilterCollection();
				});
				$inputFindFilter.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						self.searchFilter($.trim($inputFindFilter.val()));
					}
				});
				$findFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.searchFilter($.trim($inputFindFilter.val()));
				});
				$checkAll.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeProp('checked');
					}
				});
				var $moveTop = this.$el.find('button.filter-toolbar-top');
				$moveTop.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $selectedCheckboxes = $checkboxes.filter(':checked');
					// select only one
					if ($selectedCheckboxes.length != 1) {
						alert(i18n.filters.pleaseSelectOneFilter);
						return;
					}
					var rowId = 'filters-row-' + $selectedCheckboxes.val();
					var $selectedRow = self.$el.find('#' + rowId);
					var $rows = $selectedRow.parent().find('tr');
					if ($rows[0].id == rowId) {
						alert(i18n.filters.alreadyTopOfTheList);
						return;
					}
					$selectedRow.insertBefore($rows[0]);
					self.modifyFilterOrder($selectedCheckboxes);
				});
				var $moveUp = this.$el.find('button.filter-toolbar-up');
				$moveUp.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $selectedCheckboxes = $checkboxes.filter(':checked');
					// select only one
					if ($selectedCheckboxes.length != 1) {
						alert(i18n.filters.pleaseSelectOneFilter);
						return;
					}
					var rowId = 'filters-row-' + $selectedCheckboxes.val();
					var $selectedRow = self.$el.find('#' + rowId);
					var $rows = $selectedRow.parent().find('tr');
					if ($rows[0].id == rowId) {
						alert(i18n.filters.alreadyTopOfTheList);
						return;
					}
					if ($selectedRow.prev().html() && $selectedRow.prev().attr("class") != "f") {
						$selectedRow.insertBefore($selectedRow.prev());
						self.modifyFilterOrder($selectedCheckboxes);
					}
				});
				var $moveDown = this.$el.find('button.filter-toolbar-down');
				$moveDown.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $selectedCheckboxes = $checkboxes.filter(':checked');
					// select only one
					if ($selectedCheckboxes.length != 1) {
						alert(i18n.filters.pleaseSelectOneFilter);
						return;
					}
					var rowId = 'filters-row-' + $selectedCheckboxes.val();
					var $selectedRow = self.$el.find('#' + rowId);
					var $rows = $selectedRow.parent().find('tr');
					if ($rows[$rows.length - 1].id == rowId) {
						alert(i18n.filters.alreadyBottomOfTheList);
						return;
					}
					if ($selectedRow.next().html()) {
						$selectedRow.insertAfter($selectedRow.next());
						self.modifyFilterOrder($selectedCheckboxes);
					}
				});
				var $moveBottom = this.$el.find('button.filter-toolbar-bottom');
				$moveBottom.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $selectedCheckboxes = $checkboxes.filter(':checked');
					// select only one
					if ($selectedCheckboxes.length != 1) {
						alert(i18n.filters.pleaseSelectOneFilter);
						return;
					}
					var rowId = 'filters-row-' + $selectedCheckboxes.val();
					var $selectedRow = self.$el.find('#' + rowId);
					var $rows = $selectedRow.parent().find('tr');
					if ($rows[$rows.length - 1].id == rowId) {
						alert(i18n.filters.alreadyBottomOfTheList);
						return;
					}
					$selectedRow.insertAfter($rows[$rows.length - 1]);
					self.modifyFilterOrder($selectedCheckboxes);
				});
				var $toggleClassification = this.$el.find('#filter-toolbar-classification');
				$toggleClassification.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $classificationView = self.$el.find('div#filter-classification-view');
					$classificationView.toggle();
					$classificationView.attr('hidable', false);
					var mouseOver = function(event) {
						event.preventDefault() && event.stopPropagation();
						var $this = $(this);
						$this.siblings('li').removeClass('hover');
						$this.addClass('hover');
					}
					var listClick = function(event) {
						event.preventDefault() && event.stopPropagation();
						var $this = $(this);
						$this.siblings('li').removeClass('selected');
						$this.addClass('selected');
						self.classificationType = $this.data('category');
						self.collection.url = 'autodivisions/category?filter=' + $this.data('category');
						self.collection.fetch();
					}
					$classificationView.find('li').mouseover(mouseOver);
					$classificationView.find('li').click(listClick);
					$classificationView.click(function(event) {
						event.stopPropagation();
					});
				});
				var $toggleMailbox = this.$el.find('#filter-toolbar-mailbox');
				$toggleMailbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $mboxView = self.$el.find('div#filter-mailbox-view');
					$mboxView.toggle();
					$mboxView.attr('hidable', false);
					var mouseOver = function(event) {
						event.preventDefault() && event.stopPropagation();
						var $this = $(this);
						$this.siblings('li').removeClass('hover');
						$this.addClass('hover');
					}
					var listClick = function(event) {
						event.preventDefault() && event.stopPropagation();
						var $this = $(this);
						$this.siblings('li').removeClass('selected');
						$this.addClass('selected');
						self.selectedMboxId = $this.data('mbox-id');
						self.collection.url = 'autodivisions/category?mbox=' + $this.data('mbox-id');
						self.collection.fetch();
					}
					$mboxView.find('li').mouseover(mouseOver);
					$mboxView.find('li').click(listClick);
					$mboxView.click(function(event) {
						event.stopPropagation();
					});
				});
				$modify.mouseover(function() {
					$(this).css('cursor', 'pointer');
				});
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var filterId = $(this).data('filter-id');
					var filterModel = self.collection.getAutoDivisionModel('AUTODIVISION_IDX', filterId);
					if (self.addFiltersSettingsView) {
						self.addFiltersSettingsView.close();
					}
					self.addFiltersSettingsView = new settings.AddFiltersSettingsView({
						model : filterModel,
						userModel : self.userModel, // app.userModel
						mboxCollection : self.mboxCollection,
					})
					var $offsetParent = self.$el.offsetParent();
					var $addFiltersSettingsView = self.addFiltersSettingsView.render().$el;
					$addFiltersSettingsView.show().appendTo($offsetParent);
					self._centerLayerInWindow($offsetParent, $addFiltersSettingsView);
				});
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var filterId = $(this).data('filter-id');
					var filterModel = self.collection.getAutoDivisionModel('AUTODIVISION_IDX', filterId);
					if (!confirm(i18n.filters.confirmDelete)) {
						return;
					}
					if (filterModel) {
						filterModel.destroy({
							async : false,
							wait : true,
							success : function() {
								self.collection.fetch();
							}
						});
					}
				});
				$checkboxes.each(function() {
					var $this = $(this);
					if ($this.val() == self.checkFilterId) {
						$this.prop('checked', true);
						$this.focus();
					}
				});
				if (self.classificationType) {
					this.$el.find('div#filter-classification-view li').each(function() {
						var $this = $(this);
						if ($this.is('.selected')) {
							$this.removeClass('selected');
						}
						if ($this.data('category') == self.classificationType) {
							$this.addClass('selected');
						}
					});
				}
				if (self.selectedMboxId) {
					this.$el.find('div#filter-mailbox-view li').each(function() {
						var $this = $(this);
						if ($this.is('.selected')) {
							$this.removeClass('selected');
						}
						if ($this.data('mbox-id') == self.selectedMboxId) {
							$this.addClass('selected');
						}
					});
				}
			},
			searchFilter : function(term) {
				if (term.indexOf('%') != -1 || term.indexOf('_') != -1) {
					alert(i18n.filters.invalidTerm);
					return;
				}
				this.collection.url = 'autodivisions?search=' + encodeURIComponent(term);
				this.collection.fetch();
			},
			fetchFilterCollection : function() {
				if (!this.collection) {
					return;
				}
				this.collection.fetch();
			},
			modifyFilterOrder : function($selectedCheckbox) {
				var self = this;
				var filters = [];
				var $tableRows = this.$el.find('div.tbl_output table.contents tbody tr');
				$tableRows.each(function(index) {
					var filterId = $(this).data('filter-id');
					var orderNo = $tableRows.length + 1 - index;
					filters.push({
						AUTODIVISION_IDX : filterId,
						ORDINAL : orderNo
					});
				});
				self.filterModel.url = 'autodivisions/order';
				self.filterModel.save({
					filters : filters,
				}, {
					patch : true,
					wait : true,
					async : false,
					success : function() {
						self.collection.fetch();
						self.checkFilterId = $selectedCheckbox.val();
					},
				});
			},
			_centerLayerInWindow : function($offsetParent, $layer) {
				var $viewport = $(window);
				$viewport.on('resize.filterSettingsAddLayer', function(event) {
					event.preventDefault() && event.stopPropagation();
					var viewportWidth = $offsetParent.width() / 2;
					var viewportHeight = $offsetParent.height() / 2;
					var width = $layer.width() / 2;
					var height = $layer.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					$layer.css({
						top : top,
						left : left
					});
					return false;
				});
				$viewport.trigger('resize.filterSettingsAddLayer');
			},
		}); // settings.FiltersSettingsView

		settings.AddFiltersSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'add_layertbl group_add',
			attributes : {
				style : 'right:520px; top :151px; display:none; position: absolute;',
			},
			template : function(data) {
				var html, compiledTemplate = settings.AddFiltersSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#add-filters-layer-template').html();
					compiledTemplate = _.template(html);
					settings.AddFiltersSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					filter : data,
					mboxes : app.mail.mboxCollection.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.mail.filterModel
				this.userModel = options.userModel;
				this.mboxCollection = options.mboxCollection;
			},
			onRender : function() {
				var self = this;
				var $toggleRcptFilters = this.$el.find('a#toggle-rcpt-filters');
				var $toggleContentFilter = this.$el.find('a#toggle-content-filter');
				var $rcptFilters = this.$el.find('ul.settings-rcpt-filters');
				var $contentFilters = this.$el.find('ul.settings-content-filters');
				var $moveToMbox = this.$el.find('input[type=checkbox]#filter-move-to-mbox');
				var $moveToTrash = this.$el.find('input[type=checkbox]#filter-move-to-trash');
				var $radioMbox = this.$el.find('input[type=radio]#send_selbox');
				var $asRead = this.$el.find('input[type=checkbox]#add-filter-as-read');
				var $asImportant = this.$el.find('input[type=checkbox]#add-filter-as-important');
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				if ($moveToMbox.is(':checked')) {
					this.$el.find('#overlay').hide();
				}
				if ($moveToTrash.is(':checked')) {
					this.$el.find('#overlay').show();
				}
				var $sender = this.$el.find('input#add-filter-sender');
				var $to = this.$el.find('input#add-filter-to');
				var $cc = this.$el.find('input#add-filter-cc');
				var $to_cc = this.$el.find('input#add-filter-to_cc');
				var $subject = this.$el.find('input#add-filter-subject');
				var $content = this.$el.find('input#add-filter-content');
				var $attached = this.$el.find('input[type=checkbox]#add-filter-attached');
				if ($to.val() || $cc.val() || $to_cc.val()) {
					$toggleRcptFilters.find('img').addClass('sOpen'); // [-]
					$rcptFilters.find('li').not('li.input_write').show();
				}
				if ($content.val() || $attached.is(':checked')) {
					$toggleContentFilter.find('img').addClass('sOpen'); // [-]
					$contentFilters.find('li').not('li.input_write').show();
				}
				$moveToMbox.change(function() {
					if ($(this).is(':checked')) {
						$moveToTrash.removeAttr('checked');
						self.$el.find('#overlay').hide();
					} else {
						self.$el.find('#overlay').show();
					}
					$radioMbox.prop('checked', true);
				});
				var $inputNewMbox = this.$el.find('input[type=text]#new-mbox');
				$moveToTrash.change(function() {
					if ($(this).is(':checked')) {
						$radioMbox.prop('checked', true);
						$moveToMbox.removeAttr('checked');
						$inputNewMbox.val('');
						$($asRead).add($asImportant).removeAttr('checked');
						self.$el.find('#overlay').show();
					}
				});
				$toggleRcptFilters.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $img = $(this).find('img');
					if ($img.is('.sOpen')) {
						$img.removeClass('sOpen');
						$rcptFilters.find('li').not('li.input_write').hide();
					} else {
						$img.addClass('sOpen');
						$rcptFilters.find('li').not('li.input_write').show();
					}
				});
				$toggleContentFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $img = $(this).find('img');
					if ($img.is('.sOpen')) {
						$img.removeClass('sOpen');
						$contentFilters.find('li').not('li.input_write').hide();
					} else {
						$img.addClass('sOpen');
						$contentFilters.find('li').not('li.input_write').show();
					}
				});
				$asRead.click(function() {
					$moveToTrash.removeAttr('checked');
				});
				$asImportant.click(function() {
					$moveToTrash.removeAttr('checked');
				});
				var $showContactLayer = this.$el.find('a.show-contact-layout');
				$showContactLayer.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$showContactLayer.each(function() {
						$(this).removeClass($(this).data('filter-id'));
					});
					var $this = $(this);
					$this.addClass($this.data('filter-id'));
					if (self.filtersContactLayoutView) {
						self.filtersContactLayoutView.close();
					}
					self.filtersContactLayoutView = new settings.FiltersContactLayoutView({
						model : self.userModel, // app.userModel
					})
					var $offsetParent = self.$el.offsetParent();
					var $filtersContactLayoutView = self.filtersContactLayoutView.render().$el;
					$filtersContactLayoutView.show().appendTo($offsetParent);
					var $viewport = $(window);
					$viewport.off('resize.filtersContactLayout');
					$viewport.on('resize.filtersContactLayout', function(event) {
						var parentWidth = $offsetParent.width() / 2;
						var parentHeight = $offsetParent.height() / 2;
						var width = $filtersContactLayoutView.width() / 2;
						var height = $filtersContactLayoutView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$filtersContactLayoutView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.filtersContactLayout');
				});
				var $save = this.$el.find('button.filter-settings-save');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $el = self.$el;
					var sender = $sender.val(), to = $to.val(), cc = $cc.val();
					var to_cc = $to_cc.val(), subject = $subject.val();
					var content = $content.val(), attached = $attached.is(':checked');
					if (!sender && !to && !cc && !to_cc && !subject && !content && !attached) {
						alert(i18n.filters.checkForClassification);
						return;
					}
					if (!$moveToMbox.is(':checked') && !$moveToTrash.is(':checked') && !$asRead.is(':checked')
							&& !$asImportant.is(':checked')) {
						alert(i18n.filters.selectForPhaseTwoClassification);
						return;
					}
					var mboxName = $.trim($inputNewMbox.val());
					var $moveToNewMbox = $el.find('input[type=radio]#move-new-mbox');
					if ($moveToNewMbox.is(':checked') && !mboxName) {
						alert(i18n.filters.inputForMailboxName);
						return;
					}
					var $previousMail = $el.find('input[name=exst_mail]:checked');
					if ($previousMail.is(':checked') && $previousMail.val() == 1) {
						if (!confirm(i18n.filters.mailApplyToPreviousClassificationChange)) {
							return;
						}
					}
					settings.overlayView.showSaving();
					var mboxIdx;
					var $mboxList = $el.find('select[name=send_selbox]');
					var $mboxSelected = $mboxList.find('option:selected');
					if ($moveToNewMbox.is(':checked') && mboxName) {
						var mboxModel = self.mboxCollection.findModel('MBOX_NAME', mboxName);
						if (!mboxModel) {
							// create mbox
							self.mboxCollection.create({
								MBOX_NAME : mboxName,
							}, {
								async : false,
								wait : true,
								success : function(data) {
									if (data && data.get) {
										mboxIdx = data.get('MBOX_IDX');
									}
								}
							});
						} else {
							mboxIdx = mboxModel.get('MBOX_IDX');
						}
					} else if ($moveToMbox.is(':checked') && $mboxList.is(':enabled')) {
						mboxIdx = $mboxSelected.val();
					} else if ($moveToTrash.is(':checked')) {
						var trashBox = self.mboxCollection.findModel('MBOX_TYPE', 3);
						mboxIdx = trashBox.get('MBOX_IDX');
					}
					var options = {};
					if (!self.model) {
						self.model = new app.mail.AutoDivisionModel({});
					} else {
						options.patch = true;
					}
					options.wait = true;
					options.async = false;
					var params = {};
					params.AUTODIVISION_TYPE = -1;
					params.MBOX_IDX = mboxIdx;
					params.ATTACHED = ($attached.is(':checked') ? 1 : 0);
					params.AS_READ = ($asRead.is(':checked') ? 1 : 0);
					params.AS_IMPORTANT = ($asImportant.is(':checked') ? 1 : 0);
					params.PREVIOUS = $previousMail.val();
					var $inputTexts = self.$el.find('li input[type=text]');
					$inputTexts.each(function(index, element) {
						var $inputText = $(element);
						var name = $inputText.attr('name');
						var value = $inputText.val();
						if (value && value.length > 1)
							params[name] = value;
					});
					self.model.save(params, options);
					settings.overlayView.hideSaving();
					alert(i18n.filters.patchSuccess);
					self.close();
					app.vent.trigger('fetch:filters-settings-view');
				});
				var $close = this.$el.find('.filter-settings-close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
				});
			},
		}); // settings.AddFiltersSettingsView

		settings.FiltersContactLayoutView = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'add_layertbl group_add',
			attributes : {
				style : 'right:503px; top :184px; display:none; position: absolute;',
			},
			template : function(data) {
				var html, compiledTemplate = settings.FiltersContactLayoutView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-contact-layout-template').html();
					compiledTemplate = _.template(html);
					settings.FiltersContactLayoutView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			regions : {
				favoritesTreeRegion : '.mc-bookmark .filters-favorites-tree-container',
				orgTreeRegion : '.mc-orgTree .filters-org-tree-container',
				shareGroupTreeRegion : '.mc-orgTree .filters-share-group-tree-container',
				contactTreeRegion : '.mc-orgTree .filters-contact-tree-container',
			},
			initialize : function(options) {
				// this.model == Some Model
				this.listenTo(app.vent, 'close:filter-contact-layout', this.closeLayoutView);
			},
			onRender : function() {
				var self = this;
				this.showFavoritesTreeView();
				this.showOrgTreeView();
				this.showShareContactTreeView();
				this.showContactTreeView();
				var $tabs = this.$el.find('table.mc-orgTab td a');
				var $favoritesFieldset = this.$el.find('fieldset.filters-mc-bookmark');
				var $treeFieldset = this.$el.find('fieldset.filters-mc-orgTree');
				$tabs.eq(1).parent().addClass('on');
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$tabs.parent().removeClass('on');
					var $this = $(this);
					$this.parent().addClass('on');
					if ($this.hasClass('tree-tab-favorites')) {
						$favoritesFieldset.show();
						self.favoritesTreeRegion.$el.show();
						$treeFieldset.hide();
						self.orgTreeRegion.$el.hide();
						self.shareGroupTreeRegion.$el.hide();
						self.contactTreeRegion.$el.hide();
					} else if ($this.hasClass('tree-tab-organize')) {
						$favoritesFieldset.hide();
						self.favoritesTreeRegion.$el.hide();
						$treeFieldset.show();
						self.orgTreeRegion.$el.show();
						self.shareGroupTreeRegion.$el.hide();
						self.contactTreeRegion.$el.hide();
					} else if ($this.hasClass('tree-tab-share-contacts')) {
						$favoritesFieldset.hide();
						self.favoritesTreeRegion.$el.hide();
						$treeFieldset.show();
						self.orgTreeRegion.$el.hide();
						self.shareGroupTreeRegion.$el.show();
						self.contactTreeRegion.$el.hide();
					} else if ($this.hasClass('tree-tab-contacts')) {
						$favoritesFieldset.hide();
						self.favoritesTreeRegion.$el.hide();
						$treeFieldset.show();
						self.orgTreeRegion.$el.hide();
						self.shareGroupTreeRegion.$el.hide();
						self.contactTreeRegion.$el.show();
						self.showContactTreeView();
					}
				});
				var $close = this.$el.find('.filter-contact-close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
				});
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			onShow : function() {
				var self = this;
				var orgGroupCollection = new app.org.OrgGroupCollection();
				orgGroupCollection.fetch({
					success : function(collection, response, options) {
						var isOrgVisible = false, isSharedContactsVisible = false;
						collection.find(function(model, index) {
							if (model.get('USER_GROUP_STRUCTURE') === 1) {
								isOrgVisible = true;
								return true;
							}
						});
						collection.find(function(model, index) {
							if (model.get('USER_GROUP_ADDRESS') === 1) {
								isSharedContactsVisible = true;
								return true;
							}
						});
						var userAuth = app.userModel.get('USERS_AUTH');
						if (userAuth == 'U' && !isOrgVisible) {
							self.$el.find('#orgTab02').hide();
						}
						if (userAuth == 'U' && !isSharedContactsVisible) {
							self.$el.find('#orgTab03').hide();
						}
					},
					error : function(model, response, options) {
						alert('Failed to fetch Organizational Groups');
					}
				});

			},
			showFavoritesTreeView : function() {
				var self = this;
				var contactCollection = new app.contact.AddressCollection();
				contactCollection.url += '/importants';
				contactCollection.fetch({
					async : false,
				});
				this.favoritesTreeRegion.show(new settings.FavoriteContactsView({
					collection : contactCollection,
					parentView : this,
				}));
			},
			showOrgTreeView : function() {
				var self = this;
				var orgRootEntryModel = new app.org.OrgEntryModel({
					id : 'root'
				});
				orgRootEntryModel.fetch();
				this.listenTo(orgRootEntryModel, 'change', function() {
					var attributes = orgRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.org.OrgEntryCollection(member);
					self.orgTreeRegion.show(new settings.FiltersOrgTreeRootView({
						model : orgRootEntryModel,
						collection : collection,
						parentView : self,
					}));
				});
			},
			showShareContactTreeView : function() {
				var self = this;
				var contactRootEntryModel = new app.contact.ShareEntryModel({
					id : 'root',
				});
				contactRootEntryModel.fetch();
				this.listenTo(contactRootEntryModel, 'change', function() {
					var attributes = contactRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.contact.ShareEntryCollection(member);
					self.shareGroupTreeRegion.show(new settings.FiltersShareContactTreeRootView({
						model : contactRootEntryModel,
						collection : collection,
						parentView : self,
					}));
				});
			},
			showContactTreeView : function() {
				var self = this;
				if (!this.contactTreeRegion.$el) {
					this.contactRootEntryModel = new app.contact.ContactEntryModel({
						id : 'root',
					});
					this.contactTreeRegion.show(new settings.FiltersContactTreeRootView({
						model : this.contactRootEntryModel,
						collection : null,
						parentView : this,
					}));
					this.isToFetchContactRootEntry = true;
					return;
				}
				if (!this.isToFetchContactRootEntry) {
					return;
				}
				this.trigger('show:loading-contacts');
				this.contactRootEntryModel.set('id', 'root');
				this.contactRootEntryModel.fetch({
					success : function(model, response, options) {
						self.isToFetchContactRootEntry = false;
					},
				});
				this.listenToOnce(this.contactRootEntryModel, 'change', function() {
					var attributes = this.contactRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.contact.ContactEntryCollection(member);
					this.contactTreeRegion.show(new settings.FiltersContactTreeRootView({
						model : this.contactRootEntryModel,
						collection : collection,
						parentView : this,
					}));
				});
			},
			closeLayoutView : function() {
				this.close();
			},
		}); // settings.FiltersContactLayoutView

		settings.FavoriteContactItemView = Backbone.Marionette.ItemView.extend({
			tagName : "li",
			template : function(data) {
				var html, compiledTemplate = settings.FavoriteContactItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-favorite-contacts-item-template').html();
					compiledTemplate = _.template(html);
					settings.FavoriteContactItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $checkbox = this.$el.children('input:checkbox');
				var $label = this.$el.children('label:first');
				$label.click(function() {
					var mail = self.$el.data('mail');
					var $openerContactBtn = $('a.show-contact-layout');
					if ($openerContactBtn.is('.contact-sender')) {
						$('input#add-filter-sender').val(mail);
					} else if ($openerContactBtn.is('.contact-rcpt-to')) {
						$('input#add-filter-to').val(mail);
					} else if ($openerContactBtn.is('.contact-rcpt-cc')) {
						$('input#add-filter-cc').val(mail);
					} else if ($openerContactBtn.is('.contact-rcpt-to-cc')) {
						$('input#add-filter-to_cc').val(mail);
					}
					app.vent.trigger('close:filter-contact-layout');
				});
				this.$el.data('oc', 'user'); // objectClass
				if (self.model.get('ADDRESS_EMAIL')) {
					this.$el.data('mail', self.model.get('ADDRESS_EMAIL'));
				}
				if (self.model.get('ADDRESS_NAME')) {
					this.$el.data('cn', self.model.get('ADDRESS_NAME'));
				}
			},
		}); // settings.FavoriteContactItemView

		settings.FavoriteContactsView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html = '';
				html += '<ul class="favorite-contacts-list"></ul>';
				return html;
			},
			itemView : settings.FavoriteContactItemView,
			itemViewContainer : "ul.favorite-contacts-list:first",
			initialize : function(options) {
				this.parentView = options.parentView;
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var mail = $item.data('mail');
				var isDuplicate = false;
				collectionView.$el.find('li').each(function() {
					if (mail == $(this).data('mail')) {
						isDuplicate = true;
						return false;
					}
				});
				var name = itemView.model.get('ADDRESS_NAME');
				if (!isDuplicate && (name && mail)) {
					$list.append($item);
				}
			},
		}); // settings.FavoriteContactsView

		settings.FiltersOrgTreeEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, compiledTemplate = settings.FiltersOrgTreeEntryView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-org-entry-template').html();
					compiledTemplate = _.template(html);
					settings.FiltersOrgTreeEntryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.org.OrgEntryModel
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = this.$el.children('.orgNode');
				var $label = this.$el.find('label.lbtxt');
				var $list = this.$el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function() {
					var objectClass = self.$el.data('oc');
					if (objectClass == 'user') {
						var mail = self.$el.data('mail');
						var $openerContactBtn = $('a.show-contact-layout');
						if ($openerContactBtn.is('.contact-sender')) {
							$('input#add-filter-sender').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-to')) {
							$('input#add-filter-to').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-cc')) {
							$('input#add-filter-cc').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-to-cc')) {
							$('input#add-filter-to_cc').val(mail);
						}
						app.vent.trigger('close:filter-contact-layout');
					}
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email-address
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common
						// name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email
						// address
						this.$el.data('mail', attributes.mail[0]);
				}
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				$list.append($item);
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
		});// settings.FiltersOrgTreeEntryView

		settings.FiltersOrgTreeRootView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.FiltersOrgTreeRootView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-org-root-template').html();
					compiledTemplate = _.template(html);
					settings.FiltersOrgTreeRootView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			itemView : settings.FiltersOrgTreeEntryView,
			itemViewContainer : "ul.orgDepth1:first",
			initialize : function(options) {
				// this.model == app.org.OrgEntryModel
				this.parentView = options.parentView; // settings.FiltersContactLayoutView
			},
			onRender : function() {
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
		}); // settings.FiltersOrgTreeRootView

		settings.FiltersShareContactTreeEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, selfView = settings.FiltersShareContactTreeEntryView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-share-contacts-entry-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.contact.SharedGroupModel
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = this.$el.children('.orgNode');
				var $label = this.$el.find('label.lbtxt');
				var $list = this.$el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function() {
					var objectClass = self.$el.data('oc');
					if (objectClass == 'user') {
						var mail = self.$el.data('mail');
						var $openerContactBtn = $('a.show-contact-layout');
						if ($openerContactBtn.is('.contact-sender')) {
							$('input#add-filter-sender').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-to')) {
							$('input#add-filter-to').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-cc')) {
							$('input#add-filter-cc').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-to-cc')) {
							$('input#add-filter-to_cc').val(mail);
						}
						app.vent.trigger('close:filter-contact-layout');
					}
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '#' + attributes.cn[0]); // email-address
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common
						// name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email
						// address
						this.$el.data('mail', attributes.mail[0]);
				}
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				if ($item.data('mail')) {
					$list.append($item);
				}
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
		}); // settings.FiltersShareContactTreeEntryView

		settings.FiltersShareContactTreeRootView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, selfView = settings.FiltersShareContactTreeRootView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-share-contacts-root-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			itemView : settings.FiltersShareContactTreeEntryView,
			itemViewContainer : "ul.orgDepth1:first",
			initialize : function(options) {
				this.parentView = options.parentView; // app.TopPanelView
			},
			onRender : function() {
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
		}); // settings.FiltersShareContactTreeRootView

		settings.FiltersContactTreeEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, compiledTemplate = settings.FiltersContactTreeEntryView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-contacts-entry-template').html();
					compiledTemplate = _.template(html);
					settings.FiltersContactTreeEntryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.contact.ContactEntryModel
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = this.$el.children('.orgNode');
				var $label = this.$el.find('label.lbtxt');
				var $list = this.$el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							var $loading = $('<img>', {
								'src' : 'img/ico_ld_cm.gif',
								'class' : 'tchk'
							}).appendTo($el);
							self.model.fetch({
								success : function(model, response, options) {
									if (!model.member || model.member.length === 0)
										$loading.remove();
								},
								error : function(model, response, options) {
									$loading.remove();
								},
							});
							self.listenToOnce(self.model, 'change', function() {
								$loading.remove();
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							var $loading = $('<img>', {
								'src' : 'img/ico_ld_cm.gif',
								'class' : 'tchk'
							}).appendTo($el);
							self.model.fetch({
								success : function(model, response, options) {
									if (!model.member || model.member.length === 0)
										$loading.remove();
								},
								error : function(model, response, options) {
									$loading.remove();
								},
							});
							self.listenToOnce(self.model, 'change', function() {
								$loading.remove();
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function() {
					var objectClass = self.$el.data('oc');
					if (objectClass == 'user') {
						var mail = self.$el.data('mail');
						var $openerContactBtn = $('a.show-contact-layout');
						if ($openerContactBtn.is('.contact-sender')) {
							$('input#add-filter-sender').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-to')) {
							$('input#add-filter-to').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-cc')) {
							$('input#add-filter-cc').val(mail);
						} else if ($openerContactBtn.is('.contact-rcpt-to-cc')) {
							$('input#add-filter-to_cc').val(mail);
						}
						app.vent.trigger('close:filter-contact-layout');
					}
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common name
						this.$el.data('mail', '#' + attributes.cn[0]); // email-address
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email address
						this.$el.data('mail', attributes.mail[0]);
				}
			},
			initRenderBuffer : function() {
				this.elBuffer = document.createDocumentFragment();
			},
			appendHtml : function(collectionView, itemView, index) {
				if (collectionView.isBuffering) {
					collectionView.elBuffer.appendChild(itemView.el);
				} else {
					collectionView.$el.append(itemView.el);
				}
			},
			appendBuffer : function(collectionView, buffer) {
				this.$itemViewContainer = collectionView.$("ul:first");
				this.$itemViewContainer.append(buffer);
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
		}); // settings.FiltersContactTreeEntryView

		settings.FiltersContactTreeRootView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.FiltersContactTreeRootView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#filters-contacts-root-template').html();
					compiledTemplate = _.template(html);
					settings.FiltersContactTreeRootView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			itemView : settings.FiltersContactTreeEntryView,
			itemViewContainer : "ul.orgDepth1:first",
			initialize : function(options) {
				this.parentView = options.parentView; // app.TopPanelView
				this.listenTo(this.parentView, 'show:loading-contacts', this.showLoading);
			},
			onRender : function() {
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					case 'user':
					default:
						if (lastItem)
							$item.removeClass().addClass('orgNode_elbow');
						else
							$item.removeClass().addClass('orgNode_join');
					}
				});
			},
			showLoading : function() {
				this.$loading = $('<img>', {
					'src' : 'img/ico_ld_cm.gif',
					'style' : 'vertical-align: middle;'
				}).appendTo(this.$el.children('span.orgCorp'));
			},
			initRenderBuffer : function() {
				this.elBuffer = document.createDocumentFragment();
			},
			appendHtml : function(collectionView, itemView, index) {
				if (collectionView.isBuffering) {
					collectionView.elBuffer.appendChild(itemView.el);
				} else {
					collectionView.$el.append(itemView.el);
				}
			},
			appendBuffer : function(collectionView, buffer) {
				this.$itemViewContainer = collectionView.$(this.itemViewContainer);
				this.$itemViewContainer.append(buffer);
			},
			appendRecipients : function() {
				var $toggle = this.$el.find('span.orgCorp input[type=checkbox]');
				var $checkboxes = this.$el.find('ul.orgDepth1 li input[type="checkbox"]:checked');
				var recipients = [];
				$checkboxes.each(function(index, element) {
					var $checkbox = $(element);
					var $item = $checkbox.parent();
					var rcpt = {
						type : $item.data('oc'),
						personal : $item.data('cn'),
						address : $item.data('mail'),
					};
					recipients.push(rcpt);
				});
				$toggle.prop('checked', false);
				$checkboxes.prop('checked', false);
				this.parentView.trigger('add:recipients', recipients);
			},
		}); // settings.FiltersContactTreeRootView

		settings.SignatureRegisterView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 800px; display: none; position: absolute;',
			},
			template : function(data) {
				var html, compiledTemplate = settings.SignatureRegisterView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#signature-settings-register-template').html();
					compiledTemplate = _.template(html);
					settings.SignatureRegisterView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					signature : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.SignatureModel
				// this.collection == mail.SignatureCollection
			},
			onShow : function() {
				this.editorView.onShow();
				var content = this.model.get('SIGN_STMT');
				if (content)
					this.editorView.setContent(content);
				var $title = this.$el.find('input:text[name=sign_name]');
				$title.focus().blur();
			},
			onBeforeRender : function() {
				settings.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this;
				this.editorView = new settings.DaumEditorView();
				this.editorView.render();
				var $editorContainer = this.$el.find('.mc-editorFrame:first');
				$editorContainer.append(this.editorView.$el);
				$editorContainer.on('dragenter', function(event) {
					var dataTransfer = event.originalEvent.dataTransfer;
					var types = dataTransfer.types;
					if (types) {
						if ((types.contains && types.contains("Files"))
								|| (types.indexOf && types.indexOf("Files") !== -1)) {
							event.preventDefault();
							app.debug('Daum Editor dragenter <<<<<<<<<<<<<<<<<<<<<<<<<<');
						}
					}
				});
				$editorContainer.on('dragover', function(event) {
					event.preventDefault() && event.stopPropagation();
					app.debug('Daum Editor dragover <<<<<<<<<<<<<<<<<<<<<<<');
					return false;
				});
				$editorContainer.on('drop', function(event) {
					event.preventDefault() && event.stopPropagation();
					app.debug('Daum Editor drop <<<<<<<<<<<<<<<<<<<<<<<');
					var files = event.originalEvent.dataTransfer.files;
					$.each(files, function(index, file) {
						if (file.type.indexOf('image/') != -1)
							return;
						self.attachmentsView.addAttachment(file);
					});
					var cids = [];
					var formData = new FormData();
					$.each(files, function(index, file) {
						if (file.type.indexOf('image/') == -1)
							return;
						var name = cid + '.' + index;
						if (file.name && file.name.indexOf('.') != -1)
							name += file.name.substring(file.name.lastIndexOf('.'));
						cids.push(name);
						formData.append(name, file);
					});
					var url = 'inline';
					var xhr = new XMLHttpRequest();
					xhr.open('POST', url);
					xhr.upload.onprogress = function(event) {
						// _showOverlay();
					};
					xhr.upload.onabort = function(event) {
						// _hideOverlay();
					};
					xhr.upload.onload = function(event) {
						var $div = $('<div />');
						$.each(cids, function(index, cid) {
							$div.empty();
							var src = 'inline/';
							if (isPopup())
								src = '../inline/';
							var $img = $('<img>', {
								'src' : src + cid,
								'border' : '0',
							});
							$div.append($img);
							var content = $div.html();
							// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Canvas.html#pasteContent
							Editor.getCanvas().pasteContent(content, true);
						});
						// _hideOverlay();
					};
					xhr.send(formData);
					return false;
				});
				var $save = this.$el.find('div.ad_btn_area button.layer_save');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $title = self.$el.find('input:text[name=sign_name]');
					var content = self.editorView.getContent();
					if (!$title.val() || $title.val().length < 1) {
						alert(i18n.signature.invaildName);
						$title.focus();
						return false;
					}
					if (!content || content.length < 1) {
						alert(i18n.signature.invaildContent);
						return false;
					}
					var bodyText = content;
					var regExp = /[_0-9a-zA-Z-]+[_a-z0-9-.]{2,}@[a-z0-9-]{2,}(.[a-z0-9]{2,})*/i;
					var match = regExp.exec(bodyText);
					while (match) {
						var domain = app.domainModel.get('DOMAIN');
						if (domain != match[0].substring(match[0].indexOf('@') + 1)) {
							alert(i18n.signature.invaildDomain + match[0]);
							return false;
						} else {
							bodyText = bodyText.substring(match.index + match[0].length);
							match = regExp.exec(bodyText);
						}
					}
					var patch = false;
					if (self.model.get('SIGN_IDX'))
						patch = true;
					self.model.save({
						SIGN_TITLE : $title.val(),
						SIGN_STMT : content,
					}, {
						patch : patch,
						wait : true,
						async : false,
						success : function(model, response, options) {
							var userModel = app.userModel;
							app.userModel = app.userModel.clone();
							app.userModel.set({
								USERS_SIGNATURE : 'Y',
							});
							app.vent.trigger('show:signature-settings');
							app.userModel = userModel;
							self.close();
						},
						error : function(model, response, options) {
							alert(i18n.signature.failedToSave);
						},
					});
					return false;
				});
				var $previewBtn = this.$el.find('div.ad_btn_area button.layer_preview');
				$previewBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $title = self.$el.find('input:text[name=sign_name]');
					var content = self.editorView.getContent();
					content = self.model._validateHTML(content);
					var frag = document.createDocumentFragment();
					var $content = $('<div></div>', frag).html(content);
					$content.find('*').filter(function(index, element) {
						return self.model.filterElements(index, element);
					});
					self.model.set({
						SIGN_TITLE : $title.val(),
						SIGN_STMT : $content.html(),
					});
					if (self.signaturePreviewView) {
						self.signaturePreviewView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.signaturePreviewView = new settings.SignaturePreview({
						model : self.model,
					});
					var $signaturePreviewView = self.signaturePreviewView.render().$el;
					$signaturePreviewView.css('z-index', parseInt(zIndex) + 1);
					$signaturePreviewView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.signaturePreviewView');
					$viewport.on('resize.signaturePreviewView', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $signaturePreviewView.width() / 2;
						var height = $signaturePreviewView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$signaturePreviewView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.signaturePreviewView');
					return false;
				});
				var $close = this.$el.find('div.close_bt:first');
				var $cancel = this.$el.find('div.ad_btn_area button.layer_cancle');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
			onClose : function() {
				settings.overlayView.hideOverlay();
			},
		}); // settings.SignaturePreview

		settings.SignaturePreview = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'edit_layer',
			attributes : {
				style : 'width: 700px; display: none;',
			},
			template : function(data) {
				var html, compiledTemplate = settings.SignaturePreview.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#signature-settings-preview-template').html();
					compiledTemplate = _.template(html);
					settings.SignaturePreview.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					signature : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.mboxCollection
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('.close-preview-rename:first');
				var $cancel = this.$el.find('.confirm-preview-rename:first');
				$($close).add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
		}); // settings.SignaturePreview

		settings.SignatureSettingsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			className : 'signature-item',
			template : function(data) {
				var html, compiledTemplate = settings.SignatureSettingsItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#signature-settings-item-template').html();
					compiledTemplate = _.template(html);
					settings.SignatureSettingsItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					signature : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(app.vent, 'signature:updateDefault', this.updateSignature);
			},
			onRender : function() {
				var self = this;
				var $previewBtn = this.$el.find('#previewSignature');
				var $modifyBtn = this.$el.find('#modifySignature');
				var $deleteBtn = this.$el.find('#deleteSignature');
				$deleteBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = i18n.signature.deleteSignature;
					if (confirm(msg)) {
						self.model.destroy({
							async : false,
							wait : true,
						});
					}
					var userModel = app.userModel;
					app.userModel = app.userModel.clone();
					app.userModel.set({
						USERS_SIGNATURE : 'Y',
					});
					app.userModel = userModel;
				});

				$previewBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.signaturePreviewView) {
						self.signaturePreviewView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.signaturePreviewView = new settings.SignaturePreview({
						model : self.model,
					});
					var $signaturePreviewView = self.signaturePreviewView.render().$el;
					$signaturePreviewView.css('z-index', parseInt(zIndex) + 1);
					$signaturePreviewView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.signaturePreviewView');
					$viewport.on('resize.signaturePreviewView', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $signaturePreviewView.width() / 2;
						var height = $signaturePreviewView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$signaturePreviewView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.signaturePreviewView');
					return false;
				});
				$modifyBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.signatureRegisterView) {
						self.signatureRegisterView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.signatureRegisterView = new settings.SignatureRegisterView({
						model : self.model,
						collection : self.collection,
					});
					var $signatureRegisterView = self.signatureRegisterView.render().$el;
					$signatureRegisterView.css('z-index', parseInt(zIndex) + 1);
					$signatureRegisterView.show().appendTo('body');
					self.signatureRegisterView.onShow();
					var $viewport = $(window);
					$viewport.off('resize.signatureRegisterView');
					$viewport.on('resize.signatureRegisterView', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $signatureRegisterView.width() / 2;
						var height = $signatureRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$signatureRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.signatureRegisterView');
					return false;
				});
			},
			updateSignature : function() {
				var $radio = this.$el.find('input[name="sign_name"]');
				var SIGN_DEFAULT;
				if ($radio.is(":checked")) {
					SIGN_DEFAULT = "1";
				} else {
					SIGN_DEFAULT = "0";
				}

				var SIGN_DEFAULT = this.model.save({
					SIGN_DEFAULT : SIGN_DEFAULT,
				}, {
					patch : true,
					wait : true,
					async : false,
				});

			},
		}); // settings.SignatureSettingsItemView

		settings.SignatureSettingsView = Backbone.Marionette.CompositeView.extend({
			itemView : settings.SignatureSettingsItemView,
			itemViewContainer : '#signatureList',
			template : function(data) {
				var html, compiledTemplate = settings.SignatureSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#signature-settings-template').html();
					compiledTemplate = _.template(html);
					settings.SignatureSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : app.userModel.toJSON(),
					signatures : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = SignatureCollection
			},
			onRender : function() {
				var self = this;
				var $registerBtn = this.$el.find('#sign_bt');
				var $useRadio = this.$el.find('input[name="sign_ex"]');
				var $customSigns = this.$el.find('.my_sign');
				$useRadio.change(function(event) {
					event.stopPropagation();
					var checkedVal = $useRadio.filter(':checked').val();
					if (checkedVal == 'N') {
						$customSigns.hide();
						$registerBtn.hide();
					} else if (checkedVal == 'Y') {
						$customSigns.show();
						$registerBtn.show();
					}
				});
				$useRadio.change();
				$registerBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.collection.size() >= 3) {
						alert(i18n.signature.noMoreThanThree);
						return false;
					}
					if (self.signatureRegisterView) {
						self.signatureRegisterView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.signatureRegisterView = new settings.SignatureRegisterView({
						model : new app.mail.SignatureModel(),
						collection : self.collection,
					});
					var $signatureRegisterView = self.signatureRegisterView.render().$el;
					$signatureRegisterView.css('z-index', parseInt(zIndex) + 1);
					$signatureRegisterView.show().appendTo('body');
					self.signatureRegisterView.onShow();
					var $viewport = $(window);
					$viewport.off('resize.signatureRegisterView');
					$viewport.on('resize.signatureRegisterView', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $signatureRegisterView.width() / 2;
						var height = $signatureRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$signatureRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.signatureRegisterView');
					return false;
				});
				var $defaultBtn = this.$el.find('#defaultBtn');
				$defaultBtn.click(function(event) {
					$useRadio.filter('[value="N"]').click();
				});
				var $cancelBtn = this.$el.find('#cancelBtn');
				$cancelBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});
				var $saveBtn = this.$el.find('#saveBtn');
				$saveBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $signatureRadio = self.$el.find('tr.signature-item input[name="sign_name"]');
					var USERS_SIGNATURE = $useRadio.filter(':checked').val();
					if (USERS_SIGNATURE == 'Y' && !$signatureRadio.is(':checked')) {
						alert('서명을 선택해 주세요.');
						return false;
					}
					app.userModel.save({
						USERS_SIGNATURE : USERS_SIGNATURE,
					}, {
						patch : true,
						wait : true,
						async : false,
					});
					if (USERS_SIGNATURE == 'Y') {
						app.vent.trigger('signature:updateDefault');
					}
					alert(i18n.signature.saved);
				});
			},
		}); // settings.SignatureSettingsView

		settings.RecipientGroupItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = settings.RecipientGroupItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#recipient-group-item-template').html();
					compiledTemplate = _.template(html);
					settings.RecipientGroupItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					recipientGroup : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = contact.RecipientGroupModel
				this.recipientGroupCollection = this.options.recipientGroupCollection;
			},
			onRender : function() {
				var self = this;
				var $compose = this.$el.find('div.txt_bt a.recipient-group-compose');
				$compose.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var to = [], cc = [], bcc = [];
					var $list = self.$el.find('td.mlst ul.inlst li');
					$list.each(function(index, element) {
						switch ($(this).attr('class')) {
						case 'to':
							to.push($(this).text());
							break;
						case 'cc':
							cc.push($(this).text());
							break;
						case 'bcc':
							bcc.push($(this).text());
							break;
						}
					});
					location.hash = 'compose?' + $.param({
						to : to,
						cc : cc,
						bcc : bcc,
					}, true);
					return false;
				});
				var $modify = this.$el.find('div.txt_bt a.recipient-group-modify');
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.recipientGroupRegisterView) {
						self.recipientGroupRegisterView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.recipientGroupRegisterView = new settings.RecipientGroupRegisterView({
						model : self.model,
						collection : self.recipientGroupCollection,
					});
					var $recipientGroupRegisterView = self.recipientGroupRegisterView.render().$el;
					$recipientGroupRegisterView.css('z-index', parseInt(zIndex) + 1);
					$recipientGroupRegisterView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.recipientGroupRegister');
					$viewport.on('resize.recipientGroupRegister', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $recipientGroupRegisterView.width() / 2;
						var height = $recipientGroupRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$recipientGroupRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.recipientGroupRegister');
					return false;
				});
				var $remove = this.$el.find('div.txt_bt a.recipient-group-remove');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = self.model.get('name') + i18n.recipientGroup.deleteRecipientGroup;
					if (!confirm(msg)) {
						return false;
					}
					self.model.destroy({
						wait : true,
						success : function(model, response, options) {
							self.recipientGroupCollection.fetch();
						},
						error : function(model, response, options) {
							alert(i18n.recipientGroup.failedToDelete);
						},
					});
					return false;
				});
			},
		}); // settings.RecipientGroupItemView

		settings.RecipientGroupSettingsView = Backbone.Marionette.CompositeView.extend({
			tagName : 'div',
			className : 'setting_tab',
			itemView : settings.RecipientGroupItemView,
			itemViewOptions : function(model, index) {
				return {
					recipientGroupCollection : this.collection,
				}
			},
			itemViewContainer : 'table.set_tbl tbody.recipient-group',
			template : function(data) {
				var html, compiledTemplate = settings.RecipientGroupSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#recipient-group-settings-template').html();
					compiledTemplate = _.template(html);
					settings.RecipientGroupSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					recipientGroups : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = contact.RecipientGroupCollection
				// this.collection = contact.RecipientGroupCollection
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $toggle = this.$el.find('thead tr.f input:checkbox.multi_chk_all');
				var $checkboxes = this.$itemViewContainer.find('td.clk input[name=recipient-group-id]');
				$toggle.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
					$checkboxes.change();
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length)
							$toggle.prop('checked', true);
					} else {
						$toggle.removeAttr('checked');
					}
				});
				var $compose = this.$el.find('div.new_mail_area button.compose');
				$compose.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var to = [], cc = [], bcc = [];
					var $rows = $checkboxes.filter(':checked');
					if ($rows.length == 0) {
						alert(i18n.recipientGroup.pleaseCheckRecipientGroup);
						return false;
					}
					$rows.each(function(index, element) {
						if (!this.checked)
							return;
						var $list = $(this).parent().siblings('td.mlst').find('ul.inlst li');
						$list.each(function(index, element) {
							switch ($(this).attr('class')) {
							case 'to':
								to.push($(this).text());
								break;
							case 'cc':
								cc.push($(this).text());
								break;
							case 'bcc':
								bcc.push($(this).text());
								break;
							}
						});
					});
					location.hash = 'compose?' + $.param({
						to : to,
						cc : cc,
						bcc : bcc,
					}, true);
					return false;
				});
				var $remove = this.$el.find('div.new_mail_area button.remove');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $rows = $checkboxes.filter(':checked');
					if ($rows.length == 0) {
						alert(i18n.recipientGroup.pleaseCheckRecipientGroup);
						return false;
					}
					var msg = i18n.recipientGroup.deleteRecipientGroup;
					if (!confirm(msg)) {
						return false;
					}
					var count = 0;
					$rows.each(function(index, element) {
						if (!this.checked)
							return;
						var recipientGroupModel = self.collection.findModel('id', $(this).val());
						recipientGroupModel.destroy({
							wait : true,
							success : function(model, response, options) {
								count++;
								if ($rows.length == count)
									self.collection.fetch();
							},
							error : function(model, response, options) {
								alert(i18n.recipientGroup.failedToDelete);
							},
						});
					});
					return false;
				});
				var $add = this.$el.find('div.new_mail_area button.add');
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.recipientGroupRegisterView) {
						self.recipientGroupRegisterView.close();
					}
					var zIndex = settings.overlayView.$overlay.css('z-index');
					self.recipientGroupRegisterView = new settings.RecipientGroupRegisterView({
						model : new app.contact.RecipientGroupModel(),
						collection : self.collection,
					});
					var $recipientGroupRegisterView = self.recipientGroupRegisterView.render().$el;
					$recipientGroupRegisterView.css('z-index', parseInt(zIndex) + 1);
					$recipientGroupRegisterView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.recipientGroupRegister');
					$viewport.on('resize.recipientGroupRegister', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $recipientGroupRegisterView.width() / 2;
						var height = $recipientGroupRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$recipientGroupRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.recipientGroupRegister');
					return false;
				});
			},
		}); // settings.RecipientGroupSettingsView

		settings.RecipientAddressItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = settings.RecipientAddressItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#recipient-address-item-template').html();
					compiledTemplate = _.template(html);
					settings.RecipientAddressItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					recipientAddress : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $remove = this.$el.find('a:first');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.remove();
					return false;
				});
			},
		});

		settings.RecipientGroupRegisterView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'mc-dh_layer',
			attributes : {
				style : 'left: 20%; top: 20%; width: 550px',
			},
			template : function(data) {
				var html, compiledTemplate = settings.RecipientGroupRegisterView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#recipient-group-register-template').html();
					compiledTemplate = _.template(html);
					settings.RecipientGroupRegisterView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					recipientGroup : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == contact.RecipientGroupModel
				// this.collection = settings.RecipientGroupCollection
				this.listenTo(app.vent, 'add-to:recipient-group', this.addRecipientAddress);
			},
			onBeforeRender : function() {
				if (!settings.overlayView) {
					settings.overlayView = new settings.OverlayView();
					settings.overlayView.render();
				}
				settings.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this;
				_.each(this.model.get('recipientAddresses'), function(recipientAddress) {
					var address = recipientAddress.name ? recipientAddress.name : '';
					if (address)
						address = '"' + address + '" ' + '<' + recipientAddress.email + '>';
					else
						address = recipientAddress.email;
					var recipientAddressItemView = new settings.RecipientAddressItemView({
						model : new Backbone.Model({
							address : address,
							type : recipientAddress.type,
						}),
					});
					var $ul = self.$el.find('div.add_box.' + recipientAddress.type + ' ul.' + recipientAddress.type);
					$ul.append(recipientAddressItemView.render().el);
				});
				var $names = this.$el.find('input[type=text].ipt_nm');
				var $emails = this.$el.find('input[type=text].ipt_em');
				$names.add($emails).placeholder();
				var $add = this.$el.find('div.add_direct button.button_s');
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $name, $email, type;
					if ($(this).hasClass('to')) {
						$name = self.$el.find('input[name=recipient-to-name]');
						$email = self.$el.find('input[name=recipient-to-email]');
						type = 'to';
					} else if ($(this).hasClass('cc')) {
						$name = self.$el.find('input[name=recipient-cc-name]');
						$email = self.$el.find('input[name=recipient-cc-email]');
						type = 'cc';
					} else if ($(this).hasClass('bcc')) {
						$name = self.$el.find('input[name=recipient-bcc-name]');
						$email = self.$el.find('input[name=recipient-bcc-email]');
						type = 'bcc';
					}
					var expr = /^((\w|[\-\.])+)@((\w|[\-\.])+)\.([A-Za-z]+)$/;
					if (!$email.val() || $email.val().length < 1 || !expr.test($email.val())) {
						alert(i18n.recipientGroup.pleaseEnterEmailMatch);
						$email.focus();
						return false;
					}
					var address = $name.val() ? $name.val() : '';
					if (address)
						address = '"' + address + '" ' + '<' + $email.val() + '>';
					else
						address = $email.val();
					if (self.checkDuplicate(address, type)) {
						$name.add($email).val('');
						return false;
					}
					var recipientAddressItemView = new settings.RecipientAddressItemView({
						model : new Backbone.Model({
							address : address,
							type : type,
						}),
					});
					var $ul = self.$el.find('div.add_box.' + type + ' ul.' + type);
					$ul.append(recipientAddressItemView.render().el);
					$name.add($email).val('');
					return false;
				});
				var $contacts = this.$el.find('td button.popup-contacts');
				$contacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $to = self.$el.find('input[name=recipient-address-to]');
					var $cc = self.$el.find('input[name=recipient-address-cc]');
					var $bcc = self.$el.find('input[name=recipient-address-bcc]');
					$to.add($cc).add($bcc).val('');
					var $list = self.$el.find('div.add_box ul.slt_lst li span');
					$list.each(function(index, element) {
						switch ($(this).attr('class')) {
						case 'to':
							var to = $to.val();
							to += $(this).text() + ',';
							$to.val(to);
							break;
						case 'cc':
							var cc = $cc.val();
							cc += $(this).text() + ',';
							$cc.val(cc);
							break;
						case 'bcc':
							var bcc = $bcc.val();
							bcc += $(this).text() + ',';
							$bcc.val(bcc);
							break;
						}
					});
					var url = 'popup/contacts';
					if (isPopup())
						url = '../popup/contacts';
					var openedWindow = window.open(url, 'mailContacts', 'width=800,height=600,resizable=yes');
					openedWindow.focus();
					return false;
				});
				var $save = this.$el.find('div.addButton button.save');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $name = self.$el.find('input[name=recipient-group-name]');
					if (!$name.val() || $name.val().length < 1) {
						alert(i18n.recipientGroup.pleaseEnterGroupName);
						$name.focus();
						return false;
					}
					var $list = self.$el.find('div.add_box ul.slt_lst li span');
					if (!$list || $list.length == 0) {
						alert(i18n.recipientGroup.pleaseInputRecipientAddress);
						return false;
					}
					var patch = false;
					if (self.model.get('id'))
						patch = true;
					self.model.save({
						name : $name.val(),
					}, {
						patch : patch,
						wait : true,
						async : false,
						success : function(model, response, options) {
							self.saveRecipientAddress($list);
							self.close();
							if (self.collection)
								self.collection.fetch();
							else
								alert(i18n.recipientGroup.successReigsterRecipientGroup);
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 409:
								alert(i18n.recipientGroup.recipientGroupAlreadyExists + ': ' + $name.val());
								break;
							default:
								alert(i18n.recipientGroup.failedToSave);
								break;
							}
						},
					});
				});
				var $close = this.$el.find('div.hTitle a:first');
				var $cancel = this.$el.find('div.addButton button.cancel');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
			onClose : function() {
				settings.overlayView.hideOverlay();
			},
			checkDuplicate : function(address, type) {
				var $list = this.$el.find('div.add_box ul.slt_lst li span.' + type);
				var isDuplicate = false;
				$list.each(function(index, element) {
					if (address && $.trim(address) == $.trim($(this).text())) {
						isDuplicate = true;
						return false;
					}
				});
				return isDuplicate;
			},
			saveRecipientAddress : function($list) {
				var self = this;
				var recipientAddressSaveHash = {}, recipientAddressDeleteHash = {};
				var createRecipientAddresses = [], selectedRecipientAddressIds = [], recipientAddresses = [];
				$list.each(function(index, element) {
					var recipientAddressId = $(this).data('recipient-address-id');
					var address = [];
					try {
						address = InternetAddress.parseHeader($.trim($(this).text()), false);
					} catch (error) {
						return;
					}
					var recipientAddress = {
						id : recipientAddressId || 0,
						groupId : self.model.get('id'),
						name : address[0].getPersonal() || '',
						email : address[0].getAddress(),
						type : $(this).attr('class'),
					};
					if (recipientAddress.id)
						selectedRecipientAddressIds.push(recipientAddress.id);
					else
						createRecipientAddresses.push(recipientAddress);
				});
				recipientAddresses = this.model.get('recipientAddresses');
				recipientAddressSaveHash[this.model.get('id')] = createRecipientAddresses;
				recipientAddressDeleteHash[this.model.get('id')] = _.difference(_.pluck(recipientAddresses, 'id'),
						selectedRecipientAddressIds);
				var url = 'recipient-addresses';
				if (isPopup())
					url = '../recipient-addresses';
				var model = new (app.BackboneModel.extend({
					url : url,
				}))();
				model.save(recipientAddressSaveHash, {
					async : false,
					wait : true,
				});
				model = new (app.BackboneModel.extend({
					url : function() {
						url += '?model=' + encodeURIComponent(JSON.stringify(recipientAddressDeleteHash));
						return url;
					},
					defaults : {
						id : 'recipient-addresses'
					}
				}))();
				model.destroy({
					async : false,
					wait : true,
				});
			},
			addRecipientAddress : function(model) {
				var recipientAddressItemView = new settings.RecipientAddressItemView({
					model : model
				});
				var type = model.get('type');
				var $ul = this.$el.find('div.add_box.' + type + ' ul.' + type);
				$ul.append(recipientAddressItemView.render().el);
			}
		});

		settings.DaumEditorView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'tx_trex_container_signature',
			className : 'tx-editor-container-signature',
			template : function(data) {
				var html, compiledTemplate = settings.DaumEditorView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#signature-editor-template').html();
					compiledTemplate = _.template(html);
					settings.DaumEditorView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					basePath : 'js/lib/daumeditor-7.5.11/',
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				// do nothing
			},
			onShow : function() {
				var config = {
					// 런타임 시 리소스들을 로딩할 때 필요한 부분으로, 경로가 변경되면 이 부분 수정이 필요.
					// ex) http://xxx.xxx.com
					txHost : '',
					// 런타임 시 리소스들을 로딩할 때 필요한 부분으로, 경로가 변경되면 이 부분 수정이 필요.
					// ex) /xxx/xxx/
					txPath : '',
					txService : 'sample', // 수정필요없음.
					txProject : 'sample',
					// 대부분의 경우에 빈문자열
					initializedId : "_signature",
					// 에디터를 둘러싸고 있는 레이어 이름(에디터 컨테이너)
					wrapper : "tx_trex_container_signature",
					// 등록하기 위한 Form 이름 ex) tx_editor_form
					form : 'signature_form',
					// 에디터에 사용되는 이미지 디렉터리, 필요에 따라 수정한다.
					txIconPath : "js/lib/daumeditor-7.5.11/images/icon/editor/",
					// 본문에 사용되는 이미지 디렉터리, 서비스에서 사용할 때는 완성된 컨텐츠로 배포되기 위해 절대경로로
					// 수정한다.
					txDecoPath : "js/lib/daumeditor-7.5.11/images/deco/contents/",
					canvas : {
						styles : {
							color : "#000000", // 기본 글자색
							fontFamily : "굴림", // 기본 글자체
							fontSize : "10pt", // 기본 글자크기
							backgroundColor : "#fff", // 기본 배경색
							lineHeight : "1.5", // 기본 줄간격
							padding : "8px" // 위지윅 영역의 여백
						},
						showGuideArea : false
					},
					events : {
						preventUnload : false
					},
					sidebar : {
						attachbox : {
							show : true
						}
					},
					size : {
					// 지정된 본문영역의 넓이가 있을 경우에 설정
					// contentWidth : 700
					}
				};
				if (this.$el.is(':visible')) {
					if (settings.DaumEditorView.contentWidth) {
						config.size.contentWidth = settings.DaumEditorView.contentWidth;
					}
					var editor = new Editor(config);
					Editor.switchEditor(config.initializedId);
					if (!settings.DaumEditorView.viewportWidth) {
						settings.DaumEditorView.viewportWidth = $(window).width();
						settings.DaumEditorView.containerWidth = Editor.getCanvas().getContainerWidth();
					}
					$(window).off('resize.signature-editor').on('resize.signature-editor', function(event) {
						var $this = $(this);
						var namespace = settings.DaumEditorView;
						var viewportWidth = namespace.viewportWidth;
						var containerWidth = namespace.containerWidth;
						var diff = viewportWidth - $this.width();
						namespace.contentWidth = containerWidth - diff;
					}).trigger('resize.signature-editor');
				}
			},
			getContent : function() {
				var content = Editor.getCanvas().panels['html'].getContent();
				return content;
			},
			setContent : function(content) {
				if (this.$el.is(':visible')) {
					Editor.getCanvas().observeJob(Trex.Ev.__IFRAME_LOAD_COMPLETE, function() {
						Editor.modify({
							content : content
						});
					});
				}
			},
		}); // settings.DaumEditorView

		TrexConfig.addTool('inline-image', {});
		Trex.Tool.InlineImage = Trex.Class.create({
			$const : {
				__Identity : 'inline-image'
			},
			$extend : Trex.Tool,
			oninitialized : function(config) {
				var _tool = this;
				var _showOverlay = function() {
					var $overlay = $('#inline-images-overlay');
					if (!$overlay.length) {
						$overlay = $('<div id="inline-images-overlay"/>').css({
							'z-index' : 2015,
							'position' : 'fixed',
							'top' : '0',
							'left' : '0',
							'width' : '100%',
							'height' : '100%',
							'background' : '#000',
							'opacity' : '0.5',
							'filter' : 'alpha(opacity=50)'
						}).appendTo('body');
						$overlay.on('mousedown', function(event) {
							event.preventDefault() && event.stopPropagation();
						});
						var $loadingOverlay = $('<div id="loading-inline-images"/>').css({
							'z-index' : 2016,
							'position' : 'fixed',
							'text-align' : 'center'
						}).appendTo($overlay);
						var url = isPopup() ? '../img' : 'img';
						var $loadingOuter = $('<span />').css({
							'display' : 'inline-block',
							'background' : 'transparent url(' + url + '/loading_span_bg.png) no-repeat',
							'background-position' : 'left top',
							'padding-left' : '2px',
						}).appendTo($loadingOverlay);
						var $loadingInner = $('<span />').css({
							'display' : 'inline-block',
							'background' : 'transparent url(' + url + '/loading_span_bg.png) no-repeat',
							'background-position' : 'right -49px',
							'padding-right' : '2px',
						}).appendTo($loadingOuter);
						var $loadingContent = $('<span />').css({
							'display' : 'inline-block',
							'background' : 'transparent url(' + url + '/loading_span_bg.png) repeat-x',
							'background-position' : 'left -98px',
							'line-height' : '39px',
							'padding' : '0 18px 0 9px',
							'color' : '#fff',
						}).appendTo($loadingInner);
						var src = isPopup() ? '../img' : 'img';
						$loadingContent.append($('<img />', {
							src : src + '/ico_ld_cm.gif',
							width : 17,
							height : 17,
							style : 'vertical-align: middle; margin-right: 10px',
						}));
						$loadingContent.append('<strong>' + i18n.editor.image + '</span>');
						$loadingContent.append(document.createTextNode(i18n.editor.uploading));

						var $viewport = $(window);
						$viewport.resize(function(event) {
							var viewportWidth = $viewport.width() / 2;
							var viewportHeight = $viewport.height() / 2;
							var width = $loadingOverlay.width() / 2;
							var height = $loadingOverlay.height() / 2;
							var top = Math.floor(viewportHeight - height);
							var left = Math.floor(viewportWidth - width);
							$loadingOverlay.css({
								'top' : top,
								'left' : left,
							});
						});
						$viewport.resize();
					}
					$overlay.show();
				}; // var _showOverlay = function() {...}
				var _hideOverlay = function() {
					var $overlay = $('#inline-images-overlay');
					$overlay.hide();
				};
				var _cid = function() {
					var now = Date.now ? Date.now() : new Date().getTime();
					var random = Math.floor(Math.random() * 1000000);
					return now + '.' + random;
				};
				var $fileInput = $('body > input#inline_images');
				if ($fileInput.length) {
					$fileInput.remove();
				}
				$fileInput = $('<input>', {
					'id' : 'inline_images',
					'type' : 'file',
					'accept' : 'image/*',
					'multiple' : 'true',
					'style' : 'position: absolute; top: -10000px; left: -10000px;'
				}).appendTo('body');
				$fileInput.change(function(event) {
					_showOverlay();
					var $this = $(this);
					var files = this.files;
					var cid = _cid(), cids = [];
					var formData = new FormData();
					$.each(files, function(index, file) {
						var name = cid + '.' + index;
						if (file.name && file.name.indexOf('.') != -1)
							name += file.name.substring(file.name.lastIndexOf('.'));
						cids.push(name);
						formData.append(name, file);
					});
					var url = 'inline';
					var xhr = new XMLHttpRequest();
					xhr.open('POST', url);
					xhr.upload.onprogress = function(event) {
						// _showOverlay();
					};
					xhr.upload.onabort = function(event) {
						_hideOverlay();
					};
					xhr.upload.onload = function(event) {
						var $div = $('<div />');
						$.each(cids, function(index, cid) {
							$div.empty();
							var src = 'inline/';
							var $img = $('<img>', {
								'src' : src + cid,
								'border' : '0',
							});
							$div.append($img);
							var content = $div.html();
							// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Canvas.html#pasteContent
							Editor.getCanvas().pasteContent(content, true);
						});
						$fileInput.val('');
						_hideOverlay();
					};
					xhr.send(formData);
				}); // $fileInput.change(function(event) {...});
				if (!$fileInput[0].files && !document.inlineImageUploadIframe) {
					$('<iframe>', {
						'name' : 'inlineImageUploadIframe',
						'src' : 'inline/form',
						'style' : 'position: absolute; display: none;',
					}).appendTo('body');
				}
				var _toolHandler = function() {
					if ($fileInput[0].files) {
						$fileInput.click();
						return;
					}
					if (document.inlineImageUploadIframe) {
						var iframe = document.inlineImageUploadIframe;
						var form = iframe.inlineImageUploadForm;
						if (!form || !form.inline)
							return;
						var changed = false;
						form.inline.onchange = function() {
							changed = true;
							return false;
						};
						form.inline.click();
						if (!changed) {
							return;
						}
						form.submit();
						_showOverlay();
						app.vent.once('inline-image:uploaded', function(cid) {
							_hideOverlay();
							var iframe = document.inlineImageUploadIframe;
							var pathname = iframe.location.pathname;
							var url = pathname.substring(0, pathname.lastIndexOf('/')) + '/form';
							iframe.location.replace(url);
							if (!cid) {
								alert(i18n.attachment.cannotUpload);
								return;
							}
							var $div = $('<div />');
							var src = 'inline/';
							var $img = $('<img>', {
								'src' : src + cid,
								'border' : '0',
							});
							$div.append($img);
							var content = $div.html();
							// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Canvas.html#pasteContent
							Editor.getCanvas().pasteContent(content, true);
						});
						return;
					} // end if (document.inlineImageUploadIframe)
				}; // var _toolHandler = function() {...};
				var _initHandler = function() {
					// Not Callbacked
					// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Tool.html
				};
				this.weave.bind(this)(new Trex.Button(this.buttonCfg), null, _toolHandler, _initHandler);
			} // oninitialized = function(config) {...}
		}); // Trex.Tool.InlineImage = Trex.Class.create({...});

		settings.VacationSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html;
				var compiledTemplate = settings.VacationSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					var templateID = '#vacation-settings-template';
					html = settings.$template.filter(templateID).html();
					compiledTemplate = _.template(html);
					settings.VacationSettingsView.compiledTemplate = compiledTemplate;
				}
				if (data.approverCollection) {
					html = compiledTemplate({
						config : app.config,
						user : data.userModel.toJSON(),
						approvers : data.approverCollection.toJSON(),
						i18n : i18n,
					});
				} else {
					html = compiledTemplate({
						config : app.config,
						user : data.userModel.toJSON(),
						i18n : i18n,
					});
				}
				return html;
			},
			initialize : function(options) {
				this.userModel = this.model.get('userModel');
				if (app.config.approvalMail.enabled) {
					this.approverCollection = this.model.get('approverCollection');
				}
				this.parentView = options.parentView;
				this.listenTo(app.vent, 'append:deputy-receiver', this.appendDeputyReceiver);
				this.listenTo(app.vent, 'append:deputy-approver', this.appendDeputyApprover);
			},
			onRender : function() {
				var self = this;
				this._initDate();
				var _changeVacationTabMenu = function() {
					var isApprover = false;
					if (self.approverCollection && self.approverCollection.length > 0) {
						isApprover = true;
					}
					self.parentView.trigger('change:vacation-menu', isApprover);
				};
				_changeVacationTabMenu();
				var $vacationResponseUse = this.$el.find('input[name=vacation-response-use]');
				var $tableVacationResponseSettings = this.$el.find('table.vacation-response-settings');
				$vacationResponseUse.change(function() {
					if (this.value === '1') {
						$tableVacationResponseSettings.show();
					} else {
						$tableVacationResponseSettings.hide();
					}
				});
				var $addExternalEmail = this.$el.find('button.add-external-mails');
				$addExternalEmail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $inputExternalEmail = self.$el.find('input[name=out_mail_add]');
					var externalEmail = $.trim($inputExternalEmail.val());
					var expr = '^([\\w-]+(?:\\.[\\w-]+)*)@';
					expr += '((?:[\\w-]+\\.)*\\w[\\w-]{0,66})\\.([a-z]{2,6}(?:\\.[a-z]{2})?)$';
					var matcher = new RegExp(expr);
					if (!matcher.test(externalEmail)) {
						alert(i18n.spam.checkMailFormat);
						$inputExternalEmail.val('');
						$inputExternalEmail.focus();
						return false;
					}
					var internalDomain = self.model.get('DOMAIN');
					if (externalEmail.indexOf(internalDomain) != -1) {
						alert(i18n.vacationResponse.pleaseAddInternalUser);
						$inputExternalEmail.val('');
						$inputExternalEmail.focus();
						return false;
					}
					self.appendDeputyReceiver(externalEmail);
				});
				var $addUsers = this.$el.find('button.add-internal-users').add(
						this.$el.find('button.add-deputy-approver'));
				$addUsers.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var flag;
					if ($this.hasClass('add-internal-users')) {
						flag = 'vacation-response';
					} else {
						flag = 'deputy-approver';
					}
					self.parentView.trigger('show:add-internal-user', flag);
					var $orgContainer = self.parentView.internalUserSettingsRegion.$el;
					$orgContainer.toggle();
					$orgContainer.attr('hidable', false);
					self.setPositionSettingsLayer($orgContainer);
					$(window).resize(function() {
						self.setPositionSettingsLayer($orgContainer);
					});
				});
				var $deleteDeputyReceiver = this.$el.find('button.delete-deputy-receiver');
				$deleteDeputyReceiver.click(function() {
					var $deputyReceiverList = self.$el.find('ul.deputy-receiver-list li');
					var $deleteCheckboxes = $deputyReceiverList.find('input[type=checkbox]:checked');
					$deleteCheckboxes.each(function() {
						$(this).closest('li').remove();
					});
				});
				var $deputyApproverUse = this.$el.find('input[name=deputy-approver-use]');
				var $tableDeputyApproverSettings = this.$el.find('table.deputy-approver-settings');
				$deputyApproverUse.change(function() {
					if (this.value === '1') {
						$tableDeputyApproverSettings.show();
					} else {
						$tableDeputyApproverSettings.hide();
					}
				});
				var $samePeriod = this.$el.find('input#same-period');
				$samePeriod.change(function() {
					var $responseStartDate = self.$el.find('input.vacation-response-start-date');
					var $responseEndDate = self.$el.find('input.vacation-response-end-date');
					var $deputyApproverStartDate = self.$el.find('input.deputy-approver-start-date');
					var $deputyApproverEndDate = self.$el.find('input.deputy-approver-end-date');
					if (this.checked) {
						$deputyApproverStartDate.val($responseStartDate.val());
						$deputyApproverEndDate.val($responseEndDate.val());
					} else {
						$deputyApproverStartDate.val('');
						$deputyApproverEndDate.val('');
					}
				});
				var $deputyRecipientsUse = this.$el.find('input[name=proxy_use]');
				var $deputyRecipientProxySettings = this.$el.find('div.out_setProxy_ly');
				$deputyRecipientsUse.change(function() {
					var $this = $(this);
					if ($this.is(':checked'))
						$deputyRecipientProxySettings.show();
					else
						$deputyRecipientProxySettings.hide();
				});
				$deputyRecipientsUse.change();
				var $save = this.$el.find('button.save-settings');
				$save.click(function() {
					var vacationResponseEnabled = $vacationResponseUse.filter(':checked').val() === '1';
					var vacationResponseAttr = {
						USERS_ABSENT : vacationResponseEnabled ? 'Y' : 'N',
					};
					if (vacationResponseEnabled) {
						var $deputyRecipientsUse = self.$el.find('input[name=proxy_use]');
						var $responseStartDate = self.$el.find('input.vacation-response-start-date');
						var $responseEndDate = self.$el.find('input.vacation-response-end-date');
						var startDate = $.format.date($responseStartDate.val(), 'yyyyMMdd');
						var endDate = $.format.date($responseEndDate.val(), 'yyyyMMdd');
						if (!startDate || !endDate) {
							alert(i18n.vacationResponse.checkInvalidDate);
							$responseStartDate.focus();
							return false;
						}
						if ((startDate && endDate) && startDate > endDate) {
							alert(i18n.vacationResponse.endDayLessThanStartDate);
							$responseStartDate.focus();
							return false;
						}
						var deputyReceivers = [];
						var $deputyReceiverList = self.$el.find('ul.deputy-receiver-list');
						$deputyReceiverList.find('label').each(function() {
							var $label = $(this);
							var email = $.trim($label.text());
							if (email == self.model.get('USERS_IDX')) {
								alert(i18n.vacationResponse.exceptSelfRecipient);
								return false;
							}
							deputyReceivers.push(email);
						});
						if ($deputyRecipientsUse.is(':checked') && deputyReceivers.length == 0) {
							alert(i18n.vacationResponse.pleaseCheckProxyRecipient);
							return false;
						}
						var $vacationResponseMsg = self.$el.find('textarea.vacation-response-msg');
						var message = $.trim($vacationResponseMsg.val());
						if (!message || message.length == 0) {
							alert(i18n.vacationResponse.setNotificationMessage);
							return false;
						}
						vacationResponseAttr['USERS_OPT_AUTORE'] = $deputyRecipientsUse.is(':checked') ? 'Y' : 'N';
						if (vacationResponseAttr['USERS_OPT_AUTORE'] == 'Y')
							vacationResponseAttr['USERS_AUTORE_LIST'] = deputyReceivers.join(',');
						vacationResponseAttr['USERS_ABSENT_SDATE'] = startDate;
						vacationResponseAttr['USERS_ABSENT_EDATE'] = endDate;
						vacationResponseAttr['USERS_ABSENT_RESTMT'] = message.replace(/\n/g, '<br>');
					}
					self.userModel.save(vacationResponseAttr, {
						wait : true,
						patch : true,
						success : function(model, response, options) {
							if (app.config.approvalMail.enabled) {
								var status = $deputyApproverUse.filter(':checked').val() === '1';
								var deputyApproverAttr = {
									status : status,
								};
								if (status) {
									var $deputyApproverStartDate = self.$el.find('input.deputy-approver-start-date');
									var $deputyApproverEndDate = self.$el.find('input.deputy-approver-end-date');
									var deputyApproverStartDate = $.format.date($deputyApproverStartDate.val(),
											'yyyy-MM-dd');
									var deputyApproverEndDate = $.format.date($deputyApproverEndDate.val(),
											'yyyy-MM-dd');
									if (!deputyApproverStartDate || !deputyApproverEndDate) {
										alert(i18n.vacationResponse.checkInvalidDate);
										$deputyApproverStartDate.focus();
										return false;
									}
									if ((deputyApproverStartDate && deputyApproverEndDate)
											&& deputyApproverStartDate > deputyApproverEndDate) {
										alert(i18n.vacationResponse.endDayLessThanStartDate);
										$deputyApproverStartDate.focus();
										return false;
									}
									var $deputyApproverName = self.$el.find('input[name=deputy-approver-name]');
									var deputyApproverName = $deputyApproverName.val();
									if (!deputyApproverName || deputyApproverName.length === 0) {
										alert(i18n.deputyApproval.pleaseSelectDeputyApprover);
										$deputyApproverName.focus();
										return false;
									}
								}
								deputyApproverAttr['startTime'] = deputyApproverStartDate;
								deputyApproverAttr['endTime'] = deputyApproverEndDate;
								deputyApproverAttr['deputyApprover'] = deputyApproverName;
								if (app.config.approvalMail.enabled) {
									var approverModel = new (app.BackboneModel.extend({
										url : 'approval/approvers/deputy-approver',
										defaults : {
											id : 'deputy-approver',
										},
									}))();
									approverModel.save(deputyApproverAttr, {
										wait : true,
										patch : true,
										async : false,
									});
								}
							}
							alert(i18n.vacationResponse.patchSuccess);
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 400:
								alert(i18n.vacationResponse.patchFailed);
								break;
							}
						}
					});
				});
				var $setDefault = this.$el.find('button.set-default');
				$setDefault.click(function() {
					$vacationResponseUse.filter('[value=0]').click();
					if (app.config.approvalMail.enabled) {
						$deputyApproverUse.filter('[value=0]').click();
					}
				});
			},
			_initDate : function() {
				var $responseStartDate = this.$el.find('input.vacation-response-start-date');
				var $responseEndDate = this.$el.find('input.vacation-response-end-date');
				var startDate = this.userModel.get('USERS_ABSENT_SDATE') || '';
				var endDate = this.userModel.get('USERS_ABSENT_EDATE') || '';
				startDate = startDate.indexOf('0000') != -1 ? '' : startDate;
				endDate = endDate.indexOf('0000') != -1 ? '' : endDate;
				$responseStartDate.val($.format.date(startDate || new Date(), 'yyyy-MM-dd'));
				$responseEndDate.val($.format.date(endDate || new Date(), 'yyyy-MM-dd'));
				$responseStartDate.datepicker(i18n.datepicker.options);
				$responseEndDate.datepicker(i18n.datepicker.options);

				var $deputyApproverStartDate = this.$el.find('input.deputy-approver-start-date');
				var $deputyApproverEndDate = this.$el.find('input.deputy-approver-end-date');
				$deputyApproverStartDate.datepicker(i18n.datepicker.options);
				$deputyApproverEndDate.datepicker(i18n.datepicker.options);
			},
			appendDeputyReceiver : function(receiveEmail) {
				var $inputExternalEmail = this.$el.find('input[name=out_mail_add]');
				var $deputyReceiverList = this.$el.find('ul.deputy-receiver-list');
				var existsEmail = false;
				$deputyReceiverList.find('label').each(function() {
					var $this = $(this);
					if ($this.text() == receiveEmail) {
						existsEmail = true;
						return false;
					}
				});
				if (!existsEmail) {
					var id = "deputy-receiver-" + receiveEmail;
					var li = '<li><input id="' + id + '" type="checkbox">';
					li += '<label for="' + id + '">' + receiveEmail + '</label></li>';
					$deputyReceiverList.append(li);
				}
				$inputExternalEmail.val('');
			},
			appendDeputyApprover : function(deputyApproverName) {
				var $deputyApproverName = this.$el.find('input[name=deputy-approver-name]');
				$deputyApproverName.val(deputyApproverName);
			},
			setPositionSettingsLayer : function($shareSettingsLayer) {
				var $viewport = $(window);
				var viewportWidth = $viewport.width();
				var viewportHeight = $viewport.height();
				var scrollTop = $viewport.scrollTop();
				var scrollLeft = $viewport.scrollLeft();
				var layerWidth = $shareSettingsLayer.width();
				var layerHeight = $shareSettingsLayer.height();
				var top, left, marginTop, marginLeft;

				if (viewportHeight > layerHeight) {
					top = "50%";
					marginTop = -(layerHeight / 2) + scrollTop + "px";
				} else {
					top = scrollTop + "px";
					marginTop = "0";
				}
				if (viewportWidth > layerWidth) {
					left = "50%";
					marginLeft = -(layerWidth / 2) + scrollLeft + "px";
				} else {
					left = scrollLeft + "px";
					marginLeft = "0";
				}
				$shareSettingsLayer.css({
					position : 'absolute',
					top : top,
					left : left,
					'margin-top' : marginTop,
					'margin-left' : marginLeft
				});
			},
		}); // settings.VacationSettingsView

		settings.VacationResponseOrgSettingsLayout = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var $template = settings.$template;
				var templateID = '#vacation-response-org-settings-layout-template';
				var html = $template.filter(templateID).html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					flag : data.flag,
					i18n : i18n,
				});
				return html;
			},
			regions : {
				headerRegion : '#shareGroupHeader',
				orgTreeRegion : '#groupOrgTreeWrapping',
				orgUserSearchRegion : '#shareGroupUserSearch',
				orgUserListRegion : '#shareGroupUserList',
				orgRecipientsRegion : '#share_people',
				footerRegion : '#shareGroupFooter',
				paginationRegion : '.page_ctrl',
			},
			initialize : function(options) {
				this.userModel = this.model.get('userModel');
				this.flag = this.model.get('flag');
				this.contentLayoutView = options.parentView;
				this.listenTo(app.vent, 'paginate:shared-org-entries', this.showOrgUserListView);
				this.listenTo(app.vent, 'fetch:shared-recipients', this.showOrgRecipientsView);
				this.listenTo(this, 'update:shared-recipients-count', this.updateRecipientsCount);
			},
			onRender : function() {
				var self = this;
				this.headerRegion.show(new settings.VacationResponseOrgHeaderView({
					model : new Backbone.Model({
						flag : this.flag,
					}),
					contentLayoutView : this.contentLayoutView,
				}));
				var orgRootEntryModel = new app.org.OrgEntryModel({
					id : 'root'
				});
				orgRootEntryModel.fetch();
				this.listenTo(orgRootEntryModel, 'change', function() {
					var attributes = orgRootEntryModel.get('attributes');
					var member = attributes.member;
					var collection = new app.org.OrgEntryCollection(member);
					self.orgTreeRegion.show(new settings.VacationResponseOrgTreeRootView({
						model : orgRootEntryModel,
						collection : collection,
						parentView : self,
					}));
				});
				this.orgUserSearchRegion.show(new settings.VacationResponseOrgUserSearchView({
					model : orgRootEntryModel,
					parentView : this,
				}));
				this.showOrgUserListView();
				this.orgRecipientsRegion.show(new settings.VacationResponseOrgRecipientsListView({
					userModel : this.userModel,
					parentView : this,
				}));
				this.footerRegion.show(new settings.VacationResponseOrgSettingsFooterView({
					model : this.userModel, // app.userModel,
					flag : this.flag,
					contentLayoutView : this.contentLayoutView,
				}));
				// // Buttons: append [->] | remove [<-]
				var $append = this.$el.find('.btn_add');
				var $remove = this.$el.find('.btn_remove');
				var $checkAll = this.$el.find('#all_check');
				$append.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trigger('append:recipients');
					$checkAll.removeProp('checked');
				});
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trigger('remove:recipients');
				});
				$checkAll.click(function(event) {
					var checked = $(this).is(':checked');
					self.trigger('check:share-group-org-list', checked);
				});
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			showOrgUserListView : function(params) {
				var self = this;
				var paginator = new app.org.OrgEntryPaginator();
				if (params && params.url) {
					paginator.paginator_core.url = params.url;
					delete params.url;
				}
				var url = 'org/root/entries';
				// if (params && (params.search || !params.groupId)) {
				// paginator.paginator_core.url = url;
				// }
				if (!params) {
					params = {};
					params.parentGroupId = "";
					paginator.paginator_core.url = url;
				}
				params._method = 'GET';
				paginator.setParams(params);
				paginator.fetch({
					success : function(collection, response, options) {
						collection.pager();
						var shareOrgListView = new settings.VacationResponseOrgUserListView({
							model : new Backbone.Model({
								userModel : self.userModel, // app.userModel
								flag : self.flag,
							}),
							collection : paginator,
							parentView : self,
						});
						self.orgUserListRegion.show(shareOrgListView);
						// Pagination
						var paginationView = new settings.VacationResponseOrgPaginationView({
							collection : paginator,
						});
						self.paginationRegion.show(paginationView);
					},
					silent : true,
				});
			},
			updateRecipientsCount : function(recipientsCount) {
				this.$el.find('.org-group-recipients-count').text(recipientsCount);
			}
		}); // settings.VacationResponseOrgSettingsLayout

		settings.VacationResponseOrgHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var $template = settings.$template;
				var html = $template.filter('#vacation-response-org-header-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					group : data,
					flag : data.flag,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.contentLayoutView = options.contentLayoutView;
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('a#txt_pop_close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contentLayoutView.trigger('hide:share-settings-layout');
				});
			},
		}); // settings.VacationResponseOrgHeaderView

		settings.VacationResponseOrgPaginationView = Backbone.Marionette.ItemView.extend({
			initialize : function(options) {
				// this.collection == org.OrgEntryPaginator
				this.collection.on('reset', this.render, this);
			},
			render : function() {
				var html, selfView = settings.VacationResponseOrgPaginationView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = settings.$template;
					html = $template.filter('#vacation-response-org-settings-pagination-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				this.$el.html(html);
				var $firstPage = this.$el.find('a.btn_first');
				$firstPage.click($.proxy(this.gotoFirst, this));
				var $prevPage = this.$el.find('a.btn_prev');
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = this.$el.find('a.btn_next');
				$nextPage.click($.proxy(this.gotoNext, this));
				var $lastPage = this.$el.find('a.btn_last');
				$lastPage.click($.proxy(this.gotoLast, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.previousPage();
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.nextPage();
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.stopPropagation();
				if (event.which == 13) {
					event.preventDefault();
					var page = $(event.target).val();
					if (this.collection.totalPages >= page) {
						this.collection.goTo(page);
					}
				}
			},
		}); // settings.VacationResponseOrgPaginationView

		settings.VacationResponseOrgTreeEntryView = Backbone.Marionette.CompositeView.extend({
			tagName : "li",
			template : function(data) {
				var html, selfView = settings.VacationResponseOrgTreeEntryView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#vacation-response-org-entry-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.collection = this.model.member;
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var attributes = this.model.get('attributes');
				var $nodeIcon = $el.children('.orgNode');
				var $label = $el.children('label:first');
				var $list = $el.children('ul:first').hide();
				this.applyClassToItems($list.children('li'));
				$nodeIcon.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($el.hasClass('orgNode_p')) { // [+]
						$el.removeClass().addClass('orgNode_m');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_m')) { // [-]
						$el.removeClass().addClass('orgNode_p');
						$list.slideUp();
					} else if ($el.hasClass('orgNode_pBott')) { // [+]
						$el.removeClass().addClass('orgNode_mBott');
						if (self.collection.size() === 0) {
							self.model.fetch();
							self.listenToOnce(self.model, 'change', function() {
								self.applyClassToItems($list.children('li'));
								$list.slideDown();
							});
						} else {
							$list.slideDown();
						}
					} else if ($el.hasClass('orgNode_mBott')) { // [-]
						$el.removeClass().addClass('orgNode_pBott');
						$list.slideUp();
					} else {
						// no action
					}
				});
				$label.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var urlRoot = _.result(self.model, 'urlRoot');
					var url = urlRoot.replace(/([^\/])$/, '$1/') + encodeURIComponent(self.model.id) + '/entries';
					var params = {
						url : url
					};
					app.vent.trigger('paginate:shared-org-entries', params);
				});
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email
						this.$el.data('id', this.model.get('id')); // user_group_idx
					}
				}
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'group')) {
					$list.append($item);
				}
			},
			applyClassToItems : function($items) {
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					}
				});
			}
		}); // settings.VacationResponseOrgTreeEntryView

		settings.VacationResponseOrgTreeRootView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html, selfView = settings.VacationResponseOrgTreeRootView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#vacation-response-org-root-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			itemView : settings.VacationResponseOrgTreeEntryView,
			itemViewContainer : "ul#shareOrgContainer:first",
			initialize : function(options) {
				this.parentView = options.parentView; // settings.VacationResponseOrgSettingsLayout
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.children('ul:first').children('li');
				$items.show();
				$items.each(function(index, element) {
					var $item = $(element);
					var lastItem = index == $items.length - 1 ? true : false;
					var $li = $item.find('ul:first li');
					var objectClass = $item.data('oc');
					switch (objectClass) {
					case 'group':
						if (lastItem)
							$item.removeClass().addClass('orgNode_pBott');
						else
							$item.removeClass().addClass('orgNode_p');
						break;
					}
				});
				var topParentNode = this.$el.find('#topParentNode');
				topParentNode.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var checked = $(this).is(':checked');
					// var urlRoot = _.result(self.model, 'urlRoot');
					// var url = urlRoot.replace(/([^\/])$/, '$1/')
					// + encodeURIComponent(self.model.id) + '/entries';
					app.vent.trigger('paginate:shared-org-entries');
				});
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul.orgDepth1:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (_.contains(objectClass, 'groupOfNames')) {
					$list.append($item);
				}
			},
		}); // settings.VacationResponseOrgTreeRootView

		settings.VacationResponseOrgUserView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, $template = settings.$template;
				html = $template.filter('#vacation-response-org-user-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var attributes = this.model.get('attributes');
				if (_.contains(attributes.objectClass, 'groupOfNames')) {
					this.$el.data('oc', 'group'); // objectClass
					if (attributes.cn && attributes.cn[0]) {
						this.$el.data('cn', attributes.cn[0]); // common
						// name
						this.$el.data('mail', '$' + attributes.cn[0]); // email
						this.$el.data('id', this.model.get('id')); // idx
					}
				} else {
					this.$el.data('oc', 'user'); // objectClass
					if (attributes.cn && attributes.cn[0]) // common
						// name
						this.$el.data('cn', attributes.cn[0]);
					if (attributes.mail && attributes.mail[0]) // email
						// address
						this.$el.data('mail', attributes.mail[0]);
					this.$el.data('id', this.model.get('id')); // idx
				}
			}
		}); // settings.VacationResponseOrgUserView

		settings.VacationResponseOrgUserListView = Backbone.Marionette.CompositeView.extend({
			itemView : settings.VacationResponseOrgUserView,
			itemViewContainer : 'ul',
			template : function(data) {
				var html;
				var selfView = settings.VacationResponseOrgUserListView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = settings.$template;
					html = $template.filter('#vacation-response-org-user-list-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.flag = this.model.get('flag');
				this.parentView = options.parentView; // settings.VacationResponseOrgSettingsLayout
				this.listenTo(this.parentView, 'append:recipients', this.appendRecipients);
				this.listenTo(this.parentView, 'remove:recipients', this.removeRecipients);
				this.listenTo(this.parentView, 'check:share-group-org-list', this.checkChildList);
			},
			onRender : function() {
				var self = this;
				var $checkboxes = this.$el.find('input[type=checkbox]');
				$checkboxes.change(function() {
					var isDeputyApprover = (self.flag && self.flag === 'deputy-approver');
					if (this.checked && isDeputyApprover) {
						if ($checkboxes.filter(':checked').length > 1) {
							alert(i18n.deputyApproval.deputyApproverOnlyOne);
							$(this).prop('checked', false);
							return false;
						}
					}
				});
			},
			appendHtml : function(collectionView, itemView, index) {
				var $list = collectionView.$("ul:first");
				var $item = itemView.$el;
				var objectClass = itemView.model.get('attributes').objectClass;
				if (!_.contains(objectClass, 'group')) {
					$list.append($item);
				}
			},
			appendRecipients : function() {
				var self = this;
				var $checkboxes = this.$el.find('input[type="checkbox"]:checked');
				var recipients = [];
				if ($checkboxes.length > 1 && (self.flag && self.flag === 'deputy-approver')) {
					alert(i18n.deputyApproval.deputyApproverOnlyOne);
					return false;
				}
				$checkboxes.each(function(index, element) {
					var $checkbox = $(element);
					var $item = $checkbox.parent();
					var share = {
						type : $item.data('oc'),
						personal : $item.data('cn'),
						address : $item.data('mail'),
						id : $item.data('id'),
					};
					if ($item.data('mail') == self.model.get('USERS_IDX')) {
						alert(i18n.vacationResponse.exceptSelfRecipient);
						return;
					}
					recipients.push(share);
				});
				$checkboxes.prop('checked', false);
				this.parentView.trigger('add:recipients', recipients);
			},
			removeRecipients : function() {
				this.parentView.trigger('remove:recipient');
			},
			checkChildList : function(checked) {
				var $checkboxes = this.$el.find('input[type="checkbox"]');
				$checkboxes.each(function() {
					if (checked) {
						$(this).prop('checked', checked);
					} else {
						$(this).removeProp('checked');
					}
				});
			}
		}); // settings.VacationResponseOrgUserListView

		settings.VacationResponseOrgUserSearchView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.VacationResponseOrgUserSearchView.compiledTemplate;
				var $template = settings.$template;
				if (!compiledTemplate) {
					html = $template.filter('#vacation-response-org-settings-search-template').html();
					compiledTemplate = _.template(html);
					settings.VacationResponseOrgUserSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $searchInput = this.$el.find('input[type=text]');
				var $searchBtn = this.$el.find('button[type=submit]');
				$searchInput.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						self.filterOrgUsers($(this).val());
					}
				});
				$searchBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.filterOrgUsers($searchInput.val());
				});
			},
			filterOrgUsers : function(keyword) {
				if (keyword && (keyword.indexOf('%') != -1 || keyword.indexOf('_') != -1)) {
					alert(i18n.search.invalidToken);
					return;
				}
				app.vent.trigger('paginate:shared-org-entries', {
					search : encodeURIComponent(keyword),
				});
			},
		}); // settings.VacationResponseOrgUserSearchView

		settings.VacationResponseOrgRecipientsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, $template = settings.$template;
				html = $template.filter('#vacation-response-org-recipients-item-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					entry : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				this.initData();
			},
			initData : function() {
				var type = this.model.get('type');
				var USER_GROUP_IDX = this.model.get('USER_GROUP_IDX') || this.model.get('id');
				if (!type && (!USER_GROUP_IDX || USER_GROUP_IDX == 0)) {
					type = 'user';
				} else if (!type && (USER_GROUP_IDX && USER_GROUP_IDX != 0)) {
					type = 'group';
				}
				this.$el.data('SHARE_EMAIL', this.model.get('SHARE_EMAIL'));
				this.$el.data('USER_GROUP_IDX', USER_GROUP_IDX);
				this.$el.data('type', type);
				this.$el.data('SHARE_NAME', this.model.get('SHARE_NAME'));
			},
		}); // settings.VacationResponseOrgRecipientsItemView

		settings.VacationResponseOrgRecipientsListView = Backbone.Marionette.CompositeView.extend({
			template : function(data) {
				var html;
				var selfView = settings.VacationResponseOrgRecipientsListView;
				var compiledTemplate = selfView.compiledTemplate;
				if (!compiledTemplate) {
					var $template = settings.$template;
					html = $template.filter('#vacation-response-org-recipients-list-template').html();
					compiledTemplate = _.template(html);
					selfView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.parentView = options.parentView; // settings.VacationResponseOrgSettingsLayout
				this.listenTo(this.parentView, 'add:recipients', this.addRecipients);
				this.listenTo(this.parentView, 'remove:recipient', this.removeRecipients);
			},
			onRender : function() {
			},
			addRecipients : function(recipients) {
				var self = this, $el = this.$el;
				$.each(recipients, function(index, share) {
					if (self.userModel.get('USERS_IDX') == share.address) {
						alert(i18n.vacationResponse.cannotAddYourSelf);
						return false;
					}
					var isDuplicate = self.checkDuplicate(share);
					if (isDuplicate)
						return;
					var model = new Backbone.Model({
						type : share.type,
						SHARE_NAME : share.personal,
						SHARE_EMAIL : share.address,
						id : share.id,
					});
					var recipientsItemView = new settings.VacationResponseOrgRecipientsItemView({
						model : model,
						parentView : self,
					});
					$el.find('ul').append(recipientsItemView.render().el);
				});
				this.parentView.trigger('update:shared-recipients-count', this.$el.find('li').length);
			},
			removeRecipients : function() {
				var $checkbox = this.$el.find('.org-recipient-item');
				$checkbox.filter(':checked').parent('li').remove();
				this.parentView.trigger('update:shared-recipients-count', this.$el.find('li').length);
			},
			checkDuplicate : function(share) {
				var $item = this.$el.find('li label');
				var isDuplicate = false;
				$item.each(function() {
					var addr = $(this).text();
					var id;
					if (addr.charAt(0) == '$') {
						id = share.address;
					} else {
						if (share.personal) {
							id = '"' + share.personal + '"' + '<' + share.address + '>';
						} else {
							id = '<' + share.address + '>';
						}
					}
					if (addr && $.trim(addr) == $.trim(id)) {
						isDuplicate = true;
						return false;
					}
				});
				return isDuplicate;
			}
		}); // settings.VacationResponseOrgRecipientsListView

		settings.VacationResponseOrgSettingsFooterView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var $template = settings.$template;
				var html = $template.filter('#vacation-response-org-settings-footer-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.flag = options.flag;
				this.contentLayoutView = options.contentLayoutView;
			},
			onRender : function() {
				var self = this;
				var $save = this.$el.find('button.org-user-group-save');
				var $cancel = this.$el.find('button.org-user-group-cancel');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $recipients = $('div#share_people li');
					$recipients.each(function() {
						var email = $.trim($(this).data('SHARE_EMAIL'));
						if (self.flag && self.flag === 'vacation-response') {
							app.vent.trigger('append:deputy-receiver', email);
						} else {
							app.vent.trigger('append:deputy-approver', email);
						}
					});
					self.contentLayoutView.trigger('hide:share-settings-layout');
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.contentLayoutView.trigger('hide:share-settings-layout');
				});
			},
		}); // settings.VacationResponseOrgSettingsFooterView

		settings.SpamSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.SpamSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#spam-settings-template').html();
					compiledTemplate = _.template(html);
					settings.SpamSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == Some Model
			},
			onRender : function() {
				var self = this;
				var $el = this.$el;
				var $tabs = $el.find('ul.tab_list li a');
				var $panels = $el.find('div.scroll_frame div.scroll_zoom').children('div');
				var $selectFilterLevel = $el.find('table.filter_lv select[name=filter_selbox]');
				var $addFilterMail = $el.find('button.add-filter-mail');
				var $addFilterDomain = $el.find('button.add-filter-domain');
				var $addBlockWord = $el.find('button.add-block-words');
				var $removeSpamFilter = $el.find('button.remove-spam-filter');
				var $findSpamFilter = $el.find('button.find-spam-filter');
				var $sendSpamFilter = $el.find('button.send-spam-filter');
				var $cancelSpamFilter = $el.find('button.cancel-spam-filter');
				var removeItems = [];

				$tabs.eq(0).parent().addClass('on');
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$tabs.parent().removeClass('on');
					var $this = $(this);
					$this.parent().addClass('on');
					$panels.hide();
					if ($this.hasClass('settings-filter-level')) {
						$panels.filter('.settings-filter-level').show();
					} else if ($this.hasClass('settings-blocked-filters')) {
						$panels.filter('.settings-blocked-filters').show();
						// 기존 items 초기화
						removeItems.length = 0;
						self.showBlockedFilterList();
					} else if ($this.hasClass('settings-allowed-filters')) {
						$panels.filter('.settings-allowed-filters').show();
						// 기존 items 초기화
						removeItems.length = 0;
						self.showAllowedFilterList();
					} else if ($this.hasClass('settings-blocked-words')) {
						$panels.filter('.settings-blocked-words').show();
						// 기존 items 초기화
						removeItems.length = 0;
						self.showBlockedWordList();
					}
				});

				$selectFilterLevel.change(function() {
					var level;
					switch ($(this).val()) {
					case 'none':
						level = 'N';
						break;
					case 'low':
						level = 'L';
						break;
					case 'high':
						level = 'M';
						break;
					case 'highest':
						level = 'H';
						break;
					}
					self.model.save({
						USERS_SPAM_LEVEL : level,
					}, {
						wait : true,
						patch : true,
						async : false,
					});
				});

				$addFilterMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $list;
					var elementId;
					var $inputbox;
					var id = $(this).attr('id');
					if (id === 'addBlockMailFilter') {
						$list = $el.find('.ul-blocked-email-filters');
						$inputbox = $el.find('.input-block-mail-filter');
						elementId = 'blocked-email';
					} else if (id === 'addAllowedMailFilter') {
						$list = $el.find('.ul-allowed-email-filters');
						$inputbox = $el.find('.input-allow-mail-filter');
						elementId = 'allowed-email';
					}
					var email = $.trim($inputbox.val());
					var expr = '^([\\w-]+(?:\\.[\\w-]+)*)@';
					expr += '((?:[\\w-]+\\.)*\\w[\\w-]{0,66})\\.([a-z]{2,6}(?:\\.[a-z]{2})?)$';
					var matcher = new RegExp(expr);
					if (!matcher.test(email)) {
						alert(i18n.spam.checkMailFormat);
						$inputbox.val('');
						$inputbox.focus();
						return;
					}
					self.addSpamFilter($list, $inputbox, email, elementId);
				});

				$addFilterDomain.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $list;
					var elementId;
					var $inputbox;
					var id = $(this).attr('id');
					if (id === 'addBlockDomainFilter') {
						$list = $el.find('.ul-blocked-domain-filters');
						$inputbox = $el.find('.input-block-domain-filter');
						elementId = 'blocked-domain';
					} else if (id === 'addAllowedDomainFilter') {
						$list = $el.find('.ul-allowed-domain-filters');
						$inputbox = $el.find('.input-allow-domain-filter');
						elementId = 'allowed-domain';
					}
					var domain = $inputbox.val();
					var matcher = /^((\w|[\-\.])+)\.([A-Za-z]+)$/;
					if (!matcher.test(domain)) {
						var msg = '<' + domain + '>' + i18n.spam.checkDomainType;
						alert(msg);
						$inputbox.val('');
						$inputbox.focus();
						return;
					}
					self.addSpamFilter($list, $inputbox, domain, elementId);
				});

				$addBlockWord.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $list = $el.find('.ul-blocked-word-filters');
					var $inputbox = $el.find('.input-block-word-filter');
					var keyword = $inputbox.val();
					self.addSpamFilter($list, $inputbox, keyword, 'blocked-words');
				});

				$removeSpamFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $list;
					var id = $this.attr('id');
					switch (id) {
					case 'removeBlockMailFilter':
						$list = $el.find('.ul-blocked-email-filters');
						break;
					case 'removeBlockDomainFilter':
						$list = $el.find('.ul-blocked-domain-filters');
						break;
					case 'removeAllowedMailFilter':
						$list = $el.find('.ul-allowed-email-filters');
						break;
					case 'removeAllowedDomainFilter':
						$list = $el.find('.ul-allowed-domain-filters');
						break;
					case 'removeBlockedWordsFilter':
						$list = $el.find('.ul-blocked-word-filters');
						break;
					}
					var $checkboxes = $list.find('input[type=checkbox]:checked');
					$checkboxes.each(function() {
						// var filterKeyword =
						// $(this).siblings('label').attr('title');
						$(this).removeProp('checked');
						$checkboxes.closest('li').remove();
						removeItems.push($(this).val());
					});
				});

				$findSpamFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $list;
					var id = $this.attr('id');
					var keyword;
					switch (id) {
					case 'findBlockMailFilter':
						keyword = $el.find('.input-block-mail-filter').val();
						$list = $el.find('.ul-blocked-email-filters');
						break;
					case 'findBlockDomainFilter':
						keyword = $el.find('.input-block-domain-filter').val();
						$list = $el.find('.ul-blocked-domain-filters');
						break;
					case 'findAllowedMailFilter':
						keyword = $el.find('.input-allow-mail-filter').val();
						$list = $el.find('.ul-allowed-email-filters');
						break;
					case 'findAllowedDomainFilter':
						keyword = $el.find('.input-allow-domain-filter').val();
						$list = $el.find('.ul-allowed-domain-filters');
						break;
					case 'findBlockWordsFilter':
						keyword = $el.find('.input-block-word-filter').val();
						$list = $el.find('.ul-blocked-word-filters');
						break;
					}
					$list.find('label').each(function() {
						var $label = $(this);
						var title = $label.attr('title');
						if ($.trim(title) === $.trim(keyword)) {
							var $checkbox = $(this).siblings('input[type=checkbox]');
							$checkbox.prop('checked', 'checked');
							$checkbox.focus();
							return false;
						}
					});
				});

				$sendSpamFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var type;
					var id = $(this).attr('id');
					var $newItems;
					switch (id) {
					case 'sendBlockedFilter':
						$newItems = self.$el.find('div.settings-blocked-filters ul li[isnew=true]');
						break;
					case 'sendAllowedFilter':
						$newItems = self.$el.find('div.settings-allowed-filters ul li[isnew=true]');
						break;
					case 'sendBlockedWords':
						$newItems = self.$el.find('div.settings-blocked-words ul li[isnew=true]');
						break;
					}
					self.$el.find('ul li[isnew=true]');
					var addItems = [];
					$newItems.each(function() {
						addItems.push($(this).children('label').text());
					});
					_.each(addItems, function(addItem) {
						if (!addItem) {
							return;
						}
						var filterModel = new app.mail.FilterModel();
						switch (id) {
						case 'sendBlockedFilter':
							if (addItem.indexOf('@') != -1) {
								type = 1;
							} else {
								type = 2;
							}
							break;
						case 'sendAllowedFilter':
							if (addItem.indexOf('@') != -1) {
								type = 5;
							} else {
								type = 6;
							}
							break;
						case 'sendBlockedWords':
							type = 3;
							break;
						}
						filterModel.save({
							FILTER_AUTH : 3,
							FILTER_TYPE : type,
							FILTER_KEYWORD : addItem,
						}, {
							wait : true,
							async : false,
						});
					});
					_.each(removeItems, function(filterIdx) {
						filterIdx = parseInt(filterIdx);
						if (!filterIdx) {
							return;
						}
						var filterModel = new app.mail.FilterModel({
							FILTER_IDX : filterIdx,
						});
						filterModel.destroy({
							wait : true,
							async : false,
						});
					});
					alert(i18n.spam.patchSuccess);
					switch (id) {
					case 'sendBlockedFilter':
						removeItems.length = 0;
						self.showBlockedFilterList();
						break;
					case 'sendAllowedFilter':
						removeItems.length = 0;
						self.showAllowedFilterList();
						break;
					case 'sendBlockedWords':
						removeItems.length = 0;
						self.showBlockedWordList();
						break;
					}
				});

				$cancelSpamFilter.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var id = $(this).attr('id');
					if (id === 'cancelBlockedFilter') {
						var $blockedEmails = self.$el.find('.ul-blocked-email-filters');
						var $blockedDomains = self.$el.find('.ul-blocked-domain-filters');
						self.clearNewItems($blockedEmails.add($blockedDomains));
						self.restoreRemoveItems($blockedEmails.add($blockedDomains), removeItems);
					} else if (id === 'cancelAllowedFilter') {
						var $allowedEmails = self.$el.find('.ul-allowed-email-filters');
						var $allowedDomains = self.$el.find('.ul-allowed-domain-filters');
						self.clearNewItems($allowedEmails.add($allowedDomains));
						self.restoreRemoveItems($allowedEmails.add($allowedDomains), removeItems);
					} else if (id === 'cancelBlockedWords') {
						var $blockedWords = self.$el.find('.ul-blocked-word-filters');
						self.clearNewItems($blockedWords);
						self.restoreRemoveItems($blockedWords, removeItems);
					}
				});
			},
			showBlockedFilterList : function() {
				var self = this;
				var $el = this.$el;
				var $blockedEmails = $el.find('.ul-blocked-email-filters');
				var $blockedDomains = $el.find('.ul-blocked-domain-filters');
				var $blockedMailCount = $el.find('strong.blocked-mail-count');
				var $blockedDomainCount = $el.find('strong.blocked-domain-count');
				this.clearNewItems($blockedEmails.add($blockedDomains));
				var blockedFilters = new app.mail.FilterCollection({});
				blockedFilters.url = 'filters/blocked-filters';
				blockedFilters.fetch({
					async : false,
				});
				blockedFilters.forEach(function(blockedFilter) {
					var $list;
					var elementId;
					if (blockedFilter.get('FILTER_TYPE') === 1) {
						elementId = 'blocked-email';
						$list = $blockedEmails;
					} else if (blockedFilter.get('FILTER_TYPE') === 2) {
						elementId = 'blocked-domain';
						$list = $blockedDomains;
					}
					var filterKeyword = blockedFilter.get('FILTER_KEYWORD');
					if (self.isDuplicate($list, filterKeyword)) {
						return;
					}
					var filterIdx = blockedFilter.get('FILTER_IDX');
					self.prependList($list, elementId, filterKeyword, filterIdx);
				});
				$blockedMailCount.text($blockedEmails.find('li').length);
				$blockedDomainCount.text($blockedDomains.find('li').length);
			},
			showAllowedFilterList : function() {
				var self = this;
				var $el = this.$el;
				var $allowedEmails = $el.find('.ul-allowed-email-filters');
				var $allowedDomains = $el.find('.ul-allowed-domain-filters');
				var $allowedMailCount = $el.find('strong.allowed-mail-count');
				var $allowedDomainCount = $el.find('strong.allowed-domain-count');
				this.clearNewItems($allowedEmails.add($allowedDomains));
				var allowedFilters = new app.mail.FilterCollection({});
				allowedFilters.url = 'filters/allowed-filters';
				allowedFilters.fetch({
					async : false,
				});
				allowedFilters.forEach(function(allowedFilter) {
					var $list;
					var elementId;
					if (allowedFilter.get('FILTER_TYPE') === 5) {
						elementId = 'allowed-email';
						$list = $allowedEmails;
					} else if (allowedFilter.get('FILTER_TYPE') === 6) {
						elementId = 'allowed-domain';
						$list = $allowedDomains;
					}
					var filterKeyword = allowedFilter.get('FILTER_KEYWORD');
					if (self.isDuplicate($list, filterKeyword)) {
						return;
					}
					var filterIdx = allowedFilter.get('FILTER_IDX');
					self.prependList($list, elementId, filterKeyword, filterIdx);
				});
				$allowedMailCount.text($allowedEmails.find('li').length);
				$allowedDomainCount.text($allowedDomains.find('li').length);
			},
			showBlockedWordList : function() {
				var self = this;
				var $el = this.$el;
				var $blockedWords = $el.find('.ul-blocked-word-filters');
				this.clearNewItems($blockedWords);
				var blockedWords = new app.mail.FilterCollection({});
				blockedWords.url = 'filters/blocked-words';
				blockedWords.fetch({
					async : false,
				});
				blockedWords.forEach(function(blockedWord) {
					var $list = $blockedWords;
					var elementId = 'blocked-words';
					var filterKeyword = blockedWord.get('FILTER_KEYWORD');
					if (self.isDuplicate($list, filterKeyword)) {
						return;
					}
					var filterIdx = blockedWord.get('FILTER_IDX');
					self.prependList($list, elementId, filterKeyword, filterIdx);
				});
			},
			clearNewItems : function($container) {
				$container.find('label').each(function() {
					var $this = $(this);
					if ($this.attr('isnew')) {
						$this.closest('li').remove();
					}
				});
			},
			restoreRemoveItems : function($container, removeItems) {
				var $li = $container.find('li').filter(':hidden');
				$li.each(function() {
					var $checkbox = $(this).find('input[type=checkbox]');
					var filterIdx = $checkbox.val();
					for (var i = 0; i < removeItems.length; i++) {
						if (filterIdx === removeItems[i]) {
							$(this).show();
							delete removeItems[i];
						}
					}
				});
			},
			addSpamFilter : function($list, $inputBox, keyword, elementId) {
				if (this.isDuplicate($list, keyword)) {
					alert(i18n.spam.checkAlreadyKeyword);
					$list.find('label').each(function() {
						var $label = $(this);
						var title = $label.attr('title');
						if ($.trim(title) === keyword) {
							var $checkbox = $(this).siblings('input[type=checkbox]');
							$checkbox.prop('checked', 'checked');
							$checkbox.focus();
							return false;
						}
					});
					$inputBox.val('');
					return;
				}
				this.prependList($list, elementId, keyword, 0);
				$inputBox.val('');
			},
			isDuplicate : function($container, filterKeyword) {
				var isDuplicate = false;
				$container.find('label').each(function() {
					var title = $(this).attr('title');
					if ($.trim(title) === $.trim(filterKeyword)) {
						isDuplicate = true;
						return false;
					}
				});
				return isDuplicate;
			},
			prependList : function($container, prefix, filterKeyword, filterIdx) {
				var index = $container.find('input[name=li_check]').length;
				var id = 'li_' + prefix + '_' + index;
				var $input = $('<input>', {
					type : 'checkbox',
					name : 'li_check',
					id : id,
					value : filterIdx,
					seq : index,
				});
				var $label = $('<label>', {
					'for' : id,
					text : filterKeyword,
					title : filterKeyword,
					seq : index,
				});
				var $item = $($input).add($label);
				var $li = $('<li></li>').wrapInner($item);
				$container.prepend($li);
				if (filterIdx == 0) {
					$li.attr('isnew', true);
					$item.attr('isnew', true);
					$input.prop('checked', 'checked');
				}
			},
		}); // settings.SpamSettingsView

		settings.ImportSettingsView = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'setting_tab external',
			template : function(data) {
				var html, compiledTemplate = settings.ImportSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#import-settings-template').html();
					compiledTemplate = _.template(html);
					settings.ImportSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				quickInsertRegion : {
					selector : 'div#quickInsertDiv',
				},
				manualInsertRegion : {
					selector : 'div#manualInsertDiv',
				},
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				this.showQuickInsertView();
				this.showManualInsertView();

				var $panels = this.$el.find('div.scroll_frame div.scroll_zoom').children('div');
				var $tabs = this.$el.find('ul.tab_list li a');

				$tabs.eq(0).parent().addClass('on');
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$panels.hide();
					$tabs.parent().removeClass('on');
					var $item = $(this).parent().addClass('on');
					var id = $item.attr('id');
					switch (id) {
					case 'quickInsert':
						self.showQuickInsertView();
						self.quickInsertRegion.$el.show();
						break;
					case 'manualinsert':
						self.showManualInsertView();
						self.manualInsertRegion.$el.show();
						break;
					}
					return false;

				});
				alert("기능 준비 중 입니다");
			},
			showQuickInsertView : function() {
				this.quickInsertRegion.show(new settings.ImportQuickInsertView({}));
			},
			showManualInsertView : function() {
				this.manualInsertRegion.show(new settings.ImportManualInsertView({}));
			},
		}); // settings.ImportSettingsView

		settings.ImportQuickInsertView = Backbone.Marionette.Layout.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ImportQuickInsertView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#import-settings-quickinsert-template').html();
					compiledTemplate = _.template(html);
					settings.ImportQuickInsertView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			regions : {
				quickInsertFormRegion : {
					selector : 'div#quickInsertFormDiv',
				},
				importListRegion : {
					selector : 'div#importListRegion',
				},
			},
			initialize : function(options) {
				this.collection = new settings.ImportingCollection();
				this.collection.fetch();

				this.listenTo(this.collection, 'sync', this.showImportListView);
			},
			onRender : function() {
				var self = this;
				this.showQuickInsertFormView();
				this.showImportListView();

				var $saveBtn = this.$el.find('button#saveBtn');
				$saveBtn.click(function() {
					var $agreementCheckbox = self.$el.find('#use_agree');
					if (!$agreementCheckbox.is(':checked')) {
						alert("이용동의 체크가...");
						return false;
					}
					if (confirm("외부메일 추가...?")) {
						app.vent.trigger('settings:saveImporting');
					}
				});

				var $cancelBtn = this.$el.find('button#cancelBtn');
				$cancelBtn.click(function() {
					if (confirm("초기화 할래여...?")) {
						self.showQuickInsertFormView();
					}
				});
			},
			showQuickInsertFormView : function() {
				this.quickInsertFormRegion.show(new settings.ImportQuickInsertFormView({
					parentView : this,
				}));
			},
			showImportListView : function() {
				this.importListRegion.show(new settings.ImportListView({
					parentView : this,
					collection : this.collection,
				}));
			},
		});

		settings.ImportQuickInsertFormView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ImportQuickInsertFormView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#import-settings-quickInsertForm-template').html();
					compiledTemplate = _.template(html);
					settings.ImportQuickInsertFormView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mboxCollection : app.mail.mboxCollection,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.parentView = options.parentView;
				this.listenTo(app.vent, 'settings:saveImporting', this.saveImporting);
			},
			onRender : function() {
				var self = this;
				var extHostRadio = this.$el.find('input:radio[name="exter_site"]');

				extHostRadio.change(function() {
					var host = $(this).attr('id');
					if (host) {
						self.$el.find('input#exter_id').removeAttr('disabled');
						self.$el.find('input#exter_pw').removeAttr('disabled');
					}
				});
			},
			saveImporting : function() {
				var self = this;
				var importingModel = new settings.ImportingModel();
				var extHost = this.$el.find('input:radio[name="exter_site"]').filter(':checked').val();
				var mboxUse = this.$el.find('input:radio[name="new_mail_area"]').filter(':checked').attr('id');
				if (!extHost) {
					alert("호스트 선택좀...");
					return false;
				}
				importingModel.set('POP_PROTOCOL', 'pop3');
				importingModel.set('POP_ISDEL', 'N');
				importingModel.set('POP_ICON', '1');
				importingModel.set('FILTER_USE', '1');
				importingModel.set('AUTO_FETCH', '1');
				importingModel.set('AUTODIVISION_USE', '1');
				importingModel.set('POP_MBOX', 'INBOX');

				if (!this.$el.find('input#exter_id').val() || !this.$el.find('input#exter_pw').val()) {
					alert("계정정보가...");
					return false;
				}
				importingModel.set('POP_ID', this.$el.find('input#exter_id').val());
				importingModel.set('POP_PASSWD', this.$el.find('input#exter_pw').val());

				// MBOX_IDX관련 로직
				if (mboxUse == 'new_mail_box') {
					var mboxName = this.$el.find('input#newMboxNameInput').val();
					if (!mboxName) {
						alert("편지함명이...");
						return false;
					}
					var mbox = app.mail.mboxCollection.findModel('MBOX_NAME', mboxName);
					if (mbox) {
						// 중복인지 체크하고, 이미 mboxCollection에 있으면? 그거 쓰자
						if (confirm("중복된 이름 있는데 그거 쓸래여...?")) {
							importingModel.set('MBOX_IDX', mbox.get('MBOX_IDX'));
						} else {
							return false;
						}
					} else {
						if (confirm("새 편지함을 만들래여...?")) {
							var newMbox = new app.mail.MboxModel();
							newMbox.set('MBOX_NAME', mboxName);
							newMbox.save({}, {
								wait : true,
								async : false,
								success : function(model, resp, options) {
									importingModel.set('MBOX_IDX', model.get('MBOX_IDX'));
									app.mail.mboxCollection.fetch();
								}
							});
						} else {
							return false;
						}
					}
				} else {
					var selectedMboxIdx = this.$el.find('#mboxListSelect :selected').val();
					importingModel.set('MBOX_IDX', selectedMboxIdx);
				}

				if (extHost == 'naver') {
					importingModel.set('POP_SERVER', 'pop.naver.com');
					importingModel.set('POP_NAME', extHost);
					importingModel.set('POP_PORT', '995');
					importingModel.set('POP_SSL', 'Y');
				} else if (extHost == 'daum') {
					importingModel.set('POP_SERVER', 'pop.daum.net');
					importingModel.set('POP_NAME', extHost);
					importingModel.set('POP_PORT', '995');
					importingModel.set('POP_SSL', 'Y');
				} else if (extHost == 'nate') {
					// TODO
				} else if (extHost == 'gmail') {
					// TODO
				} else if (extHost == 'outlook') {
					// TODO
				} else if (extHost == 'yahoo') {
					// TODO
				}

				importingModel.save({}, {
					async : false,
					wait : true,
					success : function(model, resp, options) {
						alert("저장되었음...");
						self.parentView.collection.fetch();
						self.render();
					}
				});
			},
		});

		settings.ImportListView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ImportListView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#import-settings-importList-template').html();
					compiledTemplate = _.template(html);
					settings.ImportListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					items : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = importingCollection
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $deleteBtns = this.$el.find('#deleteBtn');
				$deleteBtns.click(function() {
					var importingModel = self.collection.findModel('POP_IDX', $(this).attr('idx'));
					if (confirm("정말로 삭제...?")) {
						importingModel.destroy({
							async : false,
							wait : true,
						});
						self.collection.fetch();
					}
				});
			},
		});

		settings.ImportManualInsertView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ImportManualInsertView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#import-settings-manualinsert-template').html();
					compiledTemplate = _.template(html);
					settings.ImportManualInsertView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
			},
		});

		settings.PopImapSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab external',
			template : function(data) {
				var html, compiledTemplate = settings.PopImapSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#pop-imap-settings-template').html();
					compiledTemplate = _.template(html);
					settings.PopImapSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
			},
			onRender : function() {
				var self = this;
				var $tabs = this.$el.find('ul.tab_list li a');
				var $panels = this.$el.find('div.scroll_frame div.scroll_zoom').children('div');
				$tabs.eq(0).parent().addClass('on');
				self.renderPopSettingsView();
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$tabs.parent().removeClass('on');
					var $this = $(this);
					$this.parent().addClass('on');
					$panels.hide();
					if ($this.hasClass('settings-pop-smtp')) {
						self.renderPopSettingsView();
					} else if ($this.hasClass('settings-imap-smtp')) {
						self.renderImapSettingsView();
					}
				});
			},
			renderPopSettingsView : function() {
				var $tab = this.$el.find('div.scroll_frame div.scroll_zoom');
				var popSettingsView = new settings.PopSettingsView({
					model : this.model,
					mboxCollection : app.mail.mboxCollection,
				});
				$tab.html(popSettingsView.render().el);
			},
			renderImapSettingsView : function() {
				var $tab = this.$el.find('div.scroll_frame div.scroll_zoom');
				var imapSettingsView = new settings.ImapSettingsView({
					model : this.model,
					mboxCollection : app.mail.mboxCollection,
				});
				$tab.html(imapSettingsView.render().el);
			},
		}); // settings.PopImapSettingsView

		settings.PopSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.PopSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#pop-settings-template').html();
					compiledTemplate = _.template(html);
					settings.PopSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $popEnabled = self.$el.find('input[name=pop_enabled]');
				var $popSince = self.$el.find('input[name=pop_since]');
				var $popAsRead = self.$el.find('input[name=pop_as_read]');
				var $popKeepCopy = self.$el.find('input[name=pop_keep_copy]');
				var $popExcludeImported = self.$el.find('input[name=pop_exclude_imported]');
				var $keepSaveBtn = self.$el.find('#keep_save_btn');
				var $clientSettingsBtn = self.$el.find('#client_settings_btn');
				var $guide = self.$el.find('#pop_guide_layer');
				var $guideClose = self.$el.find('#txt_pop_close');
				var $optionDefault = self.$el.find('div.btn_c .ab_l');
				var $save = self.$el.find('div.btn_c .save');
				var $cancel = self.$el.find('div.btn_c .cancel');
				var $toggleBox = self.$el.find('div.use_box p');
				var $toggleMenu = self.$el.find('div.box_tbl table.set_tbl tr.f').siblings();
				if (self.model.get('POP_ENABLED') == 0) {
					$toggleBox.filter('.not_use_pop_box').show();
					$toggleMenu.hide();
				} else {
					$toggleBox.filter('.use_pop_box').show();
					$toggleMenu.show();
				}
				if (self.model.get('POP_SINCE') != null) {
					$input = $('<input>', {
						type : 'radio',
						name : 'pop_since',
						id : 'active_date',
						'class' : 'set_radio new_sradio',
						checked : true,
					});
					$label = $('<label>', {
						'for' : 'active_date',
						text : self.model.get('POP_SINCE') + i18n.popImap.pop.afterMail,
					});
					var $existingSettings = self.$el.find('div.box_tbl td.pop_since');
					$existingSettings.append($input).append($label);
				}
				$popEnabled.change(function(event) {
					event.stopPropagation();
					if (this.value == 0) {
						$toggleMenu.hide();
					} else {
						$toggleMenu.show();
						self.$el.find('#active_new').prop('checked', true);
						self.$el.find('#pop_read').prop('checked', true);
						self.$el.find('#exter_pop').prop('checked', true);
					}
				});
				$keepSaveBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					// $guide.attr('hidable', false);
					$guide.toggle();
				});
				$clientSettingsBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				$guideClose.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$guide.hide();
				});
				$optionDefault.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$popEnabled.filter('#use_pop_no').click();
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var popEnabled = $popEnabled.filter(':checked').val();
					if (popEnabled == 1 && $popKeepCopy.filter(':checked').val() == null) {
						alert(i18n.popImap.pop.keepCopy);
						return;
					}
					var userModel = new app.user.UserModel({
						USERS_IDX : self.model.get('USERS_IDX'),
					});
					var popSince = $popSince.filter(':checked').val();
					var popAsRead = $popAsRead.filter(':checked').val();
					var popKeepCopy = $popKeepCopy.filter(':checked').val();
					var popExcludeImported = $popExcludeImported.filter(':checked').val();
					if (popEnabled == 0) {
						popSince = 'existed';
						popAsRead = 0;
						popKeepCopy = 0;
						popExcludeImported = 0;
					}
					userModel.save({
						POP_ENABLED : popEnabled,
						POP_SINCE : popSince,
						POP_AS_READ : popAsRead,
						POP_KEEP_COPY : popKeepCopy,
						POP_EXCLUDE_IMPORTED : popExcludeImported,
					}, {
						patch : true,
						wait : true,
						async : false,
						success : function(model, response, options) {
							alert(i18n.popImap.modificationComplete);
							self.model.fetch();
						},
					});
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});

				var $popKeepCopyGuideBtn = this.$el.find('#pop-keep-copy-guide-btn');
				$popKeepCopyGuideBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var popKeepCopyGuideView = new settings.PopKeepCopyGuideView();
					popKeepCopyGuideView.render().$el.show().appendTo('body');
				});

				var $popKeepCopyProgrameGuideBtn = this.$el.find('#pop-keep-copy-programe-guide-btn');
				$popKeepCopyProgrameGuideBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var popKeepCopyProgrameGuideView = new settings.PopKeepCopyProgrameGuideView();
					popKeepCopyProgrameGuideView.render().$el.show().appendTo('body');
				});
			},
		}); // settings.PopSettingsView

		settings.PopKeepCopyGuideView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.PopKeepCopyGuideView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#pop-keep-copy-guide-template').html();
					compiledTemplate = _.template(html);
					settings.PopKeepCopyGuideView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var self = this;
				var $close = self.$el.find('#pop-keep-copy-guide-close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.remove();
				});
			}
		}); // settings.PopKeepCopyGuideView

		settings.PopKeepCopyProgrameGuideView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.PopKeepCopyProgrameGuideView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#pop-keep-copy-programe-guide-template').html();
					compiledTemplate = _.template(html);
					settings.PopKeepCopyProgrameGuideView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var self = this;
				var $close = self.$el.find('#pop-keep-copy-programe-guide-close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.remove();
				});
			}
		}); // settings.PopKeepCopyProgrameGuideView

		settings.ImapSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ImapSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#imap-settings-template').html();
					compiledTemplate = _.template(html);
					settings.ImapSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $imapEnabled = self.$el.find('input[name=imap_enabled]');
				var $optionDefault = self.$el.find('div.btn_c .ab_l');
				var $confirm = self.$el.find('div.btn_c .confirm');
				var $cancel = self.$el.find('div.btn_c .cancel');
				var $toggleBox = self.$el.find('div.use_box p');
				if (self.model.get('IMAP_ENABLED') == 0) {
					$toggleBox.filter('.not_use_imap_box').show();
				} else {
					$toggleBox.filter('.use_imap_box').show();
				}
				$optionDefault.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$imapEnabled.filter('#use_imap_no').click();
				});
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var userModel = new app.user.UserModel({
						USERS_IDX : self.model.get('USERS_IDX'),
					});
					userModel.save({
						IMAP_ENABLED : $imapEnabled.filter(':checked').val(),
					}, {
						patch : true,
						wait : true,
						async : false,
						success : function(model, response, options) {
							alert(i18n.popImap.modificationComplete);
							self.model.fetch();
						},
					});
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render();
				});

				var $imapGuideBtn = this.$el.find('#imap-guide-btn');
				$imapGuideBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var imapGuideView = new settings.ImapGuideView();
					imapGuideView.render().$el.show().appendTo('body');
				});
			},
		}); // settings.ImapSettingsView

		settings.ImapGuideView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ImapGuideView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#imap-guide-template').html();
					compiledTemplate = _.template(html);
					settings.ImapGuideView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var self = this;
				var $close = self.$el.find('#imap-guide-close');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.remove();
				});
			}
		}); // settings.PopKeepCopyProgrameGuideView

		settings.AliasesForwardingSettingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html;
				var compiledTemplate = settings.AliasesForwardingSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					var templateId = '#aliases-forwarding-settings-template';
					html = settings.$template.filter(templateId).html();
					compiledTemplate = _.template(html);
					settings.AliasesForwardingSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.listenTo(app.vent, 'change:aliases-view', this.renderAliasesSettingsView);
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $tabs = $el.find('ul.tab_list li a');
				var $panels = $el.find('div.scroll_frame div.scroll_zoom').children('div');
				$tabs.eq(0).parent().addClass('on');
				if (self.model.get('ALIAS_ENABLED')) {
					self.renderAliasesSettingsView();
				} else if (self.model.get('AUTO_FORWARD_ENABLED')) {
					self.renderForwardingSettingsView();
				}
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$tabs.parent().removeClass('on');
					var $this = $(this);
					$this.parent().addClass('on');
					$panels.hide();
					if ($this.hasClass('settings-aliases')) {
						self.renderAliasesSettingsView();
					} else if ($this.hasClass('settings-forwarding')) {
						self.renderForwardingSettingsView();
					}
				});
			},
			renderAliasesSettingsView : function() {
				var $tab = this.$el.find('div.scroll_frame div.scroll_zoom');
				var aliasCollection = new app.user.AliasCollection();
				aliasCollection.fetch({
					async : false,
				});
				var aliasesSettingsView = new settings.AliasesSettingsView({
					collection : aliasCollection,
					userModel : this.model,
					mboxCollection : app.mail.mboxCollection,
				});
				$tab.html(aliasesSettingsView.render().el);
			},
			renderForwardingSettingsView : function() {
				var $tab = this.$el.find('div.scroll_frame div.scroll_zoom');
				this.model.fetch();
				var forwardingSettingsView = new settings.ForwardingSettingsView({
					model : this.model,
					mboxCollection : app.mail.mboxCollection,
				});
				$tab.html(forwardingSettingsView.render().el);
			},
		}); // settings.AliasesForwardingSettingsView

		settings.AliasesSettingsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = settings.AliasesSettingsItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#aliases-settings-item-template').html();
					compiledTemplate = _.template(html);
					settings.AliasesSettingsItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					alias : data,
					user : app.userModel.toJSON(),
					mboxCollection : app.mail.mboxCollection,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.user.AliasModel
			},
			onRender : function() {
				var self = this;
				var $checkboxes = self.$el.find('.multi_chk');
				var aliasIdx = this.model.get('ACCOUNT_IDX');
				var aliasId = aliasIdx.substring(0, aliasIdx.indexOf('@'));
				var $aliasUseChk = self.$el.find('#multi_use_' + aliasId);
				$aliasUseChk.change(function(event) {
					event.stopPropagation();
					var $nowAliasUse = self.model.get('ACCOUNT_ISVALID');
					var $aliasUseTxt = $aliasUseChk.parent().find('#multi_use_' + aliasId);
					if (this.checked) {
						self.aliasUseUpdate(1);
						$aliasUseTxt.text(i18n.aliasesForwarding.aliases.used);
					} else {
						self.aliasUseUpdate(0);
						$aliasUseTxt.text(i18n.aliasesForwarding.aliases.stop);
					}
				});
				var $modify = self.$el.find('.modify');
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.aliasModify();
				});
			},
			aliasUseUpdate : function(newAliasUse) {
				this.model.set('ACCOUNT_IDX', this.model.get('ACCOUNT_IDX'));
				this.model.set('ACCOUNT_ISVALID', newAliasUse);
				this.model.save(null, {
					patch : true,
					wait : true,
					async : false,
				});
				app.vent.trigger('change:aliases-view');
			},
			aliasModify : function() {
				var self = this;
				var $aliasIdxInput = $('div.use_box input[name=mem]');
				var aliasIdx = this.model.get('ACCOUNT_IDX');
				var aliasId = aliasIdx.substring(0, aliasIdx.indexOf('@'));
				var $aliasMbox = $('.alias_mbox');
				var $validity = $('#info_date');
				var $dateArea = $('#multi_date');
				var $startDate = $('#from');
				var $endDate = $('#to');
				var $duplicateChkBtn = $('div.use_box .button_s');
				var $duplicateChk = $('div.use_box input[name=duplicateChk]');
				var $saveBtn = $('div.btn_c .aliasSave');
				var $cancelBtn = $('div.btn_c .aliasCancel');
				$duplicateChkBtn.prop('disabled', true).attr('disabled', 'disabled');
				$duplicateChk.val('modify');
				$aliasMbox.val(this.model.get('MBOX_IDX'));
				$aliasIdxInput.val(aliasId).attr('readonly', true);
				if (this.model.get('ACCOUNT_ISDATED') == 0) {
					$validity.prop('checked', false);
					$dateArea.hide();
				} else {
					$validity.prop('checked', true);
					$startDate.val(this.model.get('ACCOUNT_SDATE'));
					$endDate.val(this.model.get('ACCOUNT_EDATE'));
					$dateArea.show();
				}
				$saveBtn.text(i18n.aliasesForwarding.aliases.modify);
				$cancelBtn.show();
			},
		}); // settings.AliasesSettingsItemView

		settings.AliasesSettingsView = Backbone.Marionette.CompositeView.extend({
			itemView : settings.AliasesSettingsItemView,
			itemViewContainer : 'div.box_tbl table.set_tbl tbody',
			template : function(data) {
				var html, compiledTemplate = settings.AliasesSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#aliases-settings-template').html();
					compiledTemplate = _.template(html);
					settings.AliasesSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == settings.AccountCollection
				this.userModel = options.userModel;
				this.mboxCollection = options.mboxCollection;
			},
			onRender : function() {
				var self = this;
				var useCnt = 0;
				var totalCnt = this.collection.length;
				this.collection.each(function(model) {
					if (model.get('ACCOUNT_ISVALID') == 1)
						useCnt++;
				});
				var $cntDisplay = self.$el.find('p.use_live');
				var $aliasesCnt = $('<strong>', {
					text : useCnt
				});
				$cntDisplay.empty();
				$cntDisplay.append($aliasesCnt).append(' / ').append(totalCnt);
				var $noList = self.$el.find('td.nolist');
				var $selectAllCheckbox = self.$el.find('input.multi_chk_all');
				var $checkboxes = self.$el.find('input.multi_chk');
				var $delete = self.$el.find('div.btn_c .aliasDelBtn');
				var $save = self.$el.find('div.btn_c .aliasSave');
				var $aliasId = self.$el.find('div.use_box input[name=mem]');
				var $duplicateChkBtn = self.$el.find('div.use_box .button_s');
				var $duplicateChk = self.$el.find('div.use_box input[name=duplicateChk]');
				var $mboxIdx = self.$el.find('.alias_mbox');
				var $useDateChk = self.$el.find('#info_date');
				var $startDate = self.$el.find('#from');
				var $endDate = self.$el.find('#to');
				var $dateArea = self.$el.find('#multi_date');
				var $cancelBtn = self.$el.find('div.btn_c .aliasCancel');
				if (this.collection.length < 1) {
					$noList.show();
				}
				$aliasId.keydown(function(event) {
					if (event.which == 13) {
						event.preventDefault();
						$duplicateChkBtn.click();
						return;
					}
					if ($duplicateChk.val() == 'completion') {
						$duplicateChkBtn.prop('disabled', false).removeAttr('disabled');
						$duplicateChk.val('new');
					} else if ($duplicateChk.val() == 'modify') {
						alert(i18n.aliasesForwarding.aliases.modifyWarningPhrase);
						return;
					}
				});
				$selectAllCheckbox.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (this.checked) {
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
				});
				$checkboxes.change(function() {
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length) {
							$selectAllCheckbox.prop('checked', true);
						}
					} else {
						$selectAllCheckbox.removeAttr('checked');
					}
				});
				$useDateChk.change(function() {
					if (this.checked) {
						$dateArea.show();
					} else {
						$dateArea.hide();
					}
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var checkedCnt = 0;
					$checkboxes.each(function() {
						if (!this.checked) {
							return;
						} else {
							checkedCnt++;
						}
						var chkAliasIdx = this.value;
						var models = self.collection.filter(function(aliasModel) {
							if (chkAliasIdx == aliasModel.get('ACCOUNT_IDX'))
								return true;
						});
						_.each(models, function(model) {
							var url = 'aliases/' + model.get('ACCOUNT_IDX');
							model.url = url;
							model.destroy({
								wait : true,
								async : false,
							});
						});
					});
					if (checkedCnt > 0) {
						app.vent.trigger('change:aliases-view');
					} else {
						alert(i18n.aliasesForwarding.aliases.deleteChk);
					}
				});
				$duplicateChkBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($aliasId.val().length < 1) {
						alert(i18n.aliasesForwarding.aliases.enterId);
						return;
					}
					var existUser = false;
					var existAlias = false;
					var aliasIdx = $aliasId.val() + '@' + self.userModel.get('DOMAIN');
					// 사용자계정 조회
					var userModel = new app.user.UserModel({
						USERS_IDX : aliasIdx,
					});
					userModel.url = 'users/' + aliasIdx;
					userModel.fetch({
						async : false,
						error : function(model, response, options) {
							switch (response.status) {
							case 404:
								existUser = true;
								break;
							}
						}
					});
					// 멀티계정 조회
					var aliasModel = new app.user.AliasModel();
					aliasModel.url = 'aliases/' + aliasIdx;
					aliasModel.fetch({
						async : false,
						error : function(model, response, options) {
							switch (response.status) {
							case 404:
								existAlias = true;
								break;
							}
						}
					});
					if (existUser && existAlias) {
						alert($aliasId.val() + i18n.aliasesForwarding.aliases.beUsed);
						$(this).prop('disabled', true).attr('disabled', 'disabled');
						$duplicateChk.val('completion');
						return;
					} else {
						alert($aliasId.val() + i18n.aliasesForwarding.aliases.alreadyUse);
						return;
					}
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($aliasId.val().length < 1) {
						alert(i18n.aliasesForwarding.aliases.enterId);
						return;
					}
					if ($duplicateChk.val() == 'new') {
						alert(i18n.aliasesForwarding.aliases.duplicateCheckMsg);
						return;
					}
					if ($mboxIdx.val() == null || $mboxIdx.val() < 1) {
						alert(i18n.aliasesForwarding.aliases.selectMbox);
						return;
					}
					var model = new app.user.AliasModel();
					var aliasIdx = $aliasId.val() + '@' + self.userModel.get('DOMAIN');
					var useDateChk = $useDateChk.prop('checked') ? 1 : 0;
					var sDate = $.format.date(self.$el.find('#from').val(), 'yyyy-MM-dd');
					var eDate = $.format.date(self.$el.find('#to').val(), 'yyyy-MM-dd');
					if (useDateChk == 1) {
						if (!(sDate && eDate)) {
							alert(i18n.aliasesForwarding.aliases.invalidDate);
							return;
						}
						if (sDate && eDate) {
							if (sDate > eDate) {
								alert(i18n.aliasesForwarding.aliases.invalidEndDate);
								return;
							}
						}
					}
					model.set('ACCOUNT_IDX', aliasIdx);
					model.set('MBOX_IDX', parseInt($mboxIdx.val()));
					model.set('ACCOUNT_ISVALID', 1);
					model.set('ACCOUNT_ISDATED', useDateChk);
					model.set('ACCOUNT_SDATE', sDate);
					model.set('ACCOUNT_EDATE', eDate);
					model.set('DOMAIN', self.userModel.get('DOMAIN'));
					model.set('USERS_IDX', self.userModel.get('USERS_IDX'));

					var patch = $duplicateChk.val() == 'modify' ? true : false;
					var url = 'aliases/' + aliasIdx;
					model.url = url;
					model.save(null, {
						patch : patch,
						wait : true,
						async : false,
						success : function(model, response, options) {
							app.vent.trigger('change:aliases-view');
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 409:
								alert(i18n.aliasesForwarding.aliases.exceededTheMaximumAlias);
								break;
							}
						},
					});
				});
				$cancelBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('change:aliases-view');
				});
				var $mboxSelect = self.$el.find('div.use_box select[name=admin_info]');
				$mboxSelect.empty();
				var options = [];
				options.push($('<option value="0"></option>').text(i18n.aliasesForwarding.aliases.mboxStore));
				this.mboxCollection.each(function(mboxModel) {
					var mboxName;
					switch (mboxModel.get('MBOX_TYPE')) {
					case 1:
						mboxName = i18n.mboxes.inbox;
						break;
					case 2:
						mboxName = i18n.mboxes.sent;
						break;
					case 3:
						mboxName = i18n.mboxes.trash;
						break;
					case 4:
						mboxName = i18n.mboxes.drafts;
						break;
					case 5:
						mboxName = i18n.mboxes.junk;
						break;
					case 6:
						mboxName = mboxModel.get('MBOX_NAME');
						break;
					}
					var $option = $('<option></option>');
					$option.val(mboxModel.get('MBOX_IDX'));
					$option.text(mboxName);
					options.push($option);
				});
				$mboxSelect.append(options);
				// jQuery UI Datepicker
				$startDate.datepicker(i18n.datepicker.options);
				$endDate.datepicker(i18n.datepicker.options);
			},
		}); // settings.AliasesSettingsView

		settings.ForwardingSettingsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = settings.ForwardingSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#forwarding-settings-template').html();
					compiledTemplate = _.template(html);
					settings.ForwardingSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {
				// this.model == app.userModel
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $forwardingUse = self.$el.find('input[name=use_pop]');
				var $addBtn = self.$el.find('.addBtn');
				var $deleteBtn = self.$el.find('.deleteBtn');
				var $save = self.$el.find('.saveBtn');
				var $afterSaveChk = self.$el.find('#auto_save_ok');
				$forwardingUse.change(function() {
					var $this = $(this);
					var $fowadingSettings = self.$el.find('table td.forwading-settings p');
					if ($this.is(':checked') && $this.val() == 'Y')
						$fowadingSettings.not('.forwading-use').show();
					else if ($this.is(':checked') && $this.val() == 'N')
						$fowadingSettings.not('.forwading-use').hide();
				});
				$forwardingUse.change();
				if (self.model.get('USERS_OPT_FWD_SAVE') == 'Y') {
					$afterSaveChk.prop('cheked', true);
				} else {
					$afterSaveChk.prop('cheked', false);
				}
				if (self.model.get('USERS_FWD_LIST') != null)
					var forwardingList = self.model.get('USERS_FWD_LIST').split(',');
				else
					var forwardingList = [];
				var $forwardingInput = self.$el.find('.forwardingInput');
				$forwardingInput.keydown(function(envent) {
					if (event.which == 13) {
						event.preventDefault();
						$addBtn.click();
						return;
					}
				});
				var $forwardingOption = self.$el.find('table.set_tbl .forwardingList');
				var options = [];
				options.push($('<option></option>').text(i18n.aliasesForwarding.forwarding.forwardingEmail));
				var validCnt = 0;
				for (var i = 0; i < forwardingList.length; i++) {
					var email = forwardingList[i];
					var isSelect = validCnt > 0 ? false : true;
					if (this.emailValidation(email)) {
						options.push(this.addOption(email, isSelect));
						validCnt++;
					}
				}
				$forwardingOption.empty();
				$forwardingOption.append(options);
				$addBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var value = $forwardingInput.val();
					if (value == null || value.length < 1) {
						alert(i18n.aliasesForwarding.forwarding.enterEmail);
						return;
					} else if (!self.emailValidation(value)) {
						alert(i18n.aliasesForwarding.forwarding.vaildEmail);
						return;
					}
					for (var i = 0; i < forwardingList.length; i++) {
						if (value == forwardingList[i]) {
							alert(i18n.aliasesForwarding.forwarding.existEmail);
							return;
						}
					}
					forwardingList.push(value);
					forwardingList.join(',');
					options.push(self.addOption(value, true));
					$forwardingOption.empty();
					$forwardingOption.append(options);
					$forwardingInput.val('');
				});
				$deleteBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var email = $forwardingOption.find('option:selected').val();
					if (email.length > 0) {
						for (var i = 0; i < forwardingList.length; i++) {
							if (email == forwardingList[i]) {
								forwardingList.splice(i, 1);
								$forwardingOption.find('option[value=\'' + email + '\']').remove();
							}
						}
						for (var i = 0; i < options.length; i++) {
							if (email == options[i].value)
								options.splice(i, 1);
						}
					} else {
						alert(i18n.aliasesForwarding.forwarding.deleteEmail);
					}
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var limitForward = app.domainModel.get('DOMAIM_LIMIT_FORWARD');
					if (forwardingList.length > limitForward) {
						alert(i18n.aliasesForwarding.forwarding.exceededTheMaximumForwarding);
						return false;
					}
					for (var i = 0; i < forwardingList.length; i++) {
						if (!self.emailValidation(forwardingList[i])) {
							forwardingList.splice(i, 1);
						}
					}
					self.model.save({
						USERS_OPT_FWD : $forwardingUse.filter(':checked').val(),
						USERS_OPT_FWD_SAVE : $afterSaveChk.prop('checked') ? 'Y' : 'N',
						USERS_FWD_LIST : forwardingList.toString(),
					}, {
						patch : true,
						async : false,
						success : function(model, response, options) {
							alert(i18n.aliasesForwarding.modificationComplete);
						},
					});
				});
			},
			addOption : function(value, isAdd) {
				var $option = $('<option></option>');
				$option.text(value);
				$option.attr('value', value);
				if (isAdd)
					$option.attr('selected', 'selected');
				return $option;
			},
			emailValidation : function(email) {
				var expr = '^([\\w-]+(?:\\.[\\w-]+)*)@';
				expr += '((?:[\\w-]+\\.)*\\w[\\w-]{0,66})\\.([a-z]{2,6}(?:\\.[a-z]{2})?)$';
				var matcher = new RegExp(expr);
				if (!matcher.test(email)) {
					return false;
				}
				return true;
			},
		}); // settings.ForwardingSettingsView

		settings.KpnsSettingsView = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.KpnsSettingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#kpns-settings-template').html();
					compiledTemplate = _.template(html);
					settings.KpnsSettingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					kpnsConfig : data,
					mboxes : app.mail.mboxCollection.toJSON(),
					i18n : i18n,
				});
				return html;
			},

			initialize : function(options) {
				// this.model = app.settings.KpnsModel;
				this.mboxCollection = options.mboxCollection;
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				var $kpnsUseRadio = this.$el.find('input[name=kpns_use]');
				var $tableKpnsSettings = this.$el.find('table.kpns-settings tr');
				$kpnsUseRadio.change(function() {
					var value = $(this).val();
					if ($(this).is(':checked') && value == 'Y') {
						$tableKpnsSettings.not('.f').show();
					} else if ($(this).is(':checked') && value == 'N') {
						$tableKpnsSettings.not('.f').hide();
					}
				});
				$kpnsUseRadio.change();
				var $mboxList = this.$el.find('li#mboxList');
				$mboxList.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$(this).parent().children().removeClass('on');
					if ($(this).hasClass('on')) {
						$(this).removeClass('on');
					} else {
						$(this).attr('class', 'on');
					}
				});
				var $add = this.$el.find('a#mboxAddBtn');
				$add.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = self.$el.find('ul.ct_list li.on').attr('value');
					var $mboxNotification = self.$el.find("ul.ct_list_ok [value='" + mboxId + "']");
					if ($mboxNotification.css('display') == 'none') {
						$mboxNotification.show();
					} else {
						alert(i18n.kpns.alreadySelected);
					}
				});
				var $mboxNotificationList = this.$el.find('li#mboxNotificationList');
				$mboxNotificationList.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.kpns.confirmDelete)) {
						$(this).hide();
					}
				});
				var $save = this.$el.find("div.tab_contents div.btn_c .b");
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var kpnsUse = $kpnsUseRadio.filter(':checked').val();
					var $startHour = self.$el.find('select[name="startHour"]:first');
					var $startMinute = self.$el.find('select[name="startMinute"]:first');
					var $endHour = self.$el.find('select[name="endHour"]:first');
					var $endMinute = self.$el.find('select[name="endMinute"]:first');
					var startTime = $startHour.val() + ':' + $startMinute.val() + ':00';
					var endTime = $endHour.val() + ':' + $endMinute.val() + ':00';
					$mboxNotificationList.each(function() {
						var $this = $(this);
						self.mboxCollection.each(function(mboxModel) {
							if ($this.val() == mboxModel.get('MBOX_IDX')) {
								var use = $this.css('display') != 'none' ? 'Y' : 'N';
								if (use != mboxModel.get('MBOX_NOTIFICATION')) {
									mboxModel.save({
										MBOX_NOTIFICATION : use,
									}, {
										patch : true,
										wait : true,
									});
								}
							}
						});
					});
					self.model.save({
						use : kpnsUse,
						start : startTime,
						end : endTime,
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							alert(i18n.kpns.modificationComplete);
						},
					});
					return false;
				});
			},
		}); // settings.KpnsSettingsView

		settings.DeletedMailView = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'setting_tab',
			template : function(data) {
				var html, compiledTemplate = settings.DeletedMailView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#deleted-mail-template').html();
					compiledTemplate = _.template(html);
					settings.DeletedMailView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : this.paginator,
					i18n : i18n,
				});
				return html;
			},
			regions : {
				deletedMailRegion : 'div.box_tbl',
			},
			initialize : function(options) {
				this.parentView = options.parentView;
				this.paginator = options.paginator;
				this.collection = options.paginator;

				this.listenTo(this.collection, 'sync', this.paginationView);
			},
			onRender : function() {
				var self = this;
				this.deletedMailRegion.show(new settings.DeletedMailListView({
					parentView : this,
					collection : this.paginator,
				}));

				var $period = self.$el.find('select#search_area:first');
				var $startDate = self.$el.find('input.sDate:first');
				var $endDate = self.$el.find('input.eDate:first');

				$period.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var period = $(this).val();
					if (period == 'custom') {
						$($startDate).add($endDate).removeAttr('disabled').val('');
						return false;
					}
					$($startDate).add($endDate).removeAttr('disabled');
					var now = new Date(), date = new Date();
					switch (period) {
					case '1w':
						date.setDate(now.getDate() - 7);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '1m':
						date.setMonth(now.getMonth() - 1);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '3m':
						date.setMonth(now.getMonth() - 3);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					default:
						$($startDate).add($endDate).attr('disabled', 'disabled').val('');
					}
				});
				$period.change();

				$startDate.datepicker();
				$endDate.datepicker();

				var $detailSearch = self.$el.find('#find-filter-button');
				var $detailSearchKeyword = self.$el.find('.detail_search_keyword');
				var $searchIndexOption = self.$el.find('.search_index_option');
				var $searchAreaIndex = self.$el.find('.search_area_index');

				$detailSearch.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.collection.clearSearch();
					var term = '';

					self.collection.server_api['search.deleted_from'] = term.substring(0, term.length - 1);

					if ($detailSearchKeyword.val()) {
						self.collection.server_api['search.' + $searchIndexOption.val()] = $detailSearchKeyword.val();
					}

					if ($startDate.val() != '' && $endDate.val() != '') {
						var pattern = /^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/;
						if (!pattern.test($startDate.val()) || !pattern.test($endDate.val())) {
							return false;
						}
						self.collection.server_api['search.dateOption'] = $searchAreaIndex.val();
						self.collection.startDate = $startDate.val();
						self.collection.endDate = $endDate.val();
					}
					self.collection.goTo(1);
					return false;

				});

				var $selectPerPage = self.$el.find('select.select_bt');
				$selectPerPage.children('option').each(function() {
					var $this = $(this);
					var perPage = self.collection.server_api.perPage;
					if ($this.val() == perPage) {
						$selectPerPage.children('option').removeAttr('selected');
						$this.attr('selected', 'selected');
					}
				});
				$selectPerPage.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var perPage = $(this).val();
					var server_api = self.collection.server_api;
					server_api.perPage = perPage;
					self.collection.goTo(1);
				});
				this.paginationView();

				var $restore = self.$el.find('div.new_mail_area>p>button:first');
				$restore.click(function(event) {
					event.preventDefault() && event.stopPropagation();

					var $checkboxes = self.$el.find('tbody.deleted-mail-list .clk > input:checkbox[name="id"]');
					self.restoreMails($checkboxes);
				});

				var $restoreAll = self.$el.find('div.new_mail_area>p>button').eq(1);
				$restoreAll.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.deletedMail.deletedListAllRestore)) {
						self.restoreAllMails();
					}
				});

				$detailSearchKeyword.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						$detailSearch.click();
					}
				});
			},
			paginationView : function() {
				var self = this;
				if (!this.$pagination) {
					this.$pagination = this.$el.find('.mc-paginate');
				}
				var paginationView = new settings.PaginationView({
					collection : this.collection,
				});
				this.$pagination.empty().append(paginationView.render().$el.children());
			},
			restoreMails : function($checkboxes) {
				var self = this;
				var ids = [];
				$checkboxes.each(function() {
					if (!this.checked)
						return;
					var logId = this.value;
					var mailModel = self.collection.find(function(model) {
						return logId == model.get('id');
					});
					if (mailModel)
						ids.push(mailModel.get('id'));
				});
				if (ids.length === 0) {
					alert(i18n.deletedMail.pleaseSelectMailList);
					return;
				}
				app.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					url : function() {
						var url = 'logging/deleted/' + app.userModel.get('USERS_IDX') + '/mails';
						for (var i = 0; i < ids.length; i++) {
							url += (i == 0 ? '?' : '&') + 'id=' + ids[i];
						}
						return url;
					},
					defaults : {
						id : 'mails'
					}
				}))();
				var jqXHR = model.destroy({
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					app.overlayView.hideProcessing();
					var paginator = self.collection;
					if ($checkboxes.length == ids.length && ids.length == data.deleted) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
						} else {
							paginator.pager();
						}
					} else {
						paginator.pager();
					}
					self.collection.fetch();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					app.overlayView.hideProcessing();
					alert('Failed to Restore mails.');
				});
			},

			restoreAllMails : function() {
				var self = this;
				var searchids = [];
				var searchField = [ "username", "deleted_from", "sender", "mail_to", "content", "subject" ];
				var server_api = self.collection.server_api;
				self.collection.find(function(model) {
					searchids.push(model.get('id'));
				});
				if (searchids.length === 0) {
					alert(i18n.deletedMail.nonDeletedList);
					return;
				}
				app.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({

					url : function() {
						var url = "logging/deleted/" + app.userModel.get('USERS_IDX') + "/restore/all?firstPage="
								+ self.collection.firstPage + "&currentPage=" + self.collection.currentPage
								+ "&perPage=" + self.collection.perPage + "&sortField=" + self.collection.sortField
								+ "&sortOrder=" + self.collection.sortOrder;
						if (self.searchSimple) {
							url += "&" + searchField[0] + "=" + server_api['search.' + searchField[0]];
						} else {
							if (self.collection.startDate && self.collection.endDate) {
								url = url + "&dateOption=" + server_api['search.dateOption'] + "&startDate="
										+ self.collection.startDate + "&endDate=" + self.collection.endDate;
							}
							for (var i = 0; i < searchField.length; i++) {
								if (server_api['search.' + searchField[i]]) {
									url = url + "&" + searchField[i] + "=" + server_api['search.' + searchField[i]];
								}
							}
						}
						return url;
					},
					defaults : {
						id : '0',
					},
				}))();
				var jqXHR = model.destroy({
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					var paginator = self.collection;
					paginator.pager();
					self.collection.fetch();
					alert(data.deleted + i18n.deletedMail.resultDeltedListRestore);
					app.overlayView.hideProcessing();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					app.overlayView.hideProcessing();
					alert('Failed to Restore mails.');
				});
			},
		}); // settings.DeletedMailView

		settings.DeletedMailItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = settings.DeletedMailItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#deleted-mail-item-template').html();
					compiledTemplate = _.template(html);
					settings.DeletedMailItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mail : data,
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var self = this;
			}
		});

		settings.DeletedMailEmptyView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = settings.DeletedMailEmptyView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#deleted-mail-empty-template').html();
					compiledTemplate = _.template(html);
					settings.DeletedMailEmptyView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
		});

		settings.DeletedMailListView = Backbone.Marionette.CompositeView.extend({
			// parentEl : '#divList',
			itemView : settings.DeletedMailItemView,
			itemViewContainer : '.deleted-mail-list',
			emptyView : settings.DeletedMailEmptyView,
			template : function(data) {
				var html, compiledTemplate = settings.DeletedMailListView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#deleted-mail-list-template').html();
					compiledTemplate = _.template(html);
					settings.DeletedMailListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : this.collection,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.DeletedMailLoggingPaginator
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;

				var $spanTotalRecord = self.$el.find('tfoot>tr>th.pl10>strong');
				if (this.collection) {
					var totalRecords = this.collection.totalRecords || 0;
					$spanTotalRecord.text(totalRecords);
				}

				var $checkboxes = self.$el.find('tbody.deleted-mail-list .clk > input:checkbox[name="id"]');
				var $allchecked = self.$el.find('input:checkbox[name="multi_chk_all"]');
				$checkboxes.click(function(event) {
					var result = true;
					$checkboxes.each(function() {
						if (!this.checked) {
							result = false;
						}
					});
					if (result) {
						$allchecked[0].checked = true;
					} else {
						$allchecked[0].checked = false;
					}
				});

				$allchecked.click(function(event) {
					if ($checkboxes) {
						if ($allchecked[0].checked) {
							$checkboxes.each(function() {
								if (!this.checked) {
									this.checked = true;
								}
							});
						} else {
							$checkboxes.each(function() {
								if (this.checked) {
									this.checked = false;
								}
							});
						}
					}
				});

			},
			paginateDeletedMails : function() {

			},
		});

		settings.ConfirmUserPasswordView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'edit_layer',
			attributes : {
				style : 'width: 480px; display: none; position: absolute;',
			},
			template : function(data) {
				var html;
				var compiledTemplate = settings.ConfirmUserPasswordView.compiledTemplate;
				if (!compiledTemplate) {
					html = settings.$template.filter('#confirm-user-password-template').html();
					compiledTemplate = _.template(html);
					settings.ConfirmUserPasswordView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == user.UserModel
				this.attributes = options.attributes;
				this.parentView = options.parentView;
			},
			onBeforeRender : function() {
				settings.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this;
				var $captchaRefresh = this.$el.find('a.mc-captcha-refresh');
				$captchaRefresh.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $captchaImg = self.$el.find('img[name=captcha-image]');
					$captchaImg.attr('src', 'img/captcha?_=' + new Date().getTime());
					return false;
				});
				var $confirm = this.$el.find('div.addButton button.confirm-password');
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var currentPassword = self.$el.find('input:password[name=current-password]').val();
					var captcha = self.$el.find('input:text[name=captcha]').val();
					self.attributes['USERS_CURRENT_PASSWD'] = currentPassword;
					self.attributes['captcha'] = captcha;
					self.parentView.userProfileSave(self.attributes);
					self.close();
					return false;
				});
				var $close = this.$el.find('a.close-confirm-password');
				var $cancel = this.$el.find('div.addButton button.cancel-password');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
			onClose : function() {
				settings.overlayView.hideOverlay();
			},
		});

		settings.OverlayView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			template : function(data) {
				var html;
				var compiledTemplate = settings.OverlayView.compiledTemplate;
				if (!compiledTemplate) {
					var templateId = '#settings-overlay-template';
					html = settings.$template.filter(templateId).html();
					compiledTemplate = _.template(html);
					settings.OverlayView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == No Model
			},
			onRender : function() {
				var self = this;
				this.$overlay = $('body > #settings-overlay');
				if (this.$overlay.length) {
					return;
				}
				this.$overlay = this.$el.children('#settings-overlay');
				this.$loadingLayer = this.$overlay.children('.settings-loading-layer');
				this.$savingLayer = this.$overlay.children('.settings-saving-layer');
				this.$processingLayer = this.$overlay.children('.settings-processing-layer');
				this.$uploadingMailLayer = this.$overlay.children('.settings-uploading-mail-layer');
				this.$overlay.appendTo('body');
				this.$overlay.on('mousedown', function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				if (document.styleSheets && document.styleSheets[0]) {
					var styles = '';
					styles += '-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";';
					styles += 'filter: alpha(opacity=50);';
					styles += '-moz-opacity: 0.5;';
					styles += '-khtml-opacity: 0.5;';
					styles += 'opacity: 0.5;';
					var styleSheet = document.styleSheets[0];
					var rules;
					try {
						rules = styleSheet.cssRules || styleSheet.rules;
					} catch (error) {
						styleSheet = _.find(document.styleSheets, function(styleSheet) {
							var href = styleSheet.href;
							var css = href.substring(href.lastIndexOf('/') + 1);
							return css == 'default.css';
						});
						rules = styleSheet.cssRules || styleSheet.rules;
					}
					if (styleSheet.insertRule) {
						styleSheet.insertRule('#settings-overlay {' + styles + '}', rules.length);
					} else if (styleSheet.addRule) {
						styleSheet.addRule('#settings-overlay', styles, rules.length);
					}
				}
				this.$viewport = $(window);
				this.$viewport.on('resize.settings-overlay', function(event) {
					var viewportWidth = self.$viewport.width() / 2;
					var viewportHeight = self.$viewport.height() / 2;
					var width = self.$loadingLayer.width() / 2;
					var height = self.$loadingLayer.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					self.$loadingLayer.css({
						'top' : top,
						'left' : left,
					});
					width = self.$savingLayer.width() / 2;
					height = self.$savingLayer.height() / 2;
					top = Math.floor(viewportHeight - height);
					left = Math.floor(viewportWidth - width);
					self.$savingLayer.css({
						'top' : top,
						'left' : left,
					});
					width = self.$processingLayer.width() / 2;
					height = self.$processingLayer.height() / 2;
					top = Math.floor(viewportHeight - height);
					left = Math.floor(viewportWidth - width);
					self.$processingLayer.css({
						'top' : top,
						'left' : left,
					});
					width = self.$uploadingMailLayer.width() / 2;
					height = self.$uploadingMailLayer.height() / 2;
					top = Math.floor(viewportHeight - height);
					left = Math.floor(viewportWidth - width);
					self.$uploadingMailLayer.css({
						'top' : top,
						'left' : left,
					});
				});
				this.$viewport.trigger('resize.settings-overlay');
				this.$loadingLayer.hide();
				this.$savingLayer.hide();
				this.$processingLayer.hide();
				this.$uploadingMailLayer.hide();
				this.$overlay.hide();
			},
			onClose : function() {
				this.$viewport.off('resize.settings-overlay');
				this.$overlay.remove();
			},
			showOverlay : function() {
				this.$viewport.trigger('resize.settings-overlay');
				this.$overlay.show();
			},
			hideOverlay : function() {
				this.$overlay.fadeOut();
			},
			showLoading : function() {
				this.showOverlay();
				this.$loadingLayer.show();
			},
			hideLoading : function() {
				this.$loadingLayer.fadeOut();
				this.hideOverlay();
			},
			showSaving : function() {
				this.showOverlay();
				this.$savingLayer.show();
			},
			hideSaving : function() {
				this.$savingLayer.fadeOut();
				this.hideOverlay();
			},
			showProcessing : function() {
				this.showOverlay();
				this.$processingLayer.show();
			},
			hideProcessing : function() {
				this.$processingLayer.fadeOut();
				this.hideOverlay();
			},
			showUploadingMail : function() {
				this.showOverlay();
				this.$uploadingMailLayer.show();
			},
			hideUploadingMail : function() {
				this.$uploadingMailLayer.fadeOut();
				this.hideOverlay();
			},
		});

	}); // app.module('settings', function(settings, app, Backbone,..)
	// {...});

}); // define(['app', 'app/app-models'], function(app){...});
w(      c[c[E6MccU   {    O^partitionKey=%28http%2Cseoultech.ac.kr%29,:http://mail.seoultech.ac.kr/mail/app/settings/settings-views.js?v=202301181454 necko:classified 1 strongly-framed 1 request-method GET response-head HTTP/1.1 200 
Accept-Ranges: bytes
ETag: W/"369458-1664418076000"
Last-Modified: Thu, 29 Sep 2022 02:21:16 GMT
Content-Type: application/javascript;charset=UTF-8
Content-Length: 369458
Date: Wed, 01 Feb 2023 07:57:14 GMT
 original-response-headers Accept-Ranges: bytes
ETag: W/"369458-1664418076000"
Last-Modified: Thu, 29 Sep 2022 02:21:16 GMT
Content-Type: application/javascript;charset=UTF-8
Content-Length: 369458
Date: Wed, 01 Feb 2023 07:57:14 GMT
 ctid 2 uncompressed-len 0 net-response-time-onstart 17 net-response-time-onstop 41  2