define([ 'app', 'text!app/mail/mail-template.html', 'i18n!app/mail/nls/mail-i18n',
		'i18n!app/settings/nls/settings-i18n', 'app/settings/settings-views', 'app/user/user-models',
		'app/disk/disk-models' ], function(app, template, i18n, settingsNLS) {

	app.module('mail', function(mail, app, Backbone, Marionette, $, _) {

		mail.$template = $(template);

		function isPopup() {
			try {
				if (window.opener && window.opener.location.pathname != window.location.pathname)
					return true;
				if (/.*\/popup\/.*/.test(window.location.pathname))
					return true;
				else
					return false;
			} catch (error) {
				if (/.*\/popup\/.*/.test(window.location.pathname))
					return true;
				else
					return false;
			}
		}

		mail.SidebarView = Backbone.Marionette.Layout.extend({
			template : function(data) {
				app.debug("  mail.SidebarView.template() { ... }");
				var html, compiledTemplate = mail.SidebarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#sidebar-template').html();
					compiledTemplate = _.template(html);
					mail.SidebarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					app : app,
					mboxCollection : mail.mboxCollection,
					i18n : i18n,
				});
				return html;
			},
			regions : {
				customMboxesRegion : '.mc-section_myMail.custom-mboxes .mc-list_menu',
				searchMboxesRegion : '.mc-section_myMail.schb .mc-list_menu',
				labelsRegion : '.mc-section_myMail.taglst .mc-list_menu',
			},
			initialize : function(options) {
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.userModel, 'approver:verified', this.render);
				this.listenTo(app.userModel, 'search-mbox:enabled', this.render);
				this.listenTo(app.userModel, 'mail-label:enabled', this.render);
				this.listenTo(app.vent, 'activate:mbox-item', this.activateMboxItem);
			},
			onRender : function() {
				var self = this;
				// Compose
				var $compose = this.$el.find('a.mc-btn_quick:first');
				var $composeForMe = this.$el.find('a.mc-btn_import:first');
				var $composeLinks = $compose.add($composeForMe);
				$composeLinks.click(function(event) {
					var link = document.createElement("a");
					var hash = $(this).attr('href');
					link.href = hash.substring(hash.indexOf('#') + 1);
					var pathname = link.pathname;
					if (pathname.indexOf('/') === 0) {
						var lastSlashIndex = pathname.lastIndexOf('/');
						pathname = pathname.substring(lastSlashIndex + 1);
					}
					var href = '#' + pathname + '?';
					href += '_=' + (Date.now ? Date.now() : new Date().getTime());
					if (app.userModel.get('COMPOSE_NEW_WINDOW')) {
						var win = window.open('popup/' + href, '', 'scrollbars=yes,width=1000,height=800');
						win.focus();
						return false;
					} else {
						$(this).attr('href', href);
					}
				});
				// Attach to me
				this.attachToMe();
				// Custom Mailboxes
				var mboxes = this.collection.filter(function(mboxModel) {
					return mboxModel.get('MBOX_TYPE') === 6 && mboxModel.get('MBOX_REF') === 0;
				});
				var customMboxesView = new mail.CustomMboxesView({
					collection : new mail.MboxCollection(mboxes),
					mboxCollection : this.collection
				});
				this.customMboxesRegion.show(customMboxesView);
				var $customMboxesWrapper = this.customMboxesRegion.$el.parent();
				var $toggleCustomMboxes = $customMboxesWrapper.find('.mc-lft_mTit .mc-btn_fd_up');
				$toggleCustomMboxes.click(function(event) {
					var $header = $customMboxesWrapper.children('.mc-lft_mTit');
					if (self.customMboxesRegion.$el.toggle().is(':visible'))
						$header.removeClass('mc-lft_mTit_active')
					else
						$header.addClass('mc-lft_mTit_active');
					return false;
				});
				var $addMbox = $customMboxesWrapper.find('a.mc-btn_add:first');
				$addMbox.click(function(event) {
					event.preventDefault();
					if (self.customMboxesRegion.$el.is(':hidden')) {
						$toggleCustomMboxes.click();
					}
					customMboxesView.newMboxItemView();
					return true;
				});
				$customMboxesWrapper.droppable({
					tolerance : 'pointer',
					accept : function(element) {
						if (element.data('mbox-id')) {
							return true;
						}
						return false;
					},
					drop : function(event, ui) {
						var mboxId = ui.draggable.data('mbox-id');
						var mboxModel = mail.mboxCollection.findModel('MBOX_IDX', mboxId);
						var filtered = mail.mboxCollection.filter(function(model) {
							if (model.get('MBOX_TYPE') === 6 && model.get('MBOX_REF') === 0
									&& model.get('MBOX_NAME') === mboxModel.get('MBOX_NAME')) {
								return true;
							}
							return false;
						});
						if (filtered.length) {
							if (filtered[0] === mboxModel)
								return;
							alert(i18n.mailboxNameAlreadyExists + ': ' + mboxModel.get('MBOX_NAME'));
							return;
						}
						var originalParentId = mboxModel.get('MBOX_REF');
						mboxModel.save({
							MBOX_REF : 0
						}, {
							async : false,
							patch : true,
							wait : true,
							error : function(model, response, options) {
								model.set('MBOX_REF', originalParentId);
							},
						});
					},
					over : function(event, ui) {
						$customMboxesWrapper.find('.mc-btn_fd_up:first').css('cursor', 'default');
					},
					out : function(event, ui) {
						$customMboxesWrapper.find('.mc-btn_fd_up:first').css('cursor', '');
					},
				});
				// Search Mailboxes
				if (app.userModel.get('SEARCH_MBOX_ENABLED')) {
					var searchMboxesView = new mail.SearchMboxesView({
						collection : mail.searchMboxCollection,
					});
					this.searchMboxesRegion.show(searchMboxesView);
					var $searchMboxesWrapper = this.searchMboxesRegion.$el.parent();
					var $addSearchMbox = $searchMboxesWrapper.find('a.mc-btn_add:first');
					$addSearchMbox.click(function(event) {
						event.preventDefault() && event.stopPropagation();
						if (mail.searchMboxCollection.size() >= 10) {
							alert(i18n.searchMbox.exceededMaximumNumbers);
							return false;
						}
						if (self.searchMboxesRegion.$el.is(':hidden')) {
							$searchMboxesWrapper.find('.mc-lft_mTit .mc-btn_fd_up').click();
						}
						if (self.searchMboxRegisterView) {
							self.searchMboxRegisterView.close();
						}
						var zIndex = mail.overlayView.$overlay.css('z-index');
						self.searchMboxRegisterView = new mail.SearchMboxRegisterView({
							model : new mail.SearchMboxModel(),
							collection : mail.searchMboxCollection,
							mboxCollection : self.collection,
						});
						var $searchMboxRegisterView = self.searchMboxRegisterView.render().$el;
						$searchMboxRegisterView.css('z-index', parseInt(zIndex) + 1);
						$searchMboxRegisterView.show().appendTo('body');
						var $viewport = $(window);
						$viewport.off('resize.searchMboxRegister');
						$viewport.on('resize.searchMboxRegister', function(event) {
							var parentWidth = $viewport.width() / 2;
							var parentHeight = $viewport.height() / 2;
							var width = $searchMboxRegisterView.width() / 2;
							var height = $searchMboxRegisterView.height() / 2;
							var top = Math.floor(parentHeight - height);
							var left = Math.floor(parentWidth - width);
							$searchMboxRegisterView.css({
								'top' : top,
								'left' : left
							});
						});
						$viewport.trigger('resize.searchMboxRegister');
					});
				}
				// Labels
				if (app.userModel.get('MAIL_LABEL_ENABLED')) {
					var labelsView = new mail.LabelsView({
						collection : mail.labelCollection,
					});
					this.labelsRegion.show(labelsView);
					var $labelsWrapper = this.labelsRegion.$el.parent();
					var $addLabel = $labelsWrapper.find('a.mc-btn_add:first');
					$addLabel.click(function(event) {
						event.preventDefault() && event.stopPropagation();
						if (mail.labelCollection.size() >= 10) {
							alert(i18n.label.exceededMaximumNumbers);
							return false;
						}
						if (self.labelsRegion.$el.is(':hidden')) {
							$labelsWrapper.find('.mc-lft_mTit .mc-btn_fd_up').click();
						}
						var labelModel = new mail.LabelModel();
						app.vent.trigger('show:label-add', event, mail.labelCollection, labelModel);
						return false;
					});
				}
				// Mailbox Links
				var $all = this.$el.find('a.mc-bu1:first');
				var $unseen = this.$el.find('a.mc-atc');
				var $inbox = this.$el.find('a.mc-bu2:first');
				var $sentMe = this.$el.find('a.mc-bu3:first');
				var $sent = this.$el.find('a.mc-bu4:first');
				var $drafts = this.$el.find('a.mc-bu5:first');
				var $junk = this.$el.find('a.mc-bu6:first');
				var $trash = this.$el.find('a.mc-bu7:first');
				var $important = this.$el.find('a.mc-bu8:first');
				var $attached = this.$el.find('a.mc-bu9:first');
				var $customMboxes = this.$el.find('a.mc-folder_name');
				var $approvalSent = this.$el.find('a.mc-bu12:first');
				var $approvalInbox = this.$el.find('a.mc-bu13:first');
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					mail.approvalMboxCollection.fetch({
						success : function(collection, response, options) {
							if (!collection.length)
								return;
							collection.each(function(model) {
								var $count = $approvalSent.parent('li').children('a.mc-atc').children('em');
								if (model.get('mboxName') == 'inbox')
									$count = $approvalInbox.parent('li').children('a.mc-atc').children('em');
								if ($count.length && model.get('requestCount'))
									$count.text(model.get('requestCount'))
							});
						},
					});
				}
				var $restore = this.$el.find('a.mc-bu14:first');
				var $mboxLinks = $all.add($inbox).add($sentMe).add($sent).add($drafts).add($junk).add($trash).add(
						$important).add($attached).add($customMboxes).add($approvalSent).add($approvalInbox).add(
						$restore);
				$mboxLinks.click(function(event) {
					var link = document.createElement('a');
					link.href = $(this).attr('href').substring(1);
					var pathname = link.pathname;
					if (pathname.indexOf('/') == 0) {
						var index;
						if (pathname.indexOf('approval') != -1) {
							index = pathname.indexOf('/approval/');
						} else if (pathname.indexOf('labels') != -1) {
							index = pathname.indexOf('/labels/');
						} else {
							index = pathname.indexOf('/mboxes/');
						}
						pathname = pathname.substring(index + 1);
					}
					var href = '#' + pathname + '?';
					if (link.search) {
						var query = link.search.substring(1);
						var pairs = query.split('&');
						for (var i = 0; i < pairs.length; i++) {
							var pos = pairs[i].indexOf('=');
							if (pos == -1)
								continue;
							var name = pairs[i].substring(0, pos);
							var value = pairs[i].substring(pos + 1);
							if (name == '_')
								continue;
							if (i > 0)
								href += '&';
							href += name + '=' + value;
						}
						if (pairs.length > 0 && /^_=/.test(pairs[0]) == false)
							href += '&';
					}
					href += '_=' + (Date.now ? Date.now() : new Date().getTime());
					app.debug("mboxLink : " + href);
					$(this).attr('href', href);
				});
				$mboxLinks.add($unseen).not('.secu_folder').click(function(event) {
					self.collection.fetch();
				});
				var $emptyMbox = this.$el.find('.mc-list_menu .mc-btn_clean');
				$emptyMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					var mboxName = self.getMboxNameById(mboxId);
					var msg = '', i18n = settingsNLS;
					if (app.userModel.get('USERS_DELBOX') == 'Y' && mboxModel.get('MBOX_TYPE') != 3
							&& mboxModel.get('MBOX_TYPE') != 5) {
						msg = i18n.mboxes.leadingConfirmMailboxEmpty + mboxName
								+ i18n.mboxes.trailingConfirmMailboxEmpty;
					} else {
						msg = i18n.mboxes.leadingConfirmMailboxPermanentlyEmpty + mboxName
								+ i18n.mboxes.trailingConfirmMailboxPermanentlyEmpty;
					}
					if (!confirm(msg)) {
						return false;
					}
					var model = new (app.BackboneModel.extend({
						urlRoot : 'mboxes/' + mboxId,
						defaults : {
							id : 'emails'
						},
					}))();
					mail.overlayView.showProcessing();
					model.destroy({
						wait : true,
						success : function(model, response, options) {
							self.collection.fetch();
							mail.overlayView.hideProcessing();
							mail.paginator.pager();
						},
					});
					app.userModel.fetch();
					return false;
				});
				if (this.mboxPasswordView)
					this.mboxPasswordView.close();
				this.mboxPasswordView = new mail.MboxPasswordView();
				if (this.mboxContextMenuView)
					this.mboxContextMenuView.close();
				this.mboxContextMenuView = new mail.MboxContextMenuView();
				var $systemMboxItems = $inbox.parent().add($sent.parent()).add($drafts.parent()).add($junk.parent())
						.add($trash.parent());
				$systemMboxItems.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).data('mbox-id');
					var mboxModel = self.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === mboxId;
					});
					app.vent.trigger('contextmenu:mbox', event, mboxModel);
					return false;
				});
				this.$el.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					return false;
				}).click(function(event) {
					app.$hidablesListener.trigger('hide.all');
					return true;
				});
				$systemMboxItems.droppable({
					tolerance : 'pointer',
					accept : function(element) {
						var mailIds = element.data('mail-ids');
						if (mailIds && mailIds.length) {
							return true;
						}
						return false;
					},
					drop : function(event, ui) {
						var mailIds = ui.draggable.data('mail-ids');
						var mboxId = $(this).data('mbox-id');
						var mboxModel = self.collection.find(function(model) {
							return model.get('MBOX_IDX') === mboxId;
						});
						var model = new (app.BackboneModel.extend({
							urlRoot : 'mboxes/' + mail.mboxModel.get('MBOX_IDX'),
							defaults : {
								id : 'mails'
							}
						}))();
						var jqXHR = model.save({
							MBOX_IDX : mboxModel.get('MBOX_IDX'),
							mailIds : mailIds,
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								// deferred success callback to jqXHR.done()
							},
							error : function(model, response, options) {
								// deferred error callback to jqXHR.fail()
							},
						});
						jqXHR.done(function(data, textStatus, jqXHR) {
							var paginator = mail.paginator;
							if (paginator.length == mailIds.length && mailIds.length == data.updated) {
								var info = paginator.info();
								if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
									var args = {
										page : info.currentPage - 1
									};
									location.hash = '#' + paginator.getURL(args);
									mail.mboxCollection.fetch();
									return;
								}
							}
							paginator.pager();
							mail.mboxCollection.fetch();
						}).fail(function(jqXHR, textStatus, errorThrown) {
							alert('Failed to move mails.');
						});
					},
				});
				var $blobAttachments = this.$el.find('a.blob-attachments');
				$blobAttachments.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = isPopup() ? '../popup/disk' : 'popup/disk';
					var win = window.open(url, 'blobAttachments', 'width=880,height=600,resizable=yes,location=no');
					win.focus();
					return false;
				});
				var $sms = this.$el.find('a.mc-bu15');
				$sms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = isPopup() ? '../popup/sms' : 'popup/sms';
					var win = window.open(url, 'mailSms', 'width=620,height=512,resizable=no');
					win.focus();
					return false;
				});
				if (mail.paginator.labelId) {
					this.activateMboxItem(mail.labelModel);
				} else if (mail.paginator.params && mail.paginator.params['search']) {
					var terms = '';
					var search = mail.paginator.params['search'];
					if (typeof search == 'object') {
						for ( var p in search) {
							if (p == 'startDate' || p == 'endDate')
								continue;
							if (terms.length)
								terms += '&';
							terms += 'search.' + p + '=' + search[p];
						}
					}
					var searchMboxModel = new mail.SearchMboxModel({
						mbox : mail.mboxModel.get('MBOX_IDX'),
						terms : terms,
					});
					this.activateMboxItem(searchMboxModel);
				} else if (mail.approvalMboxModel.headerView) {
					this.activateMboxItem(mail.approvalMboxModel);
				} else {
					this.activateMboxItem(mail.mboxModel);
				}
				var $sidebarScrollRegion = this.$el.find('div.mc-svc_menu_area');
				if (this.sidebarScrollY)
					$sidebarScrollRegion.scrollTop(this.sidebarScrollY);
				$sidebarScrollRegion.scroll(function() {
					self.sidebarScrollY = $(this).scrollTop();
				});
			}, // onRender : function() {...}
			onClose : function() {
				if (this.mboxPasswordView)
					this.mboxPasswordView.close();
				if (this.mboxContextMenuView)
					this.mboxContextMenuView.close();
			},
			getMboxNameById : function(mboxId) {
				if (mboxId == 'delivery-status') {
					return i18n.mbox.deliveryStatus;
				}
				var mboxModel = this.collection.find(function(mboxModel) {
					return mboxModel.get('MBOX_IDX') === mboxId;
				});
				if (!mboxModel) {
					return null;
				}
				var mboxName = mboxModel.get('MBOX_NAME');
				switch (mboxModel.get('MBOX_TYPE')) {
				case 1:
					mboxName = i18n.mbox.inbox;
					break;
				case 2:
					mboxName = i18n.mbox.sent;
					break;
				case 3:
					mboxName = i18n.mbox.trash;
					break;
				case 4:
					mboxName = i18n.mbox.drafts;
					break;
				case 5:
					mboxName = i18n.mbox.junk;
					break;
				}
				return mboxName;
			},
			attachToMe : function() {
				var self = this;
				var $attach = this.$el.find('a#attach_to_me:first');
				$attach.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var uid = function() {
						var now = Date.now ? Date.now() : new Date().getTime();
						var random = Math.floor(Math.random() * 1000000);
						return now + '.' + random;
					};
					var formatSize = function(number, pattern) {
						pattern = pattern ? pattern : '0[.]00b';
						return number ? numeral(number).format(pattern) : '0KB';
					};
					var uploadAttachments = function(files) {
						var blobsUsage = 0, blobsQuota = 0;
						$.ajax({
							async : false,
							url : 'bigmail.file.do?cmd=bigmailAttacheQuota',
							success : function(data, textStatus, jqXHR) {
								var lines = data.split(/\r\n|\r|\n/);
								var line, tokens;
								for (var i = 0; i < lines.length; i++) {
									line = lines[i];
									switch (i) {
									case 0: // Result_Code=200
										if (line == 'Result_Code=500') {
											blobsUsage = 0;
											blobsQuota = 0;
											return;
										}
										break;
									case 1: // Disk_Usage=0
										tokens = line.split('=');
										blobsUsage = parseInt(tokens[1]);
										break;
									case 2: // Disk_Quota=1073741824
										tokens = line.split('=');
										blobsQuota = parseInt(tokens[1]);
										break;
									}
								}
							},
							error : function(jqXHR, textStatus, errorThrown) {
								blobsUsage = 0;
								blobsQuota = 0;
							}
						});
						var blobsFree = blobsQuota - blobsUsage;
						var filesMaxSize = app.domainModel.get('DOMAIN_LIMIT_UPLOAD') * 1024 * 1024;
						var filesSize = 0, blobsSize = 0;
						var models = [];
						for (var i = 0; i < files.length; i++) {
							var file = files[i];
							var $item = $({});
							$item.data('attachment-id', 'items-' + i);
							$item.data('attachment-name', file.name);
							$item.data('attachment-size', file.size);
							switch (file.type) {
							case 'file':
							case 'blob':
								$item.data('attachment-type', file.type);
								break;
							default:
								var sum = filesSize + file.size;
								if (blobsQuota == 0 && (file.size > filesMaxSize || sum > filesMaxSize)) {
									alert(i18n.attachment.leadingMaxFileSize + formatSize(filesMaxSize)
											+ i18n.attachment.middlingMaxFileSize + formatSize(filesSize)
											+ i18n.attachment.trailingMaxFileSize);
									return;
								}
								if (file.size > filesMaxSize || sum > filesMaxSize) {
									var free = blobsFree - blobsSize - file.size;
									if (free < 0) {
										alert(i18n.attachment.leadingMaxBlobSize + formatSize(blobsFree)
												+ i18n.attachment.middlingMaxBlobSize + formatSize(blobsSize)
												+ i18n.attachment.trailingMaxBlobSize);
										return;
									}
									$item.data('attachment-type', 'blob');
									blobsSize += file.size;
								} else {
									$item.data('attachment-type', 'file');
									filesSize += file.size;
								}
								break;
							} // switch (file.type) {...}
							$item.data('attachment-loaded', (file.loaded ? file.loaded : 0));
							$item.data('attachment-status', (file.status ? file.status : 'queued'));
							models.push({
								id : file.id ? file.id : uid(),
								item : $item,
								file : file,
							});
						}
						var collection = new Backbone.Collection(models);
						var options = {
							fileUploadURL : 'attachments/file',
							blobUploadURL : 'attachments/blob',
							form : 'form[name="attach_to_me_form"]',
							fileInputName : 'attache_file',
							blobInputName : 'bigmail_file',
							zIndex : 2015,
						};
						var uploadView = new mail.AttachmentsUploadView({
							collection : collection,
							parentView : {
								options : options,
								$filesSize : $({}),
								$blobsSize : $({}),
								$blobsFree : $({}),
							},
						});
						var $uploadView = uploadView.render().$el;
						var zIndex = mail.overlayView.$overlay.css('z-index');
						$uploadView.css('z-index', (isNaN(zIndex) ? 'auto' : parseInt(zIndex) + 1));
						$uploadView.show().appendTo('body');
						var $viewport = $(window);
						$viewport.off('resize.attachToMe');
						$viewport.on('resize.attachToMe', function(event) {
							var viewportWidth = $(this).width() / 2;
							var viewportHeight = $(this).height() / 2;
							var width = $uploadView.width() / 2;
							var height = $uploadView.height() / 2;
							var top = Math.floor(viewportHeight - height);
							var left = Math.floor(viewportWidth - width);
							$uploadView.css({
								top : top,
								left : left
							});
						});
						$viewport.trigger('resize.attachToMe');
						uploadView.upload(function() {
							uploadView.close();
							var $form = $(options.form);
							var attachments = [];
							$form.find('input').each(function(index, element) {
								var $input = $(element);
								var name = $input.attr('name');
								var value = $input.val();
								switch (name) {
								case options.fileInputName:
									if (value) {
										var size = $input.data('file-size');
										attachments.push({
											num : index,
											name : value,
											size : isNaN(size) ? 0 : parseInt(size),
											type : 'file'
										});
									}
									break;
								case options.blobInputName:
									if (value) {
										var size = $input.data('file-size');
										attachments.push({
											num : index,
											name : value,
											size : isNaN(size) ? 0 : parseInt(size),
											type : 'blob'
										});
									}
									break;
								}
							});
							var mailModel = new mail.MailModel();
							var to = app.userModel.get('USERS_IDX');
							var subject = attachments[0].name;
							if (subject.indexOf('/') != -1)
								subject = subject.substring(subject.indexOf('/') + 1);
							subject = decodeURIComponent(subject);
							mailModel.set({
								M_TO : to,
								M_TITLE : subject,
								action : 'send-to-me',
								attachments : attachments,
							});
							mailModel.save(null, {
								async : false,
								wait : true,
								success : function(model, resp, options) {
									setTimeout(function() {
										var now = new Date().getTime();
										location.hash = '#mboxes/sent-me/mails?_=' + now;
									}, 1000);
								},
								error : function(model, resp, options) {
									alert('Failed to send this mail');
								},
							});
						}, null); // uploadView.upload(function(){...}, null);
					}; // var uploadAttachments = function(files) {...}
					var $fileForm = $('body > form[name="attach_to_me_form"]');
					if (!document.forms.attach_to_me_form) {
						$fileForm = $('<form>', {
							'name' : 'attach_to_me_form',
							'style' : 'position: absolute; top: -10000px; left: -10000px;'
						}).appendTo('body');
					} else {
						$fileForm.empty();
					}
					var $fileInput = $('body > input#attachments_to_me');
					if (!$fileInput.length) {
						$fileInput = $('<input>', {
							'id' : 'attachments_to_me',
							'type' : 'file',
							'multiple' : 'true',
							'style' : 'position: absolute; top: -10000px; left: -10000px;'
						}).appendTo('body');
						$fileInput.change(function(event) {
							event.preventDefault() && event.stopPropagation();
							var files = this.files;
							if (files.length == 0) {
								return false;
							}
							mail.overlayView.showOverlay();
							uploadAttachments(files);
							mail.overlayView.hideOverlay();
							$fileInput.remove();
							return false;
						});
					}
					if ($fileInput[0].files) {
						$fileInput.click();
						return false;
					}
					if (!document.attachmentUploadIframe) {
						$('<iframe>', {
							'name' : 'attachmentUploadIframe',
							'src' : 'attachment/form',
							'style' : 'position: absolute; display: none;',
						}).appendTo('body');
					}
					if (document.attachmentUploadIframe) {
						var iframe = document.attachmentUploadIframe;
						var form = iframe.attachmentUploadForm;
						if (!form || !form.attachment)
							return false;
						var changed = false;
						form.attachment.onchange = function() {
							changed = true;
							return false;
						};
						form.attachment.click();
						if (!changed) {
							return false;
						}
						form.submit();
						mail.overlayView.showUploading();
						app.vent.once('attachment:uploaded', function(file) {
							mail.overlayView.hideUploading();
							var iframe = document.attachmentUploadIframe;
							var pathname = iframe.location.pathname;
							var url = pathname.substring(0, pathname.lastIndexOf('/')) + '/form';
							iframe.location.replace(url);
							if (!file) {
								alert(i18n.attachment.cannotUpload);
								return;
							}
							mail.overlayView.showOverlay();
							uploadAttachments([ file ]);
							mail.overlayView.hideOverlay();
						});
					}
					return false;
				}); // $attach.click(function(event) {...});
			}, // attachToMe : function() {...}
			activateMboxItem : function(model) {
				var $all = this.$el.find('div.mc-list_menu ul li a.mc-bu1:first');
				var $inbox = this.$el.find('div.mc-list_menu ul li a.mc-bu2:first');
				var $sentMe = this.$el.find('div.mc-list_menu ul li a.mc-bu3:first');
				var $sent = this.$el.find('div.mc-list_menu ul li a.mc-bu4:first');
				var $drafts = this.$el.find('div.mc-list_menu ul li a.mc-bu5:first');
				var $junk = this.$el.find('div.mc-list_menu ul li a.mc-bu6:first');
				var $trash = this.$el.find('div.mc-list_menu ul li a.mc-bu7:first');
				var $approvalSent = this.$el.find('a.mc-bu12:first');
				var $approvalInbox = this.$el.find('a.mc-bu13:first');
				var $restore = this.$el.find('div.mc-list_menu ul li a.mc-bu14:first');
				var $mboxItems = $all.add($inbox).add($sentMe).add($sent).add($drafts).add($junk).add($trash).add(
						$approvalSent).add($approvalInbox).add($restore);
				var $customMboxItems = this.$el.find('div.custom-mboxes div.reverse-area a.mc-folder_name');
				var $searchMboxItems = this.$el.find('div.schb div.reverse-area a.mc-folder_name');
				var $labelItems = this.$el.find('div.taglst div.reverse-area a.mc-folder_name');
				$mboxItems.parents('li').removeClass('click');
				$customMboxItems.add($searchMboxItems).add($labelItems).parents('div.reverse-area')
						.removeClass('click');
				var urlRoot = '';
				if (!model) {
					return false;
				} else {
					urlRoot = _.result(model, 'urlRoot');
				}
				var $item, $customItem;
				switch (urlRoot) {
				case 'mboxes':
					$item = $mboxItems.filter(function(index) {
						var mboxId = $(this).parent('li').data('mbox-id');
						return model.get('MBOX_IDX') == mboxId;
					});
					$customItem = $customMboxItems.filter(function(index) {
						var mboxId = $(this).data('mbox-id');
						return model.get('MBOX_IDX') == mboxId;
					});
					break;
				case 'search-mboxes':
					$customItem = $searchMboxItems.filter(function(index) {
						var mboxId = $(this).data('mbox-id');
						var terms = $(this).data('mbox-terms');
						return model.get('mbox') == mboxId && model.get('terms') == terms;
					});
					break;
				case 'labels':
					$customItem = $labelItems.filter(function(index) {
						var labelId = $(this).data('label-id');
						return model.get('id') == labelId;
					});
					break;
				}
				if ($item)
					$item.parents('li').addClass('click');
				if ($customItem)
					$customItem.parents('div').addClass('click');
			},
		}); // mail.SidebarView

		mail.MboxItemView = Backbone.Marionette.CompositeView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.MboxItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mbox-item-template').html();
					compiledTemplate = _.template(html);
					mail.MboxItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == [this.model.id === model.get('MBOX_REF')]
			},
			itemViewOptions : function(model, index) {
				var mboxId = model.get('MBOX_IDX');
				var mboxCollection = this.options.mboxCollection;
				var mboxes = mboxCollection.filter(function(model) {
					if (model.get('MBOX_TYPE') !== 6)
						return false;
					return model.get('MBOX_REF') === mboxId;
				});
				return {
					collection : new mail.MboxCollection(mboxes),
					mboxCollection : mboxCollection,
				};
			},
			getLevel : function() {
				var level = 1;
				var mboxCollection = this.options.mboxCollection;
				var parentId = this.model.get('MBOX_REF');
				if (parentId === 0) {
					return level;
				}
				var parentMboxModel = mboxCollection.find(function(mboxModel) {
					return mboxModel.get('MBOX_IDX') === parentId;
				});
				while (parentMboxModel) {
					level++;
					parentId = parentMboxModel.get('MBOX_REF');
					if (parentId === 0)
						break;
					parentMboxModel = mboxCollection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function() {
				var self = this;
				var mboxModel = this.model;
				var mboxCollection = this.options.mboxCollection;
				var level = this.getLevel();
				var $list = this.$el.find('ul:first');
				var $toggle = this.$el.find('button.btn_folder:first');
				$toggle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					var folded = 0;
					if ($list.is(':visible')) {
						self.$el.removeClass('spread_folder').addClass('fold_folder');
						$list.hide();
						folded = 1;
					} else {
						self.$el.removeClass('fold_folder').addClass('spread_folder');
						$list.show();
						folded = 0;
					}
					mboxModel.save({
						FOLDED : folded
					}, {
						patch : true,
						wait : true,
						error : function(model, response, options) {
							app.log('Failed to update mbox folded');
						},
					});
					return false;
				});
				if ($list.children('li').length === 0) {
					$toggle.remove();
				}
				$list.addClass('depth' + level);
				if (mboxModel.get('FOLDED')) {
					this.$el.addClass('fold_folder');
				} else {
					this.$el.addClass('spread_folder');
					$list.show();
				}
				this.$mboxWrapper = this.$el.children('div.reverse-area');
				this.$mboxLinks = this.$mboxWrapper.find('span.item_wrap a');
				this.$mboxNameLink = this.$mboxLinks.filter('a.mc-folder_name');
				this.$renameMbox = this.$mboxLinks.filter('a.mc-btn_modify');
				this.$inputWrapper = this.$mboxWrapper.find('p.mc-folder_name:first');
				this.$input = this.$inputWrapper.children('input:text');
				this.$el.on('mouseover', function(event) {
					self.$mboxWrapper.addClass('ovr');
					self.$renameMbox.show();
					return false;
				});
				this.$el.on('mouseout', function(event) {
					self.$mboxWrapper.removeClass('ovr');
					self.$renameMbox.hide();
					return false;
				});
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					var url = self.$mboxNameLink.attr('href');
					if (mboxModel.get('MBOX_PUBLIC') == 'S') { // Secure Mbox
						url = self.$mboxLinks.filter('a.secu_folder').attr('href');
						app.vent.trigger('confirm:mbox-password', mboxModel, function() {
							location.hash = url + '?_=' + (new Date().getTime());
						});
						return false;
					}
					if (mboxModel.get('SHARING_MBOX_ID') > 0) {
						url = self.$mboxLinks.filter('a.share_doner').attr('href');
					}
					if (mboxModel.get('SHARED_MBOX_ID') > 0) {
						url = self.$mboxLinks.filter('a.share_acc').attr('href');
					}
					location.hash = url;
					return false;
				});
				this.$mboxLinks.filter('.mc-noread_num').click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = $(this).attr('href');
					if (mboxModel.get('MBOX_PUBLIC') == 'S') { // Secure Mbox
						app.vent.trigger('confirm:mbox-password', mboxModel, function() {
							location.hash = url + '&_=' + (new Date().getTime());
						});
						return false;
					}
					location.hash = url;
					return false;
				});
				this.$renameMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						app.vent.trigger('confirm:mbox-password', mboxModel, function() {
							self.$mboxWrapper.addClass('new_folder');
							self.$mboxLinks.hide();
							self.$inputWrapper.addClass('secu_folder');
							self.$inputWrapper.show();
							self.$input.val(mboxModel.get('MBOX_NAME'));
							self.$input.focus().select();
						});
					} else if (mboxModel.get('SHARING_MBOX_ID') > 0) {
						self.$mboxWrapper.addClass('new_folder');
						self.$mboxLinks.hide();
						self.$inputWrapper.addClass('share_doner');
						self.$inputWrapper.show();
						self.$input.val(mboxModel.get('MBOX_NAME'));
						self.$input.focus().select();
					} else {
						self.$mboxWrapper.addClass('new_folder');
						self.$mboxLinks.hide();
						self.$inputWrapper.show();
						self.$input.val(mboxModel.get('MBOX_NAME'));
						self.$input.focus().select();
					}
					return false;
				});
				this.$input.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					return false;
				});
				this.$input.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						self.$input.blur();
					}
				});
				this.$input.blur(function(event) {
					var mboxName = self.$input.val();
					if (mboxName.length > 16) {
						alert(i18n.mailboxNameTooLong);
						setTimeout(function() {
							self.$input.select();
						}, 250);
						return false;
					}
					if (mboxModel.isNew()) {
						if (!mboxName) {
							self.remove();
							return false;
						}
						mboxModel.save({
							MBOX_NAME : mboxName
						}, {
							wait : true,
							success : function(model, response, options) {
								mail.mboxCollection.fetch();
							},
							error : function(model, response, options) {
								switch (response.status) {
								case 409:
									alert(i18n.mailboxNameAlreadyExists + ': ' + mboxName);
									break;
								}
								self.remove();
							},
						});
					} else {
						var originalMboxName = mboxModel.get('MBOX_NAME');
						if (!mboxName || mboxName == originalMboxName) {
							self.$mboxWrapper.removeClass('new_folder');
							self.$inputWrapper.hide();
							self.$mboxLinks.not(self.$renameMbox).show();
							return false;
						}
						mboxModel.save({
							MBOX_NAME : mboxName
						}, {
							patch : true,
							wait : true,
							error : function(model, response, options) {
								switch (response.status) {
								case 409:
									alert(i18n.mailboxNameAlreadyExists + ': ' + mboxName);
									break;
								}
								self.$mboxNameLink.text(originalMboxName);
							},
						});
					}
					self.$mboxWrapper.removeClass('new_folder');
					self.$mboxNameLink.text(mboxName).show();
					self.$inputWrapper.hide();
					self.$mboxLinks.not(self.$renameMbox).show();
					return false;
				});
				this.$mboxWrapper.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (mboxModel.get('SHARED_MBOX_ID'))
						return false;
					app.vent.trigger('contextmenu:mbox', event, self.model, self);
					return false;
				});
				this.$el.data('mbox-id', mboxModel.get('MBOX_IDX'));
				this.$el.draggable({
					distance : 10,
					cursor : 'default',
					cursorAt : {
						top : -5,
						left : -5
					},
					appendTo : 'div.mc-wrap > div.mc-container',
					helper : function() {
						var $helper = $("<div />", {
							css : {
								'line-height' : '18px',
								'background-color' : '#eeeeee;',
								'padding' : '0 3px',
								'z-index' : '31'
							}
						}).append($('<span />', {
							css : {
								'display' : 'inline-block',
								'width' : '20px',
								'height' : '18px',
								'vertical-align' : 'middle',
								'background' : 'transparent url("img/side_lnb.png") no-repeat',
								'background-position' : '-235px -388px',
							},
							text : ' ',
						})).append(document.createTextNode(' ' + mboxModel.get('MBOX_NAME')));
						return $helper;
					},
				});
				this.$el.droppable({
					greedy : true,
					tolerance : 'pointer',
					accept : function(element) {
						var mboxId = element.data('mbox-id');
						if (mboxId && mboxId !== $(this).data('mbox-id')) {
							return true;
						}
						var mailIds = element.data('mail-ids');
						if (mailIds && mailIds.length) {
							return true;
						}
						return false;
					},
					drop : function(event, ui) {
						if (mboxModel.get('SHARED_MBOX_ID'))
							return;
						var mboxId = ui.draggable.data('mbox-id');
						if (mboxId) {
							var model = mail.mboxCollection.findModel('MBOX_IDX', mboxId);
							if (!model || model.get('MBOX_REF') === $(this).data('mbox-id')) {
								return;
							}
							var filtered = mail.mboxCollection.filter(function(mboxModel) {
								if (mboxModel.get('MBOX_IDX') !== model.get('MBOX_IDX')
										&& mboxModel.get('MBOX_REF') === model.get('MBOX_REF')
										&& mboxModel.get('MBOX_NAME') === model.get('MBOX_NAME')) {
									return true;
								}
								return false;
							});
							if (filtered.length) {
								alert(i18n.mailboxNameAlreadyExists + ': ' + model.get('MBOX_NAME'));
								return;
							}
							if (mboxModel.get('FOLDED')) {
								(new mail.MboxModel({
									MBOX_IDX : mboxModel.get('MBOX_IDX')
								})).save({
									FOLDED : 0
								}, {
									async : false,
									patch : true,
									success : function(model, response, options) {
										mboxModel.set('FOLDED', 0);
									},
									error : function(model, response, options) {
										// ignore error
									},
								});
							}
							var originalParentId = model.get('MBOX_REF');
							model.save({
								MBOX_REF : mboxModel.get('MBOX_IDX')
							}, {
								async : false,
								patch : true,
								wait : true,
								error : function(model, response, options) {
									model.set('MBOX_REF', originalParentId);
								},
							});
						} // end if (mboxId)
						var mailIds = ui.draggable.data('mail-ids');
						if (mailIds && mailIds.length) {
							var model = new (app.BackboneModel.extend({
								urlRoot : 'mboxes/' + mail.mboxModel.get('MBOX_IDX'),
								defaults : {
									id : 'mails'
								}
							}))();
							var jqXHR = model.save({
								MBOX_IDX : mboxModel.get('MBOX_IDX'),
								mailIds : mailIds,
							}, {
								patch : true,
								wait : true,
								success : function(model, response, options) {
									// deferred success callback to jqXHR.done()
								},
								error : function(model, response, options) {
									// deferred error callback to jqXHR.fail()
								},
							});
							jqXHR.done(function(data, textStatus, jqXHR) {
								var paginator = mail.paginator;
								if (paginator.length == mailIds.length && mailIds.length == data.updated) {
									var info = paginator.info();
									if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
										var args = {
											page : info.currentPage - 1
										};
										location.hash = '#' + paginator.getURL(args);
										mail.mboxCollection.fetch();
										return;
									}
								}
								paginator.pager();
								mail.mboxCollection.fetch();
							}).fail(function(jqXHR, textStatus, errorThrown) {
								alert('Failed to move mails.');
							});
						} // end if (mailIds && mailIds.length)
					},
					over : function(event, ui) {
						$(this).find('span.item_wrap:first > a.mc-folder_name').css('cursor', 'default');
					},
					out : function(event, ui) {
						$(this).find('span.item_wrap:first > a.mc-folder_name').css('cursor', '');
					},
				});
			},
			appendHtml : function(collectionView, itemView) {
				collectionView.$('ul:first').append(itemView.el);
			},
			newMboxNameInput : function(collection) {
				this.$mboxWrapper.addClass('new_folder');
				this.$mboxLinks.hide();
				this.$inputWrapper.show();
				var newMboxName = i18n.newMailbox;
				var model = collection.findModel('MBOX_NAME', newMboxName);
				for (var i = 0; model; i++) {
					if (i >= 100)
						break;
					var beginIndex = newMboxName.lastIndexOf(' (');
					var endIndex = newMboxName.lastIndexOf(')');
					var number = 1;
					if (beginIndex != -1 && endIndex != -1 && beginIndex < endIndex) {
						number = newMboxName.substring(beginIndex + 2, endIndex);
						number = parseInt(number);
						if (isNaN(number))
							number = 1;
						else
							number += 1;
					}
					newMboxName = i18n.newMailbox + ' (' + number + ')';
					model = collection.findModel('MBOX_NAME', newMboxName);
				}
				this.$input.val(newMboxName);
				this.$input.focus().select();
			},
		}); // mail.MboxItemView

		mail.CustomMboxesView = Backbone.Marionette.CollectionView.extend({
			tagName : 'ul',
			className : 'mc-user_folder',
			itemView : mail.MboxItemView,
			initialize : function(options) {
				// this.collection == mail.MboxCollection (MBOX_TYPE == 6)
				this.mboxCollection = options.mboxCollection;
			},
			onRender : function() {
				var self = this;
			},
			itemViewOptions : function(model, index) {
				var mboxId = model.get('MBOX_IDX');
				var mboxCollection = this.options.mboxCollection;
				var mboxes = mboxCollection.filter(function(model) {
					return model.get('MBOX_REF') === mboxId;
				});
				return {
					collection : new mail.MboxCollection(mboxes),
					mboxCollection : mboxCollection,
					itemIndex : index
				}
			},
			newMboxItemView : function() {
				var itemView = new mail.MboxItemView({
					model : new mail.MboxModel(),
				});
				this.$el.prepend(itemView.render().$el);
				itemView.newMboxNameInput(this.collection);
			},
		});

		mail.SearchMboxItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.SearchMboxItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#search-mbox-item-template').html();
					compiledTemplate = _.template(html);
					mail.SearchMboxItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					searchMbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.SearchMboxModel
				this.searchMboxCollection = this.options.searchMboxCollection;
			},
			onRender : function() {
				var self = this;
				var searchMboxModel = this.model;
				this.$searchMboxWrapper = this.$el.children('div.reverse-area');
				this.$searchMboxLinks = this.$searchMboxWrapper.find('span.item_wrap a');
				this.$searchMboxNameLink = this.$searchMboxLinks.filter('a.mc-folder_name');
				this.$renameSearchMbox = this.$searchMboxLinks.filter('a.mc-btn_modify');
				this.$inputWrapper = this.$searchMboxWrapper.find('p.mc-folder_name:first');
				this.$input = this.$inputWrapper.children('input:text');
				this.$el.on('mouseover', function(event) {
					self.$searchMboxWrapper.addClass('ovr');
					self.$renameSearchMbox.show();
					return false;
				});
				this.$el.on('mouseout', function(event) {
					self.$searchMboxWrapper.removeClass('ovr');
					self.$renameSearchMbox.hide();
					return false;
				});
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					var url = self.$searchMboxNameLink.attr('href');
					var terms = {};
					var searchTerms = url.split('&');
					for (var i = 0; i < searchTerms.length; i++) {
						var key = searchTerms[i]
								.substring(searchTerms[i].indexOf('.') + 1, searchTerms[i].indexOf('='));
						var value = searchTerms[i].substring(searchTerms[i].indexOf('=') + 1);
						terms[key] = decodeURIComponent(value);
					}
					var startDate, endDate;
					var now = new Date(), date = new Date();
					if (terms.period) {
						switch (terms.period) {
						case '1W':
							date.setDate(now.getDate() - 7);
							break;
						case '10D':
							date.setDate(now.getDate() - 10);
							break;
						case '15D':
							date.setDate(now.getDate() - 15);
							break;
						case '1M':
							date.setMonth(now.getMonth() - 1);
							break;
						case '3M':
							date.setMonth(now.getMonth() - 3);
							break;
						case '6M':
							date.setMonth(now.getMonth() - 6);
							break;
						case '1Y':
							date.setFullYear(now.getFullYear() - 1);
							break;
						}
						startDate = $.format.date(date, 'yyyy-MM-dd');
						endDate = $.format.date(now, 'yyyy-MM-dd');
					}
					if (startDate && endDate)
						url += '&search.startDate=' + startDate + '&search.endDate=' + endDate;
					location.hash = url;
					return false;
				});
				this.$renameSearchMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					self.$searchMboxWrapper.addClass('new_folder');
					self.$searchMboxLinks.hide();
					self.$inputWrapper.show();
					self.$input.val(searchMboxModel.get('name'));
					self.$input.focus().select();
					return false;
				});
				this.$input.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					return false;
				});
				this.$input.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						self.$input.blur();
					}
				});
				this.$input.blur(function(event) {
					var searchMboxName = self.$input.val();
					if (searchMboxName.length > 16) {
						alert(i18n.mailboxNameTooLong);
						setTimeout(function() {
							self.$input.select();
						}, 250);
						return false;
					}
					var originalSearchMboxName = searchMboxModel.get('name');
					if (!searchMboxName || searchMboxName == originalSearchMboxName) {
						self.$searchMboxWrapper.removeClass('new_folder');
						self.$inputWrapper.hide();
						self.$searchMboxLinks.not(self.$renameSearchMbox).show();
						return false;
					}
					searchMboxModel.save({
						name : searchMboxName,
						visible : searchMboxModel.get('visible'),
					}, {
						patch : true,
						wait : true,
					});
					self.$searchMboxWrapper.removeClass('new_folder');
					self.$searchMboxNameLink.text(searchMboxName).show();
					self.$inputWrapper.hide();
					self.$searchMboxLinks.not(self.$renameSearchMbox).show();
					return false;
				});
				this.$searchMboxWrapper.contextmenu(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('contextmenu:search-mbox', event, self.searchMboxCollection, self.model, self);
					return false;
				});
			},
		}); // mail.SearchMboxItemView

		mail.SearchMboxesView = Backbone.Marionette.CollectionView.extend({
			tagName : 'ul',
			className : 'mc-user_folder',
			itemView : mail.SearchMboxItemView,
			itemViewOptions : function(model, index) {
				return {
					searchMboxCollection : this.collection,
				}
			},
			initialize : function(options) {
				// this.collection == mail.SearchMboxCollection
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				if (this.searchMboxContextMenuView)
					this.searchMboxContextMenuView.close();
				this.searchMboxContextMenuView = new mail.SearchMboxContextMenuView();
			},
			appendHtml : function(collectionView, itemView, index) {
				var visible = itemView.model.get('visible');
				if (visible)
					collectionView.$el.append(itemView.el);
			},
			onClose : function() {
				if (this.searchMboxContextMenuView)
					this.searchMboxContextMenuView.close();
			},
		});

		mail.LabelItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.LabelItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#label-item-template').html();
					compiledTemplate = _.template(html);
					mail.LabelItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					label : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.LabelModel
				this.labelCollection = this.options.labelCollection;
			},
			onRender : function() {
				var self = this;
				this.$labelWrapper = this.$el.children('div.reverse-area');
				this.$labelLinks = this.$labelWrapper.find('span.item_wrap a');
				this.$labelNameLink = this.$labelLinks.filter('a.mc-folder_name');
				this.$modifyLabel = this.$labelLinks.filter('a.mc-btn_modify');
				this.$el.on('mouseover', function(event) {
					self.$labelWrapper.addClass('ovr');
					return false;
				});
				this.$el.on('mouseout', function(event) {
					self.$labelWrapper.removeClass('ovr');
					return false;
				});
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					var url = self.$labelNameLink.attr('href');
					location.hash = url;
					return false;
				});
				this.$modifyLabel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('show:label-add', event, self.labelCollection, self.model);
					return false;
				});
			},
		}); // mail.LabelItemView

		mail.LabelsView = Backbone.Marionette.CollectionView.extend({
			tagName : 'ul',
			className : 'mc-user_folder',
			itemView : mail.LabelItemView,
			itemViewOptions : function(model, index) {
				return {
					labelCollection : this.collection,
				}
			},
			initialize : function(options) {
				// this.collection == mail.labelCollection
				this.listenTo(this.collection, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				if (this.labelAddView)
					this.labelAddView.close();
				this.labelAddView = new mail.LabelAddView();
			},
			onClose : function() {
				if (this.labelAddView)
					this.labelAddView.close();
			},
			appendHtml : function(collectionView, itemView, index) {
				var visible = itemView.model.get('visible');
				if (visible)
					collectionView.$el.append(itemView.el);
			},
		});

		mail.MboxContextMenuView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'mbox-contextmenu',
			className : 'layer_bd layer_mouseright',
			attributes : {
				style : 'display: none; z-index: 2015;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.MboxContextMenuView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mbox-contextmenu-template').html();
					compiledTemplate = _.template(html);
					mail.MboxContextMenuView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				this.listenTo(app.vent, 'contextmenu:mbox', this.showContextMenu);
			},
			onRender : function() {
				var self = this;
				var $contextMenu = $('body > #mbox-contextmenu');
				if ($contextMenu.length)
					$contextMenu.remove();
				var $searchContextMenu = $('body > #search-mbox-contextmenu');
				if ($searchContextMenu.length)
					$searchContextMenu.remove();
				$contextMenu = this.$el.appendTo('body');
				$contextMenu.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$contextMenu.attr('hidable', true);
				$contextMenu.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($contextMenu.outerHeight() > (viewportY - event.pageY)) {
					$contextMenu.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$contextMenu.css('top', event.pageY + 'px');
				}
				if ($contextMenu.outerWidth() > (viewportX - event.pageX)) {
					$contextMenu.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$contextMenu.css('left', event.pageX + 'px');
				}
				var mboxName = this.model.get('MBOX_NAME');
				switch (this.model.get('MBOX_TYPE')) {
				case 1:
					mboxName = i18n.mbox.inbox;
					break;
				case 2:
					mboxName = i18n.mbox.sent;
					break;
				case 3:
					mboxName = i18n.mbox.trash;
					break;
				case 4:
					mboxName = i18n.mbox.drafts;
					break;
				case 5:
					mboxName = i18n.mbox.junk;
					break;
				}
				var $rename = this.$el.find('li.rename-mbox');
				$rename.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.mboxItemView.$renameMbox.click();
					self.$el.hide();
					return false;
				});
				var $markAllAsRead = this.$el.find('li.mark-all-as-read');
				$markAllAsRead.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxModel = self.model;
					var markAllAsRead = function() {
						var i18n = settingsNLS;
						if (!confirm(i18n.mboxes.leadingConfirmMarkAllAsRead + mboxName
								+ i18n.mboxes.trailingConfirmMarkAllAsRead)) {
							return false;
						}
						var model = new (app.BackboneModel.extend({
							urlRoot : 'mboxes/' + mboxModel.get('MBOX_IDX'),
							defaults : {
								id : 'mails'
							},
						}))();
						mail.overlayView.showProcessing();
						model.save({
							M_ISREAD : 'Y',
						}, {
							async : false,
							wait : true,
							patch : true,
							success : function(model, response, options) {
								alert(i18n.mboxes.successMarkAllAsRead);
							},
						});
						mail.overlayView.hideProcessing();
						if (mail.mboxModel.get('MBOX_IDX') === mboxModel.get('MBOX_IDX'))
							app.vent.trigger('paginate:mails');
						mail.mboxCollection.fetch();
					};
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						app.vent.trigger('confirm:mbox-password', mboxModel, markAllAsRead);
					} else {
						markAllAsRead();
					}
					self.$el.hide();
					return false;
				});
				var $empty = this.$el.find('li.empty-mbox');
				$empty.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxModel = self.model;
					var emptyMbox = function() {
						var msg = '', i18n = settingsNLS;
						if (app.userModel.get('USERS_DELBOX') == 'Y' && mboxModel.get('MBOX_TYPE') != 3
								&& mboxModel.get('MBOX_TYPE') != 5) {
							msg = i18n.mboxes.leadingConfirmMailboxEmpty + mboxName
									+ i18n.mboxes.trailingConfirmMailboxEmpty;
						} else {
							msg = i18n.mboxes.leadingConfirmMailboxPermanentlyEmpty + mboxName
									+ i18n.mboxes.trailingConfirmMailboxPermanentlyEmpty;
						}
						if (!confirm(msg)) {
							return false;
						}
						var model = new (app.BackboneModel.extend({
							urlRoot : 'mboxes/' + mboxModel.get('MBOX_IDX'),
							defaults : {
								id : 'emails'
							},
						}))();
						mail.overlayView.showProcessing();
						model.destroy({
							async : false,
							wait : true,
						});
						mail.mboxCollection.fetch({
							async : false,
						});
						mail.overlayView.hideProcessing();
						if (mail.mboxModel.get('MBOX_IDX') === mboxModel.get('MBOX_IDX'))
							app.vent.trigger('paginate:mails');
						app.userModel.fetch();
					};
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						app.vent.trigger('confirm:mbox-password', mboxModel, emptyMbox);
					} else {
						emptyMbox();
					}
					self.$el.hide();
					return false;
				});
				var $remove = this.$el.find('li.remove-mbox');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxModel = self.model;
					var subMboxModels = mail.mboxCollection.filter(function(model) {
						return mboxModel.get('MBOX_IDX') === model.get('MBOX_REF');
					});
					var removeMbox = function() {
						var msg = '', i18n = settingsNLS;
						if (app.userModel.get('USERS_DELBOX') == 'Y') {
							if (subMboxModels.length > 0)
								msg = i18n.mboxes.leadingConfirmMailboxesRemove + mboxName
										+ i18n.mboxes.trailingConfirmMailboxesRemove;
							else
								msg = i18n.mboxes.leadingConfirmMailboxRemove + mboxName
										+ i18n.mboxes.trailingConfirmMailboxRemove;
						} else {
							if (subMboxModels.length > 0)
								msg = i18n.mboxes.leadingConfirmMailboxesPermanentlyDelete + mboxName
										+ i18n.mboxes.trailingConfirmMailboxesPermanentlyDelete;
							else
								msg = i18n.mboxes.leadingConfirmMailboxPermanentlyDelete + mboxName
										+ i18n.mboxes.trailingConfirmMailboxPermanentlyDelete;
						}
						if (!confirm(msg)) {
							return false;
						}
						mail.overlayView.showProcessing();
						mboxModel.destroy({
							async : false,
							wait : true,
						});
						mail.overlayView.hideProcessing();
						app.userModel.fetch();
						var inboxModel = mail.mboxCollection.find(function(model) {
							return model.get('MBOX_TYPE') === 1;
						});
						var mboxId = mail.mboxModel.get('MBOX_IDX');
						if (mboxId === mboxModel.get('MBOX_IDX')) {
							location.hash = '#mboxes/' + inboxModel.get('MBOX_IDX') + '/mails';
						}
						for (var i = 0; i < subMboxModels.length; i++) {
							if (mboxId === subMboxModels[i].get('MBOX_IDX')) {
								location.hash = '#mboxes/' + inboxModel.get('MBOX_IDX') + '/mails';
								break;
							}
						}
					};
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						app.vent.trigger('confirm:mbox-password', mboxModel, removeMbox);
					} else {
						removeMbox();
					}
					self.$el.hide();
					return false;
				});
				var $download = this.$el.find('li.download-mbox');
				$download.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxModel = self.model;
					var mboxId = mboxModel.get('MBOX_IDX');
					if (mboxModel.get('MBOX_PUBLIC') == 'S') {
						app.vent.trigger('confirm:mbox-password', mboxModel, function() {
							location.href = "mboxes/" + mboxId + "/files";
						});
					} else {
						location.href = "mboxes/" + mboxId + "/files";
					}
					self.$el.hide();
					return false;
				});
			}, // onRender : function() {...}
			showContextMenu : function(mouseEvent, mboxModel, mboxItemView) {
				this.mouseEvent = mouseEvent;
				this.model = mboxModel;
				this.mboxItemView = mboxItemView;
				this.render().$el.show();
			}
		});

		mail.SearchMboxContextMenuView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'search-mbox-contextmenu',
			className : 'layer_bd layer_mouseright',
			attributes : {
				style : 'display: none; z-index: 2015;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.SearchMboxContextMenuView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#search-mbox-contextmenu-template').html();
					compiledTemplate = _.template(html);
					mail.SearchMboxContextMenuView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					searchMbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.SearchMboxModel
				this.listenTo(app.vent, 'contextmenu:search-mbox', this.showContextMenu);
			},
			onRender : function() {
				var self = this;
				var $contextMenu = $('body > #search-mbox-contextmenu');
				if ($contextMenu.length)
					$contextMenu.remove();
				var $mboxContextMenu = $('body > #mbox-contextmenu');
				if ($mboxContextMenu.length)
					$mboxContextMenu.remove();
				$contextMenu = this.$el.appendTo('body');
				$contextMenu.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$contextMenu.attr('hidable', true);
				$contextMenu.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($contextMenu.outerHeight() > (viewportY - event.pageY)) {
					$contextMenu.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$contextMenu.css('top', event.pageY + 'px');
				}
				if ($contextMenu.outerWidth() > (viewportX - event.pageX)) {
					$contextMenu.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$contextMenu.css('left', event.pageX + 'px');
				}
				var $rename = this.$el.find('li.rename-search-mbox');
				$rename.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.searchMboxItemView.$renameSearchMbox.click();
					self.$el.hide();
					return false;
				});
				var $modify = this.$el.find('li.modify-search-mbox');
				$modify.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.searchMboxRegisterView) {
						self.searchMboxRegisterView.close();
					}
					var zIndex = mail.overlayView.$overlay.css('z-index');
					self.searchMboxRegisterView = new mail.SearchMboxRegisterView({
						model : self.model,
						collection : self.collection,
						mboxCollection : mail.mboxCollection,
					});
					var $searchMboxRegisterView = self.searchMboxRegisterView.render().$el;
					$searchMboxRegisterView.css('z-index', parseInt(zIndex) + 1);
					$searchMboxRegisterView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.searchMboxRegister');
					$viewport.on('resize.searchMboxRegister', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $searchMboxRegisterView.width() / 2;
						var height = $searchMboxRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$searchMboxRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.searchMboxRegister');
					self.$el.hide();
					return false;
				});
				var $invisible = this.$el.find('li.invisible-search-mbox');
				$invisible.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.model.save({
						visible : 0,
					}, {
						patch : true,
						async : false,
						wait : true,
					});
					self.$el.hide();
					return false;
				});
				var $remove = this.$el.find('li.remove-search-mbox');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = self.model.get('name') + i18n.searchMbox.deleteConfirm;
					if (!confirm(msg)) {
						return false;
					}
					self.model.destroy({
						async : false,
						wait : true,
						success : function(model, response, options) {
							var inboxModel = mail.mboxCollection.find(function(model) {
								return model.get('MBOX_TYPE') === 1;
							});
							var hash = location.hash;
							hash = hash.substring(hash.indexOf('#') + 1);
							var pathname = hash.substring(0, hash.indexOf('/'));
							if (pathname != 'settings')
								location.hash = '#mboxes/' + inboxModel.get('MBOX_IDX') + '/mails';
							else
								self.collection.fetch();
						},
						error : function(model, response, options) {
							alert(i18n.searchMbox.failedToDelete);
						},
					});
					self.$el.hide();
					return false;
				});
			}, // onRender : function() {...}
			showContextMenu : function(mouseEvent, searchMboxCollection, searchMboxModel, searchMboxItemView) {
				this.mouseEvent = mouseEvent;
				this.collection = searchMboxCollection;
				this.model = searchMboxModel;
				this.searchMboxItemView = searchMboxItemView;
				this.render().$el.show();
			}
		});

		mail.MboxPasswordView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'mbox-password',
			className : 'edit_layer mbox-passwd-layer',
			attributes : {
				style : 'top:50%;left:50%;margin-top:-200px;margin-left:-313px;width:408px;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.MboxPasswordView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mbox-password-template').html();
					compiledTemplate = _.template(html);
					mail.MboxPasswordView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.mboxCollection
				this.listenTo(app.vent, 'confirm:mbox-password', this.showConfirmPassword);
			},
			onRender : function() {
				var self = this;
				var $layer = $('body > #mbox-password');
				if ($layer.length)
					$layer.remove();
				mail.overlayView.showOverlay();
				this.$el.css('z-index', 2016).appendTo('body');
				var $close = this.$el.find('.close-mbox-passwd:first');
				var $cancel = this.$el.find('.cancel-mbox-passwd:first');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.hide();
					mail.overlayView.hideOverlay();
					return false;
				});
				var $confirm = this.$el.find('.confirm-mbox-passwd:first');
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var password = self.$el.find('#mbox-passwd').val();
					if (!password) {
						alert(i18n.pleaseInputPassword);
						return false;
					}
					var mboxModel = new mail.MboxModel();
					mboxModel.set('MBOX_IDX', self.model.get('MBOX_IDX'));
					mboxModel.fetch({
						type : 'POST',
						data : {
							_method : 'GET',
							key : password
						},
						success : function(model, response, options) {
							self.$el.hide();
							mail.overlayView.hideOverlay();
							self.confirmAction();
						},
						error : function(model, response, options) {
							alert(i18n.invalidMailboxPassword);
						},
					});
					return false;
				});
			},
			showConfirmPassword : function(mboxModel, confirmAction) {
				this.model = mboxModel;
				this.confirmAction = confirmAction;
				this.render().$el.show();
			},
		}); // mail.MboxPasswordView

		mail.ContentLayout = Backbone.Marionette.Layout.extend({
			tagName : 'div',
			className : 'mc-content',
			template : function(data) {
				var html = mail.$template.filter('#content-layout-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			regions : {
				contentHeaderRegion : '#listHeadDiv',
				composeHeaderRegion : '#writeHeadDiv',
				deliveryStatusHeaderRegion : '#deliveryStatusHeadDiv',
				simpleSearchRegion : '#searchInputDiv',
				advancedSearchRegion : '#detail_search',
				listToolbarRegion : '#listBtnMenu',
				viewToolbarRegion : '#readBtnMenu',
				composeToolbarRegion : '#writeBtnMenu',
				sentToolbarRegion : '#sentBtnMenu',
				deliveryStatusToolbarRegion : '#deliveryBtnMenu',
				listRegion : '#divList',
				deliveryStatusListRegion : '#deliveryList',
				viewRegion : '#mc-preview',
				deliveryStatusViewRegion : '#mc-preview-delivery-status',
				composeRegion : '#writeWrap',
				signatureRegion : 'div#signature-layer',
				stationeryRegion : 'div#stationery-layer',
				formRegion : 'div#document-form-layer',
				delayDeliveryRegion : 'div#delay-delivery-layer',
				composeOptionsRegion : 'div#compose-options-layer',
				blobOptionsRegion : 'div#blob-options-layer',
				sentRegion : '#sentWrap',
				selectMailsRegion : '#ly_select_item',
				moveMailsRegion : '#moveMailLayer',
				selectLabelsRegion : '#selectLabelsLayer',
				filterMailsRegion : '#ly_move_mail_continue',
				moreActionsRegion : '#ly_select_mailaction',
				mailSourceRegion : '#viewmime',
				addContactsRegion : '#ly_address',
				deliveryStatusInfoRegion : '#sc_layer',
				reportSpamRegion : 'div.mail-toolbar-report-spam',
				approvalHeaderRegion : '#approvalHeadDiv',
				approvalSimpleSearchRegion : '#approvalSearchInputDiv',
				approvalAdvancedSearchRegion : '#approval_detail_search',
				approvalTabRegion : '#approvalTabDiv',
				approvalListToolbarRegion : '#approvalListBtnMenu',
				approvalViewToolbarRegion : '#ok_send_readBtnMenu',
				approvalListRegion : '#ok_send_listDiv',
				approvalViewRegion : '#mc-preview-approval',
				printOptionsRegion : 'div#print-options-layer',
			},
			initialize : function(options) {
				// this.model == mail.mboxModel
				// this.collection == mail.mboxCollection
				this.paginator = options.paginator; // mail.paginator
				this.mailModel = options.mailModel; // mail.mailModel
				this.userModel = options.userModel; // app.userModel
				this.deliveryStatusPaginator = options.deliveryStatusPaginator;
				this.approvalModel = options.approvalModel; // mail.approvalModel
				this.approvalPaginator = options.approvalPaginator;
				this.listenTo(app.vent, 'change:mbox', this.replaceMboxModel);
				this.listenTo(app.vent, 'compose:mail', this.showComposeView);
				this.listenTo(app.vent, 'show:sent-mail', this.showSentMailView);
				this.listenTo(app.vent, 'view:original', this.showMailSourceView);
				this.listenTo(app.vent, 'view:more-actions', this.showMoreActions);
				this.listenTo(app.vent, 'more:add-contacts', this.showAddContactsView);
				this.listenTo(app.vent, 'show:report-spam', this.showReportSpamView);
				this.listenTo(this, 'show:filter-mails-view', this.showFilterMailsView);
			},
			replaceMboxModel : function(mboxModel) {
				this.model = mboxModel;
			},
			onRender : function() {
				var self = this;
				this.contentHeaderRegion.show(new mail.ContentHeaderView({
					model : new Backbone.Model({
						mboxModel : this.model, // mail.mboxModel
						paginator : this.paginator, // mail.paginator
					}),
				}));
				this.composeHeaderRegion.show(new mail.ComposeHeaderView({
					model : this.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_TYPE') === 4;
					}),
				}));
				this.deliveryStatusHeaderRegion.show(new mail.DeliveryStatusHeaderView({
					model : this.model, // mail.mboxModel
				}));
				this.simpleSearchRegion.show(new mail.SimpleSearchView({
					model : this.model, // mail.mboxModel
					collection : this.paginator, // mail.paginator
				}));
				this.advancedSearchRegion.show(new mail.AdvancedSearchView({
					mboxModel : this.model, // mail.mboxModel
					collection : this.collection, // mail.mboxCollection
					paginator : this.paginator,
				}));
				this.listRegion.show(new mail.MailListView({
					model : this.model, // mail.mboxModel,
					collection : this.paginator, // mail.paginator
					mboxCollection : this.collection, // mail.mboxCollection
					parentView : this,
				}));
				this.viewRegion.show(new mail.MailView({
					model : this.mailModel,
					region : this.viewRegion,
				}));
				this.deliveryStatusListRegion.show(new mail.DeliveryStatusListView({
					collection : this.deliveryStatusPaginator,
				}));
				this.deliveryStatusViewRegion.show(new mail.MailView({
					model : this.mailModel,
					region : this.deliveryStatusViewRegion,
				}));
				this.composeRegion.show(new mail.ComposeMailView({
					userModel : this.userModel,
					composeRegion : this.composeRegion,
					signatureRegion : this.signatureRegion,
					stationeryRegion : this.stationeryRegion,
					formRegion : this.formRegion,
					delayDeliveryRegion : this.delayDeliveryRegion,
					blobOptionsRegion : this.blobOptionsRegion,
					parentView : this,
				}));
				this.sentRegion.show(new mail.SentMailView({
					userModel : this.userModel
				}));
				this.listToolbarRegion.show(new mail.ListToolbarView({
					model : this.userModel, // app.userModel
					collection : this.paginator, // mail.paginator
					mboxCollection : this.collection, // mail.mboxCollection
					mailModel : this.mailModel, // mail.mailModel
					parentView : this, // mail.ContentLayout
				}));
				this.viewToolbarRegion.show(new mail.MailToolbarView({
					model : this.mailModel,
					collection : this.collection, // mail.mboxCollection
					mboxModel : this.model, // mail.mboxModel
					paginator : this.paginator,
					parentView : this,
				}));
				this.composeToolbarRegion.show(new mail.ComposeToolbarView({
					userModel : this.userModel,
					parentView : this,
					composeOptionsRegion : this.composeOptionsRegion,
				// options
				}));
				this.sentToolbarRegion.show(new mail.SentToolbarView({
					model : this.collection.find(function(mboxModel) {
						return mboxModel.get('MBOX_TYPE') === 1;
					}),
				}));
				this.deliveryStatusToolbarRegion.show(new mail.DeliveryStatusToolbarView({
					model : this.userModel,
					collection : this.deliveryStatusPaginator,
					deliveryStatusListRegion : this.deliveryStatusListRegion,
				}));
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.approvalHeaderRegion.show(new mail.ApprovalHeaderView({
						model : new Backbone.Model({
							approvalMboxModel : mail.approvalMboxModel, // mail.approvalMboxModel
							paginator : this.approvalPaginator, // mail.approvalPaginator
						}),
					}));
					this.approvalSimpleSearchRegion.show(new mail.ApprovalSimpleSearchView({
						collection : this.approvalPaginator, // mail.approvalPaginator
					}));
					this.approvalAdvancedSearchRegion.show(new mail.ApprovalAdvancedSearchView({
						paginator : this.approvalPaginator
					}));
					this.approvalTabRegion.show(new mail.ApprovalTabView({
						model : new Backbone.Model({
							approvalMboxModel : mail.approvalMboxModel, // mail.approvalMboxModel
							paginator : this.approvalPaginator, // mail.approvalPaginator
						}),
					}));
					this.approvalListRegion.show(new mail.ApprovalListView({
						collection : this.approvalPaginator, // mail.approvalPaginator
					}));
					this.approvalViewRegion.show(new mail.ApprovalView({
						model : this.approvalModel,
						parentView : this
					}));
					this.approvalListToolbarRegion.show(new mail.ApprovalListToolbarView({
						model : this.userModel, // app.userModel
						collection : this.approvalPaginator, // mail.approvalPaginator
						approvalModel : this.approvalModel, // mail.approvalModel
						parentView : this, // mail.ContentLayout
					}));
					this.approvalViewToolbarRegion.show(new mail.ApprovalToolbarView({
						model : this.approvalModel,
						userModel : this.userModel,
						paginator : this.approvalPaginator,
					}));
				}
				// Nested Views of Toolbar
				this.selectMailsRegion.show(new mail.SelectCategorizedMailsView());
				this.moveMailsRegion.show(new mail.MoveToMboxView({
					model : this.model, // mail.mboxModel
					collection : mail.mboxCollection,
					mailModel : this.mailModel,
					paginator : this.paginator,
					parentView : this,
				}));
				this.moveMailsRegion.$el.attr('hidable', false);
				this.moveMailsRegion.$el.click(function(event) {
					event.stopPropagation();
				});
				this.selectLabelsRegion.show(new mail.SelectLabelsView({
					collection : mail.labelCollection,
					mailModel : this.mailModel,
					mailCollection : this.paginator,
					parentView : this,
				}));
				this.selectLabelsRegion.$el.attr('hidable', false);
				this.selectLabelsRegion.$el.click(function(event) {
					event.stopPropagation();
				});
				this.printOptionsRegion.show(new mail.PrintOptionsView({
					model : this.mailModel,
				}));
				this.printOptionsRegion.$el.attr('hidable', false);
				this.printOptionsRegion.$el.click(function(event) {
					event.stopPropagation();
				});
				$(window).on('resize.contentLayout', _.bind(this.onResize, this));
				this.$el.on('dragenter', function(event, editorEvent) {
					if (!self.composeRegion.$el.is(':visible'))
						return false;
					var dataTransfer = editorEvent ? editorEvent.dataTransfer : event.originalEvent.dataTransfer;
					var types = dataTransfer.types;
					if (types) {
						if ((types.contains && types.contains("Files"))
								|| (types.indexOf && types.indexOf("Files") !== -1)) {
							if (!self.droppableView) {
								self.droppableView = new mail.DroppableView({
									composeRegion : self.composeRegion
								});
								self.droppableView.render().$el.appendTo(app.contentRegion.$el);
							}
							self.droppableView.$el.show();
						}
					}
					return true;
				});
			},
			onShow : function() {
				// ContentLayout.onShow()
			},
			onClose : function() {
				$(window).off('resize.contentLayout');
			},
			onResize : function(event) {
				if (this.deliveryStatusListRegion.$el.is(':visible'))
					return;
				if (this.sentRegion.$el.is(':visible'))
					return;
				if (this.composeRegion.$el.is(':visible')) {
					var $pane = this.composeRegion.$el;
					var parentWidth = $pane.offsetParent().width();
					var parentHeight = $pane.offsetParent().height();
					var width = parentWidth - ($pane.outerWidth(true) - $pane.width());
					var height = parentHeight - ($pane.outerHeight(true) - $pane.height());
					$pane.width(width).height(height);
					$pane.css('overflow', 'auto');
					return;
				}
				var split = this.userModel.get('USERS_MAIL_VIEW_MODE');
				split = this.viewToolbarRegion.$el.is(':visible') ? 0 : split;
				split = this.model.get('MBOX_TYPE') == 4 ? 0 : split;
				var hash = location.hash;
				var type = hash.indexOf('#approval') == -1 ? '' : 'approval';
				switch (split) {
				case '1': // Horizontal Split
					this.showHorizontalSplit(type);
					break;
				case '2': // Vertical Split
					this.showVerticalSplit(type);
					break;
				case '0': // No Split
				default:
					var $viewRegion = this.viewRegion.$el;
					var $approvalViewRegion = this.approvalViewRegion.$el;
					var $deliveryStatusViewRegion = this.deliveryStatusViewRegion.$el;
					if (this.approvalListRegion.$el && this.approvalListRegion.$el.is(':visible')) {
						var $pane = this.approvalListRegion.$el;
						var parentWidth = $pane.offsetParent().width();
						var parentHeight = $pane.offsetParent().height();
						var width = parentWidth - ($pane.outerWidth(true) - $pane.width());
						var height = parentHeight - ($pane.outerHeight(true) - $pane.height());
						$pane.width(width).height(height - 47);
					} else if ($viewRegion.is(':visible') || $deliveryStatusViewRegion.is(':visible')
							|| ($approvalViewRegion && $approvalViewRegion.is(':visible'))) {
						var $view = $viewRegion;
						if ($approvalViewRegion && $approvalViewRegion.is(':visible')) {
							$view = $approvalViewRegion;
						} else if ($deliveryStatusViewRegion.is(':visible')) {
							$view = $deliveryStatusViewRegion;
						}
						var parentWidth = $view.offsetParent().width();
						var parentHeight = $view.offsetParent().height();
						var width = parentWidth - ($view.outerWidth(true) - $view.width());
						var height = parentHeight - ($view.outerHeight(true) - $view.height());
						$view.width(width).height(height);
						var $list = this.listRegion.$el;
						$list.width(width).height(height);
					} else {
						this.showNoSplit(type);
					}
				}
			},
			showMailList : function() {
				var isToResize = this.composeRegion.$el.is(':visible');
				if (this.sentRegion.$el.is(':visible'))
					isToResize = true;
				// header regions
				this.composeHeaderRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.contentHeaderRegion.$el.show();
				this.simpleSearchRegion.$el.show();
				// toolbar regions
				this.composeToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.viewToolbarRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				this.listToolbarRegion.$el.show();
				// content regions
				this.composeRegion.$el.hide();
				this.sentRegion.$el.hide();
				this.deliveryStatusListRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.hideApprovalViews();
				}
				var split = this.userModel.get('USERS_MAIL_VIEW_MODE');
				if (this.model.get('MBOX_TYPE') == 4) {
					split = '0';
				}
				switch (split) {
				case '1': // Horizontal Split
					this.showHorizontalSplit();
					break;
				case '2': // Vertical Split
					this.showVerticalSplit();
					break;
				case '0': // No Split
				default:
					this.showNoSplit();
				}
				if (isToResize) {
					setTimeout(function() {
						$(window).trigger('resize.contentLayout');
					}, 100);
				}
			},
			showMailView : function() {
				this.composeHeaderRegion.$el.hide();
				this.composeToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				this.composeRegion.$el.hide();
				this.sentRegion.$el.hide();
				this.deliveryStatusListRegion.$el.hide();
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.hideApprovalViews();
				}
				var split = this.userModel.get('USERS_MAIL_VIEW_MODE');
				switch (split) {
				case '1': // Horizontal Split
					break;
				case '2': // Vertical Split
					break;
				case '0': // No Split
				default:
					this.contentHeaderRegion.$el.show();
					this.simpleSearchRegion.$el.show();
					this.listToolbarRegion.$el.hide();
					this.viewToolbarRegion.$el.show();
					this.listRegion.$el.hide();
					this.viewRegion.$el.show();
					break;
				}
			},
			showComposeView : function(params) {
				if (params && params.dispatch)
					return;
				// header regions
				this.contentHeaderRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.composeHeaderRegion.$el.show();
				this.simpleSearchRegion.$el.show();
				// toolbar regions
				this.listToolbarRegion.$el.hide();
				this.viewToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				this.composeToolbarRegion.$el.show();
				// content regions
				this.listRegion.$el.hide();
				this.viewRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				this.sentRegion.$el.hide();
				this.deliveryStatusListRegion.$el.hide();
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.hideApprovalViews();
				}
				var $composeRegion = this.composeRegion.$el;
				$composeRegion.show();
				var $offsetParent = $composeRegion.offsetParent();
				var parentWidth = $offsetParent.width();
				var parentHeight = $offsetParent.height();
				var width = parentWidth - ($composeRegion.outerWidth(true) - $composeRegion.width());
				var height = parentHeight - ($composeRegion.outerHeight(true) - $composeRegion.height());
				$composeRegion.width(width).height(height);
				$composeRegion.css('overflow', 'auto');
				this.composeRegion.show(new mail.ComposeMailView({
					userModel : this.userModel,
					params : params,
					composeRegion : this.composeRegion,
					signatureRegion : this.signatureRegion,
					stationeryRegion : this.stationeryRegion,
					formRegion : this.formRegion,
					delayDeliveryRegion : this.delayDeliveryRegion,
					blobOptionsRegion : this.blobOptionsRegion,
					parentView : this,
				}));
				app.vent.trigger('show:compose-header-name');
				app.vent.trigger('activate:mbox-item');
			},
			showSentMailView : function(mailModel) {
				// header regions
				this.contentHeaderRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.composeHeaderRegion.$el.show();
				this.simpleSearchRegion.$el.show();
				// toolbar regions
				this.listToolbarRegion.$el.hide();
				this.viewToolbarRegion.$el.hide();
				this.composeToolbarRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.show();
				// content regions
				this.listRegion.$el.hide();
				this.viewRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				this.composeRegion.$el.hide();
				if (document.msFileUploadIframe) {
					this.composeRegion.show(new mail.ComposeMailView({
						userModel : this.userModel,
						params : {},
						composeRegion : this.composeRegion,
						signatureRegion : this.signatureRegion,
						stationeryRegion : this.stationeryRegion,
						formRegion : this.formRegion,
						delayDeliveryRegion : this.delayDeliveryRegion,
						blobOptionsRegion : this.blobOptionsRegion,
						parentView : this,
					}));
				}
				this.deliveryStatusListRegion.$el.hide();
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.hideApprovalViews();
				}
				this.sentRegion.$el.show();
				var $sentRegion = this.sentRegion.$el;
				var $offsetParent = $sentRegion.offsetParent();
				var parentWidth = $offsetParent.width();
				var parentHeight = $offsetParent.height();
				var width = parentWidth - ($sentRegion.outerWidth(true) - $sentRegion.width());
				var height = parentHeight - ($sentRegion.outerHeight(true) - $sentRegion.height());
				$sentRegion.width(width).height(height);
				$sentRegion.css({
					'overflow' : 'auto',
					'top' : 0,
				});
				var unregisteredContacts = this.getUnregisteredContacts(mailModel);
				this.sentRegion.show(new mail.SentMailView({
					model : new Backbone.Model({
						contacts : unregisteredContacts.toJSON(),
						mailModel : mailModel,
					}),
					collection : unregisteredContacts,
					mailModel : mailModel,
				}));
			},
			getUnregisteredContacts : function(mailModel) {
				var contactCollection = new app.contact.AddressCollection();
				var toAddrs = this.getAddress(mailModel.get('M_TO'));
				var ccAddrs = this.getAddress(mailModel.get('M_CC'));
				var bccAddrs = this.getAddress(mailModel.get('M_BCC'));
				var addrs = _.union(toAddrs, ccAddrs, bccAddrs);
				contactCollection.fetch({
					async : false,
				});
				var unregisteredContacts = new Backbone.Collection();
				for (var i = 0, len = addrs.length; i < len; i++) {
					var addr = addrs[i];
					var prefix = addr.address.charAt(0);
					if (prefix == '#' || prefix == '$' || prefix == '!') {
						continue;
					}
					var contact = contactCollection.getAddressModel('ADDRESS_EMAIL', addr.address);
					if (!contact) {
						contact = new Backbone.Model({});
						contact.set('ADDRESS_NAME', addr.personal);
						contact.set('ADDRESS_EMAIL', addr.address);
						unregisteredContacts.add(contact);
					}
				}
				return unregisteredContacts;
			},
			getAddress : function(to) {
				var addrs = [];
				try {
					var toAddr = InternetAddress.parseHeader(to, false);
					for (var i = 0; i < toAddr.length; i++) {
						var addr = {};
						addr.personal = toAddr[i].getPersonal();
						addr.address = toAddr[i].getAddress();
						addrs.push(addr);
					}
				} catch (error) {
				}
				return addrs;
			},
			showDeliveryStatusList : function() {
				// header regions
				this.composeHeaderRegion.$el.hide();
				this.contentHeaderRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.show();
				this.simpleSearchRegion.$el.show();
				// toolbar regions
				this.composeToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.viewToolbarRegion.$el.hide();
				this.listToolbarRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.show();
				// content regions
				this.listRegion.$el.hide();
				this.viewRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				this.composeRegion.$el.hide();
				this.sentRegion.$el.hide();
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.hideApprovalViews();
				}
				this.deliveryStatusInfoRegion.show(new mail.DeliveryStatusInfoView({}));
				var $splitPane = this.$el.find('#cont_flex_area');
				$splitPane.removeClass().addClass('mc-list_normal');
				this.deliveryStatusListRegion.$el.show();
				app.vent.trigger('activate:mbox-item');
			},
			showDeliveryStatusView : function() {
				// header regions
				this.composeHeaderRegion.$el.hide();
				this.contentHeaderRegion.$el.show();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.simpleSearchRegion.$el.show();
				// toolbar regions
				this.listToolbarRegion.$el.hide();
				this.viewToolbarRegion.$el.show();
				this.composeToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				// content regions
				this.composeRegion.$el.hide();
				this.sentRegion.$el.hide();
				this.deliveryStatusListRegion.$el.hide();
				this.listRegion.$el.hide();
				this.viewRegion.$el.hide();
				if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
					this.hideApprovalViews();
				}
				var $listPane = this.deliveryStatusListRegion.$el;
				var $viewPane = this.deliveryStatusViewRegion.$el;
				var $splitPane = this.$el.find('#cont_flex_area');
				$splitPane.css('overflow', 'hidden');
				var parentWidth = $splitPane.width();
				var parentHeight = $splitPane.height();
				var width = parentWidth - ($viewPane.outerWidth(true) - $viewPane.width());
				var height = parentHeight - ($viewPane.outerHeight(true) - $viewPane.height());
				$viewPane.width(width).height(height);
				$viewPane.css({
					'top' : '0px',
					'left' : '0px',
					'overflow' : 'auto'
				});
				$viewPane.show();
			},
			showApprovalList : function() {
				// header regions
				this.composeHeaderRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.contentHeaderRegion.$el.hide();
				this.approvalHeaderRegion.$el.show();
				this.approvalTabRegion.$el.show();
				if (this.advancedSearchRegion.$el.is(':visible')) {
					var $toggle = this.simpleSearchRegion.$el.find('a.mc-search_detail');
					$toggle.click();
				}
				this.simpleSearchRegion.$el.hide();
				this.approvalSimpleSearchRegion.$el.show();
				// toolbar regions
				this.composeToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.viewToolbarRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				this.listToolbarRegion.$el.hide();
				this.approvalViewToolbarRegion.$el.hide();
				this.approvalListToolbarRegion.$el.show();
				// approval tab regions

				// content regions
				this.composeRegion.$el.hide();
				this.sentRegion.$el.hide();
				this.deliveryStatusListRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				this.listRegion.$el.hide();
				this.viewRegion.$el.hide();
				this.approvalListRegion.$el.hide();
				this.approvalViewRegion.$el.hide();
				var split = this.userModel.get('USERS_MAIL_VIEW_MODE');
				if (this.model.get('MBOX_TYPE') == 4) {
					split = 0;
				}
				switch (split) {
				case '1': // Horizontal Split
					this.showHorizontalSplit('approval');
					break;
				case '2': // Vertical Split
					this.showVerticalSplit('approval');
					break;
				case '0': // No Split
				default:
					this.showNoSplit('approval');
				}
				setTimeout(function() {
					$(window).trigger('resize.contentLayout');
				}, 100);
			},
			showApprovalView : function() {
				this.contentHeaderRegion.$el.hide();
				this.composeHeaderRegion.$el.hide();
				this.composeToolbarRegion.$el.hide();
				this.listToolbarRegion.$el.hide();
				this.sentToolbarRegion.$el.hide();
				this.deliveryStatusHeaderRegion.$el.hide();
				this.deliveryStatusToolbarRegion.$el.hide();
				this.deliveryStatusViewRegion.$el.hide();
				this.composeRegion.$el.hide();
				this.sentRegion.$el.hide();
				this.listRegion.$el.hide();
				this.viewRegion.$el.hide();
				this.deliveryStatusListRegion.$el.hide();
				var split = this.userModel.get('USERS_MAIL_VIEW_MODE');
				switch (split) {
				case '1': // Horizontal Split
					break;
				case '2': // Vertical Split
					break;
				case '0': // No Split
				default:
					this.approvalHeaderRegion.$el.show();
					this.approvalTabRegion.$el.hide();
					this.simpleSearchRegion.$el.hide();
					this.approvalSimpleSearchRegion.$el.show();
					this.approvalListToolbarRegion.$el.hide();
					this.approvalViewToolbarRegion.$el.show();
					this.approvalListRegion.$el.hide();
					this.approvalViewRegion.$el.show();
					break;
				}
			},
			hideApprovalViews : function() {
				this.approvalHeaderRegion.$el.hide();
				if (this.approvalAdvancedSearchRegion.$el.is(':visible')) {
					var $toggle = this.approvalSimpleSearchRegion.$el.find('a.mc-search_detail');
					$toggle.click();
				}
				this.approvalSimpleSearchRegion.$el.hide();
				this.approvalTabRegion.$el.hide();
				this.approvalListRegion.$el.hide();
				this.approvalViewRegion.$el.hide();
				this.approvalListToolbarRegion.$el.hide();
				this.approvalViewToolbarRegion.$el.hide();
			},
			showNoSplit : function(type) {
				if (type == 'approval') {
					app.vent.trigger('toggle:approval-list-toolbar-print-button', 'hide');
					app.vent.trigger('activate:approval-list-toolbar-split-button', 'no');
				} else {
					app.vent.trigger('toggle:list-toolbar-print-button', 'hide');
					app.vent.trigger('activate:list-toolbar-split-button', 'no');
				}
				var $splitPane = this.$el.find('#cont_flex_area');
				$splitPane.removeClass().addClass('mc-list_normal');
				var $listPane = (type == 'approval') ? this.approvalListRegion.$el : this.listRegion.$el;
				$listPane.show();
				var $offsetParent = $listPane.offsetParent();
				if (!$offsetParent.is('html')) {
					$offsetParent.css('overflow', 'hidden');
				}
				var parentWidth = $offsetParent.width();
				var parentHeight = $offsetParent.height();
				var width = parentWidth - ($listPane.outerWidth(true) - $listPane.width());
				var height = parentHeight - ($listPane.outerHeight(true) - $listPane.height());
				$listPane.width(width).height(height);
				var $viewPane = (type == 'approval') ? this.approvalViewRegion.$el : this.viewRegion.$el;
				width = parentWidth - ($viewPane.outerWidth(true) - $viewPane.width());
				height = parentHeight - ($viewPane.outerHeight(true) - $viewPane.height());
				$viewPane.width(width).height(height);
				$viewPane.css({
					'top' : '0px',
					'left' : '0px',
					'overflow' : 'auto'
				});
				$viewPane.hide();
			},
			showVerticalSplit : function(type) {
				if (type == 'approval') {
					app.vent.trigger('toggle:approval-list-toolbar-print-button', 'show');
					app.vent.trigger('activate:approval-list-toolbar-split-button', 'vertical');
				} else {
					app.vent.trigger('toggle:list-toolbar-print-button', 'show');
					app.vent.trigger('activate:list-toolbar-split-button', 'vertical');
				}
				var $splitPane = this.$el.find('#cont_flex_area');
				// $splitPane[0].className = 'mc-list_vertical';
				$splitPane.removeClass().addClass('mc-list_horizontal');
				var $listPane = (type == 'approval') ? this.approvalListRegion.$el : this.listRegion.$el;
				var $viewPane = (type == 'approval') ? this.approvalViewRegion.$el : this.viewRegion.$el;
				var $offsetParent = $listPane.offsetParent();
				if (!$offsetParent.is('html')) {
					$offsetParent.css({
						'overflow' : 'hidden'
					});
				}
				var parentWidth = $offsetParent.width();
				var parentHeight = $offsetParent.height();
				var width = 0;
				if (this.listPaneWidth) {
					width = this.listPaneWidth;
				} else {
					width = Math.ceil(parentWidth / 2) - ($listPane.outerWidth(true) - $listPane.width());
				}
				var height = parentHeight - ($listPane.outerHeight(true) - $listPane.height());
				var approvalTabSize = 0;
				if (type == 'approval') {
					height -= 47;
					approvalTabSize = 47;
				}
				$listPane.width(width).height(height);
				$listPane.show();
				width = (parentWidth - $listPane.outerWidth(true)) - ($viewPane.outerWidth(true) - $viewPane.width());
				height = parentHeight - ($viewPane.outerHeight(true) - $viewPane.height());
				$viewPane.width(width).height(height);
				$viewPane.css({
					'top' : approvalTabSize + 'px',
					'left' : $listPane.outerWidth(true) + 'px',
					'overflow' : 'auto'
				});
				$viewPane.show();
				var self = this;
				$viewPane.resizable().resizable('destroy');
				$viewPane.resizable({
					containment : '#cont_flex_area',
					handles : 'w',
					resize : function(event, ui) {
						var remainingWidth = $offsetParent.width() - $(this).outerWidth(true);
						self.listPaneWidth = remainingWidth - ($listPane.outerWidth(true) - $listPane.width());
						$listPane.css('width', self.listPaneWidth + 'px');
					}
				});
				$viewPane.find('.ui-resizable-w').css({
					'left' : '0px'
				}).addClass('mc-divContent');
				$viewPane.off('resize').on('resize', function(event) {
					event.stopPropagation();
				});
				this.viewRegion.currentView.off('render');
				this.viewRegion.currentView.on('render', function() {
					var $handle = $viewPane.children('.ui-resizable-w');
					var $el = this.$el;
					setTimeout(function() {
						$handle.width(7).height($el.height());
					}, 250);
				}, this.viewRegion);
				this.viewRegion.currentView.trigger('render');
			},
			showHorizontalSplit : function(type) {
				if (type == 'approval') {
					app.vent.trigger('toggle:approval-list-toolbar-print-button', 'show');
					app.vent.trigger('activate:approval-list-toolbar-split-button', 'horizontal');
				} else {
					app.vent.trigger('toggle:list-toolbar-print-button', 'show');
					app.vent.trigger('activate:list-toolbar-split-button', 'horizontal');
				}
				var $splitPane = this.$el.find('#cont_flex_area');
				// $splitPane[0].className = 'mc-list_horizontal';
				$splitPane.removeClass().addClass('mc-list_vertical');
				var $listPane = (type == 'approval') ? this.approvalListRegion.$el : this.listRegion.$el;
				var $viewPane = (type == 'approval') ? this.approvalViewRegion.$el : this.viewRegion.$el;
				var $offsetParent = $listPane.offsetParent();
				if (!$offsetParent.is('html')) {
					$offsetParent.css({
						'overflow' : 'hidden'
					});
				}
				var parentWidth = $offsetParent.width();
				var parentHeight = $offsetParent.height();
				var width = parentWidth - ($listPane.outerWidth(true) - $listPane.width());
				var height = 0;
				if (this.listPaneHeight) {
					height = this.listPaneHeight;
				} else {
					height = Math.ceil(parentHeight / 2) - ($listPane.outerHeight(true) - $listPane.height());
				}
				$listPane.width(width).height(height);
				$listPane.show();
				width = parentWidth - ($viewPane.outerWidth(true) - $viewPane.width());
				height = (parentHeight - $listPane.outerHeight(true))
						- ($listPane.outerHeight(true) - $listPane.height());
				$viewPane.width(width).height(height);
				var approvalTabSize = 0;
				if (type == 'approval') {
					approvalTabSize = 47;
				}
				$viewPane.css({
					'top' : $listPane.outerHeight(true) + approvalTabSize + 'px',
					'left' : '0px',
					'overflow' : 'auto'
				});
				$viewPane.show();
				var self = this;
				$viewPane.resizable().resizable('destroy');
				$viewPane.resizable({
					containment : '#cont_flex_area',
					handles : 'n',
					resize : function(event, ui) {
						var remainingHeight = $offsetParent.height() - $(this).outerHeight(true);
						self.listPaneHeight = remainingHeight - ($listPane.outerHeight(true) - $listPane.height());
						$listPane.css('height', self.listPaneHeight - approvalTabSize + 'px');
					}
				});
				$viewPane.find('.ui-resizable-n').css({
					'top' : '0px'
				});
				$viewPane.off('resize').on('resize', function(event) {
					event.stopPropagation();
				});
			},
			showMoreActions : function(paginator) {
				if (paginator) {
					this.moreActionsRegion.show(new mail.MoreActionsView({
						model : this.mailModel,
						collection : mail.mboxCollection,
						paginator : this.paginator,
					}));
				} else {
					this.moreActionsRegion.show(new mail.MoreActionsView({
						model : this.mailModel,
						collection : mail.mboxCollection,
					}));
				}
				this.moreActionsRegion.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			showAddContactsView : function(addressCollection) {
				if (!addressCollection) {
					return;
				}
				this.addContactsRegion.show(new mail.AddContactsView({
					collection : addressCollection,
				}));
				this.addContactsRegion.$el.show();
				this.addContactsRegion.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			showMailSourceView : function(mimeModel) {
				this.mailSourceRegion.show(new mail.MailSourceView({
					model : mimeModel,
				}));
				this.mailSourceRegion.$el.show();
				this.mailSourceRegion.$el.attr('hidable', false);
				this.mailSourceRegion.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			showReportSpamView : function(mails) {
				if (!mails) {
					return;
				}
				this.reportSpamRegion.show(new mail.ReportSpamView({
					model : this.model,
					collection : mails,
					mboxCollection : mail.mboxCollection,
					paginator : this.paginator,
				}));
				this.reportSpamRegion.$el.attr('hidable', false);
				this.reportSpamRegion.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			showMboxPasswordView : function(mboxModel, isRenameMbox) {
				if (!mboxModel) {
					return;
				}
				if (this.mboxPasswordView) {
					this.mboxPasswordView.$mboxPasswordView.remove();
				}
				this.mboxPasswordView = new mail.MboxPasswordView({
					model : mboxModel,
					collection : mail.mboxCollection,
					isRenameMbox : isRenameMbox,
				});
				this.mboxPasswordView.render();
			},
			showFilterMailsView : function(mboxModel) {
				if (!mboxModel) {
					return;
				}
				this.filterMailsRegion.show(new mail.FilterMailsView({
					model : mboxModel,
					collection : mail.mboxCollection,
					mailModel : this.mailModel,
					paginator : this.paginator,
				}));
				this.filterMailsRegion.$el.attr('hidable', false);
				this.filterMailsRegion.$el.click(function(event) {
					event.stopPropagation();
				});
				this.filterMailsRegion.$el.show();
			},
		}); // mail.ContentLayout

		mail.ContentHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ContentHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#content-header-template').html();
					compiledTemplate = _.template(html);
					mail.ContentHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mboxModel : data.mboxModel,
					paginator : data.paginator,
					labelCollection : mail.labelCollection,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.mboxModel = this.model.get('mboxModel');
				this.paginator = this.model.get('paginator');
				this.listenTo(this.mboxModel, 'change', this.render);
				this.listenTo(app.vent, 'change:mbox', this.replaceMboxModel);
				this.listenTo(this.paginator, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $deleteUnseenMail = this.$el.find('a.mc-noReadDel');
				$deleteUnseenMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = self.mboxModel.get('MBOX_IDX');
					var msg = i18n.deleteUnseenMailPhrase;
					if (!confirm(msg)) {
						return false;
					}
					var model = new (app.BackboneModel.extend({
						url : 'mboxes/' + mboxId + '/emails?flag=unseen',
						defaults : {
							id : mboxId
						},
					}))();
					mail.overlayView.showProcessing();
					model.destroy({
						async : false,
						wait : true,
					});
					self.paginator.fetch({
						async : false,
					});
					mail.mboxCollection.fetch();
					app.vent.trigger('paginate:mails', self.mboxModel);
					mail.overlayView.hideProcessing();
					return false;
				});
				this.activateMboxItem();
			},
			replaceMboxModel : function(mboxModel, params) {
				this.stopListening(this.mboxModel);
				this.model.set('mboxModel', mboxModel);
				this.mboxModel = mboxModel;
				if (this.mboxModel.get('SHARED_MBOX_ID') > 0 && !this.mboxModel.get('sharer')) {
					var sharedMbox = this.mboxModel;
					var sharedMboxModel = new mail.SharedMboxModel();
					sharedMboxModel.set('id', this.mboxModel.get('SHARED_MBOX_ID'));
					var urlRoot = _.result(sharedMboxModel, 'urlRoot');
					sharedMboxModel.urlRoot = urlRoot.replace(/([^\/])$/, '$1/') + 'sharing';
					sharedMboxModel.fetch({
						success : function(model, response, options) {
							var sharer = model.get('sharer');
							sharedMbox.set('sharer', sharer);
						},
					});
				}
				this.listenTo(this.mboxModel, 'change', this.render);
				this.render();
			},
			activateMboxItem : function() {
				if (mail.approvalMboxModel.headerView)
					delete mail.approvalMboxModel.headerView;
				if (this.paginator.labelId) {
					app.vent.trigger('activate:mbox-item', mail.labelModel);
				} else if (this.paginator.params && this.paginator.params['search']) {
					var terms = '';
					var search = this.paginator.params['search'];
					if (typeof search == 'object') {
						for ( var p in search) {
							if (p == 'startDate' || p == 'endDate')
								return;
							if (terms.length)
								terms += '&';
							terms += 'search.' + p + '=' + search[p];
						}
					}
					var searchMboxModel = new mail.SearchMboxModel({
						mbox : this.mboxModel.get('MBOX_IDX'),
						terms : terms,
					});
					app.vent.trigger('activate:mbox-item', searchMboxModel);
				} else {
					app.vent.trigger('activate:mbox-item', this.mboxModel);
				}
			},
		}); // mail.ContentHeaderView

		mail.SimpleSearchView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.SimpleSearchView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#simple-search-template').html();
					compiledTemplate = _.template(html);
					mail.SimpleSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.mboxModel
				// this.collection == mail.paginator
			},
			onRender : function() {
				var self = this;
				var $input = this.$el.find('input.mc-search');
				var $search = this.$el.find('input.mc-search_btn');
				var $toggle = this.$el.find('a.mc-search_detail');

				$input.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						var term = $(this).val();
						self.search(term);
						$(this).val('');
					}
				});

				$search.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var term = $input.val();
					self.search(term);
					$input.val('');
				});

				$toggle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var contentLayout = mail.controller.contentLayout;
					var $advancedSearch = contentLayout.advancedSearchRegion.$el;
					var $splitPane = contentLayout.$el.find('#cont_flex_area');
					$advancedSearch.toggle();
					if ($advancedSearch.is(':visible')) {
						$(this).addClass('advanced');
						$splitPane.css('top', '149px');
					} else {
						$(this).removeClass('advanced');
						$splitPane.css('top', '88px');
					}
					$(window).resize();
				});
			},
			search : function(term) {
				if (!term)
					return;
				if (term.indexOf('%') != -1 || term.indexOf('_') != -1) {
					alert(i18n.search.invalidTerm);
					return;
				}
				var hash = '#mboxes/all/mails?search=' + encodeURIComponent(term);
				location.hash = hash;
			},
		}); // mail.SimpleSearchView

		mail.AdvancedSearchView = Backbone.Marionette.ItemView.extend({
			tagName : 'fieldset',
			template : function(data) {
				var html, compiledTemplate = mail.AdvancedSearchView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#advanced-search-template').html();
					compiledTemplate = _.template(html);
					mail.AdvancedSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mboxes : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.mboxCollection
				this.listenTo(app.vent, 'change:mbox', this.renderMboxSelect);
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $from = $el.find('input.advanced-search-from:first');
				var $toOptions = $el.find('select.advanced-search-to-options:first');
				var $to = $el.find('input.advanced-search-to:first');
				var $contentsOptions = $el.find('select.advanced-search-contents-options:first');
				var $contents = $el.find('input.advanced-search-contents:first');
				var $mboxSelect = $el.find('select.advanced-search-mbox-select:first');
				var $excludeTrashAndSpam = $el.find('input[name="excludeTrashAndSpam"]');
				var $periodSelect = $el.find('select.advanced-search-period-select:first');
				var $startDate = $el.find('input.advanced-search-start-date:first');
				var $endDate = $el.find('input.advanced-search-end-date:first');
				var $search = $el.find('button.btn_srch_submit:first');

				var $inputs = $from.add($to).add($contents);
				$inputs.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						$search.click();
					}
				});

				// Search for Mailbox
				this.renderMboxSelect();
				$mboxSelect.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).val();
					if (mboxId == 'all') {
						$excludeTrashAndSpam.removeAttr('disabled');
					} else {
						$excludeTrashAndSpam.attr('disabled', 'disabled');
					}
				});
				// Search Period Select
				$periodSelect.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var period = $(this).val();
					if (period == 'ALL') {
						$($startDate).add($endDate).attr('disabled', true).val('');
						return false;
					} else if (period == 'CUSTOM') {
						$($startDate).add($endDate).removeAttr('disabled').val('');
						return false;
					}
					$($startDate).add($endDate).removeAttr('disabled');
					var now = new Date(), date = new Date();
					switch (period) {
					case '1W':
						date.setDate(now.getDate() - 7);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '1M':
						date.setMonth(now.getMonth() - 1);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '3M':
						date.setMonth(now.getMonth() - 3);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '6M':
						date.setMonth(now.getMonth() - 6);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '1Y':
						date.setFullYear(now.getFullYear() - 1);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case 'ALL':
					default:
						$($startDate).add($endDate).attr('disabled', 'disabled').val('');
					}
				});
				// jQuery UI Datepicker
				$startDate.datepicker();
				$endDate.datepicker();
				// Search Button
				$search.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = '';
					if ($from.val()) {
						params += 'search.from=' + encodeURIComponent($from.val());
					}
					if ($to.val()) {
						if (params.length)
							params += '&';
						switch ($('option:selected', $toOptions).val()) {
						case 'to+cc':
							params += 'search.to=' + encodeURIComponent($to.val());
							params += '&search.cc=' + encodeURIComponent($to.val());
							break;
						case 'to':
						default:
							params += 'search.to=' + encodeURIComponent($to.val());
						}
					}
					if ($contents.val()) {
						if (params.length)
							params += '&';
						switch ($('option:selected', $contentsOptions).val()) {
						case 'subject+body':
							params += 'search.subject=' + encodeURIComponent($contents.val());
							params += '&search.body=' + encodeURIComponent($contents.val());
							break;
						case 'subject':
							params += 'search.subject=' + encodeURIComponent($contents.val());
							break;
						case 'body':
							params += 'search.body=' + encodeURIComponent($contents.val());
							break;
						case 'attachments':
							params += 'search.attachments=' + encodeURIComponent($contents.val());
							break;
						case 'all':
						default:
							params += 'search.subject=' + encodeURIComponent($contents.val());
							params += '&search.body=' + encodeURIComponent($contents.val());
							params += '&search.attachments=' + encodeURIComponent($contents.val());
						}
					}
					if ($startDate.is(':enabled') && $endDate.is(':enabled')) {
						var pattern = /^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/;
						if (!pattern.test($startDate.val()) || !pattern.test($endDate.val())) {
							alert(i18n.search.invalidDate);
							return false;
						}
						if (params.length)
							params += '&';
						params += 'search.startDate=' + $startDate.val();
						params += '&search.endDate=' + $endDate.val();
					}
					if ($excludeTrashAndSpam.is(':enabled')) {
						if (params.length)
							params += '&';
						params += 'search.excludeTrashAndSpam=';
						params += $excludeTrashAndSpam.filter(':checked').val();
					}
					var hash = '#';
					var mboxId = $('option:selected', $mboxSelect).val();
					if (mboxId) {
						hash += 'mboxes/' + mboxId + '/mails';
					} else {
						hash += 'mboxes/all/mails';
					}
					if (params.length) {
						hash += '?' + params;
					}
					location.hash = hash;
				}); // $search.click(function(event) {...});
			},
			renderMboxSelect : function() {
				var $el = this.$el;
				var $mboxSelect = $el.find('select.advanced-search-mbox-select:first');
				$mboxSelect.empty();
				var $excludeTrashAndSpam = $el.find('input[name="excludeTrashAndSpam"]');
				$excludeTrashAndSpam.removeAttr('disabled');
				var options = [];
				options.push($('<option value="all"></option>').text(i18n.search.allMboxes));
				this.collection.each(function(mboxModel) {
					var $option = $('<option></option>');
					$option.val(mboxModel.get('MBOX_IDX'));
					if (mail.mboxModel.get('MBOX_IDX') == mboxModel.get('MBOX_IDX')) {
						$option.attr('selected', 'selected');
						$excludeTrashAndSpam.attr('disabled', 'disabled');
					}
					switch (mboxModel.get('MBOX_TYPE')) {
					case 1:
						$option.text(i18n.mbox.inbox);
						break;
					case 2:
						$option.text(i18n.mbox.sent);
						break;
					case 3:
						$option.text(i18n.mbox.trash);
						break;
					case 4:
						$option.text(i18n.mbox.drafts);
						break;
					case 5:
						$option.text(i18n.mbox.junk);
						break;
					case 6:
					default:
						$option.text(mboxModel.get('MBOX_NAME'));
					}
					options.push($option);
				});
				$mboxSelect.append(options);
			},
		}); // mail.AdvancedSearchView

		mail.ComposeHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ComposeHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#compose-header-template').html();
					compiledTemplate = _.template(html);
					mail.ComposeHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel({ MBOX_TYPE : 4 // draft })
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(app.vent, 'show:compose-header-name', this.render);
			},
		}); // mail.ComposeHeaderView

		mail.DeliveryStatusHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.DeliveryStatusHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#delivery-status-header-template').html();
					compiledTemplate = _.template(html);
					mail.DeliveryStatusHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : mail.deliveryStatusPaginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = mail.MboxModel
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(app.vent, 'content-header:delivery-status', this.render);
			},
		}); // mail.DeliveryStatusHeaderView

		mail.ComposeToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ComposeToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#compose-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.ComposeToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					config : app.config,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel;
				this.parentView = options.parentView;
				this.composeOptionsRegion = options.composeOptionsRegion;
				this.listenTo(app.vent, 'clear:draft', this.clearDraft);
				this.listenTo(app.vent, 'update:draft', this.updateDraft);
			},
			onRender : function() {
				var $send = this.$el.find('.send-mail');
				$send.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('send:mail');
					return false;
				});
				var $sendSecure = this.$el.find('.send-secure');
				$sendSecure.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('send:secure');
					return false;
				});
				var $preview = this.$el.find('.preview-mail');
				$preview.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('preview:mail');
					return false;
				});
				var $save = this.$el.find('.save-mail');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('save:mail');
					return false;
				});
				// Compose Options:  
				var composeOptionsView = new mail.ComposeOptionsView({
					model : this.userModel,
					contentLayoutView : this.parentView,
					composeOptionsRegion : this.composeOptionsRegion,
				});
				this.composeOptionsRegion.show(composeOptionsView);
				var $composeOptions = this.$el.find('img.buWriteOpt').parent('button');
				$composeOptions.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					composeOptionsView.$composeOptionsRegion.toggle();
					return false;
				});
			},
			clearDraft : function() {
				var $draft = this.$el.find('span#draft-time');
				$draft.empty();
			},
			updateDraft : function() {
				var $draft = this.$el.find('span#draft-time');
				var update = $.format.date(new Date(), 'HH:mm:ss');
				$draft.text(i18n.savedAsDraft + ' ' + update);
			},
		}); // mail.ComposeToolbarView

		mail.SentToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.SentToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#sent-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.SentToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// model = mail.mailModel (MBOX_TYPE == 1)
			},
			onRender : function() {
				var self = this;
				var $moveInbox = this.$el.find('p.menu_txt a.inbox');
				$moveInbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = '#mboxes/' + self.model.get('MBOX_IDX') + '/mails';
					if (isPopup() && window.opener) {
						window.opener.location.hash = url;
						window.close();
					} else if (isPopup()){
						location.href = '../' + url;
					} else {
						location.hash = url;
					}
					return false;
				});
				var $moveCompose = this.$el.find('p.menu_txt a.compose');
				$moveCompose.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = '#compose';
					if (isPopup() && window.opener) {
						window.opener.location.hash = url;
						window.close();
					} else if (isPopup()){
						location.href = '../' + url;
					} else {
						location.hash = url;
					}
					return false;
				});
			},
		}); // mail.SentToolbarView

		mail.ListToolbarView = Backbone.Marionette.ItemView.extend({
			// parentEl : 'div#listBtnMenu',
			template : function(data) {
				var html, compiledTemplate = mail.ListToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#list-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.ListToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					mbox : mail.mboxModel.toJSON(),
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				// this.collection == mail.paginator
				this.mboxCollection = options.mboxCollection;
				this.mailModel = options.mailModel;
				this.parentView = options.parentView;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(this.mailModel, 'change', this.render);
				this.listenTo(app.vent, 'toggle:list-toolbar-print-button', this.togglePrintButton);
				this.listenTo(app.vent, 'activate:list-toolbar-split-button', this.activateSplitButton);
			},
			onRender : function() {
				var self = this;
				var $listRegion = this.parentView.listRegion.$el;
				var $checkboxes = $listRegion.find('.mc-mailList .mc-check .mCheck');
				var $buttons = this.$el.find('button');
				if (!$checkboxes.length)
					$checkboxes = $('<input type="checkbox" class="dummy-checkbox"/>');
				$checkboxes.change(function(event) {
					event.stopPropagation();
					$buttons.each(function(index, element) {
						var $this = $(this);
						if ($this.is('.btn_selectAll') || $this.is('.mc-sbRgt')) {
							return;
						}
						if ($checkboxes.filter(':checked').length == 0) {
							$this.attr('disabled', 'disabled');
						} else {
							$this.removeAttr('disabled');
						}
						if ($this.is('.btn_txt')) {
							$this.css('box-shadow', 'none');
						}
					});
				});
				$checkboxes.eq(0).change();
				var $selectAll = this.$el.find('div.mc-buttonSet button.btn_selectAll');
				$selectAll.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($checkboxes.eq(0).hasClass('dummy-checkbox')) {
						return false;
					}
					var $this = $(this);
					var $toggle = $listRegion.find('.mc-mailListItem .mc-check .mCheck');
					if ($this.is('.toolbar-selectAll')) {
						$this.removeClass('toolbar-selectAll');
						$checkboxes.prop('checked', false);
						$toggle.prop('checked', false);
					} else {
						$this.addClass('toolbar-selectAll');
						$checkboxes.prop('checked', true);
						$toggle.prop('checked', true);
					}
					$checkboxes.change();
					return false;
				});
				var $delete = this.$el.find('div.mc-buttonSet button.btn_deleteMail');
				$delete.add($permanentlyDelete).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trashMails($checkboxes);
					return false;
				});
				var $permanentlyDelete = this.$el.find('div.mc-buttonSet button.permanently-delete-mail');
				$permanentlyDelete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var MBOX_TYPE = mail.mboxModel.get('MBOX_TYPE');
					var USERS_DELBOX = self.model.get('USERS_DELBOX');
					var msg = i18n.permanentlyDeleteMail;
					if (MBOX_TYPE == 3 || MBOX_TYPE == 5) {
						switch (MBOX_TYPE) {
						case 3: //  
							msg = i18n.deleteMail;
							break;
						case 5: //  
							msg = i18n.deleteSpamMail;
							break;
						}
					}
					if (confirm(msg))
						self.deleteMails($checkboxes);
					return false;
				});
				var $markAsRead = this.$el.find('div.mc-buttonSet .btn_markAsRead');
				$markAsRead.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $checked = $checkboxes.filter(':checked');
					if ($checked.length == 0)
						return false;
					var unflaggables = [], seenMails = [], unseenMails = [];
					$checked.each(function(index, element) {
						var M_IDX = $(this).val();
						var model = self.collection.find(function(mailModel) {
							if (M_IDX == mailModel.get('M_IDX'))
								return true;
						});
						if (model) {
							var M_ISREAD = model.get('M_ISREAD');
							switch (M_ISREAD) {
							case 'P': //  
							case 'X': //  
							case 'N': //  
								unseenMails.push(model);
								break;
							case 'O': //  
							case 'Y': //  
								seenMails.push(model);
								break;
							case 'A': // IMAP  
							case 'R': // 
							case 'F': // 
							default:
								unflaggables.push(model);
							}
						}
					});
					var ids = [], flags = [];
					if (unseenMails.length > 0) {
						$.each(unseenMails, function(index, model) {
							ids.push(model.get('M_IDX'));
							if (model.get('M_ISREAD') == 'P')
								flags.push('O')
							else
								flags.push('Y');
						});
					} else {
						if (unflaggables.length > 0)
							alert(i18n.unableToMarkAsUnread);
						$.each(seenMails, function(index, model) {
							ids.push(model.get('M_IDX'));
							if (model.get('M_ISREAD') == 'O')
								flags.push('P')
							else
								flags.push('N');
						});
					}
					if (ids.length == 0) {
						return false;
					}
					mail.overlayView.showProcessing();
					var model = new (app.BackboneModel.extend({
						urlRoot : 'mboxes/' + mail.mboxModel.get('MBOX_IDX'),
						defaults : {
							id : 'mails'
						}
					}))();
					model.save({
						mailIds : ids,
						mailFlags : flags,
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							mail.overlayView.hideProcessing();
							self.collection.pager();
							self.mboxCollection.fetch();
						},
						error : function(model, response, options) {
							alert('Failed to update mail flags');
							mail.overlayView.hideProcessing();
						},
					});
					return false;
				});
				$checkboxes.change(function(event) {
					var $checked = $checkboxes.filter(':checked');
					if ($checked.length == 0)
						return true;
					var unflaggables = [], seenMails = [], unseenMails = [];
					$checked.each(function(index, element) {
						var M_IDX = $(this).val();
						var model = self.collection.find(function(mailModel) {
							if (M_IDX == mailModel.get('M_IDX'))
								return true;
						});
						if (model) {
							var M_ISREAD = model.get('M_ISREAD');
							switch (M_ISREAD) {
							case 'P': //  
							case 'X': //  
							case 'N': //  
								unseenMails.push(model);
								break;
							case 'O': // 
							case 'Y': // 
								seenMails.push(model);
								break;
							case 'A': // IMAP  
							case 'R': // 
							case 'F': // 
							default:
								unflaggables.push(model);
							}
						}
					});
					if (unseenMails.length > 0) {
						$markAsRead.addClass('mark-readMode');
						$markAsRead.text(i18n.markAsRead);
					} else {
						$markAsRead.removeClass('mark-readMode');
						$markAsRead.text(i18n.markAsUnread);
					}
				});
				var $reportSpam = this.$el.find('div.mc-buttonSet .btn_reportSpam');
				$reportSpam.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $listRegion = self.parentView.listRegion.$el;
					var $checkboxes = $listRegion.find('.mc-mailList .mc-check .mCheck');
					var mailCollection = new mail.MailCollection();
					$checkboxes.each(function() {
						if (!this.checked)
							return;
						var mailId = this.value;
						var mailModel = self.collection.find(function(model) {
							return mailId == model.get('M_IDX');
						});
						if (mailModel)
							mailCollection.add(mailModel);
					});
					app.vent.trigger('show:report-spam', mailCollection);
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('.mail-toolbar-report-spam');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $reply = this.$el.find('.reply-mail');
				var $replyAll = this.$el.find('.reply-mail-to-all');
				var $recomposeMail = this.$el.find('.recomposeMailBtn');
				$reply.add($replyAll).add($recomposeMail).click(function(event) {
					event.stopPropagation();
					var $checked = $checkboxes.filter(':checked');
					if ($checked.length !== 1) {
						alert(i18n.pleaseSelectOneMail);
						return false;
					}
					var mailModel = self.collection.find(function(model) {
						return $checked.val() == model.get('M_IDX');
					});
					if (mailModel.get('MALICIOUS_ID')) {
						alert(i18n.cannotComposeMaliciousMail);
						return false;
					}
					var hash;
					if ($(this).hasClass('reply-mail'))
						hash = '#reply?id=';
					else if ($(this).hasClass('reply-mail-to-all'))
						hash = '#reply-to-all?id=';
					else if ($(this).hasClass('recomposeMailBtn'))
						hash = '#recompose?id=';
					hash += $checked.val();
					if (self.model.get('COMPOSE_NEW_WINDOW')) {
						var win = window.open('popup/' + hash, '', 'scrollbars=yes,width=1000,height=800');
						win.focus();
					} else {
						location.hash = hash;
					}
					return false;
				});
				var $forward = this.$el.find('.forward-mail');
				var $forwardForMe = this.$el.find('.forward-for-me');
				$forward.add($forwardForMe).click(function(event) {
					event.stopPropagation();
					var $checked = $checkboxes.filter(':checked');
					var params = [];
					var isMaliciousMail = false;
					$checked.each(function(index, element) {
						var mailModel = self.collection.find(function(model) {
							return $(element).val() == model.get('M_IDX');
						});
						if (mailModel.get('MALICIOUS_ID')) {
							isMaliciousMail = true;
							return false;
						}
						params.push('id=' + $(element).val());
					});
					if (isMaliciousMail) {
						alert(i18n.cannotComposeMaliciousMail);
						return false;
					}
					var hash;
					if ($(this).hasClass('forward-mail'))
						hash = '#forward?';
					else if ($(this).hasClass('forward-for-me'))
						hash = '#forward-for-me?';
					hash += params.join('&');
					if (self.model.get('COMPOSE_NEW_WINDOW')) {
						var win = window.open('popup/' + hash, '', 'scrollbars=yes,width=1000,height=800');
						win.focus();
					} else {
						location.hash = hash;
					}
					return false;
				});
				var $moveToMbox = this.$el.find('.move-to-mbox');
				$moveToMbox.click(function(event) {
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#moveMailLayer');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $selectLabel = this.$el.find('span.mc-groupBtn button.select-label');
				$selectLabel.click(function(event) {
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#selectLabelsLayer');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
					app.vent.trigger('init:select-label-items');
				});
				var $moreActions = this.$el.find('.more-actions');
				$moreActions.click(function(event) {
					app.vent.trigger('view:more-actions', self.collection);
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#ly_select_mailaction');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $printOptions = this.$el.find('.mc-print:first');
				$printOptions.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!self.mailModel || !self.mailModel.get('M_IDX')) {
						alert(i18n.pleaseSelectMail);
						return false;
					}
					var $layer = self.parentView.$el.find('div#print-options-layer');
					$layer.css({
						position : 'absolute',
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $split = this.$el.find('.mc-layoutSelect a');
				$split.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var split = '0';
					if ($this.hasClass('mc-setHorizontal')) {
						split = '1';
					} else if ($this.hasClass('mc-setVertical')) {
						split = '2';
					} else {
						split = '0';
					}
					var setting = self.model.get('USERS_MAIL_VIEW_MODE');
					if (split === setting) {
						return false;
					}
					self.model.save({
						USERS_MAIL_VIEW_MODE : split
					}, {
						patch : true,
						wait : true,
						success : function(model, reponse, options) {
							var split = model.get('USERS_MAIL_VIEW_MODE');
							switch (split) {
							case '0':
								mail.controller.contentLayout.showNoSplit();
								break;
							case '1':
								mail.controller.contentLayout.showHorizontalSplit();
								break;
							case '2':
								mail.controller.contentLayout.showVerticalSplit();
								break;
							default:
								mail.controller.contentLayout.showNoSplit();
							}
							$(window).trigger('resize.columns');
						},
					});
					return false;
				});
			},
			togglePrintButton : function(action) {
				var $print = this.$el.find('.mc-print:first');
				switch (action) {
				case 'show':
					$print.css('display', 'inline-block');
					$print.show();
					break;
				case 'hide':
					$print.hide();
					break;
				}
			},
			activateSplitButton : function(split) {
				var $split = this.$el.find('.mc-layoutSelect a');
				$split.removeClass('on');
				switch (split) {
				case 'no':
					$split.filter('.mc-setCommon').addClass('on');
					break;
				case 'vertical':
					$split.filter('.mc-setVertical').addClass('on');
					break;
				case 'horizontal':
					$split.filter('.mc-setHorizontal').addClass('on');
					break;
				}
			},
			trashMails : function($checkboxes) {
				var self = this;
				var ids = [];
				var containsImportantMails = false;
				$checkboxes.each(function() {
					if (!this.checked)
						return;
					var mailId = this.value;
					var mailModel = self.collection.find(function(model) {
						return mailId == model.get('M_IDX');
					});
					if (mailModel) {
						ids.push(mailModel.get('M_IDX'));
						if (mailModel.get('M_PRIORITY') == 1)
							containsImportantMails = true;
					}
				});
				if (ids.length === 0) {
					return;
				}
				if (containsImportantMails) {
					if (!confirm(i18n.containsImportantMails))
						return;
				}
				var trashMboxModel = this.mboxCollection.find(function(model) {
					return model.get('MBOX_TYPE') == 3;
				});
				if (!trashMboxModel || !trashMboxModel.get('MBOX_IDX')) {
					alert('Failed to trash mails (Not found trash mailbox)');
					return;
				}
				mail.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					urlRoot : 'mboxes/' + mail.mboxModel.get('MBOX_IDX'),
					defaults : {
						id : 'mails'
					}
				}))();
				var jqXHR = model.save({
					MBOX_IDX : trashMboxModel.get('MBOX_IDX'),
					mailIds : ids,
				}, {
					patch : true,
					wait : true,
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					mail.overlayView.hideProcessing();
					var paginator = self.collection;
					if (paginator.length == ids.length && ids.length == data.updated) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
							self.mboxCollection.fetch();
							return;
						}
					}
					paginator.pager();
					self.mboxCollection.fetch();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					mail.overlayView.hideProcessing();
					alert('Failed to trash mails.');
				});
			},
			deleteMails : function($checkboxes) {
				var self = this;
				var ids = [];
				$checkboxes.each(function() {
					if (!this.checked)
						return;
					var mailId = this.value;
					var mailModel = self.collection.find(function(model) {
						return mailId == model.get('M_IDX');
					});
					if (mailModel)
						ids.push(mailModel.get('M_IDX'));
				});
				if (ids.length === 0) {
					return;
				}
				mail.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					url : function() {
						var url = 'mboxes/' + mail.mboxModel.get('MBOX_IDX') + '/mails';
						for (var i = 0; i < ids.length; i++) {
							url += (i == 0 ? '?' : '&') + 'id=' + ids[i];
						}
						return url;
					},
					defaults : {
						id : 'mails'
					}
				}))();
				var jqXHR = model.destroy({
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					mail.overlayView.hideProcessing();
					var paginator = self.collection;
					if ($checkboxes.length == ids.length && ids.length == data.deleted) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
						} else {
							paginator.pager();
						}
					} else {
						paginator.pager();
					}
					self.mboxCollection.fetch();
					self.model.fetch(); // app.userModel
				}).fail(function(jqXHR, textStatus, errorThrown) {
					mail.overlayView.hideProcessing();
					alert('Failed to delete mails.');
				});
			},
		}); // mail.ListToolbarView

		mail.MailToolbarView = Backbone.Marionette.ItemView.extend({
			// parentEl : 'div#readBtnMenu',
			template : function(data) {
				var html, compiledTemplate = mail.MailToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.MailToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mail : data,
					mbox : mail.mboxModel.toJSON(),
					mboxCollection : mail.mboxCollection,
					user : app.userModel.toJSON(),
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.mailModel
				// this.collection == mail.mboxCollection
				this.mboxModel = options.mboxModel;
				this.paginator = options.paginator;
				this.parentView = options.parentView;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(app.vent, 'change:mbox', this.replaceMboxModel);
			},
			replaceMboxModel : function(mboxModel) {
				this.mboxModel = mboxModel;
			},
			onRender : function() {
				var self = this;
				var $reply = this.$el.find('.reply-mail');
				var $replyAll = this.$el.find('.reply-mail-to-all');
				var $forward = this.$el.find('.forward-mail');
				var $forwardForMe = this.$el.find('.forward-for-me');
				var $recomposeMail = this.$el.find('.recomposeMailBtn');
				$reply.add($replyAll).add($forward).add($forwardForMe).add($recomposeMail).click(function(event) {
					event.stopPropagation();
					if (self.model.get('MALICIOUS_ID')) {
						alert(i18n.cannotComposeMaliciousMail);
						return false;
					}
					var hash;
					if ($(this).hasClass('reply-mail'))
						hash = '#reply?id=';
					else if ($(this).hasClass('reply-mail-to-all'))
						hash = '#reply-to-all?id=';
					else if ($(this).hasClass('forward-mail'))
						hash = '#forward?id=';
					else if ($(this).hasClass('forward-for-me'))
						hash = '#forward-for-me?id=';
					else if ($(this).hasClass('recomposeMailBtn'))
						hash = '#recompose?id=';
					hash += self.model.get('M_IDX');
					if (app.userModel.get('COMPOSE_NEW_WINDOW')) {
						hash = 'popup/' + hash;
						if (isPopup())
							hash = '../' + hash;
						var win = window.open(hash, '', 'scrollbars=yes,width=1000,height=800');
						win.focus();
					} else {
						location.hash = hash;
					}
					return false;
				});
				var $delete = this.$el.find('div.mc-buttonSet button.delete-mail');
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.trashMail();
				});
				var $permanentlyDelete = this.$el.find('div.mc-buttonSet button.permanently-delete-mail');
				$permanentlyDelete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var MBOX_TYPE = mail.mboxModel.get('MBOX_TYPE');
					var USERS_DELBOX = app.userModel.get('USERS_DELBOX');
					var msg = i18n.permanentlyDeleteMail;
					if (MBOX_TYPE == 3 || MBOX_TYPE == 5) {
						switch (MBOX_TYPE) {
						case 3: //  
							msg = i18n.deleteMail;
							break;
						case 5: //  
							msg = i18n.deleteSpamMail;
							break;
						}
					}
					if (confirm(msg)) {
						jqXHR = self.deleteMail();
					} else {
						return false;
					}
				});
				var $reportSpam = this.$el.find('div.mc-buttonSet .btn_reportSpam');
				$reportSpam.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mails = new mail.MailCollection();
					mails.add(self.model);
					app.vent.trigger('show:report-spam', mails);
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('.mail-toolbar-report-spam');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $markAsRead = this.$el.find('div.mc-buttonSet .btn_markAsRead');
				$markAsRead.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var M_ISREAD = self.model.get('M_ISREAD');
					switch (M_ISREAD) {
					case 'A': // IMAP  
					case 'R': // 
					case 'F': // 
					case 'O': // 
						return false;
					case 'Y': // 
						M_ISREAD = 'N';
						break;
					case 'P': //  
						M_ISREAD = 'O';
						break;
					case 'X': //  
					case 'N': //  
					default:
						M_ISREAD = 'Y';
						break;
					}
					self.model.save({
						M_ISREAD : M_ISREAD,
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							var mboxCollection = self.collection;
							if (isPopup() && !window.opener.closed) {
								var openerApp = window.opener.require('app');
								openerApp.mail.paginator.pager();
								mboxCollection = openerApp.mail.mboxCollection;
							}
							var mboxId = model.get('MBOX_IDX');
							var mboxModel = mboxCollection.findModel('MBOX_IDX', mboxId);
							if (mboxModel)
								mboxModel.fetch();
						}
					});
					return false;
				});
				var $moveToMbox = this.$el.find('.move-to-mbox');
				$moveToMbox.click(function(event) {
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#moveMailLayer');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $selectLabel = this.$el.find('span.mc-groupBtn button.select-label');
				$selectLabel.click(function(event) {
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#selectLabelsLayer');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
					app.vent.trigger('init:select-label-items');
				});
				var $moreActions = this.$el.find('.more-actions');
				$moreActions.click(function(event) {
					app.vent.trigger('view:more-actions');
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#ly_select_mailaction');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
				var $toList = this.$el.find('button.goList');
				$toList.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					location.hash = '#' + self.paginator.getURL();
					return false;
				});
				var $toPrev = this.$el.find('button.goPrev');
				$toPrev.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.model.get('prevMail') == null) {
						alert(i18n.noPreviousEmail);
						return false;
					}
					if (mail.mboxModel.get('SHARED_MBOX_ID') == 0) {
						markAsRead('prevMail');
					}
					var hash = self.model.prevMailHash(self.mboxModel, self.paginator);
					location.hash = hash;
					return false;
				});
				var $toNext = this.$el.find('button.goNext');
				$toNext.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.model.get('nextMail') == null) {
						alert(i18n.noNextEmail);
						return false;
					}
					if (mail.mboxModel.get('SHARED_MBOX_ID') == 0) {
						markAsRead('nextMail');
					}
					var hash = self.model.nextMailHash(self.mboxModel, self.paginator);
					location.hash = hash;
					return false;
				});
				var markAsRead = function(attribute) {
					var _mail = self.model.get(attribute);
					switch (_mail.M_ISREAD) {
					case 'A': // IMAP  
					case 'R': // 
					case 'F': // 
					case 'O': // 
					case 'Y': // 
						return;
					case 'P': //  
						_mail.M_ISREAD = 'O';
						break;
					case 'X': //  
					case 'N': //  
					default:
						_mail.M_ISREAD = 'Y';
						break;
					}
					var mailModel = new mail.MailModel({
						M_IDX : _mail.M_IDX
					});
					mailModel.save({
						M_ISREAD : _mail.M_ISREAD
					}, {
						async : false,
						patch : true,
						wait : true,
						success : function(model, response, options) {
							var mboxCollection = self.collection;
							if (isPopup() && !window.opener.closed) {
								var openerApp = window.opener.require('app');
								openerApp.mail.paginator.pager();
								mboxCollection = openerApp.mail.mboxCollection;
							}
							var mboxId = _mail.MBOX_IDX;
							var mboxModel = mboxCollection.findModel('MBOX_IDX', mboxId);
							if (mboxModel)
								mboxModel.fetch();
						},
					});
					return;
				};
				var $printOptions = this.$el.find('div.mc-rightTool a.mc-print');
				$printOptions.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $offsetParent = $(this).offsetParent();
					var position = $(this).position();
					var top = $offsetParent.position().top + position.top + $(this).outerHeight();
					var $layer = self.parentView.$el.find('div#print-options-layer');
					$layer.css({
						position : 'absolute',
						top : top
					});
					$layer.attr('hidable', false);
					$layer.toggle();
				});
			},
			trashMail : function() {
				var self = this;
				var trashMboxModel = this.collection.find(function(mboxModel) {
					return mboxModel.get('MBOX_TYPE') === 3;
				});
				var MBOX_IDX = trashMboxModel.get('MBOX_IDX');
				var jqXHR = this.model.save({
					MBOX_IDX : MBOX_IDX
				}, {
					patch : true,
					wait : true,
				});
				jqXHR.done(function() {
					var mboxId = self.mboxModel.get('MBOX_IDX');
					var now = Date.now ? Date.now() : new Date().getTime();
					var url = '#' + self.paginator.getURL() + '&_=' + now;
					if (isPopup()) {
						if (!window.opener.closed) {
							var openerApp = window.opener.require('app');
							openerApp.mail.mboxCollection.fetch();
							window.opener.location.hash = url;
						}
						window.close();
					} else {
						self.collection.fetch();
						var afterDeletingMoving = app.userModel.get('AFTER_DELETING_MOVING');
						switch (afterDeletingMoving) {
						case 'P':
							if (self.model.get('prevMail') != null)
								url = self.model.prevMailHash(self.mboxModel, self.paginator);
							break;
						case 'N':
							if (self.model.get('nextMail') != null)
								url = self.model.nextMailHash(self.mboxModel, self.paginator);
							break;
						}
						location.hash = url;
					}
				});
			},
			deleteMail : function() {
				var self = this;
				var jqXHR = this.model.destroy({
					wait : true,
				});
				jqXHR.done(function() {
					var mboxId = self.mboxModel.get('MBOX_IDX');
					var now = Date.now ? Date.now() : new Date().getTime();
					var url = '#' + self.paginator.getURL() + '&_=' + now;
					if (isPopup()) {
						if (!window.opener.closed) {
							var openerApp = window.opener.require('app');
							openerApp.mail.mboxCollection.fetch();
							window.opener.location.hash = url;
						}
						window.close();
					} else {
						self.collection.fetch();
						var afterDeletingMoving = app.userModel.get('AFTER_DELETING_MOVING');
						switch (afterDeletingMoving) {
						case 'P':
							if (self.model.get('prevMail') != null)
								url = self.model.prevMailHash(self.mboxModel, self.paginator);
							break;
						case 'N':
							if (self.model.get('nextMail') != null)
								url = self.model.nextMailHash(self.mboxModel, self.paginator);
							break;
						}
						location.hash = url;
					}
				});
			},
		}); // mail.MailToolbarView

		mail.DeliveryStatusToolbarView = Backbone.Marionette.ItemView.extend({
			// parentEl : 'div#deliveryBtnMenu',
			template : function(data) {
				var html, compiledTemplate = mail.DeliveryStatusToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#delivery-status-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.DeliveryStatusToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				// this.collection == this.paginator
				this.deliveryStatusListRegion = options.deliveryStatusListRegion;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(app.vent, 'enable:delivery-toolbar-buttons', this.enableButtons);
				this.listenTo(app.vent, 'disable:delivery-toolbar-buttons', this.disableButtons);
			},
			onRender : function() {
				var self = this;
				var $split = this.$el.find('.mc-layoutSelect a');
				var $selectAll = this.$el.find('div.mc-buttonSet button.btn_selectAll');
				var $delete = this.$el.find('div.mc-buttonSet button.btn_deleteMail');

				this.disableButtons();

				$selectAll.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.deliveryStatusListRegion.$el.find('.mc-mailList .mc-check .mCheck');
					var $selectAllCheckbox = self.deliveryStatusListRegion.$el
							.find('.mc-mailListItem .mc-check .mCheck');
					if (!$checkboxes.length) {
						return false;
					}
					var $this = $(this);
					if ($this.is('.toolbar-selectAll')) {
						$this.removeClass('toolbar-selectAll');
						$checkboxes.prop('checked', false);
						$selectAllCheckbox.prop('checked', false);
					} else {
						$this.addClass('toolbar-selectAll');
						$checkboxes.prop('checked', true);
						$selectAllCheckbox.prop('checked', true);
						self.$el.find('button').removeAttr('disabled', 'disabled');
					}
				});
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = self.deliveryStatusListRegion.$el.find('.send_ok .mc-check .mCheck');
					var deleteCnt = self.deleteDeliveryStatus($checkboxes);
					if (deleteCnt > 0) {
						app.vent.trigger('paginate:delivery-status');
					}
				});
			},
			enableButtons : function() {
				this.$el.find('button').each(function() {
					var $this = $(this);
					if ($this.is('.btn_selectAll') || $this.is('.mc-sbRgt')) {
						return;
					}
					$this.removeAttr('disabled');
					if ($this.is('.btn_txt')) {
						$this.css('box-shadow', 'none');
					}
				});
			},
			disableButtons : function() {
				this.$el.find('button').each(function() {
					var $this = $(this);
					if ($this.is('.btn_selectAll') || $this.is('.mc-sbRgt') || $this.is('#sc_guide')) {
						return;
					}
					$this.attr('disabled', 'disabled');
					if ($this.is('.btn_txt')) {
						$this.css('box-shadow', 'none');
					}
				});
			},
			deleteDeliveryStatus : function($checkboxes) {
				var self = this;
				var deleteCnt = 0;
				$checkboxes.each(function() {
					if (!this.checked)
						return;
					var chkMidx = this.value;
					var models = self.collection.filter(function(model) {
						if (chkMidx == model.get('MAIL_RECONF_IDX'))
							return true;
					});
					_.each(models, function(model) {
						model.destroy({
							wait : true,
							async : false,
							data : {
								group : model.get('MAIL_RECONF_GROUP'),
								_method : 'DELETE',
							},
						});
						deleteCnt++;
					});
				});
				return deleteCnt;
			},
		}); // mail.DeliveryStatusToolbarView

		mail.MailView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			template : function(data) {
				var html, compiledTemplate = mail.MailView.compiledTemplate;
				var compiledEmptyTemplate = mail.MailView.compiledEmptyTemplate;
				var compiledThreadsTemplate = mail.MailView.compiledThreadsTemplate;
				var compiledPrevNextTemplate = mail.MailView.compiledPrevNextTemplate;
				var compiledMaliciousTemplate = mail.MailView.compiledMaliciousTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-view-template').html();
					compiledTemplate = _.template(html);
					mail.MailView.compiledTemplate = compiledTemplate;
				}
				if (!compiledEmptyTemplate) {
					html = mail.$template.filter('#empty-mail-view-template').html();
					compiledEmptyTemplate = _.template(html);
					mail.MailView.compiledEmptyTemplate = compiledEmptyTemplate;
				}
				if (!compiledThreadsTemplate) {
					html = mail.$template.filter('#thread-mails-template').html();
					compiledThreadsTemplate = _.template(html);
					mail.MailView.compiledThreadsTemplate = compiledThreadsTemplate;
				}
				if (!compiledPrevNextTemplate) {
					html = mail.$template.filter('#prev-next-mails-template').html();
					compiledPrevNextTemplate = _.template(html);
					mail.MailView.compiledPrevNextTemplate = compiledPrevNextTemplate;
				}
				if (!compiledMaliciousTemplate) {
					html = mail.$template.filter('#malicious-mail-view-template').html();
					compiledMaliciousTemplate = _.template(html);
					mail.MailView.compiledMaliciousTemplate = compiledMaliciousTemplate;
				}
				if (mail.mailModel.get('M_IDX')) {
					var popup = isPopup();
					if (mail.mailModel.get('MALICIOUS_ID')) {
						html = compiledMaliciousTemplate({
							urlRoot : _.result(mail.mailModel, 'urlRoot'),
							mail : data,
							i18n : i18n,
							popup : popup,
						});
					} else {
						html = compiledTemplate({
							urlRoot : _.result(mail.mailModel, 'urlRoot'),
							mail : data,
							mbox : mail.mboxModel.toJSON(),
							user : app.userModel.toJSON(),
							paginator : mail.paginator,
							i18n : i18n,
							popup : popup,
						});
					}
					var _html = compiledThreadsTemplate({
						urlRoot : _.result(mail.mailModel, 'urlRoot'),
						mail : data,
						i18n : i18n,
						popup : popup,
					});
					var split = app.userModel ? app.userModel.get('USERS_MAIL_VIEW_MODE') : '0';
					var hash = location.hash;
					if (split == '0' && hash.indexOf('#print') == -1) {
						var prevHash = mail.mailModel.prevMailHash(mail.mboxModel, mail.paginator);
						var nextHash = mail.mailModel.nextMailHash(mail.mboxModel, mail.paginator);
						html += compiledPrevNextTemplate({
							mail : data,
							mboxModel : mail.mboxModel,
							paginator : mail.paginator,
							prevMailHash : prevHash,
							nextMailHash : nextHash,
							i18n : i18n,
							popup : popup,
						});
					}
				} else {
					html = compiledEmptyTemplate({
						i18n : i18n,
					});
				}
				return html;
			},
			initialize : function(options) {
				// this.model == mail.mailModel
				this.region = options.region;
				this.listenTo(this.model, 'change', function() {
					if (this.region && this.region.$el) {
						if (!this.region.$el.is(':visible'))
							return;
					}
					this.render();
				});
				this.listenTo(mail.labelCollection, 'change', this.changeMailLabels);
			},
			onRender : function() {
				var mailId = this.model.get('M_IDX');
				if (mailId) {
					this.$el.removeClass('subMsg');
					this.$el.addClass('mc-coverWrap');
					this.$el.css('position', 'relative');
				} else {
					this.$el.removeClass('mc-coverWrap');
					this.$el.addClass('subMsg');
					this.$el.show();
				}
				var self = this;
				var $important = this.$el.find('#vtCont');
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (mail.mboxModel.get('SHARED_MBOX_ID') > 0) {
						return false;
					}
					var priority = self.model.get('M_PRIORITY');
					if (priority === 1) {
						self.model.save({
							M_PRIORITY : 3
						}, {
							patch : true,
							wait : true
						});
						this.className = 'icoImportantOff';
					} else {
						self.model.save({
							M_PRIORITY : 1
						}, {
							patch : true,
							wait : true
						});
						this.className = 'icoImportantOn';
					}
				});
				var $senderImportant = this.$el.find('.sender-important');
				$senderImportant.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (mail.mboxModel.get('SHARED_MBOX_ID') > 0) {
						return false;
					}
					var importantSender = self.model.get('importantSender');
					var url = _.result(self.model, 'urlRoot') + '/' + self.model.get('M_IDX') + '/sender-important';
					if (importantSender) {
						self.model.save({
							importantSender : false,
						}, {
							patch : true,
							wait : true,
							url : url,
						});
						this.className = 'icoImportantOff';
					} else {
						self.model.save({
							importantSender : true,
						}, {
							patch : true,
							wait : true,
							url : url,
						});
						this.className = 'icoImportantOn';
					}
				});
				var $addToContacts = this.$el.find('a.addAdrs');
				$addToContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var addrs = [];
					try {
						addrs = InternetAddress.parseHeader(self.model.get('M_SENDER'), false);
					} catch (error) {
						return;
					}
					var addressModel = new app.contact.AddressModel({});
					addressModel.urlRoot = 'contacts';
					addressModel.save({
						ADDRESS_NAME : addrs[0].getPersonal() || i18n.addContacts.anonymous,
						ADDRESS_EMAIL : addrs[0].getAddress(),
						ADDRESS_EMAIL_REP : 'Y',
						GROUP_IDX : 0,
					}, {
						wait : true,
						async : false,
					}).done(function() {
						alert(i18n.addContacts.successPhrase);
					});
				});
				var $blockAddress = this.$el.find('a.refuse');
				$blockAddress.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var filterModel = new mail.FilterModel({});
					filterModel.save({
						FILTER_AUTH : 3, // 3: 
						FILTER_TYPE : 1, // 1: 
						FILTER_KEYWORD : self.model.get('M_SENDER'),
					}, {
						wait : true,
						async : false,
					}).done(function() {
						alert(i18n.successBouncing);
					});
				});
				var $saveAttachmentToDrive = this.$el.find('a.btn_savendr');
				$saveAttachmentToDrive.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!app.domainDetailsModel.get('diskServiceEnabled')) {
						location.href = $(this).attr('href');
						return false;
					}
					var fragments = $(this).attr('href').split('/');
					var index = fragments[3].split('.');
					var attachment, attachments = self.model.get('attachments');
					if (index.length === 1) {
						attachment = attachments[index[0]];
					} else {
						attachments = self.model.get('mails')[index[0]].attachments;
						attachment = attachments[index[1]];
					}
					mail.attachmentToSave = attachment;
					var url = 'popup/disk/#folders?id=' + fragments[1] + '&index=' + fragments[3];
					if (isPopup())
						url = '../' + url;
					var win = window.open(url, 'diskFolders', 'width=448,height=464,resizable=no');
					win.focus();
					return false;
				});
				var $removeAttachment = this.$el.find('div.file_list a.btn_del');
				$removeAttachment.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (mail.mboxModel.get('SHARED_MBOX_ID')) {
						alert(i18n.cannotRemoveAttachmentFromSharedMail);
						return false;
					}
					if (self.model.get('M_GROUP')) {
						alert(i18n.cannotRemoveAttachmentFromGroupMail);
						return false;
					}
					if (!confirm(i18n.removeAttachment)) {
						return false;
					}
					var $this = $(this);
					var mailId = $this.data('mail-id');
					var attachmentIndex = $this.data('attachment-index');
					var model = new (app.BackboneModel.extend({
						urlRoot : function() {
							if (isPopup())
								return '../mails/' + mailId + '/attachments';
							else
								return 'mails/' + mailId + '/attachments';
						},
						defaults : {
							id : attachmentIndex
						}
					}))();
					mail.overlayView.showProcessing();
					model.destroy({
						success : function(model, response, options) {
							self.model.fetch();
							mail.paginator.pager();
							mail.overlayView.hideProcessing();
						},
						error : function(model, response, options) {
							mail.overlayView.hideProcessing();
						},
					});
					return false;
				});
				var $scrollTop = this.$el.find('.mc-toTop');
				$scrollTop.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $scrollableParents = $(this).parents().filter(function(index, element) {
						return $(this).css('overflow') == 'auto';
					});
					if ($scrollableParents.length == 0) {
						$(window).scrollTop(0);
					} else {
						$scrollableParents.first().scrollTop(0);
					}
					return false;
				});
				var $settingsSplit = this.$el.find('.empty-mail-settings-split');
				$settingsSplit.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					location.hash = '#settings/general/viewing';
				});
				var $settingsAfterDeleting = this.$el.find('.empty-mail-settings-after-deleting');
				$settingsAfterDeleting.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					location.hash = '#settings/general/viewing';
				});
				// Previous/Next Mail
				var $mailLinks = this.$el.find('.mc-subject a');
				$mailLinks.click(function(event) {
					var _mail = null;
					var mailId = $(this).data('mail-id');
					var prevMail = self.model.get('prevMail');
					var nextMail = self.model.get('nextMail');
					if (prevMail && prevMail.M_IDX == mailId)
						_mail = prevMail;
					else if (nextMail && nextMail.M_IDX == mailId)
						_mail = nextMail;
					if (!_mail) {
						return true;
					}
					switch (_mail.M_ISREAD) {
					case 'A': // IMAP  
					case 'R': // 
					case 'F': // 
					case 'O': // 
					case 'Y': // 
						return true;
					case 'P': //  
						_mail.M_ISREAD = 'O';
						break;
					case 'X': //  
					case 'N': //  
					default:
						_mail.M_ISREAD = 'Y';
						break;
					}
					if (mail.mboxModel.get('SHARED_MBOX_ID') == 0) {
						var mailModel = new mail.MailModel({
							M_IDX : _mail.M_IDX,
						});
						mailModel.save({
							M_ISREAD : _mail.M_ISREAD
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								var mboxCollection = mail.mboxCollection;
								if (isPopup() && !window.opener.closed) {
									var openerApp = window.opener.require('app');
									openerApp.mail.paginator.pager();
									mboxCollection = openerApp.mail.mboxCollection;
								}
								var mboxId = _mail.MBOX_IDX;
								var mboxModel = mboxCollection.findModel('MBOX_IDX', mboxId);
								if (mboxModel)
									mboxModel.fetch();
							},
						});
					} else {
						var mboxCollection = mail.mboxCollection;
						if (isPopup() && !window.opener.closed) {
							var openerApp = window.opener.require('app');
							openerApp.mail.paginator.pager();
							mboxCollection = openerApp.mail.mboxCollection;
						}
						var mboxId = _mail.MBOX_IDX;
						var mboxModel = mboxCollection.findModel('MBOX_IDX', mboxId);
						if (mboxModel)
							mboxModel.fetch();
					}
					return true;
				}); // $mailLinks.click(function(event) {...});
				if (app.config.secureMail.enabled && this.model.get('M_IDX')) {
					var secureMailCollection = new (mail.SecureMailCollection.extend({
						url : function() {
							if (isPopup())
								return '../secure-mails?mailId=' + self.model.get('M_IDX');
							else
								return 'secure-mails?mailId=' + self.model.get('M_IDX');
						}
					}))();
					secureMailCollection.fetch({
						success : function(collection, response, options) {
							if (!collection.length)
								return;
							mail.secureMailCollection.set(collection.models);
							self.secureMailInfoView = new mail.SecureMailInfoView({
								collection : collection,
								parentView : self,
							});
							var $container = self.$el.find('div.se_info:first');
							$container.html(self.secureMailInfoView.render().$el);
						},
						error : function(collection, response, options) {
							app.log('Failed to fetch SecureMailCollection: ' + _.result(collection, 'url'));
						},
					});
				}
				var $ipInfo = this.$el.find('span.info_ip');
				var $moreGeoIp = $ipInfo.find('a.more-geo-ip');
				$moreGeoIp.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.mailGeoIpTraceView) {
						self.mailGeoIpTraceView.close();
					}
					self.mailGeoIpTraceView = new mail.MailGeoIpTraceView({
						model : self.model,
					});
					var $mailGeoIpTraceView = self.mailGeoIpTraceView.render().$el;
					var $offsetParent = self.$el.offsetParent();
					$mailGeoIpTraceView.show().appendTo($offsetParent);
					$mailGeoIpTraceView.css({
						'top' : $ipInfo.position().top + 20,
						'right' : 29,
					});
				});
				var $tnef = this.$el.find('.mc-tnef');
				$tnef.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var tnefUrl = 'popup/#'+$(this).attr('href');
					if (isPopup()){
						tnefUrl = '#' + $(this).attr('href');
						location.href = tnefUrl;
						return false;
					}
					window.open(tnefUrl, '', 'scrollbars=yes,width=900,height=680');
					return false;
				});
				// Mail Labels
				this.changeMailLabels();
				var $aLinks = this.$el.find('div.mc-readFrame a[href]');
				var $areaLinks = this.$el.find('div.mc-readFrame area[href]');
				$aLinks.add($areaLinks).click(function(event) {
					event.stopPropagation();
					var href = $(this).attr('href');
					var blobUrl = location.origin + location.pathname + 'bigmail.file.do?cmd=download';
					if (href.indexOf(blobUrl) === 0)
						return true;
					var msg = i18n.goToUrl + 'URL : ' + href;
					if (!confirm(msg))
						return false;
				});
				var $viewingSettings = this.$el.find('a.viewing-settings');
				$viewingSettings.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = '#settings/general/viewing';
					if (isPopup()) {
						window.opener.location.hash = url;
						window.close();
					} else {
						location.hash = url;
					}
					return false;
				});
				this.$el.find('div.msg_caution a.more').click(function() {
					event.preventDefault() && event.stopPropagation();
					if (!self.maliciousForgeryHelpView) {
						self.maliciousForgeryHelpView = new mail.MaliciousForgeryHelpLayerView({});
						self.maliciousForgeryHelpView.render().$el.appendTo(self.$el.offsetParent());
					}
					self.maliciousForgeryHelpView.$el.attr('hidable', false);
					self.maliciousForgeryHelpView.$el.toggle();
				});
				var $mContent = this.$el.find('div.mc-viewFrame');
				if($mContent.length > 0){
					this.autoLink($mContent);
				}
			}, // onRender : function() {...}
			changeMailLabels : function() {
				var $mailLabelWrapper = this.$el.find('div.mc-viewTit h4 span.mail-labels');
				$mailLabelWrapper.empty();
				var mailLabels = [];
				var labels = this.model.get('labels');
				for (var i = 0; i < labels.length; i++) {
					var labelModel = mail.labelCollection.findModel('id', labels[i].labelId);
					if (!labelModel || !labelModel.get('visible'))
						continue;
					var $mailLabel = $('<a><span>' + _.escape(labelModel.get('name')) + '</span></a>');
					var href = '#labels/' + labelModel.get('id') + '/mails?'
					href += '_=' + (Date.now ? Date.now() : new Date().getTime());
					$mailLabel.attr('href', href);
					$mailLabel.addClass('lst_tag cc_' + labelModel.get('color'));
					mailLabels.push($mailLabel);
				}
				$mailLabelWrapper.append(mailLabels);
			},
			autoLink : function(obj) {
				var self = this;
				obj.each(function() {
					var queue = [];
					self.eachText(this, function(e) {
		                var html = self.makeHtml(e);
		                if (html != e.data) {
		                    queue.push([e, self.makeHtml(e)]);
		                }
		            });
		            $.each(queue, function(i, x) {
		                $(x[0]).replaceWith(x[1]);
		            });
				});
			},
			eachText : function(node, callback) {
				var self = this;
				$.each(node.childNodes, function() {
		            if (this.nodeType != 8 && this.nodeName != 'A') {
		                this.nodeType != 1 ? callback(this) : self.eachText(this, callback);
		            }
		        });
			},
			makeHtml : function(textNode) {
				var re = /(?:(?=(?:http|https):)([a-zA-Z][-+.a-zA-Z\d]*):(?:((?:[-_.!~*'()a-zA-Z\d;?:@&=+$,]|%[a-fA-F\d]{2})(?:[-_.!~*'()a-zA-Z\d;\/?:@&=+$,\[\]]|%[a-fA-F\d]{2})*)|(?:(?:\/\/(?:(?:(?:((?:[-_.!~*'()a-zA-Z\d;:&=+$,]|%[a-fA-F\d]{2})*)@)?(?:((?:(?:(?:[a-zA-Z\d](?:[-a-zA-Z\d]*[a-zA-Z\d])?)\.)*(?:[a-zA-Z](?:[-a-zA-Z\d]*[a-zA-Z\d])?)\.?|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[(?:(?:[a-fA-F\d]{1,4}:)*(?:[a-fA-F\d]{1,4}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:(?:[a-fA-F\d]{1,4}:)*[a-fA-F\d]{1,4})?::(?:(?:[a-fA-F\d]{1,4}:)*(?:[a-fA-F\d]{1,4}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}))?)\]))(?::(\d*))?))?|((?:[-_.!~*'()a-zA-Z\d$,;:@&=+]|%[a-fA-F\d]{2})+))|(?!\/\/))(\/(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*(?:;(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*)*(?:\/(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*(?:;(?:[-_.!~*'()a-zA-Z\d:@&=+$,]|%[a-fA-F\d]{2})*)*)*)?)(?:\?((?:[-_.!~*'()a-zA-Z\d;\/?:@&=+$,\[\]]|%[a-fA-F\d]{2})*))?)(?:\#((?:[-_.!~*'()a-zA-Z\d;\/?:@&=+$,\[\]]|%[a-fA-F\d]{2})*))?)/img;
				var source = textNode.data;
		        return source.replace(re, function() {
		            var url = arguments[0];
		            var a = $('<a></a>').attr({'href': url, 'target': '_blank'}).text(url);
		            return url.match(/^https?:\/\/$/) ? url : $('<div></div>').append(a).html();
		        });
			},
		}); // mail.MailView

		mail.SecureMailInfoView = Backbone.Marionette.ItemView.extend({
			tagName : 'table',
			template : function(data) {
				var html, compiledTemplate = mail.SecureMailInfoView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#secure-mail-info-template').html();
					compiledTemplate = _.template(html);
					mail.SecureMailInfoView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					items : data.items,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = mail.SecureMailCollection
				this.parentView = options.parentView; // mail.MailView
			},
			onRender : function() {
				var self = this;
				var $button = this.$el.find('button.button_s.ml5:first');
				var $readings = this.parentView.$el.find('div.ad_layer:first');
				var secureMailIds = [];
				this.collection.each(function(model) {
					secureMailIds.push(model.id);
				});
				var mailId = this.collection.at(0).get('mailId');
				var readingCollection = new (mail.SecureMailReadingCollection.extend({
					url : function() {
						if (isPopup())
							return '../secure-mail-readings?mailId=' + mailId;
						else
							return 'secure-mail-readings?mailId=' + mailId;
					}
				}))();
				readingCollection.fetch();
				var secureMailReadingsView = new mail.SecureMailReadingsView({
					collection : readingCollection,
				});
				$button.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($readings.is(':visible')) {
						$readings.hide();
						return false;
					}
					var position = $(this).position();
					$readings.css({
						position : 'absolute',
						top : position.top + $button.outerHeight(),
						left : position.left,
						width : 500,
					});
					$readings.html(secureMailReadingsView.render().$el.children());
					$readings.show();
					return false;
				});
				var $recall = this.$el.find('td.tar button');
				$recall.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var secureMailModel = self.collection.at(0);
					if (secureMailModel.get('recalled')) {
						alert(i18n.secureMail.alreadyRecalled);
						return false;
					}
					secureMailModel.save({
						recalled : 1,
						mailId : secureMailModel.get('mailId')
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							alert(i18n.secureMail.recallSuccessfully);
						},
						error : function(model, response, options) {
							alert(i18n.secureMail.recallFailed);
						}
					});
					return false;
				});
			},
		}); // mail.SecureMailInfoView

		mail.SecureMailReadingsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			template : function(data) {
				var html, compiledTemplate = mail.SecureMailReadingsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#secure-mail-readings-template').html();
					compiledTemplate = _.template(html);
					mail.SecureMailReadingsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					items : data.items,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = mail.SecureMailCollection
				this.parentView = options.parentView;
			},
			onRender : function() {
				var $close = this.$el.find('div.close_bt:first');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $container = $(this).parents('div.ad_layer:first');
					$container.hide();
					return false;
				});
			},
		}); // mail.SecureMailReadingsView

		mail.MailItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.MailItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-item-template').html();
					compiledTemplate = _.template(html);
					mail.MailItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mail : data,
					paginator : mail.paginator,
					mbox : mail.mboxModel.toJSON(),
					mboxCollection : mail.mboxCollection,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(mail.mailModel, 'change', this.toggleSelection);
				this.listenTo(app.vent, 'toggle:mail-item', this.toggleSelection);
				this.listenTo(app.vent, 'sync:secure-mails', this.changeSecureMailIcon);
				this.listenTo(mail.labelCollection, 'change', this.changeMailLabels);
			},
			onRender : function() {
				var self = this;
				this.$el.find('.mc-name a:first').on('contextmenu', function(event) {
					event.preventDefault();
					return false;
				});
				this.$list = this.$el.children('ul.mc-mInfo');
				this.$checkbox = this.$list.find('li.mc-check input:checkbox');
				this.$checkbox.change(function(event) {
					var $this = $(this);
					app.debug('MailItemView $checkbox.change(function(event) { checked:' + $this.is(':checked')
							+ ', val:' + $this.val() + ' });');
					event.stopPropagation();
					if ($this.is(':checked')) {
						self.$list.addClass('on');
					} else {
						self.$list.removeClass('on');
					}
				});
				this.toggleSelection();
				var M_ISREAD = this.model.get('M_ISREAD');
				switch (M_ISREAD) {
				case 'A': // IMAP  
				case 'R': // 
				case 'F': // 
				case 'O': // 
				case 'Y': // 
					this.$el.removeClass('mc-notRead');
					break;
				case 'P': //  
				case 'X': //  
				case 'N': //  
				default:
					this.$el.addClass('mc-notRead');
				}
				if (mail.mboxModel.get('SHARED_MBOX_ID') > 0) {
					this.$el.removeClass('mc-notRead');
				}
				var $sender = this.$el.find('.mc-name a:first');
				$sender.click(function(event) {
					if (mail.mboxModel.get('MBOX_TYPE') != 4 && mail.mboxModel.get('MBOX_IDX') != 'sent-me') {
						event.preventDefault() && event.stopPropagation();
						app.vent.trigger('contextmenu:mail', event, self.model);
						return false;
					}
				});
				var $mailLinks = this.$el.find('.mc-subject a').not('.icoPreviewMail');
				$mailLinks.click(function(event) {
					var $this = $(this);
					setTimeout(function() {
						if ($this.is('.icoNewWindow'))
							return;
						app.vent.trigger('toggle:mail-item');
					}, 100);
					switch (M_ISREAD) {
					case 'A': // IMAP  
					case 'R': // 
					case 'F': // 
					case 'O': // 
					case 'Y': // 
						break;
					case 'P': //  
						M_ISREAD = 'O';
						break;
					case 'X': //  
					case 'N': //  
					default:
						M_ISREAD = 'Y';
						break;
					}
					if (self.model.get('M_ISREAD') != M_ISREAD && mail.mboxModel.get('SHARED_MBOX_ID') == 0) {
						self.model.save({
							M_ISREAD : M_ISREAD
						}, {
							patch : true,
							wait : true,
							silent : true,
							success : function(model, response, options) {
								var mboxId = model.get('MBOX_IDX');
								var mboxModel = mail.mboxCollection.findModel('MBOX_IDX', mboxId);
								if (mboxModel) {
									mboxModel.fetch();
								}
								if (model.get('M_IDX') == mail.mailModel.get('M_IDX')
										&& model.get('M_ISREAD') != mail.mailModel.get('M_ISREAD')) {
									mail.mailModel.set('M_ISREAD', M_ISREAD);
								}
							},
						});
					}
					if (mail.mboxModel.get('MBOX_TYPE') != 4 && app.userModel.get('USERS_MAIL_VIEW') == 3
							&& app.userModel.get('USERS_MAIL_VIEW_MODE') == '0') {
						window.open('popup/' + $this.attr('href'), '', 'scrollbars=yes,width=900,height=680');
						return false;
					}
					if ($this.is('.icoNewWindow')) {
						window.open('popup/' + $this.attr('href'), '', 'scrollbars=yes,width=900,height=680');
						return false;
					}
					return true;
				});
				var $important = this.$el.find('.mc-important a');
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (mail.mboxModel.get('SHARED_MBOX_ID') > 0) {
						return false;
					}
					var priority = self.model.get('M_PRIORITY') == 1 ? 3 : 1;
					self.model.save({
						M_PRIORITY : priority,
					}, {
						patch : true,
						wait : true,
						silent : true,
						success : function(model, response, options) {
							var mboxId = self.model.get('MBOX_IDX');
							var mboxModel = mail.mboxCollection.findModel('MBOX_IDX', mboxId);
							if (mboxModel) {
								mboxModel.fetch();
							}
						},
					});
				});
				var $previewLink = this.$el.find('.icoPreviewMail');
				$previewLink.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.vent.trigger('display:preview', event, self.model);
				});
				this.$el.draggable({
					distance : 10,
					cursor : 'default',
					cursorAt : {
						top : -1,
						left : -1
					},
					appendTo : 'div.mc-wrap > div.mc-container',
					helper : function() {
						var color, backgroundPosition;
						switch (M_ISREAD) {
						case 'A': // IMAP  
						case 'R': // 
						case 'F': // 
						case 'O': // 
						case 'Y': // 
							color = '#525354';
							backgroundPosition = '0 -16px';
							break;
						case 'P': //  
						case 'X': //  
						case 'N': //  
						default:
							color = '#2454c5';
							backgroundPosition = '0 -1px';
							break;
						}
						var $helper = $("<div />", {
							css : {
								'line-height' : '18px',
								'background-color' : 'transparent',
								'padding' : '0 3px',
								'z-index' : '31',
								'color' : color,
							}
						}).append($('<span />', {
							css : {
								'display' : 'inline-block',
								'width' : '22px',
								'height' : '16px',
								'vertical-align' : 'middle',
								'background' : 'transparent url("img/ico_email.gif") no-repeat',
								'background-position' : backgroundPosition,
							},
							text : ' ',
						})).append($('<span />', {
							css : {
								'display' : 'inline-block',
								'width' : $sender.css('width'),
								'height' : '16px',
								'vertical-align' : 'middle',
								'overflow' : 'hidden',
								'text-overflow' : 'ellipsis',
								'white-space' : 'nowrap',
								'padding-left' : '10px',
							},
							text : ' ' + $sender.children('a').text()
						})).append(document.createTextNode(' ' + self.model.get('M_TITLE')));
						return $helper;
					},
					start : function(event, ui) {
						var $checkboxes = self.options.parentView.$checkboxes;
						var mailIds = [];
						$checkboxes.each(function(index, element) {
							if (this.checked)
								mailIds.push(parseInt(this.value));
						});
						if (mailIds.length == 0 || !_.contains(mailIds, self.model.get('M_IDX'))) {
							self.$checkbox.prop('checked', true).change();
							mailIds.push(self.model.get('M_IDX'));
						}
						$(this).data('mail-ids', mailIds);
					},
				});
				if (mail.mboxModel.get('SHARED_MBOX_ID'))
					this.$el.draggable('destroy');
				// Mail Labels
				this.changeMailLabels();
			},
			toggleSelection : function() {
				var split = app.userModel.get('USERS_MAIL_VIEW_MODE');
				if (split == '0')
					return;
				if (this.model.get('M_IDX') == mail.mailModel.get('M_IDX')) {
					this.$checkbox.prop('checked', true);
				} else {
					this.$checkbox.prop('checked', false);
				}
				this.$checkbox.change();
			},
			changeSecureMailIcon : function(secureMailCollection) {
				var secureMailModel = secureMailCollection.findModel('mailId', this.model.get('M_IDX'));
				if (!secureMailModel)
					return;
				var $icon = this.$el.find('li.mc-read:first').children('span');
				switch (this.model.get('M_ISREAD')) {
				case 'A': // IMAP  
				case 'R': // 
				case 'F': // 
				case 'O': // 
				case 'Y': // 
					$icon.attr('title', i18n.secureMail.read);
					$icon.removeClass().addClass('icoRead nosecu');
					break;
				case 'P': //  
				case 'X': //  
				case 'N': //  
				default:
					$icon.attr('title', i18n.secureMail.unread);
					$icon.removeClass().addClass('icoRead secu');
					break;
				}
			},
			changeMailLabels : function() {
				var $mailLabelWrapper = this.$el.find('div.mc-subject span.mail-labels');
				$mailLabelWrapper.empty();
				var mailLabels = [];
				var labels = this.model.get('labels');
				for (var i = 0; i < labels.length; i++) {
					var labelModel = mail.labelCollection.findModel('id', labels[i].labelId);
					if (!labelModel || !labelModel.get('visible'))
						continue;
					var $mailLabel = $('<a><sapn>' + _.escape(labelModel.get('name')) + '</sapn></a>');
					var href = '#labels/' + labelModel.get('id') + '/mails?'
					href += '_=' + (Date.now ? Date.now() : new Date().getTime());
					$mailLabel.attr('href', href);
					$mailLabel.addClass('lst_tag cc_' + labelModel.get('color'));
					mailLabels.push($mailLabel);
				}
				$mailLabelWrapper.append(mailLabels);
			},
		}); // mail.MailItemView

		mail.ContextMenuView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'mail-contextmenu',
			className : 'layer_bd layer_mouseright',
			attributes : {
				style : 'display: none; z-index: 2015; width: 200px',
			},
			template : function(data) {
				var html, compiledTemplate = mail.ContextMenuView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-context-menu-template').html();
					compiledTemplate = _.template(html);
					mail.ContextMenuView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.mailModel
				this.listenTo(app.vent, 'contextmenu:mail', this.showContextMenu);
			},
			onRender : function() {
				var self = this;
				var $contextMenu = $('body > #mail-contextmenu');
				if ($contextMenu.length)
					$contextMenu.remove();
				$contextMenu = this.$el.appendTo('body');
				$contextMenu.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$contextMenu.attr('hidable', true);
				$contextMenu.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($contextMenu.outerHeight() > (viewportY - event.pageY)) {
					$contextMenu.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$contextMenu.css('top', event.pageY + 'px');
				}
				if ($contextMenu.outerWidth() > (viewportX - event.pageX)) {
					$contextMenu.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$contextMenu.css('left', event.pageX + 'px');
				}
				var to = self.model.get('M_SENDER');
				var mboxType = mail.mboxModel.get('MBOX_TYPE');
				if (mboxType == 2 || mboxType == 4) {
					to = self.model.get('M_TO');
				}
				var addrs = [];
				try {
					addrs = InternetAddress.parseHeader(to, false);
				} catch (error) {
					return;
				}
				var $composeMail = this.$el.find('.compose-mail');
				$composeMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var hash = '#compose?' + $.param({
						to : to,
					}, true);
					if (app.userModel.get('COMPOSE_NEW_WINDOW')) {
						var win = window.open('popup/' + hash, '', 'scrollbars=yes,width=1000,height=800');
						win.focus();
					} else {
						location.hash = hash;
					}
					self.$el.hide();
				});
				var $searchFrom = this.$el.find('.search-from');
				$searchFrom.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var encSender = encodeURIComponent(addrs[0].getAddress());
					location.hash = 'mboxes/all/mails?search.from=' + encSender;
					self.$el.hide();
				});
				var $searchTo = this.$el.find('.search-to');
				$searchTo.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var encTo = encodeURIComponent(addrs[0].getAddress());
					location.hash = 'mboxes/all/mails?search.to=' + encTo;
					self.$el.hide();
				});
				var $searchFromTo = this.$el.find('.search-from-to');
				$searchFromTo.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var encAddress = encodeURIComponent(addrs[0].getAddress());
					location.hash = 'mboxes/all/mails?search=' + encAddress;
					self.$el.hide();
				});
				var $showAsConveration = this.$el.find('li.show-as-converation');
				$showAsConveration.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var encSender = encodeURIComponent(to);
					var url = 'popup/#converation/mails?perPage=10&search.converation=' + encSender;
					var win = window.open(url, '', 'scrollbars=yes,width=900,height=680');
					win.focus();
					self.$el.hide();
					return false;
				});
				var $senderImportant = this.$el.find('.add-sender-important');
				$senderImportant.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var addressCollection = new app.contact.AddressCollection();
					addressCollection.fetch({
						success : function(collection, response, options) {
							var addressModel = collection.find(function(model) {
								if (model.get('ADDRESS_NAME') == addrs[0].getPersonal()
										&& model.get('ADDRESS_EMAIL') == addrs[0].getAddress()) {
									return true;
								}
							});
							var attrs = {
								ADDRESS_IMPORTANT : 'Y',
							};
							var syncOptions = {
								wait : true,
								success : function(model, response, options) {
									alert(i18n.contextMenuActions.successSenderImportant);
									self.$el.hide();
								},
								error : function(model, response, options) {
									self.$el.hide();
								}
							};
							if (addressModel) {
								syncOptions.patch = true;
							} else {
								addressModel = new app.contact.AddressModel();
								attrs.ADDRESS_EMAIL = addrs[0].getAddress();
								attrs.ADDRESS_NAME = addrs[0].getPersonal();
								attrs.ADDRESS_EMAIL_REP = 'Y';
							}
							addressModel.save(attrs, syncOptions);
						}
					});
				});
				var $addContact = this.$el.find('.add-to-contact');
				$addContact.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var addressModel = new app.contact.AddressModel({});
					addressModel.save({
						ADDRESS_NAME : addrs[0].getPersonal() || i18n.addContacts.anonymous,
						ADDRESS_EMAIL : addrs[0].getAddress(),
						ADDRESS_EMAIL_REP : 'Y',
						GROUP_IDX : 0,
					}, {
						wait : true,
						success : function(model, response, options) {
							alert(i18n.contextMenuActions.successAddedContact);
							self.$el.hide();
						},
						error : function(model, response, options) {
							self.$el.hide();
						}
					});
				});
				var $blockFrom = this.$el.find('.block-from');
				$blockFrom.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.contextMenuActions.confirmBlockList)) {
						var filterModel = new mail.FilterModel({});
						filterModel.save({
							FILTER_AUTH : 3, // 3: 
							FILTER_TYPE : 1, // 1: 
							FILTER_KEYWORD : self.model.get('M_SENDER'),
						}, {
							wait : true,
							success : function(model, response, options) {
								self.moveToSpam();
								alert(i18n.contextMenuActions.successBlockList);
								self.$el.hide();
							},
							error : function(model, response, options) {
								self.$el.hide();
							}
						});
					}
				});
				var $deleteFromTo = this.$el.find('.delete-from-to');
				$deleteFromTo.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (confirm(i18n.contextMenuActions.confirmDeleteFromTo)) {
						mail.overlayView.showProcessing();
						var trashMboxModel = mail.mboxCollection.findModel('MBOX_TYPE', '3');
						var model = new (app.BackboneModel.extend({
							urlRoot : 'mboxes/' + mail.mboxModel.get('MBOX_IDX'),
							defaults : {
								id : 'mails'
							}
						}))();
						var jqXHR = model.save({
							trashMboxId : trashMboxModel.get('MBOX_IDX'),
							sender : addrs[0].getAddress(),
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								// deferred success callback to jqXHR.done()
							},
							error : function(model, response, options) {
								// deferred error callback to jqXHR.fail()
							},
						});
						jqXHR.done(function(data, textStatus, jqXHR) {
							mail.overlayView.hideProcessing();
							var paginator = mail.paginator;
							var info = paginator.info();
							if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
								var args = {
									page : info.currentPage - 1
								};
								location.hash = '#' + paginator.getURL(args);
								mail.mboxCollection.fetch();
								return;
							}
							paginator.pager();
							mail.mboxCollection.fetch();
						}).fail(function(jqXHR, textStatus, errorThrown) {
							alert('Failed to move mails.');
						});
					}
				});
			},
			moveToSpam : function() {
				var mboxModel = mail.mboxCollection.findModel('MBOX_TYPE', '5');
				this.model.save({
					MBOX_IDX : mboxModel.get('MBOX_IDX'),
				}, {
					patch : true,
					wait : true,
					success : function() {
						var paginator = mail.paginator;
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
							mail.mboxCollection.fetch();
							return;
						}
						paginator.pager();
						mail.mboxCollection.fetch();
					}
				});
			},
			showContextMenu : function(mouseEvent, mailModel) {
				this.mouseEvent = mouseEvent;
				this.model = mailModel;
				this.render().$el.show();
			}
		}); // mail.ContextMenuView

		mail.MailSimplePreview = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.MailSimplePreview.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-simple-preview-template').html();
					compiledTemplate = _.template(html);
					mail.MailSimplePreview.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mail : data,
					mbox : mail.mboxModel.toJSON(),
					mboxCollection : mail.mboxCollection,
					paginator : mail.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.parentView = options.parentView;
				this.mboxCollection = options.mboxCollection;
			},
			onRender : function() {
				var self = this;
				var $deleteBtn = this.$el.find('button#deleteBtn');
				var $closeBtn = this.$el.find('button#closeBtn');
				var $reportBtn = this.$el.find('button#reportBtn');

				$closeBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.parentView.closeSimplePreview();
				});

				$deleteBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var MBOX_TYPE = mail.mboxModel.get('MBOX_TYPE');
					var USERS_DELBOX = self.model.get('USERS_DELBOX');
					if (confirm(i18n.deleteThisMail)) {
						if (MBOX_TYPE == 3 || MBOX_TYPE == 5 || USERS_DELBOX == 'N') {
							self.model.destroy({
								wait : true,
								success : (function() {
									self.parentView.closeSimplePreview();
									self.collection.fetch();
									self.mboxCollection.fetch();
								}),
							});
						} else {
							var trashMboxModel = self.mboxCollection.find(function(model) {
								return model.get('MBOX_TYPE') == 3;
							});
							self.model.save({
								MBOX_IDX : trashMboxModel.get('MBOX_IDX'),
							}, {
								patch : true,
								wait : true,
								success : (function() {
									self.parentView.closeSimplePreview();
									self.collection.fetch();
									self.mboxCollection.fetch();
								}),
							});
						}
					}
				});

				$reportBtn.click(function(event) {
					var reportView = new mail.MailSimpleReport({
						model : self.model,
						mboxCollection : mail.mboxCollection,
						parentView : self,
					});
					reportView.render();
					self.$el.html(reportView.el);
				});

			},
		}); // mail.MailSimplePreview

		mail.MailSimpleReport = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.MailSimpleReport.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#report-spam-template').html();
					compiledTemplate = _.template(html);
					mail.MailSimpleReport.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.mboxCollection = options.mboxCollection;
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				var $reportType = this.$el.find('ul li input[name="join_line"]');
				var $reportHackPanel = this.$el.find('div.hack_write');
				var $textArea = this.$el.find('.report-spam-description');
				var $report = this.$el.find('button.report-spam');
				var $cancel = this.$el.find('button.report-spam-cancel');
				$reportType.change(function() {
					if ($(this).hasClass('report-spam-hacking-mail')) {
						$reportHackPanel.show();
					} else {
						$reportHackPanel.hide();
					}
				});
				$textArea.placeholder();
				$report.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $spamProcess = self.$el.find('ul li input[name="spam_handle"]:checked');
					var $filter = self.$el.find('ul li input[name="spam_filter"]');
					var reportDescription = '';
					if ($reportHackPanel.is(':visible')) {
						reportDescription = $textArea.val();
					}
					var reportModel = new mail.MailReportModel({});
					var sender;
					try {
						sender = InternetAddress.parseHeader(self.model.get('M_SENDER'), false);
					} catch (error) {
						return '';
					}
					reportModel.save({
						M_IDX : self.model.get('M_IDX'),
						M_TITLE : self.model.get('M_TITLE'),
						MAIL_REPORT_SENDDATE : self.model.get('M_TIME'),
						MAIL_REPORT_FROM : sender[0].getAddress(),
						MAIL_REPORT_STMT : reportDescription,
					}, {
						wait : true,
						async : false,
					});

					//    (, )
					var mboxModel = self.mboxCollection.findModel('MBOX_TYPE', '5');
					var MBOX_IDX = mboxModel.get('MBOX_IDX');
					if ($spamProcess.val() == 'move') {
						self.model.save({
							MBOX_IDX : MBOX_IDX
						}, {
							patch : true,
							wait : true,
							async : false,
						});
					} else if ($spamProcess.val() == 'del') {
						self.model.destroy({
							wait : true,
							async : false,
						});
					}

					//    
					if ($filter.is(':checked')) {
						var filterModel = new mail.FilterModel({});
						filterModel.save({
							FILTER_AUTH : 3, // 3: 
							FILTER_TYPE : 1, // 1: 
							FILTER_KEYWORD : self.model.get('M_SENDER'),
						}, {
							wait : true,
							async : false,
						});
					}

					self.parentView.parentView.closeSimplePreview();
					alert(i18n.successReportSpam);
					var now = new Date().getTime();
					var url = '#' + mail.paginator.getURL({}) + '&_=' + now;
					location.hash = url;
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.parentView.parentView.closeSimplePreview();
				});
			},
		}); // mail.MailSimplePreview

		mail.MailListEmptyView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.MailListEmptyView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-empty-item-template').html();
					compiledTemplate = _.template(html);
					mail.MailListEmptyView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
		});

		mail.MailListView = Backbone.Marionette.CompositeView.extend({
			// parentEl : '#divList',
			itemView : mail.MailItemView,
			itemViewContainer : '.mc-listWrap .mc-mailList',
			emptyView : mail.MailListEmptyView,
			template : function(data) {
				var html, compiledTemplate = mail.MailListView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-list-template').html();
					compiledTemplate = _.template(html);
					mail.MailListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					paginator : mail.paginator,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.MailPaginator
				this.mboxCollection = options.mboxCollection;
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'paginate:mails', this.paginateMails);
				this.listenTo(app.vent, 'paginate:labelMails', this.paginateLabelMails);
				this.listenTo(app.vent, 'display:preview', this.showSimplePreview);
			},
			itemViewOptions : function(model, index) {
				return {
					parentView : this
				};
			},
			onRender : function() {
				var self = this;
				if (this.mailContextMenuView)
					this.mailContextMenuView.close();
				this.mailContextMenuView = new mail.ContextMenuView();
				var $columnList = this.$el.find('ul.mc-mailListItem:first');
				var $itemList = this.$itemViewContainer;
				var $toggle = $columnList.find('.mc-check .mCheck');
				var $checkboxes = this.$checkboxes = $itemList.find('.mc-check .mCheck');
				$toggle.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
					$checkboxes.change();
				});
				var shiftKey;
				this.$el.off('keydown').on('keydown', function(event) {
					shiftKey = event.shiftKey;
					return true;
				});
				this.$el.off('keyup').on('keyup', function(event) {
					shiftKey = event.shiftKey;
					return true;
				});
				var lastChecked;
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length)
							$toggle.prop('checked', true);
						if (!shiftKey)
							lastChecked = this;
					} else {
						$toggle.removeAttr('checked');
					}
					if (shiftKey && this.checked) {
						var checked = this, beginIndex = null, endIndex = null;
						$checkboxes.each(function(index, element) {
							if (!this.checked)
								return;
							if (this === checked || this === lastChecked) {
								if (beginIndex === null)
									beginIndex = index;
								else
									endIndex = index;
							}
						});
						if (beginIndex !== null && endIndex !== null) {
							$checkboxes.each(function(index, element) {
								if (this.checked)
									return;
								if (beginIndex < index && index < endIndex)
									$(this).prop('checked', true).change();
							});
						}
						lastChecked = this;
					}
				});
				var $important = $columnList.find('.mc-important .icoImportantOn');
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var now = Date.now ? Date.now() : new Date().getTime();
					var url = '#mboxes/' + self.model.get('MBOX_IDX');
					if (self.collection.labelId)
						url = '#labels/' + self.collection.labelId;
					url += '/mails?flag=important&_=' + now;
					location.hash = url;
				});
				var $unseen = $columnList.find('.mc-read .icoReadNot');
				$unseen.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var now = Date.now ? Date.now() : new Date().getTime();
					var url = '#mboxes/' + self.model.get('MBOX_IDX');
					if (self.collection.labelId)
						url = '#labels/' + self.collection.labelId;
					url += '/mails?flag=unseen&_=' + now;
					location.hash = url;
				});
				var $attached = $columnList.find('.mc-file .icoFile');
				$attached.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var now = Date.now ? Date.now() : new Date().getTime();
					var url = '#mboxes/' + self.model.get('MBOX_IDX');
					if (self.collection.labelId)
						url = '#labels/' + self.collection.labelId;
					url += '/mails?flag=attached&_=' + now;
					location.hash = url;
				});
				// Dimensions
				var $fromColumn = $columnList.children('li.mc-from:first');
				var $subjectColumn = $columnList.children('li.mc-title:first');
				var $dateColumn = $columnList.children('li.mc-date:first');
				var $sizeColumn = $columnList.children('li.mc-size:first');
				var $fromSubjectItemsWrapper = $itemList.find('li > .mc-mTitle');
				var $fromItems = $fromSubjectItemsWrapper.children('.mc-name');
				var $subjectItems = $fromSubjectItemsWrapper.children('.mc-subject');
				var $dateItems = $itemList.find('li > .mc-mInfo > .mc-date');
				var $sizeItems = $itemList.find('li > .mc-mInfo > .mc-size');
				var fromSubjectWrapperPaddingLeft, fromItemsWidth;
				function initFromColumn() {
					fromSubjectWrapperPaddingLeft = self.fromSubjectWrapperPaddingLeft;
					fromItemsWidth = self.fromItemsWidth;
					if (fromSubjectWrapperPaddingLeft) {
						$fromSubjectItemsWrapper.css('padding-left', fromSubjectWrapperPaddingLeft);
						$fromItems.width(fromItemsWidth);
					} else {
						fromColumnWidth = $fromColumn.width();
						var paddingLeft = $fromSubjectItemsWrapper.css('padding-left');
						if (paddingLeft && /^-?[0-9]+px$/.test(paddingLeft))
							paddingLeft = parseInt(paddingLeft.substring(0, paddingLeft.length - 2));
						fromSubjectWrapperPaddingLeft = paddingLeft;
						fromItemsWidth = $fromItems.width();
					}
				}
				var subjectColumnLeft, subjectItemsWidth;
				function initSubjectColumn() {
					subjectColumnLeft = self.subjectColumnLeft;
					subjectItemsWidth = self.subjectItemsWidth;
					if (subjectColumnLeft) {
						$subjectColumn.css('left', subjectColumnLeft);
						$subjectItems.width(subjectItemsWidth);
					} else {
						$subjectColumn.css('left', 0);
						subjectColumnLeft = 0;
						subjectItemsWidth = $subjectItems.width();
					}
				}
				var dateColumnWidth, dateItemsWidth;
				function initDateColumn() {
					dateColumnWidth = self.dateColumnWidth;
					dateItemsWidth = self.dateItemsWidth;
					if (dateColumnWidth) {
						$dateColumn.width(dateColumnWidth);
						$dateItems.width(dateItemsWidth);
					} else {
						dateColumnWidth = $dateColumn.width();
						dateItemsWidth = $dateItems.width();
					}
				}
				var sizeColumnWidth, sizeItemsWidth;
				function initSizeColumn() {
					sizeColumnWidth = self.sizeColumnWidth;
					sizeItemsWidth = self.sizeItemsWidth;
					if (sizeColumnWidth) {
						$sizeColumn.width(sizeColumnWidth);
						$sizeItems.width(sizeItemsWidth);
					} else {
						sizeColumnWidth = $sizeColumn.width();
						sizeItemsWidth = $sizeItems.width();
					}
				}
				initFromColumn();
				initSubjectColumn();
				initDateColumn();
				initSizeColumn();
				$subjectColumn.css('position', 'relative');
				$subjectColumn.resizable({
					handles : 'w',
					resize : function(event, ui) {
						var left = ui.position.left;
						if (left < -80) {
							left = -80;
							$subjectColumn.css('left', left);
						} else if (left > 600) {
							left = 600;
							$subjectColumn.css('left', left);
						}
						var diff = left - subjectColumnLeft;
						self.subjectColumnLeft = left;
						self.fromSubjectWrapperPaddingLeft = fromSubjectWrapperPaddingLeft + diff;
						self.fromItemsWidth = fromItemsWidth + diff;
						$fromSubjectItemsWrapper.css('padding-left', self.fromSubjectWrapperPaddingLeft);
						$fromItems.width(self.fromItemsWidth);
						$subjectItems.width(self.subjectItemsWidth);
						var gap = subjectItemsWidth - $subjectItems.width();
						self.subjectItemsWidth = $subjectItems.width() - (diff - gap);
						$subjectItems.width(self.subjectItemsWidth);
					},
				}).on('resize', function(event) {
					event.stopPropagation();
				});
				$dateColumn.resizable({
					handles : 'w',
					maxWidth : 200,
					minWidth : 80,
					resize : function(event, ui) {
						$dateColumn.css('left', 'auto');
						var diff = ui.size.width - dateColumnWidth;
						self.dateColumnWidth = ui.size.width;
						self.dateItemsWidth = dateItemsWidth + diff;
						$dateItems.width(self.dateItemsWidth);
						var gap = subjectItemsWidth - $subjectItems.width();
						self.subjectItemsWidth = $subjectItems.width() - (diff - gap);
						$subjectItems.width(self.subjectItemsWidth);
					},
				}).on('resize', function(event) {
					event.stopPropagation();
				});
				$dateItems.css({
					'width' : '150px',
					'overflow' : 'hidden',
					'text-overflow' : 'ellipsis'
				});
				$sizeColumn.resizable({
					handles : 'w',
					maxWidth : 100,
					minWidth : 72,
					resize : function(event, ui) {
						$sizeColumn.css('left', 'auto');
						var diff = ui.size.width - sizeColumnWidth;
						self.sizeColumnWidth = ui.size.width;
						self.sizeItemsWidth = sizeItemsWidth + diff;
						$sizeItems.width(self.sizeItemsWidth);
					},
				}).on('resize', function(event) {
					event.stopPropagation();
				});
				$(window).off('resize.columns').on('resize.columns', function(event) {
					$subjectColumn.removeAttr('style').css('position', 'relative');
					$fromSubjectItemsWrapper.removeAttr('style');
					$fromItems.removeAttr('style');
					$subjectItems.removeAttr('style');
					$dateColumn.removeAttr('style');
					$dateItems.removeAttr('style').css({
						'width' : '150px',
						'overflow' : 'hidden',
						'text-overflow' : 'ellipsis'
					});
					$sizeColumn.removeAttr('style');
					$sizeItems.removeAttr('style');
					self.fromSubjectWrapperPaddingLeft = 0;
					self.fromItemsWidth = 0;
					self.subjectColumnLeft = self.subjectItemsWidth = 0;
					self.dateColumnWidth = self.dateItemsWidth = 0;
					self.sizeColumnWidth = self.sizeItemsWidth = 0;
					initFromColumn();
					initSubjectColumn();
					initDateColumn();
					initSizeColumn();
				});
				// Pagination
				var $pagination = this.$el.find('.mc-paginate');
				var paginationView = new mail.PaginationView({
					collection : this.collection
				});
				$pagination.append(paginationView.render().$el.children());
				// MailListGroupByDay
				var sortFiled = this.collection.params && this.collection.params.sortField;
				sortFiled = sortFiled ? this.collection.params.sortField : 'M_TIME';
				if (app.userModel.get('LIST_GROUP_BY_DATE') && sortFiled == 'M_TIME') {
					this.parentView.listRegion.$el.addClass('grp_day');
					this.showMailListGroupByDate();
				} else {
					this.parentView.listRegion.$el.removeClass('grp_day');
				}
				// Popup Notice
				var popupCollection = new mail.PopupCollection();
				popupCollection.fetch({
					url : _.result(popupCollection, 'url') + '/notice',
					async : false,
				});
				popupCollection.each(function(popupModel) {
					var popupNoticeView = new mail.PopupNoticeView({
						model : popupModel,
					});
					var popupId = popupModel.get('POPUP_IDX');
					if (popupNoticeView.getCookie('loginPopup-' + popupId, 'popupId-' + popupId))
						popupNoticeView.remove();
					else
						self.$itemViewContainer.prepend(popupNoticeView.render().el);
				});
			},
			showMailListGroupByDate : function() {
				var self = this;
				var now = (function(timeZone) {
					var date = new Date();
					if (!timeZone || !/^Z|[+-](?:2[0-3]|[0-1][0-9]):[0-5][0-9]$/.test(timeZone))
						return date;
					var offset = 0;
					if (timeZone !== 'Z') {
						var sign = timeZone.charAt(0);
						var hours = timeZone.substring(1, 3);
						var minutes = timeZone.substring(4, 6);
						offset = parseInt(hours, 10) * 60 + parseInt(minutes, 10);
						offset = sign == '+' ? -(offset) : offset;
					}
					var diff = date.getTimezoneOffset() - offset;
					var time = date.getTime() + diff * 60000;
					date.setTime(time);
					return date;
				})(app.userModel.get('USERS_TIMEZONE'));
				var dateType = {
					today : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth(), now.getDate()),
					},
					yesterday : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1),
					},
					thisWeek : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay()),
					},
					lastWeek : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() - 7),
					},
					twoWeeksAgo : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() - 14),
					},
					threeWeeksAgo : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() - 21),
					},
					lastMonth : {
						flag : false,
						time : new Date(now.getFullYear(), now.getMonth() - 1, now.getDate()),
					},
					delayDelivery : {
						flag : false,
					},
					old : {
						flag : false,
					},
				};
				var $mailList = this.$itemViewContainer.find('> li').not('mc-infor_day');
				$mailList.each(function() {
					var $this = $(this);
					var $checkbox = $this.find('.mc-check .mCheck');
					if (!$checkbox.length) {
						return false;
					}
					var mailId = $checkbox.val();
					var mailModel = self.collection.find(function(model) {
						return model.get('M_IDX') == mailId;
					});
					var mTime = $.format.parseDate(mailModel.get('M_TIME')).date;
					var type;
					if (mTime.getTime() == dateType.today.time.getTime()) {
						type = 'today';
					} else if (mTime.getTime() == dateType.yesterday.time.getTime()) {
						type = 'yesterday';
					} else if (mTime.getTime() >= dateType.thisWeek.time.getTime()
							&& mTime.getTime() < dateType.yesterday.time.getTime()) {
						type = 'thisWeek';
					} else if (mTime.getTime() >= dateType.lastWeek.time.getTime()
							&& mTime.getTime() < dateType.thisWeek.time.getTime()) {
						type = 'lastWeek';
					} else if (mTime.getTime() >= dateType.twoWeeksAgo.time.getTime()
							&& mTime.getTime() < dateType.lastWeek.time.getTime()) {
						type = 'twoWeeksAgo';
					} else if (mTime.getTime() >= dateType.threeWeeksAgo.time.getTime()
							&& mTime.getTime() < dateType.twoWeeksAgo.time.getTime()) {
						type = 'threeWeeksAgo';
					} else if (mTime.getTime() >= dateType.lastMonth.time.getTime()
							&& mTime.getTime() < dateType.threeWeeksAgo.time.getTime()) {
						type = 'lastMonth';
					} else if (mTime.getTime() > dateType.today.time.getTime()) {
						type = 'delayDelivery';
					} else {
						type = 'old';
					}
					if (!dateType[type].flag) {
						var mailListGroupByDateView = new mail.MailListGroupByDateView({
							model : new Backbone.Model({
								type : type,
								time : dateType[type].time,
								mailModel : mailModel,
							}),
							parentView : self,
						});
						$this.before(mailListGroupByDateView.render().el);
						dateType[type].flag = true;
					}
				});
			},
			paginateMails : function(mboxModel, params) {
				if (mboxModel) {
					this.model = mboxModel;
				}
				mail.overlayView.showLoading();
				if (!params)
					params = {};
				if (this.collection.labelId)
					delete this.collection.labelId;
				this.collection.setParameters(params);
				this.collection.pager({
					type : 'POST',
					success : function(collection, response, options) {
						mail.overlayView.hideLoading();
						var mailId = mail.mailModel.get('M_IDX');
						var mailModel = collection.find(function(model) {
							return model.get('M_IDX') == mailId;
						});
						if (!mailModel) {
							var split = app.userModel.get('USERS_MAIL_VIEW_MODE');
							var showFirstMail = app.userModel.get('SHOW_FIRST_MAIL');
							if (split != '0' && showFirstMail && collection.models[0]) {
								var mailIdx = collection.models[0].get('M_IDX');
								var mboxIdx = mboxModel.get('MBOX_IDX');
								var parameters = collection.getParameters();
								if (typeof mboxModel.get('MBOX_IDX') == "string") {
									parameters += '&specialUseMailbox=' + mboxIdx;
								}
								location.hash = '#mboxes/' + mboxIdx + '/mails/' + mailIdx + parameters;
							} else {
								mail.mailModel.set('M_IDX', 0);
							}
						}
						if (app.config.secureMail.enabled) {
							if (mboxModel && mboxModel.get('MBOX_TYPE') == 2) {
								mail.secureMailCollection.fetch({
									success : function(collection, response, options) {
										app.vent.trigger('sync:secure-mails', collection);
									},
									error : function(collection, response, options) {
										app.log('Failed to fetch SecureMailCollection');
									}
								});
							}
						}
					},
					error : function(collection, response, options) {
						mail.overlayView.hideLoading();
						switch (response.status) {
						case 401:
							app.vent.trigger('confirm:mbox-password', mboxModel, function() {
								var parameters = collection.getParameters();
								location.hash = '#mboxes/' + mboxModel.id + '/mails' + parameters;
							});
							break;
						default:
							alert(i18n.failedToListMails);
							break;
						}
					},
				});
			},
			paginateLabelMails : function(labelModel, params) {
				mail.overlayView.showLoading();
				if (!params)
					params = {};
				this.collection.labelId = labelModel.get('id');
				this.collection.setParameters(params);
				this.collection.pager({
					type : 'POST',
					success : function(collection, response, options) {
						mail.overlayView.hideLoading();
						var mailId = mail.mailModel.get('M_IDX');
						var mailModel = collection.find(function(model) {
							return model.get('M_IDX') == mailId;
						});
						if (!mailModel) {
							var split = app.userModel.get('USERS_MAIL_VIEW_MODE');
							var showFirstMail = app.userModel.get('SHOW_FIRST_MAIL');
							if (split != 0 && showFirstMail && collection.models[0]) {
								var mailIdx = collection.models[0].get('M_IDX');
								var labeId = labelModel.get('id');
								var parameters = collection.getParameters();
								location.hash = '#labels/' + labeId + '/mails/' + mailIdx + parameters;
							} else {
								mail.mailModel.set('M_IDX', 0);
							}
						}
					},
					error : function(collection, response, options) {
						mail.overlayView.hideLoading();
						alert(i18n.failedToListMails);
					},
				});
			},
			showSimplePreview : function(event, mailModel) {
				if (!mailModel)
					return;

				var $previewLayer = this.$el.find('div#previewMailLayer');
				if ($previewLayer.length == 0) {
					$previewLayer = $('body div#previewMailLayer');
				} else {
					$previewLayer.appendTo('body');
				}

				var previewPopup = new mail.MailSimplePreview({
					parentView : this,
					model : mailModel,
					collection : this.collection,
					mboxCollection : this.mboxCollection,
				});
				previewPopup.render();
				$previewLayer.empty().html(previewPopup.el);
				$previewLayer.show();

				var top = event.pageY;
				var left = event.pageX;

				$previewLayer.css({
					top : top,
					left : left,
				});
				if (this.curPositionTop != top) {
					$previewLayer.show();
				} else {
					$previewLayer.toggle();
				}
				this.curPositionTop = top;
				$previewLayer.attr('hidable', false);
				$previewLayer.click(function(event) {
					event.stopPropagation();
				});
			},
			closeSimplePreview : function(event) {
				$previewLayer = $('body div#previewMailLayer');
				$previewLayer.hide();
			},
		}); // mail.MailListView

		mail.MailListGroupByDateView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			className : 'mc-infor_day',
			template : function(data) {
				var html, compiledTemplate = mail.MailListGroupByDateView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-list-group-by-date-template').html();
					compiledTemplate = _.template(html);
					mail.MailListGroupByDateView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					data : data,
				});
				return html;
			},
			initialize : function(options) {
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mailEl = self.$el.next('li');
					var nextEl = mailEl.next('li');
					while (nextEl.html() && !nextEl.hasClass('mc-infor_day')) {
						mailEl = mailEl.add(nextEl);
						nextEl = nextEl.next('li');
					}
					var $fold = self.$el.find('span.day_view em:first');
					if ($fold.hasClass('ic_fold')) {
						$fold.removeClass().addClass('ic_unfold');
						mailEl.hide();
					} else {
						$fold.removeClass().addClass('ic_fold');
						mailEl.show();
					}
					return false;
				});
			},
		});

		mail.DeliveryStatusInfoView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_b',
			template : function(data) {
				var html, compiledTemplate = mail.DeliveryStatusInfoView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#delivery-status-info-template').html();
					compiledTemplate = _.template(html);
					mail.DeliveryStatusInfoView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
			},
		}); // mail.DeliveryStatusInfoView

		mail.DeliveryStatusItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			className : 'delivery-status-list',
			template : function(data) {
				var html, compiledTemplate = mail.DeliveryStatusItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#delivery-status-item-template').html();
					compiledTemplate = _.template(html);
					mail.DeliveryStatusItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					deliveryStatus : data,
					paginator : mail.deliveryStatusPaginator,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $cancelDelivery = this.$el.find('.cancelDeliveryStatus');
				$cancelDelivery.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var isSubList = $this.data('is-sub-list');
					if (isSubList) {
						if (confirm(i18n.cancelGroupDeliveryStatus)) {
							self.model.save({
								MAIL_RECONF_STATE : 4,
							}, {
								patch : true,
								async : false,
								wait : true,
								url : 'delivery-status/groups/' + self.model.get('MAIL_RECONF_GROUP'),
							});
						}
					} else {
						var msg = self.model.get('MAIL_RECONF_TO') + i18n.cancelDeliveryStatus;
						if (confirm(msg)) {
							self.model.save({
								MAIL_RECONF_STATE : 4,
							}, {
								patch : true,
								async : false,
								wait : true,
							});
						}
					}
				});
				var $editReservationMail = this.$el.find('.editReservationMail');
				$editReservationMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = i18n.cancelBeforeReservationMail;
					if (confirm(msg)) {
						cancelReservationMail();
						location.hash = '#recompose?id=' + self.model.get('M_IDX');
					}
				});
				var $cancelReservationMail = this.$el.find('.cancelReservationMail');
				$cancelReservationMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var msg = i18n.cancelReservationMail;
					if (confirm(msg)) {
						cancelReservationMail();
					}
				});
				var cancelReservationMail = function() {
					var mailReconfCount = self.model.get('MAIL_RECONF_CNT');
					if (mailReconfCount == 1) {
						self.model.save({
							MAIL_RECONF_STATE : 5,
						}, {
							patch : true,
							async : false,
							wait : true,
						});
					} else if (mailReconfCount > 1) {
						self.model.save({
							MAIL_RECONF_STATE : 5,
						}, {
							patch : true,
							async : false,
							wait : true,
							url : 'delivery-status/groups/' + self.model.get('MAIL_RECONF_GROUP'),
						});
					}
					return;
				};
				var $deliveryStatusMail = this.$el.find('div.mc-subject a.delivery-status-mail');
				$deliveryStatusMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.model.get('MBOX_IDX'))
						location.href = $(this).attr('href');
					else
						alert(i18n.cannotViewDeletedMail);
					return false;
				});
			}
		}); // mail.DeliveryStatusItemView

		mail.DeliveryStatusListView = Backbone.Marionette.CompositeView.extend({
			// parentEl : '#deliveryList',
			itemView : mail.DeliveryStatusItemView,
			itemViewContainer : '.mc-listWrap .mc-mailList',
			template : function(data) {
				var html, compiledTemplate = mail.DeliveryStatusListView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#delivery-status-list-template').html();
					compiledTemplate = _.template(html);
					mail.DeliveryStatusListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : mail.deliveryStatusPaginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.deliveryStatusPaginator
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'paginate:delivery-status', this.paginateDeliveryStatus);
			},
			onRender : function() {
				var self = this;
				var $toggle = this.$el.find('.mc-mailListItem .mc-check .mCheck');
				var $checkboxes = this.$el.find('.mc-mailList .mc-check .mCheck');
				$toggle.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						app.vent.trigger('enable:delivery-toolbar-buttons');
						$checkboxes.prop('checked', true);
					} else {
						app.vent.trigger('disable:delivery-toolbar-buttons');
						$checkboxes.removeAttr('checked');
					}
				});
				$checkboxes.change(function(event) {
					event.stopPropagation();
					if (this.checked) {
						app.vent.trigger('enable:delivery-toolbar-buttons');
						if ($checkboxes.length == $checkboxes.filter(':checked').length) {
							$toggle.prop('checked', true);
						}
					} else {
						if ($checkboxes.filter(':checked').length == 0)
							app.vent.trigger('disable:delivery-toolbar-buttons');
						$toggle.removeAttr('checked');
					}
				});

				var $toggleSubView = this.$el.find('.toggleDeliverySubView');
				$toggleSubView.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $span = $this.find('span');
					if ($span.is('.ic_send_off')) {
						$span.removeClass('ic_send_off').addClass('ic_send_on');
					} else {
						$span.removeClass('ic_send_on').addClass('ic_send_off');
					}
					var MAIL_RECONF_IDX = parseInt($(this).attr('idx'));
					var MAIL_RECONF_GROUP = parseInt($(this).attr('group'));
					var $subList = self.$el.find('li.sub-view-' + MAIL_RECONF_GROUP);
					if ($subList.length > 0) {
						$subList.toggle();
						return;
					}
					var deliveryStatusCollection = self.fetchDeliveryStatusCollection(MAIL_RECONF_GROUP,
							MAIL_RECONF_IDX);
					deliveryStatusCollection.forEach(function(model) {
						var $thisList = $this.closest('.delivery-status-list');
						self.showSubViewList($thisList, model, MAIL_RECONF_GROUP);
					})
				});
				var $pagination = this.$el.find('.mc-paginate');
				var paginationView = new mail.PaginationView({
					collection : this.collection
				});
				$pagination.append(paginationView.render().$el.children());
			},
			fetchDeliveryStatusCollection : function(MAIL_RECONF_GROUP, MAIL_RECONF_IDX) {
				var deliveryStatusCollection = new mail.DeliveryStatusCollection();
				deliveryStatusCollection.fetch({
					url : 'delivery-status/groups/' + MAIL_RECONF_GROUP,
					async : false,
				});
				return deliveryStatusCollection;
			},
			showSubViewList : function($thisList, model, MAIL_RECONF_GROUP) {
				var subItemView = new mail.DeliveryStatusItemView({
					model : model,
				});
				var $subItemView = subItemView.render().$el;
				var $subItemList = $subItemView.addClass('send_group sub-view-' + MAIL_RECONF_GROUP);
				$thisList.after($subItemList);
				$subItemView.show();
			},
			paginateDeliveryStatus : function(params) {
				this.collection.setParameters(params);
				this.collection.pager({
					async : false
				});
				app.vent.trigger('content-header:delivery-status');
			},
		}); // mail.DeliveryStatusListView

		mail.PaginationView = Backbone.View.extend({
			// parentEl : '.mc-paginate',
			render : function() {
				var html, compiledTemplate = mail.PaginationView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-pagination-template').html();
					compiledTemplate = _.template(html);
					mail.PaginationView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : this.collection,
					i18n : i18n,
				});
				this.$el.html(html.replace(/\r|\n|\t/g, ''));
				return this;
			},
		}); // mail.PaginationView

		mail.SelectCategorizedMailsView = Backbone.View.extend({
			// parentEl : '#ly_select_item'
			tagName : 'div',
			className : 'type_a',
			template : function(data) {
				var html, compiledTemplate = mail.SelectCategorizedMailsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#select-categorized-mails-template').html();
					compiledTemplate = _.template(html);
					mail.SelectCategorizedMailsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
		}); // mail.SelectCategorizedMailsView

		mail.MoveToMboxItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.MoveToMboxItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#move-to-mbox-item-template').html();
					compiledTemplate = _.template(html);
					mail.MoveToMboxItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.mboxModel
				this.parentView = options.parentView;
			},
			getLevel : function() {
				var level = 0;
				var mboxCollection = this.options.mboxCollection;
				var parentId = this.model.get('MBOX_REF');
				if (parentId === 0) {
					return level;
				}
				var parentMboxModel = mboxCollection.find(function(mboxModel) {
					return mboxModel.get('MBOX_IDX') === parentId;
				});
				while (parentMboxModel) {
					level++;
					parentId = parentMboxModel.get('MBOX_REF');
					if (parentId === 0)
						break;
					parentMboxModel = mboxCollection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === parentId;
					});
				}
				return level;
			},
			onRender : function() {
				var self = this;
				var level = this.getLevel();
				var $mboxName = this.$el.find('label.mbox-name');
				var name = $mboxName.text();
				for (var i = 0; i < level; i++) {
					name = '../' + name;
				}
				$mboxName.text(name);
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $nextDeliverymailToMbox = self.parentView.$el.find('div.btn_area #showMoveMailContBtn');
					if (self.model.get('MBOX_TYPE') == 2)
						$nextDeliverymailToMbox.attr('disabled', true);
					else
						$nextDeliverymailToMbox.attr('disabled', false)
				});
			},
		}); // mail.MoveToMboxItemView

		mail.MoveToMboxView = Backbone.Marionette.ItemView.extend({
			// parentEl : '#moveMailLayer'
			tagName : 'div',
			className : 'type_a moveBox',
			template : function(data) {
				var html, compiledTemplate = mail.MoveToMboxView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#move-to-mbox-template').html();
					compiledTemplate = _.template(html);
					mail.MoveToMboxView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.mboxModel
				// this.collection == mail.mboxCollection
				this.mailModel = options.mailModel;
				this.paginator = options.paginator;
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.renderMboxItems);
				this.listenTo(this.collection, 'add', this.addedToMboxCollection);
			},
			onRender : function() {
				this.renderMboxItems();
				var self = this;
				var $newMbox = this.$el.find('.mailBoxMove button');
				var $moveMail = this.$el.find('div.btn_area #execMoveMailBtn');
				$nextDeliverymailToMbox = this.$el.find('div.btn_area #showMoveMailContBtn');
				$newMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $input = $(this).siblings('input:text');
					var mboxName = $.trim($input.val());
					if (mboxName !== '') {
						mail.mboxCollection.create({
							MBOX_NAME : mboxName
						}, {
							wait : true,
							success : function(model, response, options) {
								if (isPopup() && !window.opener.closed) {
									var openerApp = window.opener.require('app');
									openerApp.mail.mboxCollection.fetch();
								}
							},
							error : function(model, response, options) {
								switch (response.status) {
								case 409:
									alert(i18n.mailboxNameAlreadyExists + ': ' + mboxName);
									break;
								}
							},
						});
					}
					$input.val('');
				});
				var $listRegion = this.parentView.listRegion ? this.parentView.listRegion.$el : $({});
				$moveMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $mboxCheckboxes = self.$el.find('#moveBox_list li input[type="checkbox"]:checked');
					var $mailCheckboxes = $listRegion.find('.mc-mailList .mc-check .mCheck');
					var MBOX_IDX = $mboxCheckboxes.val();
					if (isPopup() || $listRegion.is(':hidden')) {
						self.moveMail(MBOX_IDX);
					} else {
						self.moveMails(MBOX_IDX, $mailCheckboxes);
					}
				});
				$nextDeliverymailToMbox.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkMbox = self.$el.find('#moveBox_list li input[type="checkbox"]:checked');
					var mboxModel = self.collection.findModel('MBOX_IDX', $checkMbox.val());
					self.parentView.trigger('show:filter-mails-view', mboxModel);
				});
				this.$el.click(function(event) {
					event.stopPropagation();
					event.preventDefault();
				});
			},
			addedToMboxCollection : function(model, collection, options) {
				this.MBOX_IDX = model.get('MBOX_IDX');
				this.renderMboxItems();
			},
			renderMboxItems : function() {
				var self = this;
				var $mboxList = this.$el.find('#moveBox_list');
				$mboxList.empty();
				var mboxModels = [];
				function traverseMbox(parentMboxModel) {
					var subMboxModels;
					if (parentMboxModel) {
						subMboxModels = self.collection.filter(function(mboxModel) {
							return mboxModel.get('MBOX_REF') === parentMboxModel.get('MBOX_IDX');
						});
						mboxModels.push(parentMboxModel);
					} else {
						subMboxModels = self.collection.filter(function(mboxModel) {
							return !(mboxModel.get('MBOX_TYPE') === 4 || mboxModel.get('SHARED_MBOX_ID') > 0)
									&& mboxModel.get('MBOX_REF') === 0;
						});
					}
					for (var i = 0; i < subMboxModels.length; i++) {
						traverseMbox(subMboxModels[i]);
					}
				}
				traverseMbox();
				var height = 0;
				for (var i = 0; i < mboxModels.length; i++) {
					var mboxItemView = new mail.MoveToMboxItemView({
						model : mboxModels[i],
						parentView : this,
						mboxCollection : this.collection,
					});
					$mboxList.append(mboxItemView.render().el);
					height += 20;
				}
				$mboxList.css({
					'height' : height + 'px',
				});
				var $mboxItems = this.$el.find('#moveBox_list li');
				$mboxItems.each(function(index) {
					var $item = $(this);
					var $checkbox = $item.find('input:checkbox');
					if (index == 0) {
						$item.addClass('selected');
						$checkbox.prop('checked', true);
					}
					if ($checkbox.val() == self.MBOX_IDX) {
						$mboxItems.removeClass('selected');
						$mboxItems.find('input:checkbox').prop('checked', false);
						$item.addClass('selected');
						$checkbox.prop('checked', true);
						var pos = $mboxList.scrollTop() + $item.position().top;
						$mboxList.scrollTop(pos);
					}
					$item.click(function() {
						$mboxItems.removeClass('selected');
						$mboxItems.find('input:checkbox').prop('checked', false);
						$(this).addClass('selected');
						var $checked = $(this).find('input:checkbox');
						self.MBOX_IDX = $checked.val();
						$checked.prop('checked', true);
					});
				});
			},
			moveMail : function(MBOX_IDX) {
				var self = this;
				var now = new Date().getTime();
				var url = '#' + this.paginator.getURL() + '&_=' + now;
				this.mailModel.save({
					MBOX_IDX : MBOX_IDX
				}, {
					patch : true,
					wait : true,
					success : function() {
						if (isPopup()) {
							window.opener.location.hash = url;
						} else {
							var afterDeletingMoving = app.userModel.get('AFTER_DELETING_MOVING');
							switch (afterDeletingMoving) {
							case 'P':
								if (self.mailModel.get('prevMail') != null)
									url = self.mailModel.prevMailHash(self.model, self.paginator);
								break;
							case 'N':
								if (self.mailModel.get('nextMail') != null)
									url = self.mailModel.nextMailHash(self.model, self.paginator);
								break;
							}
							location.hash = url;
						}
						self.collection.fetch(); // mail.mboxCollection
						app.$hidablesListener.trigger('hide.all');
					}
				});
			},
			moveMails : function(MBOX_IDX, $checkboxes) {
				var self = this;
				var ids = [];
				$checkboxes.each(function() {
					if (!this.checked)
						return;
					ids.push(this.value);
				});
				if (ids.length === 0) {
					return;
				}
				var mboxModel = this.collection.find(function(model) {
					return model.get('MBOX_IDX') == MBOX_IDX;
				});
				if (!mboxModel) {
					alert('Failed to move mails: not found mailbox (id:' + MBOX_IDX + ')');
					return;
				}
				mail.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					urlRoot : 'mboxes/' + mail.mboxModel.get('MBOX_IDX'),
					defaults : {
						id : 'mails'
					}
				}))();
				var jqXHR = model.save({
					MBOX_IDX : mboxModel.get('MBOX_IDX'),
					mailIds : ids,
				}, {
					patch : true,
					wait : true,
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					mail.overlayView.hideProcessing();
					var paginator = mail.paginator;
					if (paginator.length == ids.length && ids.length == data.updated) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
							self.collection.fetch();
							return;
						}
					}
					paginator.pager();
					self.collection.fetch();
				}).fail(function(jqXHR, textStatus, errorThrown) {
					mail.overlayView.hideProcessing();
					alert('Failed to move mails.');
				});
				app.$hidablesListener.trigger('hide.all');
			},
		}); // mail.MoveToMboxView

		mail.SelectLabelItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.SelectLabelItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#select-label-item-template').html();
					compiledTemplate = _.template(html);
					mail.SelectLabelItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					label : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.labelModel
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $checkbox = $this.find('input:checkbox');
					if ($this.hasClass('selected')) {
						$this.removeClass('selected');
						$checkbox.prop('checked', false);
					} else if ($this.hasClass('exception')) {
						$this.removeClass('exception').addClass('selected');
						$checkbox.prop('checked', true);
					} else {
						if ($this.hasClass('label-exception')) {
							$this.addClass('exception');
						} else {
							$this.addClass('selected');
							$checkbox.prop('checked', true);
						}
					}
					return false;
				});
			},
		}); // mail.SelectLabelItemView

		mail.SelectLabelsView = Backbone.Marionette.ItemView.extend({
			// parentEl : '#selectLabelsLayer'
			tagName : 'div',
			className : 'type_a moveBox',
			template : function(data) {
				var html, compiledTemplate = mail.SelectLabelsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#select-labels-template').html();
					compiledTemplate = _.template(html);
					mail.SelectLabelsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.labelCollection
				this.mailModel = options.mailModel;
				this.mailCollection = options.mailCollection;
				this.parentView = options.parentView;
				this.listenTo(this.collection, 'sync', this.renderLabelItems);
				this.listenTo(app.vent, 'init:select-label-items', this.initLabelItems);
			},
			onRender : function() {
				var self = this;
				this.renderLabelItems();
				var $newLabel = this.$el.find('div.mailBoxMove button.new-label');
				$newLabel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.collection.size() >= 10) {
						alert(i18n.label.exceededMaximumNumbers);
						return false;
					}
					var $labelName = self.$el.find('input:text[name=label-name]');
					var labelName = $.trim($labelName.val());
					if (!labelName || labelName.length < 1) {
						alert(i18n.label.pleaseEnterName);
						$labelName.focus();
						return false;
					}
					if (labelName && labelName.length > 10) {
						alert(i18n.label.labelNameTooLong);
						$labelName.focus();
						return false;
					}
					var colors = i18n.label.colors;
					var random = Math.floor(Math.random() * colors.length);
					var labelModel = new mail.LabelModel();
					labelModel.save({
						name : labelName,
						color : colors[random],
					}, {
						wait : true,
						async : false,
						success : function(model, response, options) {
							if (isPopup()) {
								if (window.opener && !window.opener.closed) {
									var openerApp = window.opener.require('app');
									openerApp.mail.labelCollection.fetch();
								} else {
									self.collection.fetch();
								}
							} else {
								self.collection.fetch();
							}
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 409:
								alert(i18n.label.labelNameAlreadyExists + ': ' + labelName);
								break;
							}
						},
					});
					$labelName.val('');
					return false;
				});
				var $listRegion = this.parentView.listRegion ? this.parentView.listRegion.$el : $({});
				var $save = this.$el.find('div.btn_area button.button_s');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $labelItems = self.$el.find('ul.label-list li');
					var $mailList = $listRegion.find('.mc-mailList .mc-check input:checkbox[name="M_IDX"]');
					if (isPopup() || $listRegion.is(':hidden')) {
						self.saveMailLabel($labelItems);
					} else {
						self.saveMailLabels($labelItems, $mailList);
					}
					return false;
				});
				this.$el.click(function(event) {
					event.stopPropagation();
					event.preventDefault();
				});
			},
			renderLabelItems : function() {
				var self = this;
				var $labelList = this.$el.find('ul.label-list');
				$labelList.empty();
				this.collection.each(function(labelModel) {
					var labelItemView = new mail.SelectLabelItemView({
						model : labelModel,
					});
					$labelList.append(labelItemView.render().el);
				});
				this.initLabelItems();
			},
			initLabelItems : function() {
				var self = this;
				var $labelList = this.$el.find('ul.label-list');
				var $listRegion = this.parentView.listRegion ? this.parentView.listRegion.$el : $({});
				var labelIds = [];
				if ((isPopup() || $listRegion.is(':hidden')) && this.mailModel) {
					var labels = this.mailModel.get('labels');
					for (var i = 0; i < labels.length; i++) {
						labelIds.push(labels[i].labelId);
					}
				} else {
					var $mailList = $listRegion.find('.mc-mailList .mc-check input:checkbox[name="M_IDX"]');
					$mailList.each(function(index) {
						var $this = $(this);
						if (!$this.is(':checked'))
							return;
						var mailModel = self.mailCollection.find(function(model) {
							return $this.val() == model.get('M_IDX');
						});
						if (mailModel && mailModel.get('labels').length > 0) {
							var labels = mailModel.get('labels');
							for (var i = 0; i < labels.length; i++) {
								labelIds.push(labels[i].labelId);
							}
						}
					});
				}
				var $labelItems = $labelList.find('li');
				$labelItems.removeClass();
				$labelItems.find('input:checkbox').prop('checked', false);
				$labelItems.each(function(index) {
					var $this = $(this);
					var $checkbox = $this.find('input:checkbox');
					var filters = _.filter(labelIds, function(labelId) {
						return labelId == $checkbox.val();
					});
					var mailLength = $mailList ? $mailList.filter(':checked').length : 1;
					if (filters.length == mailLength) {
						$this.addClass('selected');
						$checkbox.prop('checked', true);
					} else if (filters.length > 0 && filters.length < mailLength) {
						$this.addClass('exception').addClass('label-exception');
					}
					var pos = $labelItems.scrollTop() + $this.position().top;
					$labelItems.scrollTop(pos);
				});
			},
			saveMailLabel : function($labelItems) {
				var self = this;
				var labelSaveHash = {}, labelDeleteHash = {};
				var selectedLabelIds = [], mailLabelIds = [];
				$labelItems.each(function(index) {
					var $this = $(this);
					var $checkbox = $this.find('input:checkbox');
					if (!$checkbox.is(':checked')) {
						return;
					}
					selectedLabelIds.push(Number($checkbox.val()));
				});
				var labels = this.mailModel.get('labels');
				for (var i = 0; i < labels.length; i++) {
					mailLabelIds.push(labels[i].labelId);
				}
				labelSaveHash[this.mailModel.get('M_IDX')] = _.difference(selectedLabelIds, mailLabelIds);
				labelDeleteHash[this.mailModel.get('M_IDX')] = _.difference(mailLabelIds, selectedLabelIds);
				mail.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					url : function() {
						if (isPopup())
							return '../mail-labels';
						else
							return 'mail-labels';
					},
				}))();
				model.save(labelSaveHash, {
					async : false,
					wait : true,
				});
				model = new (app.BackboneModel.extend({
					url : function() {
						var url = 'mail-labels';
						if (isPopup())
							url = '../mail-labels';
						url += '?model=' + encodeURIComponent(JSON.stringify(labelDeleteHash));
						return url;
					},
					defaults : {
						id : 'mail-labels'
					}
				}))();
				model.destroy({
					async : false,
					wait : true,
				});
				mail.overlayView.hideProcessing();
				this.mailModel.fetch();
				app.$hidablesListener.trigger('hide.all');
			},
			saveMailLabels : function($labelItems, $mailList) {
				var self = this;
				var labelSaveHash = {}, labelDeleteHash = {};
				var selectedLabelIds = [], exceptionLabelIds = [];
				$labelItems.each(function(index) {
					var $this = $(this);
					var $checkbox = $this.find('input:checkbox');
					if (!$checkbox.is(':checked')) {
						if ($this.hasClass('exception'))
							exceptionLabelIds.push(Number($checkbox.val()));
						return;
					}
					selectedLabelIds.push(Number($checkbox.val()));
				});
				$mailList.each(function(index) {
					var $this = $(this);
					if (!$this.is(':checked'))
						return;
					var mailModel = self.mailCollection.find(function(model) {
						return $this.val() == model.get('M_IDX');
					});
					var mailLabelIds = [];
					if (mailModel && mailModel.get('labels').length > 0) {
						var labels = mailModel.get('labels');
						for (var i = 0; i < labels.length; i++) {
							mailLabelIds.push(labels[i].labelId);
						}
					}
					labelSaveHash[mailModel.get('M_IDX')] = _.difference(selectedLabelIds, mailLabelIds);
					labelDeleteHash[mailModel.get('M_IDX')] = _.difference(mailLabelIds, _.union(selectedLabelIds,
							exceptionLabelIds));
				});
				mail.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					url : function() {
						if (isPopup())
							return '../mail-labels';
						else
							return 'mail-labels';
					},
				}))();
				model.save(labelSaveHash, {
					async : false,
					wait : true,
				});
				model = new (app.BackboneModel.extend({
					url : function() {
						var url = 'mail-labels';
						if (isPopup())
							url = '../mail-labels';
						url += '?model=' + encodeURIComponent(JSON.stringify(labelDeleteHash));
						return url;
					},
					defaults : {
						id : 'mail-labels'
					}
				}))();
				model.destroy({
					async : false,
					wait : true,
				});
				mail.overlayView.hideProcessing();
				mail.paginator.pager();
				app.$hidablesListener.trigger('hide.all');
			},
		}); // mail.MoveToMboxView

		mail.FilterMailsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_b',
			template : function(data) {
				var html, compiledTemplate = mail.FilterMailsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#filter-mails-template').html();
					compiledTemplate = _.template(html);
					mail.FilterMailsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = mail.mboxModel
				// this.collection = mail.mboxCollection
				this.mailModel = options.mailModel;
				this.paginator = options.paginator;
			},
			onRender : function() {
				var self = this;
				var $moveMail = this.$el.find('#execMoveMailContBtn');
				$moveMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $mailCheckboxes = $('.mc-mailList .mc-check .mCheck:checked');
					var MBOX_IDX = self.model.get('MBOX_IDX');
					self.registerFilter(MBOX_IDX, $mailCheckboxes);
					app.$hidablesListener.trigger('hide.all');
				});
			},
			registerFilter : function(MBOX_IDX, $mailCheckboxes) {
				var $displayMailView = $('div#mc-preview');
				if (isPopup()
						|| ($displayMailView.is(':visible') && $displayMailView.parent().hasClass('mc-list_normal'))) {
					this.registerFilterByMailView(MBOX_IDX);
				} else {
					// Mail List View
					this.registerFilterByListView(MBOX_IDX, $mailCheckboxes);
				}
			},
			registerFilterByMailView : function(MBOX_IDX) {
				var self = this;
				var $previous = this.$el.find('input#check_cleanup_option');
				var prevMailChecked = ($previous.is(':checked') ? 1 : 0);
				if (!this.mailModel || !this.mailModel.get('M_SENDER')) {
					return false;
				}
				var sender;
				try {
					var addr = InternetAddress.parseHeader(this.mailModel.get('M_SENDER'), false);
					sender = addr[0].getAddress();
				} catch (error) {
					return false;
				}
				if (!sender) {
					return false;
				}
				if (!prevMailChecked) {
					this.mailModel.save({
						MBOX_IDX : MBOX_IDX
					}, {
						patch : true,
						wait : true,
					});
				}
				var filterCollection = new mail.AutoDivisionCollection({});
				filterCollection.fetch({
					async : false,
				});
				var filterModel = filterCollection.findModel('SENDER', sender);
				if (!filterModel) {
					filterModel = new mail.AutoDivisionModel({});
					filterModel.save({
						MBOX_IDX : MBOX_IDX,
						AUTODIVISION_TYPE : -1,
						SENDER : sender,
						PREVIOUS : prevMailChecked,
					}, {
						async : false,
						wait : true,
					});
				}
				var now = new Date().getTime();
				var url = '#' + self.paginator.getURL({}) + '&_=' + now;
				self.collection.fetch(); // mail.mboxCollection
				if (isPopup()) {
					window.opener.location.hash = url;
				} else {
					location.hash = url;
				}
				self.paginator.pager();
				app.$hidablesListener.trigger('hide.all');
			},
			registerFilterByListView : function(MBOX_IDX, $mailCheckboxes) {
				var self = this;
				var $previous = this.$el.find('input#check_cleanup_option');
				var prevMailChecked = ($previous.is(':checked') ? 1 : 0);
				var mailModels = [];
				$mailCheckboxes.each(function() {
					var mailIdx = $(this).val();
					var model = self.paginator.find(function(mailModel) {
						if (mailIdx == mailModel.get('M_IDX'))
							return true;
					});
					if (model)
						mailModels.push(model);
				});
				var filterCollection = new mail.AutoDivisionCollection({});
				filterCollection.fetch({
					async : false,
				});
				var filters = filterCollection.toJSON();
				for (var i = 0; i < mailModels.length; i++) {
					var mailModel = mailModels[i];
					if (!mailModel || !mailModel.get('M_SENDER')) {
						continue;
					}
					var sender;
					try {
						var addr = InternetAddress.parseHeader(mailModel.get('M_SENDER'), false);
						sender = addr[0].getAddress();
					} catch (error) {
						continue;
					}
					if (!sender) {
						continue;
					}
					if (!prevMailChecked) {
						mailModel.save({
							MBOX_IDX : MBOX_IDX
						}, {
							patch : true,
							wait : true,
						});
					}
					var filterModel = _.find(filters, function(model) {
						return model.SENDER == sender && model.MBOX_IDX == MBOX_IDX;
					});
					if (filterModel)
						continue;
					else
						filterModel = new mail.AutoDivisionModel({});
					filterModel.save({
						MBOX_IDX : MBOX_IDX, // 
						AUTODIVISION_TYPE : -1,
						SENDER : sender,
						PREVIOUS : ($previous.is(':checked') ? 1 : 0),
					}, {
						async : false,
						wait : true,
						success : function(model, response, options) {
							filters.push(model.toJSON());
						},
					});
				}
				self.collection.fetch();
				app.vent.trigger('paginate:mails', self.model);
				app.$hidablesListener.trigger('hide.all');
			},
		}); // mail.FilterMailsView

		mail.MoreActionsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_a',
			template : function(data) {
				var html, compiledTemplate = mail.MoreActionsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#more-actions-template').html();
					compiledTemplate = _.template(html);
					mail.MoreActionsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mbox : mail.mboxModel.toJSON(),
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.model
				// this.collection == mail.mboxCollection
				if (options.paginator) {
					this.paginator = options.paginator;
				}
			},
			onRender : function() {
				var self = this;
				var $addToContacts = this.$el.find('.add-to-contacts');
				$addToContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkBoxes = $('.mc-mailList .mc-check .mCheck:checked');
					var addressCollection = new app.contact.AddressCollection();
					var $moreActions;
					if (self.paginator) {
						// List View
						$checkBoxes.each(function() {
							var mailIdx = $(this).val();
							var mailModel = self.paginator.find(function(model) {
								return model.get('M_IDX') == mailIdx;
							});
							self.addContacts(mailIdx, mailModel, addressCollection);
						});
						$moreActions = $('button.list-more-actions');
					} else {
						// Mail View
						var mailIdx = self.model.get('M_IDX');
						self.addContacts(mailIdx, self.model, addressCollection);
						$moreActions = $('button.mail-more-actions');
					}
					app.vent.trigger('more:add-contacts', addressCollection);
					var $offsetParent = $moreActions.offsetParent();
					var position = $moreActions.position();
					var top = $offsetParent.position().top + position.top + $moreActions.outerHeight();
					var left = $offsetParent.position().left + position.left;
					var $layer = $('#ly_address');
					$layer.css({
						position : 'absolute',
						top : top,
						left : left
					});
					$layer.attr('hidable', false);
				});
				var $searchForSender = this.$el.find('.search-for-this-sender');
				$searchForSender.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = $('.mc-mailList .mc-check .mCheck:checked');
					if ($checkboxes.length > 1) {
						alert(i18n.pleaseSelectOneMail);
						return false;
					}
					var mailIdx;
					var mailModel;
					if (self.paginator) {
						mailIdx = $checkboxes.val();
						mailModel = self.paginator.find(function(model) {
							return model.get('M_IDX') == mailIdx;
						});
					} else {
						mailModel = self.model;
					}
					var addrs = [];
					try {
						addrs = InternetAddress.parseHeader(mailModel.get('M_SENDER'), false);
					} catch (error) {
						return;
					}
					var sender = addrs[0].getAddress();
					var encSender = encodeURIComponent(sender);
					location.hash = 'mboxes/all/mails?search.from=' + encSender;
					app.$hidablesListener.trigger('hide.all');
				});
				var $downloadToPC = this.$el.find('.download-to-pc');
				$downloadToPC.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.paginator) {
						// List View
						var $checkboxes = $('.mc-mailList .mc-check .mCheck:checked');
						var mailIds = [];
						$checkboxes.each(function() {
							mailIds.push($(this).val());
						});
						if (mailIds.length == 1) {
							location.href = 'mails/' + mailIds[0] + '/download';
						} else {
							location.href = 'mails/download?ids=' + mailIds.join(',');
						}
					} else {
						// Mail View
						if (isPopup()) {
							location.href = '../mails/' + self.model.get('M_IDX') + '/download';
						} else {
							location.href = 'mails/' + self.model.get('M_IDX') + '/download';
						}
					}
					app.$hidablesListener.trigger('hide.all');
				});
				var $viewOriginal = this.$el.find('.view-original');
				var $viewHeader = this.$el.find('.view-header');
				$viewOriginal.add($viewHeader).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mailIdx;
					if (self.paginator) {
						var $checkboxes = $('.mc-mailList .mc-check .mCheck:checked');
						if ($checkboxes.length > 1) {
							alert(i18n.pleaseSelectOneMail);
							return false;
						}
						// List View
						mailIdx = $checkboxes.val();
					} else {
						// Mail View
						mailIdx = self.model.get('M_IDX');
					}
					var viewMode = $(this).hasClass('view-header') ? 1 : 0;
					self.fetchMimeMessage(mailIdx, viewMode);
				});
				var $showAsConveration = this.$el.find('a.show-as-converation');
				$showAsConveration.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.paginator) {
						var $checkboxes = $('.mc-mailList .mc-check .mCheck:checked');
						if ($checkboxes.length > 1) {
							alert(i18n.pleaseSelectOneMail);
							return false;
						}
						// List View
						self.model = self.paginator.find(function(model) {
							return model.get('M_IDX') == $checkboxes.val();
						});
					}
					var encSender = encodeURIComponent(self.model.get('M_SENDER'));
					if (mail.mboxModel.get('MBOX_TYPE') == 2 || mail.mboxModel.get('MBOX_TYPE') == 4)
						encSender = encodeURIComponent(self.model.get('M_TO'));
					var url = 'popup/#converation/mails?perPage=10&search.converation=' + encSender;
					var win = window.open(url, '', 'scrollbars=yes,width=900,height=680');
					win.focus();
					app.$hidablesListener.trigger('hide.all');
					return false;
				});
			},
			fetchMimeMessage : function(M_IDX, viewMode) {
				var mimeModel = new mail.MimeModel();
				mimeModel.set('M_IDX', M_IDX);
				mimeModel.set('viewMode', viewMode);
				mimeModel.fetch({
					wait : true,
					async : false,
				});
				app.vent.trigger('view:original', mimeModel);
			},
			addContacts : function(mailIdx, mailModel, addressCollection) {
				var addrs = [];
				try {
					addrs = InternetAddress.parseHeader(mailModel.get('M_SENDER'), false);
				} catch (error) {
					return;
				}
				var addressModel = new app.contact.AddressModel({});
				addressModel.urlRoot = 'contacts';
				addressModel.save({
					ADDRESS_NAME : addrs[0].getPersonal() || i18n.addContacts.anonymous,
					ADDRESS_EMAIL : addrs[0].getAddress(),
					ADDRESS_EMAIL_REP : 'Y',
					GROUP_IDX : 0,
				}, {
					wait : true,
					async : false,
					success : function(model, response, options) {
						var retModel = new app.contact.AddressModel(response.contact);
						addressModel = retModel;
					},
				});
				addressCollection.add(addressModel);
			},
		}); // mail.MoreActionsView

		mail.MailSourceView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_c',
			template : function(data) {
				var html, compiledTemplate = mail.MailSourceView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-source-template').html();
					compiledTemplate = _.template(html);
					mail.MailSourceView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mime : data,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
			},
			onRender : function() {
				var self = this;
				var $viewMode = this.$el.find('button.view-mime-viewMode');
				$viewMode.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var M_IDX = self.model.get('M_IDX');
					var viewMode = $this.val();
					self.fetchMimeMessage(M_IDX, viewMode);
				});
			},
			fetchMimeMessage : function(M_IDX, viewMode) {
				var mimeModel = new mail.MimeModel();
				mimeModel.set('M_IDX', M_IDX);
				mimeModel.set('viewMode', viewMode);
				mimeModel.fetch({
					wait : true,
					async : false,
				});
				app.vent.trigger('view:original', mimeModel);
			},
		}); // mail.MailSourceView

		mail.AddContactsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'tr',
			template : function(data) {
				var html, compiledTemplate = mail.AddContactsItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#add-contact-item-template').html();
					compiledTemplate = _.template(html);
					mail.AddContactsItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.contact.AddressModel
			},
			onRender : function() {
				var self = this;
				var $editAddressName = this.$el.find('.edit-contact-name');
				var $addressNameWrapper = this.$el.find('.contact-name-wrapper');
				var $addressNameInputWrapper = this.$el.find('.add-contact-name');
				var $inputAddressName = $addressNameInputWrapper.find('input[type=text]');
				var $editGroupName = this.$el.find('.edit-group-name');
				var $groupNameWrapper = this.$el.find('.contact-group-name-wrapper');
				var $groupNameInputWrapper = this.$el.find('.add-contact-group-name');
				var $inputGroupName = $groupNameInputWrapper.find('input[type=text]');
				var $important = this.$el.find('span.contact-important');

				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var important;
					if ($important.is('.importantOff')) {
						$important.removeClass('importantOff').addClass('importantOn');
						important = 'Y';
					} else {
						$important.removeClass('importantOn').addClass('importantOff');
						important = 'N';
					}
					self.model.save({
						ADDRESS_IMPORTANT : important,
					}, {
						patch : true,
						wait : true,
						async : false,
					});
				});

				$editAddressName.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$addressNameWrapper.hide();
					$addressNameInputWrapper.show();
					$inputAddressName.val(self.model.get('ADDRESS_NAME'));
					$inputAddressName.focus();
					$inputAddressName.select();
				});
				$inputAddressName.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						var addressName = $.trim($(this).val());
						if (!addressName) {
							return false;
						}
						self.model.save({
							ADDRESS_NAME : addressName,
						}, {
							patch : true,
							wait : true
						});
						$addressNameInputWrapper.hide();
						$addressNameWrapper.show();
						self.$el.find('span.contact-name').text(addressName);
					}
				});
				$inputAddressName.blur(function(event) {
					var addressName = $.trim($(this).val());
					if (!addressName) {
						return false;
					}
					self.model.save({
						ADDRESS_NAME : addressName,
					}, {
						patch : true,
						wait : true
					});
					$addressNameInputWrapper.hide();
					$addressNameWrapper.show();
					self.$el.find('span.contact-name').text(addressName);
				});

				$editGroupName.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$groupNameWrapper.hide();
					$groupNameInputWrapper.show();
					var groupCollection = new app.contact.GroupCollection();
					groupCollection.fetch({
						async : false,
					});
					var groupModel = groupCollection.getGroupModel('GROUP_IDX', self.model.get('GROUP_IDX'));
					var groupName = groupModel && groupModel.get('GROUP_NM') || i18n.addContacts.defaultGroup;
					$inputGroupName.val(groupName);
					$inputGroupName.focus();
					$inputGroupName.select();
				});
				$inputGroupName.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						var groupName = $.trim($(this).val());
						if (!groupName) {
							return false;
						}
						self.moveAddressToGroup(groupName);
						$groupNameInputWrapper.hide();
						$groupNameWrapper.show();
						self.$el.find('span.contact-group-name').text(groupName);
					}
				});
				$inputGroupName.blur(function(event) {
					var groupName = $.trim($(this).val());
					if (!groupName) {
						return false;
					}
					self.moveAddressToGroup(groupName);
					$groupNameInputWrapper.hide();
					$groupNameWrapper.show();
					self.$el.find('span.contact-group-name').text(groupName);
				});
			},
			moveAddressToGroup : function(groupName) {
				var groupCollection = new app.contact.GroupCollection();
				groupCollection.fetch({
					async : false,
				});
				var group = groupCollection.find(function(groupModel) {
					return groupModel.get('GROUP_NM') === groupName;
				});
				if (!group) {
					group = new app.contact.GroupModel();
					group.save({
						GROUP_NM : groupName,
					}, {
						wait : true,
						async : false,
					});
				}
				this.model.urlRoot = 'contacts';
				this.model.save({
					GROUP_IDX : group.get('GROUP_IDX'),
				}, {
					patch : true,
					wait : true
				});
			},
		}); // mail.AddContactsItemView

		mail.AddContactsView = Backbone.Marionette.CompositeView.extend({
			itemView : mail.AddContactsItemView,
			itemViewContainer : 'tbody#ly_address_table',
			template : function(data) {
				var html, compiledTemplate = mail.AddContactsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#add-contact-template').html();
					compiledTemplate = _.template(html);
					mail.AddContactsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contact : data,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == app.contact.AddressCollection
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('.close-add-contact-view');
				$close.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					$('#ly_address').attr('hidable', true);
					app.$hidablesListener.trigger('hide.all');
				});
				if (this.collection.length > 6) {
					this.$el.find('div#ly_address_list').addClass('has_scrl');
				} else {
					this.$el.find('div#ly_address_list').removeClass('has_scrl');
				}
			},
		}); // mail.AddContactsView

		mail.ReportSpamView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_c',
			template : function(data) {
				var html, compiledTemplate = mail.ReportSpamView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#report-spam-template').html();
					compiledTemplate = _.template(html);
					mail.ReportSpamView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.MboxModel
				// this.collection == mail.MailCollection
				this.mboxCollection = options.mboxCollection;
				this.paginator = options.paginator;
			},
			onRender : function() {
				var self = this;
				var $reportType = this.$el.find('ul li input[name="join_line"]');
				var $reportHackPanel = this.$el.find('div.hack_write');
				var $textArea = this.$el.find('.report-spam-description');
				var $report = this.$el.find('button.report-spam');
				var $cancel = this.$el.find('button.report-spam-cancel');
				$reportType.change(function() {
					if ($(this).hasClass('report-spam-hacking-mail')) {
						$reportHackPanel.show();
					} else {
						$reportHackPanel.hide();
					}
				});
				$textArea.placeholder();
				$report.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $spamProcess = self.$el.find('ul li input[name="spam_handle"]:checked');
					var $filter = self.$el.find('ul li input[name="spam_filter"]');
					var reportDescription = '';
					if ($reportHackPanel.is(':visible')) {
						reportDescription = $textArea.val();
					}
					self.collection.forEach(function(model) {
						var mailModel = model.clone();
						var reportModel = new mail.MailReportModel({});
						var sender;
						try {
							sender = InternetAddress.parseHeader(mailModel.get('M_SENDER'), false);
						} catch (error) {
							return '';
						}
						reportModel.save({
							M_IDX : mailModel.get('M_IDX'),
							M_TITLE : mailModel.get('M_TITLE'),
							MAIL_REPORT_SENDDATE : mailModel.get('M_TIME'),
							MAIL_REPORT_FROM : sender[0].getAddress(),
							MAIL_REPORT_STMT : reportDescription,
							MAIL_REPORT_TYPE : $reportType.filter(':checked').val(),
						}, {
							wait : true,
							async : false,
						});

						//    (, )
						var mboxModel = self.mboxCollection.findModel('MBOX_TYPE', '5');
						var MBOX_IDX = mboxModel.get('MBOX_IDX');
						if ($spamProcess.val() == 'move') {
							mailModel.save({
								MBOX_IDX : MBOX_IDX
							}, {
								patch : true,
								wait : true,
								async : false,
							});
						} else if ($spamProcess.val() == 'del') {
							mailModel.destroy({
								wait : true,
								async : false,
							});
						}

						//    
						if ($filter.is(':checked')) {
							var filterModel = new mail.FilterModel({});
							filterModel.save({
								FILTER_AUTH : 3, // 3: 
								FILTER_TYPE : 1, // 1: 
								FILTER_KEYWORD : mailModel.get('M_SENDER'),
							}, {
								wait : true,
								async : false,
							});
						}
					});

					var $displayMailView = $('div#mc-preview');
					var now = new Date().getTime();
					var url = '#' + self.paginator.getURL({}) + '&_=' + now;
					if ($displayMailView.is(':visible')) {
						// Mail View
						alert(i18n.successReportSpam);
						self.mboxCollection.fetch();
						location.hash = url;
						self.paginator.pager();
					} else {
						// List View
						alert(i18n.successReportSpam);
						if (isPopup()) {
							self.mboxCollection.fetch();
							window.opener.location.hash = url;
							self.paginator.pager();
						} else {
							self.mboxCollection.fetch();
							app.vent.trigger('paginate:mails', self.model);
						}
					}
					app.$hidablesListener.trigger('hide.all');
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
				});
			},
		}); // mail.ReportSpamView

		mail.ComposeMailView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'mc-division',
			template : function(data) {
				var html, compiledTemplate = mail.ComposeMailView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#compose-mail-template').html();
					compiledTemplate = _.template(html);
					mail.ComposeMailView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : app.userModel.toJSON(),
					i18n : i18n,
					config : app.config,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				this.userModel = options.userModel; // app.userModel
				this.params = options.params || {};
				this.composeRegion = options.composeRegion;
				this.signatureRegion = options.signatureRegion;
				this.stationeryRegion = options.stationeryRegion;
				this.formRegion = options.formRegion;
				this.delayDeliveryRegion = options.delayDeliveryRegion;
				this.blobOptionsRegion = options.blobOptionsRegion;
				this.parentView = options.parentView;
				this.listenTo(app.vent, 'send:mail', this.send);
				this.listenTo(app.vent, 'save:mail', this.draft);
				this.listenTo(app.vent, 'preview:mail', this.preview);
				this.listenTo(app.vent, 'compose:changed', function(callback) {
					var changed = this.submitForm('changed');
					callback.call(null, changed);
				});
				this.listenTo(app.vent, 'send:secure', this.sendSecure);
				this.listenTo(app.vent, 'send:secure-mail', this.sendSecureMail);
				this.listenTo(this.userModel, 'change:AUTOSAVE_INTERVAL', this._autoSave());
				app.vent.trigger('clear:draft');
			},
			onBeforeRender : function() {
				this._showLoadingOverlay();
				var self = this;
				var getReplyTo = function(recipient1, recipient2) {
					var addrs1 = [], addrs2 = [];
					try {
						addrs1 = InternetAddress.parseHeader(recipient1, false);
					} catch (error) {
					}
					try {
						addrs2 = InternetAddress.parseHeader(recipient2, false);
					} catch (error) {
					}
					if (addrs1.length && !addrs2.length) {
						return recipient1;
					} else if (!addrs1.length && addrs2.length) {
						return recipient2;
					}
					if (addrs1[0].getAddress() === addrs2[0].getAddress()) {
						if (addrs1[0].getPersonal())
							return recipient1;
						else if (addrs2[0].getPersonal())
							return recipient2;
					}
					return recipient1 || recipient2;
				};
				var getRecipients = function(addresslist) {
					var addrs = [];
					try {
						addrs = InternetAddress.parseHeader(addresslist, false);
					} catch (error) {
						return '';
					}
					var recipients = [];
					var user = self.userModel.get('USERS_IDX');
					for (var i = 0; i < addrs.length; i++) {
						var address = addrs[i].getAddress();
						if (address === user)
							continue;
						recipients.push(addrs[i].toString());
					}
					return recipients.join(',');
				};
				var getOriginalMessage = function(data) {
					var html = mail.$template.filter('#blockquoted-mail-template').html();
					var compiledTemplate = _.template(html);
					var message = compiledTemplate({
						i18n : i18n,
						mail : data
					});
					return message;
				};
				var getSignature = function() {
					var html = '';
					var useSignature = self.userModel.get('USERS_SIGNATURE');
					if (useSignature == 'Y') {
						var signatureCollection = new app.mail.SignatureCollection();
						signatureCollection.fetch({
							async : false,
							wait : true,
							cache : false,
						});
						var signature = signatureCollection.findModel('SIGN_DEFAULT', '1');
						if (signature) {
							html += '<p><br></p>';
							html += '<p><br></p>';
							html += '<p><br></p>';
							html += '<div id="signature-area">';
							html += signature.get('SIGN_STMT');
							html += '</div>';
							html += '<p><br></p>';
						}
						var $div = $('<div></div>').html(html);
						var $images = $div.find('img');
						var pattern = /^cid:(.+)/i;
						$images.each(function(index, element) {
							var $img = $(element);
							var src = $img.attr('src');
							var match = pattern.exec(src);
							if (match && match.length == 2) {
								var url = 'inline/' + match[1];
								if (isPopup())
									url = '../inline/' + match[1];
								$img.attr('src', url);
							}
						});
						html = $div.html();
					}
					return html;
				};
				if (location.hash) {
					var link = document.createElement("a");
					var hash = location.hash;
					link.href = hash.substring(hash.indexOf('#') + 1);
					var pathname = link.pathname;
					if (pathname.indexOf('/') == 0) {
						var lastSlashIndex = pathname.lastIndexOf('/');
						pathname = pathname.substring(lastSlashIndex + 1);
					}
					switch (pathname) {
					case 'compose':
					case 'recompose':
						if (this.params.id) {
							this.mailModel = new mail.MailModel({
								M_IDX : this.params.id
							});
							this.mailModel.fetch({
								async : false,
								data : {
									action : 'recompose'
								}
							});
							this.params.to = this.mailModel.get('M_TO');
							this.params.cc = this.mailModel.get('M_CC');
							this.params.bcc = this.mailModel.get('M_BCC');
							this.params.subject = this.mailModel.get('M_TITLE');
							this.params.content = this.mailModel.get('M_CONTENT');
							if (pathname == 'recompose') {
								this.mailModel.set('M_IDX', 0);
								// Attachments
								this.params.attachments = [];
								var attachments = this.mailModel.get('attachments') || [];
								for (var i = 0; i < attachments.length; i++) {
									var attachment = attachments[i];
									this.params.attachments.push({
										id : 'attachment.' + this.params.id + '.' + attachment.num,
										name : attachment.name,
										size : attachment.size,
										type : 'file'
									});
								}
							}
						} else {
							this.params.content = getSignature();
						}
						break;
					case 'reply':
						this.params.action = pathname;
						if (this.params.id) {
							var model = new mail.MailModel({
								M_IDX : this.params.id
							});
							model.fetch({
								async : false
							});
							this.params.to = getReplyTo(model.get('M_RETURN'), model.get('M_SENDER'));
							this.params.subject = 'RE: ' + model.get('M_TITLE');
							this.params.content = getSignature();
							if (this.userModel.get('REPLY_WITH') == 'original')
								this.params.content += getOriginalMessage(model.toJSON());
						}
						break;
					case 'reply-to-all':
						this.params.action = pathname;
						if (this.params.id) {
							var model = new mail.MailModel({
								M_IDX : this.params.id
							});
							model.fetch({
								async : false
							});
							this.params.to = getReplyTo(model.get('M_RETURN'), model.get('M_SENDER'));
							this.params.to = getRecipients(this.params.to + ',' + model.get('M_TO'));
							this.params.cc = getRecipients(model.get('M_CC'));
							this.params.subject = 'RE: ' + model.get('M_TITLE');
							this.params.content = getSignature();
							if (this.userModel.get('REPLY_WITH') == 'original')
								this.params.content += getOriginalMessage(model.toJSON());
						}
						break;
					case 'forward':
					case 'forward-for-me':
						var forwardingOption = self.userModel.get('FORWARDING_OPTION');
						this.params.action = pathname;
						if (this.params.id && (typeof this.params.id == 'string')) {
							var model = new mail.MailModel({
								M_IDX : this.params.id
							});
							model.fetch({
								async : false,
								data : {
									action : 'forward'
								}
							});
							if (this.params.action === 'forward-for-me') {
								this.params.to = this.userModel.get('USERS_IDX');
							}
							this.params.subject = 'FW: ' + model.get('M_TITLE');
							this.params.content = getSignature();
							this.params.attachments = [];
							if (forwardingOption) {
								var subject = model.get('M_TITLE');
								if (subject) {
									subject = subject.replace(/[\\/:*?\"<>|\r\n\t]/gi, ' ');
									if (subject.length > 32)
										subject = subject.substring(0, 32);
								} else {
									subject = "No Subject";
								}
								this.params.attachments.push({
									id : 'mail.' + model.get('M_IDX'),
									name : subject + '.eml',
									size : model.get('M_SIZE'),
									type : 'file'
								});
							} else {
								this.params.content += getOriginalMessage(model.toJSON());
								// Attachments
								var attachments = model.get('attachments') || [];
								for (var i = 0; i < attachments.length; i++) {
									var attachment = attachments[i];
									this.params.attachments.push({
										id : 'attachment.' + this.params.id + '.' + attachment.num,
										name : attachment.name,
										size : attachment.size,
										type : 'file'
									});
								}
								// Attachments of Nested Messages
								var mails = model.get('mails') || [];
								for (var index = 0; index < mails.length; index++) {
									var attachments = mails[index].attachments || [];
									for (var i = 0; i < attachments.length; i++) {
										var attachment = attachments[i];
										this.params.attachments.push({
											id : 'attachment.' + this.params.id + '.' + index + '.' + attachment.num,
											name : attachment.name,
											size : attachment.size,
											type : 'file'
										});
									}
								}
							}
						} else if (this.params.id && $.isArray(this.params.id)) {
							var mailIds = this.params.id;
							var mailModels = mail.paginator.filter(function(mailModel) {
								var mailId = mailModel.get('M_IDX');
								for (var i = 0; i < mailIds.length; i++) {
									if (mailId == mailIds[i])
										return true;
								}
							});
							if (mailIds.length !== mailModels.length) {
								for (var index = 0; index < mailModels.length; index++) {
									var mailId = mailModels[index].get('M_IDX');
									for (var i = 0; i < mailIds.length; i++) {
										if (mailId == mailIds[i]) {
											mailIds.splice(i, 1);
											break;
										}
									}
								}
								for (var index = 0; index < mailIds.length; index++) {
									var model = new mail.MailModel({
										M_IDX : mailIds[index]
									});
									model.fetch({
										async : false,
									});
									mailModels.push(model);
								}
							}
							this.params.attachments = [];
							for (var index = 0; index < mailModels.length; index++) {
								var mailModel = mailModels[index];
								var subject = mailModel.get('M_TITLE');
								if (subject) {
									subject = subject.replace(/[\\/:*?\"<>|\r\n\t]/gi, ' ');
									if (subject.length > 32)
										subject = subject.substring(0, 32);
								} else {
									subject = "No Subject";
								}
								this.params.attachments.push({
									id : 'mail.' + mailModel.get('M_IDX'),
									name : subject + '.eml',
									size : mailModel.get('M_SIZE'),
									type : 'file'
								});
							}
							if (mailModels && mailModels[0]) {
								this.params.subject = 'FW: ' + mailModels[0].get('M_TITLE');
							}
							this.params.content = getSignature();
						}
						break; // case 'forward':
					case 'approval-recompose':
						if (this.params.id) {
							this.approvalModel = new mail.ApprovalModel({
								id : this.params.id
							});
							this.approvalModel.fetch({
								async : false,
								data : {
									action : 'approval-recompose'
								}
							});
							this.mailModel = new mail.MailModel(this.approvalModel.get('mail'));
							this.mailModel.set('M_IDX', 0);
							this.params.to = this.mailModel.get('M_TO');
							this.params.cc = this.mailModel.get('M_CC');
							this.params.bcc = this.mailModel.get('M_BCC');
							this.params.subject = this.mailModel.get('M_TITLE');
							this.params.content = this.mailModel.get('M_CONTENT');
							// Attachments
							this.params.attachments = [];
							var attachments = this.mailModel.get('attachments') || [];
							var mailId = this.approvalModel.get('mailId');
							for (var i = 0; i < attachments.length; i++) {
								var attachment = attachments[i];
								this.params.attachments.push({
									id : 'attachment.' + mailId + '.' + attachment.num,
									name : attachment.name,
									size : attachment.size,
									type : 'file'
								});
							}
							// Attachments of Nested Messages
							var mails = this.mailModel.get('mails') || [];
							for (var index = 0; index < mails.length; index++) {
								var attachments = mails[index].attachments || [];
								for (var i = 0; i < attachments.length; i++) {
									var attachment = attachments[i];
									this.params.attachments.push({
										id : 'attachment.' + mailId + '.' + index + '.' + attachment.num,
										name : attachment.name,
										size : attachment.size,
										type : 'file'
									});
								}
							}
						}
						break;
					} // end switch (pathname) {...}
				} // end if (location.hash) {...}
			},
			onRender : function() {
				var self = this;
				var position = {
					of : this.$el.find("#mailTo"),
					my : "left top",
					at : "left bottom",
					collision : "none",
				};
				var keydown = function(event, ui) {
					var $input = $(event.currentTarget);
					if ($input.hasClass('ui-state-disabled')) {
						$input.removeClass('ui-state-disabled');
						var timer = $input.data('timer');
						if (!timer) {
							timer = setTimeout(function() {
								$input.addClass('ui-state-disabled').css({
									'opacity' : '1',
									'filter' : 'none',
									'background-image' : 'none',
								});
								$input.data('timer', 0);
							}, 250);
							$input.data('timer', timer);
						}
					}
					switch (event.keyCode) {
					case $.ui.keyCode.TAB:
						var tabindex = 0;
						var $inputs = [ self.$to, self.$cc, self.$bcc ];
						for (tabindex = 0; tabindex < $inputs.length; tabindex++) {
							if ($inputs[tabindex].inputbox('input').is(':focus'))
								break;
						}
						setTimeout(function() {
							switch (tabindex) {
							case 0:
								if (self.$cc.inputbox('input').is(':visible')) {
									self.$cc.inputbox('focus');
									break;
								}
							case 1:
								if (self.$bcc.inputbox('input').is(':visible')) {
									self.$bcc.inputbox('focus');
									break;
								}
							case 2:
								self.$subject.focus();
								break;
							}
							return;
						}, 250);
						break;
					case $.ui.keyCode.ENTER:
						var $rcptInput = $(this);
						setTimeout(function() {
							if ($input.hasClass('ui-state-disabled')) {
								$rcptInput.inputbox('on', 'blur');
								$input.autocomplete('close');
								$input.blur();
							}
						}, 250);
						break;
					}
					if (self.$recentContacts.hasClass('selected') || self.$importantContacts.hasClass('selected')) {
						self.$recentContacts.removeClass('selected');
						self.$importantContacts.removeClass('selected');
						self.dropdownContactsView.$el.hide();
					}
				};
				// To: 
				var autocompleteOptions = _.extend(mail.autocompleteOptions, {
					position : position
				});
				this.$to = this.$el.find('input[name="M_TO"]');
				this.$to.inputbox({
					containment : 'parent',
					autocompleteOptions : autocompleteOptions,
					focus : function(event, ui) {
						self.$to.parent('div.mc-mInput_holder').addClass('mInput_over');
						self.$cc.parent('div.mc-mInput_holder').removeClass('mInput_over');
						self.$bcc.parent('div.mc-mInput_holder').removeClass('mInput_over');
						self.$focusedInput = self.$to;
						if (self.$cc.inputbox('input').hasClass('ui-state-disabled')) {
							self.$cc.inputbox('on', 'blur');
							self.$cc.inputbox('input').removeClass('ui-state-disabled').blur();
							setTimeout(function() {
								self.$to.inputbox('focus');
							}, 250);
						}
						if (self.$bcc.inputbox('input').hasClass('ui-state-disabled')) {
							self.$bcc.inputbox('on', 'blur');
							self.$bcc.inputbox('input').removeClass('ui-state-disabled').blur();
							setTimeout(function() {
								self.$to.inputbox('focus');
							}, 250);
						}
						self.$autocomplete.position(_.extend(position, {
							of : self.$el.find('#mailTo')
						}));
						hideSignature();
						hideStationery();
						hideDocumentForm();
					},
					keydown : keydown,
				});
				if (this.params && this.params.to) {
					if (typeof this.params.to === 'string')
						this.$to.inputbox('add', this.params.to);
					else if (typeof this.params.to === 'object' && this.params.to.join && this.params.to.length)
						this.$to.inputbox('add', this.params.to.join(','));
				}
				// [Checkbox ] <!-- deprecated by comment tag -->
				var $composeForMe = this.$el.find('#composeForMe');
				$composeForMe.click(function(event) { //
					var personal = self.userModel.get('USERS_NAME');
					var address = self.userModel.get('USERS_IDX');
					self.$to.inputbox('add', '"' + personal + '" <' + address + '>');
					$composeForMe.prop('disabled', true);
				});
				if (/^#compose-for-me/.test(location.hash) || /^#forward-for-me/.test(location.hash)) {
					// $composeForMe.click(); <!-- deprecated by comment tag -->
					var personal = self.userModel.get('USERS_NAME');
					var address = self.userModel.get('USERS_IDX');
					if (personal)
						address = '"' + personal + '" <' + address + '>';
					this.$to = $('<input />', {
						type : 'hidden',
						name : 'M_TO',
						value : address,
					}).inputbox({
						containment : 'parent',
					}).appendTo(this.$el.find('form:first'));
					setTimeout(function() {
						self.$el.find('input[name="M_TITLE"]').focus();
					}, 250);
				}
				// Cc: 
				autocompleteOptions = _.extend(mail.autocompleteOptions, {
					position : _.extend(position, {
						of : this.$el.find('#mailCc')
					})
				});
				this.$cc = this.$el.find('input[name="M_CC"]');
				this.$cc.inputbox({
					containment : 'parent',
					autocompleteOptions : autocompleteOptions,
					focus : function(event, ui) {
						self.$cc.parent('div.mc-mInput_holder').addClass('mInput_over');
						self.$to.parent('div.mc-mInput_holder').removeClass('mInput_over');
						self.$bcc.parent('div.mc-mInput_holder').removeClass('mInput_over');
						self.$focusedInput = self.$cc;
						if (self.$to.inputbox('input').hasClass('ui-state-disabled')) {
							self.$to.inputbox('on', 'blur');
							self.$to.inputbox('input').removeClass('ui-state-disabled').blur();
							setTimeout(function() {
								self.$cc.inputbox('focus');
							}, 250);
						}
						if (self.$bcc.inputbox('input').hasClass('ui-state-disabled')) {
							self.$bcc.inputbox('on', 'blur');
							self.$bcc.inputbox('input').removeClass('ui-state-disabled').blur();
							setTimeout(function() {
								self.$cc.inputbox('focus');
							}, 250);
						}
						self.$autocomplete.position(_.extend(position, {
							of : self.$el.find('#mailCc')
						}));
						hideSignature();
						hideStationery();
						hideDocumentForm();
					},
					keydown : keydown,
				});
				if (this.params && this.params.cc) {
					if (typeof this.params.cc === 'string')
						this.$cc.inputbox('add', this.params.cc);
					else if (typeof this.params.cc === 'object' && this.params.cc.join && this.params.cc.length)
						this.$cc.inputbox('add', this.params.cc.join(','));
				}
				// Bcc: 
				autocompleteOptions = _.extend(mail.autocompleteOptions, {
					position : _.extend(position, {
						of : this.$el.find('#mailBcc')
					})
				});
				this.$bcc = this.$el.find('input[name="M_BCC"]');
				this.$bcc.inputbox({
					containment : 'parent',
					autocompleteOptions : autocompleteOptions,
					focus : function(event, ui) {
						self.$bcc.parent('div.mc-mInput_holder').addClass('mInput_over');
						self.$to.parent('div.mc-mInput_holder').removeClass('mInput_over');
						self.$cc.parent('div.mc-mInput_holder').removeClass('mInput_over');
						self.$focusedInput = self.$bcc;
						if (self.$to.inputbox('input').hasClass('ui-state-disabled')) {
							self.$to.inputbox('on', 'blur');
							self.$to.inputbox('input').removeClass('ui-state-disabled').blur();
							setTimeout(function() {
								self.$bcc.inputbox('focus');
							}, 250);
						}
						if (self.$cc.inputbox('input').hasClass('ui-state-disabled')) {
							self.$cc.inputbox('on', 'blur');
							self.$cc.inputbox('input').removeClass('ui-state-disabled').blur();
							setTimeout(function() {
								self.$bcc.inputbox('focus');
							}, 250);
						}
						if (self.$autocomplete)
							self.$autocomplete.position(_.extend(position, {
								of : self.$el.find('#mailBcc')
							}));
						hideSignature();
						hideStationery();
						hideDocumentForm();
					},
					keydown : keydown,
				});
				if (this.params && this.params.bcc) {
					if (typeof this.params.bcc === 'string')
						this.$bcc.inputbox('add', this.params.bcc);
					else if (typeof this.params.bcc === 'object' && this.params.bcc.join && this.params.bcc.length)
						this.$bcc.inputbox('add', this.params.bcc.join(','));
				}
				// [  /]
				var $toggleBcc = this.$el.find('a.bcc-recipients-toggle');
				var $toggleImg = $toggleBcc.children('img');
				$toggleBcc.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $bccField = self.$el.find('tr.bcc-recipients-field:first');
					if ($toggleImg.hasClass('sOpen')) {
						$toggleImg.removeClass().addClass('sClose');
						$bccField.hide();
					} else {
						$toggleImg.removeClass().addClass('sOpen');
						$bccField.show();
					}
					return false;
				});
				if (this.params && this.params.bcc) {
					$toggleBcc.click();
				}
				// [   &   /]
				this.$toggleContacts = this.$el.find('div.btn_recentaddr a');
				this.$toggleContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					self.$toggleContacts.not($this).removeClass();
					if ($this.hasClass('on')) {
						$this.removeClass();
						self.$autocomplete.hide();
					} else {
						$this.addClass('on');
						self.$autocomplete.show();
					}
					var of = self.$el.find('#mailTo');
					switch ($this.data('rcpt-type')) {
					case 'to':
						of = self.$el.find('#mailTo');
						self.$to.inputbox('focus');
						break;
					case 'cc':
						of = self.$el.find('#mailCc');
						self.$cc.inputbox('focus');
						break;
					case 'bcc':
						of = self.$el.find('#mailBcc');
						self.$bcc.inputbox('focus');
						break;
					}
					self.$autocomplete.position(_.extend(position, {
						of : of
					}));
					self.$recentContacts.addClass('selected');
					self.$importantContacts.removeClass('selected');
					self.dropdownContactsView.renderRecentContacts();
					return false;
				});
				// [Contacts ]
				var $contacts = this.$el.find('div.btn_majoraddr a.address');
				$contacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = 'popup/contacts';
					if (isPopup())
						url = '../popup/contacts';
					var openedWindow = window.open(url, 'mailContacts', 'width=800,height=600,resizable=yes');
					openedWindow.focus();
					return false;
				});
				var $orgs = this.$el.find('div.btn_majoraddr a.org');
				$orgs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = 'http://portal.seoultech.ac.kr/orgChart.face?m=resOrgChartEmailReceiverView';
					var openedWindow = window.open(url, 'mailContacts', 'width=800,height=600,resizable=yes');
					openedWindow.focus();
					return false;
				});
				// Clear Recipient Inputs & Dropdown Contacts
				var clearInputs = function(focusTarget) {
					self.$to.parent('div.mc-mInput_holder').removeClass('mInput_over');
					self.$cc.parent('div.mc-mInput_holder').removeClass('mInput_over');
					self.$bcc.parent('div.mc-mInput_holder').removeClass('mInput_over');
					if (self.$to.inputbox('input').hasClass('ui-state-disabled')) {
						self.$to.inputbox('on', 'blur');
						self.$to.inputbox('input').removeClass('ui-state-disabled').blur();
						setTimeout(function() {
							focusTarget.focus();
						}, 250);
					}
					if (self.$cc.inputbox('input').hasClass('ui-state-disabled')) {
						self.$cc.inputbox('on', 'blur');
						self.$cc.inputbox('input').removeClass('ui-state-disabled').blur();
						setTimeout(function() {
							focusTarget.focus();
						}, 250);
					}
					if (self.$bcc.inputbox('input').hasClass('ui-state-disabled')) {
						self.$bcc.inputbox('on', 'blur');
						self.$bcc.inputbox('input').removeClass('ui-state-disabled').blur();
						setTimeout(function() {
							focusTarget.focus();
						}, 250);
					}
					self.$toggleContacts.removeClass();
					self.$autocomplete.hide();
				};
				// Subject: 
				this.$subject = this.$el.find('input[name="M_TITLE"]');
				if (this.params && this.params.subject) {
					this.$subject.val(this.params.subject);
				}
				this.$subject.focus(function(event) {
					clearInputs($(this));
					hideSignature();
					hideStationery();
					hideDocumentForm();
					return false;
				});
				this.$subject.keydown(function(event) {
					switch (event.keyCode) {
					case 9: // Tab
						Editor.focus();
						return false;
					}
				});
				// Editor View
				var font = this.userModel.get('COMPOSE_FONT');
				var fontSize = this.userModel.get('COMPOSE_FONT_SIZE');
				var format = this.userModel.get('COMPOSE_FORMAT');
				this.editorView = new mail.DaumEditorView({
					config : {
						fontFamily : (font && font != 'none' ? font : i18n.editor.Gulim),
						fontSize : (fontSize ? fontSize + 'pt' : '10pt'),
						selectedMode : (format ? format : 'html'),
					},
					clearInputs : clearInputs,
					hideSignature : function() {
						hideSignature();
					},
					hideStationery : function() {
						hideStationery();
					},
					hideDocumentForm : function() {
						hideDocumentForm();
					},
					contentLayoutView : this.parentView,
				});
				this.editorView.render();
				var $editorContainer = this.$el.find('.mc-editorFrame:first');
				$editorContainer.append(this.editorView.$el);
				$editorContainer.on('dragenter', function(event) {
					var dataTransfer = event.originalEvent.dataTransfer;
					var types = dataTransfer.types;
					if (types) {
						if ((types.contains && types.contains("Files"))
								|| (types.indexOf && types.indexOf("Files") !== -1)) {
							event.preventDefault();
							app.debug('Daum Editor dragenter <<<<<<<<<<<<<<<<<<<<<<<<<<');
						}
					}
				});
				$editorContainer.on('dragover', function(event) {
					event.preventDefault() && event.stopPropagation();
					app.debug('Daum Editor dragover <<<<<<<<<<<<<<<<<<<<<<<');
					return false;
				});
				$editorContainer.on('drop', function(event) {
					event.preventDefault() && event.stopPropagation();
					app.debug('Daum Editor drop <<<<<<<<<<<<<<<<<<<<<<<');
					var files = event.originalEvent.dataTransfer.files;
					$.each(files, function(index, file) {
						if (file.type.indexOf('image/') != -1)
							return;
						self.attachmentsView.addAttachment(file);
					});
					var cids = [];
					var formData = new FormData();
					$.each(files, function(index, file) {
						if (file.type.indexOf('image/') == -1)
							return;
						var name = cid + '.' + index;
						if (file.name && file.name.indexOf('.') != -1)
							name += file.name.substring(file.name.lastIndexOf('.'));
						cids.push(name);
						formData.append(name, file);
					});
					var url = 'inline';
					if (isPopup())
						url = '../inline';
					var xhr = new XMLHttpRequest();
					xhr.open('POST', url);
					xhr.upload.onprogress = function(event) {
						// _showOverlay();
					};
					xhr.upload.onabort = function(event) {
						// _hideOverlay();
					};
					xhr.upload.onload = function(event) {
						var $div = $('<div />');
						$.each(cids, function(index, cid) {
							$div.empty();
							var src = 'inline/';
							if (isPopup())
								src = '../inline/';
							var $img = $('<img>', {
								'src' : src + cid,
								'border' : '0',
							});
							$div.append($img);
							var content = $div.html();
							// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Canvas.html#pasteContent
							Editor.getCanvas().pasteContent(content, true);
						});
						// _hideOverlay();
					};
					xhr.send(formData);
					return false;
				});
				// Signature : 
				var $signatureButton = $editorContainer.find('div#tx_signature a');
				var signatureView;
				var signatureCollection = new app.mail.SignatureCollection();
				$signatureButton.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!signatureView) {
						signatureCollection.fetch({
							cache : false,
						});
						signatureView = new mail.SignatureView({
							collection : signatureCollection,
							parentView : self,
							signatureRegion : self.signatureRegion,
						});
						self.signatureRegion.show(signatureView);
					}
					if (signatureView && signatureView.$signatureRegion) {
						signatureView.$signatureRegion.toggle();
						var top = Math.round($editorContainer.position().top + 33);
						signatureView.$signatureRegion.css({
							position : 'absolute',
							top : top,
							right : 15,
						});
					}
					return false;
				});
				var hideSignature = function() {
					if (signatureView && signatureView.$signatureRegion)
						signatureView.$signatureRegion.hide();
				};
				// Stationery: 
				var $stationeryButton = $editorContainer.find('div#tx_stationery a');
				var stationeryPaginator = new mail.StationeryPaginator();
				var stationeryView = new mail.StationeryView({
					collection : stationeryPaginator,
					parentView : this,
					stationeryRegion : this.stationeryRegion,
				});
				stationeryPaginator.fetch({
					success : function(collection, response, options) {
						collection.pager();
						self.stationeryRegion && self.stationeryRegion.show(stationeryView);
					},
					silent : true,
				});
				$stationeryButton.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (stationeryView.$stationeryRegion) {
						stationeryView.$stationeryRegion.toggle();
						var top = Math.round($editorContainer.position().top + 33);
						stationeryView.$stationeryRegion.css({
							position : 'absolute',
							top : top,
							right : 15,
						});
					}
					return false;
				});
				var hideStationery = function() {
					if (stationeryView.$stationeryRegion)
						stationeryView.$stationeryRegion.hide();
				};
				// Document Form: 
				var $formButton = $editorContainer.find('div#tx_document-form a');
				var formView;
				var formPaginator = new mail.FormPaginator();
				formPaginator.clearSearch();
				formPaginator.pager({
					type : 'POST',
					success : function(collection, response, options) {
						formView = new mail.FormView({
							model : new Backbone.Model({
								items : collection.toJSON(),
								totalRecords : collection.totalRecords,
								perPage : collection.perPage,
								currentPage : collection.currentPage,
								searchField : collection.getSearchField(),
								searchTerm : collection.getSearchTerm(),
							}),
							collection : collection,
							parentView : self,
							formRegion : self.formRegion,
						});
						self.formRegion && self.formRegion.show(formView);
					},
					error : function(collection, response, options) {
						alert('Failed to fetch document forms');
					},
				});
				$formButton.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					formPaginator.clearSearch();
					formPaginator.goTo(1);
					if (formView && formView.$formRegion) {
						formView.$formRegion.toggle();
						var top = Math.round($editorContainer.position().top + 33);
						formView.$formRegion.css({
							position : 'absolute',
							top : top,
							right : 15,
						});
					}
					return false;
				});
				var hideDocumentForm = function() {
					if (formView && formView.$formRegion)
						formView.$formRegion.hide();
				};
				var $delayDeliveryWrapper = this.$el.find('div.section_sendopt');
				// Delay Delivery: 
				var $delayDeliverySection = $delayDeliveryWrapper.find('span.cal.rsvTime');
				var $delayDeliveryLink = $delayDeliverySection.find('a.tit');
				var $delayDeliveryBar = $delayDeliverySection.find('span.bar');
				var delayDeliveryText = i18n.scheduleSendingEmail;
				var timeZone = this.userModel.get('USERS_TIMEZONE');
				var timeZoneDate = function(timeZone) {
					var date = new Date();
					if (!timeZone || !/^Z|[+-](?:2[0-3]|[0-1][0-9]):[0-5][0-9]$/.test(timeZone))
						return date;
					var offset = 0;
					if (timeZone !== 'Z') {
						var sign = timeZone.charAt(0);
						var hours = timeZone.substring(1, 3);
						var minutes = timeZone.substring(4, 6);
						offset = parseInt(hours, 10) * 60 + parseInt(minutes, 10);
						offset = sign == '+' ? -(offset) : offset;
					}
					var diff = date.getTimezoneOffset() - offset;
					var time = date.getTime() + diff * 60000;
					date.setTime(time);
					return date;
				};
				var date = timeZoneDate(this.userModel.get('USERS_TIMEZONE'));
				date.setHours(date.getHours() + 1);
				if (date.getMinutes() >= 30)
					date.setMinutes(30);
				var delayDeliveryModel = new Backbone.Model({
					date : $.format.date(date, 'yy-MM-dd'),
					hour : $.format.date(date, 'HH'),
					minute : $.format.date(date, 'mm'),
					dDay : 0,
					timeZone : this.userModel.get('USERS_TIMEZONE'),
				});
				this.listenTo(delayDeliveryModel, 'change', function() {
					var model = delayDeliveryModel;
					var dateString = '20' + model.get('date') + 'T' + model.get('hour') + ':' + model.get('minute')
							+ ':00';
					var parsedDate = $.format.parseDate(dateString);
					var date = parsedDate.date;
					date.setHours(parseInt(parsedDate.time.hour, 10));
					date.setMinutes(parseInt(parsedDate.time.minute, 10));
					var dDay = model.get('dDay');
					if (dDay) {
						date.setDate(date.getDate() + dDay);
					}
					var $form = $(this.attachmentsView.options.form);
					var $delayDateTime = $form.find('input[name="delay-date-time"]');
					var $delayTimeZone = $form.find('input[name="delay-time-zone"]');
					if ($delayDateTime.length == 0) {
						$delayDateTime = $('<input>', {
							'name' : 'delay-date-time',
							'type' : 'hidden',
						});
						$delayTimeZone = $('<input>', {
							'name' : 'delay-time-zone',
							'type' : 'hidden',
						});
						$form.append($delayDateTime).append($delayTimeZone);
					}
					$delayDateTime.val($.format.date(date, 'yyyy-MM-dd HH:mm:ss'));
					var timeZone = model.get('timeZone');
					$delayTimeZone.val(timeZone);
					var $linkClone = $delayDeliveryLink.clone(true);
					var $barClone = $delayDeliveryBar.clone(true);
					$delayDeliveryLink.remove();
					$delayDeliveryBar.remove();
					$delayDeliveryLink = $linkClone;
					$delayDeliveryBar = $barClone;
					var html = '';
					html += '<a href="#">' + $.format.date(date, 'yy/MM/dd(E) HH:mm');
					html += ' (GMT ' + timeZone + ')';
					html += '</a>';
					html += '<a class="btn_del" href="#">';
					if (isPopup())
						html += '<img src="../img/b.gif" />';
					else
						html += '<img src="img/b.gif" />';
					html += '</a>';
					$delayDeliverySection.html(html);
					var $link = $delayDeliverySection.find('a:first');
					$link.click(function(event) {
						event.preventDefault() && event.stopPropagation();
						$linkClone.click();
						return false;
					});
					var $delete = $delayDeliverySection.find('a.btn_del');
					$delete.click(function(event) {
						event.preventDefault() && event.stopPropagation();
						var $linkClone = $delayDeliveryLink.clone(true);
						var $barClone = $delayDeliveryBar.clone(true);
						$delayDeliveryLink.remove();
						$delayDeliveryBar.remove();
						$delayDeliveryLink = $linkClone;
						$delayDeliveryBar = $barClone;
						$delayDeliverySection.text(delayDeliveryText);
						$delayDeliverySection.prepend($barClone);
						$delayDeliverySection.prepend($linkClone);
						$delayDateTime.remove();
						$delayTimeZone.remove();
						return false;
					});
					$delayDeliverySection.prepend($barClone);
					$delayDeliverySection.prepend($linkClone);
				}); // this.listenTo(delayDeliveryModel, 'change', ...);
				var delayDeliveryView = new mail.DelayDeliveryView({
					model : delayDeliveryModel,
					$wrapper : $delayDeliveryWrapper,
				});
				this.delayDeliveryRegion.show(delayDeliveryView);
				this.delayDeliveryRegion.$el.children().appendTo(this.$el);
				$delayDeliveryLink.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					delayDeliveryView.$el.toggle();
					var $offsetParent = $delayDeliveryWrapper.offsetParent();
					var offsetParentPosition = $offsetParent.position();
					var position = $delayDeliveryWrapper.position();
					var height = delayDeliveryView.$tabs.filter('.selected').data('height');
					var top = Math.round(position.top - height);
					var left = position.left;
					delayDeliveryView.$el.css({
						position : 'absolute',
						top : top,
						left : left,
						bottom : '40px',
					});
					return false;
				});
				// Alias
				if (this.userModel.get('ALIAS_ENABLED')) {
					var aliasCollection = new app.user.AliasCollection();
					aliasCollection.fetch({
						async : false,
						wait : true,
					});
					var aliasModels = aliasCollection.filter(function(aliasModel) {
						var isValid = aliasModel.get('ACCOUNT_ISVALID');
						var isDated = aliasModel.get('ACCOUNT_ISDATED');
						var startDate = aliasModel.get('ACCOUNT_SDATE');
						var endDate = aliasModel.get('ACCOUNT_EDATE');
						var now = $.format.date(new Date(), 'yyyy-MM-dd');
						return isValid && (!isDated || (now >= startDate && now <= endDate));
					});
					if (aliasModels.length) {
						var $senderSettings = self.$el.find('tr.sender-settings');
						var $senderSelect = $senderSettings.find('select[name=M_SENDER]')
						var options = [];
						options.push($('<option></option>').val(self.userModel.get('USERS_IDX')).text(
								self.userModel.get('USERS_IDX')));
						aliasModels.each(function(aliasModel) {
							var $option = $('<option></option>');
							$option.val(aliasModel.get('ACCOUNT_IDX'));
							$option.text(aliasModel.get('ACCOUNT_IDX'));
							options.push($option);
						});
						$senderSelect.append(options);
						$senderSettings.show();
					}
				}
			},
			onShow : function() {
				var self = this;
				this.$autocomplete = this.$el.find('div#autoComplete:first');
				this.dropdownContactsView = new mail.DropdownContactsView({
					parentView : this
				});
				var offInputboxBlur = function() {
					var $input = self.$focusedInput.inputbox('input');
					if ($input.hasClass('ui-state-disabled')) {
						$input.removeClass('ui-state-disabled');
					}
					$input.focus(function(event) {
						self.$focusedInput.inputbox('on', 'blur');
					});
					self.$to.inputbox('input').autocomplete('close');
					self.$cc.inputbox('input').autocomplete('close');
					self.$bcc.inputbox('input').autocomplete('close');
					self.$focusedInput.inputbox('off', 'blur');
				};
				this.$recentContacts = this.$el.find('img.ico_recent:first').parent('a');
				this.$recentContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$importantContacts.removeClass('selected');
					$(this).addClass('selected');
					self.dropdownContactsView.renderRecentContacts();
					offInputboxBlur();
					if (self.$autocomplete.is(':hidden'))
						self.$autocomplete.show();
					return false;
				});
				this.$importantContacts = this.$el.find('img.ico_important:first').parent('a');
				this.$importantContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$recentContacts.removeClass('selected');
					$(this).addClass('selected');
					self.dropdownContactsView.renderImportantContacts();
					offInputboxBlur();
					if (self.$autocomplete.is(':hidden'))
						self.$autocomplete.show();
					return false;
				});
				var popup = isPopup();
				if (popup && window.opener && !window.opener.closed) {
					var openerApp = window.opener.require('app');
					app.domainModel = openerApp.domainModel;
					app.diskUserModel = openerApp.diskUserModel;
					app.diskFileFilterCollection = openerApp.diskFileFilterCollection;
				}
				if (!popup) {
					app.domainModel.fetch();
					app.diskUserModel.fetch({
						error : function(model, response, options) {
							app.log('Failed to fetch disk.UserModel');
						}
					});
					app.diskFileFilterCollection.fetch({
						error : function(collection, response, options) {
							app.log('Failed to fetch disk.FileFilterCollection');
						}
					});
				}
				this.attachmentsView = new mail.AttachmentsView({
					model : app.diskUserModel,
					parentView : this,
					fileUploadURL : (popup ? '../attachments/file' : 'attachments/file'),
					blobUploadURL : (popup ? '../attachments/blob' : 'attachments/blob'),
					blobQuotaURL : (popup ? '../bigmail.file.do?cmd=bigmailAttacheQuota'
							: 'bigmail.file.do?cmd=bigmailAttacheQuota'),
					filesMaxSize : app.domainModel.get('DOMAIN_LIMIT_UPLOAD') * 1024 * 1024,
					blobExpirationDays : app.diskUserModel.get('BIGMAIL_VALIDITY_DAYS'),
					blobPasswordRequired : app.diskUserModel.get('BIGMAIL_PASSWORD_REQUIRED'),
					attachments : this.params.attachments || [],
					files : this.params.files,
					blobOptionsRegion : this.blobOptionsRegion,
					zIndex : 2015,
				});
				this.$toggleAttachments = this.$el.find('a.toggle-attachments');
				var $toggleImg = this.$toggleAttachments.children('img');
				this.$toggleAttachments.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $dropzone = self.attachmentsView.$el.find('div.attachments-dropzone');
					var $header = $dropzone.find('div.attachments-list-header');
					var $content = $dropzone.find('div.attachments-list-content');
					var $footer = self.attachmentsView.$el.find('div.attachments-footer');
					if ($toggleImg.hasClass('sOpen')) {
						$toggleImg.removeClass().addClass('sClose');
						$header.hide();
						$content.hide();
						$footer.hide();
						$dropzone.hide();
					} else {
						$toggleImg.removeClass().addClass('sOpen');
						$header.show();
						$content.show();
						$footer.show();
						$dropzone.show();
					}
					return false;
				});
				this.attachmentsView.render();
				this.editorView.onShow();
				if (this.params && this.params.content) {
					this.editorView.setContent(this.params.content);
				}
				this._hideLoadingOverlay();
				if (this.params && this.params.to) {
					setTimeout(function() {
						if (self.params && self.params.subject)
							Editor.focus();
						else
							self.$subject.focus();
					}, 250);
				} else {
					this.$to.inputbox('focus');
				}
				this._autoSave();
			},
			onClose : function() {
				delete this.options
				delete this.userModel; // app.userModel
				delete this.params;
				delete this.composeRegion;
				delete this.signatureRegion;
				delete this.stationeryRegion;
				delete this.formRegion;
				delete this.delayDeliveryRegion;
				delete this.blobOptionsRegion;
				delete this.parentView;
				clearInterval(this.intervalId);
				this.attachmentsView.close();
				delete this.attachmentsView;
				if (this.droppableView) {
					this.droppableView.close();
					delete this.droppableView;
				}
			},
			_autoSave : function() {
				var self = this;
				var interval = this.userModel.get('AUTOSAVE_INTERVAL');
				if (interval > 0) {
					interval = interval * 1000;
					if (this.intervalId) {
						clearInterval(this.intervalId);
					}
					this.intervalId = setInterval(function() {
						if (self.composeRegion.$el.is(':hidden')) {
							clearInterval(self.intervalId);
							self.intervalId = null;
							return;
						}
						self.submitForm('draft');
					}, interval);
				}
			},
			_showOverlay : function() {
				this.$overlay = $('#compose-overlay');
				if (!this.$overlay.length) {
					if (document.styleSheets && document.styleSheets[0]) {
						var styles = '';
						styles += '-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";';
						styles += 'filter: alpha(opacity=50);';
						styles += '-moz-opacity: 0.5;';
						styles += '-khtml-opacity: 0.5;';
						styles += 'opacity: 0.5;';
						var styleSheet = document.styleSheets[0];
						var rules;
						try {
							rules = styleSheet.cssRules || styleSheet.rules;
						} catch (error) {
							styleSheet = _.find(document.styleSheets, function(styleSheet) {
								var href = styleSheet.href;
								var css = href.substring(href.lastIndexOf('/') + 1);
								return css == 'default.css';
							});
							rules = styleSheet.cssRules || styleSheet.rules;
						}
						if (styleSheet.insertRule) {
							styleSheet.insertRule('#compose-overlay{' + styles + '}', rules.length);
						} else if (styleSheet.addRule) {
							styleSheet.addRule('#compose-overlay', styles, rules.length);
						}
					}
					this.$overlay = $('<div id="compose-overlay"/>').css({
						'z-index' : 2015,
						'position' : 'absolute',
						'top' : '0',
						'left' : '0',
						'width' : '100%',
						'height' : '100%',
						'background' : 'black',
						'opacity' : '0.5',
					}).appendTo('body');
					this.$overlay.on('mousedown', function(event) {
						event.preventDefault() && event.stopPropagation();
					});
				}
				this.$overlay.show();
			},
			_hideOverlay : function() {
				this.$overlay && this.$overlay.hide();
			},
			_showLoadingOverlay : function() {
				this._showOverlay();
				this.$loadingOverlay = this.$overlay.children('.loading-compose');
				if (this.$loadingOverlay.length) {
					this.$loadingOverlay.show();
					return;
				}
				var zIndex = this.$overlay.css('z-index');
				var $loadingLayer = $('<div class="loading-compose"/>').css({
					'z-index' : isNaN(zIndex) ? 'auto' : parseInt(zIndex) + 1,
					'position' : 'absolute',
					'text-align' : 'center'
				}).appendTo(this.$overlay);
				var url = 'img/loading_span_bg.png';
				if (isPopup())
					url = '../img/loading_span_bg.png';
				var $loadingOuter = $('<span />').css({
					'display' : 'inline-block',
					'background' : 'transparent url(' + url + ') no-repeat',
					'background-position' : 'left top',
					'padding-left' : '2px',
				}).appendTo($loadingLayer);
				var $loadingInner = $('<span />').css({
					'display' : 'inline-block',
					'background' : 'transparent url(' + url + ') no-repeat',
					'background-position' : 'right -49px',
					'padding-right' : '2px',
				}).appendTo($loadingOuter);
				var $loadingContent = $('<span />').css({
					'display' : 'inline-block',
					'background' : 'transparent url(' + url + ') repeat-x',
					'background-position' : 'left -98px',
					'line-height' : '39px',
					'padding' : '0 18px 0 9px',
					'color' : '#fff',
				}).appendTo($loadingInner);
				var src = 'img/ico_ld_cm.gif';
				if (isPopup())
					src = '../img/ico_ld_cm.gif';
				$loadingContent.append($('<img />', {
					src : src,
					width : 17,
					height : 17,
					style : 'vertical-align: middle; margin-right: 10px',
				}));
				$loadingContent.append(document.createTextNode(i18n.overlay.leadingLoading));
				$loadingContent.append('<strong>' + i18n.overlay.composeMail + '</strong>');
				$loadingContent.append(document.createTextNode(i18n.overlay.trailingLoading));
				var $viewport = $(window);
				$viewport.off('resize.loadingCompose');
				$viewport.on('resize.loadingCompose', function(event) {
					var viewportWidth = $viewport.width() / 2;
					var viewportHeight = $viewport.height() / 2;
					var width = $loadingLayer.width() / 2;
					var height = $loadingLayer.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					$loadingLayer.css({
						'top' : top,
						'left' : left
					});
				});
				$viewport.trigger('resize.loadingCompose');
			},
			_hideLoadingOverlay : function() {
				this.$loadingOverlay && this.$loadingOverlay.hide();
				this._hideOverlay();
			},
			preview : function() {
				this.submitForm('preview');
			},
			draft : function() {
				this.submitForm('draft');
			},
			sendSecure : function() {
				var self = this;
				var isValidForm = this._validateForm();
				if (!isValidForm) {
					return;
				}
				if (this.sendSecureMailView) {
					this.sendSecureMailView.close();
				}
				var zIndex = mail.overlayView.$overlay.css('z-index');
				this.sendSecureMailView = new mail.SendSecureMailView({
					model : new Backbone.Model({
						to : this.$to.val(),
						cc : this.$cc.val(),
						bcc : this.$bcc.val(),
					}),
				});
				var $sendSecureMailView = this.sendSecureMailView.render().$el;
				$sendSecureMailView.css('z-index', parseInt(zIndex) + 1);
				$sendSecureMailView.show().appendTo('body');
				var $viewport = $(window);
				$viewport.off('resize.sendSecureMail');
				$viewport.on('resize.sendSecureMail', function(event) {
					var parentWidth = $viewport.width() / 2;
					var parentHeight = $viewport.height() / 2;
					var width = $sendSecureMailView.width() / 2;
					var height = $sendSecureMailView.height() / 2;
					var top = Math.floor(parentHeight - height);
					var left = Math.floor(parentWidth - width);
					$sendSecureMailView.css({
						'top' : top,
						'left' : left
					});
				});
				$viewport.trigger('resize.sendSecureMail');
			},
			sendSecureMail : function(data) {
				this.secureMails = data.secureMails;
				this.send();
			},
			requireBlobPassword : function() {
				var self = this;
				var blobItems = [];
				var $items = this.attachmentsView.getAttachmentItems();
				var $blobItems = $items.filter(function(index, element) {
					var type = $(element).data('attachment-type');
					if (type === 'blob')
						return true;
				});
				if ($blobItems.length == 0) {
					return false;
				}
				var blobPassword;
				$blobItems.each(function(index, element) {
					if (!blobPassword && $(element).data('blob-password'))
						blobPassword = $(element).data('blob-password');
				});
				if (blobPassword) {
					$blobItems.each(function(index, element) {
						$(element).data('blob-password', blobPassword);
					});
					return false;
				}
				if (!app.diskUserModel.get('BIGMAIL_PASSWORD_REQUIRED')) {
					return false;
				}
				this._hideOverlay();
				var region = new (Backbone.Marionette.Region.extend({
					el : 'div.mc-container:first',
					open : function(view) {
						this.$el.append(view.$el);
					}
				}))();
				var blobPasswordView = new mail.BlobPasswordView({
					model : new Backbone.Model({}),
					$blobItems : $blobItems
				});
				region.show(blobPasswordView);
				return true;
			},
			send : function() {
				var self = this;
				this._showOverlay();
				var isValidForm = this._validateForm();
				if (!isValidForm) {
					this._hideOverlay();
					return;
				}
				if (!this.previewBeforeSending) {
					this.previewBeforeSending = self.userModel.get('PREVIEW_BEFORE_SENDING');
					switch (this.previewBeforeSending) {
					case 'all':
						this._hideOverlay();
						this.submitForm('preview');
						return;
					case 'important':
						var $form = $(this.attachmentsView.options.form);
						var $priority = $form.find('input[name="M_PRIORITY"]');
						if ($priority.is(':checked')) {
							this._hideOverlay();
							this.submitForm('preview');
							return;
						}
						break;
					case 'none':
					default:
						break;
					}
				}
				var domainSendingQuota = app.domainModel.get('DOMAIN_MAIL_QUOTA');
				if (domainSendingQuota > 0)
					this.userModel.fetch({
						async : false
					});
				var userSendingQuota = this.userModel.get('USERS_MAIL_QUOTA');
				if (domainSendingQuota > 0 && userSendingQuota <= 0) {
					this._hideOverlay();
					var msg = i18n.leadingMaxSending + domainSendingQuota + i18n.trailingMaxSending;
					alert(msg);
					return;
				}
				if (this.requireBlobPassword()) {
					this._hideOverlay();
					return;
				}
				var upload = this.attachmentsView.upload();
				upload.done(function() {
					self.submitForm('send');
				}).fail(function() {
					if (this.xhr.status != 406)
						alert(i18n.attachment.failedToUpload);
				}).always(function() {
					self._hideOverlay();
				});
			},
			_validateForm : function() {
				var options = this.attachmentsView.options;
				var $inputs = $(options.form).find('input');
				var $invalidRecipient = $(options.form).find('ul.inputbox-list').find('li.inputbox-item.invalid.text');
				if($invalidRecipient.length > 0){
					alert(i18n.invalidRecipient);
					return false;
				}
				for (var i = 0; i < $inputs.length; i++) {
					var $input = $inputs.eq(i);
					var name = $input.attr('name');
					var value = $input.val();
					switch (name) {
					case 'M_TO':
						if (!value) {
							alert(i18n.emptyTo);
							return false;
						}
						var rcptCount = $(options.form).find('div#mailTo').find('div.text-wrapper').length-1
						try {
							var IACount = InternetAddress.parseHeader(value, false).length;
						} catch (e) {
							alert(e)
							return false;
						}
						if(rcptCount != IACount && rcptCount > 0){
							alert(i18n.faultAddrTo);
							return false;
						}
						break;
					case 'M_CC':
						if (value) {
							var rcptCount = $(options.form).find('div#mailCc').find('div.text-wrapper').length-1
							try {
								var IACount = InternetAddress.parseHeader(value, false).length;
							} catch (e) {
								alert(e);
								return false;
							}
							if(rcptCount != IACount && rcptCount > 0){
								alert(i18n.faultAddrCc);
								return false;
							}
						}
						break;	
					case 'M_BCC':
						if (value) {
							var rcptCount = $(options.form).find('div#mailBcc').find('div.text-wrapper').length-1
							try {
								var IACount = InternetAddress.parseHeader(value, false).length;
							} catch (e) {
								alert(e);
								return false;
							}
							if(rcptCount != IACount && rcptCount > 0){
								alert(i18n.faultAddrBcc);
								return false;
							}
						}
						break;
					case 'M_TITLE':
						if (!value) {
							alert(i18n.emptySubject);
							return false;
						}
						break;
					}
				}
				return true;
			},
			submitForm : function(action) {
				var self = this;
				if (!this.mailModel) {
					this.mailModel = new mail.MailModel();
				}
				var mailModel = this.mailModel.clone();
				var attachmentsView = this.attachmentsView;
				var options = this.attachmentsView.options;
				var $form = $(options.form);
				var attachments = [];
				var sender = $form.find('select[name=M_SENDER]').val();
				if (sender && sender != mailModel.get('M_SENDER'))
					mailModel.set('M_SENDER', sender);
				var recipients = 0;
				$form.find('input').each(function(index, element) {
					var $input = $(element);
					var name = $input.attr('name');
					var value = $input.val();
					switch (name) {
					case 'M_SENDERNM':
					case 'M_TO':
					case 'M_CC':
					case 'M_BCC':
					case 'M_TITLE':
						if (value != mailModel.get(name))
							mailModel.set(name, value);
						if (value && (name === 'M_TO' || name === 'M_CC' || name === 'M_BCC'))
							recipients = recipients + value.split(',').length;
						break;
					case 'M_PRIORITY':
						value = $input.is(':checked') ? 1 : 3;
						if (action === 'send')
							mailModel.set('M_PRIORITY', value);
						break;
					case 'individual-mails':
						value = $input.is(':checked') ? true : false;
						if (action === 'send' || action === 'preview')
							mailModel.set('individual', value);
						break;
					case 'delay-date-time':
						if (action === 'send')
							mailModel.set('delayDateTime', value);
						break;
					case 'delay-time-zone':
						if (action === 'send')
							mailModel.set('delayTimeZone', value);
						break;
					case options.fileInputName:
						if (value) {
							var size = $input.data('file-size');
							attachments.push({
								num : index,
								name : value,
								size : isNaN(size) ? 0 : parseInt(size),
								type : 'file'
							});
						}
						break;
					case options.blobInputName:
						if (value) {
							var size = $input.data('file-size');
							attachments.push({
								num : index,
								name : value,
								size : isNaN(size) ? 0 : parseInt(size),
								type : 'blob'
							});
						}
						break;
					}
				});
				
				if (action === 'send') {
					if(recipients >= 300) {
						mailModel.set('individual', true);
					} else if (recipients >= 2 && !mailModel.get('individual')){
						if(!confirm(i18n.manyRecipientsMessage)){
							return false;
						}
					} else if (recipients >= 2 && mailModel.get('individual')){
						if(!confirm(i18n.individualMessage)){
							return false;
						}
					}
				}
				
				var content = this.editorView.getContent();
				var backgroundImage = Editor.getCanvas().getPanel(Editor.getCanvas().mode).getStyle('backgroundImage');
				if (backgroundImage != 'none') {
					var html = '';
					html += '<table width="100%" height="350" border="0" cellpadding="0" cellspacing="1"'
							+ ' align="left">';
					html += '<tr valign="top">';
					html += "<td bgcolor='#ffffff' style='padding:8px; background-image:" + backgroundImage + "'>";
					html += content;
					html += '</td>';
					html += '</tr>';
					html += '</table>';
					content = html;
				}
				content = mailModel._validateHTML(content);
				var frag = document.createDocumentFragment();
				var $content = $('<div></div>', frag).html(content);
				$content.find('*').filter(function(index, element) {
					return mailModel.filterElements(index, element);
				});
				content = $content.html();
				var bodyText = $content.text();
				if (!bodyText && $content.find('img[src]').length) {
					bodyText += ' ';
				}
				if (bodyText && content != mailModel.get('M_CONTENT')) {
					// 2019.08.14 :   ,     (,  )
					try {
						var font = this.userModel.get('COMPOSE_FONT');
						var fontSize = this.userModel.get('COMPOSE_FONT_SIZE');
						i18n.editor.fontfamilyOptions.each(function(fontfamily) {
							if (fontfamily.title == font) {
								font = fontfamily.data;
							}
						});
						var html = '<div style="font-family: ';
						html += font + '; font-size: ' + fontSize + 'pt;">';
						html += content + '</div>';
						content = html;
					} catch (e) {
						app.log(e);
					}
					mailModel.set('M_CONTENT', content);
					if (bodyText != mailModel.get('bodyText'))
						mailModel.set('bodyText', bodyText);
				}
				switch (action) {
				case 'send':
					mailModel.set({
						action : action,
						attachments : attachments,
					});
					if (this.secureMails) {
						var secureMailIds = [];
						for (var i = 0; i < this.secureMails.length; i++) {
							secureMailIds.push(this.secureMails[i].id);
						}
						mailModel.set('secureMailIds', secureMailIds);
					}
					mailModel.save(null, {
						async : false,
						wait : true,
						success : function(model, resp, options) {
							self.updateFlags();
							if (app.config.approvalMail.enabled && app.domainDetailsModel.get('approvalEnabled')) {
								var reportModel = model.get('report');
								if (reportModel && reportModel.filtered) {
									var policyModel = new mail.ApprovalPolicyModel(reportModel.policy);
									var approverCollection = new mail.ApproverCollection(reportModel.policy.approvers);
									var filterCollection = new mail.ApprovalFilterCollection(reportModel.filters);
									if (self.approvalPolicyView) {
										self.approvalPolicyView.close();
									}
									var zIndex = mail.overlayView.$overlay.css('z-index');
									self.approvalPolicyView = new mail.ApprovalPolicyView({
										model : new Backbone.Model({
											policyModel : policyModel,
											filterCollection : filterCollection,
											approverCollection : approverCollection,
										}),
										composeMailView : self,
										mailModel : model,
										parentView : self,
									});
									var $approvalPolicyView = self.approvalPolicyView.render().$el;
									$approvalPolicyView.css('z-index', parseInt(zIndex) + 1);
									$approvalPolicyView.show().appendTo('body');
									self.approvalPolicyView._centerLayerInWindow();
									return;
								}
							}
							location.hash = '#sent-mail';
							app.vent.trigger('show:sent-mail', mailModel);
						},
						error : function(model, resp, options) {
							var msg = i18n.failedToSendMail;
							if (!resp) {
								alert(msg);
								return;
							}
							var responseText = resp.responseText ? resp.responseText : '';
							switch (resp.status) {
							case 413:
								if (responseText.indexOf('recipients exceeded the maximum number of allowed') != -1) {
									var numOfRecipients = self.$to.inputbox('size') + self.$cc.inputbox('size')
											+ self.$bcc.inputbox('size');
									if (resp.responseJSON && resp.responseJSON.detail) {
										msg = resp.responseJSON.detail.message;
										if (typeof msg == 'string')
											numOfRecipients = msg.substring(0, msg.indexOf(' '));
									}
									msg = i18n.leadingMaxRecipients + self.userModel.get('MAX_MAIL_RECIPIENTS');
									msg += i18n.middlingMaxRecipients + numOfRecipients + i18n.trailingMaxRecipients;
									alert(msg);
									break;
								}
							case 503: // statusText: Service Unavailable
								if (responseText.indexOf('Exceeded Sending Quota') != -1) {
									msg = i18n.leadingMaxSending + app.domainModel.get('DOMAIN_MAIL_QUOTA')
											+ i18n.trailingMaxSending;
									alert(msg);
									self.userModel.fetch();
									break;
								}
							default:
								alert(i18n.failedToSendMail);
							}
						},
					});
					break;
				case 'draft':
					if (mailModel.isNew()) {
						if (!mailModel.get('M_TO') && !mailModel.get('M_TITLE') && !mailModel.get('M_CONTENT'))
							return;
					}
					if (!mailModel.hasChanged()) {
						return;
					}
					mailModel.set('action', action);
					mailModel.save(null, {
						async : true,
						wait : true,
						success : function(model, resp, options) {
							app.vent.trigger('update:draft');
							self.mailModel = model;
						},
						error : function(model, resp, options) {
							alert(i18n.failedToSaveDraft);
						},
					});
					break;
				case 'changed':
					if (mailModel.isNew()) {
						if (!mailModel.get('M_TO') && !mailModel.get('M_TITLE') && !mailModel.get('M_CONTENT'))
							return false;
					}
					return mailModel.hasChanged();
				case 'preview':
					var $items = attachmentsView.getAttachmentItems();
					var preview = new mail.ComposeMailPreviewView({
						model : new Backbone.Model({
							mailModel : mailModel,
							attachment : $items,
						}),
						composeMailView : this,
					});
					if (!this.previewBeforeSending) {
						this.previewBeforeSending = this.userModel.get('PREVIEW_BEFORE_SENDING');
					}
					preview.render();
					return;
				}
			},
			updateFlags : function() {
				if (mail.mboxModel && mail.mboxModel.get('SHARED_MBOX_ID') > 0)
					return;
				switch (this.params.action) {
				case 'reply':
				case 'reply-to-all':
					if (this.params.id) {
						var model = new mail.MailModel({
							M_IDX : this.params.id
						});
						model.save({
							M_ISREAD : 'R',
						}, {
							patch : true,
							async : false
						});
					}
					break;
				case 'forward':
					if (this.params.id && (typeof this.params.id == 'string')) {
						var model = new mail.MailModel({
							M_IDX : this.params.id
						});
						model.save({
							M_ISREAD : 'F',
						}, {
							patch : true,
							async : false,
						});
					} else if (this.params.id && $.isArray(this.params.id)) {
						var mailIds = this.params.id;
						for (var i = 0; i < mailIds.length; i++) {
							var model = new mail.MailModel({
								M_IDX : mailIds[i]
							});
							model.save({
								M_ISREAD : 'F',
							}, {
								patch : true,
								async : false,
							});
						}
					}
					break; // case 'forward':
				} // end switch (this.params.action) {...}
			}
		}); // mail.ComposeMailView

		mail.ComposeMailPreviewView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ComposeMailPreviewView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-write-preview-template').html();
					compiledTemplate = _.template(html);
					mail.ComposeMailPreviewView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mailModel : data.mailModel,
					attachment : data.attachment,
					user : app.userModel,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.composeMailView = options.composeMailView;
				var self = this;
				this.normalFileSize = 0;
				this.bigmailFileSize = 0;
				this.normalFileCnt = 0;
				this.bigmailFileCnt = 0;
				var $items = this.model.get('attachment');
				$items.each(function(index, item) {
					var data = $(item).data();
					if (data.attachmentType == 'file') {
						self.normalFileSize += data.attachmentSize;
						self.normalFileCnt++;
					} else {
						self.bigmailFileSize += data.attachmentSize;
						self.bigmailFileCnt++;
					}
				});
			},
			onRender : function() {
				var self = this;
				//   
				this.$layer = this.$el.children().appendTo('body');
				this._centerLayerInWindow(this.$layer);
				this.$layer.show();

				var $close = this.$layer.find('.ic_cancle:first');
				var $modify = this.$layer.find('#closeLayerBtn:first');
				$close.add($modify).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.composeMailView.previewBeforeSending = null;
					self.$layer.remove();
					self.remove();
					mail.overlayView.hideOverlay();
					return false;
				});

				var $normalAttachArea = this.$layer.find('#normalAttachArea');
				var $bigmailAttachArea = this.$layer.find('#bigmailAttachArea');
				var $splitBar = this.$layer.find("#split-bar");

				var $normalAttachCnt = this.$layer.find('#normailFileCnt');
				var $bigmailAttachCnt = this.$layer.find('#bigmailFileCnt');

				var $normalFileSize = this.$layer.find('#normalFileSize');
				var $bigmailFileSize = this.$layer.find('#bigmailFileSize');

				$normalAttachCnt.text(this.normalFileCnt);
				$bigmailAttachCnt.text(this.bigmailFileCnt);

				$normalFileSize.css('font-weight', 'normal').text(
						'(' + numeral(this.normalFileSize).format('0.0b') + ')');
				$bigmailFileSize.css('font-weight', 'normal').text(
						'(' + numeral(this.bigmailFileSize).format('0.0b') + ')');

				if (this.bigmailFileCnt == 0) {
					$bigmailAttachArea.hide();
					$splitBar.hide();
				}
				if (this.normalFileCnt == 0) {
					$normalAttachArea.hide();
					$splitBar.hide();
				}
				var $previewOption = this.$layer.find("input:radio[name='send_set']");
				var $sendBtn = this.$layer.find('#sendMailBtn');
				$sendBtn.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var previewOption = $previewOption.filter(':checked').val();
					if (previewOption != app.userModel.get('PREVIEW_BEFORE_SENDING')) {
						app.userModel.save({
							PREVIEW_BEFORE_SENDING : previewOption,
						}, {
							patch : true,
							wait : true,
						});
					}
					app.vent.trigger('send:mail');
					self.$layer.remove();
					self.remove();
					mail.overlayView.hideOverlay();
					return false;
				});
				mail.overlayView.showOverlay();
			},

			_centerLayerInWindow : function($layer) {
				var $viewport = $(window);
				$viewport.off('resize.composePreviewLayer');
				$viewport.on('resize.composePreviewLayer', function(event) {
					event.preventDefault() && event.stopPropagation();
					var viewportWidth = $viewport.width() / 2;
					var viewportHeight = $viewport.height() / 2;
					// var width = $layer.width(), height = $layer.height();
					var width = $viewport.width() * 0.6 / 2;
					var height = $viewport.height() * 0.8 / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					$layer.css({
						width : Math.floor($viewport.width() * 0.6),
						height : Math.floor($viewport.height() * 0.8),
						top : top,
						left : left
					});
					var $contentArea = $layer.find('.tbl_wrap');
					var contentHeight = $layer.height() - 170;
					$contentArea.css({
						height : contentHeight,
					});
					return false;
				});
				$viewport.trigger('resize.composePreviewLayer');
			},
		}); // mail.ComposeMailPreviewView

		mail.SignatureView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.SignatureView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#signature-template').html();
					compiledTemplate = _.template(html);
					mail.SignatureView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					signatures : data.items,
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.SignatureCollection()
				this.listenTo(this.collection, 'sync', this.render);
				this.parentView = options.parentView;
				this.signatureRegion = options.signatureRegion;
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var _replaceInlineImages = function(signature) {
					var $div = $('<div></div>').html(signature);
					var $images = $div.find('img');
					var pattern = /^cid:(.+)/i;
					$images.each(function(index, element) {
						var $img = $(element);
						var src = $img.attr('src');
						var match = pattern.exec(src);
						if (match && match.length == 2) {
							var url = 'inline/' + match[1];
							if (isPopup())
								url = '../inline/' + match[1];
							$img.attr('src', url);
						}
					});
					return $div.html();
				};
				var $signatures = this.$el.find('ul li a');
				$signatures.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var curId = self.$el.find('li.chk a').data('id');
					var curSignatureModel = self.collection.findModel('SIGN_IDX', curId);
					var curSignature = curSignatureModel ? curSignatureModel.get('SIGN_STMT') : '';
					var newId = $(this).data('id');
					var newSignatureModel = self.collection.findModel('SIGN_IDX', newId);
					var newSignature = newSignatureModel ? newSignatureModel.get('SIGN_STMT') : '';
					var content = Editor.getContent();
					var frag = document.createDocumentFragment();
					var $content = $('<div></div>', frag).html(content);
					var $signatureArea = $content.find('div#signature-area');
					if ($signatureArea.length) {
						if ($signatureArea.html() != _replaceInlineImages(curSignature)
								&& !confirm(i18n.confirmChangeSignature))
							return false;
						if (newSignature)
							$signatureArea.html(_replaceInlineImages(newSignature));
						else
							$signatureArea.remove();
						Editor.modify({
							content : $content.html(),
						});
					} else {
						if (newSignature) {
							var html = '<div id="signature-area">' + _replaceInlineImages(newSignature) + '</div>';
							Editor.getCanvas().pasteContent(html, true);
						}
					}
					$signatures.parent().removeClass('chk');
					$(this).parent().addClass('chk');
					if (self.$signatureRegion)
						self.$signatureRegion.hide();
					return false;
				});
			},
			onShow : function() {
				if (this.$signatureRegion)
					this.$signatureRegion.remove();
				this.$signatureRegion = this.signatureRegion.$el.clone(true);
				this.$signatureRegion.appendTo(this.parentView.$el);
				this.$el = this.$signatureRegion.children();
			},
		}); // mail.SignatureView

		mail.StationeryView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_b',
			template : function(data) {
				var html, compiledTemplate = mail.StationeryView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#stationery-template').html();
					compiledTemplate = _.template(html);
					mail.StationeryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					items : data.items,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.StationeryPaginator
				this.listenTo(this.collection, 'reset', this.render);
				this.parentView = options.parentView;
				this.stationeryRegion = options.stationeryRegion;
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				if (this.$stationeryRegion) {
					this.renderPagination();
				}
				var $stationery = this.$el.find('ul.letter_list li a');
				$stationery.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var img = new Image();
					img.src = $(this).find('img').attr('src');
					Editor.getCanvas().getPanel(Editor.getCanvas().mode).addStyle({
						backgroundImage : 'url("' + img.src + '")',
					});
					return false;
				});
				var $notUsed = this.$el.find('div.hTitle button.s_bt');
				$notUsed.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					Editor.getCanvas().getPanel(Editor.getCanvas().mode).addStyle({
						backgroundImage : 'none',
					});
					return false;
				});
			},
			onShow : function() {
				if (this.$stationeryRegion)
					this.$stationeryRegion.remove();
				this.$stationeryRegion = this.stationeryRegion.$el.clone(true);
				this.$stationeryRegion.appendTo(this.parentView.$el);
				this.$el = this.$stationeryRegion.children();
				this.renderPagination();
			},
			renderPagination : function() {
				var html = mail.$template.filter('#stationery-pagination-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				var $pagination = this.$el.find('div.tList div.ad_btn_area');
				$pagination.html(html);
				var $prevPage = $pagination.find('span.ic_l_prev').parent();
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = $pagination.find('span.ic_l_next').parent();
				$nextPage.click($.proxy(this.gotoNext, this));
				var $pages = $pagination.find('ol li a');
				$pages.click($.proxy(this.gotoPage, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.previousPage();
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.nextPage();
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.preventDefault() && event.stopPropagation();
				var page = $(event.target).text();
				this.collection.goTo(page);
			},
		}); // mail.StationeryView

		mail.FormView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.FormView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#form-template').html();
					compiledTemplate = _.template(html);
					mail.FormView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					forms : data.items,
					totalRecords : data.totalRecords,
					perPage : data.perPage,
					currentPage : data.currentPage,
					searchField : data.searchField,
					searchTerm : data.searchTerm,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = new BackboneModel({...});
				// this.collection == mail.FormPaginator
				this.listenTo(this.collection, 'sync', this.renderView);
				this.parentView = options.parentView;
				this.formRegion = options.formRegion;
			},
			renderView : function() {
				this.model = new Backbone.Model({
					items : this.collection.toJSON(),
					totalRecords : this.collection.totalRecords,
					perPage : this.collection.perPage,
					currentPage : this.collection.currentPage,
					searchField : this.collection.getSearchField(),
					searchTerm : this.collection.getSearchTerm(),
				});
				this.render();
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				if (this.$formRegion) {
					this.renderPagination();
				}
				var $search = this.$el.find('button#search-forms:first');
				var $searchField = this.$el.find('select[name="search-field"]:first');
				var $searchTerm = this.$el.find('input[name="search-term"]:first');
				$search.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.collection.clearSearch();
					var field = $searchField.val();
					var term = $searchTerm.val();
					self.collection.server_api['search.' + field] = term;
					self.collection.goTo(1);
					return false;
				});
				var $forms = this.$el.find('td.tl a');
				$forms.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var id = $(this).data('id');
					var model = self.collection.findModel('FORMLETTER_IDX', id);
					var content = model.get('CONTENT');
					Editor.getCanvas().pasteContent(content, true);
					if (self.$formRegion)
						self.$formRegion.hide();
					return false;
				});
			},
			onShow : function() {
				if (this.$formRegion)
					this.$formRegion.remove();
				this.$formRegion = this.formRegion.$el.clone(true);
				this.$formRegion.appendTo(this.parentView.$el);
				this.$el = this.$formRegion.children();
				this.renderPagination();
			},
			renderPagination : function() {
				var html = mail.$template.filter('#form-pagination-template').html();
				var compiledTemplate = _.template(html);
				html = compiledTemplate({
					info : this.collection.info(),
					i18n : i18n,
				});
				html = html.replace(/\r|\n|\t/g, '');
				var $pagination = this.$el.find('div.mc-paginate');
				$pagination.html(html);
				var $firstPage = $pagination.find('a.pre_end:first');
				$firstPage.click($.proxy(this.gotoFirst, this));
				var $prevPage = $pagination.find('a.pre:first');
				$prevPage.click($.proxy(this.gotoPrev, this));
				var $nextPage = $pagination.find('a.next:first');
				$nextPage.click($.proxy(this.gotoNext, this));
				var $lastPage = $pagination.find('a.next_end:first');
				$lastPage.click($.proxy(this.gotoLast, this));
				var $pages = $pagination.find('span.mc-paging_num a');
				$pages.click($.proxy(this.gotoPage, this));
				return this;
			},
			gotoFirst : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(1);
			},
			gotoPrev : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.requestPreviousPage();
			},
			gotoNext : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.requestNextPage();
			},
			gotoLast : function(event) {
				event.preventDefault() && event.stopPropagation();
				this.collection.goTo(this.collection.information.lastPage);
			},
			gotoPage : function(event) {
				event.preventDefault() && event.stopPropagation();
				var page = $(event.target).text();
				this.collection.goTo(page);
			},
		}); // mail.FormView

		mail.DelayDeliveryView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'mc-pop_wrap pop_reserve',
			template : function(data) {
				var html, compiledTemplate = mail.DelayDeliveryView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#delay-delivery-template').html();
					compiledTemplate = _.template(html);
					mail.DelayDeliveryView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = new Backbone.Model({
				// date : 'yy-MM-dd',
				// hour : 'HH',
				// minute : 'mm',
				// timeZone : '+09:00',
				// });
				this.listenTo(this.model, 'change', this.render);
				this.$wrapper = options.$wrapper;
			},
			onRender : function() {
				var self = this;
				this.$tabs = this.$el.find('ul.tab_reserve li a');
				this.$tabs.filter('#delay-delivery-custom').data('height', 280);
				this.$tabs.filter('#delay-delivery-d-day').data('height', 330);
				var $customPanel = this.$el.find('#delay-delivery-custom-panel');
				var $dDayPanel = this.$el.find('#delay-delivery-d-day-panel');
				this.$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$tabs.removeClass('selected');
					var id = $(this).addClass('selected').attr('id');
					switch (id) {
					case 'delay-delivery-custom':
						$dDayPanel.hide();
						$customPanel.show();
						break;
					case 'delay-delivery-d-day':
						$customPanel.hide();
						$dDayPanel.show();
						break;
					}
					var position = self.$wrapper.position();
					var top = Math.round(position.top - $(this).data('height'));
					self.$el.css('top', top);
					return false;
				});
				if (this.selectedTabId) {
					this.$tabs.filter('#' + this.selectedTabId).click();
				} else {
					this.selectedTabId = this.$tabs.filter('.selected').attr('id');
				}
				// jQuery UI Datepicker
				var $delayDeliveryDate = this.$el.find('input[name="date"]');
				$delayDeliveryDate.datepicker(i18n.datepicker.delayDeliveryOptions);
				// TimeZone Utility
				var timeZoneDiff = function(timeZone) {
					if (!timeZone || !/^Z|[+-](?:2[0-3]|[0-1][0-9]):[0-5][0-9]$/.test(timeZone))
						return 0;
					var offset = 0;
					if (timeZone !== 'Z') {
						var sign = timeZone.charAt(0);
						var hours = timeZone.substring(1, 3);
						var minutes = timeZone.substring(4, 6);
						offset = parseInt(hours, 10) * 60 + parseInt(minutes, 10);
						offset = sign == '+' ? -(offset) : offset;
					}
					var diff = (new Date()).getTimezoneOffset() - offset;
					return diff * 60000;
				};
				var timeZoneDate = function(timeZone, date) {
					if (!date)
						date = new Date();
					var diff = timeZoneDiff(timeZone);
					var time = date.getTime() + diff;
					date.setTime(time);
					return date;
				};
				// TimeZone
				var $timeZones = this.$el.find('select[name="timeZone"]');
				$timeZones.children('option[value="' + this.model.get('timeZone') + '"]').prop('selected', true);
				var selectedTimeZones = [];
				$timeZones.each(function(index, element) {
					selectedTimeZones.push(element.options[element.selectedIndex].value);
				});
				$timeZones.change(function(event) {
					var $d, $h, $m, $z = $(this);
					self.selectedTabId = self.$tabs.filter('.selected').attr('id');
					switch (self.selectedTabId) {
					case 'delay-delivery-custom':
						$d = $customPanel.find('input[name="date"]:first');
						$h = $customPanel.find('select[name="hour"]:first');
						$m = $customPanel.find('select[name="minute"]:first');
						break;
					case 'delay-delivery-d-day':
						$d = $dDayPanel.find('input[name="date"]:first');
						$h = $dDayPanel.find('select[name="hour"]:first');
						$m = $dDayPanel.find('select[name="minute"]:first');
						break;
					}
					var pattern = /^([0-9]{2})-(1[0-2]|0[1-9])-(3[0-1]|0[1-9]|[1-2][0-9])$/;
					if (!pattern.test($d.val())) {
						alert(i18n.invalidDateFormat);
						return false;
					}
					var dateString = '20' + $d.val() + 'T' + $h.val() + ':' + $m.val() + ':00';
					var parsedDate = $.format.parseDate(dateString);
					var date = parsedDate.date;
					date.setHours(parseInt(parsedDate.time.hour, 10));
					date.setMinutes(parseInt(parsedDate.time.minute, 10));
					var index = $timeZones.index(this);
					var diff = timeZoneDiff(selectedTimeZones[index]);
					var timeZone = $z.val();
					selectedTimeZones[index] = timeZone;
					date.setTime(date.getTime() - diff);
					date = timeZoneDate(timeZone, date);
					$d.val($.format.date(date, 'yy-MM-dd'));
					$h.children('option[value="' + $.format.date(date, 'HH') + '"]').prop('selected', true);
					$m.children('option[value="' + $.format.date(date, 'mm') + '"]').prop('selected', true);
					return false;
				});
				// D-Day
				var $date = $dDayPanel.find('input[name="date"]:first');
				var $hour = $dDayPanel.find('select[name="hour"]:first');
				var $minute = $dDayPanel.find('select[name="minute"]:first');
				var $dDay = $dDayPanel.find('input[name="d-day"]:first');
				var $dDayText = $dDayPanel.find('#d-day-date-time strong:first');
				var dateTimeChanged = function(event) {
					event.preventDefault() && event.stopPropagation();
					var dateString = '20' + $date.val() + 'T' + $hour.val() + ':' + $minute.val() + ':00';
					var parsedDate = $.format.parseDate(dateString);
					var date = parsedDate.date;
					date.setHours(parseInt(parsedDate.time.hour, 10));
					date.setMinutes(parseInt(parsedDate.time.minute, 10));
					$dDayText.text($.format.date(date, i18n.dDay.dateTime));
					return false;
				};
				$date.change(dateTimeChanged);
				$hour.change(dateTimeChanged);
				$minute.change(dateTimeChanged);
				$dDay.keyup(function(event) {
					event.preventDefault() && event.stopPropagation();
					var days = $(this).val();
					if (!days || isNaN(days))
						return false;
					var dateString = '20' + $date.val() + 'T' + $hour.val() + ':' + $minute.val() + ':00';
					var parsedDate = $.format.parseDate(dateString);
					var date = parsedDate.date;
					date.setDate(date.getDate() + parseInt(days));
					date.setHours(parseInt(parsedDate.time.hour, 10));
					date.setMinutes(parseInt(parsedDate.time.minute, 10));
					$dDayText.text($.format.date(date, i18n.dDay.dateTime));
					return false;
				});
				// Confirm | Cancel
				var $buttons = this.$el.find('div.btn_area button');
				var $confirm = $buttons.filter('.b');
				var $cancel = $buttons.not('.b');
				$confirm.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $d, $h, $m, $z, dDay;
					self.selectedTabId = self.$tabs.filter('.selected').attr('id');
					switch (self.selectedTabId) {
					case 'delay-delivery-custom':
						$d = $customPanel.find('input[name="date"]:first');
						$h = $customPanel.find('select[name="hour"]:first');
						$m = $customPanel.find('select[name="minute"]:first');
						$z = $customPanel.find('select[name="timeZone"]:first');
						dDay = 0;
						break;
					case 'delay-delivery-d-day':
						$d = $dDayPanel.find('input[name="date"]:first');
						$h = $dDayPanel.find('select[name="hour"]:first');
						$m = $dDayPanel.find('select[name="minute"]:first');
						$z = $dDayPanel.find('select[name="timeZone"]:first');
						dDay = isNaN($dDay.val()) ? 0 : parseInt($dDay.val());
						break;
					}
					var pattern = /^([0-9]{2})-(1[0-2]|0[1-9])-(3[0-1]|0[1-9]|[1-2][0-9])$/;
					if (!pattern.test($d.val())) {
						alert(i18n.invalidDateFormat);
						return false;
					}
					var dateString = '20' + $d.val() + 'T' + $h.val() + ':' + $m.val() + ':00';
					var parsedDate = $.format.parseDate(dateString);
					var date = parsedDate.date;
					date.setHours(parseInt(parsedDate.time.hour, 10));
					date.setMinutes(parseInt(parsedDate.time.minute, 10));
					if (dDay) {
						date.setDate(date.getDate() + dDay);
					}
					var timeZone = $z.val();
					var now = timeZoneDate(timeZone);
					if (now.getTime() > date.getTime()) {
						alert(i18n.cannotBeLaterThanCurrent);
						return false;
					}
					var limit = timeZoneDate(timeZone);
					limit.setFullYear(now.getFullYear() + 5);
					if (limit.getTime() < date.getTime()) {
						alert(i18n.scheduleWithinFiveYears);
						return false;
					}
					self.model.set({
						date : $d.val(),
						hour : $h.val(),
						minute : $m.val(),
						timeZone : $z.val(),
						dDay : dDay,
					});
					if (!self.model.hasChanged())
						self.model.trigger('change');
					self.$el.hide();
					return false;
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.selectedTabId = self.$tabs.filter('.selected').attr('id');
					self.$el.hide();
					return false;
				});
			},
		}); // mail.DelayDeliveryView

		mail.ComposeOptionsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_a option2',
			template : function(data) {
				var html, compiledTemplate = mail.ComposeOptionsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#compose-options-template').html();
					compiledTemplate = _.template(html);
					mail.ComposeOptionsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				this.contentLayoutView = options.contentLayoutView;
				this.composeOptionsRegion = options.composeOptionsRegion;
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			onShow : function() {
				if (this.$composeOptionsRegion)
					this.$composeOptionsRegion.remove();
				var composeView = this.contentLayoutView.composeRegion.currentView;
				this.$composeOptionsRegion = this.composeOptionsRegion.$el.clone(true);
				this.$composeOptionsRegion.appendTo(this.contentLayoutView.$el);
				var self = this;
				var $el = this.$composeOptionsRegion.children();
				var $charset = $el.find('select[name="character-encoding"]');
				$charset.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!composeView.mailModel)
						composeView.mailModel = new mail.MailModel();
					composeView.mailModel.set('charset', $(this).val());
					return false;
				});
				if (composeView.mailModel && composeView.mailModel.get('charset')) {
					var charset = composeView.mailModel.get('charset');
					$charset.children('option[value="' + charset + '"]').prop('selected', true);
				}
				var $autosaveInterval = $el.find('select[name="AUTOSAVE_INTERVAL"]');
				var $previewBeforeSending = $el.find('select[name="PREVIEW_BEFORE_SENDING"]');
				var $saveInSent = $el.find('input[name="USERS_SENDBOX"]');
				var $buttons = $el.find('div.addButton button');
				var $save = $buttons.filter('.b');
				var $cancel = $buttons.not('.b');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var interval = $autosaveInterval.val();
					self.model.save({
						AUTOSAVE_INTERVAL : isNaN(interval) ? 0 : parseInt(interval),
						PREVIEW_BEFORE_SENDING : $previewBeforeSending.val(),
						USERS_SENDBOX : $saveInSent.is(':checked') ? 'Y' : 'N',
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							self.render().onShow();
						},
						error : function(model, response, options) {
							alert('Failed to save the composing settings');
						},
					});
					return false;
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render().onShow();
					return false;
				});
			},
		}); // mail.ComposeOptionsView

		mail.BlobOptionsView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.BlobOptionsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#blob-options-template').html();
					compiledTemplate = _.template(html);
					mail.BlobOptionsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					diskUser : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.diskUserModel
				this.composeRegion = options.composeRegion;
				this.parentView = options.parentView;
				this.blobOptionsRegion = options.blobOptionsRegion;
			},
			onRender : function() {
				this.$el.click(function(event) {
					event.stopPropagation();
				});
			},
			onShow : function() {
				if (this.$blobOptionsRegion)
					this.$blobOptionsRegion.remove();
				this.$blobOptionsRegion = this.blobOptionsRegion.$el.clone(true);
				this.$blobOptionsRegion.appendTo(this.composeRegion.$el);
				var self = this;
				var $el = this.$blobOptionsRegion.children();
				var $expirationDays = $el.find('input[name="file_date"]');
				var $downLimit = $el.find('input[name="down_num"]');
				var $passwordRequired = $el.find('input[name="passwd-required"]');
				var $buttons = $el.find('div.ad_btn_area button');
				var $save = $buttons.filter('.b');
				var $cancel = $buttons.not('.b');
				var $close = $el.find('.ic_cancle:first');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (isNaN($expirationDays.val()) || isNaN($downLimit.val())) {
						alert(i18n.attachment.enterNumber);
						$expirationDays.focus();
						return false;
					} else if ($expirationDays.val() <= 0 || $downLimit.val() <= 0) {
						alert(i18n.attachment.enterNumberGreaterThanZero);
						$expirationDays.focus();
						return false;
					} else if ($expirationDays.val() > self.model.get('BIGMAIL_MAX_VALIDITY_DAYS')) {
						alert(i18n.attachment.leadingDaysLimit + self.model.get('BIGMAIL_MAX_VALIDITY_DAYS')
								+ i18n.attachment.trailingDaysLimit);
						$expirationDays.focus();
						return false;
					} else if ($downLimit.val() > self.model.get('BIGMAIL_MAX_DOWNLOAD_LIMIT')) {
						alert(i18n.attachment.leadingDownloadLimit + self.model.get('BIGMAIL_MAX_DOWNLOAD_LIMIT')
								+ i18n.attachment.trailingDownloadLimit);
						$downLimit.focus();
						return false;
					}
					var passwdRequired = $passwordRequired.filter(':checked').val();
					self.model.save({
						BIGMAIL_VALIDITY_DAYS : parseInt($expirationDays.val()),
						BIGMAIL_DOWNLOAD_LIMIT : parseInt($downLimit.val()),
						BIGMAIL_PASSWORD_REQUIRED : (passwdRequired == "true" ? 1 : 0)
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							self.render().onShow();
						},
						error : function(model, response, options) {
							alert('Failed to save the blob settings');
						},
					});
					return false;
				});
				$cancel.add($close).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.render().onShow();
					return false;
				});
			},
		}); // mail.BlobOptionsView

		mail.PrintOptionsView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'type_c',
			template : function(data) {
				var html, compiledTemplate = mail.PrintOptionsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#print-options-template').html();
					compiledTemplate = _.template(html);
					mail.PrintOptionsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.mdoel = mail.MailModel
			},
			onRender : function() {
				var self = this;
				var $print = this.$el.find('p.btn_area button.print');
				var $cancel = this.$el.find('p.btn_area button.cancel');
				$print.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = [];
					var options = self.$el.find('li.first input:checkbox');
					options.each(function(index, element) {
						if (!$(this).is(':checked'))
							params.push($(this).attr('name'));
					});
					var printUrl = '#print/' + self.model.get('M_IDX') + '?excludeOptions='
							+ encodeURIComponent(params);
					if (isPopup()) {
						location.hash = printUrl;
					} else {
						printUrl = 'popup/' + printUrl;
						window.open(printUrl, '', 'scrollbars=yes,width=900,height=680');
					}
					app.$hidablesListener.trigger('hide.all');
				});
				$cancel.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
				});
			},
		}); // mail.PrintOptionsView

		mail.SentMailView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.SentMailView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#sent-mail-template').html();
					compiledTemplate = _.template(html);
					mail.SentMailView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					contacts : data.contacts,
					mailModel : data.mailModel,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == Backbone.Collection
				this.mailModel = options.mailModel;
			},
			onRender : function() {
				var self = this;
				var $addArea = this.$el.find('div.not_address');
				var $completeArea = this.$el.find('div#complete-address');
				var $important = this.$el.find('a.important');
				var $addContacts = this.$el.find('button.add-contacts');
				$important.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var $span = $this.children('.ic_hlt_star');
					if ($span.hasClass('ic_hlt_star_on')) {
						$span.removeClass('ic_hlt_star_on').addClass('ic_hlt_star_off');
					} else {
						$span.removeClass('ic_hlt_star_off').addClass('ic_hlt_star_on');
					}
				});
				$addContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $nameInput = self.$el.find('.contact-name');
					var contacts = [], count = 0, saved = 0;
					var $addressCount = $completeArea.find('#count-address');
					var $addressNames = $completeArea.find('.view_box');
					$nameInput.each(function() {
						var $this = $(this);
						if ($this.val())
							count++;
					});
					if (count == 0) {
						alert(i18n.addContacts.pleaseEnterName);
						$nameInput[0].focus();
						return false;
					}
					var msg = i18n.addContacts.noNameContact + ($nameInput.length - count) + i18n.addContacts.exceptFor
							+ '\n' + count + i18n.addContacts.saveContactsPharse;
					if ((count != $nameInput.length) && !confirm(msg)) {
						return false;
					}
					var $list = self.$el.find('div.not_address ul li');
					$list.each(function() {
						var $this = $(this);
						var personal = $this.find('input.contact-name').val();
						if (!personal)
							return;
						var address = $this.data('address');
						var important = $this.find('.important span.ic_hlt_star').hasClass('ic_hlt_star_on');
						if (!this.addressModel) {
							if (isPopup()) {
								var AddrssModel = app.contact.AddressModel.extend({
									urlRoot : '../contacts'
								});
								this.addressModel = new AddrssModel();
							} else {
								this.addressModel = new app.contact.AddressModel({});
							}
						}
						var addressModel = this.addressModel;
						addressModel.save({
							ADDRESS_NAME : personal,
							ADDRESS_EMAIL : address,
							ADDRESS_IMPORTANT : (important ? 'Y' : 'N'),
							ADDRESS_EMAIL_REP : 'Y',
							GROUP_IDX : 0,
						}, {
							wait : true,
							success : function(model, response, options) {
								saved++;
								$addressNames.append(personal);
								if (saved == count) {
									$addressCount.append(saved);
									$addArea.hide();
									$completeArea.show();
								} else {
									$addressNames.append(', ');
								}
							},
						});
					});
				});
				var $moveDeliveryStatus = this.$el.find('a.deliverystatus');
				$moveDeliveryStatus.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = '#delivery-status';
					if (isPopup()) {
						window.opener.location.hash = url;
						window.close();
					} else {
						location.hash = url;
					}
					return false;
				});
				var $moveContacts = this.$el.find('a.contacts');
				$moveContacts.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = '#contacts';
					if (isPopup()) {
						window.opener.location.hash = url;
						window.close();
					} else {
						location.hash = url;
					}
					return false;
				});
				var $registerRecipientGroup = this.$el.find('div.rc_grp button.recipient-group-register');
				$registerRecipientGroup.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.recipientGroupRegisterView) {
						self.recipientGroupRegisterView.close();
					}
					var zIndex = mail.overlayView.$overlay.css('z-index');
					var to = self.getRecipientAddress(self.mailModel.get('M_TO'), 'to');
					var cc = self.getRecipientAddress(self.mailModel.get('M_CC'), 'cc');
					var bcc = self.getRecipientAddress(self.mailModel.get('M_BCC'), 'bcc');
					self.recipientGroupRegisterView = new app.settings.RecipientGroupRegisterView({
						model : new app.contact.RecipientGroupModel({
							recipientAddresses : to.concat(cc).concat(bcc),
						}),
					});
					var $recipientGroupRegisterView = self.recipientGroupRegisterView.render().$el;
					$recipientGroupRegisterView.css('z-index', parseInt(zIndex) + 1);
					$recipientGroupRegisterView.show().appendTo('body');
					var $viewport = $(window);
					$viewport.off('resize.recipientGroupRegister');
					$viewport.on('resize.recipientGroupRegister', function(event) {
						var parentWidth = $viewport.width() / 2;
						var parentHeight = $viewport.height() / 2;
						var width = $recipientGroupRegisterView.width() / 2;
						var height = $recipientGroupRegisterView.height() / 2;
						var top = Math.floor(parentHeight - height);
						var left = Math.floor(parentWidth - width);
						$recipientGroupRegisterView.css({
							'top' : top,
							'left' : left
						});
					});
					$viewport.trigger('resize.recipientGroupRegister');
					return false;
				});
			},
			getRecipientAddress : function(addr, type) {
				var recipientAddresses = [];
				try {
					var addrs = InternetAddress.parseHeader(addr, false);
					for (var i = 0; i < addrs.length; i++) {
						var recipientAddress = {};
						recipientAddress.name = addrs[i].getPersonal();
						recipientAddress.email = addrs[i].getAddress();
						recipientAddress.type = type;
						recipientAddresses.push(recipientAddress);
					}
				} catch (error) {
				}
				return recipientAddresses;
			},
		}); // mail.SentMailView

		mail.autocompleteOptions = {
			source : function(request, response) {
				var url = 'autocomplete';
				if (isPopup())
					url = '../autocomplete';
				$.ajax({
					url : url,
					dataType : "json",
					data : {
						term : encodeURIComponent(request.term)
					},
					success : function(data) {
						for (var i = 0; i < data.length; i++) {
							var pattern = /(\S+\s*[^\/]*)(?:\s\/\s\S.+)*\s(\S+)/gi;
							var matches = pattern.exec(data[i]);
							if (matches) {
								data.splice(i, 1, {
									'label' : data[i],
									'value' : matches[1] + ' ' + matches[2]
								});
							}
						}
						response(data);
					}
				});
			},
			autoFocus : true,
			minLength : 2,
			appendTo : "#autoComplete div.type_a.autoBook",
			position : {
				of : "#mailTo",
				my : "left top",
				at : "left bottom",
				collision : "none",
			},
			create : function(event, ui) {
				app.debug('autocomplete.create(event, ui) {...}');
				var $ul = $(this).autocomplete('widget');
				var target = $(this).autocomplete('option', 'appendTo');
				var $container = $(target).parents('#autoComplete:first');
				if ($container.is(':visible')) {
					$container.find('.ui-autocomplete').not($ul).hide();
					$container.hide();
				}
				$ul.removeClass('ui-widget ui-widget-content');
				$ul.addClass('autoAddr').css('height', '234px');
			},
			search : function(event, ui) {
				app.debug('autocomplete.search(event, ui) { "' + $(this).val() + '" }');
				var $input = $(this);
				if ($input.val() == $input.data('focus-value')) {
					return false;
				}
				var $ul = $input.autocomplete('widget');
				var target = $input.autocomplete('option', 'appendTo');
				var $list = $(target).find('ul.autoAddr').not($ul);
				if ($list.length) {
					$list.hide();
					$(target).prepend($ul);
				}
				var position = $input.autocomplete('option', 'position');
				var $container = $(target).parents('#autoComplete:first');
				$container.show().position(position);
				$container.resize(function(event) {
					var $this = $(event.target);
					$this.position(position);
				});
			},
			open : function(event, ui) {
				app.debug('autocomplete.open(event, ui) {...}');
				var $input = $(this);
				var $ul = $input.autocomplete('widget');
				var $items = $ul.children('.ui-menu-item');
				$items.each(function(index, element) {
					var $element = $(element);
					var text = $element.text();
					text = text.replace(/</g, '\x02').replace(/>/g, '\x03');
					var term = $input.val();
					var specialCharacters = "^$.*+?=!:|\/()[]{}";
					var expr = [];
					for (var i = 0; i < term.length; i++) {
						var ch = term.charAt(i);
						if (specialCharacters.indexOf(ch) != -1)
							expr.push("\\");
						expr.push(ch);
					}
					var regExp = new RegExp(expr.join(''), "gi");
					var label = text.replace(regExp, "<strong>" + term + "</strong>");
					label = label.replace(/\x02/g, '&lt;').replace(/\x03/g, '&gt;');
					var html = [];
					html.push('<a><span class="email">');
					html.push(label);
					html.push('</span></a>');
					html.push('<input type="hidden" value="');
					html.push(text.replace(/\x02/g, '<').replace(/\x03/g, '>').replace(/\"/g, '&quot;'));
					html.push('"/>');
					$element.empty().html(html.join(''));
				});
				var target = $input.autocomplete('option', 'appendTo');
				if ($items.length === 0) {
					var $container = $(target).parents('#autoComplete:first');
					$container.hide();
				} else {
					var rcptInputs = [], $rcptInput;
					var $form = $(target).parents('form:first');
					rcptInputs.push($form.find('input[name="M_TO"]:first'));
					rcptInputs.push($form.find('input[name="M_CC"]:first'));
					rcptInputs.push($form.find('input[name="M_BCC"]:first'));
					for (var i = 0; i < rcptInputs.length; i++) {
						$rcptInput = rcptInputs[i];
						if ($rcptInput.inputbox('input').is(':focus'))
							break;
					}
					app.debug("autocomplete.open(event, ui) { $rcptInput.inputbox('off', 'blur'); }");
					$rcptInput.inputbox('off', 'blur');
					app.debug("autocomplete.open(event, ui) { $input.addClass('ui-state-disabled'); }");
					$input.addClass('ui-state-disabled').css({
						'opacity' : '1',
						'filter' : 'none',
						'background-image' : 'none',
					});
				}
			},
			focus : function(event, ui) {
				app.debug('autocomplete.focus(event, ui) { "' + ui.item.value + '" }');
				var $ul = $(this).autocomplete('widget');
				$ul.find('.ui-menu-item.selected').removeClass('selected');
				var $item = $ul.children('.ui-menu-item.ui-state-focus');
				$item.removeClass('ui-state-focus').addClass('selected');
				var $input = $(this);
				$input.data('focus-value', ui.item.value);
			},
			select : function(event, ui) {
				app.debug('autocomplete.select(event, ui) { "' + ui.item.value + '" }');
				var $input = $(this);
				if ($input.hasClass('ui-state-disabled')) {
					app.debug('autocomplete.select(event, ui) { if ($input.hasClass("ui-state-disabled") { ... } }');
					var rcptInputs = [], $rcptInput;
					var target = $input.autocomplete('option', 'appendTo');
					var $form = $(target).parents('form:first');
					rcptInputs.push($form.find('input[name="M_TO"]:first'));
					rcptInputs.push($form.find('input[name="M_CC"]:first'));
					rcptInputs.push($form.find('input[name="M_BCC"]:first'));
					for (var i = 0; i < rcptInputs.length; i++) {
						$rcptInput = rcptInputs[i];
						if ($rcptInput.inputbox('input').is(':focus')) {
							app.debug("autocomplete.select(event, ui) { $rcptInput.inputbox('input').is(':focus') }");
							break;
						}
						if ($rcptInput.inputbox('input').hasClass('ui-state-disabled')) {
							app.debug("autocomplete.select(event, ui) { "
									+ "$rcptInput.inputbox('input').hasClass('ui-state-disabled') }");
							break;
						}
					}
					app.debug("autocomplete.select(event, ui) { $rcptInput.inputbox('on', 'blur'); }");
					$rcptInput.inputbox('on', 'blur');
					$input.blur();
					app.debug("autocomplete.select(event, ui) { $input.removeClass('ui-state-disabled'); }");
					$input.removeClass('ui-state-disabled');
				}
				if (event.which === 1) { // left button for mousedown/mouseup
					$input.val(ui.item.value).blur();
				}
			},
			close : function(event, ui) {
				app.debug('autocomplete.close(event, ui) {...}');
				var target = $(this).autocomplete('option', 'appendTo');
				var $container = $(target).parents('#autoComplete:first');
				$container.hide();
			},
			change : function(event, ui) {
				app.debug('autocomplete.change(event, ui) {...}');
				var target = $(this).autocomplete('option', 'appendTo');
				var $container = $(target).parents('#autoComplete:first');
				$container.hide();
			},
		};

		mail.DropdownContactsView = Backbone.Marionette.ItemView.extend({
			el : '#autoComplete ul.dropdown-contacts-list',
			template : function(data) {
				var html, compiledTemplate = mail.DropdownContactsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#dropdown-contacts-template').html();
					compiledTemplate = _.template(html);
					mail.DropdownContactsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					recentContacts : data.recentContactCollection.toJSON(),
					importantContacts : data.importantContactCollection.toJSON(),
					renderFor : data.renderFor,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				var self = this;
				this.parentView = options.parentView; // mail.ComposeMailView
				this.recentContactCollection = new app.contact.RecentContactCollection();
				this.recentContactCollection.fetch({
					success : function(collection, response, options) {
						self.render();
					},
					error : function(collection, response, options) {
						alert('Failed to fetch Recent Contacts');
					},
				});
				this.importantContactCollection = new (app.contact.AddressCollection.extend({
					url : function() {
						if (isPopup())
							return '../contacts/importants';
						else
							return 'contacts/importants';
					},
				}))();
				this.importantContactCollection.fetch({
					success : function(collection, response, options) {
						self.render();
					},
					error : function(collection, response, options) {
						alert('Failed to fetch Important Contacts');
					},
				});
				this.model = new Backbone.Model({
					recentContactCollection : this.recentContactCollection,
					importantContactCollection : this.importantContactCollection,
					renderFor : 'recents',
				});
			},
			onRender : function() {
				var self = this;
				var $items = this.$el.children('li');
				$items.mouseover(function(event) {
					$(this).addClass('selected');
					return false;
				});
				$items.mouseout(function(event) {
					$(this).removeClass('selected');
					return false;
				});
				$items.click(function(event) {
					var $this = $(this);
					var $name = $this.find('span.name:first');
					var $email = $this.find('span.email:first');
					var $input = self.parentView.$focusedInput;
					$input.inputbox('on', 'blur');
					if ($name.length)
						$input.inputbox('add', '"' + $name.text() + '" <' + $email.text() + '>');
					else
						$input.inputbox('add', $email.text());
					var parentView = self.parentView;
					parentView.$autocomplete.hide();
					parentView.$toggleContacts.removeClass();
					return false;
				});
				var $remove = $items.find('a.btn_del');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var contactsName = $this.data('contacts-name');
					var id = $this.data('contacts-id');
					switch (contactsName) {
					case 'recents':
						var model = self.recentContactCollection.findModel('RECENT_ADDRESS_IDX', id);
						model.destroy({
							wait : true,
							success : function(model, response, options) {
								self.renderRecentContacts();
							},
							error : function(model, response, options) {
								alert('Failed to delete a Recent Contact');
							},
						});
						break;
					case 'importants':
						var model = self.importantContactCollection.findModel('ADDRESS_IDX', id);
						model.save({
							ADDRESS_IMPORTANT : 'N'
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								self.importantContactCollection.remove(model);
								self.renderImportantContacts();
							},
							error : function(model, response, options) {
								alert('Failed to delete an Important Contact');
							},
						});
						break;
					}
					return false;
				});
			},
			target : function(target) {
				this.$target = $(target);
			},
			renderRecentContacts : function() {
				this.model.set('renderFor', 'recents');
				this.render().$el.show();
			},
			renderImportantContacts : function() {
				this.model.set('renderFor', 'importants');
				this.render().$el.show();
			},
		}); // mail.DropdownContactsView

		mail.AttachmentsView = Backbone.Marionette.ItemView.extend({
			el : '#attachments-cell',
			template : function(data) {
				var html, compiledTemplate = mail.AttachmentsView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#attachments-template').html();
					compiledTemplate = _.template(html);
					mail.AttachmentsView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					diskUser : data,
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			options : {
				fileUploadURL : 'bigmail.file.do?cmd=webmailAttacheFile' + '&DOMAIN=kebi.com&USERS_ID=webmaster'
						+ '&MAX_FILE_SIZE=10485760',
				blobUploadURL : 'bigmail.file.do?cmd=bigmailAttacheFile' + '&DOMAIN=kebi.com&USERS_ID=webmaster'
						+ '&MAX_FILE_SIZE=10485760',
				blobQuotaURL : 'bigmail.file.do?cmd=bigmailAttacheQuota',
				filesUsage : 0, // bytes (default: 0bytes)
				filesQuota : 104857600, // bytes (default: 100MB)
				filesMaxSize : 10485760, // bytes (default: 10MB)
				blobsUsage : 10485760, // bytes (default: 0bytes)
				blobsQuota : 1073741824, // bytes (default: 1GB)
				form : 'form[name="mail_write_form"]',
				fileInputName : 'attache_file',
				blobInputName : 'bigmail_file',
				blobExpirationDays : 30, // days (default: 30days)
				blobPasswordRequired : false,
				_attachments : [ {
					id : '123456.789',
					name : '.txt',
					size : 1024,
					type : 'file'
				}, {
					id : '987654.321',
					name : '.avi',
					size : 912630880,
					type : 'blob'
				} ],
				zIndex : 1000,
			},
			initialize : function(options) {
				// this.model = app.diskUserModel
				this.parentView = options.parentView;
				this.blobOptionsRegion = options.blobOptionsRegion;
				this.listenTo(this.model, 'change', this._changeBlobOptions);
				for ( var option in options) {
					this.options[option] = options[option];
				}
				this.files = {};
				if (this.options.attachments) {
					var attachments = this.options.attachments;
					for (var i = 0; i < attachments.length; i++) {
						var attachment = attachments[i];
						var file = {
							name : attachment.name,
							size : attachment.size,
							type : attachment.type,
							loaded : attachment.size,
							status : 'done',
						};
						this.files[attachment.id] = file;
					}
				}
				if (this.options.files) {
					var files = this.options.files;
					var blobPattern = /^[0-9]+\.[0-9]+\.[0-9]+$/;
					for (var i = 0; i < files.length; i++) {
						if (files[i].linkCount) { // blob-attachment
							var id = files[i].linkCount;
							var type = blobPattern.test(id) ? 'blob' : 'file';
							this.files[id] = {
								name : files[i].name,
								size : files[i].size,
								type : type,
								loaded : files[i].size,
								status : 'done',
							};
						} else {
							var id = this._uid();
							this.files[id] = files[i];
						}
					}
				}
				this.listenTo(app.vent, 'attach:files', function(files) {
					var blobPattern = /^[0-9]+\.[0-9]+\.[0-9]+$/;
					for (var i = 0; i < files.length; i++) {
						var id = files[i].linkCount;
						var type = blobPattern.test(id) ? 'blob' : 'file';
						var file = {
							id : id,
							name : files[i].name,
							size : files[i].size,
							type : type,
							loaded : files[i].size,
							status : 'done'
						};
						this.addAttachment(file);
					}
					this._showAttachmentsSize();
				});
			},
			onRender : function() {
				this._initFileInput();
				this._initDropzone();
				this._initAttachmentsSize();
				this._initBlobOptions();
			},
			onClose : function() {
				delete this.parentView;
				delete this.blobOptionsRegion;
				delete this.options;
				for ( var id in this.files) {
					if (this.files[id].msClose)
						this.files[id].msClose();
				}
				delete this.files;
			},
			_initBlobOptions : function() {
				// Blob Options:  
				var blobOptionsView = new mail.BlobOptionsView({
					model : this.model,
					composeRegion : this.parentView,
					parentView : this,
					blobOptionsRegion : this.blobOptionsRegion,
				});
				this.blobOptionsRegion.show(blobOptionsView);
				var $blobOptions = this.$el.find('img.btn_write_opt').parent('a');
				$blobOptions.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					blobOptionsView.$blobOptionsRegion.toggle();
					if (app.userModel.get('ATTACHMENTS_POSITION'))
						blobOptionsView.$blobOptionsRegion.css('top', Math.round($blobOptions.position().top - 255));
					else
						blobOptionsView.$blobOptionsRegion.css('top', Math.round($blobOptions.position().top + 20));
					blobOptionsView.$blobOptionsRegion.css({
						position : 'absolute',
						left : 150,
					});
					return false;
				});
			},
			_changeBlobOptions : function() {
				// Blob Options
				var validityDays = this.model.get('BIGMAIL_VALIDITY_DAYS');
				var downloadLimit = this.model.get('BIGMAIL_DOWNLOAD_LIMIT');
				this.options.blobExpirationDays = validityDays;
				var $days = this.$el.find('.blob-expirationdays');
				var $limit = this.$el.find('.blob-downloadlimit');
				$days.text(validityDays + i18n.downloadBlobAttachments.validityDays);
				$limit.text(downloadLimit + i18n.downloadBlobAttachments.downloadTimes);
				// Blob Capacity
				var blobsUsage = this.model.get('DISK_USAGE');
				var blobsQuota = this.model.get('DISK_QUOTA');
				var blobsFree = blobsQuota - blobsUsage;
				this.$blobsFree.data('blobs-free', blobsFree);
				this.$blobsFree.text(this._formatSize(blobsFree));
				this.$blobsQuota.data('blobs-quota', blobsQuota);
				this.$blobsQuota.text(this._formatSize(blobsQuota));
			},
			_initFileInput : function() {
				var self = this, $el = this.$el;
				this.$fileInput = $('<input>', {
					'name' : 'attachments',
					'type' : 'file',
					'multiple' : 'true',
					'style' : 'position: absolute; top: -10000px; left: -10000px;'
				});
				$el.append(this.$fileInput);
				if (!this.$fileInput[0].files) {
					var url = isPopup() ? '../attachment/form' : 'attachment/form';
					if (!document.attachmentUploadIframe) {
						$('<iframe>', {
							'name' : 'attachmentUploadIframe',
							'src' : url,
							'style' : 'position: absolute; display: none;',
						}).appendTo('body');
					}
				}
				var $attach = $el.find('.attachments-attach');
				$attach.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.$fileInput[0].files) {
						self.$fileInput.click();
						return false;
					}
					if (document.attachmentUploadIframe) {
						var iframe = document.attachmentUploadIframe;
						var form = iframe.attachmentUploadForm;
						var changed = false;
						form.attachment.onchange = function() {
							changed = true;
							return false;
						};
						form.attachment.click();
						if (!changed) {
							return false;
						}
						app.vent.once('attachment:uploaded', function(file) {
							mail.overlayView.hideUploading();
							var iframe = document.attachmentUploadIframe;
							var pathname = iframe.location.pathname;
							var url = pathname.substring(0, pathname.lastIndexOf('/')) + '/form';
							iframe.location.replace(url);
							if (!file) {
								alert(i18n.attachment.cannotUpload);
								return;
							}
							self.addAttachment(file);
							self._showAttachmentsSize();
						});
						form.submit();
						mail.overlayView.showUploading();
					}
					return false;
				});
				var $drive = $el.find('.attachments-drive');
				$drive.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = 'popup/disk/#attachments';
					if (isPopup())
						url = '../' + url;
					var win = window.open(url, 'diskAttachments', 'width=710,height=705,resizable=no');
					win.focus();
					return false;
				});
			},
			_initDropzone : function() {
				var self = this, $el = this.$el;
				var $dropzone = $el.find('.attachments-dropzone:first');
				var $content = $dropzone.children('.attachments-list-content');
				var $droppable = $content.children('.attachments-droppable');
				var $list = $content.children('.attachments-list');
				this.$fileInput.change(function(event) {
					$.each(this.files, function(index, file) {
						self.addAttachment(file);
					});
					self._showAttachmentsSize();
					self.$fileInput.val('');
					return false;
				});
				$dropzone.on('dragenter', function(event) {
					var dataTransfer = event.originalEvent.dataTransfer;
					var types = dataTransfer.types;
					if (types) {
						if ((types.contains && types.contains("Files"))
								|| (types.indexOf && types.indexOf("Files") !== -1)) {
							event.preventDefault();
						}
					}
				});
				$dropzone.on('dragover', function(event) {
					event.preventDefault() && event.stopPropagation();
					return false;
				});
				$dropzone.on('drop', function(event) {
					event.preventDefault() && event.stopPropagation();
					var isAllFiles = true;
					var dataTransfer = event.originalEvent.dataTransfer;
					if (!dataTransfer) {
						return;
					}
					if (dataTransfer.items) {
						$.each(dataTransfer.items, function(index, item) {
							var entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
							if (entry && !entry.isFile) {
								isAllFiles = false;
							}
						});
					}
					if (!isAllFiles)
						return;
					var files = dataTransfer.files;
					$.each(files, function(index, file) {
						self.addAttachment(file);
					});
					self._showAttachmentsSize();
					return false;
				});
				var $toggle = $el.find('.attachments-list-header input:checkbox');
				$toggle.change(function() {
					var $checkboxes = $list.find('input:checkbox');
					if (this.checked) {
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
				});
				var $remove = $el.find('.attachments-remove');
				$remove.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = $list.find('input:checkbox');
					var $checked = $checkboxes.filter(':checked');
					var options = self.options;
					var $form = $(options.form);
					var $inputs = $form.find('input[name="' + options.fileInputName + '"]');
					$inputs = $inputs.add($form.find('input[name="' + options.blobInputName + '"]'));
					$checked.each(function(index, element) {
						// this === element
						var $checkbox = $(element);
						var $item = $checkbox.parents('.attachments-item:first');
						var id = $item.data('attachment-id');
						var name = $item.data('attachment-name');
						var type = $item.data('attachment-type');
						var value = id + '/' + encodeURIComponent(name);
						var $input = $inputs.filter(function(index, element) {
							var pathname = $(element).val();
							if (pathname === value)
								return true;
							if (type === 'blob' && pathname === 'blob.' + value)
								return true;
							return false;
						});
						$input.remove();
						$item.remove();
						delete self.files[id];
					});
					$checkboxes = $list.find('input:checkbox');
					if ($checkboxes.length === 0) {
						$toggle.prop('checked', false);
						$list.hide();
						$droppable.show();
					}
					self._showAttachmentsSize();
				});
				var $convert = $el.find('.attachments-convert');
				$convert.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $checkboxes = $list.find('input:checkbox');
					var $checked = $checkboxes.filter(':checked');
					$checked.each(function(index, element) {
						// this === element
						var $checkbox = $(element);
						var $item = $checkbox.parents('.attachments-item');
						var size = $item.data('attachment-size');
						var type = $item.data('attachment-type');
						if (type === 'blob') {
							var filesMaxSize = self.options.filesMaxSize;
							var filesSize = self.$filesSize.data('files-size');
							var sum = filesSize + size;
							if (size >= filesMaxSize || sum >= filesMaxSize) {
								alert(i18n.attachment.leadingMaxFileSize + numeral(filesMaxSize).format('0[.]00b')
										+ i18n.attachment.middlingMaxFileSize + numeral(filesSize).format('0[.]00b')
										+ i18n.attachment.trailingMaxFileSize);
								return;
							}
							$item.data('attachment-type', 'file');
							var $type = $item.find('.attach_type span:first');
							var $validity = $item.find('.down_period');
							$type.text('');
							$validity.text('');
						}
					});
					self._showAttachmentsSize();
				});
			}, // _initDropzone
			_initAttachmentsSize : function() {
				var self = this, $el = this.$el;
				var file, filesSize = 0, blobsSize = 0;
				for ( var id in this.files) {
					file = this.files[id];
					switch (file.type) {
					case 'blob':
						blobsSize += file.size;
						break;
					case 'file':
					default:
						filesSize += file.size;
					}
				}
				this.$filesSize = $el.find('.attachments-files-size');
				this.$filesSize.text(this._formatSize(filesSize));
				this.$filesSize.data('files-size', 0);

				var filesMaxSize = this.options.filesMaxSize;
				this.$filesMaxSize = $el.find('.attachments-files-max-size');
				this.$filesMaxSize.text(this._formatSize(filesMaxSize));
				this.$filesMaxSize.data('files-max-size', filesMaxSize);

				this.$blobsSize = $el.find('.attachments-blobs-size');
				this.$blobsSize.text(this._formatSize(blobsSize));
				this.$blobsSize.data('blobs-size', 0);

				var blobsUsage = this.options.blobsUsage;
				var blobsQuota = this.options.blobsQuota;
				var blobsFree = blobsQuota - blobsUsage;

				this.$blobsFree = $el.find('.attachments-blobs-available');
				this.$blobsFree.text(this._formatSize(blobsFree));
				this.$blobsFree.data('blobs-free', blobsFree);

				this.$blobsQuota = $el.find('.attachments-blobs-quota');
				this.$blobsQuota.text(this._formatSize(blobsQuota));
				this.$blobsQuota.data('blobs-quota', blobsQuota);

				if (this.options.blobQuotaURL) {
					$.get(this.options.blobQuotaURL, function(data) {
						var lines = data.split(/\r\n|\r|\n/);
						var line, tokens;
						var usage, quota;
						for (var i = 0; i < lines.length; i++) {
							line = lines[i];
							switch (i) {
							case 0: // Result_Code=200
								if (line == 'Result_Code=500') {
									self.$blobsFree.data('blobs-free', 0);
									self.$blobsFree.text(self._formatSize(0));
									self.$blobsQuota.data('blobs-quota', 0);
									self.$blobsQuota.text(self._formatSize(0));
									return;
								}
								break;
							case 1: // Disk_Usage=0
								tokens = line.split('=');
								usage = parseInt(tokens[1]);
								break;
							case 2: // Disk_Quota=1073741824
								tokens = line.split('=');
								quota = parseInt(tokens[1]);
								break;
							}
						}
						var free = quota - usage;
						self.$blobsFree.data('blobs-free', free);
						self.$blobsFree.text(self._formatSize(free));
						self.$blobsQuota.data('blobs-quota', quota);
						self.$blobsQuota.text(self._formatSize(quota));
						self._initAttachmentItems();
					}).fail(function() {
						self.$blobsFree.data('blobs-free', 0);
						self.$blobsFree.text(self._formatSize(0));
						self.$blobsQuota.data('blobs-quota', 0);
						self.$blobsQuota.text(self._formatSize(0));
						self._initAttachmentItems();
					});
				}
			},
			_showAttachmentsSize : function() {
				var self = this, $el = this.$el;
				var $list = $el.find('.attachments-list');
				var $items = $list.children('.attachments-item');
				var filesSize = 0, blobsSize = 0;
				$items.each(function(index, element) {
					// this === element
					var $item = $(element);
					var id = $item.data('attachment-id');
					var file = self.files[id];
					var type = $item.data('attachment-type');
					switch (type) {
					case 'blob':
						blobsSize += file.size;
						break;
					case 'file':
					default:
						filesSize += file.size;
					}
				});
				this.$filesSize.data('files-size', filesSize);
				this.$filesSize.text(this._formatSize(filesSize));
				this.$blobsSize.data('blobs-size', blobsSize);
				this.$blobsSize.text(this._formatSize(blobsSize));
			},
			_initAttachmentItems : function() {
				var $list = this.$el.find('.attachments-list');
				for ( var id in this.files) {
					var file = this.files[id];
					var item = this._createAttachmentItem(id, file);
					$list.append(item);
				}
				var $items = $list.find('.attachments-item');
				if ($items.length > 0) {
					var $dropzone = $list.parents('.attachments-dropzone');
					var $droppable = $dropzone.find('.attachments-droppable');
					$droppable.hide();
					$list.show();
					this._showAttachmentsSize();
					if ($dropzone.is(':hidden'))
						this.parentView.$toggleAttachments.click();
				}
			}, // _initAttachmentItems
			_createAttachmentItem : function(id, file) {
				var filesSize = this.$filesSize.data('files-size');
				var filesMaxSize = this.options.filesMaxSize;
				var blobsSize = this.$blobsSize.data('blobs-size');
				var blobsFree = this.$blobsFree.data('blobs-free');
				var blobsQuota = this.$blobsQuota.data('blobs-quota');
				var sum = filesSize + file.size;
				if ((blobsQuota == 0 || file.type == 'file') && (file.size > filesMaxSize || sum > filesMaxSize)) {
					alert(i18n.attachment.leadingMaxFileSize + this._formatSize(filesMaxSize)
							+ i18n.attachment.middlingMaxFileSize + this._formatSize(filesSize)
							+ i18n.attachment.trailingMaxFileSize);
					return null;
				}
				if (file.size > filesMaxSize || sum > filesMaxSize) {
					var free = blobsFree - blobsSize - file.size;
					if (free <= 0) {
						alert(i18n.attachment.leadingMaxBlobSize + this._formatSize(blobsFree)
								+ i18n.attachment.middlingMaxBlobSize + this._formatSize(blobsSize)
								+ i18n.attachment.trailingMaxBlobSize);
						return null;
					}
				}
				var model = new Backbone.Model({
					id : id,
					name : file.name,
					size : file.size,
					type : file.type,
					loaded : (file.loaded ? file.loaded : 0),
					status : (file.status ? file.status : 'queued'),
				});
				var attachmentsItemView = new mail.AttachmentsItemView({
					model : model,
					diskUserModel : this.model,
					parentView : this,
				});
				return attachmentsItemView.render().el;
			},
			_uid : function() {
				var now = Date.now ? Date.now() : new Date().getTime();
				var random = Math.floor(Math.random() * 1000000);
				return now + '.' + random;
			},
			_formatSize : function(number, pattern) {
				pattern = pattern ? pattern : '0[.]00b';
				var fmt = number ? numeral(number).format(pattern) : '0KB';
				return fmt;
			},
			_showOverlay : function() {
				this.$overlay = $('#attachments-overlay');
				if (!this.$overlay.length) {
					if (document.styleSheets && document.styleSheets[0]) {
						var styles = '';
						styles += '-ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=50)";';
						styles += 'filter: alpha(opacity=50);';
						styles += '-moz-opacity: 0.5;';
						styles += '-khtml-opacity: 0.5;';
						styles += 'opacity: 0.5;';
						var styleSheet = document.styleSheets[0];
						var rules;
						try {
							rules = styleSheet.cssRules || styleSheet.rules;
						} catch (error) {
							styleSheet = _.find(document.styleSheets, function(styleSheet) {
								var href = styleSheet.href;
								var css = href.substring(href.lastIndexOf('/') + 1);
								return css == 'default.css';
							});
							rules = styleSheet.cssRules || styleSheet.rules;
						}
						if (styleSheet.insertRule) {
							styleSheet.insertRule('#attachments-overlay{' + styles + '}', rules.length);
						} else if (styleSheet.addRule) {
							styleSheet.addRule('#attachments-overlay', styles, rules.length);
						}
					}
					this.$overlay = $('<div id="attachments-overlay"/>').css({
						'position' : 'fixed',
						'top' : '0',
						'left' : '0',
						'width' : '100%',
						'height' : '100%',
						'background' : '#000000',
						'z-index' : this.options.zIndex,
					}).appendTo('body');
					this.$overlay.on('mousedown', function(event) {
						event.preventDefault() && event.stopPropagation();
					});
				}
				this.$overlay.show();
			},
			_hideOverlay : function() {
				this.$overlay.hide();
			},
			addAttachment : function(file) {
				if (!file)
					return;
				var $dropzone = this.$el.find('.attachments-dropzone:first');
				var $content = $dropzone.children('.attachments-list-content');
				var $droppable = $content.children('.attachments-droppable');
				var $list = $content.children('.attachments-list');
				if ($list.is(':hidden')) {
					$droppable.hide();
					$list.show();
				}
				var id = this._uid();
				if (file.id)
					id = file.id;
				var item = this._createAttachmentItem(id, file);
				if (!item)
					return;
				$list.append(item);
				var $items = $list.children('.attachments-item');
				if ($items.length === 0) {
					$list.hide();
					$droppable.show();
					return;
				} else {
					if ($dropzone.is(':hidden')) {
						var $toggleImg = this.parentView.$toggleAttachments.children('img');
						var $header = $dropzone.find('div.attachments-list-header');
						var $footer = this.$el.find('div.attachments-footer');
						$toggleImg.removeClass().addClass('sOpen');
						$header.show();
						$content.show();
						$footer.show();
						$dropzone.show();
					}
				}
				var pos = $content.scrollTop() + $(item).position().top;
				$content.scrollTop(pos);
				this.files[id] = file;
			},
			getAttachmentItems : function() {
				var $list = this.$el.find('.attachments-list');
				var $items = $list.children('.attachments-item');
				return $items;
			},
			upload : function() {
				var self = this, $el = this.$el;
				this.deferred = {
					callbacks : {},
					done : function(callback) {
						this.callbacks['done'] = callback;
						return this;
					},
					fail : function(callback) {
						this.callbacks['fail'] = callback;
						return this;
					},
					always : function(callback) {
						this.callbacks['always'] = callback;
						return this;
					}
				};
				var $items = this.getAttachmentItems();
				if ($items.length === 0) {
					setTimeout(function() {
						var done = self.deferred.callbacks['done'];
						done && done.call();
						var always = self.deferred.callbacks['always'];
						always && always.call();
					}, 100);
					return this.deferred;
				}
				this._showOverlay();
				var models = [];
				$items.each(function(index, element) {
					var id = $(element).data('attachment-id');
					models.push({
						id : id,
						item : element,
						file : self.files[id],
					});
				});
				var collection = new Backbone.Collection(models);
				this.uploadView = new mail.AttachmentsUploadView({
					collection : collection,
					parentView : this,
				});
				var $uploadView = this.uploadView.render().$el;
				var zIndex = this.$overlay.css('z-index');
				zIndex = isNaN(zIndex) ? 'auto' : parseInt(zIndex) + 1;
				$uploadView.css('z-index', zIndex);
				$uploadView.show().appendTo('body');
				this._centerElementInWindow($uploadView);
				setTimeout(function() {
					self.uploadView.upload(self._uploadCallback, self);
				}, 100);
				return this.deferred;
			},
			_uploadCallback : function() {
				this.uploadView.remove();
				this.$overlay.hide();
				if (this.uploadView.done) {
					this.deferred.callbacks['done'].call();
				} else if (this.uploadView.fail) {
					this.deferred.callbacks['fail'].call(this.uploadView);
				}
				var always = this.deferred.callbacks['always'];
				always && always.call();
			},
			_centerElementInWindow : function($element) {
				var $viewport = $(window);
				$viewport.resize(function(event) {
					var viewportWidth = $viewport.width() / 2;
					var viewportHeight = $viewport.height() / 2;
					var width = $element.width() / 2;
					var height = $element.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					$element.css({
						top : top,
						left : left
					});
				});
				$viewport.resize();
			},
		}); // mail.AttachmentsView

		mail.AttachmentsItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			className : 'attachments-item',
			template : function(data) {
				var html, compiledTemplate = mail.AttachmentsItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#attachments-item-template').html();
					compiledTemplate = _.template(html);
					mail.AttachmentsItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					file : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.diskUserModel = options.diskUserModel;
				this.parentView = options.parentView;
				this.options = this.parentView.options;
			},
			onRender : function() {
				var self = this, $item = this.$el, options = this.options;

				$item.data('attachment-id', this.model.id);
				$item.data('attachment-name', this.model.get('name'));
				$item.data('attachment-size', this.model.get('size'));
				$item.data('attachment-loaded', this.model.get('loaded'));
				$item.data('attachment-status', this.model.get('status'));

				var $filesSize = this.parentView.$filesSize;
				var $blobsSize = this.parentView.$blobsSize;
				var $blobsFree = this.parentView.$blobsFree;

				var $status = $item.find('.status');
				var $type = $item.find('.attach_type span:first');
				var $convert = $item.find('.attach_type .chg_type');
				var $validity = $item.find('.down_period');

				var type = this.model.get('type');
				var name = this.model.get('name');
				var size = this.model.get('size');
				var filesSize = $filesSize.data('files-size');
				var blobsSize = $blobsSize.data('blobs-size');
				switch (type) {
				case 'blob':
					if (!this._isBlobAcceptable(name)) {
						this._alertBlobNotAcceptable(name);
						setTimeout(function() {
							self.close();
							self.parentView._showAttachmentsSize();
						}, 250);
						return;
					}
					$status.text(i18n.attachment.done);
					var days = options.blobExpirationDays;
					var date = this._dateAfterDays(days);
					$item.data('attachment-type', 'blob');
					$type.text(i18n.attachment.blob);
					$convert.prop('disabled', true).attr('disabled', 'disabled');
					$validity.text(i18n.attachment.leadingValidityDays + date + i18n.attachment.middlingValidityDays
							+ days + i18n.attachment.trailingValidityDays);
					$blobsSize.data('blobs-size', blobsSize + size);
					this.listenToOnce(this.diskUserModel, 'change', this.render);
					break;
				case 'file':
					$status.text(i18n.attachment.done);
				default:
					var attahcmentType = $item.data('attachment-type');
					var days = this.options.blobExpirationDays;
					var date = this._dateAfterDays(days);
					var sum = filesSize + size;
					if (size > this.options.filesMaxSize) {
						if (!this._isBlobAcceptable(name)) {
							this._alertBlobNotAcceptable(name);
							setTimeout(function() {
								self.close();
								self.parentView._showAttachmentsSize();
							}, 250);
							return;
						}
						$item.data('attachment-type', 'blob');
						$type.text(i18n.attachment.blob);
						$validity.text(i18n.attachment.leadingValidityDays + date
								+ i18n.attachment.middlingValidityDays + days + i18n.attachment.trailingValidityDays);
						$convert.prop('disabled', true).attr('disabled', 'disabled');
						$blobsSize.data('blobs-size', blobsSize + size);
						this.listenToOnce(this.diskUserModel, 'change', this.render);
					} else if (sum > this.options.filesMaxSize || attahcmentType == 'blob') {
						if (!this._isBlobAcceptable(name)) {
							this._alertBlobNotAcceptable(name);
							setTimeout(function() {
								self.close();
								self.parentView._showAttachmentsSize();
							}, 250);
							return;
						}
						$item.data('attachment-type', 'blob');
						$type.text(i18n.attachment.blob);
						$validity.text(i18n.attachment.leadingValidityDays + date
								+ i18n.attachment.middlingValidityDays + days + i18n.attachment.trailingValidityDays);
						$blobsSize.data('blobs-size', blobsSize + size);
						this.listenToOnce(this.diskUserModel, 'change', this.render);
					} else {
						if (!this._isFileAcceptable(name)) {
							this._alertFileNotAcceptable(name);
							setTimeout(function() {
								self.close();
								self.parentView._showAttachmentsSize();
							}, 250);
							return;
						}
						if (name.length > 80){
							alert(i18n.attachment.cannotFileName);
							setTimeout(function() {
								self.close();
								self.parentView._showAttachmentsSize();
							}, 250);
							return;
						}
						$item.data('attachment-type', 'file');
						$type.text(i18n.attachment.file);
						$validity.text(i18n.attachment.unlimited);
						$filesSize.data('files-size', filesSize + size);
					}
				}

				$convert.mousedown(function(event) {
					var size = $item.data('attachment-size');
					var type = $item.data('attachment-type');
					switch (type) {
					case 'file':
						if (!self._isBlobAcceptable(name)) {
							self._alertBlobNotAcceptable(name);
							break;
						}
						var blobsSize = $blobsSize.data('blobs-size');
						var blobsFree = $blobsFree.data('blobs-free');
						var sum = blobsSize + size;
						if (size >= blobsFree || sum >= blobsFree) {
							alert(i18n.attachment.leadingMaxBlobSize + numeral(blobsFree).format('0[.]00b')
									+ i18n.attachment.middlingMaxBlobSize + numeral(blobsSize).format('0[.]00b')
									+ i18n.attachment.trailingMaxBlobSize);
							break;
						}
						$item.data('attachment-type', 'blob');
						$type.text(i18n.attachment.blob);
						days = self.options.blobExpirationDays;
						date = self._dateAfterDays(days);
						$validity.text(i18n.attachment.leadingValidityDays + date
								+ i18n.attachment.middlingValidityDays + days + i18n.attachment.trailingValidityDays);
						self.listenToOnce(self.diskUserModel, 'change', self.render);
						break;
					case 'blob':
					default:
						if (!self._isFileAcceptable(name)) {
							self._alertFileNotAcceptable(name);
							break;
						}
						if (name.length > 80){
							alert(i18n.attachment.cannotFileName);
							return;
						}
						var filesMaxSize = self.options.filesMaxSize;
						var filesSize = $filesSize.data('files-size');
						var sum = filesSize + size;
						if (size >= filesMaxSize || sum >= filesMaxSize) {
							alert(i18n.attachment.leadingMaxFileSize + numeral(filesMaxSize).format('0[.]00b')
									+ i18n.attachment.middlingMaxFileSize + numeral(filesSize).format('0[.]00b')
									+ i18n.attachment.trailingMaxFileSize);
							break;
						}
						$item.data('attachment-type', 'file');
						$type.text(i18n.attachment.file);
						$validity.text(i18n.attachment.unlimited);
						self.stopListening(self.diskUserModel);
					}
					self.parentView._showAttachmentsSize();
				});

				var $checkbox = $item.find('input:checkbox');
				$checkbox.change(function(event) {
					var $dropzone = $item.parents('.attachments-dropzone:first');
					var $header = $dropzone.children('.attachments-list-header');
					var $toggle = $header.find('input:checkbox');
					var $content = $dropzone.children('.attachments-list-content');
					var $list = $content.children('.attachments-list');
					var $checkboxes = $list.find('input:checkbox');
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length) {
							$toggle.prop('checked', true);
						}
					} else {
						$toggle.removeAttr('checked');
					}
				});
			}, // onRender
			_dateAfterDays : function(days) {
				var now = Date.now ? Date.now() : new Date().getTime();
				var after = now + days * 24 * 60 * 60 * 1000;
				var date = $.format.date(new Date(after), 'yy/MM/dd');
				return date;
			},
			_makePattern : function(pattern) {
				if (!pattern || typeof pattern !== 'string')
					return "";
				pattern = pattern.replace(/\s|\*/g, '');
				var specialCharacters = "^$.*+?=!:|\/()[]{}";
				var expr = [];
				var ch = '';
				for (var i = 0; i < pattern.length; i++) {
					ch = pattern.charAt(i);
					if (specialCharacters.indexOf(ch) != -1)
						expr.push("\\");
					expr.push(ch);
				}
				pattern = expr.join("");
				pattern = pattern.replace(/,/g, '|');
				return pattern;
			},
			_isFileAcceptable : function(filename) {
				var type = app.domainModel.get('DOMAIN_EXTTYPE');
				var blockedExtensions = app.domainModel.get('DOMAIN_BLOCKEXT');
				var allowedExtensions = app.domainModel.get('DOMAIN_ALLOWEXT');
				var expr, pattern;
				switch (type) {
				case 'black':
					expr = this._makePattern(blockedExtensions);
					if (!expr)
						break;
					pattern = new RegExp('(' + expr + ')$', 'i');
					if (pattern.test(filename))
						return false;
					break;
				case 'white':
					expr = this._makePattern(allowedExtensions);
					if (!expr)
						break;
					pattern = new RegExp('(' + expr + ')$', 'i');
					if (!pattern.test(filename))
						return false;
					break;
				}
				return true;
			},
			_isBlobAcceptable : function(filename) {
				var items = [];
				app.diskFileFilterCollection.each(function(model, index, list) {
					var item = model.get('FILTER_ITEM');
					if (item)
						items.push(item);
				});
				var expr = this._makePattern(items.join(","));
				if (!expr)
					return true;
				var pattern = new RegExp('(' + expr + ')$', 'i');
				if (pattern.test(filename))
					return false;
				return true;
			},
			_alertFileNotAcceptable : function(name) {
				var type = app.domainModel.get('DOMAIN_EXTTYPE');
				switch (type) {
				case 'white':
					alert(i18n.attachment.leadingAllowedFileExtention + app.domainModel.get('DOMAIN_ALLOWEXT')
							+ i18n.attachment.trailingAllowedFileExtention);
					break;
				case 'black':
					alert(i18n.attachment.leadingBlockedFileExtention + app.domainModel.get('DOMAIN_BLOCKEXT')
							+ i18n.attachment.trailingBlockedFileExtention);
					break;
				}
				return;
			},
			_alertBlobNotAcceptable : function(name) {
				var items = [];
				app.diskFileFilterCollection.each(function(model, index, list) {
					var item = model.get('FILTER_ITEM');
					if (item)
						items.push(item);
				});
				alert(i18n.attachment.leadingBlockedFileExtention + items.join(',')
						+ i18n.attachment.trailingBlockedFileExtention);
				return;
			}
		}); // mail.AttachmentItemView

		mail.AttachmentsUploadView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'mc-dh_layer',
			template : function(data) {
				var html, compiledTemplate = mail.AttachmentsUploadView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#attachments-upload-template').html();
					compiledTemplate = _.template(html);
					mail.AttachmentsUploadView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					items : data.items,
					popup : isPopup(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection = options.collection
				this.parentView = options.parentView; // mail.AttachmentsView
				this.fail = false;
				this.done = false;
			},
			onRender : function() {
				var self = this, $el = this.$el;

				this.$totalProgressPercent = $el.find('.progress_bar .total');
				this.$totalProgressBar = $el.find('.p_bar .p_bar_value:first');

				this.$transferFiles = $el.find('#transfer-files');
				this.$transferRate = $el.find('#transfer-rate');
				this.$transferBytes = $el.find('#transfer-bytes');
				this.$transferTime = $el.find('#transfer-time');

				this.$close = $el.find('img.lClose:first');
				this.$close.click(function(event) {
					self.xhr && self.xhr.abort();
				});
				this.$pause = $el.find('div.addButton.nb button');
				this.$pause.click(function(event) {
					self.xhr && self.xhr.abort();
				});
			},
			upload : function(callback, context) {
				var self = this, $el = this.$el, collection = this.collection;
				var options = this.parentView.options;
				var totalLoaded = 0, totalBytes = 0, totalPercent = 0, totalRate = 0;
				var actualLoaded = 0, actualTotal = 0;
				var startTime = this._now();
				collection.each(function(model, index) {
					var $item = $(model.get('item'));
					totalLoaded += $item.data('attachment-loaded');
					totalBytes += model.get('file').size;
					if (status !== 'done') {
						var loaded = $item.data('attachment-loaded');
						var size = $item.data('attachment-size');
						actualTotal += (size - loaded);
					}
					if (model.get('file').msClose && !document.msFileUploadIframe) {
						$('<iframe>', { // IE10, IE11
							'name' : 'msFileUploadIframe',
							'style' : 'position: absolute; display: none;',
							'src' : '/mail/attachment/fileUpload',
						}).appendTo('body');
					}
				});
				var uploadables = [];
				collection.each(function(model, index) {
					uploadables.push(function() {
						self.$transferFiles.text((index + 1) + '/' + collection.length);
						var $item = $(model.get('item'));
						var id = model.get('id');
						var file = model.get('file');
						var type = $item.data('attachment-type');
						var status = $item.data('attachment-status');
						if (status === 'done') {
							var $form = $(options.form);
							var $input;
							switch (type) {
							case 'blob':
								$input = $('<input>', {
									type : 'hidden',
									name : options.blobInputName,
									value : id + '/' + encodeURIComponent(file.name),
								}).data('file-size', file.size);
								if (file.type === 'file') {
									$input.val('blob.' + $input.val());
								}
								break;
							case 'file':
							default:
								$input = $('<input>', {
									type : 'hidden',
									name : options.fileInputName,
									value : id + '/' + encodeURIComponent(file.name),
								}).data('file-size', file.size);
							}
							var value = $input.val();
							var $inputs = $form.find('input[name="' + options.fileInputName + '"]');
							$inputs = $inputs.add($form.find('input[name="' + options.blobInputName + '"]'))
							$inputs = $inputs.filter(function(index, element) {
								var pathname = $(element).val();
								if (pathname === value)
									return true;
								if (type === 'file' && pathname === 'blob.' + value)
									$(element).remove();
								return false;
							});
							if ($inputs.length === 0) {
								$form.append($input);
							}
							if (index < collection.length - 1) {
								try {
									uploadables[index + 1].call();
								} catch (error) {
									app.log(error);
									self.fail = true;
									callback.call(context);
								}
							} else {
								self.done = true;
								callback.apply(context);
							}
							return;
						}

						var url;
						switch (type) {
						case 'blob':
							url = options.blobUploadURL;
							break;
						case 'file':
						default:
							url = options.fileUploadURL;
						}

						var link = document.createElement('a');
						link.href = url;
						if (/^\?/.test(link.search))
							url += '&dir=' + encodeURIComponent(id);
						else
							url += '?dir=' + encodeURIComponent(id);

						var xhr = self.xhr = new XMLHttpRequest();
						xhr.open('POST', url);
						xhr.onreadystatechange = function() {
							if (xhr.readyState === 4) {
								switch (xhr.status) {
								case 200:
									if (file.msClose) { // IE10, IE11
										file.msClose();
										var iframe = document.msFileUploadIframe;
										if (iframe && iframe.location) {
											iframe.location.reload(true);
										}
									}
									setTimeout(function() {
										if (index < collection.length - 1) {
											try {
												uploadables[index + 1].call();
											} catch (error) {
												app.log(error);
												self.fail = true;
												callback.call(context);
											}
										} else {
											self.done = true;
											callback.apply(context);
										}
									}, 100);
									break;
								default:
									xhr.upload.onerror();
								}
							}
						};

						var formData = new FormData();
						if (document.msFileUploadIframe) {
							if (!document.forms.msFileUploadForm)
								$('<form>', {
									'name' : 'msFileUploadForm',
									'target' : 'msFileUploadIframe',
									'style' : 'position: absolute; display: none;',
								}).appendTo('body');
							formData = new FormData(document.forms.msFileUploadForm);
						}

						if (type === 'blob' && $item.data('blob-password')) {
							var blobPassword = $item.data('blob-password');
							formData.append('password', blobPassword);
						}
						formData.append(id, file);

						var $fileItem = $el.find('#file_id_' + id.replace(/\./, '_'));
						var $progress = $fileItem.find('.file_progress');
						var $progressBytes = $progress.find('.st');
						var $progressBar = $progress.find('.p_bar .p_bar_value');
						var $progressStatus = $progress.find('.transfer_status');

						var $parent = $fileItem.parents('.upld_file_list:first');
						var top = $parent.scrollTop() + $fileItem.position().top;
						$parent.scrollTop(top);

						var prevLoaded = 0;
						xhr.upload.onprogress = function(event) {
							if (status !== 'loading') {
								$item.data('attachment-status', 'loading');
								$item.find('.status').text(i18n.attachment.uploading);
								$progressStatus.text(i18n.attachment.uploading);
								status = 'loading';
							}
							if (event.lengthComputable) {
								var overloaded = 0;
								var loaded = event.loaded;
								var total = event.total;
								$item.data('attachment-loaded', loaded);
								var transferred = loaded - prevLoaded;
								totalLoaded += transferred;
								actualLoaded += transferred;
								if (totalLoaded > totalBytes) {
									overloaded = totalLoaded - totalBytes;
									totalLoaded = totalLoaded - overloaded;
								}
								if (transferred > 0) {
									var position = self._formatSize(totalLoaded) + '/' + self._formatSize(totalBytes);
									self.$transferBytes.text(position);
									var pos = self._formatSize(loaded) + '/' + self._formatSize(total);
									$progressBytes.text(pos);
								}
								prevLoaded = loaded - overloaded;
								var percent = Math.round(totalLoaded / totalBytes * 100);
								if (percent != totalPercent) {
									totalPercent = percent;
									self.$totalProgressPercent.text(percent + '%');
									self.$totalProgressBar.css('width', percent + '%');
								}
								percent = Math.round(loaded / total * 100);
								$progressBar.css('width', percent + '%');
								var elapsedTime = self._now() - startTime;
								if (elapsedTime == 0)
									interval = 1;
								var rate = Math.round(actualLoaded * 1000 / elapsedTime);
								if (totalRate != rate) {
									totalRate = rate;
									var speed = self._formatSize(rate);
									self.$transferRate.text(speed + i18n.attachment.perSecond);
								}
								var remainingBytes = actualTotal - actualLoaded;
								var remainingTime = Math.floor(remainingBytes / rate * 1000);
								var estimatedTime = elapsedTime + remainingTime;
								var time = '';
								if (elapsedTime > 60000)
									time += Math.floor(elapsedTime / 60000) + i18n.attachment.elapsedMinutes;
								time += Math.floor(elapsedTime % 60000 / 1000) + i18n.attachment.elapsedSeconds;
								time += ' / ';
								if (estimatedTime > 60000)
									time += Math.floor(estimatedTime / 60000) + i18n.attachment.elapsedMinutes;
								time += Math.floor(estimatedTime % 60000 / 1000) + i18n.attachment.elapsedSeconds;
								self.$transferTime.text(time);
							} // end if (event.lengthComputable)
						}; // xhr.upload.onprogress
						xhr.upload.onabort = function(event) {
							$item.data('attachment-status', 'abort');
							$item.find('.status').text(i18n.attachment.aborted);
							$progressStatus.text(i18n.attachment.aborted);
							self.fail = true;
							callback.call(context);
						}; // xhr.upload.onabort
						xhr.upload.onload = function(event) {
							$item.data('attachment-status', 'done');
							$item.find('.status').text(i18n.attachment.uploaded);
							$progressStatus.text(i18n.attachment.uploaded);
							var $form = $(options.form);
							var $input;
							switch (type) {
							case 'blob':
								$input = $('<input>', {
									type : 'hidden',
									name : options.blobInputName,
									value : id + '/' + encodeURIComponent(file.name)
								}).data('file-size', file.size);
								break;
							case 'file':
							default:
								$input = $('<input>', {
									type : 'hidden',
									name : options.fileInputName,
									value : id + '/' + encodeURIComponent(file.name)
								}).data('file-size', file.size);
							}
							var $inputs = $form.find('input[name="' + options.fileInputName + '"]');
							$inputs = $inputs.add($form.find('input[name="' + options.blobInputName + '"]'));
							$inputs = $inputs.filter(function(index, element) {
								return $(element).val() === $input.val();
							});
							if ($inputs.length === 0) {
								$form.append($input);
							}
						}; // xhr.upload.onload = function(event) {...}
						xhr.upload.onerror = function(event) {
							if (xhr.status == 406) {
								var type = app.domainDetailsModel.get('mimetypeFilter');
								var msg = file.name + ' ' + i18n.attachment.failedToUpload + '\n';
								switch (type) {
								case 'white':
									msg += i18n.attachment.leadingAllowedFileMimetype;
									msg += app.domainDetailsModel.get('allowedMimetypes');
									msg += i18n.attachment.trailingAllowedFileMimetype;
									break;
								case 'black':
									msg += i18n.attachment.leadingBlockedFileMimetype;
									msg += app.domainDetailsModel.get('blockedMimetypes');
									msg += i18n.attachment.trailingBlockedFileMimetype
									break;
								}
								alert(msg);

								$item.data('attachment-loaded', 0);
								$item.data('attachment-status', '');
								$item.find('.status').text('');
								var $form = $(options.form);
								var value = id + '/' + encodeURIComponent(file.name);
								var $inputs = $form.find('input[name="' + options.fileInputName + '"]');
								$inputs = $inputs.add($form.find('input[name="' + options.blobInputName + '"]'));
								var $input = $inputs.filter(function(index, element) {
									return $(element).val() === value;
								});
								if ($input.length)
									$input.remove();
							}
							self.fail = true;
							callback.call(context);
						};
						xhr.send(formData);
					}); // uploadables[].push(function() {...});
				}); // collection.each(function(model, index) {...});
				if (uploadables.length) {
					try {
						uploadables[0].call();
					} catch (error) {
						app.log(error);
						this.fail = true;
						callback.call(context);
					}
				} else {
					this.done = true;
					callback.call(context);
				}
			}, // upload : function() {...}
			_formatSize : function(number, pattern) {
				pattern = typeof pattern === 'string' ? pattern : '0.0b';
				return numeral(number).format(pattern);
			},
			_now : function() {
				return Date.now ? Date.now() : new Date().getTime();
			},
		}); // mail.AttachmentsUploadView

		mail.DaumEditorView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'tx_trex_container',
			className : 'tx-editor-container',
			template : function(data) {
				var html, compiledTemplate = mail.DaumEditorView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#daum-editor-template').html();
					compiledTemplate = _.template(html);
					mail.DaumEditorView.compiledTemplate = compiledTemplate;
				}
				var basePath = 'js/lib/daumeditor-7.5.11/';
				if (isPopup())
					basePath = '../js/lib/daumeditor-7.5.11/';
				html = compiledTemplate({
					i18n : i18n,
					basePath : basePath,
				});
				return html;
			},
			initialize : function(options) {
				this.config = options.config;
				this.clearInputs = options.clearInputs;
				this.hideSignature = options.hideSignature;
				this.hideStationery = options.hideStationery;
				this.hideDocumentForm = options.hideDocumentForm;
				this.contentLayoutView = options.contentLayoutView;
			},
			onRender : function() {
				// do nothing
			},
			onShow : function() {
				var basePath = 'js/lib/daumeditor-7.5.11/';
				if (isPopup())
					basePath = '../js/lib/daumeditor-7.5.11/';
				var config = {
					//       ,      .
					// ex) http://xxx.xxx.com
					txHost : '',
					//       ,      .
					// ex) /xxx/xxx/
					txPath : '',
					txService : 'sample', // .
					txProject : 'sample',
					//   
					initializedId : "",
					//     ( )
					wrapper : "tx_trex_container",
					//   Form  ex) tx_editor_form
					form : 'mail_write_form',
					//    ,   .
					txIconPath : basePath + "images/icon/editor/",
					//    ,        
					// .
					txDecoPath : basePath + "images/deco/contents/",
					canvas : {
						styles : {
							color : "#000000", //  
							fontFamily : this.config.fontFamily, //  
							fontSize : this.config.fontSize, //  
							backgroundColor : "#fff", //  
							lineHeight : "1.5", //  
							padding : "8px" //   
						},
						selectedMode : this.config.selectedMode, //   
						showGuideArea : false
					},
					events : {
						preventUnload : false
					},
					sidebar : {
						attachbox : {
							show : true
						}
					},
					size : {
					//      
					// contentWidth : 700
					}
				};
				if (this.$el.is(':visible')) {
					if (mail.DaumEditorView.contentWidth) {
						config.size.contentWidth = mail.DaumEditorView.contentWidth;
					}
					var editor = new Editor(config);
					Editor.switchEditor(config.initializedId);
					var self = this;
					Editor.getToolbar().observeJob(Trex.Ev.__TOOL_CLICK, function(identity) {
						self.clearInputs(Editor);
					});
					Editor.getCanvas().observeJob(Trex.Ev.__CANVAS_PANEL_CLICK, function(ev) {
						self.clearInputs(Editor);
						self.hideSignature();
						self.hideStationery();
						self.hideDocumentForm();
					});
					Editor.getCanvas().observeJob(Trex.Ev.__CANVAS_TEXT_PANEL_CLICK, function(ev) {
						self.clearInputs(Editor);
						self.hideSignature();
						self.hideStationery();
						self.hideDocumentForm();
					});
					Editor.getCanvas().observeJob(Trex.Ev.__CANVAS_PANEL_DRAGOVER, function(ev) {
						self.contentLayoutView.$el.trigger('dragenter', ev);
					});
					if (!mail.DaumEditorView.viewportWidth) {
						mail.DaumEditorView.viewportWidth = $(window).width();
						mail.DaumEditorView.containerWidth = Editor.getCanvas().getContainerWidth();
					}
					$(window).off('resize.editor').on('resize.editor', function(event) {
						var $this = $(this);
						var namespace = mail.DaumEditorView;
						var viewportWidth = namespace.viewportWidth;
						var containerWidth = namespace.containerWidth;
						var diff = viewportWidth - $this.width();
						namespace.contentWidth = containerWidth - diff;
					}).trigger('resize.editor');
				}
			},
			getContent : function() {
				var content = Editor.getContent();
				return content;
			},
			setContent : function(content) {
				if (this.$el.is(':visible')) {
					Editor.getCanvas().observeJob(Trex.Ev.__IFRAME_LOAD_COMPLETE, function() {
						Editor.modify({
							content : content
						});
						// Editor.focusOnTop();
						// Editor.focusOnBottom();
						// Editor.focus();
					});
					/*
					 * Editor.getCanvas().observeJob(Trex.Ev.__CANVAS_PANEL_KEYDOWN,
					 * function(event) { Editor.focusOnBottom();
					 * Editor.focusOnTop(); });
					 */
				}
			},
		}); // mail.DaumEditorView

		TrexConfig.addTool('inline-image', {});
		Trex.Tool.InlineImage = Trex.Class.create({
			$const : {
				__Identity : 'inline-image'
			},
			$extend : Trex.Tool,
			oninitialized : function(config) {
				var _tool = this;
				var _showOverlay = function() {
					var $overlay = $('#inline-images-overlay');
					if (!$overlay.length) {
						$overlay = $('<div id="inline-images-overlay"/>').css({
							'z-index' : 2015,
							'position' : 'fixed',
							'top' : '0',
							'left' : '0',
							'width' : '100%',
							'height' : '100%',
							'background' : '#000',
							'opacity' : '0.5',
							'filter' : 'alpha(opacity=50)'
						}).appendTo('body');
						$overlay.on('mousedown', function(event) {
							event.preventDefault() && event.stopPropagation();
						});
						var $loadingOverlay = $('<div id="loading-inline-images"/>').css({
							'z-index' : 2016,
							'position' : 'fixed',
							'text-align' : 'center'
						}).appendTo($overlay);
						var url = isPopup() ? '../img' : 'img';
						var $loadingOuter = $('<span />').css({
							'display' : 'inline-block',
							'background' : 'transparent url(' + url + '/loading_span_bg.png) no-repeat',
							'background-position' : 'left top',
							'padding-left' : '2px',
						}).appendTo($loadingOverlay);
						var $loadingInner = $('<span />').css({
							'display' : 'inline-block',
							'background' : 'transparent url(' + url + '/loading_span_bg.png) no-repeat',
							'background-position' : 'right -49px',
							'padding-right' : '2px',
						}).appendTo($loadingOuter);
						var $loadingContent = $('<span />').css({
							'display' : 'inline-block',
							'background' : 'transparent url(' + url + '/loading_span_bg.png) repeat-x',
							'background-position' : 'left -98px',
							'line-height' : '39px',
							'padding' : '0 18px 0 9px',
							'color' : '#fff',
						}).appendTo($loadingInner);
						var src = isPopup() ? '../img' : 'img';
						$loadingContent.append($('<img />', {
							src : src + '/ico_ld_cm.gif',
							width : 17,
							height : 17,
							style : 'vertical-align: middle; margin-right: 10px',
						}));
						$loadingContent.append('<strong>' + i18n.editor.image + '</span>');
						$loadingContent.append(document.createTextNode(i18n.editor.uploading));

						var $viewport = $(window);
						$viewport.resize(function(event) {
							var viewportWidth = $viewport.width() / 2;
							var viewportHeight = $viewport.height() / 2;
							var width = $loadingOverlay.width() / 2;
							var height = $loadingOverlay.height() / 2;
							var top = Math.floor(viewportHeight - height);
							var left = Math.floor(viewportWidth - width);
							$loadingOverlay.css({
								'top' : top,
								'left' : left,
							});
						});
						$viewport.resize();
					}
					$overlay.show();
				}; // var _showOverlay = function() {...}
				var _hideOverlay = function() {
					var $overlay = $('#inline-images-overlay');
					$overlay.hide();
				};
				var _cid = function() {
					var now = Date.now ? Date.now() : new Date().getTime();
					var random = Math.floor(Math.random() * 1000000);
					return now + '.' + random;
				};
				var $fileInput = $('body > input#inline_images');
				if ($fileInput.length) {
					$fileInput.remove();
				}
				$fileInput = $('<input>', {
					'id' : 'inline_images',
					'type' : 'file',
					'accept' : 'image/*',
					'multiple' : 'true',
					'style' : 'position: absolute; top: -10000px; left: -10000px;'
				}).appendTo('body');
				$fileInput.change(function(event) {
					_showOverlay();
					var $this = $(this);
					var files = this.files;
					var cid = _cid(), cids = [];
					var formData = new FormData();
					$.each(files, function(index, file) {
						var name = cid + '.' + index;
						if (file.name && file.name.indexOf('.') != -1)
							name += file.name.substring(file.name.lastIndexOf('.'));
						cids.push(name);
						formData.append(name, file);
					});
					var url = isPopup() ? '../inline' : 'inline';
					var xhr = new XMLHttpRequest();
					xhr.open('POST', url);
					xhr.onreadystatechange = function() {
						if (xhr.readyState === 4) {
							switch (xhr.status) {
							case 406:
								alert(i18n.attachment.cannotUploadModulationFile);
								break;
							}
							return false;
						}
					};
					xhr.upload.onprogress = function(event) {
						// _showOverlay();
					};
					xhr.upload.onabort = function(event) {
						_hideOverlay();
					};
					xhr.upload.onload = function(event) {
						var $div = $('<div />');
						$.each(cids, function(index, cid) {
							$div.empty();
							var src = isPopup() ? '../inline/' : 'inline/';
							var $img = $('<img>', {
								'src' : src + cid,
								'border' : '0',
							});
							$div.append($img);
							var content = $div.html();
							// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Canvas.html#pasteContent
							Editor.getCanvas().pasteContent(content, true);
						});
						$fileInput.val('');
						_hideOverlay();
					};
					xhr.send(formData);
				}); // $fileInput.change(function(event) {...});
				if (!$fileInput[0].files && !document.inlineImageUploadIframe) {
					$('<iframe>', {
						'name' : 'inlineImageUploadIframe',
						'src' : isPopup() ? '../inline/form' : 'inline/form',
						'style' : 'position: absolute; display: none;',
					}).appendTo('body');
				}
				var _toolHandler = function() {
					if ($fileInput[0].files) {
						$fileInput.click();
						return;
					}
					if (document.inlineImageUploadIframe) {
						var iframe = document.inlineImageUploadIframe;
						var form = iframe.inlineImageUploadForm;
						if (!form || !form.inline)
							return;
						var changed = false;
						form.inline.onchange = function() {
							changed = true;
							return false;
						};
						try {
							form.inline.click();
						} catch (error) {
							app.log(error);
						}
						if (!changed) {
							return;
						}
						form.submit();
						_showOverlay();
						app.vent.once('inline-image:uploaded', function(cid) {
							_hideOverlay();
							var iframe = document.inlineImageUploadIframe;
							var pathname = iframe.location.pathname;
							var url = pathname.substring(0, pathname.lastIndexOf('/')) + '/form';
							iframe.location.replace(url);
							if (!cid) {
								alert(i18n.attachment.cannotUpload);
								return;
							}
							var $div = $('<div />');
							var src = isPopup() ? '../inline/' : 'inline/';
							var $img = $('<img>', {
								'src' : src + cid,
								'border' : '0',
							});
							$div.append($img);
							var content = $div.html();
							// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Canvas.html#pasteContent
							Editor.getCanvas().pasteContent(content, true);
						});
						return;
					} // end if (document.inlineImageUploadIframe)
				}; // var _toolHandler = function() {...};
				var _initHandler = function() {
					// Not Callbacked
					// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Tool.html
				};
				this.weave.bind(this)(new Trex.Button(this.buttonCfg), null, _toolHandler, _initHandler);
			} // oninitialized = function(config) {...}
		}); // Trex.Tool.InlineImage = Trex.Class.create({...});

		TrexConfig.addTool('signature', {});
		Trex.Tool.Signature = Trex.Class.create({
			$const : {
				__Identity : 'signature'
			},
			$extend : Trex.Tool,
			oninitialized : function(config) {
				var _tool = this;
				var _toolHandler = function() {

				};
				var _initHandler = function() {
					// Not Callbacked
					// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Tool.html
				};
				this.weave.bind(this)(new Trex.Button(this.buttonCfg), null, _toolHandler, _initHandler);
			} // oninitialized = function(config) {...}
		}); // Trex.Tool.Stationery = Trex.Class.create({...});

		TrexConfig.addTool('stationery', {});
		Trex.Tool.Stationery = Trex.Class.create({
			$const : {
				__Identity : 'stationery'
			},
			$extend : Trex.Tool,
			oninitialized : function(config) {
				var _tool = this;
				var _toolHandler = function() {

				};
				var _initHandler = function() {
					// Not Callbacked
					// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Tool.html
				};
				this.weave.bind(this)(new Trex.Button(this.buttonCfg), null, _toolHandler, _initHandler);
			} // oninitialized = function(config) {...}
		}); // Trex.Tool.Stationery = Trex.Class.create({...});

		TrexConfig.addTool('document-form', {});
		Trex.Tool.DocumentForm = Trex.Class.create({
			$const : {
				__Identity : 'document-form'
			},
			$extend : Trex.Tool,
			oninitialized : function(config) {
				var _tool = this;
				var _toolHandler = function() {

				};
				var _initHandler = function() {
					// Not Callbacked
					// http://uie.daum.net/openeditor/api/1.5/symbols/Trex.Tool.html
				};
				this.weave.bind(this)(new Trex.Button(this.buttonCfg), null, _toolHandler, _initHandler);
			} // oninitialized = function(config) {...}
		}); // Trex.Tool.Stationery = Trex.Class.create({...});

		mail.SendSecureMailView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 500px; display: none; position: absolute;',
			},
			template : function(data) {
				var html;
				var compiledTemplate = mail.SendSecureMailView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#send-secure-mail-template').html();
					compiledTemplate = _.template(html);
					mail.SendSecureMailView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == { to : '', cc : '', bcc : '' }
			},
			onBeforeRender : function() {
				mail.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('div.close_bt:first');
				var $cancel = this.$el.find('div.ad_btn_area button.layer_cancle');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
				var $password = this.$el.find('input[name="password"]');
				var $confirmPassword = this.$el.find('input[name="confirmPassword"]');
				var $passwordHint = this.$el.find('input[name="passwordHint"]');
				var $contact = this.$el.find('input[name="contact"]');
				var $inputs = $password.add($confirmPassword).add($passwordHint).add($contact);
				$inputs.placeholder();
				var $period = this.$el.find('select[name="period"]');
				var $startDate = this.$el.find('input[name="startDate"]');
				$startDate.datepicker();
				var $endDate = this.$el.find('input[name="endDate"]');
				$endDate.datepicker();
				$period.change(function(event) {
					switch ($(this).val()) {
					case 'unlimited':
						$startDate.val('');
						$endDate.val('');
						break;
					case 'custom':
					default:
						break;
					}
					return false;
				});
				$startDate.add($endDate).change(function(event) {
					if ($period.val() == 'unlimited') {
						$startDate.val('');
						$endDate.val('');
					}
				});
				var $readingLimitSelect = this.$el.find('select[name="readingLimitSelect"]');
				var $readingLimit = this.$el.find('input[name="readingLimit"]');
				$readingLimitSelect.change(function(event) {
					switch ($(this).val()) {
					case 'unlimited':
						$readingLimit.val('');
						break;
					case 'custom':
					default:
						break;
					}
				});
				$readingLimit.keyup(function(event) {
					if ($readingLimitSelect.val() == 'unlimited') {
						$readingLimit.val('');
						return false;
					}
				});
				var $send = this.$el.find('div.ad_btn_area button.b');
				$send.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!$password.val()) {
						alert(i18n.secureMail.enterPassword);
						return false;
					}
					if (/[^\x21-\x7E]+/.test($password.val())) {
						alert(i18n.secureMail.invalidPasswordCharacters);
						return false;
					}
					if (!$confirmPassword.val()) {
						alert(i18n.secureMail.enterConfirmPassword);
						return false;
					}
					if ($password.val() !== $confirmPassword.val()) {
						alert(i18n.secureMail.confirmPasswordNotMatch);
						return false;
					}
					if (!$passwordHint.val()) {
						alert(i18n.secureMail.enterPasswordHint);
						return false;
					}
					if (!$contact.val() && false) {
						alert(i18n.secureMail.enterContact);
						return false;
					}
					var startDate, endDate, dateFormat = $endDate.datepicker('option', 'dateFormat');
					switch ($period.val()) {
					case 'custom':
						try {
							startDate = $.datepicker.parseDate(dateFormat, $startDate.val());
							if (!startDate)
								throw new Error('Invalid Start Date: "' + $startDate.val() + '"');
						} catch (error) {
							alert(i18n.secureMail.invalidStartDate);
							$startDate.val('');
							return false;
						}
						try {
							endDate = $.datepicker.parseDate(dateFormat, $endDate.val());
							if (!endDate)
								throw new Error('Invalid End Date: "' + $endDate.val() + '"');
						} catch (error) {
							alert(i18n.secureMail.invalidEndDate);
							$endDate.val('');
							return false;
						}
						break;
					case 'unlimited':
						startDate = $.format.parseDate('1970-01-01T00:00:00').date;
						endDate = $.format.parseDate('9999-12-31T23:59:59').date;
						break;
					}
					if (startDate.getTime() > endDate.getTime()) {
						alert(i18n.secureMail.invalidEndDate);
						return false;
					}
					var readingLimit = 0;
					switch ($readingLimitSelect.val()) {
					case 'custom':
						readingLimit = parseInt($readingLimit.val());
						if (isNaN(readingLimit)) {
							alert(i18n.secureMail.enterNumber);
							return false;
						}
						if (readingLimit <= 0) {
							alert(i18n.secureMail.enterNumberGreaterThanZero);
							return false;
						}
						break;
					case 'unlimited':
						readingLimit = 0;
						break;
					}
					var getRecipients = function(addresslist) {
						var rcpts = [];
						try {
							var addrs = InternetAddress.parseHeader(addresslist, false);
							for (var i = 0; i < addrs.length; i++) {
								rcpts.push(addrs[i].getAddress());
							}
						} catch (error) {
						}
						return rcpts;
					};
					var recipients = [], data = self.model.toJSON();
					recipients = recipients.concat(getRecipients(data.to));
					recipients = recipients.concat(getRecipients(data.cc));
					recipients = recipients.concat(getRecipients(data.bcc));
					var secureMails = [];
					for (var i = 0; i < recipients.length; i++) {
						secureMails.push({
							recipient : recipients[i],
							password : $password.val(),
							passwordHint : $passwordHint.val(),
							contact : $contact.val(),
							startDate : $.format.date(startDate, 'yyyy-MM-dd'),
							endDate : $.format.date(endDate, 'yyyy-MM-dd'),
							readingLimit : readingLimit
						});
					}
					var model = new (app.BackboneModel.extend({
						url : function() {
							if (isPopup())
								return '../secure-mails';
							else
								return 'secure-mails';
						},
						defaults : {
							secureMails : secureMails,
						}
					}))();
					model.save(null, {
						async : true,
						wait : true,
						success : function(model, resp, options) {
							app.vent.trigger('send:secure-mail', model.toJSON());
							self.close();
						},
						error : function(model, resp, options) {
							alert(i18n.secureMail.failedToSendSecureMail);
						},
					});
					return false;
				}); // $send.click(function(event) {...});
			},
			onClose : function() {
				mail.overlayView.hideOverlay();
			},
		});

		mail.BlobPasswordView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 500px; display: block; position: absolute;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.BlobPasswordView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#blob-password-template').html();
					compiledTemplate = _.template(html);
					mail.BlobPasswordView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// options { Backbone.Model, $blobItems }
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('div.close_bt:first');
				var $cancel = this.$el.find('div.ad_btn_area button.layer_cancle');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
				var $password = this.$el.find('input[name="password"]');
				var $confirmPassword = this.$el.find('input[name="confirmPassword"]');
				$password.add($confirmPassword).placeholder();
				var $save = this.$el.find('div.ad_btn_area button.b');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var password = $password.val();
					var confirmPassword = $confirmPassword.val();
					if (!password) {
						alert(i18n.blobAttachmentPassword.enterPassword);
						return false;
					}
					if (/[^\x21-\x7E]+/.test(password)) {
						alert(i18n.blobAttachmentPassword.invalidPasswordCharacters);
						return false;
					}
					if (!confirmPassword) {
						alert(i18n.blobAttachmentPassword.enterConfirmPassword);
						return false;
					}
					if (password !== confirmPassword) {
						alert(i18n.blobAttachmentPassword.confirmPasswordNotMatch);
						return false;
					}
					self.options.$blobItems.each(function(index, element) {
						$(element).data('blob-password', password);
					});
					self.close();
					app.vent.trigger('send:mail');
					return false;
				}); // $save.click(function(event) {...});
			},
			onShow : function() {
				var self = this;
				var $offsetParent = $('div.mc-container:first');
				this.$overlay = $('<div></div>').css({
					'z-index' : 2015,
					'position' : 'absolute',
					'top' : '0',
					'left' : '0',
					'width' : '100%',
					'height' : '100%',
					'background' : 'tranparent',
					'opacity' : '0.5',
				}).appendTo($offsetParent);
				this.$overlay.on('mousedown', function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				this.$el.css('z-index', parseInt(this.$overlay.css('z-index')) + 1);
				var $viewport = $(window);
				$viewport.off('resize.blobPassword');
				$viewport.on('resize.blobPassword', function(event) {
					var parentWidth = $offsetParent.width() / 2;
					var parentHeight = $offsetParent.height() / 2;
					var width = self.$el.width() / 2;
					var height = self.$el.height() / 2;
					var top = Math.floor(parentHeight - height);
					var left = Math.floor(parentWidth - width);
					self.$el.css({
						'top' : top,
						'left' : left
					});
				});
				$viewport.trigger('resize.blobPassword');
			},
			onClose : function() {
				this.$overlay.remove();
			},
		});

		mail.SearchMboxRegisterView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 480px; display: none; position: absolute;',
			},
			template : function(data) {
				var html;
				var compiledTemplate = mail.SearchMboxRegisterView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#search-mbox-register-template').html();
					compiledTemplate = _.template(html);
					mail.SearchMboxRegisterView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					searchMbox : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.SearchMboxModel
				// this.collection = mail.SearchMboxCollection
				this.mboxCollection = options.mboxCollection;
			},
			onBeforeRender : function() {
				mail.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $name = $el.find('input.search-mbox-name:first');
				var $mboxSelect = $el.find('select.search-mbox-select:first');
				var $excludeTrashAndSpam = $el.find('input[name="excludeTrashAndSpam"]');
				var $from = $el.find('input.search-mbox-from:first');
				var $toOptions = $el.find('select.search-mbox-to-options:first');
				var $to = $el.find('input.search-mbox-to:first');
				var $contentsOptions = $el.find('select.search-mbox-contents-options:first');
				var $contents = $el.find('input.search-mbox-contents:first');
				var $attached = $el.find('input[name="attachedStatus"]');
				var $size = $el.find('input.search-mbox-size:first');
				var $sizeRange = $el.find('input[name="sizeRange"]');
				var $periodSelect = $el.find('select.search-period-select:first');
				var $startDate = $el.find('input.search-start-date:first');
				var $endDate = $el.find('input.search-end-date:first');
				var $save = $el.find('div.ad_btn_area button.layer_save');
				var $close = $el.find('div.close_bt:first');
				var $cancel = $el.find('div.ad_btn_area button.layer_cancle');
				this.renderMboxSelect();
				$mboxSelect.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxId = $(this).val();
					if (mboxId == 'all') {
						$excludeTrashAndSpam.removeAttr('disabled');
					} else {
						$excludeTrashAndSpam.attr('disabled', 'disabled');
					}
				});
				// jQuery UI Datepicker
				$startDate.datepicker();
				$endDate.datepicker();
				$periodSelect.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var period = $(this).val();
					if (period == 'CUSTOM') {
						$($startDate).add($endDate).removeAttr('disabled').val('');
						return false;
					} else {
						$($startDate).add($endDate).attr('disabled', true).val('');
						return false;
					}
				});
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!$name.val() || $name.val().length < 1) {
						alert(i18n.searchMbox.pleaseEnterName);
						return false;
					}
					var terms = '';
					if ($excludeTrashAndSpam.is(':enabled')) {
						terms += 'search.excludeTrashAndSpam=' + $excludeTrashAndSpam.filter(':checked').val();
					}
					if ($from.val()) {
						if (terms.length)
							terms += '&';
						var from = $from.val();
						var regExp = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
						if (regExp.test(from))
							from = encodeURIComponent(from);
						terms += 'search.from=' + from;
					}
					if ($to.val()) {
						if (terms.length)
							terms += '&';
						var to = $to.val();
						var regExp = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
						if (regExp.test(to))
							to = encodeURIComponent(to);
						switch ($('option:selected', $toOptions).val()) {
						case 'to+cc':
							terms += 'search.to=' + to;
							terms += '&search.cc=' + to;
							break;
						case 'to':
						default:
							terms += 'search.to=' + to;
							break;
						}
					}
					if ($contents.val()) {
						if (terms.length)
							terms += '&';
						var contents = $contents.val();
						var regExp = /[\{\}\[\]\/?.,;:|\)*~`!^\-_+<>@\#$%&\\\=\(\'\"]/gi;
						if (regExp.test(contents))
							contents = encodeURIComponent(contents);
						switch ($('option:selected', $contentsOptions).val()) {
						case 'subject+body':
							terms += 'search.subject=' + contents;
							terms += '&search.body=' + contents;
							break;
						case 'subject':
							terms += 'search.subject=' + contents;
							break;
						case 'body':
							terms += 'search.body=' + contents;
							break;
						case 'attachments':
							terms += 'search.attachments=' + contents;
							break;
						case 'all':
						default:
							terms += 'search.subject=' + contents;
							terms += '&search.body=' + contents;
							terms += '&search.attachments=' + contents;
						}
					}
					if ($attached.filter(':checked').val() != 'any') {
						if (terms.length)
							terms += '&';
						terms += 'search.attached=' + $attached.filter(':checked').val();
					}
					if ($size.val() && $size.val() != 0) {
						if (isNaN($size.val()) || $size.val() < 0) {
							alert(i18n.searchMbox.enterNumberGreaterThanZero);
							return false;
						}
						if (terms.length)
							terms += '&';
						terms += 'search.size=' + ($size.val() * 1024 * 1024);
						terms += '&search.sizeRange=' + $sizeRange.filter(':checked').val();
					}
					if ($periodSelect.val() != 'ALL' && $periodSelect.val() != 'CUSTOM') {
						if (terms.length)
							terms += '&';
						terms += 'search.period=' + $periodSelect.val();
					}
					if ($startDate.is(':enabled') && $endDate.is(':enabled')) {
						var regExp = /^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/;
						if (!regExp.test($startDate.val()) || !regExp.test($endDate.val())) {
							alert(i18n.search.invalidDate);
							return false;
						}
						if (terms.length)
							terms += '&';
						terms += 'search.startDate=' + $startDate.val();
						terms += '&search.endDate=' + $endDate.val();
					}
					var patch = false;
					if (self.model.get('id'))
						patch = true;
					self.model.save({
						name : $name.val(),
						mbox : $('option:selected', $mboxSelect).val(),
						terms : terms,
						visible : self.model.get('visible'),
					}, {
						patch : patch,
						wait : true,
						async : false,
						success : function(model, response, options) {
							self.collection.fetch();
							self.close();
						},
						error : function(model, response, options) {
							alert(i18n.searchMbox.failedToSave);
						},
					});
					return false;
				});
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
			onClose : function() {
				mail.overlayView.hideOverlay();
			},
			renderMboxSelect : function() {
				var self = this, $el = this.$el;
				var $mboxSelect = $el.find('select.search-mbox-select:first');
				var $excludeTrashAndSpam = $el.find('input[name="excludeTrashAndSpam"]');
				$mboxSelect.empty();
				var mboxModels = [];
				function traverseMbox(parentMboxModel) {
					var subMboxModels;
					if (parentMboxModel) {
						subMboxModels = self.mboxCollection.filter(function(mboxModel) {
							return mboxModel.get('MBOX_REF') === parentMboxModel.get('MBOX_IDX');
						});
						mboxModels.push(parentMboxModel);
					} else {
						subMboxModels = self.mboxCollection.filter(function(mboxModel) {
							return mboxModel.get('MBOX_REF') === 0;
						});
					}
					for (var i = 0; i < subMboxModels.length; i++) {
						traverseMbox(subMboxModels[i]);
					}
				}
				traverseMbox();
				var options = [];
				options.push($('<option value="all"></option>').text(i18n.search.allMboxes));
				for (var i = 0; i < mboxModels.length; i++) {
					var level = self.getLevel(mboxModels[i], self.mboxCollection);
					var $option = $('<option></option>');
					$option.val(mboxModels[i].get('MBOX_IDX'));
					if (self.model && (self.model.get('mbox') == mboxModels[i].get('MBOX_IDX'))) {
						$option.attr('selected', 'selected');
						$excludeTrashAndSpam.attr('disabled', 'disabled');
					}
					switch (mboxModels[i].get('MBOX_TYPE')) {
					case 1:
						$option.text(i18n.mbox.inbox);
						break;
					case 2:
						$option.text(i18n.mbox.sent);
						break;
					case 3:
						$option.text(i18n.mbox.trash);
						break;
					case 4:
						$option.text(i18n.mbox.drafts);
						break;
					case 5:
						$option.text(i18n.mbox.junk);
						break;
					case 6:
					default:
						var name = mboxModels[i].get('MBOX_NAME');
						for (var j = 0; j < level; j++) {
							name = '../' + name;
						}
						$option.text(name);
					}
					options.push($option);
				}
				$mboxSelect.append(options);
			},
			getLevel : function(model, mboxCollection) {
				var level = 0;
				var parentId = model.get('MBOX_REF');
				if (parentId === 0) {
					return level;
				}
				var parentMboxModel = mboxCollection.find(function(mboxModel) {
					return mboxModel.get('MBOX_IDX') === parentId;
				});
				while (parentMboxModel) {
					level++;
					parentId = parentMboxModel.get('MBOX_REF');
					if (parentId === 0)
						break;
					parentMboxModel = mboxCollection.find(function(mboxModel) {
						return mboxModel.get('MBOX_IDX') === parentId;
					});
				}
				return level;
			},
		});

		mail.MailGeoIpTraceView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 400px; display: none; position: absolute;',
				hidable : 'false',
			},
			template : function(data) {
				var html;
				var compiledTemplate = mail.MailGeoIpTraceView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-geoip-trace-templete').html();
					compiledTemplate = _.template(html);
					mail.MailGeoIpTraceView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					mail : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = new mail.mailModel()
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				var $close = this.$el.find('div.close_bt:first');
				var $cancel = this.$el.find('div.ad_btn_area button:first');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.close();
					return false;
				});
			},
		});

		mail.LabelAddView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer tag_new',
			attributes : {
				style : 'width: 140px; z-index: 2015;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.LabelAddView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#label-add-template').html();
					compiledTemplate = _.template(html);
					mail.LabelAddView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					label : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.LabelModel
				this.listenTo(app.vent, 'show:label-add', this.showLabelAdd);
			},
			onRender : function() {
				var self = this;
				var $labelAddView = this.$el.appendTo('body');
				$labelAddView.css({
					'position' : 'absolute',
					'top' : 'auto',
					'right' : 'auto',
					'bottom' : 'auto',
					'left' : 'auto',
				});
				$labelAddView.attr('hidable', true);
				$labelAddView.click(function(event) {
					event.stopPropagation();
				});
				var event = this.mouseEvent;
				var viewportX, viewportY;
				if (window.innerHeight) {
					viewportX = window.innerWidth;
					viewportY = window.innerHeight;
				} else if (document.documentElement && document.documentElement.clientHeight) {
					viewportX = document.documentElement.clientWidth;
					viewportY = document.documentElement.clientHeight;
				} else if (document.body) {
					viewportX = document.body.clientWidth;
					viewportY = document.body.clientHeight;
				}
				if ($labelAddView.outerHeight() > (viewportY - event.pageY)) {
					$labelAddView.css('bottom', (viewportY - event.pageY) + 'px');
				} else {
					$labelAddView.css('top', event.pageY + 'px');
				}
				if ($labelAddView.outerWidth() > (viewportX - event.pageX)) {
					$labelAddView.css('right', (viewportX - event.pageX) + 'px');
				} else {
					$labelAddView.css('left', event.pageX + 'px');
				}
				var $colorsWrapper = this.$el.find('li.label-color');
				var $colors = this.$el.find('input:radio[name=labelColor]');
				$colors.change(function(event) {
					var $this = $(this);
					$colorsWrapper.removeClass('selected');
					$this.parent().addClass('selected');
				});
				var $save = this.$el.find('div.adl_footer button.layer_save');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var patch = false;
					if (self.model.get('id'))
						patch = true;
					if (!patch && mail.labelCollection.size() >= 10) {
						alert(i18n.label.exceededMaximumNumbers);
						return false;
					}
					var $name = self.$el.find('input:text[name=labelName]');
					if (!$name.val() || $name.val().length < 1) {
						alert(i18n.label.pleaseEnterName);
						$name.focus();
						return false;
					}
					if ($name.val() && $name.val().length > 10) {
						alert(i18n.label.labelNameTooLong);
						$name.focus();
						return false;
					}
					var labelFilters = self.collection.filter(function(labelModel) {
						return self.model.get('name') != $name.val() && labelModel.get('name') == $name.val();
					});
					if (labelFilters.length) {
						alert(i18n.label.labelNameAlreadyExists + ': ' + $name.val());
						$name.focus();
						return false;
					}
					var $color = $colors.filter(':checked');
					if (!$color.val()) {
						alert(i18n.label.pleaseSelectColor);
						return false;
					}
					self.model.save({
						name : $name.val(),
						color : $color.val(),
						visible : self.model.get('visible'),
					}, {
						patch : patch,
						wait : true,
						async : false,
						success : function(model, response, options) {
							if (!patch)
								self.collection.fetch();
							self.close();
						},
						error : function(model, response, options) {
							switch (response.status) {
							case 409:
								alert(i18n.label.labelNameAlreadyExists + ': ' + $name.val());
								break;
							default:
								alert(i18n.label.failedToSave);
								break;
							}
						},
					});
					return false;
				});
				var $close = this.$el.find('div.close_bt');
				var $cancel = this.$el.find('div.adl_footer button.layer_cancel');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					app.$hidablesListener.trigger('hide.all');
					return false;
				});
			}, // onRender : function() {...}
			showLabelAdd : function(mouseEvent, labelCollection, labelModel) {
				this.mouseEvent = mouseEvent;
				this.collection = labelCollection;
				this.model = labelModel;
				this.render().$el.show();
			}
		});

		mail.OverlayView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			attributes : {
				style : 'display: none;',
			},
			template : function(data) {
				var html;
				var compiledTemplate = mail.OverlayView.compiledTemplate;
				if (!compiledTemplate) {
					var templateId = '#mail-overlay-template';
					html = mail.$template.filter(templateId).html();
					compiledTemplate = _.template(html);
					mail.OverlayView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == No Model
			},
			onRender : function() {
				var self = this;
				this.$overlay = this.$el.children('#mail-overlay');
				this.$loadingLayer = this.$overlay.children('.mail-loading-layer');
				this.$processingLayer = this.$overlay.children('.mail-processing-layer');
				this.$uploadingLayer = this.$overlay.children('.attachment-uploading-layer');
				this.$overlay.appendTo('body');
				this.$overlay.on('mousedown', function(event) {
					event.preventDefault() && event.stopPropagation();
				});
				this.$viewport = $(window);
				this.$viewport.resize(function(event) {
					var viewportWidth = self.$viewport.width() / 2;
					var viewportHeight = self.$viewport.height() / 2;
					var width = self.$loadingLayer.width() / 2;
					var height = self.$loadingLayer.height() / 2;
					var top = Math.floor(viewportHeight - height);
					var left = Math.floor(viewportWidth - width);
					self.$loadingLayer.css({
						'top' : top,
						'left' : left,
					});
					width = self.$processingLayer.width() / 2;
					height = self.$processingLayer.height() / 2;
					top = Math.floor(viewportHeight - height);
					left = Math.floor(viewportWidth - width);
					self.$processingLayer.css({
						'top' : top,
						'left' : left,
					});
					width = self.$uploadingLayer.width() / 2;
					height = self.$uploadingLayer.height() / 2;
					top = Math.floor(viewportHeight - height);
					left = Math.floor(viewportWidth - width);
					self.$uploadingLayer.css({
						'top' : top,
						'left' : left,
					});
				});
				this.$viewport.resize();
				this.$loadingLayer.hide();
				this.$processingLayer.hide();
				this.$uploadingLayer.hide();
				this.$overlay.hide();
			},
			onClose : function() {
				this.$overlay.remove();
			},
			showOverlay : function() {
				this.$viewport.trigger('resize');
				this.$overlay.show();
			},
			hideOverlay : function() {
				this.$overlay.fadeOut();
			},
			showLoading : function() {
				this.showOverlay();
				this.$loadingLayer.show();
			},
			hideLoading : function() {
				this.$loadingLayer.fadeOut();
				this.hideOverlay();
			},
			showProcessing : function() {
				this.showOverlay();
				this.$processingLayer.show();
			},
			hideProcessing : function() {
				this.$processingLayer.fadeOut();
				this.hideOverlay();
			},
			showUploading : function() {
				this.showOverlay();
				this.$uploadingLayer.show();
			},
			hideUploading : function() {
				this.$uploadingLayer.fadeOut();
				this.hideOverlay();
			},
		});

		mail.ApprovalPolicyView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width: 700px;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalPolicyView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-policy-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalPolicyView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					policyModel : data.policyModel,
					filterCollection : data.filterCollection,
					approverCollection : data.approverCollection,
					user : app.userModel,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = new BackboneModel({...});
				this.approverCollection = this.model.get('approverCollection');
				this.filterCollection = this.model.get('filterCollection');
				this.composeMailView = options.composeMailView;
				this.mailModel = options.mailModel;
				this.M_IDX = this.mailModel.get('M_IDX');
				this.listenTo(app.vent, 'show:approval-filtered', this.replaceApprover);
				this.parentView = options.parentView;
			},
			onBeforeRender : function() {
				mail.overlayView.showOverlay();
			},
			onRender : function() {
				var self = this;
				var $close = this.$el.find('.ic_cancle:first');
				var $modify = this.$el.find('#closeApprovalLayerBtn:first');
				var mailId = this.mailModel.get('M_IDX');
				$close.add($modify).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					// 
					self.mailModel.destroy({
						wait : true,
						async : false
					});
					if (self.parentView.mailModel && self.parentView.mailModel.get('M_IDX'))
						self.parentView.mailModel.unset('M_IDX');
					// approval queue  task 
					var approvalModel = new (app.BackboneModel.extend({
						url : function() {
							if (isPopup())
								return '../approval/tasks/' + mailId;
							else
								return 'approval/tasks/' + mailId;
						},
						defaults : {
							id : mailId
						}
					}))();
					approvalModel.destroy({
						wait : true,
						async : false
					});
					self.composeMailView.previewBeforeSending = null;
					self.close();
					return false;
				});

				var $change = this.$el.find('.changeApproverBtn');
				$change.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var policyModel = self.model.get('policyModel');
					var url = 'popup/#approval/policies/' + policyModel.id + '/approvers/levels/' + $(this).val();
					if (isPopup())
						url = '#approval/policies/' + policyModel.id + '/approvers/levels/' + $(this).val();
					window.open(url, '', 'scrollbars=yes,width=500,height=420');
					return false;
				});

				var $send = this.$el.find('#sendApprovalBtn');
				$send.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var finalLevel = self.approverCollection.getFinalLevels();
					var approvals = [];
					var isDeputy = false;
					for (var i = 1; i <= finalLevel; i++) {
						var approvers = self.approverCollection.getApporversByLevels(i);
						_.each(approvers, function(approver) {
							if (approver.get('prime') == 1) {
								var address = approver.get('approver');
								if (approver.get('status')) {
									if (approver.get('deputyApproverName')) {
										address = approver.get('deputyApprover');
									} else {
										isDeputy = true;
									}
								}
								var approvalModel = new mail.ApprovalModel({
									mailId : mailId,
									levels : approver.get('levels'),
									approver : address
								});
								approvals.push(approvalModel.toJSON());
							}
						});
					}
					if (isDeputy) {
						alert(i18n.pleaseSelectDifferentApprover);
						return false;
					}
					var model = new (app.BackboneModel.extend({
						url : function() {
							if (isPopup())
								return '../approval/tasks/' + mailId;
							else
								return 'approval/tasks/' + mailId;
						},
						defaults : {
							mailId : mailId,
							approvals : approvals
						},
					}))();
					model.save(null, {
						wait : true,
						async : false,
						success : function(model, response, options) {
							location.hash = '#sent-mail';
							app.vent.trigger('show:sent-mail', self.mailModel);
							self.close();
						},
						error : function(model, response, options) {
							alert('Failed to send.');
						},
					});
					mail.overlayView.hideOverlay();
					return false;
				});
			},
			replaceApprover : function(approverModel) {
				var levels = approverModel.get('levels');
				this.approverCollection.forEach(function(model) {
					if (model.get('levels') == approverModel.get('levels')) {
						if (model.get('approver') == approverModel.get('approver'))
							model.set('prime', 1);
						else
							model.set('prime', 0);
					}
				});
				this.render();
			},
			_centerLayerInWindow : function() {
				var self = this;
				var $viewport = $(window);
				$viewport.off('resize.ApprovalPolicyView');
				$viewport.on('resize.ApprovalPolicyView', function(event) {
					var parentWidth = $viewport.width() / 2;
					var parentHeight = $viewport.height() / 2;
					var width = self.$el.width() / 2;
					var height = self.$el.height() / 2;
					var top = Math.floor(parentHeight - height);
					var left = Math.floor(parentWidth - width);
					self.$el.css({
						'top' : top,
						'left' : left
					});
				});
				$viewport.trigger('resize.ApprovalPolicyView');
			},
			onClose : function() {
				mail.overlayView.hideOverlay();
			},
		}); // mail.ApprovalPolicyView

		mail.ApprovalHeaderView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalHeaderView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-header-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalHeaderView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					approvalMboxModel : data.approvalMboxModel,
					paginator : data.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.approvalMboxModel = this.model.get('approvalMboxModel');
				this.paginator = this.model.get('paginator');
				this.listenTo(this.approvalMboxModel, 'change', this.render);
				this.listenTo(app.vent, 'change:approval-mbox', this.replaceMboxModel);
				this.listenTo(this.paginator, 'sync', this.render);
			},
			onRender : function() {
				var self = this;
				var $deleteCompletedMail = this.$el.find('a.mc-noReadDel');
				$deleteCompletedMail.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var mboxName = self.approvalMboxModel.get('mboxName');
					var msg = i18n.deleteApproveRejectMailPhrase;
					if (!confirm(msg)) {
						return false;
					}
					var model = new (app.BackboneModel.extend({
						url : 'approval/mboxes/' + mboxName + '/approvals?flag=completedMail',
						defaults : {
							id : mboxName
						},
					}))();
					mail.overlayView.showProcessing();
					model.destroy({
						async : false,
						wait : true,
					});
					self.paginator.pager();
					mail.overlayView.hideProcessing();
					return false;
				});
				this.activateMboxItem();
			},
			replaceMboxModel : function(approvalMboxModel, params) {
				this.stopListening(this.approvalMboxModel);
				this.model.set('approvalMboxModel', approvalMboxModel);
				this.approvalMboxModel = approvalMboxModel;
				this.listenTo(this.approvalMboxModel, 'change', this.render);
				this.render();
			},
			activateMboxItem : function() {
				this.approvalMboxModel.headerView = true;
				app.vent.trigger('activate:mbox-item', this.approvalMboxModel);
			},
		}); // mail.ApprovalHeaderView

		mail.ApprovalSimpleSearchView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalSimpleSearchView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#simple-search-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalSimpleSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.approvalPaginator
			},
			onRender : function() {
				var self = this;
				var $input = this.$el.find('input.mc-search');
				var $search = this.$el.find('input.mc-search_btn');
				var $toggle = this.$el.find('a.mc-search_detail');

				$input.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						var term = $(this).val();
						self.search(term);
						$(this).val('');
					}
				});

				$search.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var term = $input.val();
					self.search(term);
					$input.val('');
				});

				$toggle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var contentLayout = mail.controller.contentLayout;
					var $advancedSearch = contentLayout.approvalAdvancedSearchRegion.$el;
					var $splitPane = contentLayout.$el.find('#cont_flex_area');
					$advancedSearch.toggle();
					if ($advancedSearch.is(':visible')) {
						$(this).css('background', 'url(img/btn_mail.gif) no-repeat -91px -151px');
						$splitPane.css('top', '149px');
					} else {
						$(this).css('background', 'url(img/btn_mail.gif) no-repeat -33px -151px');
						$splitPane.css('top', '88px');
					}
					$(window).resize();
				});
			},
			search : function(term) {
				if (!term)
					return;
				if (term.indexOf('%') != -1 || term.indexOf('_') != -1) {
					alert(i18n.search.invalidTerm);
					return;
				}
				var hash = '#approval/mboxes/' + mail.approvalMboxModel.get('mboxName') + '/approvals?search='
						+ encodeURIComponent(term);
				location.hash = hash;
			},
		}); // mail.ApprovalSimpleSearchView

		mail.ApprovalAdvancedSearchView = Backbone.Marionette.ItemView.extend({
			tagName : 'fieldset',
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalAdvancedSearchView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-advanced-search-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalAdvancedSearchView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.listenTo(app.vent, 'change:approval-mbox', this.renderMboxSelect);
			},
			onRender : function() {
				var self = this, $el = this.$el;
				var $applicant = $el.find('input.advanced-search-from:first');
				var $toOptions = $el.find('select.advanced-search-to-options:first');
				var $approver = $el.find('input.advanced-search-to:first');
				var $contentsOptions = $el.find('select.advanced-search-contents-options:first');
				var $contents = $el.find('input.advanced-search-contents:first');
				var $mboxSelect = $el.find('select.advanced-search-mbox-select:first');
				var $periodSelect = $el.find('select.advanced-search-period-select:first');
				var $startDate = $el.find('input.advanced-search-start-date:first');
				var $endDate = $el.find('input.advanced-search-end-date:first');
				var $search = $el.find('button.btn_srch_submit:first');

				var $inputs = $applicant.add($approver).add($contents);
				$inputs.keydown(function(event) {
					event.stopPropagation();
					if (event.which == 13) {
						event.preventDefault();
						$search.click();
					}
				});

				// Search for Mailbox
				this.renderMboxSelect();
				// Search Period Select
				$periodSelect.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					var period = $(this).val();
					if (period == 'ALL') {
						$($startDate).add($endDate).attr('disabled', true).val('');
						return false;
					} else if (period == 'CUSTOM') {
						$($startDate).add($endDate).removeAttr('disabled').val('');
						return false;
					}
					$($startDate).add($endDate).removeAttr('disabled');
					var now = new Date(), date = new Date();
					switch (period) {
					case '1W':
						date.setDate(now.getDate() - 7);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '1M':
						date.setMonth(now.getMonth() - 1);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '3M':
						date.setMonth(now.getMonth() - 3);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '6M':
						date.setMonth(now.getMonth() - 6);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case '1Y':
						date.setFullYear(now.getFullYear() - 1);
						$startDate.val($.format.date(date, 'yyyy-MM-dd'));
						$endDate.val($.format.date(now, 'yyyy-MM-dd'));
						break;
					case 'ALL':
					default:
						$($startDate).add($endDate).attr('disabled', 'disabled').val('');
					}
				});
				// jQuery UI Datepicker
				$startDate.datepicker();
				$endDate.datepicker();
				// Search Button
				$search.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var params = '';
					if ($applicant.val()) {
						params += 'search.applicant=' + encodeURIComponent($applicant.val());
					}
					if ($approver.val()) {
						params += 'search.approver=' + encodeURIComponent($approver.val());
					}
					if ($contents.val()) {
						if (params.length)
							params += '&';
						params += 'search.subject=' + encodeURIComponent($contents.val());
					}
					if ($startDate.is(':enabled') && $endDate.is(':enabled')) {
						var pattern = /^([0-9]{4})-?(1[0-2]|0[1-9])-?(3[0-1]|0[1-9]|[1-2][0-9])$/;
						if (!pattern.test($startDate.val()) || !pattern.test($endDate.val())) {
							alert(i18n.search.invalidDate);
							return false;
						}
						if (params.length)
							params += '&';
						params += 'search.startDate=' + $startDate.val();
						params += '&search.endDate=' + $endDate.val();
					}
					var hash = '#';
					var mboxName = $('option:selected', $mboxSelect).val();
					if (mboxName) {
						hash += 'approval/mboxes/' + mboxName + '/approvals';
					}
					if (params.length) {
						hash += '?' + params;
					}
					location.hash = hash;
				}); // $search.click(function(event) {...});
			},
			renderMboxSelect : function() {
				var $el = this.$el;
				var $mboxSelect = $el.find('select.advanced-search-mbox-select:first');
				$mboxSelect.empty();
				var $excludeTrashAndSpam = $el.find('input[name="excludeTrashAndSpam"]');
				$excludeTrashAndSpam.removeAttr('disabled');
				var $option = $('<option></option>');
				var mboxName = mail.approvalMboxModel.get('mboxName');
				$option.val(mboxName);
				$option.text(mboxName == 'sent' ? i18n.approval.sent : i18n.approval.inbox);
				$mboxSelect.append($option);
			},
		}); // mail.ApprovalAdvancedSearchView

		mail.ApprovalTabView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalTabView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-tab-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalTabView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : data.paginator,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				this.approvalMboxModel = this.model.get('approvalMboxModel');
				this.paginator = this.model.get('paginator');
				this.listenTo(this.approvalMboxModel, 'change', this.render);
				this.listenTo(this.paginator, 'sync', this.render);
				this.listenTo(app.vent, 'change:approval-mbox', this.replaceMboxModel);
			},
			replaceMboxModel : function(approvalMboxModel) {
				this.approvalMboxModel = approvalMboxModel;
			},
			onRender : function() {
				var self = this;
				var $tabs = self.$el.find('ul a');
				$tabs.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var flag, status;
					if ($this.attr('id') == 'all-tab') {
						flag = null;
					} else if ($this.attr('id') == 'request-tab') {
						if (self.approvalMboxModel.get('mboxName') == 'sent') {
							flag = 'request';
						} else {
							flag = 'pending';
						}
					} else if ($this.attr('id') == 'approve-tab') {
						flag = 'approve';
					} else if ($this.attr('id') == 'reject-tab') {
						flag = 'reject';
					}
					status = flag;
					location.hash = "#" + self.paginator.getURL({
						page : 1,
						flag : flag,
						status : status
					});
				});

				var flag = (self.paginator.params && self.paginator.params.flag) ? self.paginator.params.flag : '';
				var $tab;
				if (flag == 'request' || flag == 'pending') {
					$tab = self.$el.find('#request-tab');
				} else if (flag == 'approve') {
					$tab = self.$el.find('#approve-tab');
				} else if (flag == 'reject') {
					$tab = self.$el.find('#reject-tab');
				} else {
					$tab = self.$el.find('#all-tab');
				}
				self.selectItem($tab);
			},
			selectItem : function($this) {
				$this.siblings().removeClass('onFilter');
				$this.addClass('onFilter');
			},
		}); // mail.ApprovalTabView

		mail.ApprovalListToolbarView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalListToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-list-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalListToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					user : data,
					mbox : mail.approvalMboxModel.toJSON(),
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == app.userModel
				// this.collection == mail.approvalPaginator
				this.approvalModel = options.approvalModel;
				this.parentView = options.parentView;
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(this.approvalModel, 'change', this.render);
				this.listenTo(app.vent, 'toggle:approval-list-toolbar-print-button', this.togglePrintButton);
				this.listenTo(app.vent, 'activate:approval-list-toolbar-split-button', this.activateSplitButton);
			},
			onRender : function() {
				var self = this;
				var $listRegion = this.parentView.approvalListRegion.$el;
				var $checkboxes = $listRegion.find('.mc-mailList .mc-check .mCheck');
				var $buttons = this.$el.find('button');
				if (!$checkboxes.length)
					$checkboxes = $('<input type="checkbox" class="dummy-checkbox"/>');
				$checkboxes.change(function(event) {
					event.preventDefault() && event.stopPropagation();
					$buttons.each(function(index, element) {
						var $this = $(this);
						if ($this.is('.btn_selectAll') || $this.is('.mc-sbRgt')) {
							return;
						}
						if ($checkboxes.filter(':checked').length == 0) {
							$this.attr('disabled', 'disabled');
						} else {
							$this.removeAttr('disabled');
						}
						if ($this.is('.btn_txt')) {
							$this.css('box-shadow', 'none');
						}
					});
					return false;
				});
				$checkboxes.eq(0).change();
				var $selectAll = this.$el.find('div.mc-buttonSet button.btn_selectAll');
				$selectAll.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if ($checkboxes.eq(0).hasClass('dummy-checkbox')) {
						return false;
					}
					var $this = $(this);
					var $toggle = $listRegion.find('.mc-mailListItem .mc-check .mCheck');
					if ($this.is('.toolbar-selectAll')) {
						$this.removeClass('toolbar-selectAll');
						$checkboxes.prop('checked', false);
						$toggle.prop('checked', false);
					} else {
						$this.addClass('toolbar-selectAll');
						$checkboxes.prop('checked', true);
						$toggle.prop('checked', true);
					}
					$checkboxes.change();
					return false;
				});
				var $delete = this.$el.find('#deleteMailBtn');
				$delete.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.deleteApprovals($checkboxes);
					return false;
				});
				var $recall = this.$el.find('#recallMailBtn');
				$recall.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var ids = [];
					var exceptedCount = 0;
					var $checked = $checkboxes.filter(':checked');
					if ($checked.length == 0) {
						alert(i18n.pleaseSelectMail);
					}
					$checked.each(function(index, element) {
						var id = $(this).val();
						var model = self.collection.find(function(approvalModel) {
							if (id == approvalModel.get('id'))
								return true;
						});
						if (model) {
							if (model.get('applicant') != self.model.get('USERS_IDX')) {
								return false;
							}
							var status = model.get('status');
							if (model.get('subApprovals')) {
								var subs = model.get('subApprovals');
								var subExceptedCount = 0;
								for (var i = 0; i < subs.length; i++) {
									if (subs[i].status != 'request' && subs[i].status != 'pending')
										status = subs[i].status;
								}
							}
							if (!status || status == 'request' || status == 'pending') {
								ids.push(model.get('id'));
							} else {
								exceptedCount++;
							}
						}
					});
					if (ids.length > 0 && exceptedCount > 0) {
						var msg = i18n.exceptApprovalMail + ids.length + i18n.exceptApprovalMailRecall;
						if (!confirm(msg)) {
							return false;
						}
					} else if (ids.length > 0 && exceptedCount == 0) {
						if (!confirm(i18n.recallConfirm)) {
							return false;
						}
					} else if (ids.length == 0 && exceptedCount > 0) {
						alert(i18n.notRecalled);
						return false;
					} else {
						return false;
					}
					mail.overlayView.showProcessing();
					var model = new (app.BackboneModel.extend({
						urlRoot : 'approval/mboxes/' + mail.approvalMboxModel.get('mboxName'),
						defaults : {
							id : 'approvals'
						}
					}))();
					model.save({
						id : ids,
						status : 'recall'
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							mail.overlayView.hideProcessing();
							mail.mboxCollection.fetch();
							self.collection.pager();
						},
						error : function(model, response, options) {
							alert('Failed to recall Approvals.');
							mail.overlayView.hideProcessing();
						},
					});
					return false;
				});
				var $approve = this.$el.find('#approveMailBtn');
				$approve.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var ids = [];
					var exceptedCount = 0;
					var $checked = $checkboxes.filter(':checked');
					if ($checked.length == 0) {
						alert(i18n.pleaseSelectMail);
					}
					$checked.each(function(index, element) {
						var id = $(this).val();
						var model = self.collection.find(function(approvalModel) {
							if (id == approvalModel.get('id'))
								return true;
						});
						if (model) {
							if (model.get('approver') != self.model.get('USERS_IDX')) {
								return false;
							}
							if (model.get('status') == 'pending') {
								ids.push(model.get('id'));
							} else {
								exceptedCount++;
							}
						}
					});
					if (ids.length > 0 && exceptedCount > 0) {
						var msg = i18n.exceptStandByMail + ids.length + i18n.approveExceptStandByMail;
						if (!confirm(msg)) {
							return false;
						}
					} else if (ids.length > 0 && exceptedCount == 0) {
						if (!confirm(i18n.approveConfirm)) {
							return false;
						}
					} else if (ids.length == 0 && exceptedCount > 0) {
						alert(i18n.notApproved);
						return false;
					} else {
						return false;
					}
					mail.overlayView.showProcessing();
					var model = new (app.BackboneModel.extend({
						urlRoot : 'approval/mboxes/' + mail.approvalMboxModel.get('mboxName'),
						defaults : {
							id : 'approvals'
						}
					}))();
					model.save({
						id : ids,
						status : 'approve'
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							mail.overlayView.hideProcessing();
							mail.mboxCollection.fetch();
							self.collection.pager();
						},
						error : function(model, response, options) {
							alert('Failed to approve Approvals.');
							mail.overlayView.hideProcessing();
						},
					});
					return false;
				});
				var $reject = this.$el.find('#rejectMailBtn');
				$reject.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var ids = [];
					var exceptedCount = 0;
					var $checked = $checkboxes.filter(':checked');
					if ($checked.length == 0) {
						alert(i18n.pleaseSelectMail);
					}
					$checked.each(function(index, element) {
						var id = $(this).val();
						var model = self.collection.find(function(approvalModel) {
							if (id == approvalModel.get('id'))
								return true;
						});
						if (model) {
							if (model.get('approver') != self.model.get('USERS_IDX')) {
								return false;
							}
							if (model.get('status') == 'pending') {
								ids.push(model.get('id'));
							} else {
								exceptedCount++;
							}
						}
					});
					var msg;
					if (ids.length > 0 && exceptedCount > 0) {
						msg = i18n.exceptStandByMail + ids.length + i18n.rejectExceptStandByMail;
					} else if (ids.length > 0 && exceptedCount == 0) {
						msg = i18n.rejectConfirm;
					} else if (ids.length == 0 && exceptedCount > 0) {
						alert(i18n.notRejected);
						return false;
					} else {
						return false;
					}
					if (msg && msg.length > 0) {
						var $approvalRejectView = new mail.ApprovalRejectView({
							model : new Backbone.Model({
								ids : ids,
								msg : msg
							}),
							parentView : self,
						});
						$approvalRejectView.render().$el.appendTo('body');
					}
					return false;
				});
				var $split = this.$el.find('.mc-layoutSelect a');
				$split.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					var split = '0';
					if ($this.hasClass('mc-setHorizontal')) {
						split = '1';
					} else if ($this.hasClass('mc-setVertical')) {
						split = '2';
					} else {
						split = '0';
					}
					var setting = self.model.get('USERS_MAIL_VIEW_MODE');
					if (split === setting) {
						return false;
					}
					self.model.save({
						USERS_MAIL_VIEW_MODE : split
					}, {
						patch : true,
						wait : true,
						success : function(model, response, options) {
							var split = model.get('USERS_MAIL_VIEW_MODE');
							switch (split) {
							case '0':
								mail.controller.contentLayout.showNoSplit('approval');
								break;
							case '1':
								mail.controller.contentLayout.showHorizontalSplit('approval');
								break;
							case '2':
								mail.controller.contentLayout.showVerticalSplit('approval');
								break;
							default:
								mail.controller.contentLayout.showNoSplit('approval');
							}
						},
					});
					return false;
				});
			},
			deleteApprovals : function($checkboxes) {
				var self = this;
				var ids = [];
				var $checked = $checkboxes.filter(':checked');
				if ($checked.length == 0) {
					alert(i18n.pleaseSelectMail);
					return false;
				}
				var exceptedCount = 0;
				$checked.each(function() {
					var id = this.value;
					var approvalModel = self.collection.find(function(model) {
						return id == model.get('id');
					});
					if (approvalModel) {
						if (mail.approvalMboxModel.get('mboxName') == 'sent') {
							if (approvalModel.get('applicant') != self.model.get('USERS_IDX')) {
								return false;
							}
						} else if (mail.approvalMboxModel.get('mboxName') == 'inbox') {
							if (approvalModel.get('approver') != self.model.get('USERS_IDX')) {
								return false;
							}
						} else {
							return false;
						}
						var status = approvalModel.get('status');
						if (status == 'recall' || status == 'approve' || status == 'reject') {
							ids.push(approvalModel.get('id'));
						} else {
							exceptedCount++;
						}
					}
				});
				if (ids.length > 0 && exceptedCount > 0) {
					var msg = i18n.exceptPendingMail + ids.length + i18n.exceptPendingMailDelete;
					if (!confirm(msg)) {
						return false;
					}
				} else if (ids.length > 0 && exceptedCount == 0) {
					if (!confirm(i18n.deleteConfirm)) {
						return false;
					}
				} else if (ids.length == 0 && exceptedCount > 0) {
					alert(i18n.notDeleted);
					return false;
				} else {
					return false;
				}
				mail.overlayView.showProcessing();
				var model = new (app.BackboneModel.extend({
					url : function() {
						var url = 'approval/mboxes/' + mail.approvalMboxModel.get('mboxName') + '/approvals';
						for (var i = 0; i < ids.length; i++) {
							url += (i == 0 ? '?' : '&') + 'id=' + ids[i];
						}
						return url;
					},
					defaults : {
						id : 'approvals'
					}
				}))();
				var jqXHR = model.destroy({
					success : function(model, response, options) {
						// deferred success callback to jqXHR.done()
					},
					error : function(model, response, options) {
						// deferred error callback to jqXHR.fail()
					},
				});
				jqXHR.done(function(data, textStatus, jqXHR) {
					mail.overlayView.hideProcessing();
					var paginator = self.collection;
					if (paginator.length == ids.length && ids.length == data.deleted) {
						var info = paginator.info();
						if (info.currentPage == info.lastPage && info.currentPage > info.firstPage) {
							var args = {
								page : info.currentPage - 1
							};
							location.hash = '#' + paginator.getURL(args);
						} else {
							paginator.pager();
						}
					} else {
						paginator.pager();
					}
				}).fail(function(jqXHR, textStatus, errorThrown) {
					mail.overlayView.hideProcessing();
					alert('Failed to delete approvals.');
				});
			},
			togglePrintButton : function(action) {
				var $print = this.$el.find('.mc-print:first');
				switch (action) {
				case 'show':
					$print.css('display', 'inline-block');
					$print.show();
					break;
				case 'hide':
					$print.hide();
					break;
				}
			},
			activateSplitButton : function(split) {
				var $split = this.$el.find('.mc-layoutSelect a');
				$split.removeClass('on');
				switch (split) {
				case 'no':
					$split.filter('.mc-setCommon').addClass('on');
					break;
				case 'vertical':
					$split.filter('.mc-setVertical').addClass('on');
					break;
				case 'horizontal':
					$split.filter('.mc-setHorizontal').addClass('on');
					break;
				}
			},
		}); // mail.ApprovalListToolbarView

		mail.ApprovalToolbarView = Backbone.Marionette.ItemView.extend({
			// parentEl : 'div#ok_send_readBtnMenu',
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalToolbarView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-toolbar-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalToolbarView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					approval : data,
					mbox : mail.approvalMboxModel.toJSON(),
					i18n : i18n,
					popup : isPopup(),
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.approvalModel
				this.userModel = options.userModel;
				this.paginator = options.paginator;
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var self = this;
				var $recompose = this.$el.find('button.approval-recompose');
				$recompose.click(function(event) {
					event.stopPropagation();
					if (isPopup()) {
						window.opener.location.hash = '#approval-recompose?id=' + self.model.get('id');
						window.close();
					} else {
						location.hash = '#approval-recompose?id=' + self.model.get('id');
					}
					return false;
				});
				var $deleteByApplicant = this.$el.find('button.approval-sent-delete');
				$deleteByApplicant.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!confirm(i18n.deleteConfirm)) {
						return false;
					}
					if (self.model.get('applicant') != self.userModel.get('USERS_IDX')) {
						return false;
					}
					var status = self.model.get('status');
					if (status == 'approve' || status == 'reject' || status == 'recall') {
						var jqXHR = self.deleteApproval();
						jqXHR.done(function() {
							var now = Date.now ? Date.now() : new Date().getTime();
							var url = '#' + self.paginator.getURL() + '&_=' + now;
							if (isPopup()) {
								window.opener.location.hash = url;
								window.close();
							} else {
								location.hash = url;
							}
						});
					}
					return false;
				});
				var $recall = this.$el.find('button.approval-recall');
				$recall.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!confirm(i18n.recallConfirm)) {
						return false;
					}
					if (self.model.get('applicant') != self.userModel.get('USERS_IDX')) {
						return false;
					}
					var status = self.model.get('status');
					if (status == 'request' || status == 'pending') {
						self.model.save({
							status : 'recall'
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								mail.mboxCollection.fetch();
								if (isPopup() && !window.opener.closed) {
									var openerApp = window.opener.require('app');
									openerApp.mail.approvalPaginator.pager();
								}
							}
						});
					}
					return false;
				});
				var $deleteByApprover = this.$el.find('button.approval-inbox-delete');
				$deleteByApprover.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!confirm(i18n.deleteConfirm)) {
						return false;
					}
					if (self.model.get('approver') != self.userModel.get('USERS_IDX')) {
						return false;
					}
					var status = self.model.get('status');
					if (status == 'approve' || status == 'reject') {
						var jqXHR = self.deleteApproval();
						jqXHR.done(function() {
							var now = Date.now ? Date.now() : new Date().getTime();
							var url = '#' + self.paginator.getURL() + '&_=' + now;
							if (isPopup()) {
								window.opener.location.hash = url;
								window.close();
							} else {
								location.hash = url;
							}
						});
					}
					return false;
				});
				var $approve = this.$el.find('button.approval-approve');
				$approve.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (!confirm(i18n.approveConfirm)) {
						return false;
					}
					if (self.model.get('approver') != self.userModel.get('USERS_IDX')) {
						return false;
					}
					var status = self.model.get('status');
					if (status == 'pending') {
						self.model.save({
							status : 'approve'
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								mail.mboxCollection.fetch();
								if (isPopup() && !window.opener.closed) {
									var openerApp = window.opener.require('app');
									openerApp.mail.approvalPaginator.pager();
								}
							}
						});
					}
					return false;
				});
				var $reject = this.$el.find('button.approval-reject');
				$reject.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var status = self.model.get('status');
					if (status == 'pending') {
						var $approvalRejectView = new mail.ApprovalRejectView({
							model : self.model,
							parentView : self
						});
						$approvalRejectView.render().$el.appendTo('body');
					}
					return false;
				});
				var $toList = this.$el.find('button.goList');
				$toList.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					location.hash = '#' + self.paginator.getURL();
					return false;
				});
				var $toPrev = this.$el.find('button.goPrev');
				$toPrev.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.model.get('prevApproval') == null) {
						alert(i18n.noPreviousEmail);
						return false;
					}
					var hash = self.model.prevApprovalHash(mail.approvalMboxModel, self.paginator);
					location.hash = hash;
					return false;
				});
				var $toNext = this.$el.find('button.goNext');
				$toNext.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					if (self.model.get('nextApproval') == null) {
						alert(i18n.noNextEmail);
						return false;
					}
					var hash = self.model.nextApprovalHash(mail.approvalMboxModel, self.paginator);
					location.hash = hash;
					return false;
				});
			},
			deleteApproval : function() {
				var jqXHR = this.model.destroy({
					wait : true,
				});
				return jqXHR;
			},
		}); // mail.ApprovalToolbarView

		mail.ApprovalItemView = Backbone.Marionette.ItemView.extend({
			tagName : 'li',
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalItemView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-item-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalItemView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					approval : data,
					paginator : mail.approvalPaginator,
					mbox : mail.approvalMboxModel.toJSON(),
					user : app.userModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function() {
				this.listenTo(this.model, 'change', this.render);
				this.listenTo(app.vent, 'toggle:approval-item', this.toggleSelection);
			},
			onRender : function() {
				var self = this;
				if (self.model.get('isSubApproval')) {
					self.$el.attr('class', 'sub-approval-item-' + self.model.get('mailId'));
				}
				var $toggleSubList = this.$el.find('.toggleSubList');
				$toggleSubList.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $span = $(this).find('span:first');
					if ($span.hasClass('ic_send_off')) {
						$span.removeClass('ic_send_off').addClass('ic_send_on');
					} else {
						$span.removeClass('ic_send_on').addClass('ic_send_off');
					}
					var mailId = parseInt($(this).attr('mailId'));
					var $subList = self.$el.parent().find('li.sub-approval-item-' + mailId);
					if ($subList.length > 0) {
						$subList.toggle();
						return false;
					}
					var subItems = [];
					var subApprovals = _.sortBy(self.model.get('subApprovals'), 'levels');
					_.each(subApprovals, function(approvalModel) {
						var model = new mail.ApprovalModel(approvalModel);
						model.set('isSubApproval', true);
						var subItemView = new mail.ApprovalItemView({
							model : model
						});
						subItems.push(subItemView.render().$el);
					});
					self.$el.after(subItems);
				});
				this.$list = this.$el.children('ul.mc-mInfo');
				this.$checkbox = this.$list.find('li.mc-check input:checkbox');
				var $mailLinks = this.$el.find('.mc-subject a').not('.icoPreviewMail');
				$mailLinks.click(function(event) {
					var $this = $(this);
					setTimeout(function() {
						if ($this.is('.icoNewWindow'))
							return;
						app.vent.trigger('toggle:mail-item');
					}, 100);
					if ($this.is('.icoNewWindow')) {
						window.open('popup/' + $this.attr('href'), '', 'scrollbars=yes,width=900,height=680');
						return false;
					}
					return true;
				});
			},
			toggleSelection : function() {
				var split = app.userModel.get('USERS_MAIL_VIEW_MODE');
				app.debug('toggleSelection : function() { split: ' + split + ' };');
				if (split == '0')
					return;
				if (this.model.get('M_IDX') == mail.mailModel.get('M_IDX')) {
					this.$checkbox.prop('checked', true);
				} else {
					this.$checkbox.prop('checked', false);
				}
				this.$checkbox.change();
			},
		}); // mail.ApprovalItemView

		mail.ApprovalListView = Backbone.Marionette.CompositeView.extend({
			itemView : mail.ApprovalItemView,
			itemViewContainer : '.mc-listWrap .mc-mailList',
			emptyView : mail.MailListEmptyView,
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalListView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-list-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalListView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					paginator : mail.approvalPaginator,
					user : app.userModel.toJSON(),
					mbox : mail.approvalMboxModel.toJSON(),
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.collection == mail.apprvoalPaginator
				this.listenTo(this.collection, 'sync', this.render);
				this.listenTo(app.vent, 'paginate:approvals', this.paginateApprovals);
			},
			onRender : function() {
				var self = this;
				var $toggle = this.$el.find('.mc-mailListItem .mc-check .mCheck');
				var $checkboxes = this.$el.find('.mc-mailList .mc-check .mCheck');
				$toggle.change(function(event) {
					if (this.checked) {
						if (!$checkboxes.length) {
							this.checked = false;
							return false;
						}
						$checkboxes.prop('checked', true);
					} else {
						$checkboxes.removeAttr('checked');
					}
					$checkboxes.change();
					return false;
				});
				$checkboxes.change(function(event) {
					if (this.checked) {
						if ($checkboxes.length == $checkboxes.filter(':checked').length)
							$toggle.prop('checked', true);
					} else {
						$toggle.removeAttr('checked');
					}
				});
				var $attached = this.$el.find('.mc-mailListItem .mc-file .icoFile');
				$attached.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var now = Date.now ? Date.now() : new Date().getTime();
					var url = '#approval/' + self.model.get('MBOX_IDX') + '/mails?flag=attached&_=' + now;
					location.hash = url;
				});
				var $pagination = this.$el.find('.mc-paginate');
				var paginationView = new mail.PaginationView({
					collection : this.collection
				});
				$pagination.append(paginationView.render().$el.children());
			},
			paginateApprovals : function(params) {
				mail.overlayView.showLoading();
				if (!params)
					params = {};
				this.collection.setParameters(params);
				this.collection.pager({
					type : 'POST',
					success : function(collection, response, options) {
						mail.overlayView.hideLoading();
						var approvalId = mail.approvalModel.get('id');
						var approvalModel = collection.find(function(model) {
							return model.get('id') == approvalId;
						});
						if (!approvalModel)
							mail.approvalModel.set('id', 0);
					},
					error : function(collection, response, options) {
						mail.overlayView.hideLoading();
						switch (response.status) {
						default:
							alert(i18n.failedToListMails);
							break;
						}
					},
				});
			},
		}); // mail.ApprovalListView

		mail.ApprovalView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalView.compiledTemplate;
				var compiledEmptyTemplate = mail.ApprovalView.compiledEmptyTemplate;
				var compiledPrevNextTemplate = mail.ApprovalView.compiledPrevNextTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-view-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalView.compiledTemplate = compiledTemplate;
				}
				if (!compiledEmptyTemplate) {
					html = mail.$template.filter('#empty-mail-view-template').html();
					compiledEmptyTemplate = _.template(html);
					mail.ApprovalView.compiledEmptyTemplate = compiledEmptyTemplate;
				}
				if (!compiledPrevNextTemplate) {
					html = mail.$template.filter('#prev-next-approvals-template').html();
					compiledPrevNextTemplate = _.template(html);
					mail.ApprovalView.compiledPrevNextTemplate = compiledPrevNextTemplate;
				}
				if (mail.approvalModel.get('id')) {
					html = compiledTemplate({
						urlRoot : _.result(mail.approvalModel, 'urlRoot'),
						approval : data,
						i18n : i18n,
						popup : isPopup(),
					});

					var split = app.userModel ? app.userModel.get('USERS_MAIL_VIEW_MODE') : '0';
					var hash = location.hash;
					if (split == '0' && hash.indexOf('#print') == -1) {
						var prevHash = mail.approvalModel.prevApprovalHash(mail.approvalMboxModel,
								mail.approvalPaginator);
						var nextHash = mail.approvalModel.nextApprovalHash(mail.approvalMboxModel,
								mail.approvalPaginator);
						html += compiledPrevNextTemplate({
							approval : data,
							paginator : mail.approvalPaginator,
							prevApprovalHash : prevHash,
							nextApprovalHash : nextHash,
							i18n : i18n,
							popup : isPopup(),
						});
					}
				} else {
					html = compiledEmptyTemplate({
						i18n : i18n
					});
				}
				return html;
			},
			initialize : function(options) {
				// this.model == mail.approvalModel
				this.parentView = options.parentView;
				this.listenTo(this.model, 'sync', this.render);
				this.listenTo(this.model, 'change', this.render);
			},
			onRender : function() {
				var approvalId = this.model.get('id');
				if (approvalId) {
					this.$el.removeClass('subMsg');
					this.$el.addClass('mc-coverWrap');
				} else {
					this.$el.removeClass('mc-coverWrap');
					this.$el.addClass('subMsg');
					this.$el.show();
				}
				var self = this;
				var $scrollTop = self.$el.find('.mc-toTop');
				$scrollTop.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $scrollableParents = $(this).parents().filter(function(index, element) {
						return $(this).css('overflow') == 'auto';
					});
					if ($scrollableParents.length == 0) {
						$(window).scrollTop(0);
					} else {
						$scrollableParents.first().scrollTop(0);
					}
					return false;
				});
			},
		}); // mail.ApprovalView

		mail.ApprovalRejectView = Backbone.Marionette.ItemView.extend({
			template : function(data) {
				var html, compiledTemplate = mail.ApprovalRejectView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#approval-reject-template').html();
					compiledTemplate = _.template(html);
					mail.ApprovalRejectView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					data : data,
					i18n : i18n,
				});
				return html;
			},
			initialize : function(options) {
				// this.model == mail.approvalModel
				this.parentView = options.parentView;
			},
			onRender : function() {
				var self = this;
				self.$el.css('z-index', 2016);
				var $save = self.$el.find('.rejected-reason-save');
				$save.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var $textarea = self.$el.find('.rejected-reason-textarea');
					if ($textarea.length < 1) {
						alert(i18n.rejectedReasons);
					}

					mail.overlayView.showProcessing();
					if (self.model.get('ids') && self.model.get('ids').length > 0) {
						var model = new (app.BackboneModel.extend({
							urlRoot : 'approval/mboxes/' + mail.approvalMboxModel.get('mboxName'),
							defaults : {
								id : 'approvals'
							}
						}))();
						model.save({
							id : self.model.get('ids'),
							status : 'reject',
							reason : $textarea.val()
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								mail.overlayView.hideProcessing();
								mail.mboxCollection.fetch();
								self.parentView.collection.pager();
								$close.click();
								mail.overlayView.hideOverlay();
							},
							error : function(model, response, options) {
								alert('Failed to recall Approvals.');
								mail.overlayView.hideProcessing();
							},
						});
					} else {
						self.model.save({
							status : 'reject',
							reason : $textarea.val()
						}, {
							patch : true,
							wait : true,
							success : function(model, response, options) {
								mail.overlayView.hideProcessing();
								mail.mboxCollection.fetch();
								$close.click();
								mail.overlayView.hideOverlay();
							},
							error : function(model, response, options) {
								alert('Failed to reject reason.');
								mail.overlayView.hideProcessing();
							}
						});
					}
				});
				var $close = self.$el.find('.rejected-reason-close');
				var $cancel = self.$el.find('.rejected-reason-cancel');
				$close.add($cancel).click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.remove();
					mail.overlayView.hideOverlay();
				});
				mail.overlayView.showOverlay();
			},
		}); // mail.ApprovalRejectView

		mail.DroppableView = Backbone.Marionette.ItemView.extend({
			tagName : 'div',
			id : 'mail-droppable',
			className : 'drag_layer',
			attributes : {
				style : 'display: none; z-index: 2016;',
			},
			template : function(data) {
				var html, compiledTemplate = mail.DroppableView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#mail-droppable-template').html();
					compiledTemplate = _.template(html);
					mail.DroppableView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					popup : isPopup()
				});
				return html;
			},
			initialize : function(options) {
				// this.model == No Model
				this.composeRegion = options.composeRegion;
			},
			onRender : function() {
				var self = this;
				this.$el.on('dragenter', function(event) {
					var dataTransfer = event.originalEvent.dataTransfer;
					var types = dataTransfer.types;
					if (types) {
						if ((types.contains && types.contains("Files"))
								|| (types.indexOf && types.indexOf("Files") !== -1)) {
							event.preventDefault();
							self.$el.show();
						}
					}
				});
				this.$el.on('dragover', function(event) {
					event.preventDefault() && event.stopPropagation();
					return false;
				});
				this.$el.on('dragleave', function(event) {
					event.preventDefault() && event.stopPropagation();
					var $this = $(this);
					if (!$this.has(event.target) || $this.is(event.target))
						$this.hide();
					return false;
				});
				this.$el.on('drop', function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.hide();
					var isAllFiles = true;
					var dataTransfer = event.originalEvent.dataTransfer;
					if (!dataTransfer) {
						return false;
					}
					if (dataTransfer.items) {
						$.each(dataTransfer.items, function(index, item) {
							var entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
							if (entry && !entry.isFile) {
								isAllFiles = false;
							}
						});
					}
					if (!isAllFiles)
						return false;
					var files = dataTransfer.files;
					$.each(files, function(index, file) {
						self.composeRegion.currentView.attachmentsView.addAttachment(file);
					});
					self.composeRegion.currentView.attachmentsView._showAttachmentsSize();
					return false;
				});
			},
		}); // mail.DroppableView

		mail.PopupNoticeView = Backbone.Marionette.ItemView.extend({
			className : 'notify_view',
			template : function(data) {
				var html, compiledTemplate = mail.PopupNoticeView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#popup-notice-template').html();
					compiledTemplate = _.template(html);
					mail.PopupNoticeView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
					popup : data,
				});
				return html;
			},
			initialize : function(options) {
				// this.model = new mail.PopupModel
			},
			onRender : function() {
				var self = this;
				var $popupTitle = this.$el.find('div.popup-title');
				$popupTitle.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var url = 'popups/' + self.model.get('POPUP_IDX');
					var left = self.model.get('POPUP_LEFT') > 0 ? self.model.get('POPUP_LEFT') : 10;
					var top = self.model.get('POPUP_TOP') > 0 ? self.model.get('POPUP_TOP') : 10;
					var width = self.model.get('POPUP_WIDTH') > 0 ? self.model.get('POPUP_WIDTH') : 350;
					var height = self.model.get('POPUP_HEIGHT') > 0 ? self.model.get('POPUP_HEIGHT') : 350;
					var env = 'status=yes,toolbar=no,scrollbars=yes';
					env += ',left=' + left + ',top=' + top + ',width=' + width + ',height=' + height;
					window.open(url, self.model.get('POPUP_IDX'), env);
					return false;
				});
				var $stopByToday = this.$el.find('a.today_close');
				$stopByToday.click(function(event) {
					event.preventDefault() && event.stopPropagation();
					var popupId = self.model.get('POPUP_IDX');
					self.setCookie('loginPopup-' + popupId, 'popupId-' + popupId, 1);
					self.remove();
					return false;
				})
			},
			setCookie : function(name, value, expires) {
				var now = new Date();
				now.setDate(now.getDate() + expires);
				document.cookie = name + '=' + encodeURIComponent(value) + '; path=/; expires=' + now.toGMTString()
						+ ';';
			},
			getCookie : function(name, value) {
				if (name)
					name += '=';
				var isCookie = false;
				var cookies = document.cookie;
				var pos = cookies.indexOf(name);
				if (pos != -1) {
					var start = pos + name.length;
					var end = cookies.indexOf(';', start);
					if (end == -1)
						end = cookies.length;
					var cvalue = cookies.substring(start, end);
					cvalue = decodeURIComponent(cvalue);
					if (value === cvalue) {
						isCookie = true;
						return isCookie;
					}
				}
				return isCookie;
			}
		});

		mail.MaliciousForgeryHelpLayerView = Backbone.Marionette.CompositeView.extend({
			tagName : 'div',
			className : 'ad_layer',
			attributes : {
				style : 'width:520px; left:530px; top:150px; margin-left:-260px; display:none; position: absolute;',
				hidable : 'true',
			},
			template : function(data) {
				var html, compiledTemplate = mail.MaliciousForgeryHelpLayerView.compiledTemplate;
				if (!compiledTemplate) {
					html = mail.$template.filter('#malicious-forgery-help-layer-template').html();
					compiledTemplate = _.template(html);
					mail.MaliciousForgeryHelpLayerView.compiledTemplate = compiledTemplate;
				}
				html = compiledTemplate({
					i18n : i18n,
				});
				return html;
			},
			onRender : function() {
				var self = this;
				this.$el.click(function(event) {
					event.stopPropagation();
				});
				this.$el.find('div.close_bt').click(function(event) {
					event.preventDefault() && event.stopPropagation();
					self.$el.toggle();
				});
			}
		});

	}); // app.module('mail', function(mail, app, Backbone, Marionette, $, _) );
});I<R      c[c[E6MccU   s    O^partitionKey=%28http%2Cseoultech.ac.kr%29,:http://mail.seoultech.ac.kr/mail/app/mail/mail-views.js?v=202301181454 necko:classified 1 strongly-framed 1 request-method GET response-head HTTP/1.1 200 
Accept-Ranges: bytes
ETag: W/"554222-1664418080000"
Last-Modified: Thu, 29 Sep 2022 02:21:20 GMT
Content-Type: application/javascript;charset=UTF-8
Content-Length: 554222
Date: Wed, 01 Feb 2023 07:57:14 GMT
 original-response-headers Accept-Ranges: bytes
ETag: W/"554222-1664418080000"
Last-Modified: Thu, 29 Sep 2022 02:21:20 GMT
Content-Type: application/javascript;charset=UTF-8
Content-Length: 554222
Date: Wed, 01 Feb 2023 07:57:14 GMT
 ctid 2 uncompressed-len 0 net-response-time-onstart 277 net-response-time-onstop 278  t